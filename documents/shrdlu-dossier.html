<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>shrdlu-dossier</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../dark-theme.css" />
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#chapter-1-introduction-to-shrdlu"
id="toc-chapter-1-introduction-to-shrdlu">Chapter 1: Introduction to
Shrdlu</a>
<ul>
<li><a href="#what-is-shrdlu-and-why-build-it"
id="toc-what-is-shrdlu-and-why-build-it">What is Shrdlu and Why Build
It?</a></li>
<li><a href="#overview-of-static-site-generators"
id="toc-overview-of-static-site-generators">Overview of Static Site
Generators</a>
<ul>
<li><a href="#performance-benefits"
id="toc-performance-benefits">Performance Benefits</a></li>
<li><a href="#development-benefits"
id="toc-development-benefits">Development Benefits</a></li>
<li><a href="#popular-generators-and-their-approaches"
id="toc-popular-generators-and-their-approaches">Popular Generators and
Their Approaches</a></li>
</ul></li>
<li><a href="#the-power-of-custom-markup-languages"
id="toc-the-power-of-custom-markup-languages">The Power of Custom Markup
Languages</a>
<ul>
<li><a href="#domain-specific-expressiveness"
id="toc-domain-specific-expressiveness">Domain-Specific
Expressiveness</a></li>
<li><a href="#extensibility-without-plugins"
id="toc-extensibility-without-plugins">Extensibility Without
Plugins</a></li>
<li><a href="#semantic-markup" id="toc-semantic-markup">Semantic
Markup</a></li>
</ul></li>
<li><a href="#turing-completeness-in-document-processing"
id="toc-turing-completeness-in-document-processing">Turing-Completeness
in Document Processing</a>
<ul>
<li><a href="#dynamic-content-generation"
id="toc-dynamic-content-generation">Dynamic Content Generation</a></li>
<li><a href="#data-driven-documents"
id="toc-data-driven-documents">Data-Driven Documents</a></li>
<li><a href="#conditional-content"
id="toc-conditional-content">Conditional Content</a></li>
</ul></li>
<li><a href="#multi-format-output-strategy-html-pdf-epub"
id="toc-multi-format-output-strategy-html-pdf-epub">Multi-Format Output
Strategy (HTML, PDF, EPUB)</a>
<ul>
<li><a href="#unified-document-model"
id="toc-unified-document-model">Unified Document Model</a></li>
<li><a href="#format-specific-rendering"
id="toc-format-specific-rendering">Format-Specific Rendering</a></li>
<li><a href="#url-based-format-selection"
id="toc-url-based-format-selection">URL-Based Format Selection</a></li>
</ul></li>
<li><a href="#book-roadmap" id="toc-book-roadmap">Book Roadmap</a></li>
<li><a href="#summary" id="toc-summary">Summary</a></li>
<li><a href="#why-racket-for-dsl-implementation"
id="toc-why-racket-for-dsl-implementation">Why Racket for DSL
Implementation</a>
<ul>
<li><a href="#the-language-oriented-programming-paradigm"
id="toc-the-language-oriented-programming-paradigm">The
Language-Oriented Programming Paradigm</a></li>
<li><a href="#built-in-language-infrastructure"
id="toc-built-in-language-infrastructure">Built-in Language
Infrastructure</a></li>
<li><a href="#performance-considerations"
id="toc-performance-considerations">Performance Considerations</a></li>
<li><a href="#community-and-ecosystem"
id="toc-community-and-ecosystem">Community and Ecosystem</a></li>
</ul></li>
<li><a href="#s-expressions-and-homoiconicity"
id="toc-s-expressions-and-homoiconicity">S-expressions and
Homoiconicity</a>
<ul>
<li><a href="#what-are-s-expressions"
id="toc-what-are-s-expressions">What Are S-expressions?</a></li>
<li><a href="#homoiconicity-code-as-data"
id="toc-homoiconicity-code-as-data">Homoiconicity: Code as Data</a></li>
<li><a href="#reader-syntax-and-notation"
id="toc-reader-syntax-and-notation">Reader Syntax and Notation</a></li>
<li><a href="#practical-s-expression-manipulation"
id="toc-practical-s-expression-manipulation">Practical S-expression
Manipulation</a></li>
</ul></li>
<li><a href="#macros-and-language-extensions"
id="toc-macros-and-language-extensions">Macros and Language
Extensions</a>
<ul>
<li><a href="#understanding-macros"
id="toc-understanding-macros">Understanding Macros</a></li>
<li><a href="#pattern-based-macros"
id="toc-pattern-based-macros">Pattern-Based Macros</a></li>
<li><a href="#syntax-objects-and-hygiene"
id="toc-syntax-objects-and-hygiene">Syntax Objects and Hygiene</a></li>
<li><a href="#procedural-macros-with-syntax-case"
id="toc-procedural-macros-with-syntax-case">Procedural Macros with
<code>syntax-case</code></a></li>
<li><a href="#macro-debugging-techniques"
id="toc-macro-debugging-techniques">Macro Debugging Techniques</a></li>
</ul></li>
<li><a href="#the-lang-mechanism" id="toc-the-lang-mechanism">The
<code>#lang</code> Mechanism</a>
<ul>
<li><a href="#how-lang-works" id="toc-how-lang-works">How
<code>#lang</code> Works</a></li>
<li><a href="#creating-a-basic-language"
id="toc-creating-a-basic-language">Creating a Basic Language</a></li>
<li><a href="#implementing-a-custom-reader"
id="toc-implementing-a-custom-reader">Implementing a Custom
Reader</a></li>
<li><a href="#language-configuration"
id="toc-language-configuration">Language Configuration</a></li>
<li><a href="#module-phases-and-compile-time-programming"
id="toc-module-phases-and-compile-time-programming">Module Phases and
Compile-Time Programming</a></li>
</ul></li>
<li><a href="#essential-racket-libraries-for-our-project"
id="toc-essential-racket-libraries-for-our-project">Essential Racket
Libraries for Our Project</a>
<ul>
<li><a href="#parser-tools" id="toc-parser-tools">Parser Tools</a></li>
<li><a href="#drawing-and-pdf-generation"
id="toc-drawing-and-pdf-generation">Drawing and PDF Generation</a></li>
<li><a href="#web-server" id="toc-web-server">Web Server</a></li>
<li><a href="#file-system-and-path-utilities"
id="toc-file-system-and-path-utilities">File System and Path
Utilities</a></li>
<li><a href="#testing-framework" id="toc-testing-framework">Testing
Framework</a></li>
</ul></li>
<li><a href="#setting-up-the-development-environment"
id="toc-setting-up-the-development-environment">Setting Up the
Development Environment</a>
<ul>
<li><a href="#project-structure" id="toc-project-structure">Project
Structure</a></li>
<li><a href="#package-definition" id="toc-package-definition">Package
Definition</a></li>
<li><a href="#drracket-configuration"
id="toc-drracket-configuration">DrRacket Configuration</a></li>
<li><a href="#command-line-interface"
id="toc-command-line-interface">Command Line Interface</a></li>
<li><a href="#development-workflow"
id="toc-development-workflow">Development Workflow</a></li>
<li><a href="#debugging-tools" id="toc-debugging-tools">Debugging
Tools</a></li>
</ul></li>
<li><a href="#summary-1" id="toc-summary-1">Summary</a>
<ul>
<li><a href="#exercises" id="toc-exercises">Exercises</a></li>
</ul></li>
<li><a href="#language-philosophy-and-goals"
id="toc-language-philosophy-and-goals">Language Philosophy and Goals</a>
<ul>
<li><a href="#core-design-principles"
id="toc-core-design-principles">Core Design Principles</a></li>
<li><a href="#target-audiences-and-use-cases"
id="toc-target-audiences-and-use-cases">Target Audiences and Use
Cases</a></li>
<li><a href="#design-trade-offs" id="toc-design-trade-offs">Design
Trade-offs</a></li>
</ul></li>
<li><a href="#syntax-design-decisions"
id="toc-syntax-design-decisions">Syntax Design Decisions</a>
<ul>
<li><a href="#the-notation" id="toc-the-notation">The @
Notation</a></li>
<li><a href="#bracket-types-and-their-meanings"
id="toc-bracket-types-and-their-meanings">Bracket Types and Their
Meanings</a></li>
<li><a href="#string-handling-and-escaping"
id="toc-string-handling-and-escaping">String Handling and
Escaping</a></li>
<li><a href="#comments-and-documentation"
id="toc-comments-and-documentation">Comments and Documentation</a></li>
<li><a href="#whitespace-handling"
id="toc-whitespace-handling">Whitespace Handling</a></li>
<li><a href="#command-resolution-and-namespaces"
id="toc-command-resolution-and-namespaces">Command Resolution and
Namespaces</a></li>
</ul></li>
<li><a href="#core-language-constructs"
id="toc-core-language-constructs">Core Language Constructs</a>
<ul>
<li><a href="#document-structure-elements"
id="toc-document-structure-elements">Document Structure
Elements</a></li>
<li><a href="#text-formatting" id="toc-text-formatting">Text
Formatting</a></li>
<li><a href="#lists-and-enumerations"
id="toc-lists-and-enumerations">Lists and Enumerations</a></li>
<li><a href="#tables" id="toc-tables">Tables</a></li>
<li><a href="#code-and-technical-content"
id="toc-code-and-technical-content">Code and Technical Content</a></li>
<li><a href="#mathematics" id="toc-mathematics">Mathematics</a></li>
<li><a href="#cross-references-and-links"
id="toc-cross-references-and-links">Cross-References and Links</a></li>
</ul></li>
<li><a href="#control-flow-and-computations"
id="toc-control-flow-and-computations">Control Flow and Computations</a>
<ul>
<li><a href="#variables-and-binding"
id="toc-variables-and-binding">Variables and Binding</a></li>
<li><a href="#conditionals" id="toc-conditionals">Conditionals</a></li>
<li><a href="#loops-and-iteration" id="toc-loops-and-iteration">Loops
and Iteration</a></li>
<li><a href="#functions" id="toc-functions">Functions</a></li>
</ul></li>
<li><a href="#template-and-macro-system"
id="toc-template-and-macro-system">Template and Macro System</a>
<ul>
<li><a href="#document-templates" id="toc-document-templates">Document
Templates</a></li>
<li><a href="#syntactic-macros" id="toc-syntactic-macros">Syntactic
Macros</a></li>
<li><a href="#code-generation-macros"
id="toc-code-generation-macros">Code Generation Macros</a></li>
</ul></li>
<li><a href="#comparison-with-typst-and-latex"
id="toc-comparison-with-typst-and-latex">Comparison with Typst and
LaTeX</a>
<ul>
<li><a href="#latex-comparison" id="toc-latex-comparison">LaTeX
Comparison</a></li>
<li><a href="#typst-comparison" id="toc-typst-comparison">Typst
Comparison</a></li>
<li><a href="#unique-shrdlu-features"
id="toc-unique-shrdlu-features">Unique Shrdlu Features</a></li>
</ul></li>
<li><a href="#example-documents" id="toc-example-documents">Example
Documents</a>
<ul>
<li><a href="#example-1-technical-blog-post"
id="toc-example-1-technical-blog-post">Example 1: Technical Blog
Post</a></li>
<li><a href="#example-2-academic-paper"
id="toc-example-2-academic-paper">Example 2: Academic Paper</a></li>
<li><a href="#example-3-data-driven-report"
id="toc-example-3-data-driven-report">Example 3: Data-Driven
Report</a></li>
</ul></li>
<li><a href="#summary-2" id="toc-summary-2">Summary</a>
<ul>
<li><a href="#design-exercises" id="toc-design-exercises">Design
Exercises</a></li>
</ul></li>
<li><a href="#introduction-to-lexical-analysis-and-parsing"
id="toc-introduction-to-lexical-analysis-and-parsing">Introduction to
Lexical Analysis and Parsing</a>
<ul>
<li><a href="#the-pipeline-architecture"
id="toc-the-pipeline-architecture">The Pipeline Architecture</a></li>
<li><a href="#why-separate-lexing-and-parsing"
id="toc-why-separate-lexing-and-parsing">Why Separate Lexing and
Parsing?</a></li>
<li><a href="#rackets-parser-tools"
id="toc-rackets-parser-tools">Racket’s Parser Tools</a></li>
</ul></li>
<li><a href="#token-design-and-specification"
id="toc-token-design-and-specification">Token Design and
Specification</a>
<ul>
<li><a href="#token-types-for-shrdlu"
id="toc-token-types-for-shrdlu">Token Types for Shrdlu</a></li>
<li><a href="#regular-expression-patterns"
id="toc-regular-expression-patterns">Regular Expression
Patterns</a></li>
</ul></li>
<li><a href="#building-the-lexer" id="toc-building-the-lexer">Building
the Lexer</a>
<ul>
<li><a href="#advanced-lexer-features"
id="toc-advanced-lexer-features">Advanced Lexer Features</a></li>
<li><a href="#lexer-state-management"
id="toc-lexer-state-management">Lexer State Management</a></li>
</ul></li>
<li><a href="#parser-architecture-and-grammar-design"
id="toc-parser-architecture-and-grammar-design">Parser Architecture and
Grammar Design</a>
<ul>
<li><a href="#abstract-syntax-tree-design"
id="toc-abstract-syntax-tree-design">Abstract Syntax Tree
Design</a></li>
<li><a href="#grammar-specification"
id="toc-grammar-specification">Grammar Specification</a></li>
<li><a href="#parser-implementation"
id="toc-parser-implementation">Parser Implementation</a></li>
<li><a href="#advanced-grammar-features"
id="toc-advanced-grammar-features">Advanced Grammar Features</a></li>
</ul></li>
<li><a href="#implementing-the-reader"
id="toc-implementing-the-reader">Implementing the @ Reader</a>
<ul>
<li><a href="#location-tracking-and-error-reporting"
id="toc-location-tracking-and-error-reporting">Location Tracking and
Error Reporting</a></li>
</ul></li>
<li><a href="#testing-the-lexer-and-parser"
id="toc-testing-the-lexer-and-parser">Testing the Lexer and Parser</a>
<ul>
<li><a href="#integration-tests" id="toc-integration-tests">Integration
Tests</a></li>
</ul></li>
<li><a href="#performance-optimization"
id="toc-performance-optimization">Performance Optimization</a></li>
<li><a href="#summary-3" id="toc-summary-3">Summary</a>
<ul>
<li><a href="#exercises-1" id="toc-exercises-1">Exercises</a></li>
</ul></li>
<li><a href="#introduction-to-document-interpretation"
id="toc-introduction-to-document-interpretation">Introduction to
Document Interpretation</a></li>
<li><a href="#the-evaluation-model" id="toc-the-evaluation-model">The
Evaluation Model</a></li>
<li><a href="#core-interpreter-implementation"
id="toc-core-interpreter-implementation">Core Interpreter
Implementation</a></li>
<li><a href="#advanced-interpretation-features"
id="toc-advanced-interpretation-features">Advanced Interpretation
Features</a>
<ul>
<li><a href="#function-definition-and-application"
id="toc-function-definition-and-application">Function Definition and
Application</a></li>
<li><a href="#control-flow" id="toc-control-flow">Control Flow</a></li>
<li><a href="#template-system" id="toc-template-system">Template
System</a></li>
<li><a href="#data-loading-and-processing"
id="toc-data-loading-and-processing">Data Loading and
Processing</a></li>
<li><a href="#include-and-module-system"
id="toc-include-and-module-system">Include and Module System</a></li>
</ul></li>
<li><a href="#error-handling-and-debugging"
id="toc-error-handling-and-debugging">Error Handling and
Debugging</a></li>
<li><a href="#caching-and-optimization"
id="toc-caching-and-optimization">Caching and Optimization</a></li>
<li><a href="#integration-with-external-tools"
id="toc-integration-with-external-tools">Integration with External
Tools</a></li>
<li><a href="#testing-the-interpreter"
id="toc-testing-the-interpreter">Testing the Interpreter</a></li>
<li><a href="#the-document-model" id="toc-the-document-model">The
Document Model</a></li>
<li><a href="#summary-4" id="toc-summary-4">Summary</a>
<ul>
<li><a href="#exercises-2" id="toc-exercises-2">Exercises</a></li>
</ul></li>
<li><a href="#the-need-for-an-intermediate-representation"
id="toc-the-need-for-an-intermediate-representation">The Need for an
Intermediate Representation</a></li>
<li><a href="#core-document-model-architecture"
id="toc-core-document-model-architecture">Core Document Model
Architecture</a></li>
<li><a href="#building-the-document-model"
id="toc-building-the-document-model">Building the Document
Model</a></li>
<li><a href="#cross-reference-resolution"
id="toc-cross-reference-resolution">Cross-Reference Resolution</a></li>
<li><a href="#mathematical-content-representation"
id="toc-mathematical-content-representation">Mathematical Content
Representation</a></li>
<li><a href="#node-specific-rendering"
id="toc-node-specific-rendering">Node-Specific Rendering</a></li>
<li><a href="#table-and-figure-rendering"
id="toc-table-and-figure-rendering">Table and Figure Rendering</a></li>
<li><a href="#css-generation-and-theming"
id="toc-css-generation-and-theming">CSS Generation and Theming</a></li>
<li><a href="#text-layout-and-line-breaking"
id="toc-text-layout-and-line-breaking">Text Layout and Line
Breaking</a></li>
<li><a href="#rendering-document-elements"
id="toc-rendering-document-elements">Rendering Document
Elements</a></li>
<li><a href="#advanced-pdf-features"
id="toc-advanced-pdf-features">Advanced PDF Features</a></li>
<li><a href="#integration-and-export"
id="toc-integration-and-export">Integration and Export</a></li>
<li><a href="#exercises-3" id="toc-exercises-3">Exercises</a></li>
<li><a href="#the-electronic-publishing-challenge"
id="toc-the-electronic-publishing-challenge">The Electronic Publishing
Challenge</a></li>
<li><a href="#epub-structure-and-architecture"
id="toc-epub-structure-and-architecture">EPUB Structure and
Architecture</a></li>
<li><a href="#content-generation-and-splitting"
id="toc-content-generation-and-splitting">Content Generation and
Splitting</a></li>
<li><a href="#navigation-and-metadata"
id="toc-navigation-and-metadata">Navigation and Metadata</a></li>
<li><a href="#styling-and-resources"
id="toc-styling-and-resources">Styling and Resources</a></li>
<li><a href="#mathematical-content-in-epub"
id="toc-mathematical-content-in-epub">Mathematical Content in
EPUB</a></li>
<li><a href="#packaging-and-validation"
id="toc-packaging-and-validation">Packaging and Validation</a></li>
<li><a href="#testing-epub-generation"
id="toc-testing-epub-generation">Testing EPUB Generation</a></li>
<li><a href="#exercises-4" id="toc-exercises-4">Exercises</a></li>
<li><a href="#the-architecture-of-knowledge"
id="toc-the-architecture-of-knowledge">The Architecture of
Knowledge</a></li>
<li><a href="#site-configuration-and-project-structure"
id="toc-site-configuration-and-project-structure">Site Configuration and
Project Structure</a></li>
<li><a href="#content-organization-and-collections"
id="toc-content-organization-and-collections">Content Organization and
Collections</a></li>
<li><a href="#navigation-generation"
id="toc-navigation-generation">Navigation Generation</a></li>
<li><a href="#url-schemes-and-routing"
id="toc-url-schemes-and-routing">URL Schemes and Routing</a></li>
<li><a href="#taxonomy-systems" id="toc-taxonomy-systems">Taxonomy
Systems</a></li>
<li><a href="#index-generation-and-sitemaps"
id="toc-index-generation-and-sitemaps">Index Generation and
Sitemaps</a></li>
<li><a href="#testing-site-organization"
id="toc-testing-site-organization">Testing Site Organization</a></li>
<li><a href="#exercises-5" id="toc-exercises-5">Exercises</a></li>
<li><a href="#orchestrating-the-symphony-of-generation"
id="toc-orchestrating-the-symphony-of-generation">Orchestrating the
Symphony of Generation</a></li>
<li><a href="#build-architecture-overview"
id="toc-build-architecture-overview">Build Architecture
Overview</a></li>
<li><a href="#dependency-tracking-and-incremental-builds"
id="toc-dependency-tracking-and-incremental-builds">Dependency Tracking
and Incremental Builds</a></li>
<li><a href="#parallel-build-execution"
id="toc-parallel-build-execution">Parallel Build Execution</a></li>
<li><a href="#build-cache-system" id="toc-build-cache-system">Build
Cache System</a></li>
<li><a href="#file-watching-and-live-reload"
id="toc-file-watching-and-live-reload">File Watching and Live
Reload</a></li>
<li><a href="#build-statistics-and-reporting"
id="toc-build-statistics-and-reporting">Build Statistics and
Reporting</a></li>
<li><a href="#testing-the-build-engine"
id="toc-testing-the-build-engine">Testing the Build Engine</a></li>
<li><a href="#exercises-6" id="toc-exercises-6">Exercises</a></li>
<li><a href="#beyond-static-files-adding-dynamic-capabilities"
id="toc-beyond-static-files-adding-dynamic-capabilities">Beyond Static
Files: Adding Dynamic Capabilities</a></li>
<li><a href="#server-architecture" id="toc-server-architecture">Server
Architecture</a></li>
<li><a href="#request-routing-and-dispatch"
id="toc-request-routing-and-dispatch">Request Routing and
Dispatch</a></li>
<li><a href="#static-file-serving" id="toc-static-file-serving">Static
File Serving</a></li>
<li><a href="#api-endpoints-and-json-handling"
id="toc-api-endpoints-and-json-handling">API Endpoints and JSON
Handling</a></li>
<li><a href="#websocket-support" id="toc-websocket-support">WebSocket
Support</a></li>
<li><a href="#security-and-middleware"
id="toc-security-and-middleware">Security and Middleware</a></li>
<li><a href="#development-tools-integration"
id="toc-development-tools-integration">Development Tools
Integration</a></li>
<li><a href="#testing-the-web-server"
id="toc-testing-the-web-server">Testing the Web Server</a></li>
<li><a href="#exercises-7" id="toc-exercises-7">Exercises</a></li>
<li><a href="#pushing-the-boundaries-of-rackets-macro-system"
id="toc-pushing-the-boundaries-of-rackets-macro-system">Pushing the
Boundaries of Racket’s Macro System</a></li>
<li><a href="#syntax-classes-and-robust-macros"
id="toc-syntax-classes-and-robust-macros">Syntax Classes and Robust
Macros</a></li>
<li><a href="#phase-separation-and-compile-time-computation"
id="toc-phase-separation-and-compile-time-computation">Phase Separation
and Compile-Time Computation</a></li>
<li><a href="#advanced-module-system-features"
id="toc-advanced-module-system-features">Advanced Module System
Features</a></li>
<li><a href="#continuation-based-control-flow"
id="toc-continuation-based-control-flow">Continuation-Based Control
Flow</a></li>
<li><a href="#github-pages-deployment"
id="toc-github-pages-deployment">GitHub Pages Deployment</a></li>
<li><a href="#performance-optimization-1"
id="toc-performance-optimization-1">Performance Optimization</a></li>
<li><a href="#monitoring-and-analytics"
id="toc-monitoring-and-analytics">Monitoring and Analytics</a></li>
<li><a href="#cli-and-automation" id="toc-cli-and-automation">CLI and
Automation</a></li>
<li><a href="#overview" id="toc-overview">Overview</a></li>
<li><a href="#architecture" id="toc-architecture">Architecture</a>
<ul>
<li><a href="#core-components" id="toc-core-components">Core
Components</a></li>
</ul></li>
<li><a href="#tts-model-integration" id="toc-tts-model-integration">TTS
Model Integration</a>
<ul>
<li><a href="#using-coqui-tts" id="toc-using-coqui-tts">Using Coqui
TTS</a></li>
<li><a href="#alternative-using-bark"
id="toc-alternative-using-bark">Alternative: Using Bark</a></li>
</ul></li>
<li><a href="#document-processing-pipeline"
id="toc-document-processing-pipeline">Document Processing Pipeline</a>
<ul>
<li><a href="#text-extraction-and-preparation"
id="toc-text-extraction-and-preparation">Text Extraction and
Preparation</a></li>
<li><a href="#caching-system" id="toc-caching-system">Caching
System</a></li>
</ul></li>
<li><a href="#audio-processing" id="toc-audio-processing">Audio
Processing</a>
<ul>
<li><a href="#format-conversion-and-optimization"
id="toc-format-conversion-and-optimization">Format Conversion and
Optimization</a></li>
</ul></li>
<li><a href="#web-integration" id="toc-web-integration">Web
Integration</a>
<ul>
<li><a href="#request-handler" id="toc-request-handler">Request
Handler</a></li>
</ul></li>
<li><a href="#configuration" id="toc-configuration">Configuration</a>
<ul>
<li><a href="#site-configuration-integration"
id="toc-site-configuration-integration">Site Configuration
Integration</a></li>
<li><a href="#build-integration" id="toc-build-integration">Build
Integration</a></li>
</ul></li>
<li><a href="#frontend-integration"
id="toc-frontend-integration">Frontend Integration</a>
<ul>
<li><a href="#javascript-audio-player"
id="toc-javascript-audio-player">JavaScript Audio Player</a></li>
</ul></li>
<li><a href="#production-considerations"
id="toc-production-considerations">Production Considerations</a>
<ul>
<li><a href="#performance-optimization-2"
id="toc-performance-optimization-2">Performance Optimization</a></li>
<li><a href="#error-handling" id="toc-error-handling">Error
Handling</a></li>
</ul></li>
<li><a href="#summary-5" id="toc-summary-5">Summary</a></li>
<li><a href="#language-overview" id="toc-language-overview">Language
Overview</a></li>
<li><a href="#core-language-forms" id="toc-core-language-forms">Core
Language Forms</a>
<ul>
<li><a href="#document-definition" id="toc-document-definition">Document
Definition</a></li>
<li><a href="#content-elements" id="toc-content-elements">Content
Elements</a></li>
</ul></li>
<li><a href="#reader-extensions" id="toc-reader-extensions">Reader
Extensions</a>
<ul>
<li><a href="#hash-lang-reader" id="toc-hash-lang-reader">Hash-lang
Reader</a></li>
<li><a href="#markdown-integration"
id="toc-markdown-integration">Markdown Integration</a></li>
<li><a href="#template-system-1" id="toc-template-system-1">Template
System</a></li>
<li><a href="#content-processing" id="toc-content-processing">Content
Processing</a></li>
<li><a href="#asset-management" id="toc-asset-management">Asset
Management</a></li>
<li><a href="#url-and-routing" id="toc-url-and-routing">URL and
Routing</a></li>
</ul></li>
<li><a href="#configuration-reference"
id="toc-configuration-reference">Configuration Reference</a>
<ul>
<li><a href="#site-configuration" id="toc-site-configuration">Site
Configuration</a></li>
<li><a href="#environment-variables"
id="toc-environment-variables">Environment Variables</a></li>
</ul></li>
<li><a href="#plugin-system" id="toc-plugin-system">Plugin System</a>
<ul>
<li><a href="#plugin-structure" id="toc-plugin-structure">Plugin
Structure</a></li>
<li><a href="#plugin-hooks" id="toc-plugin-hooks">Plugin Hooks</a></li>
</ul></li>
<li><a href="#error-messages-and-diagnostics"
id="toc-error-messages-and-diagnostics">Error Messages and
Diagnostics</a>
<ul>
<li><a href="#common-error-patterns"
id="toc-common-error-patterns">Common Error Patterns</a></li>
<li><a href="#debugging-functions"
id="toc-debugging-functions">Debugging Functions</a></li>
</ul></li>
<li><a href="#advanced-features" id="toc-advanced-features">Advanced
Features</a>
<ul>
<li><a href="#macros-and-extensions"
id="toc-macros-and-extensions">Macros and Extensions</a></li>
<li><a href="#performance-optimization-3"
id="toc-performance-optimization-3">Performance Optimization</a></li>
</ul></li>
<li><a href="#migration-guide" id="toc-migration-guide">Migration
Guide</a>
<ul>
<li><a href="#from-jekyll" id="toc-from-jekyll">From Jekyll</a></li>
<li><a href="#from-hugo" id="toc-from-hugo">From Hugo</a></li>
</ul></li>
<li><a href="#core-api" id="toc-core-api">Core API</a>
<ul>
<li><a href="#document-api" id="toc-document-api">Document API</a></li>
<li><a href="#node-api" id="toc-node-api">Node API</a></li>
<li><a href="#rendering-api" id="toc-rendering-api">Rendering
API</a></li>
<li><a href="#parser-api" id="toc-parser-api">Parser API</a></li>
<li><a href="#template-api" id="toc-template-api">Template API</a></li>
<li><a href="#collection-api" id="toc-collection-api">Collection
API</a></li>
<li><a href="#asset-api" id="toc-asset-api">Asset API</a></li>
<li><a href="#build-api" id="toc-build-api">Build API</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="chapter-1-introduction-to-shrdlu">Chapter 1: Introduction to
Shrdlu</h1>
<h2 id="what-is-shrdlu-and-why-build-it">What is Shrdlu and Why Build
It?</h2>
<p>Shrdlu is a static website generator built in Racket that introduces
a revolutionary approach to content creation: a Turing-complete markup
language. Named after the famous SHRDLU natural language understanding
program from the 1970s, our Shrdlu aims to bridge the gap between simple
markup and full programming languages, offering authors unprecedented
control over their content generation.</p>
<p>But why build yet another static site generator? The answer lies in
the limitations of existing solutions:</p>
<ol type="1">
<li><p><strong>Limited Expressiveness</strong>: Most markup languages
(Markdown, reStructuredText) offer fixed sets of features. When you need
something beyond their capabilities, you’re forced to embed raw HTML or
use complex plugin systems.</p></li>
<li><p><strong>Format Lock-in</strong>: Traditional generators typically
produce only HTML. Converting to PDF or EPUB requires separate
toolchains, often with inconsistent results.</p></li>
<li><p><strong>Lack of Computational Power</strong>: Want to generate a
Fibonacci sequence in your document? Calculate compound interest in a
financial blog post? Most markup languages can’t handle even simple
computations without external preprocessing.</p></li>
<li><p><strong>Poor Abstraction Mechanisms</strong>: Reusing document
fragments, creating custom components, or building domain-specific
abstractions is cumbersome in most systems.</p></li>
</ol>
<p>Shrdlu addresses these limitations by providing: - A markup language
that can perform arbitrary computations - Native multi-format output
(HTML, PDF, EPUB) from a single source - First-class functions and
macros for creating reusable components - Deep integration with Racket’s
powerful language-building facilities</p>
<h2 id="overview-of-static-site-generators">Overview of Static Site
Generators</h2>
<p>Static site generators have revolutionized web publishing by
pre-building HTML pages from source files, offering several advantages
over dynamic systems:</p>
<h3 id="performance-benefits">Performance Benefits</h3>
<ul>
<li>No server-side processing per request</li>
<li>Cacheable content</li>
<li>CDN-friendly distribution</li>
<li>Minimal attack surface</li>
</ul>
<h3 id="development-benefits">Development Benefits</h3>
<ul>
<li>Version control for content</li>
<li>Clear separation of content and presentation</li>
<li>Reproducible builds</li>
<li>Local development without databases</li>
</ul>
<h3 id="popular-generators-and-their-approaches">Popular Generators and
Their Approaches</h3>
<p><strong>Jekyll</strong> pioneered the modern static site generator
movement with its simple file-based approach and Liquid templating.
However, Liquid’s limitations become apparent when building complex
sites.</p>
<p><strong>Hugo</strong> emphasizes speed and provides more powerful
templating through Go’s template language, but still restricts authors
to predefined functionality.</p>
<p><strong>Gatsby</strong> and <strong>Next.js</strong> bring React’s
component model to static generation but require JavaScript knowledge
and impose heavyweight toolchains.</p>
<p><strong>Pandoc</strong> excels at document conversion but isn’t
designed for website generation and lacks programmability in its
markup.</p>
<p>Shrdlu learns from these predecessors while charting a new path:
bringing the full power of a programming language to document authors
without sacrificing the simplicity of markup for common tasks.</p>
<h2 id="the-power-of-custom-markup-languages">The Power of Custom Markup
Languages</h2>
<p>Creating our own markup language might seem like reinventing the
wheel, but it offers unique advantages:</p>
<h3 id="domain-specific-expressiveness">Domain-Specific
Expressiveness</h3>
<pre class="shrdlu"><code>@article[#:title &quot;Compound Interest Calculator&quot;]{
  If you invest @def[P]{$1000} at @def[r]{5%} annual interest 
  for @def[n]{10} years, you&#39;ll have:
  
  @calculate{
    let ([amount (* P (expt (+ 1 (/ r 100)) n))])
      @format-currency[amount]
  }
}</code></pre>
<h3 id="extensibility-without-plugins">Extensibility Without
Plugins</h3>
<p>Instead of relying on external plugin systems, Shrdlu documents can
define their own extensions:</p>
<pre class="shrdlu"><code>@define-tag[sidenote][content]{
  @div[#:class &quot;sidenote&quot;]{
    @icon{info} @em{Note:} @content
  }
}

Later in the document, @sidenote{This appears in the margin}.</code></pre>
<h3 id="semantic-markup">Semantic Markup</h3>
<p>Unlike HTML’s presentation-focused tags, Shrdlu encourages semantic
markup that adapts to different output formats:</p>
<pre class="shrdlu"><code>@theorem[#:label &quot;fermat-last&quot;]{
  For any integer @math{n &gt; 2}, there are no three positive 
  integers @math{a}, @math{b}, and @math{c} that satisfy:
  @equation{a^n + b^n = c^n}
}</code></pre>
<p>This renders appropriately whether generating HTML (with proper CSS
classes), PDF (with LaTeX-style formatting), or EPUB (with semantic tags
for e-readers).</p>
<h2 id="turing-completeness-in-document-processing">Turing-Completeness
in Document Processing</h2>
<p>Turing-completeness means Shrdlu can compute anything that’s
computationally possible. This isn’t just a theoretical nicety—it
enables powerful document generation techniques:</p>
<h3 id="dynamic-content-generation">Dynamic Content Generation</h3>
<pre class="shrdlu"><code>@define[fibonacci][n]{
  @if[(&lt; n 2)]{
    n
  }{
    @+ [@fibonacci[(- n 1)]] [@fibonacci[(- n 2)]]
  }
}

The 10th Fibonacci number is @fibonacci[10].</code></pre>
<h3 id="data-driven-documents">Data-Driven Documents</h3>
<pre class="shrdlu"><code>@let[data @load-csv[&quot;sales-2024.csv&quot;]]{
  @section{Quarterly Sales Report}
  
  @for[quarter @in [@group-by[data &#39;quarter]]]{
    @subsection{Quarter @get[quarter &#39;number]}
    Total sales: @format-currency[@sum[@map[quarter &#39;amount]]]
    
    @piechart[@map[quarter [&#39;product &#39;amount]]]
  }
}</code></pre>
<h3 id="conditional-content">Conditional Content</h3>
<pre class="shrdlu"><code>@configure[#:audience @get-env[&quot;SHRDLU_AUDIENCE&quot; &quot;public&quot;]]

@when[@equals[@config &#39;audience] &quot;internal&quot;]{
  @warning{This document contains confidential information.}
}</code></pre>
<p>However, with great power comes great responsibility. We’ll explore
security implications and sandboxing strategies in Chapter 13.</p>
<h2 id="multi-format-output-strategy-html-pdf-epub">Multi-Format Output
Strategy (HTML, PDF, EPUB)</h2>
<p>One of Shrdlu’s defining features is its ability to generate multiple
output formats from a single source. This isn’t achieved through
post-processing or conversion—each format is generated directly from the
document’s semantic structure.</p>
<h3 id="unified-document-model">Unified Document Model</h3>
<p>Shrdlu parses documents into an intermediate representation that
captures semantic intent rather than visual presentation:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>(struct document (metadata sections))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>(struct section (level title id content))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>(struct paragraph (elements))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>(struct emphasis (level content))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>(struct math-inline (latex))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>(struct code-block (language content))</span></code></pre></div>
<h3 id="format-specific-rendering">Format-Specific Rendering</h3>
<p>Each output format has its own rendering pipeline that interprets the
document model appropriately:</p>
<p><strong>HTML Output</strong>: - Semantic HTML5 tags - CSS for styling
- JavaScript for interactivity - MathJax for mathematics</p>
<p><strong>PDF Output</strong>: - Direct PDF generation using Racket’s
drawing libraries - Professional typography - Precise layout control -
Vector graphics support</p>
<p><strong>EPUB Output</strong>: - EPUB3 specification compliance -
Reflowable text - Embedded fonts and images - Navigation structures</p>
<h3 id="url-based-format-selection">URL-Based Format Selection</h3>
<p>The web server intelligently serves different formats based on query
parameters:</p>
<p>/section/article → HTML (default) /section/article?fmt=pdf → PDF
/section/article?fmt=epub → EPUB</p>
<p>Pre-generating all formats during build ensures fast response times
and allows CDN caching.</p>
<h2 id="book-roadmap">Book Roadmap</h2>
<p>This book is structured to take you from zero to a fully functional
Shrdlu implementation:</p>
<p><strong>Part I (Chapters 1-3)</strong> establishes foundations:
understanding the project scope, learning necessary Racket concepts, and
designing the markup language.</p>
<p><strong>Part II (Chapters 4-6)</strong> builds the core language
implementation: lexing, parsing, interpretation, and the document
model.</p>
<p><strong>Part III (Chapters 7-9)</strong> implements output generation
for HTML, PDF, and EPUB formats.</p>
<p><strong>Part IV (Chapters 10-12)</strong> constructs the static site
architecture: organization, building, and serving.</p>
<p><strong>Part V (Chapters 13-14)</strong> explores advanced features
and real-world deployment.</p>
<p>Each chapter includes: - Conceptual explanations - Implementation
details with code - Practical examples - Exercises for deeper
understanding</p>
<p>By the end of this journey, you’ll have: 1. A working static site
generator 2. Deep understanding of language implementation 3. Experience
with multiple output formats 4. Knowledge applicable to other DSL
projects</p>
<p>Let’s begin this exciting journey into language design, document
processing, and the powerful world of Racket programming!</p>
<h2 id="summary">Summary</h2>
<p>Shrdlu represents a new paradigm in static site generation—one where
the markup language itself is a full programming language. By building
on Racket’s language-creation facilities, we can create a system that’s
both powerful for advanced users and simple for basic tasks. The
multi-format output strategy ensures our content remains portable and
accessible across different media.</p>
<p>In the next chapter, we’ll dive into Racket’s features that make it
the ideal platform for implementing Shrdlu, setting the stage for our
language implementation journey. # Chapter 2: Racket Fundamentals for
Language Design</p>
<h2 id="why-racket-for-dsl-implementation">Why Racket for DSL
Implementation</h2>
<p>Racket isn’t just another programming language—it’s a language for
creating languages. This fundamental design philosophy makes it the
ideal choice for implementing Shrdlu. While we could build a markup
language processor in Python, JavaScript, or any other language, Racket
offers unique advantages that dramatically simplify our task.</p>
<h3 id="the-language-oriented-programming-paradigm">The
Language-Oriented Programming Paradigm</h3>
<p>Racket embraces “language-oriented programming,” where creating new
languages is a primary problem-solving technique. This approach
recognizes that many programming tasks are best solved by first creating
a language suited to the problem domain, then solving the problem in
that language.</p>
<p>Consider how we might process markup in a traditional language like
Python:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_markup(text):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Complex regex patterns</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># State machines</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># String manipulation</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Error handling</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... hundreds of lines of parsing code</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ast</span></code></pre></div>
<p>In Racket, we can define our language’s syntax declaratively and let
Racket handle the parsing complexity:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>(provide (all-from-out racket))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>(module reader syntax/module-reader</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  shrdlu)</span></code></pre></div>
<h3 id="built-in-language-infrastructure">Built-in Language
Infrastructure</h3>
<p>Racket provides industrial-strength language implementation tools out
of the box:</p>
<ol type="1">
<li><strong>Lexer Generators</strong>: The <code>parser-tools/lex</code>
library provides professional-grade lexical analysis</li>
<li><strong>Parser Generators</strong>: <code>parser-tools/yacc</code>
offers LALR(1) parsing with excellent error reporting</li>
<li><strong>Syntax Objects</strong>: First-class representations of code
with source location tracking</li>
<li><strong>Module System</strong>: Sophisticated namespace management
and separate compilation</li>
<li><strong>Macro System</strong>: Hygienic macros for extending the
language</li>
<li><strong>DrRacket IDE</strong>: Language-aware development
environment with debugging support</li>
</ol>
<h3 id="performance-considerations">Performance Considerations</h3>
<p>While Racket may not match C++ for raw computational speed, it excels
at language processing tasks:</p>
<ul>
<li><strong>JIT Compilation</strong>: Racket’s JIT compiler optimizes
language implementations</li>
<li><strong>Immutable Data Structures</strong>: Persistent data
structures enable efficient functional programming</li>
<li><strong>Green Threads</strong>: Lightweight concurrency for parallel
document processing</li>
<li><strong>FFI Support</strong>: Easy integration with C libraries when
needed</li>
</ul>
<h3 id="community-and-ecosystem">Community and Ecosystem</h3>
<p>Racket’s community has deep expertise in language design:</p>
<ul>
<li>Academic roots in programming language research</li>
<li>Production languages built in Racket (Typed Racket, Datalog,
Redex)</li>
<li>Extensive documentation on language implementation</li>
<li>Active community support for language builders</li>
</ul>
<h2 id="s-expressions-and-homoiconicity">S-expressions and
Homoiconicity</h2>
<p>At the heart of Racket’s power lies a simple but profound idea:
S-expressions (symbolic expressions). Understanding S-expressions is
crucial for implementing Shrdlu effectively.</p>
<h3 id="what-are-s-expressions">What Are S-expressions?</h3>
<p>S-expressions are a notation for nested list structures. Everything
in Racket—data and code alike—is represented as S-expressions:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Numbers</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="dv">42</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">; Strings  </span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Hello, Shrdlu&quot;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">; Symbols</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>&#39;article</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">; Lists</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>&#39;(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>&#39;(<span class="op">+</span> <span class="dv">2</span> <span class="dv">3</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">; Nested structures</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>&#39;(article ((title <span class="st">&quot;My Post&quot;</span>))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  (paragraph <span class="st">&quot;Some content&quot;</span>))</span></code></pre></div>
<p>This uniformity means we can represent our document structure
naturally:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>&#39;(document</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  (metadata </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    (title <span class="st">&quot;The Shrdlu Manual&quot;</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    (author <span class="st">&quot;Jane Doe&quot;</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    (date <span class="st">&quot;2025-10-02&quot;</span>))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  (section ((id <span class="st">&quot;intro&quot;</span>))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    (title <span class="st">&quot;Introduction&quot;</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    (paragraph <span class="st">&quot;Welcome to Shrdlu...&quot;</span>)))</span></code></pre></div>
<h3 id="homoiconicity-code-as-data">Homoiconicity: Code as Data</h3>
<p>Homoiconicity means that code has the same structure as the data it
manipulates. In Racket, both are S-expressions. This property is
transformative for language implementation:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">; This is data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>&#39;(<span class="op">+</span> <span class="dv">1</span> <span class="dv">2</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">; This is code</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>(<span class="op">+</span> <span class="dv">1</span> <span class="dv">2</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">; We can manipulate code as data</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> expr </span>&#39;(<span class="op">+</span> <span class="dv">1</span> <span class="dv">2</span>))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> modified-expr </span>(<span class="kw">append</span> expr &#39;(<span class="dv">3</span> <span class="dv">4</span>)))</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">; modified-expr is &#39;(+ 1 2 3 4)</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">; And evaluate data as code</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">eval</span> modified-expr)  <span class="co">; Returns 10</span></span></code></pre></div>
<p>For Shrdlu, this means we can: 1. Parse markup into S-expressions 2.
Transform those S-expressions 3. Evaluate them to produce output</p>
<h3 id="reader-syntax-and-notation">Reader Syntax and Notation</h3>
<p>While S-expressions are powerful, they can be verbose. Racket
provides reader syntax extensions to make code more readable:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Quote shorthand</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>&#39;(a b c)  <span class="co">; Same as (quote (a b c))</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">; Quasiquote for templates</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>`(article ,title ,@paragraphs)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">; Vector literal</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>#(<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">; Hash table literal</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>#hash((key1 <span class="op">.</span> <span class="st">&quot;value1&quot;</span>) (key2 <span class="op">.</span> <span class="st">&quot;value2&quot;</span>))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">; Here strings</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="st">#&lt;&lt;END</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="ot">This is a multi-line</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="ot">string literal</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="ot">END</span></span></code></pre></div>
<p>We’ll leverage these conveniences when implementing Shrdlu’s
parser.</p>
<h3 id="practical-s-expression-manipulation">Practical S-expression
Manipulation</h3>
<p>Let’s explore common patterns for working with S-expressions that
we’ll use throughout Shrdlu:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Pattern matching on S-expressions</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(process-element elem)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  (match elem</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>`(paragraph ,@contents)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>     (process-paragraph contents)<span class="op">]</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>`(emphasis ,level ,text)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>     (process-emphasis level text)<span class="op">]</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>`(math ,latex)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>     (process-math latex)<span class="op">]</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">error</span> <span class="st">&quot;Unknown element type&quot;</span>)<span class="op">]</span>))</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">; Building S-expressions programmatically</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-section title <span class="op">.</span> content)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  `(section ((title ,title))</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    ,@content))</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">; Transforming S-expressions</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(add-ids doc)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> (<span class="op">[</span>counter <span class="dv">0</span><span class="op">]</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> </span>(add-id elem)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">set!</span> counter (<span class="op">+</span> counter <span class="dv">1</span>))</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>      (match elem</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>`(,tag ((,@attrs)) ,@content)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>         `(,tag ((id ,(format <span class="st">&quot;elem-~a&quot;</span> counter)) ,@attrs)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>            ,@(map add-id content))<span class="op">]</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>`(,tag ,@content)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>         `(,tag ((id ,(format <span class="st">&quot;elem-~a&quot;</span> counter)))</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>            ,@(map add-id content))<span class="op">]</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span><span class="kw">else</span> elem<span class="op">]</span>))</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    (add-id doc)))</span></code></pre></div>
<h2 id="macros-and-language-extensions">Macros and Language
Extensions</h2>
<p>Racket’s macro system is perhaps its most powerful feature for
language implementation. Unlike string-based macros in C, Racket macros
are hygienic, composable, and operate on abstract syntax trees.</p>
<h3 id="understanding-macros">Understanding Macros</h3>
<p>A macro is a syntax transformer—it takes code as input and produces
code as output, all at compile time:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Simple macro example</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>(define-syntax-rule (when <span class="kw">condition</span> body <span class="op">...</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> <span class="kw">condition</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">begin</span> body <span class="op">...</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>      (void)))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">; Usage</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>(when (<span class="op">&gt;</span> x <span class="dv">10</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  (displayln <span class="st">&quot;x is large&quot;</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  (process x))</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">; Expands to:</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">if</span> (<span class="op">&gt;</span> x <span class="dv">10</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">begin</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>      (displayln <span class="st">&quot;x is large&quot;</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>      (process x))</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    (void))</span></code></pre></div>
<h3 id="pattern-based-macros">Pattern-Based Macros</h3>
<p>The <code>syntax-rules</code> form provides pattern matching for
macro definitions:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> shrdlu-let</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-rules</span> ()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">; Pattern 1: single binding</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(shrdlu-let (<span class="op">[</span>var val<span class="op">]</span>) body <span class="op">...</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> (<span class="op">[</span>var val<span class="op">]</span>) body <span class="op">...</span>)<span class="op">]</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">; Pattern 2: multiple bindings</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(shrdlu-let (<span class="op">[</span>var val<span class="op">]</span> <span class="op">...</span>) body <span class="op">...</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> (<span class="op">[</span>var val<span class="op">]</span> <span class="op">...</span>) body <span class="op">...</span>)<span class="op">]</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">; Pattern 3: named let</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(shrdlu-let name (<span class="op">[</span>var val<span class="op">]</span> <span class="op">...</span>) body <span class="op">...</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> name (<span class="op">[</span>var val<span class="op">]</span> <span class="op">...</span>) body <span class="op">...</span>)<span class="op">]</span>))</span></code></pre></div>
<h3 id="syntax-objects-and-hygiene">Syntax Objects and Hygiene</h3>
<p>Racket macros work with syntax objects, which carry lexical context
and source location information:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(debug-location stx)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-case</span> stx ()</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> expr)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">with-syntax</span> (<span class="op">[</span>line (syntax-line #&#39;expr)<span class="op">]</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                   <span class="op">[</span>col (syntax-column #&#39;expr)<span class="op">]</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                   <span class="op">[</span>source (syntax-source #&#39;expr)<span class="op">]</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>       #&#39;(<span class="kw">begin</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>           (printf <span class="st">&quot;Evaluating at ~a:~a:~a</span><span class="ch">\n</span><span class="st">&quot;</span> </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                   &#39;source &#39;line &#39;col)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>           expr))<span class="op">]</span>))</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">; Usage</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>(debug-location (<span class="op">+</span> <span class="dv">1</span> <span class="dv">2</span>))</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">; Prints: Evaluating at &quot;filename.rkt&quot;:25:3</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">; Returns: 3</span></span></code></pre></div>
<h3 id="procedural-macros-with-syntax-case">Procedural Macros with
<code>syntax-case</code></h3>
<p>For complex transformations, we need procedural macros:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(define-shrdlu-element stx)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-case</span> stx ()</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> name (attr <span class="op">...</span>) renderer)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">with-syntax</span> (<span class="op">[</span>struct-name (format-id #&#39;name <span class="st">&quot;~a-element&quot;</span> #&#39;name)<span class="op">]</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                   <span class="op">[</span>make-name (format-id #&#39;name <span class="st">&quot;make-~a&quot;</span> #&#39;name)<span class="op">]</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                   <span class="op">[</span>(attr-accessor <span class="op">...</span>) </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                    (map (λ (a) (format-id a <span class="st">&quot;~a-~a&quot;</span> #&#39;name a))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>                         (syntax-&gt;list #&#39;(attr <span class="op">...</span>)))<span class="op">]</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>       #&#39;(<span class="kw">begin</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>           <span class="co">; Define the structure</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>           (struct struct-name (attr <span class="op">...</span>) #:transparent)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>           <span class="co">; Define constructor</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>           (<span class="ex">define</span><span class="fu"> </span>(make-name attr <span class="op">...</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>             (struct-name attr <span class="op">...</span>))</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>           <span class="co">; Register renderer</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>           (register-renderer! &#39;name renderer)))<span class="op">]</span>))</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">; Usage</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>(define-shrdlu-element emphasis (level content)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  (λ (elem format)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">case</span> format</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(html) `(em ,(emphasis-content elem))<span class="op">]</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(pdf) (make-pdf-emphasis (emphasis-level elem)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>                               (emphasis-content elem))<span class="op">]</span>)))</span></code></pre></div>
<h3 id="macro-debugging-techniques">Macro Debugging Techniques</h3>
<p>Debugging macros can be challenging. Here are essential
techniques:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Macro stepper in DrRacket</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">; Use the Macro Stepper tool to visualize expansion</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">; Manual expansion</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">syntax-&gt;datum</span> (expand-once #&#39;(when true (displayln <span class="st">&quot;yes&quot;</span>))))</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">; Debugging with syntax-parse</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>(require syntax/parse)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(robust-macro stx)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  (syntax-parse stx</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> (~optional (~seq #:opt opt-val))</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        arg:expr <span class="op">...</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>     #:with expanded-arg (do-something #&#39;arg)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>     #&#39;(<span class="kw">begin</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>         (~? (use-opt opt-val))</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>         expanded-arg <span class="op">...</span>)<span class="op">]</span>))</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">; Compile-time printf debugging</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(ct-debug stx)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-case</span> stx ()</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> expr)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">begin</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>       (printf <span class="st">&quot;Compile time: ~v</span><span class="ch">\n</span><span class="st">&quot;</span> (<span class="kw">syntax-&gt;datum</span> #&#39;expr))</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>       #&#39;expr)<span class="op">]</span>))</span></code></pre></div>
<h2 id="the-lang-mechanism">The <code>#lang</code> Mechanism</h2>
<p>The <code>#lang</code> mechanism is Racket’s crown jewel for language
implementation. It allows us to define completely new languages that
integrate seamlessly with the Racket ecosystem.</p>
<h3 id="how-lang-works">How <code>#lang</code> Works</h3>
<p>When Racket sees a file beginning with <code>#lang</code>, it:</p>
<ol type="1">
<li>Loads the specified language module</li>
<li>Uses that module’s reader to parse the file</li>
<li>Compiles and runs the resulting program</li>
</ol>
<div class="sourceCode" id="cb20"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>#lang shrdlu</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>@article<span class="op">[</span>#:title <span class="st">&quot;Understanding #lang&quot;</span><span class="op">]{</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  This file is written in our custom Shrdlu language!</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="creating-a-basic-language">Creating a Basic Language</h3>
<p>Here’s the minimal structure for a new language:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">; shrdlu/main.rkt</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>#lang racket/base</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>(provide (all-from-out racket/base))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">; Export our special forms</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>(provide article section paragraph)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>(define-syntax-rule (article opts body <span class="op">...</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  (make-article &#39;opts (<span class="kw">list</span> body <span class="op">...</span>)))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>(define-syntax-rule (section title body <span class="op">...</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  (make-section title (<span class="kw">list</span> body <span class="op">...</span>)))</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">; ... more definitions ...</span></span></code></pre></div>
<h3 id="implementing-a-custom-reader">Implementing a Custom Reader</h3>
<p>For Shrdlu’s <code>@</code>-notation, we need a custom reader:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">; shrdlu/reader.rkt</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>#lang s-exp syntax/module-reader</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>shrdlu</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>#:read shrdlu-read</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>#:read-syntax shrdlu-read-syntax</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;parser.rkt&quot;</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(shrdlu-read in)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-&gt;datum</span> (shrdlu-read-syntax <span class="dv">#f</span> in)))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(shrdlu-read-syntax src in)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  (parse-shrdlu-port src in))</span></code></pre></div>
<h3 id="language-configuration">Language Configuration</h3>
<p>Languages can be configured through various mechanisms:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Language info module</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>(module info racket/setup/infotab</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> name </span><span class="st">&quot;Shrdlu&quot;</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> deps </span>&#39;(<span class="st">&quot;base&quot;</span> <span class="st">&quot;parser-tools-lib&quot;</span> <span class="st">&quot;draw-lib&quot;</span>))</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> build-deps </span>&#39;(<span class="st">&quot;racket-doc&quot;</span> <span class="st">&quot;scribble-lib&quot;</span>))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> scribblings </span>&#39;((<span class="st">&quot;scribblings/shrdlu.scrbl&quot;</span>)))</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> compile-omit-paths </span>&#39;(<span class="st">&quot;examples&quot;</span>))</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> test-omit-paths </span>&#39;(<span class="st">&quot;examples&quot;</span>)))</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">; Configure module language</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>(module configure-runtime racket/base</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  (require shrdlu/runtime-config)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  (configure-shrdlu-runtime!))</span></code></pre></div>
<h3 id="module-phases-and-compile-time-programming">Module Phases and
Compile-Time Programming</h3>
<p>Understanding Racket’s phase system is crucial for language
implementation:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">; Phase 0: Runtime</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(process-document doc)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  (render-html doc))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">; Phase 1: Compile time (for macros)</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>(begin-for-syntax</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(generate-id base)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    (format <span class="st">&quot;~a-~a&quot;</span> base (gensym))))</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">; Cross-phase persistent data</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(save-compile-time-info stx)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-case</span> stx ()</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> key value)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>     #&#39;(begin-for-syntax</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>         (hash-set! compile-time-table &#39;key &#39;value))<span class="op">]</span>))</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co">; Using phase 1 functions in macros</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(auto-id stx)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-case</span> stx ()</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> name)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">with-syntax</span> (<span class="op">[</span>id (generate-id (<span class="kw">syntax-&gt;datum</span> #&#39;name))<span class="op">]</span>)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>       #&#39;(<span class="ex">define</span><span class="fu"> name </span>&#39;id))<span class="op">]</span>))</span></code></pre></div>
<h2 id="essential-racket-libraries-for-our-project">Essential Racket
Libraries for Our Project</h2>
<p>Implementing Shrdlu requires leveraging several key Racket libraries.
Let’s explore each one in detail.</p>
<h3 id="parser-tools">Parser Tools</h3>
<p>The <code>parser-tools</code> collection provides industrial-strength
lexing and parsing:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>(require parser-tools/lex</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>         (prefix-in : parser-tools/lex-sre)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>         parser-tools/yacc)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">; Define tokens</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>(define-tokens value-tokens</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  (STRING NUMBER IDENTIFIER))</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>(define-empty-tokens op-tokens</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  (LPAREN RPAREN </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>   LBRACKET RBRACKET</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>   AT-SIGN COMMA</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>   EOF))</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">; Lexer definition</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> shrdlu-lexer</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  (lexer</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>whitespace (token-WHITESPACE)<span class="op">]</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span><span class="st">&quot;@&quot;</span> (token-AT-SIGN)<span class="op">]</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span><span class="st">&quot;(&quot;</span> (token-LPAREN)<span class="op">]</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span><span class="st">&quot;)&quot;</span> (token-RPAREN)<span class="op">]</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span><span class="st">&quot;[&quot;</span> (token-LBRACKET)<span class="op">]</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span><span class="st">&quot;]&quot;</span> (token-RBRACKET)<span class="op">]</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span><span class="st">&quot;,&quot;</span> (token-COMMA)<span class="op">]</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>   <span class="co">; Strings with escape sequences</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(:: <span class="ch">#\&quot;</span> </span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        (:* (:or (:~ <span class="ch">#\&quot;</span> <span class="ch">#\\</span>)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>                 (:: <span class="ch">#\\</span> any-char)))</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>        <span class="ch">#\&quot;</span>)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    (token-STRING (parse-string lexeme))<span class="op">]</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>   <span class="co">; Numbers</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(:or (:: (:? <span class="ch">#\-</span>) (:+ numeric))</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>         (:: (:? <span class="ch">#\-</span>) (:+ numeric) <span class="ch">#\.</span> (:+ numeric)))</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    (token-NUMBER (<span class="kw">string-&gt;number</span> lexeme))<span class="op">]</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>   <span class="co">; Identifiers</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(:: (:or alphabetic <span class="ch">#\-</span> <span class="ch">#\_</span>)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        (:* (:or alphabetic numeric <span class="ch">#\-</span> <span class="ch">#\_</span>)))</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    (token-IDENTIFIER (<span class="kw">string-&gt;symbol</span> lexeme))<span class="op">]</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(eof) (token-EOF)<span class="op">]</span>))</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a><span class="co">; Parser definition</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> shrdlu-parser</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>  (parser</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>   (start document)</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>   (end EOF)</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>   (tokens value-tokens op-tokens)</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">error</span> (λ (tok-ok? tok-name tok-value)</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">error</span> &#39;parser <span class="st">&quot;Unexpected token ~a&quot;</span> tok-name)))</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>   (grammar</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    (document</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(element) $1<span class="op">]</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(element document) (<span class="kw">cons</span> $1 $2)<span class="op">]</span>)</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>    (element</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT-SIGN IDENTIFIER) `(,$2)<span class="op">]</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT-SIGN IDENTIFIER LBRACKET args RBRACKET)</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>      `(,$2 (attrs ,@$4))<span class="op">]</span></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT-SIGN IDENTIFIER LBRACKET args RBRACKET </span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>       LPAREN body RPAREN)</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>      `(,$2 (attrs ,@$4) ,@$7)<span class="op">]</span>)</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">; ... more grammar rules ...</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>    )))</span></code></pre></div>
<h3 id="drawing-and-pdf-generation">Drawing and PDF Generation</h3>
<p>For PDF output, we’ll use Racket’s drawing libraries:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(require racket/draw</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>         racket/class</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>         pict)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">; Create a PDF device context</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(create-pdf-context filename width height)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ps-setup </span>(new ps-setup%))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  (send ps-setup set-paper-name <span class="st">&quot;Letter&quot;</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  (send ps-setup set-orientation &#39;portrait)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(new pdf-dc%</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>interactive <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>use-paper-bbox <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>width width<span class="op">]</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>height height<span class="op">]</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>output filename<span class="op">]</span>))</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  (send dc start-doc <span class="st">&quot;Shrdlu Document&quot;</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  dc)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="co">; Text rendering with font control</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-text dc text font-name font-size x y)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> font </span>(make-font </span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>                #:size font-size</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>                #:face font-name</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>                #:family &#39;default))</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  (send dc set-font font)</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  (send dc draw-text text x y))</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="co">; Advanced layout with pict</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(create-document-pict elements)</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>  (apply vl-append <span class="dv">12</span>  <span class="co">; 12 pixels spacing</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    (map render-element-pict elements)))</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-element-pict elem)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>  (match elem</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>`(heading ,level ,text)</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>     (text text (<span class="kw">cons</span> &#39;bold &#39;default) </span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>           (<span class="op">-</span> <span class="dv">24</span> (<span class="op">*</span> <span class="dv">2</span> level)))<span class="op">]</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>`(paragraph ,@words)</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>     (para #:width <span class="dv">600</span> </span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>           (apply <span class="kw">string-append</span> </span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>                  (add-between words <span class="st">&quot; &quot;</span>)))<span class="op">]</span></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>`(code ,lang ,content)</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>     (colorize</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>      (frame (tt content) #:color <span class="st">&quot;gray&quot;</span>)</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;black&quot;</span>)<span class="op">]</span>))</span></code></pre></div>
<h3 id="web-server">Web Server</h3>
<p>Racket includes a production-ready web server:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(require web-server/servlet</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>         web-server/servlet-env</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>         web-server/http</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>         net/url)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">; Define servlet for handling requests</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(shrdlu-servlet req)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> url </span>(request-uri req))</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> path </span>(url-&gt;path url))</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> query </span>(url-query url))</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> format </span>(get-format query))</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  (match path</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">list</span> section article)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>     (serve-article section article format)<span class="op">]</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>     (not-found)<span class="op">]</span>))</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(serve-article section article format)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> content-type</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">case</span> format</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(html) <span class="st">&quot;text/html; charset=utf-8&quot;</span><span class="op">]</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(pdf) <span class="st">&quot;application/pdf&quot;</span><span class="op">]</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(epub) <span class="st">&quot;application/epub+zip&quot;</span><span class="op">]</span>))</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  (response/output</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>   #:mime-type content-type</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>   (λ (out)</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> filename </span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>       (build-path <span class="st">&quot;output&quot;</span> section article </span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>                   (format <span class="st">&quot;index.~a&quot;</span> format)))</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">call-with-input-file</span> filename</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>       (λ (in)</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>         (copy-port in out))))))</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a><span class="co">; Start the server</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(start-shrdlu-server #:port <span class="op">[</span>port <span class="dv">8080</span><span class="op">]</span>)</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>  (serve/servlet shrdlu-servlet</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>                 #:port port</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>                 #:launch-browser? <span class="dv">#f</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>                 #:servlet-path <span class="st">&quot;/&quot;</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>                 #:servlet-regexp #rx<span class="st">&quot;&quot;</span>))</span></code></pre></div>
<h3 id="file-system-and-path-utilities">File System and Path
Utilities</h3>
<p>Racket provides excellent file system manipulation:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>(require racket/file</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>         racket/path</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>         file/glob)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">; Directory structure management</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(ensure-output-structure)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>dir &#39;(<span class="st">&quot;output&quot;</span> <span class="st">&quot;output/html&quot;</span> <span class="st">&quot;output/pdf&quot;</span> </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;output/epub&quot;</span> <span class="st">&quot;cache&quot;</span>)<span class="op">]</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    (make-directory* dir)))</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">; Find all Shrdlu source files</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(find-shrdlu-files root)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[</span>file (in-glob (build-path root <span class="st">&quot;**/*.shrdlu&quot;</span>))<span class="op">]</span>)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    (define-values (base name dir?) (split-path file))</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">list</span> file </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>          (path-&gt;string (find-relative-path root base))</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>          (path-replace-extension name <span class="st">&quot;&quot;</span>))))</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co">; Watch for changes</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>(require file/sha1)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(watch-files files callback)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> checksums </span>(make-hash))</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(update-and-check file)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> new-sum </span>(file-sha1 file))</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> old-sum </span>(hash-ref checksums file <span class="dv">#f</span>))</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    (hash-set! checksums file new-sum)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">and</span> old-sum (<span class="kw">not</span> (<span class="kw">equal?</span> old-sum new-sum))))</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> loop ()</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    (for (<span class="op">[</span>file files<span class="op">]</span>)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>      (when (update-and-check file)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>        (callback file)))</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    (sleep <span class="dv">1</span>)</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    (loop)))</span></code></pre></div>
<h3 id="testing-framework">Testing Framework</h3>
<p>Racket’s built-in testing framework is perfect for language
development:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(require rackunit</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>         rackunit/text-ui)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">; Unit tests for parser</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> parser-tests</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  (test-suite <span class="st">&quot;Parser Tests&quot;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    (test-case <span class="st">&quot;Simple element&quot;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>      (check-equal? (parse-string <span class="st">&quot;@title{Hello}&quot;</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                    &#39;(title <span class="st">&quot;Hello&quot;</span>)))</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    (test-case <span class="st">&quot;Element with attributes&quot;</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>      (check-equal? (parse-string <span class="st">&quot;@link[#:href </span><span class="ch">\&quot;</span><span class="st">http://example.com</span><span class="ch">\&quot;</span><span class="st">]{text}&quot;</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>                    &#39;(link (attrs (href <span class="st">&quot;http://example.com&quot;</span>)) <span class="st">&quot;text&quot;</span>)))</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    (test-case <span class="st">&quot;Nested elements&quot;</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>      (check-equal? </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>       (parse-string <span class="st">&quot;@section{@title{Intro} @p{Some text}}&quot;</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>       &#39;(section (title <span class="st">&quot;Intro&quot;</span>) (p <span class="st">&quot;Some text&quot;</span>))))))</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="co">; Property-based testing with quickcheck</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>(require quickcheck)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(gen-shrdlu-element)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  (sized (λ (size)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (<span class="kw">zero?</span> size)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>        (choose (gen-const &#39;(text <span class="st">&quot;hello&quot;</span>))</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>                (gen-const &#39;(br)))</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>        (gen-bind (choose (gen-const &#39;p)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>                         (gen-const &#39;em)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>                         (gen-const &#39;strong))</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>                  (λ (tag)</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>                    (gen-map (λ (children)</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>                               `(,tag ,@children))</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>                             (gen-list (gen-resize </span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>                                       (<span class="kw">quotient</span> size <span class="dv">2</span>)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>                                       gen-shrdlu-element)))))))))</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>(quickcheck</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a> (property (<span class="op">[</span>elem gen-shrdlu-element<span class="op">]</span>)</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>   (valid-element? elem)))</span></code></pre></div>
<h2 id="setting-up-the-development-environment">Setting Up the
Development Environment</h2>
<p>Let’s configure a productive development environment for Shrdlu.</p>
<h3 id="project-structure">Project Structure</h3>
<p>shrdlu/ ├── README.md ├── info.rkt ├── main.rkt ├── lang/ │ ├──
reader.rkt │ └── parser.rkt ├── compiler/ │ ├── lexer.rkt │ ├──
syntax.rkt │ └── expander.rkt ├── runtime/ │ ├── document.rkt │ ├──
evaluation.rkt │ └── library.rkt ├── generators/ │ ├── html.rkt │ ├──
pdf.rkt │ └── epub.rkt ├── server/ │ └── web.rkt ├── tests/ │ ├──
parser-tests.rkt │ ├── eval-tests.rkt │ └── integration-tests.rkt └──
examples/ ├── blog/ └── documentation/</p>
<h3 id="package-definition">Package Definition</h3>
<p>Create <code>info.rkt</code> for package management:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>#lang info</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> collection </span><span class="st">&quot;shrdlu&quot;</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> version </span><span class="st">&quot;0.1.0&quot;</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> deps </span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  &#39;(<span class="st">&quot;base&quot;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;parser-tools-lib&quot;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;web-server-lib&quot;</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;draw-lib&quot;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;pict-lib&quot;</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;rackunit-lib&quot;</span>))</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> build-deps </span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  &#39;(<span class="st">&quot;scribble-lib&quot;</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;racket-doc&quot;</span>))</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> scribblings </span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  &#39;((<span class="st">&quot;scribblings/shrdlu.scrbl&quot;</span> (multi-page))))</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> raco-commands</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  &#39;((<span class="st">&quot;shrdlu&quot;</span> (submod shrdlu/cli main) <span class="st">&quot;Shrdlu command line tool&quot;</span> <span class="dv">#f</span>)))</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> compile-omit-paths </span>&#39;(<span class="st">&quot;examples&quot;</span>))</span></code></pre></div>
<h3 id="drracket-configuration">DrRacket Configuration</h3>
<p>Configure DrRacket for Shrdlu development:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">; .drracket-prefs.rkt</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>#lang racket/base</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> preferences</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  &#39;((drracket:tabify-on-return? <span class="dv">#f</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    (drracket:indent-mode &#39;racket)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    (drracket:show-line-numbers? <span class="dv">#t</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    (drracket:syntax-coloring-active? <span class="dv">#t</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    (drracket:backup-files? <span class="dv">#t</span>)))</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">; Custom keybindings for Shrdlu development</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> keybindings</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  &#39;((<span class="st">&quot;c:x;c:t&quot;</span> <span class="st">&quot;run-shrdlu-tests&quot;</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;c:x;c:b&quot;</span> <span class="st">&quot;build-shrdlu-site&quot;</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;c:x;c:p&quot;</span> <span class="st">&quot;preview-shrdlu-output&quot;</span>)))</span></code></pre></div>
<h3 id="command-line-interface">Command Line Interface</h3>
<p>Create a CLI tool for Shrdlu:</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">; cli.rkt</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>#lang racket/base</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>(require racket/cmdline</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>         racket/path</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;compiler/main.rkt&quot;</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;server/web.rkt&quot;</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> build-mode </span>&#39;incremental)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> output-dir </span><span class="st">&quot;output&quot;</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> watch? </span><span class="dv">#f</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> serve? </span><span class="dv">#f</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> port </span><span class="dv">8080</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>(module+ main</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  (command-line</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>   #:program <span class="st">&quot;shrdlu&quot;</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>   #:once-each</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;-o&quot;</span> <span class="st">&quot;--output&quot;</span>) dir</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;Output directory&quot;</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>                      (<span class="kw">set!</span> output-dir dir)<span class="op">]</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;-w&quot;</span> <span class="st">&quot;--watch&quot;</span>) <span class="st">&quot;Watch for changes&quot;</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">set!</span> watch? <span class="dv">#t</span>)<span class="op">]</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;-s&quot;</span> <span class="st">&quot;--serve&quot;</span>) <span class="st">&quot;Start web server&quot;</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">set!</span> serve? <span class="dv">#t</span>)<span class="op">]</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;-p&quot;</span> <span class="st">&quot;--port&quot;</span>) p</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;Server port&quot;</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">set!</span> port (<span class="kw">string-&gt;number</span> p))<span class="op">]</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;--full&quot;</span>) <span class="st">&quot;Full rebuild&quot;</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">set!</span> build-mode &#39;full)<span class="op">]</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>   #:args (source-dir)</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">cond</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>serve?</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>      (thread (λ () (build-site source-dir output-dir build-mode)))</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>      (start-server #:port port #:root output-dir)</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>      (when watch?</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>        (watch-and-rebuild source-dir output-dir))<span class="op">]</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>watch?</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>      (build-site source-dir output-dir build-mode)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>      (watch-and-rebuild source-dir output-dir)<span class="op">]</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="kw">else</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>      (build-site source-dir output-dir build-mode)<span class="op">]</span>)))</span></code></pre></div>
<h3 id="development-workflow">Development Workflow</h3>
<p>Here’s a typical development session:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial setup</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> raco pkg install <span class="at">--link</span> shrdlu/</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Run tests</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> raco test shrdlu/tests/</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Build examples</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> racket shrdlu/cli.rkt <span class="at">--output</span> build/ examples/blog/</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Development mode with auto-rebuild</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> racket shrdlu/cli.rkt <span class="at">--watch</span> <span class="at">--serve</span> examples/blog/</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co"># REPL development</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> racket</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="kw">(</span><span class="ex">require</span> shrdlu<span class="kw">)</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> <span class="kw">(</span><span class="ex">parse-shrdlu-string</span> <span class="st">&quot;@article{Hello, world!}&quot;</span><span class="kw">)</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;(article &quot;Hello, world!&quot;)</span></span></code></pre></div>
<h3 id="debugging-tools">Debugging Tools</h3>
<p>Create debugging utilities:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">; debug.rkt</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>#lang racket/base</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>(require syntax/parse/define</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>         racket/pretty)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>(define-simple-macro (debug-expr expr)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">begin</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    (printf <span class="st">&quot;~a:~a: &quot;</span> </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>            (syntax-source #&#39;expr)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>            (syntax-line #&#39;expr))</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    (pretty-write &#39;expr)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    (printf <span class="st">&quot; =&gt; &quot;</span>)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> result </span>expr)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    (pretty-write result)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">newline</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    result))</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="co">; Trace document transformations</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(trace-transform transform doc)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  (printf <span class="st">&quot;=== Transform: ~a ===</span><span class="ch">\n</span><span class="st">&quot;</span> </span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>          (object-name transform))</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>  (printf <span class="st">&quot;Input:</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  (pretty-write doc)</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> result </span>(transform doc))</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>  (printf <span class="st">&quot;Output:</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  (pretty-write result)</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>  (printf <span class="st">&quot;===================</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>  result)</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="co">; Visual AST inspector</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>(require mrlib/tree-layout)</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(visualize-ast ast)</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(ast-&gt;tree node)</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    (match node</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">list</span> op args <span class="op">...</span>)</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>       (tree-layout #:pict (text (<span class="kw">symbol-&gt;string</span> op))</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>                   (map ast-&gt;tree args))<span class="op">]</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>atom</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>       (tree-layout #:pict (text (~v atom)))<span class="op">]</span>))</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>  (show-pict (naive-layered (ast-&gt;tree ast))))</span></code></pre></div>
<h2 id="summary-1">Summary</h2>
<p>This chapter has laid the groundwork for implementing Shrdlu by
exploring Racket’s fundamental language-building features. We’ve seen
how:</p>
<ol type="1">
<li><strong>Racket’s philosophy</strong> of language-oriented
programming aligns perfectly with our goals</li>
<li><strong>S-expressions and homoiconicity</strong> provide a uniform
representation for both code and data</li>
<li><strong>The macro system</strong> enables powerful, hygienic syntax
extensions</li>
<li><strong>The <code>#lang</code> mechanism</strong> allows seamless
integration of new languages</li>
<li><strong>Rich libraries</strong> provide industrial-strength tools
for parsing, drawing, and web serving</li>
<li><strong>Development tools</strong> support productive language
implementation</li>
</ol>
<p>These concepts form the foundation upon which we’ll build Shrdlu. In
the next chapter, we’ll put this knowledge to use by designing Shrdlu’s
markup language syntax and semantics. We’ll make crucial decisions about
notation, built-in constructs, and the balance between simplicity and
power.</p>
<p>The journey from understanding these fundamentals to implementing a
complete language may seem daunting, but Racket’s tools make each step
manageable. As we progress, you’ll see how these abstract concepts
translate into practical implementation techniques.</p>
<h3 id="exercises">Exercises</h3>
<ol type="1">
<li><p><strong>S-expression Manipulation</strong>: Write a function that
converts nested HTML-like S-expressions into a flat list of opening and
closing tags:</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>(flatten-tags &#39;(<span class="kw">div</span> (p <span class="st">&quot;Hello&quot;</span>) (p <span class="st">&quot;World&quot;</span>)))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co">; =&gt; &#39;(open-div open-p &quot;Hello&quot; close-p open-p &quot;World&quot; close-p close-div)</span></span></code></pre></div></li>
<li><p><strong>Macro Practice</strong>: Create a
<code>@define-element</code> macro that generates both a constructor
function and a predicate:</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(@define-element paragraph content)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co">; Should create:</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">; - (make-paragraph content)</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">; - (paragraph? obj)</span></span></code></pre></div></li>
<li><p><strong>Mini-Language</strong>: Implement a tiny
<code>#lang</code> that only supports arithmetic:</p>
<pre><code>#lang arithmetic
2 + 3 * 4
(1 + 2) * (3 + 4)</code></pre></li>
<li><p><strong>Parser Experimentation</strong>: Use
<code>parser-tools</code> to create a parser for a subset of Markdown
(headers, paragraphs, and emphasis).</p></li>
<li><p><strong>Drawing Challenge</strong>: Use Racket’s
<code>pict</code> library to create a function that renders a simple
document tree as a visual diagram.</p></li>
</ol>
<p>These exercises will prepare you for the implementation challenges
ahead. In Chapter 3, we’ll design Shrdlu’s syntax and semantics, making
crucial decisions that will shape the entire system. # Chapter 3:
Designing the Shrdlu Markup Language</p>
<h2 id="language-philosophy-and-goals">Language Philosophy and
Goals</h2>
<p>Designing a markup language is fundamentally different from designing
a general-purpose programming language. While programming languages
optimize for algorithmic expression and computational efficiency, markup
languages must balance human readability, semantic richness, and
processing capabilities. Shrdlu aims to transcend traditional markup
limitations by embracing computation while maintaining the clarity that
makes markup languages successful.</p>
<h3 id="core-design-principles">Core Design Principles</h3>
<p><strong>1. Progressive Enhancement</strong> The language should be
simple for simple tasks but scale gracefully to complex ones. A user
writing a basic blog post shouldn’t need to understand the language’s
computational features:</p>
<pre class="shrdlu"><code>@article[#:title &quot;My First Post&quot;]{
  This is a simple paragraph with @em{emphasis} and a 
  @link[#:href &quot;https://example.com&quot;]{link}.
}</code></pre>
<p>Yet the same language should support sophisticated document
generation:</p>
<pre class="shrdlu"><code>@article[#:title &quot;Fibonacci Sequence Analysis&quot;]{
  @define[fib][n]{
    @if[@&lt; [n 2]]{n}{
      @+ [@fib[@- [n 1]]] [@fib[@- [n 2]]]
    }
  }
  
  The first 20 Fibonacci numbers are:
  @for[i @in [@range[20]]]{
    F@sub{@i} = @fib[@i]@if[@&lt; [i 19]]{, }
  }
}</code></pre>
<p><strong>2. Semantic Markup First</strong> Unlike HTML’s presentation
bias or Markdown’s limited semantics, Shrdlu prioritizes meaning:</p>
<pre class="shrdlu"><code>@theorem[#:label &quot;pythagoras&quot; #:name &quot;Pythagorean Theorem&quot;]{
  In a right triangle, the square of the hypotenuse equals 
  the sum of squares of the other two sides: @math{a^2 + b^2 = c^2}.
}

@proof{
  Consider the diagram in @ref[figure &quot;right-triangle-proof&quot;]...
}</code></pre>
<p><strong>3. Homoiconicity and Metaprogramming</strong> Following Lisp
tradition, Shrdlu code is data and data is code:</p>
<pre class="shrdlu"><code>@define[make-section][title content]{
  @list[&#39;section 
        @list[@list[&#39;title title]]
        content]
}

@eval[@make-section[&quot;Dynamic Section&quot; &quot;This section was generated programmatically&quot;]]</code></pre>
<p><strong>4. Multi-Format Awareness</strong> Document elements know
they might be rendered in different formats:</p>
<pre class="shrdlu"><code>@figure[#:label &quot;data-viz&quot;]{
  @format-switch{
    @case[html]{
      @javascript-chart[type: &quot;bar&quot; data: sales-data]
    }
    @case[pdf]{
      @static-chart[sales-data]
    }
    @case[epub]{
      @table[sales-data]  ; Fallback to table for e-readers
    }
  }
}</code></pre>
<p><strong>5. Computational Completeness Without Complexity</strong>
While Turing-complete, the language shouldn’t require programming
knowledge for common tasks. Computational features are opt-in:</p>
<pre class="shrdlu"><code>; Simple static content
@section{Introduction}

; Computed content when needed
@section{
  @string-append[&quot;Chapter &quot; @number-&gt;string[chapter-num] &quot;: &quot;
                 @get-chapter-title[chapter-num]]
}</code></pre>
<h3 id="target-audiences-and-use-cases">Target Audiences and Use
Cases</h3>
<p>Understanding who will use Shrdlu shapes our design decisions:</p>
<p><strong>Technical Writers and Documentarians</strong> - Need rich
cross-referencing - Require automated numbering and indexing - Want
conditional content for different audiences - Value single-source
publishing</p>
<p><strong>Bloggers and Content Creators</strong> - Prioritize ease of
use - Want attractive default styling - Need social media integration -
Appreciate built-in SEO features</p>
<p><strong>Academic Authors</strong> - Require citations and
bibliographies - Need mathematical typesetting - Want precise PDF
control - Value reproducible documents</p>
<p><strong>Data Scientists and Analysts</strong> - Need to embed
computations - Want to generate charts from data - Require literate
programming features - Value reproducible research</p>
<h3 id="design-trade-offs">Design Trade-offs</h3>
<p>Every language design involves compromises. Here are Shrdlu’s key
trade-offs:</p>
<p><strong>Readability vs. Precision</strong> We choose a Lisp-like
syntax for precision and homoiconicity, accepting that some find it less
readable than Markdown:</p>
<pre class="shrdlu"><code>; Shrdlu - precise but more verbose
@blockquote[#:cite &quot;Knuth&quot;]{
  Premature optimization is the root of all evil.
}

; Markdown - concise but less structured
&gt; Premature optimization is the root of all evil. - Knuth</code></pre>
<p><strong>Safety vs. Power</strong> We provide full computational
power, accepting security implications that must be addressed through
sandboxing:</p>
<pre class="shrdlu"><code>@define[read-file][path]{
  @with-input-from-file[path]{
    @port-&gt;string[@current-input-port[]]
  }
}

; This is powerful but potentially dangerous
@include[@read-file[&quot;../../../etc/passwd&quot;]]  ; Must be sandboxed!</code></pre>
<p><strong>Familiarity vs. Innovation</strong> We introduce new concepts
like format-aware elements, accepting a steeper learning curve for
advanced features:</p>
<pre class="shrdlu"><code>@adaptive-image[
  #:src &quot;diagram.svg&quot;
  #:alt &quot;System Architecture&quot;
  #:pdf-src &quot;diagram.pdf&quot;      ; High-res for print
  #:html-srcset [&quot;diagram-2x.png&quot; &quot;diagram-1x.png&quot;]
  #:epub-format &quot;png&quot;           ; Compatibility
]</code></pre>
<h2 id="syntax-design-decisions">Syntax Design Decisions</h2>
<p>The concrete syntax of a language profoundly affects its usability.
Shrdlu’s syntax builds on Scribble’s innovations while adding our own
refinements.</p>
<h3 id="the-notation">The @ Notation</h3>
<p>The @ symbol introduces Shrdlu forms, chosen for several reasons:</p>
<ol type="1">
<li><strong>Rarity in prose</strong>: Unlike parentheses or brackets, @
rarely appears in normal text</li>
<li><strong>Visual distinction</strong>: @ stands out, making code
easily identifiable</li>
<li><strong>Email precedent</strong>: Users understand @ as introducing
special notation</li>
<li><strong>Single character</strong>: Minimal typing overhead</li>
</ol>
<p>Basic @ forms:</p>
<pre class="shrdlu"><code>@command                        ; Simple command
@command{text}                  ; Command with text argument
@command[options]{text}         ; Command with options and text
@command[opt1 opt2]{text1}{text2} ; Multiple arguments</code></pre>
<h3 id="bracket-types-and-their-meanings">Bracket Types and Their
Meanings</h3>
<p>Shrdlu uses different bracket types consistently:</p>
<p><strong>Square Brackets <code>[]</code> for Options and
Arguments</strong>:</p>
<pre class="shrdlu"><code>@image[#:src &quot;photo.jpg&quot; #:width 300 #:alt &quot;Description&quot;]
@ref[figure &quot;architecture&quot;]
@calculate[@+ [2 3]]</code></pre>
<p><strong>Curly Braces <code>{}</code> for Content</strong>:</p>
<pre class="shrdlu"><code>@paragraph{This is textual content with @em{emphasis}.}
@section{@title{Introduction} @p{First paragraph}}</code></pre>
<p><strong>Parentheses <code>()</code> for Grouping and
Lists</strong>:</p>
<pre class="shrdlu"><code>@define[coordinates][](list 42.3 -71.1))
@for[item @in (list &quot;apple&quot; &quot;banana&quot; &quot;cherry&quot;)]{@li{@item}}</code></pre>
<h3 id="string-handling-and-escaping">String Handling and Escaping</h3>
<p>Strings in Shrdlu require careful design to handle both prose and
code:</p>
<p><strong>Basic String Literals</strong>:</p>
<pre class="shrdlu"><code>&quot;This is a simple string&quot;
&#39;symbol-not-string</code></pre>
<p><strong>Here Strings for Multi-line Content</strong>:</p>
<pre class="shrdlu"><code>@verbatim{
  #&lt;&lt;END
  This is literal text that can contain anything:
  @commands, {braces}, [brackets], and &quot;quotes&quot;
  without interpretation.
  END
}</code></pre>
<p><strong>Escape Sequences</strong>:</p>
<pre class="shrdlu"><code>@p{
  To output an at-sign: @@
  To output a brace: @&quot;{&quot; or @&quot;}&quot;
  Unicode: @&quot;\u03BB&quot; (λ)
  Arbitrary character: @char[955] 
}</code></pre>
<p><strong>Smart Quote Handling</strong>:</p>
<pre class="shrdlu"><code>@configure[#:smart-quotes #t]

@p{
  &quot;This becomes &#39;smart quotes&#39; automatically&quot; but
  @code{&quot;this preserves \&quot;literal\&quot; quotes&quot;}.
}</code></pre>
<h3 id="comments-and-documentation">Comments and Documentation</h3>
<p>Shrdlu supports multiple comment styles for different purposes:</p>
<pre class="shrdlu"><code>@; Line comment - stripped from output
@p{
  Visible text @; invisible comment
}

@;{
  Block comment - can span multiple lines
  and contain arbitrary text
}

@doc{
  Documentation comment - preserved in metadata
  for API documentation generation.
  @param[x]{The input value}
  @returns{Processed result}
}

@#;@p{
  Commented-out content - useful during editing
  This entire paragraph is ignored
}</code></pre>
<h3 id="whitespace-handling">Whitespace Handling</h3>
<p>Whitespace management significantly affects readability:</p>
<pre class="shrdlu"><code>@; Whitespace normalization in text mode
@p{
  Multiple     spaces     become single spaces.
  
  Blank lines create paragraph breaks.
  Newlines
  are
  converted to spaces.
}

@; Preserved whitespace in code
@code{
  function example() {
    return &quot;spacing preserved&quot;;
  }
}

@; Explicit whitespace control
@p{First line@br{}Second line}
@p{Word@nbsp{}with@nbsp{}non-breaking@nbsp{}spaces}</code></pre>
<h3 id="command-resolution-and-namespaces">Command Resolution and
Namespaces</h3>
<p>Shrdlu must resolve command names in a predictable way:</p>
<pre class="shrdlu"><code>@; Built-in commands
@section{...}  ; Resolves to shrdlu:section

@; User-defined commands
@define[my-command][text]{
  @p{Custom: @text}
}
@my-command{Hello}  ; Resolves to local definition

@; Qualified names
@html:div[#:class &quot;special&quot;]{...}
@latex:vspace{1em}

@; Import commands
@require[&quot;my-extensions.shrdlu&quot; 
         :prefix my:]
@my:custom-element{...}</code></pre>
<h2 id="core-language-constructs">Core Language Constructs</h2>
<p>Shrdlu provides a rich set of built-in constructs that form the
foundation for document creation.</p>
<h3 id="document-structure-elements">Document Structure Elements</h3>
<p><strong>Document Root</strong>:</p>
<pre class="shrdlu"><code>@document[
  #:title &quot;The Shrdlu Manual&quot;
  #:author &quot;Jane Doe&quot;
  #:date &quot;2025-10-02&quot;
  #:lang &quot;en&quot;
  #:keywords [&quot;markup&quot; &quot;static-site&quot; &quot;racket&quot;]
]{
  @abstract{Brief document summary...}
  @include[&quot;chapters/introduction.shrdlu&quot;]
  @include[&quot;chapters/syntax.shrdlu&quot;]
}</code></pre>
<p><strong>Sectioning</strong>:</p>
<pre class="shrdlu"><code>@chapter[#:label &quot;intro&quot;]{Introduction}
@section[#:label &quot;motivation&quot;]{Why Shrdlu?}
@subsection{Design Goals}
@subsubsection{Simplicity}

@; Alternative with explicit numbering
@section[#:number &quot;2.3.1&quot;]{Custom Numbering}

@; Unnumbered sections
@section*{Acknowledgments}</code></pre>
<p><strong>Paragraphs and Text Flow</strong>:</p>
<pre class="shrdlu"><code>@p{Standard paragraph with automatic spacing.}

@p[#:indent #f]{Non-indented paragraph.}

@p[#:align &#39;justify]{
  Justified text with proper hyphenation when 
  rendering to PDF.
}

@noindent{Continues without paragraph break.}</code></pre>
<h3 id="text-formatting">Text Formatting</h3>
<p><strong>Inline Formatting</strong>:</p>
<pre class="shrdlu"><code>@em{emphasis} or @i{italic}
@strong{strong} or @b{bold}
@code{inline_code()}
@kbd{Ctrl+C}
@var{variable}
@dfn{definition}
@abbr[#:title &quot;Hypertext Markup Language&quot;]{HTML}</code></pre>
<p><strong>Advanced Typography</strong>:</p>
<pre class="shrdlu"><code>@; Smart punctuation
@p{
  &quot;Quotes,&quot; she said---using an em dash.
  @ellipsis
}

@; Small caps and font variants
@sc{Small Capitals}
@font[#:family &quot;Garamond&quot; #:size &quot;14pt&quot;]{Custom font text}

@; Superscript and subscript
H@sub{2}O has a density of 1g/cm@sup{3}</code></pre>
<h3 id="lists-and-enumerations">Lists and Enumerations</h3>
<p><strong>Unordered Lists</strong>:</p>
<pre class="shrdlu"><code>@ul{
  @li{First item}
  @li{Second item with @em{emphasis}}
  @li{
    Nested content:
    @ul{
      @li{Sub-item A}
      @li{Sub-item B}
    }
  }
}</code></pre>
<p><strong>Ordered Lists with Custom Styling</strong>:</p>
<pre class="shrdlu"><code>@ol[#:style &#39;lower-roman]{
  @li{Prima}
  @li{Secunda}
  @li{Tertia}
}

@ol[#:start 10 #:style &#39;decimal]{
  @li[#:value 10]{Forced to ten}
  @li{Continues to eleven}
}</code></pre>
<p><strong>Description Lists</strong>:</p>
<pre class="shrdlu"><code>@dl{
  @dt{Racket}
  @dd{A language for language-oriented programming}
  
  @dt{Shrdlu}
  @dd{A markup language that computes}
}</code></pre>
<h3 id="tables">Tables</h3>
<p><strong>Simple Tables</strong>:</p>
<pre class="shrdlu"><code>@table{
  @tr{@th{Name} @th{Age} @th{City}}
  @tr{@td{Alice} @td{30} @td{Boston}}
  @tr{@td{Bob} @td{25} @td{Denver}}
}</code></pre>
<p><strong>Advanced Tables</strong>:</p>
<pre class="shrdlu"><code>@table[
  #:caption &quot;Sales by Region&quot;
  #:label &quot;sales-2024&quot;
  #:align &quot;lrr&quot;  ; left, right, right
]{
  @thead{
    @tr{@th[#:colspan 3]{2024 Sales}}
    @tr{@th{Region} @th{Q1} @th{Q2}}
  }
  @tbody{
    @tr{@td{North} @td{$150K} @td{$175K}}
    @tr{@td{South} @td{$120K} @td{$135K}}
  }
  @tfoot{
    @tr{@td{Total} @td{$270K} @td{$310K}}
  }
}</code></pre>
<h3 id="code-and-technical-content">Code and Technical Content</h3>
<p><strong>Code Blocks with Syntax Highlighting</strong>:</p>
<pre class="shrdlu"><code>@code[#:lang &quot;racket&quot;]{
  (define (factorial n)
    (if (zero? n)
        1
        (* n (factorial (- n 1)))))
}

@code[#:lang &quot;python&quot; #:line-numbers #t #:highlight (3 4)]{
  def fibonacci(n):
      if n &lt;= 1:
          return n
      return fibonacci(n-1) + fibonacci(n-2)
}</code></pre>
<p><strong>Inline Technical Elements</strong>:</p>
<pre class="shrdlu"><code>@; File paths
@file{/usr/local/bin/shrdlu}

@; Commands
@command{git commit -m &quot;Initial commit&quot;}

@; Key combinations
@key{Ctrl+Alt+Delete}

@; Menu paths
@menu{File → Save As...}</code></pre>
<h3 id="mathematics">Mathematics</h3>
<p><strong>Inline Math</strong>:</p>
<pre class="shrdlu"><code>The quadratic formula is @math{x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}}.</code></pre>
<p><strong>Display Math</strong>:</p>
<pre class="shrdlu"><code>@equation[#:label &quot;euler&quot;]{
  e^{i\pi} + 1 = 0
}

@align{
  f(x) &amp;= x^2 + 2x + 1 \\
       &amp;= (x + 1)^2
}</code></pre>
<p><strong>Math Environments</strong>:</p>
<pre class="shrdlu"><code>@theorem[#:name &quot;Fundamental Theorem of Calculus&quot;]{
  If @math{f} is continuous on @math{[a,b]}, then
  @equation{
    \int_a^b f(x)\,dx = F(b) - F(a)
  }
  where @math{F&#39; = f}.
}

@proof{
  By the definition of the derivative...
}</code></pre>
<h3 id="cross-references-and-links">Cross-References and Links</h3>
<p><strong>Internal References</strong>:</p>
<pre class="shrdlu"><code>@section[#:label &quot;implementation&quot;]{Implementation Details}

See @ref[section &quot;implementation&quot;] for details.
Also check @pageref[&quot;implementation&quot;].

@; Smart references
@autoref[&quot;implementation&quot;] ; Produces &quot;Section 2.3&quot;</code></pre>
<p><strong>External Links</strong>:</p>
<pre class="shrdlu"><code>@url{https://shrdlu-lang.org}
@link[#:href &quot;https://example.com&quot;]{Link text}
@link[
  #:href &quot;document.pdf&quot;
  #:title &quot;PDF Version&quot;
  #:rel &quot;alternate&quot;
]{Download PDF}</code></pre>
<p><strong>Footnotes and Marginal Notes</strong>:</p>
<pre class="shrdlu"><code>This needs clarification@footnote{
  Extended explanation that appears at page bottom.
}.

@marginpar{
  Side note that appears in the margin.
}</code></pre>
<h2 id="control-flow-and-computations">Control Flow and
Computations</h2>
<p>The computational heart of Shrdlu enables dynamic document
generation.</p>
<h3 id="variables-and-binding">Variables and Binding</h3>
<p><strong>Variable Definition</strong>:</p>
<pre class="shrdlu"><code>@define[author]{&quot;Jane Doe&quot;}
@define[year]{2025}
@define[current-chapter]{1}

@; Using variables
Written by @author in @year.</code></pre>
<p><strong>Local Binding with Let</strong>:</p>
<pre class="shrdlu"><code>@let[
  [title &quot;Quarterly Report&quot;]
  [quarter 4]
  [year 2024]
]{
  @section{@title - Q@quarter @year}
}</code></pre>
<p><strong>Destructuring Binding</strong>:</p>
<pre class="shrdlu"><code>@let-values[
  [(name age) (list &quot;Alice&quot; 30)]
  [(x y z) (get-coordinates)]
]{
  @name is @age years old at position (@x, @y, @z).
}</code></pre>
<h3 id="conditionals">Conditionals</h3>
<p><strong>Simple If</strong>:</p>
<pre class="shrdlu"><code>@if[@&gt; [temperature 90]]{
  It&#39;s very hot today!
}{
  The weather is pleasant.
}</code></pre>
<p><strong>Multi-Branch Conditionals</strong>:</p>
<pre class="shrdlu"><code>@cond[
  [@&lt; [score 60]] {Grade: F}
  [@&lt; [score 70]] {Grade: D}
  [@&lt; [score 80]] {Grade: C}
  [@&lt; [score 90]] {Grade: B}
  [else] {Grade: A}
]</code></pre>
<p><strong>Pattern Matching</strong>:</p>
<pre class="shrdlu"><code>@match[@get-document-type[]]{
  [&#39;article] {@article-template[]}
  [&#39;book] {@book-template[]}
  [&#39;report] {@report-template[]}
  [other] {@error[&quot;Unknown type: &quot; other]}
}</code></pre>
<h3 id="loops-and-iteration">Loops and Iteration</h3>
<p><strong>For Loops</strong>:</p>
<pre class="shrdlu"><code>@ul{
  @for[item @in [&quot;apple&quot; &quot;banana&quot; &quot;cherry&quot;]]{
    @li{I like @item}
  }
}

@; With index
@for[(item idx) @in-indexed [@get-items[]]]{
  @p{Item @idx: @item}
}</code></pre>
<p><strong>Range Iteration</strong>:</p>
<pre class="shrdlu"><code>@for[n @in [@range[1 11]]]{
  @p{Paragraph @n}
}

@; With step
@for[x @in [@range[0 100 10]]]{
  @x% complete@br{}
}</code></pre>
<p><strong>While Loops</strong>:</p>
<pre class="shrdlu"><code>@define[counter]{0}
@while[@&lt; [counter 5]]{
  @p{Iteration @counter}
  @set![counter @+ [counter 1]]
}</code></pre>
<p><strong>List Comprehensions</strong>:</p>
<pre class="shrdlu"><code>@; Generate a table of squares
@table{
  @for[n @in [@range[1 11]]]{
    @tr{@td{@n} @td{@math{@n^2 = @[* n n]}}}
  }
}</code></pre>
<h3 id="functions">Functions</h3>
<p><strong>Function Definition</strong>:</p>
<pre class="shrdlu"><code>@define[greet][name]{
  Hello, @name!
}

@greet[&quot;World&quot;]  ; Output: Hello, World!</code></pre>
<p><strong>Functions with Optional Arguments</strong>:</p>
<pre class="shrdlu"><code>@define[make-heading][text #:level 2 #:id auto]{
  @match[level]{
    [1] {@h1[#:id @generate-id[text]]{@text}}
    [2] {@h2[#:id @or[id @generate-id[text]]]{@text}}
    [3] {@h3[#:id @or[id @generate-id[text]]]{@text}}
  }
}</code></pre>
<p><strong>Higher-Order Functions</strong>:</p>
<pre class="shrdlu"><code>@define[map-paragraphs][func items]{
  @for[item @in items]{
    @p{@func[item]}
  }
}

@map-paragraphs[@uppercase][&quot;hello&quot; &quot;world&quot;]</code></pre>
<p><strong>Anonymous Functions</strong>:</p>
<pre class="shrdlu"><code>@define[numbers][1 2 3 4 5]
@define[doubled][@map[@lambda[x][* x 2]] numbers]

Doubled: @join[&quot;, &quot; doubled]</code></pre>
<h2 id="template-and-macro-system">Template and Macro System</h2>
<p>Templates and macros enable powerful abstraction mechanisms.</p>
<h3 id="document-templates">Document Templates</h3>
<p><strong>Basic Template</strong>:</p>
<pre class="shrdlu"><code>@define-template[article-template][
  #:title required
  #:author required  
  #:date @today[]
  #:abstract &quot;&quot;
  #:keywords []
][
  @article[
    #:meta @list[
      [&#39;title title]
      [&#39;author author]
      [&#39;date date]
      [&#39;keywords keywords]
    ]
  ]{
    @when[@not[@empty? abstract]]{
      @abstract{@abstract}
    }
    @content  ; Special variable bound to template body
  }
]

@; Using the template
@article-template[
  #:title &quot;My Article&quot;
  #:author &quot;Jane Doe&quot;
  #:abstract &quot;Brief summary...&quot;
]{
  @section{Introduction}
  Article content here...
}</code></pre>
<h3 id="syntactic-macros">Syntactic Macros</h3>
<p><strong>Simple Macros</strong>:</p>
<pre class="shrdlu"><code>@define-syntax[unless][
  @syntax-rules[]{
    [(unless condition body ...)
     (if (not condition)
         (begin body ...)
         (void))]
  }
]

@unless[@file-exists?[&quot;output.pdf&quot;]]{
  @generate-pdf[]
}</code></pre>
<p><strong>Pattern-Based Macros</strong>:</p>
<pre class="shrdlu"><code>@define-syntax[with-temporary-file][
  @syntax-rules[]{
    [(with-temporary-file var body ...)
     (let ([var (make-temporary-file)])
       (dynamic-wind
         (λ () (void))
         (λ () body ...)
         (λ () (delete-file var))))]
  }
]</code></pre>
<p><strong>Hygienic Macros with Syntax-Case</strong>:</p>
<pre class="shrdlu"><code>@define-syntax[define-counter][
  @lambda[stx]{
    @syntax-case[stx []]{
      [(define-counter name)
       @with-syntax[
         [inc-name @format-id[#&#39;name &quot;inc-~a&quot; #&#39;name]]
         [reset-name @format-id[#&#39;name &quot;reset-~a&quot; #&#39;name]]
         [get-name @format-id[#&#39;name &quot;get-~a&quot; #&#39;name]]
       ]{
         #&#39;(begin
             (define counter 0)
             (define (get-name) counter)
             (define (inc-name)
               (set! counter (+ counter 1))
               counter)
             (define (reset-name)
               (set! counter 0)))}]
    }
  }
]

@define-counter[section]
@section[#:number @inc-section[]]{First Section}</code></pre>
<h3 id="code-generation-macros">Code Generation Macros</h3>
<p><strong>DSL Creation</strong>:</p>
<pre class="shrdlu"><code>@define-syntax[define-bibliography-style][
  @lambda[stx]{
    @syntax-case[stx []]{
      [(define-bibliography-style name rules ...)
       #&#39;(begin
           (define name 
             (make-bibliography-style &#39;name))
           (add-rules! name rules) ...)]
    }
  }
]

@define-bibliography-style[apa
  [journal-article 
   (author year title journal volume pages)]
  [book
   (author year title publisher location)]
]</code></pre>
<h2 id="comparison-with-typst-and-latex">Comparison with Typst and
LaTeX</h2>
<p>Understanding how Shrdlu relates to existing sophisticated markup
systems helps clarify our design choices.</p>
<h3 id="latex-comparison">LaTeX Comparison</h3>
<p><strong>Document Structure</strong>:</p>
<div class="sourceCode" id="cb95"><pre
class="sourceCode latex"><code class="sourceCode latex"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co">% LaTeX</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="bu">\documentclass</span>{<span class="ex">article</span>}</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="bu">\usepackage</span>{<span class="ex">amsmath</span>}</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="kw">\begin</span>{<span class="ex">document</span>}</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="fu">\title</span>{My Document}</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="fu">\author</span>{Jane Doe}</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="fu">\maketitle</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="kw">\section</span>{Introduction}</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>Content here.</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="kw">\end</span>{<span class="ex">document</span>}</span></code></pre></div>
<pre class="shrdlu"><code>@; Shrdlu equivalent
@document[
  #:class &quot;article&quot;
  #:packages [&quot;amsmath&quot;]
  #:title &quot;My Document&quot;
  #:author &quot;Jane Doe&quot;
]{
  @section{Introduction}
  Content here.
}</code></pre>
<p><strong>Key Differences</strong>: 1. <strong>Syntax</strong>:
S-expressions vs. backslash commands 2. <strong>Extensibility</strong>:
Full Racket vs. TeX macros 3. <strong>Error Messages</strong>: Modern
vs. cryptic TeX errors 4. <strong>Output</strong>: Multiple formats
vs. primarily PDF</p>
<p><strong>Mathematical Content</strong>:</p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode latex"><code class="sourceCode latex"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co">% LaTeX</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="kw">\begin</span>{<span class="ex">equation</span>}</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="ss">  </span><span class="sc">\int</span><span class="ss">_0^</span><span class="sc">\infty</span><span class="ss"> e^{-x^2} dx = </span><span class="sc">\frac</span><span class="ss">{</span><span class="sc">\sqrt</span><span class="ss">{</span><span class="sc">\pi</span><span class="ss">}}{2}</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="kw">\end</span>{<span class="ex">equation</span>}</span></code></pre></div>
<pre class="shrdlu"><code>@; Shrdlu
@equation{
  \int_0^\infty e^{-x^2} dx = \frac{\sqrt{\pi}}{2}
}</code></pre>
<p>Shrdlu reuses LaTeX math syntax for familiarity but processes it
within our system.</p>
<h3 id="typst-comparison">Typst Comparison</h3>
<p>Typst offers modern markup with computational features, making it a
closer relative to Shrdlu:</p>
<p><strong>Functions and Computation</strong>:</p>
<pre class="typst"><code>// Typst
#let fibonacci(n) = {
  if n &lt;= 1 { n }
  else { fibonacci(n - 1) + fibonacci(n - 2) }
}

The 10th Fibonacci number is #fibonacci(10).</code></pre>
<pre class="shrdlu"><code>@; Shrdlu
@define[fibonacci][n]{
  @if[@&lt;= [n 1]]{n}{
    @+ [@fibonacci[@- [n 1]]] 
       [@fibonacci[@- [n 2]]]
  }
}

The 10th Fibonacci number is @fibonacci[10].</code></pre>
<p><strong>Key Advantages of Shrdlu</strong>:</p>
<ol type="1">
<li><strong>True Lisp Heritage</strong>: First-class functions, macros,
and homoiconicity</li>
<li><strong>Multi-Format Output</strong>: Native HTML, PDF, and EPUB
vs. Typst’s PDF focus</li>
<li><strong>Web Integration</strong>: Built-in static site
generation</li>
<li><strong>Extensibility</strong>: Full Racket ecosystem access</li>
</ol>
<p><strong>Template System</strong>:</p>
<pre class="typst"><code>// Typst
#let article(title, author, body) = {
  set page(margin: 2.5cm)
  align(center, text(24pt, title))
  align(center, author)
  body
}</code></pre>
<pre class="shrdlu"><code>@; Shrdlu - more powerful with pattern matching
@define-template[article][
  #:title required
  #:author required
  #:margin &quot;2.5cm&quot;
][
  @with-page-settings[#:margin margin]{
    @center[@text[#:size &quot;24pt&quot;]{@title}]
    @center{@author}
    @content
  }
]</code></pre>
<h3 id="unique-shrdlu-features">Unique Shrdlu Features</h3>
<p><strong>Format-Aware Elements</strong>:</p>
<pre class="shrdlu"><code>@algorithm[#:label &quot;quicksort&quot;]{
  @format-switch{
    @case[html]{
      @code[#:lang &quot;javascript&quot; #:interactive #t]{
        // Interactive version for web
        function quicksort(arr) { /* ... */ }
      }
    }
    @case[pdf]{
      @pseudocode{
        \begin{algorithmic}
        \Function{QuickSort}{$A, low, high$}
        % LaTeX algorithmic style
        \EndFunction
        \end{algorithmic}
      }
    }
  }
}</code></pre>
<p><strong>First-Class Language Integration</strong>:</p>
<pre class="shrdlu"><code>@racket{
  ; Direct Racket code execution
  (require plot)
  (plot (function sin -5 5))
}

@python{
  # Python integration through FFI
  import numpy as np
  data = np.random.normal(0, 1, 1000)
  return histogram(data)
}</code></pre>
<p><strong>Reactive Documents</strong>:</p>
<pre class="shrdlu"><code>@reactive-var[temperature]{20}

@slider[
  #:var temperature
  #:min 0 
  #:max 100
  #:label &quot;Temperature (°C)&quot;
]

The water is @if[@&lt; [temperature 0]]{frozen}
           @elif[@&lt; [temperature 100]]{liquid}
           @else{steam}.</code></pre>
<h2 id="example-documents">Example Documents</h2>
<p>Let’s explore complete Shrdlu documents that showcase the language’s
capabilities.</p>
<h3 id="example-1-technical-blog-post">Example 1: Technical Blog
Post</h3>
<pre class="shrdlu"><code>@document[
  #:title &quot;Understanding Parser Combinators&quot;
  #:author &quot;Jane Doe&quot;
  #:date @today[]
  #:tags [&quot;functional programming&quot; &quot;parsing&quot; &quot;racket&quot;]
  #:slug &quot;parser-combinators&quot;
]{
  
@abstract{
  Parser combinators offer an elegant approach to building parsers
  by composing simple parsers into complex ones. This post explores
  their implementation in Racket.
}

@section{Introduction}

@dropcap{P}arser combinators represent parsers as first-class values
that can be combined using higher-order functions. Unlike parser
generators like @tt{yacc}, combinators allow parsers to be built
directly in the host language.

@section{Basic Combinators}

Let&#39;s start with primitive parsers:

@code[#:lang &quot;racket&quot;]{
; Parse a specific character
(define (char c)
  (λ (input)
    (if (and (not (empty? input))
             (equal? (first input) c))
        (success c (rest input))
        (failure input))))

; Parse any character satisfying a predicate  
(define (sat? pred)
  (λ (input)
    (if (and (not (empty? input))
             (pred (first input)))
        (success (first input) (rest input))
        (failure input))))
}

@subsection{Combinator Operators}

The power comes from combining parsers:

@code[#:lang &quot;racket&quot; #:line-numbers #t]{
; Sequence: parse p then q
(define (seq p q)
  (λ (input)
    (match (p input)
      [(success v1 rest1)
       (match (q rest1)
         [(success v2 rest2)
          (success (list v1 v2) rest2)]
         [failure failure])]
      [failure failure])))

; Choice: parse p or q  
(define (alt p q)
  (λ (input)
    (match (p input)
      [(success _ _) as result] result]
      [failure (q input)])))
}

@callout[#:type &quot;info&quot;]{
  These combinators form a @dfn{monadic} structure, with @tt{return}
  as @tt{success} and @tt{&gt;&gt;=} as sequential composition.
}

@section{Practical Example}

Let&#39;s build a parser for arithmetic expressions:

@code[#:lang &quot;racket&quot;]{
(define digit
  (sat? char-numeric?))

(define number
  (map string-&gt;number
       (map list-&gt;string
            (many1 digit))))

(define expr
  (chainl1 term 
           (alt (char #\+) (char #\-))))

(define term
  (chainl1 factor
           (alt (char #\*) (char #\/))))
}

@figure[
  #:label &quot;parse-tree&quot;
  #:caption &quot;Parse tree for &#39;2+3*4&#39;&quot;
]{
  @render-parse-tree[&quot;2+3*4&quot; expr]
}

@section{Performance Considerations}

Parser combinators trade some performance for elegance:

@data-table[
  #:source &quot;benchmarks.csv&quot;
  #:columns [&quot;Parser Type&quot; &quot;Lines/Second&quot; &quot;Memory (MB)&quot;]
  #:chart-type &quot;bar&quot;
]

@section{Conclusion}

Parser combinators demonstrate the power of functional abstraction.
While not always the fastest option, they excel in clarity and
composability.

@bibliography[#:style &quot;acm&quot;]
}</code></pre>
<h3 id="example-2-academic-paper">Example 2: Academic Paper</h3>
<pre class="shrdlu"><code>@document[
  #:class &quot;academic-paper&quot;
  #:title &quot;Quantum Error Correction via Stabilizer Codes&quot;
  #:authors [
    @author[
      #:name &quot;Alice Smith&quot;
      #:affiliation &quot;Quantum University&quot;
      #:email &quot;asmith@qu.edu&quot;
    ]
    @author[
      #:name &quot;Bob Jones&quot;
      #:affiliation &quot;Institute of Computing&quot;
      #:email &quot;bjones@ic.org&quot;
    ]
  ]
]{

@abstract{
  We present a novel approach to quantum error correction using
  generalized stabilizer codes. Our method achieves a threshold
  error rate of @math{p_{th} = 1.1 \times 10^{-3}}, improving
  upon previous results by 23%.
}

@keywords{quantum computing, error correction, stabilizer codes}

@section{Introduction}

Quantum error correction @cite{shor1995} is essential for building
fault-tolerant quantum computers. The stabilizer formalism
@cite{gottesman1997} provides a powerful framework for constructing
quantum error-correcting codes.

@definition[#:label &quot;stabilizer&quot;]{
  A @dfn{stabilizer code} is defined by a stabilizer group 
  @math{S \subseteq \mathcal{P}_n} where:
  @equation[#:label &quot;stabilizer-def&quot;]{
    |\psi\rangle \in \mathcal{C} \iff 
    g|\psi\rangle = |\psi\rangle \quad \forall g \in S
  }
}

@section{Theoretical Framework}

@subsection{Stabilizer Groups}

Consider the Pauli group @math{\mathcal{P}_n} on @math{n} qubits:

@equation{
  \mathcal{P}_n = \{\pm 1, \pm i\} \times 
  \{I, X, Y, Z\}^{\otimes n}
}

@theorem[#:label &quot;main-theorem&quot;]{
  For any stabilizer code with distance @math{d}, the number of
  correctable errors @math{t} satisfies:
  @equation{
    t = \lfloor \frac{d-1}{2} \rfloor
  }
}

@proof{
  By the quantum Singleton bound...
  @qed
}

@subsection{Code Construction}

Our construction uses the following generator matrix:

@equation[#:label &quot;generator&quot;]{
  G = \begin{pmatrix}
    H_1 &amp; 0 \\
    H_2 &amp; H_3
  \end{pmatrix}
}

where @math{H_i} are parity check matrices satisfying
@ref[Lemma &quot;orthogonality&quot;].

@section{Experimental Results}

@figure[
  #:label &quot;results&quot;
  #:caption &quot;Error rate vs. code distance&quot;
]{
  @plot[
    #:data &quot;error_rates.csv&quot;
    #:x &quot;distance&quot;
    #:y &quot;error_rate&quot;
    #:log-y #t
    #:legend [&quot;Our method&quot; &quot;Previous best&quot; &quot;Theoretical limit&quot;]
  ]
}

As shown in @ref[Figure &quot;results&quot;], our method achieves superior
performance for distances @math{d \geq 7}.

@table[
  #:label &quot;comparison&quot;
  #:caption &quot;Performance comparison&quot;
]{
  @tr{@th{Method} @th{Threshold} @th{Gates} @th{Depth}}
  @tr{@td{Steane} @td{@math{8.1 \times 10^{-4}} @td{15} @td{8}}
  @tr{@td{Surface} @td{@math{9.2 \times 10^{-4}} @td{12} @td{6}}
  @tr{@td{Ours} @td{@math{1.1 \times 10^{-3}} @td{10} @td{5}}
}

@section{Conclusion}

We have demonstrated a new quantum error correction scheme with
improved threshold rates. Future work includes:

@ol{
  @li{Extension to non-Clifford gates}
  @li{Implementation on near-term devices}
  @li{Optimization for specific noise models}
}

@acknowledgments{
  This work was supported by NSF Grant PHY-1234567.
}

@bibliography[#:style &quot;aps&quot; #:file &quot;references.bib&quot;]

@appendix{Detailed Proofs}

@lemma[#:label &quot;orthogonality&quot;]{
  The matrices @math{H_i} satisfy...
}

}</code></pre>
<h3 id="example-3-data-driven-report">Example 3: Data-Driven Report</h3>
<pre class="shrdlu"><code>@require[&quot;data-analysis.shrdlu&quot;]
@require[&quot;charts.shrdlu&quot;]

@document[
  #:title &quot;Q3 2024 Sales Report&quot;
  #:author &quot;Analytics Team&quot;
  #:confidential #t
]{

@; Load and process data
@define[sales-data]{
  @load-csv[&quot;sales-q3-2024.csv&quot;
    #:parse-dates [&quot;date&quot;]
    #:parse-numbers [&quot;amount&quot; &quot;units&quot;]
  ]
}

@define[by-region]{
  @group-by[sales-data &#39;region 
    #:aggregate [&#39;amount &#39;sum] 
               [&#39;units &#39;sum]]
}

@define[by-product]{
  @group-by[sales-data &#39;product
    #:aggregate [&#39;amount &#39;sum]
               [&#39;units &#39;sum]
               [&#39;profit &#39;mean]]
}

@executive-summary{
  Q3 showed strong growth with total sales of
  @format-currency[@sum[@map[sales-data &#39;amount]]],
  representing a @percent[@calculate-growth[q2-total q3-total]]
  increase over Q2.
}

@section{Regional Performance}

@for[region @in [@sort[by-region &#39;amount &#39;desc]]]{
  @subsection{@get[region &#39;name] Region}
  
  @kpi-card[
    #:title &quot;Revenue&quot;
    #:value @format-currency[@get[region &#39;amount]]
    #:change @calculate-change[region &#39;q2&#39; &#39;q3&#39;]
  ]
  
  @if[@&gt; [@get[region &#39;growth] 0.1]]{
    @badge[#:color &quot;green&quot;]{High Growth}
  }
}

@section{Product Analysis}

@figure[
  #:label &quot;product-mix&quot;
  #:caption &quot;Revenue by Product Category&quot;
]{
  @pie-chart[
    #:data by-product
    #:value &#39;amount
    #:label &#39;product
    #:colors [&quot;#FF6B6B&quot; &quot;#4ECDC4&quot; &quot;#45B7D1&quot; &quot;#96CEB4&quot;]
  ]
}

Top performers this quarter:

@ranked-list[
  #:data by-product
  #:sort-by &#39;profit
  #:limit 5
  #:format @lambda[item]{
    @b{@get[item &#39;product]}: 
    @format-currency[@get[item &#39;amount]]
    (@percent[@get[item &#39;profit-margin]] margin)
  }
]

@section{Trends and Projections}

@let[
  [time-series @extract-time-series[sales-data &#39;date &#39;amount]]
  [forecast @arima-forecast[time-series 90]]  ; 90 days
]{
  @figure[
    #:label &quot;forecast&quot;
    #:caption &quot;Sales Forecast - Next 90 Days&quot;
  ]{
    @line-chart[
      #:data @append[time-series forecast]
      #:x &#39;date
      #:y &#39;amount
      #:segment-at @today[]
      #:segment-labels [&quot;Historical&quot; &quot;Projected&quot;]
    ]
  }
  
  Projected Q4 revenue: @format-currency[@sum[forecast &#39;amount]]
  
  @confidence-interval[forecast #:level 0.95]
}

@section{Recommendations}

Based on our analysis:

@recommendations[
  @priority[high]{
    Increase inventory for @top-products[3] in 
    @top-regions[2] regions
  }
  
  @priority[medium]{
    Review pricing strategy for underperforming products
  }
  
  @priority[low]{
    Explore expansion opportunities in emerging markets
  }
]

@appendix{Methodology}

@subsection{Data Collection}

Sales data extracted from CRM system with the following filters:
@code[#:lang &quot;sql&quot;]{
  @generate-extraction-query[
    #:table &quot;sales&quot;
    #:date-range [q3-start q3-end]
    #:exclude-cancelled #t
  ]
}

@subsection{Statistical Methods}

@itemize{
  @item{ARIMA(2,1,2) model for time series forecasting}
  @item{Bootstrap confidence intervals (n=1000)}
  @item{Seasonal decomposition using STL}
}

}</code></pre>
<h2 id="summary-2">Summary</h2>
<p>This chapter has explored the design philosophy and concrete syntax
of the Shrdlu markup language. We’ve seen how the language balances
simplicity for basic tasks with computational power for complex document
generation. Key design decisions include:</p>
<ol type="1">
<li><strong>@ Notation</strong>: Provides clear visual distinction
between content and code</li>
<li><strong>Semantic Markup</strong>: Prioritizes meaning over
presentation</li>
<li><strong>Progressive Enhancement</strong>: Simple documents remain
simple</li>
<li><strong>Computational Completeness</strong>: Full programming power
when needed</li>
<li><strong>Multi-Format Awareness</strong>: Single source, multiple
outputs</li>
</ol>
<p>The examples demonstrate Shrdlu’s versatility across different
document types—from technical blog posts to academic papers to
data-driven reports. Each showcases different aspects of the
language:</p>
<ul>
<li>Blog posts use syntax highlighting and figures</li>
<li>Academic papers leverage mathematical typesetting and citations</li>
<li>Reports demonstrate data integration and dynamic content</li>
</ul>
<p>In the next chapter, we’ll begin implementing this design, starting
with the lexer and parser that will transform Shrdlu’s textual
representation into abstract syntax trees. The foundation we’ve laid
here—understanding the language’s syntax and semantics—will guide every
implementation decision to come.</p>
<h3 id="design-exercises">Design Exercises</h3>
<ol type="1">
<li><p><strong>Syntax Extension</strong>: Design a syntax for embedding
CSV data directly in Shrdlu documents. Consider both inline and
multi-line formats.</p></li>
<li><p><strong>Semantic Element</strong>: Create a new semantic element
for musical notation. How would it render differently in HTML (perhaps
using ABC notation) versus PDF (using Lilypond)?</p></li>
<li><p><strong>Macro Design</strong>: Design a macro system for creating
custom theorem-like environments (Lemma, Corollary, Proposition) with
consistent styling.</p></li>
<li><p><strong>Format Negotiation</strong>: Propose a mechanism for
handling format-specific features gracefully when the target format
doesn’t support them.</p></li>
<li><p><strong>Language Comparison</strong>: Take a complex LaTeX
document you’ve written or found online and translate it to Shrdlu. What
features are easier? What’s missing?</p></li>
</ol>
<p>These exercises will deepen your understanding of language design
trade-offs and prepare you for the implementation challenges ahead. In
Chapter 4, we’ll transform these design ideas into working code,
beginning with lexical analysis. # Chapter 4: Building the Lexer and
Parser</p>
<h2 id="introduction-to-lexical-analysis-and-parsing">Introduction to
Lexical Analysis and Parsing</h2>
<p>The journey from raw text to executable document begins with two
fundamental stages: lexical analysis and parsing. In this chapter, we’ll
build the foundation of Shrdlu’s language processor, transforming
streams of characters into structured representations that our system
can manipulate and evaluate.</p>
<p>Unlike traditional compilers that target machine code, Shrdlu’s
parser produces abstract syntax trees (ASTs) that represent document
structure. These ASTs serve as the intermediate representation for all
subsequent processing—interpretation, optimization, and multi-format
rendering.</p>
<h3 id="the-pipeline-architecture">The Pipeline Architecture</h3>
<p>Our processing pipeline follows a classic architecture:</p>
<p>Raw Text → Lexer → Token Stream → Parser → AST → Evaluator ↓ Document
Model ↓ Format Renderers (HTML, PDF, EPUB)</p>
<p>The lexer (lexical analyzer) breaks input into meaningful
tokens—atomic units like symbols, numbers, and strings. The parser then
assembles these tokens into hierarchical structures according to
Shrdlu’s grammar.</p>
<h3 id="why-separate-lexing-and-parsing">Why Separate Lexing and
Parsing?</h3>
<p>While it’s possible to build parsers that work directly on character
streams, separation offers several advantages:</p>
<ol type="1">
<li><strong>Simplified Parser Logic</strong>: The parser works with
meaningful tokens rather than individual characters</li>
<li><strong>Better Error Messages</strong>: We can report errors in
terms of tokens (“unexpected string”) rather than characters</li>
<li><strong>Performance</strong>: Token-based lookahead is more
efficient than character-based</li>
<li><strong>Flexibility</strong>: Different lexical conventions (like
comment styles) can be changed without affecting the parser</li>
</ol>
<h3 id="rackets-parser-tools">Racket’s Parser Tools</h3>
<p>Racket provides powerful tools for building lexers and parsers:</p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>(require parser-tools/lex</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>         parser-tools/yacc</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>         (prefix-in : parser-tools/lex-sre))</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; These libraries give us:</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; - Regular expression-based lexer generation</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; - LALR(1) parser generation  </span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; - Automatic error recovery</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; - Position tracking for error reporting</span></span></code></pre></div>
<p>Let’s begin by understanding what we need to tokenize.</p>
<h2 id="token-design-and-specification">Token Design and
Specification</h2>
<p>Tokens are the atoms of our language. Each token carries: - A type
(identifying what kind of token it is) - A value (the actual content) -
Position information (where it appeared in the source)</p>
<h3 id="token-types-for-shrdlu">Token Types for Shrdlu</h3>
<p>Based on our language design, we need these token types:</p>
<div class="sourceCode" id="cb110"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; token-types.rkt</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>(require parser-tools/lex)</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>(provide (all-defined-out))</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Define token types with and without associated values</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>(define-tokens value-tokens</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>  (STRING         <span class="co">; &quot;hello world&quot;</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>   NUMBER         <span class="co">; 42, 3.14</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>   SYMBOL         <span class="co">; &#39;foo</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>   IDENTIFIER     <span class="co">; variable-name</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>   COMMAND        <span class="co">; @command</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>   KEYWORD))      <span class="co">; #:keyword</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>(define-empty-tokens punctuation-tokens</span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>  (LBRACKET      <span class="co">; [</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>   RBRACKET      <span class="co">; ]</span></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>   LBRACE        <span class="co">; {</span></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>   RBRACE        <span class="co">; }</span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a>   LPAREN        <span class="co">; (</span></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>   RPAREN        <span class="co">; )</span></span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>   AT            <span class="co">; @</span></span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>   SEMICOLON     <span class="co">; ;</span></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>   EOF))         <span class="co">; End of file</span></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a><span class="co">;; Position tracking structure</span></span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>(struct source-location (line column offset) #:transparent)</span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a><span class="co">;; Token with position information</span></span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a>(struct positioned-token (token location) #:transparent)</span></code></pre></div>
<h3 id="regular-expression-patterns">Regular Expression Patterns</h3>
<p>We define lexical patterns using Racket’s <code>lex-sre</code> (Lexer
Scheme Regular Expressions):</p>
<div class="sourceCode" id="cb111"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; lexer-patterns.rkt</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>(require parser-tools/lex</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>         (prefix-in : parser-tools/lex-sre))</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>(provide (all-defined-out))</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Basic character classes</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev digit (:/ <span class="st">&quot;0&quot;</span> <span class="st">&quot;9&quot;</span>))</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev alpha (:or (:/ <span class="st">&quot;a&quot;</span> <span class="st">&quot;z&quot;</span>) (:/ <span class="st">&quot;A&quot;</span> <span class="st">&quot;Z&quot;</span>)))</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev alphanum (:or alpha digit))</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; Whitespace (including newlines for proper line counting)</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev whitespace </span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>  (:or <span class="ch">#\</span><span class="er">space</span> <span class="ch">#\</span><span class="er">tab</span> <span class="ch">#\</span><span class="er">return</span>))</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev <span class="kw">newline</span> </span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>  (:or <span class="ch">#\</span><span class="er">newline</span> </span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>       (:seq <span class="ch">#\</span><span class="er">return</span> <span class="ch">#\</span><span class="er">newline</span>)))  <span class="co">; Windows CRLF</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a><span class="co">;; Identifier pattern (Scheme-style)</span></span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev identifier-start</span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>  (:or alpha </span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>       (:or <span class="st">&quot;!&quot;</span> <span class="st">&quot;$&quot;</span> <span class="st">&quot;%&quot;</span> <span class="st">&quot;&amp;&quot;</span> <span class="st">&quot;*&quot;</span> <span class="st">&quot;/&quot;</span> <span class="st">&quot;:&quot;</span> <span class="st">&quot;&lt;&quot;</span> <span class="st">&quot;=&quot;</span> </span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;&gt;&quot;</span> <span class="st">&quot;?&quot;</span> <span class="st">&quot;^&quot;</span> <span class="st">&quot;_&quot;</span> <span class="st">&quot;~&quot;</span> <span class="st">&quot;+&quot;</span> <span class="st">&quot;-&quot;</span>)))</span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev identifier-continue</span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a>  (:or identifier-start digit <span class="st">&quot;.&quot;</span> <span class="st">&quot;@&quot;</span>))</span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev identifier</span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a>  (:seq identifier-start</span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a>        (:* identifier-continue)))</span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-35"><a href="#cb111-35" aria-hidden="true" tabindex="-1"></a><span class="co">;; Number patterns</span></span>
<span id="cb111-36"><a href="#cb111-36" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev decimal-integer</span>
<span id="cb111-37"><a href="#cb111-37" aria-hidden="true" tabindex="-1"></a>  (:seq (:? (:or <span class="st">&quot;+&quot;</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb111-38"><a href="#cb111-38" aria-hidden="true" tabindex="-1"></a>        (:+ digit)))</span>
<span id="cb111-39"><a href="#cb111-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-40"><a href="#cb111-40" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev decimal-float</span>
<span id="cb111-41"><a href="#cb111-41" aria-hidden="true" tabindex="-1"></a>  (:seq (:? (:or <span class="st">&quot;+&quot;</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb111-42"><a href="#cb111-42" aria-hidden="true" tabindex="-1"></a>        (:* digit)</span>
<span id="cb111-43"><a href="#cb111-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;.&quot;</span></span>
<span id="cb111-44"><a href="#cb111-44" aria-hidden="true" tabindex="-1"></a>        (:+ digit)</span>
<span id="cb111-45"><a href="#cb111-45" aria-hidden="true" tabindex="-1"></a>        (:? (:seq (:or <span class="st">&quot;e&quot;</span> <span class="st">&quot;E&quot;</span>)</span>
<span id="cb111-46"><a href="#cb111-46" aria-hidden="true" tabindex="-1"></a>                  (:? (:or <span class="st">&quot;+&quot;</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb111-47"><a href="#cb111-47" aria-hidden="true" tabindex="-1"></a>                  (:+ digit)))))</span>
<span id="cb111-48"><a href="#cb111-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-49"><a href="#cb111-49" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev number</span>
<span id="cb111-50"><a href="#cb111-50" aria-hidden="true" tabindex="-1"></a>  (:or decimal-integer decimal-float))</span>
<span id="cb111-51"><a href="#cb111-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-52"><a href="#cb111-52" aria-hidden="true" tabindex="-1"></a><span class="co">;; String patterns with escape sequences</span></span>
<span id="cb111-53"><a href="#cb111-53" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev string-char</span>
<span id="cb111-54"><a href="#cb111-54" aria-hidden="true" tabindex="-1"></a>  (:or (:~ <span class="ch">#\&quot;</span> <span class="ch">#\\</span>)  <span class="co">; Any char except &quot; or \</span></span>
<span id="cb111-55"><a href="#cb111-55" aria-hidden="true" tabindex="-1"></a>       (:seq <span class="ch">#\\</span> any-char)))  <span class="co">; Escape sequence</span></span>
<span id="cb111-56"><a href="#cb111-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-57"><a href="#cb111-57" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev string-literal</span>
<span id="cb111-58"><a href="#cb111-58" aria-hidden="true" tabindex="-1"></a>  (:seq <span class="ch">#\&quot;</span></span>
<span id="cb111-59"><a href="#cb111-59" aria-hidden="true" tabindex="-1"></a>        (:* string-char)</span>
<span id="cb111-60"><a href="#cb111-60" aria-hidden="true" tabindex="-1"></a>        <span class="ch">#\&quot;</span>))</span>
<span id="cb111-61"><a href="#cb111-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-62"><a href="#cb111-62" aria-hidden="true" tabindex="-1"></a><span class="co">;; Keywords (Racket-style #:keyword)</span></span>
<span id="cb111-63"><a href="#cb111-63" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev keyword</span>
<span id="cb111-64"><a href="#cb111-64" aria-hidden="true" tabindex="-1"></a>  (:seq <span class="st">&quot;#:&quot;</span></span>
<span id="cb111-65"><a href="#cb111-65" aria-hidden="true" tabindex="-1"></a>        identifier))</span>
<span id="cb111-66"><a href="#cb111-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-67"><a href="#cb111-67" aria-hidden="true" tabindex="-1"></a><span class="co">;; Comments</span></span>
<span id="cb111-68"><a href="#cb111-68" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev line-comment</span>
<span id="cb111-69"><a href="#cb111-69" aria-hidden="true" tabindex="-1"></a>  (:seq <span class="st">&quot;;&quot;</span></span>
<span id="cb111-70"><a href="#cb111-70" aria-hidden="true" tabindex="-1"></a>        (:* (:~ <span class="ch">#\</span><span class="er">newline</span>))</span>
<span id="cb111-71"><a href="#cb111-71" aria-hidden="true" tabindex="-1"></a>        (:? <span class="ch">#\</span><span class="er">newline</span>)))</span>
<span id="cb111-72"><a href="#cb111-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-73"><a href="#cb111-73" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev block-comment</span>
<span id="cb111-74"><a href="#cb111-74" aria-hidden="true" tabindex="-1"></a>  (:seq <span class="st">&quot;#|&quot;</span></span>
<span id="cb111-75"><a href="#cb111-75" aria-hidden="true" tabindex="-1"></a>        (:* (:or (:~ <span class="ch">#\|</span>)</span>
<span id="cb111-76"><a href="#cb111-76" aria-hidden="true" tabindex="-1"></a>                 (:seq <span class="ch">#\|</span> (:~ <span class="ch">#\#</span>))))</span>
<span id="cb111-77"><a href="#cb111-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;|#&quot;</span>))</span></code></pre></div>
<h2 id="building-the-lexer">Building the Lexer</h2>
<p>Now let’s implement the lexer using these patterns:</p>
<div class="sourceCode" id="cb112"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; lexer.rkt</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>(require parser-tools/lex</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>         (prefix-in : parser-tools/lex-sre)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;token-types.rkt&quot;</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;lexer-patterns.rkt&quot;</span>)</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>(provide make-lexer</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>         tokenize-string</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>         tokenize-file)</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a><span class="co">;; Track position information</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-position-tracker)</span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> (<span class="op">[</span>line <span class="dv">1</span><span class="op">]</span></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>column <span class="dv">1</span><span class="op">]</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>offset <span class="dv">0</span><span class="op">]</span>)</span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>    (λ (action <span class="op">[</span>chars <span class="dv">1</span><span class="op">]</span>)</span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">case</span> action</span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(get) (source-location line column offset)<span class="op">]</span></span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(advance)</span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">set!</span> offset (<span class="op">+</span> offset chars))</span>
<span id="cb112-23"><a href="#cb112-23" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">set!</span> column (<span class="op">+</span> column chars))<span class="op">]</span></span>
<span id="cb112-24"><a href="#cb112-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="kw">newline</span>)</span>
<span id="cb112-25"><a href="#cb112-25" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">set!</span> offset (<span class="op">+</span> offset <span class="dv">1</span>))</span>
<span id="cb112-26"><a href="#cb112-26" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">set!</span> line (<span class="op">+</span> line <span class="dv">1</span>))</span>
<span id="cb112-27"><a href="#cb112-27" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">set!</span> column <span class="dv">1</span>)<span class="op">]</span>))))</span>
<span id="cb112-28"><a href="#cb112-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-29"><a href="#cb112-29" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main lexer definition</span></span>
<span id="cb112-30"><a href="#cb112-30" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-shrdlu-lexer input-port <span class="op">[</span>source-name <span class="st">&quot;unknown&quot;</span><span class="op">]</span>)</span>
<span id="cb112-31"><a href="#cb112-31" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> pos-tracker </span>(make-position-tracker))</span>
<span id="cb112-32"><a href="#cb112-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-33"><a href="#cb112-33" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> shrdlu-lexer</span></span>
<span id="cb112-34"><a href="#cb112-34" aria-hidden="true" tabindex="-1"></a>    (lexer-src-pos</span>
<span id="cb112-35"><a href="#cb112-35" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Whitespace - skip but track position</span></span>
<span id="cb112-36"><a href="#cb112-36" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>whitespace</span>
<span id="cb112-37"><a href="#cb112-37" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">begin</span></span>
<span id="cb112-38"><a href="#cb112-38" aria-hidden="true" tabindex="-1"></a>        (pos-tracker &#39;advance (<span class="kw">string-length</span> lexeme))</span>
<span id="cb112-39"><a href="#cb112-39" aria-hidden="true" tabindex="-1"></a>        (return-without-pos (shrdlu-lexer input-port)))<span class="op">]</span></span>
<span id="cb112-40"><a href="#cb112-40" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-41"><a href="#cb112-41" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Newlines - track line numbers</span></span>
<span id="cb112-42"><a href="#cb112-42" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="kw">newline</span></span>
<span id="cb112-43"><a href="#cb112-43" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">begin</span></span>
<span id="cb112-44"><a href="#cb112-44" aria-hidden="true" tabindex="-1"></a>        (pos-tracker &#39;newline)</span>
<span id="cb112-45"><a href="#cb112-45" aria-hidden="true" tabindex="-1"></a>        (return-without-pos (shrdlu-lexer input-port)))<span class="op">]</span></span>
<span id="cb112-46"><a href="#cb112-46" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-47"><a href="#cb112-47" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Comments - skip entirely</span></span>
<span id="cb112-48"><a href="#cb112-48" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(:or line-comment block-comment)</span>
<span id="cb112-49"><a href="#cb112-49" aria-hidden="true" tabindex="-1"></a>      (return-without-pos (shrdlu-lexer input-port))<span class="op">]</span></span>
<span id="cb112-50"><a href="#cb112-50" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-51"><a href="#cb112-51" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; The @ symbol - critical for Shrdlu</span></span>
<span id="cb112-52"><a href="#cb112-52" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;@&quot;</span></span>
<span id="cb112-53"><a href="#cb112-53" aria-hidden="true" tabindex="-1"></a>      (token-AT)<span class="op">]</span></span>
<span id="cb112-54"><a href="#cb112-54" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-55"><a href="#cb112-55" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Commands (@ followed by identifier)</span></span>
<span id="cb112-56"><a href="#cb112-56" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(:seq <span class="st">&quot;@&quot;</span> identifier)</span>
<span id="cb112-57"><a href="#cb112-57" aria-hidden="true" tabindex="-1"></a>      (token-COMMAND (<span class="kw">substring</span> lexeme <span class="dv">1</span>))<span class="op">]</span></span>
<span id="cb112-58"><a href="#cb112-58" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-59"><a href="#cb112-59" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Punctuation</span></span>
<span id="cb112-60"><a href="#cb112-60" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;[&quot;</span> (token-LBRACKET)<span class="op">]</span></span>
<span id="cb112-61"><a href="#cb112-61" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;]&quot;</span> (token-RBRACKET)<span class="op">]</span></span>
<span id="cb112-62"><a href="#cb112-62" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;{&quot;</span> (token-LBRACE)<span class="op">]</span></span>
<span id="cb112-63"><a href="#cb112-63" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;}&quot;</span> (token-RBRACE)<span class="op">]</span></span>
<span id="cb112-64"><a href="#cb112-64" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;(&quot;</span> (token-LPAREN)<span class="op">]</span></span>
<span id="cb112-65"><a href="#cb112-65" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;)&quot;</span> (token-RPAREN)<span class="op">]</span></span>
<span id="cb112-66"><a href="#cb112-66" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;;&quot;</span> (token-SEMICOLON)<span class="op">]</span></span>
<span id="cb112-67"><a href="#cb112-67" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-68"><a href="#cb112-68" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Keywords</span></span>
<span id="cb112-69"><a href="#cb112-69" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>keyword</span>
<span id="cb112-70"><a href="#cb112-70" aria-hidden="true" tabindex="-1"></a>      (token-KEYWORD (string-&gt;keyword (<span class="kw">substring</span> lexeme <span class="dv">2</span>)))<span class="op">]</span></span>
<span id="cb112-71"><a href="#cb112-71" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-72"><a href="#cb112-72" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Numbers</span></span>
<span id="cb112-73"><a href="#cb112-73" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>number</span>
<span id="cb112-74"><a href="#cb112-74" aria-hidden="true" tabindex="-1"></a>      (token-NUMBER (<span class="kw">string-&gt;number</span> lexeme))<span class="op">]</span></span>
<span id="cb112-75"><a href="#cb112-75" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-76"><a href="#cb112-76" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Strings with escape processing</span></span>
<span id="cb112-77"><a href="#cb112-77" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>string-literal</span>
<span id="cb112-78"><a href="#cb112-78" aria-hidden="true" tabindex="-1"></a>      (token-STRING (process-string-escapes </span>
<span id="cb112-79"><a href="#cb112-79" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">substring</span> lexeme <span class="dv">1</span> (<span class="op">-</span> (<span class="kw">string-length</span> lexeme) <span class="dv">1</span>))))<span class="op">]</span></span>
<span id="cb112-80"><a href="#cb112-80" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-81"><a href="#cb112-81" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Identifiers</span></span>
<span id="cb112-82"><a href="#cb112-82" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>identifier</span>
<span id="cb112-83"><a href="#cb112-83" aria-hidden="true" tabindex="-1"></a>      (token-IDENTIFIER (<span class="kw">string-&gt;symbol</span> lexeme))<span class="op">]</span></span>
<span id="cb112-84"><a href="#cb112-84" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-85"><a href="#cb112-85" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; End of file</span></span>
<span id="cb112-86"><a href="#cb112-86" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(eof)</span>
<span id="cb112-87"><a href="#cb112-87" aria-hidden="true" tabindex="-1"></a>      (token-EOF)<span class="op">]</span></span>
<span id="cb112-88"><a href="#cb112-88" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb112-89"><a href="#cb112-89" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Catch-all for illegal characters</span></span>
<span id="cb112-90"><a href="#cb112-90" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>any-char</span>
<span id="cb112-91"><a href="#cb112-91" aria-hidden="true" tabindex="-1"></a>      (raise-lex-error source-name</span>
<span id="cb112-92"><a href="#cb112-92" aria-hidden="true" tabindex="-1"></a>                       (pos-tracker &#39;get)</span>
<span id="cb112-93"><a href="#cb112-93" aria-hidden="true" tabindex="-1"></a>                       (format <span class="st">&quot;Illegal character: ~a&quot;</span> lexeme))<span class="op">]</span>))</span>
<span id="cb112-94"><a href="#cb112-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-95"><a href="#cb112-95" aria-hidden="true" tabindex="-1"></a>  shrdlu-lexer)</span>
<span id="cb112-96"><a href="#cb112-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-97"><a href="#cb112-97" aria-hidden="true" tabindex="-1"></a><span class="co">;; Process escape sequences in strings</span></span>
<span id="cb112-98"><a href="#cb112-98" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(process-string-escapes str)</span>
<span id="cb112-99"><a href="#cb112-99" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(process-char chars acc)</span>
<span id="cb112-100"><a href="#cb112-100" aria-hidden="true" tabindex="-1"></a>    (match chars</span>
<span id="cb112-101"><a href="#cb112-101" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>&#39;() (<span class="kw">list-&gt;string</span> (<span class="kw">reverse</span> acc))<span class="op">]</span></span>
<span id="cb112-102"><a href="#cb112-102" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">cons</span> <span class="ch">#\\</span> (<span class="kw">cons</span> c rest))</span>
<span id="cb112-103"><a href="#cb112-103" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> escaped-char</span></span>
<span id="cb112-104"><a href="#cb112-104" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">case</span> c</span>
<span id="cb112-105"><a href="#cb112-105" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="ch">#\n</span>) <span class="ch">#\</span><span class="er">newline</span><span class="op">]</span></span>
<span id="cb112-106"><a href="#cb112-106" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="ch">#\t</span>) <span class="ch">#\</span><span class="er">tab</span><span class="op">]</span></span>
<span id="cb112-107"><a href="#cb112-107" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="ch">#\r</span>) <span class="ch">#\</span><span class="er">return</span><span class="op">]</span></span>
<span id="cb112-108"><a href="#cb112-108" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="ch">#\&quot;</span>) <span class="ch">#\&quot;</span><span class="op">]</span></span>
<span id="cb112-109"><a href="#cb112-109" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="ch">#\\</span>) <span class="ch">#\\</span><span class="op">]</span></span>
<span id="cb112-110"><a href="#cb112-110" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="ch">#\0</span>) <span class="ch">#\</span><span class="er">null</span><span class="op">]</span></span>
<span id="cb112-111"><a href="#cb112-111" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span><span class="kw">else</span> c<span class="op">]</span>))  <span class="co">; Unknown escape, keep as-is</span></span>
<span id="cb112-112"><a href="#cb112-112" aria-hidden="true" tabindex="-1"></a>       (process-char rest (<span class="kw">cons</span> escaped-char acc))<span class="op">]</span></span>
<span id="cb112-113"><a href="#cb112-113" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">cons</span> c rest)</span>
<span id="cb112-114"><a href="#cb112-114" aria-hidden="true" tabindex="-1"></a>       (process-char rest (<span class="kw">cons</span> c acc))<span class="op">]</span>))</span>
<span id="cb112-115"><a href="#cb112-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-116"><a href="#cb112-116" aria-hidden="true" tabindex="-1"></a>  (process-char (<span class="kw">string-&gt;list</span> str) &#39;()))</span>
<span id="cb112-117"><a href="#cb112-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-118"><a href="#cb112-118" aria-hidden="true" tabindex="-1"></a><span class="co">;; Custom error reporting</span></span>
<span id="cb112-119"><a href="#cb112-119" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(raise-lex-error source pos message)</span>
<span id="cb112-120"><a href="#cb112-120" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">raise</span></span>
<span id="cb112-121"><a href="#cb112-121" aria-hidden="true" tabindex="-1"></a>   (exn:fail:read</span>
<span id="cb112-122"><a href="#cb112-122" aria-hidden="true" tabindex="-1"></a>    (format <span class="st">&quot;~a:~a:~a: ~a&quot;</span> </span>
<span id="cb112-123"><a href="#cb112-123" aria-hidden="true" tabindex="-1"></a>            source </span>
<span id="cb112-124"><a href="#cb112-124" aria-hidden="true" tabindex="-1"></a>            (source-location-line pos)</span>
<span id="cb112-125"><a href="#cb112-125" aria-hidden="true" tabindex="-1"></a>            (source-location-column pos)</span>
<span id="cb112-126"><a href="#cb112-126" aria-hidden="true" tabindex="-1"></a>            message)</span>
<span id="cb112-127"><a href="#cb112-127" aria-hidden="true" tabindex="-1"></a>    (current-continuation-marks)</span>
<span id="cb112-128"><a href="#cb112-128" aria-hidden="true" tabindex="-1"></a>    &#39;())))</span>
<span id="cb112-129"><a href="#cb112-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-130"><a href="#cb112-130" aria-hidden="true" tabindex="-1"></a><span class="co">;; Convenience functions</span></span>
<span id="cb112-131"><a href="#cb112-131" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(tokenize-string str #:source <span class="op">[</span>source <span class="st">&quot;string&quot;</span><span class="op">]</span>)</span>
<span id="cb112-132"><a href="#cb112-132" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> input </span>(open-input-string str))</span>
<span id="cb112-133"><a href="#cb112-133" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> lexer </span>(make-shrdlu-lexer input source))</span>
<span id="cb112-134"><a href="#cb112-134" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(collect-tokens)</span>
<span id="cb112-135"><a href="#cb112-135" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> tok </span>(lexer))</span>
<span id="cb112-136"><a href="#cb112-136" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (<span class="kw">eq?</span> (position-token-token tok) &#39;EOF)</span>
<span id="cb112-137"><a href="#cb112-137" aria-hidden="true" tabindex="-1"></a>        &#39;()</span>
<span id="cb112-138"><a href="#cb112-138" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">cons</span> tok (collect-tokens))))</span>
<span id="cb112-139"><a href="#cb112-139" aria-hidden="true" tabindex="-1"></a>  (collect-tokens))</span>
<span id="cb112-140"><a href="#cb112-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-141"><a href="#cb112-141" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(tokenize-file path)</span>
<span id="cb112-142"><a href="#cb112-142" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-with-input-file</span> path</span>
<span id="cb112-143"><a href="#cb112-143" aria-hidden="true" tabindex="-1"></a>    (λ (input)</span>
<span id="cb112-144"><a href="#cb112-144" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> lexer </span>(make-shrdlu-lexer input path))</span>
<span id="cb112-145"><a href="#cb112-145" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> </span>(collect-tokens)</span>
<span id="cb112-146"><a href="#cb112-146" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> tok </span>(lexer))</span>
<span id="cb112-147"><a href="#cb112-147" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">if</span> (<span class="kw">eq?</span> (position-token-token tok) &#39;EOF)</span>
<span id="cb112-148"><a href="#cb112-148" aria-hidden="true" tabindex="-1"></a>            &#39;()</span>
<span id="cb112-149"><a href="#cb112-149" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">cons</span> tok (collect-tokens))))</span>
<span id="cb112-150"><a href="#cb112-150" aria-hidden="true" tabindex="-1"></a>      (collect-tokens))))</span></code></pre></div>
<h3 id="advanced-lexer-features">Advanced Lexer Features</h3>
<p>Let’s add support for more sophisticated lexical features:</p>
<div class="sourceCode" id="cb113"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; lexer-advanced.rkt</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;lexer.rkt&quot;</span>)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Here-string support for multi-line literals</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev here-string-delimiter</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>  (:seq <span class="st">&quot;&lt;&lt;&quot;</span> (:+ alpha)))</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(lex-here-string input-port delim)</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> end-pattern </span>(<span class="kw">string-append</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> delim))</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(read-until-delimiter chars)</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> ch </span>(<span class="kw">read-char</span> input-port))</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">eof-object?</span> ch)</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">error</span> &#39;here-string <span class="st">&quot;Unexpected EOF in here-string&quot;</span>)<span class="op">]</span></span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> new-chars </span>(<span class="kw">cons</span> ch chars))</span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> str </span>(<span class="kw">list-&gt;string</span> (<span class="kw">reverse</span> new-chars)))</span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">if</span> (string-suffix? str end-pattern)</span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">substring</span> str <span class="dv">0</span> (<span class="op">-</span> (<span class="kw">string-length</span> str) </span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>                              (<span class="kw">string-length</span> end-pattern)))</span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>           (read-until-delimiter new-chars))<span class="op">]</span>))</span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>  (read-until-delimiter &#39;()))</span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a><span class="co">;; Raw string literals (no escape processing)</span></span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev raw-string</span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>  (:seq <span class="st">&quot;r</span><span class="ch">\&quot;</span><span class="st">&quot;</span> </span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>        (:* (:~ <span class="ch">#\&quot;</span>))</span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;</span><span class="ch">\&quot;</span><span class="st">&quot;</span>))</span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a><span class="co">;; Unicode support</span></span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a>(define-lex-abbrev unicode-escape</span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a>  (:seq <span class="st">&quot;</span><span class="ch">\\</span><span class="st">u&quot;</span></span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a>        (:= <span class="dv">4</span> (:or digit </span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a>                   (:/ <span class="st">&quot;a&quot;</span> <span class="st">&quot;f&quot;</span>) </span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a>                   (:/ <span class="st">&quot;A&quot;</span> <span class="st">&quot;F&quot;</span>)))))</span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-40"><a href="#cb113-40" aria-hidden="true" tabindex="-1"></a><span class="co">;; Extended lexer with additional features</span></span>
<span id="cb113-41"><a href="#cb113-41" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-extended-lexer input-port <span class="op">[</span>source <span class="st">&quot;unknown&quot;</span><span class="op">]</span>)</span>
<span id="cb113-42"><a href="#cb113-42" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> base-lexer </span>(make-shrdlu-lexer input-port source))</span>
<span id="cb113-43"><a href="#cb113-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-44"><a href="#cb113-44" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> extended-lexer</span></span>
<span id="cb113-45"><a href="#cb113-45" aria-hidden="true" tabindex="-1"></a>    (lexer-src-pos</span>
<span id="cb113-46"><a href="#cb113-46" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Here-strings</span></span>
<span id="cb113-47"><a href="#cb113-47" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>here-string-delimiter</span>
<span id="cb113-48"><a href="#cb113-48" aria-hidden="true" tabindex="-1"></a>      (token-STRING (lex-here-string input-port </span>
<span id="cb113-49"><a href="#cb113-49" aria-hidden="true" tabindex="-1"></a>                                     (<span class="kw">substring</span> lexeme <span class="dv">2</span>)))<span class="op">]</span></span>
<span id="cb113-50"><a href="#cb113-50" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb113-51"><a href="#cb113-51" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Raw strings</span></span>
<span id="cb113-52"><a href="#cb113-52" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>raw-string</span>
<span id="cb113-53"><a href="#cb113-53" aria-hidden="true" tabindex="-1"></a>      (token-STRING (<span class="kw">substring</span> lexeme <span class="dv">2</span> </span>
<span id="cb113-54"><a href="#cb113-54" aria-hidden="true" tabindex="-1"></a>                              (<span class="op">-</span> (<span class="kw">string-length</span> lexeme) <span class="dv">1</span>)))<span class="op">]</span></span>
<span id="cb113-55"><a href="#cb113-55" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb113-56"><a href="#cb113-56" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Unicode escapes in identifiers</span></span>
<span id="cb113-57"><a href="#cb113-57" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(:seq identifier-start </span>
<span id="cb113-58"><a href="#cb113-58" aria-hidden="true" tabindex="-1"></a>            (:* (:or identifier-continue unicode-escape)))</span>
<span id="cb113-59"><a href="#cb113-59" aria-hidden="true" tabindex="-1"></a>      (token-IDENTIFIER (process-unicode-escapes lexeme))<span class="op">]</span></span>
<span id="cb113-60"><a href="#cb113-60" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb113-61"><a href="#cb113-61" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Delegate to base lexer</span></span>
<span id="cb113-62"><a href="#cb113-62" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="kw">else</span></span>
<span id="cb113-63"><a href="#cb113-63" aria-hidden="true" tabindex="-1"></a>      (base-lexer input-port)<span class="op">]</span>))</span>
<span id="cb113-64"><a href="#cb113-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-65"><a href="#cb113-65" aria-hidden="true" tabindex="-1"></a>  extended-lexer)</span>
<span id="cb113-66"><a href="#cb113-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-67"><a href="#cb113-67" aria-hidden="true" tabindex="-1"></a><span class="co">;; Process Unicode escape sequences</span></span>
<span id="cb113-68"><a href="#cb113-68" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(process-unicode-escapes str)</span>
<span id="cb113-69"><a href="#cb113-69" aria-hidden="true" tabindex="-1"></a>  (regexp-replace* </span>
<span id="cb113-70"><a href="#cb113-70" aria-hidden="true" tabindex="-1"></a>   #rx<span class="st">&quot;</span><span class="ch">\\\\</span><span class="st">u([0-9a-fA-F]{4})&quot;</span></span>
<span id="cb113-71"><a href="#cb113-71" aria-hidden="true" tabindex="-1"></a>   str</span>
<span id="cb113-72"><a href="#cb113-72" aria-hidden="true" tabindex="-1"></a>   (λ (match hex)</span>
<span id="cb113-73"><a href="#cb113-73" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">string</span> (<span class="kw">integer-&gt;char</span> (<span class="kw">string-&gt;number</span> hex <span class="dv">16</span>))))))</span></code></pre></div>
<h3 id="lexer-state-management">Lexer State Management</h3>
<p>Some lexical features require state tracking:</p>
<div class="sourceCode" id="cb114"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; lexer-stateful.rkt</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>(require parser-tools/lex)</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Lexer modes for context-sensitive tokenization</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>(define-struct lexer-state </span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>  (mode           <span class="co">; &#39;normal, &#39;code, &#39;math, &#39;verbatim</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>   brace-depth    <span class="co">; Track nested braces</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>   bracket-depth  <span class="co">; Track nested brackets</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>   string-delim)  <span class="co">; Current string delimiter</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>  #:mutable)</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-stateful-lexer input-port <span class="op">[</span>source <span class="st">&quot;unknown&quot;</span><span class="op">]</span>)</span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> state </span>(lexer-state &#39;normal <span class="dv">0</span> <span class="dv">0</span> <span class="dv">#f</span>))</span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Mode-specific lexers</span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(normal-mode-lexer)</span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>    (lexer-src-pos</span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Switch to code mode</span></span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;@code&quot;</span></span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">begin</span></span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>        (set-lexer-state-mode! state &#39;code)</span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>        (token-COMMAND <span class="st">&quot;code&quot;</span>))<span class="op">]</span></span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Switch to math mode</span></span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;@math&quot;</span></span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">begin</span></span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a>        (set-lexer-state-mode! state &#39;math)</span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a>        (token-COMMAND <span class="st">&quot;math&quot;</span>))<span class="op">]</span></span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Default processing</span></span>
<span id="cb114-33"><a href="#cb114-33" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="kw">else</span></span>
<span id="cb114-34"><a href="#cb114-34" aria-hidden="true" tabindex="-1"></a>      ((make-shrdlu-lexer input-port source))<span class="op">]</span>))</span>
<span id="cb114-35"><a href="#cb114-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-36"><a href="#cb114-36" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(code-mode-lexer)</span>
<span id="cb114-37"><a href="#cb114-37" aria-hidden="true" tabindex="-1"></a>    (lexer-src-pos</span>
<span id="cb114-38"><a href="#cb114-38" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; In code mode, preserve exact formatting</span></span>
<span id="cb114-39"><a href="#cb114-39" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(:+ (:~ <span class="ch">#\}</span>))</span>
<span id="cb114-40"><a href="#cb114-40" aria-hidden="true" tabindex="-1"></a>      (token-STRING lexeme)<span class="op">]</span></span>
<span id="cb114-41"><a href="#cb114-41" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb114-42"><a href="#cb114-42" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;}&quot;</span></span>
<span id="cb114-43"><a href="#cb114-43" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">begin</span></span>
<span id="cb114-44"><a href="#cb114-44" aria-hidden="true" tabindex="-1"></a>        (when (<span class="kw">zero?</span> (lexer-state-brace-depth state))</span>
<span id="cb114-45"><a href="#cb114-45" aria-hidden="true" tabindex="-1"></a>          (set-lexer-state-mode! state &#39;normal))</span>
<span id="cb114-46"><a href="#cb114-46" aria-hidden="true" tabindex="-1"></a>        (token-RBRACE))<span class="op">]</span>))</span>
<span id="cb114-47"><a href="#cb114-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-48"><a href="#cb114-48" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(math-mode-lexer)</span>
<span id="cb114-49"><a href="#cb114-49" aria-hidden="true" tabindex="-1"></a>    (lexer-src-pos</span>
<span id="cb114-50"><a href="#cb114-50" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; LaTeX-style math commands</span></span>
<span id="cb114-51"><a href="#cb114-51" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(:seq <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> (:+ alpha))</span>
<span id="cb114-52"><a href="#cb114-52" aria-hidden="true" tabindex="-1"></a>      (token-COMMAND (<span class="kw">substring</span> lexeme <span class="dv">1</span>))<span class="op">]</span></span>
<span id="cb114-53"><a href="#cb114-53" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb114-54"><a href="#cb114-54" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Math operators</span></span>
<span id="cb114-55"><a href="#cb114-55" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(:or <span class="st">&quot;+&quot;</span> <span class="st">&quot;-&quot;</span> <span class="st">&quot;*&quot;</span> <span class="st">&quot;/&quot;</span> <span class="st">&quot;=&quot;</span> <span class="st">&quot;&lt;&quot;</span> <span class="st">&quot;&gt;&quot;</span> <span class="st">&quot;^&quot;</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb114-56"><a href="#cb114-56" aria-hidden="true" tabindex="-1"></a>      (token-IDENTIFIER (<span class="kw">string-&gt;symbol</span> lexeme))<span class="op">]</span></span>
<span id="cb114-57"><a href="#cb114-57" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb114-58"><a href="#cb114-58" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Exit math mode</span></span>
<span id="cb114-59"><a href="#cb114-59" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;}&quot;</span></span>
<span id="cb114-60"><a href="#cb114-60" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">begin</span></span>
<span id="cb114-61"><a href="#cb114-61" aria-hidden="true" tabindex="-1"></a>        (set-lexer-state-mode! state &#39;normal)</span>
<span id="cb114-62"><a href="#cb114-62" aria-hidden="true" tabindex="-1"></a>        (token-RBRACE))<span class="op">]</span>))</span>
<span id="cb114-63"><a href="#cb114-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb114-64"><a href="#cb114-64" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Dispatch based on mode</span></span>
<span id="cb114-65"><a href="#cb114-65" aria-hidden="true" tabindex="-1"></a>  (λ ()</span>
<span id="cb114-66"><a href="#cb114-66" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">case</span> (lexer-state-mode state)</span>
<span id="cb114-67"><a href="#cb114-67" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(normal) (normal-mode-lexer)<span class="op">]</span></span>
<span id="cb114-68"><a href="#cb114-68" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(code) (code-mode-lexer)<span class="op">]</span></span>
<span id="cb114-69"><a href="#cb114-69" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(math) (math-mode-lexer)<span class="op">]</span></span>
<span id="cb114-70"><a href="#cb114-70" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span> (<span class="kw">error</span> &#39;lexer <span class="st">&quot;Unknown mode&quot;</span>)<span class="op">]</span>)))</span></code></pre></div>
<h2 id="parser-architecture-and-grammar-design">Parser Architecture and
Grammar Design</h2>
<p>With our lexer producing a stream of tokens, we now build the parser
that assembles these tokens into an Abstract Syntax Tree (AST). Shrdlu’s
grammar is designed to be:</p>
<ol type="1">
<li><strong>Unambiguous</strong>: Each valid input has exactly one
parse</li>
<li><strong>Left-factored</strong>: To work well with LALR(1)
parsing</li>
<li><strong>Error-friendly</strong>: Providing good error recovery</li>
</ol>
<h3 id="abstract-syntax-tree-design">Abstract Syntax Tree Design</h3>
<p>First, let’s define our AST node types:</p>
<div class="sourceCode" id="cb115"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; ast.rkt</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>(provide (all-defined-out))</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Base AST node with source location</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>(struct ast-node (location) #:transparent)</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Document structure nodes</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>(struct document ast-node (metadata content) #:transparent)</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>(struct section ast-node (level title label content) #:transparent)</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>(struct paragraph ast-node (content) #:transparent)</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; Inline elements</span></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>(struct text ast-node (value) #:transparent)</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>(struct command ast-node (name args content) #:transparent)</span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>(struct emphasis ast-node (content) #:transparent)</span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>(struct strong ast-node (content) #:transparent)</span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>(struct code ast-node (lang content) #:transparent)</span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>(struct math ast-node (display? content) #:transparent)</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a><span class="co">;; Lists</span></span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a>(struct itemize ast-node (items) #:transparent)</span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a>(struct enumerate ast-node (style items) #:transparent)</span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>(struct item ast-node (content) #:transparent)</span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a><span class="co">;; Links and references  </span></span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a>(struct link ast-node (href title content) #:transparent)</span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>(struct ref ast-node (type target) #:transparent)</span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a>(struct cite ast-node (keys) #:transparent)</span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a><span class="co">;; Block elements</span></span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a>(struct figure ast-node (label caption content) #:transparent)</span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a>(struct table ast-node (label caption rows) #:transparent)</span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a>(struct row ast-node (cells) #:transparent)</span>
<span id="cb115-36"><a href="#cb115-36" aria-hidden="true" tabindex="-1"></a>(struct cell ast-node (header? colspan rowspan content) #:transparent)</span>
<span id="cb115-37"><a href="#cb115-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-38"><a href="#cb115-38" aria-hidden="true" tabindex="-1"></a><span class="co">;; Code and computation</span></span>
<span id="cb115-39"><a href="#cb115-39" aria-hidden="true" tabindex="-1"></a>(struct code-block ast-node (lang options content) #:transparent)</span>
<span id="cb115-40"><a href="#cb115-40" aria-hidden="true" tabindex="-1"></a>(struct expression ast-node (form) #:transparent)</span>
<span id="cb115-41"><a href="#cb115-41" aria-hidden="true" tabindex="-1"></a>(struct definition ast-node (name params body) #:transparent)</span>
<span id="cb115-42"><a href="#cb115-42" aria-hidden="true" tabindex="-1"></a>(struct conditional ast-node (test then <span class="kw">else</span>) #:transparent)</span>
<span id="cb115-43"><a href="#cb115-43" aria-hidden="true" tabindex="-1"></a>(struct loop ast-node (type bindings body) #:transparent)</span>
<span id="cb115-44"><a href="#cb115-44" aria-hidden="true" tabindex="-1"></a>(struct application ast-node (func args) #:transparent)</span>
<span id="cb115-45"><a href="#cb115-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-46"><a href="#cb115-46" aria-hidden="true" tabindex="-1"></a><span class="co">;; Special nodes</span></span>
<span id="cb115-47"><a href="#cb115-47" aria-hidden="true" tabindex="-1"></a>(struct include ast-node (path) #:transparent)</span>
<span id="cb115-48"><a href="#cb115-48" aria-hidden="true" tabindex="-1"></a>(struct raw ast-node (format content) #:transparent)</span>
<span id="cb115-49"><a href="#cb115-49" aria-hidden="true" tabindex="-1"></a>(struct meta ast-node (key value) #:transparent)</span>
<span id="cb115-50"><a href="#cb115-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-51"><a href="#cb115-51" aria-hidden="true" tabindex="-1"></a><span class="co">;; Helper functions</span></span>
<span id="cb115-52"><a href="#cb115-52" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(ast-node-type node)</span>
<span id="cb115-53"><a href="#cb115-53" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb115-54"><a href="#cb115-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(document? node) &#39;document<span class="op">]</span></span>
<span id="cb115-55"><a href="#cb115-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(section? node) &#39;section<span class="op">]</span></span>
<span id="cb115-56"><a href="#cb115-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(paragraph? node) &#39;paragraph<span class="op">]</span></span>
<span id="cb115-57"><a href="#cb115-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(text? node) &#39;text<span class="op">]</span></span>
<span id="cb115-58"><a href="#cb115-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(command? node) &#39;command<span class="op">]</span></span>
<span id="cb115-59"><a href="#cb115-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; ... etc</span></span>
<span id="cb115-60"><a href="#cb115-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> &#39;unknown<span class="op">]</span>))</span>
<span id="cb115-61"><a href="#cb115-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-62"><a href="#cb115-62" aria-hidden="true" tabindex="-1"></a><span class="co">;; Pretty printing for debugging</span></span>
<span id="cb115-63"><a href="#cb115-63" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(ast-&gt;sexp node)</span>
<span id="cb115-64"><a href="#cb115-64" aria-hidden="true" tabindex="-1"></a>  (match node</span>
<span id="cb115-65"><a href="#cb115-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(document loc meta content)</span>
<span id="cb115-66"><a href="#cb115-66" aria-hidden="true" tabindex="-1"></a>     `(document ,@(map ast-&gt;sexp content))<span class="op">]</span></span>
<span id="cb115-67"><a href="#cb115-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(section loc level title label content)</span>
<span id="cb115-68"><a href="#cb115-68" aria-hidden="true" tabindex="-1"></a>     `(section ,level ,title ,@(map ast-&gt;sexp content))<span class="op">]</span></span>
<span id="cb115-69"><a href="#cb115-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(paragraph loc content)</span>
<span id="cb115-70"><a href="#cb115-70" aria-hidden="true" tabindex="-1"></a>     `(p ,@(map ast-&gt;sexp content))<span class="op">]</span></span>
<span id="cb115-71"><a href="#cb115-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(text loc value) value<span class="op">]</span></span>
<span id="cb115-72"><a href="#cb115-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(command loc name args content)</span>
<span id="cb115-73"><a href="#cb115-73" aria-hidden="true" tabindex="-1"></a>     `(,name ,@args ,@(map ast-&gt;sexp content))<span class="op">]</span></span>
<span id="cb115-74"><a href="#cb115-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(emphasis loc content)</span>
<span id="cb115-75"><a href="#cb115-75" aria-hidden="true" tabindex="-1"></a>     `(em ,@(map ast-&gt;sexp content))<span class="op">]</span></span>
<span id="cb115-76"><a href="#cb115-76" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> node<span class="op">]</span>))</span></code></pre></div>
<h3 id="grammar-specification">Grammar Specification</h3>
<p>Now let’s define Shrdlu’s grammar in BNF-like notation:</p>
<div class="sourceCode" id="cb116"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; grammar.rkt</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>(require parser-tools/yacc</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>         parser-tools/lex</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;token-types.rkt&quot;</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;ast.rkt&quot;</span>)</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>(provide parse-shrdlu)</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parser definition</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> parse-shrdlu</span></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>  (parser</span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Token precedence and associativity</span></span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>   (tokens value-tokens punctuation-tokens)</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Start symbol</span></span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>   (start document)</span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Error handling</span></span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">error</span> (λ (tok-ok? tok-name tok-value)</span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>            (raise-syntax-error </span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a>             &#39;parser</span>
<span id="cb116-24"><a href="#cb116-24" aria-hidden="true" tabindex="-1"></a>             (format <span class="st">&quot;Unexpected token ~a~a&quot;</span></span>
<span id="cb116-25"><a href="#cb116-25" aria-hidden="true" tabindex="-1"></a>                     tok-name</span>
<span id="cb116-26"><a href="#cb116-26" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">if</span> tok-value </span>
<span id="cb116-27"><a href="#cb116-27" aria-hidden="true" tabindex="-1"></a>                         (format <span class="st">&quot; (~a)&quot;</span> tok-value)</span>
<span id="cb116-28"><a href="#cb116-28" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&quot;&quot;</span>)))))</span>
<span id="cb116-29"><a href="#cb116-29" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb116-30"><a href="#cb116-30" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; End-of-file token</span></span>
<span id="cb116-31"><a href="#cb116-31" aria-hidden="true" tabindex="-1"></a>   (end EOF)</span>
<span id="cb116-32"><a href="#cb116-32" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb116-33"><a href="#cb116-33" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Grammar rules</span></span>
<span id="cb116-34"><a href="#cb116-34" aria-hidden="true" tabindex="-1"></a>   (grammar</span>
<span id="cb116-35"><a href="#cb116-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-36"><a href="#cb116-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Document structure</span></span>
<span id="cb116-37"><a href="#cb116-37" aria-hidden="true" tabindex="-1"></a>    (document</span>
<span id="cb116-38"><a href="#cb116-38" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(metadata-list element-list)</span>
<span id="cb116-39"><a href="#cb116-39" aria-hidden="true" tabindex="-1"></a>      (document <span class="dv">#f</span> $1 $2)<span class="op">]</span>)</span>
<span id="cb116-40"><a href="#cb116-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-41"><a href="#cb116-41" aria-hidden="true" tabindex="-1"></a>    (metadata-list</span>
<span id="cb116-42"><a href="#cb116-42" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>() &#39;()<span class="op">]</span></span>
<span id="cb116-43"><a href="#cb116-43" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(metadata metadata-list)</span>
<span id="cb116-44"><a href="#cb116-44" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">cons</span> $1 $2)<span class="op">]</span>)</span>
<span id="cb116-45"><a href="#cb116-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-46"><a href="#cb116-46" aria-hidden="true" tabindex="-1"></a>    (metadata</span>
<span id="cb116-47"><a href="#cb116-47" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND option-list)</span>
<span id="cb116-48"><a href="#cb116-48" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">if</span> (<span class="kw">eq?</span> $2 &#39;meta)</span>
<span id="cb116-49"><a href="#cb116-49" aria-hidden="true" tabindex="-1"></a>          (apply meta <span class="dv">#f</span> $3)</span>
<span id="cb116-50"><a href="#cb116-50" aria-hidden="true" tabindex="-1"></a>          <span class="dv">#f</span>)<span class="op">]</span>)</span>
<span id="cb116-51"><a href="#cb116-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-52"><a href="#cb116-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Elements (top-level content)</span></span>
<span id="cb116-53"><a href="#cb116-53" aria-hidden="true" tabindex="-1"></a>    (element-list</span>
<span id="cb116-54"><a href="#cb116-54" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>() &#39;()<span class="op">]</span></span>
<span id="cb116-55"><a href="#cb116-55" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(element element-list)</span>
<span id="cb116-56"><a href="#cb116-56" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">cons</span> $1 $2)<span class="op">]</span>)</span>
<span id="cb116-57"><a href="#cb116-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-58"><a href="#cb116-58" aria-hidden="true" tabindex="-1"></a>    (element</span>
<span id="cb116-59"><a href="#cb116-59" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND)</span>
<span id="cb116-60"><a href="#cb116-60" aria-hidden="true" tabindex="-1"></a>      (command <span class="dv">#f</span> $2 &#39;() &#39;())<span class="op">]</span></span>
<span id="cb116-61"><a href="#cb116-61" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND option-list)</span>
<span id="cb116-62"><a href="#cb116-62" aria-hidden="true" tabindex="-1"></a>      (command <span class="dv">#f</span> $2 $3 &#39;())<span class="op">]</span></span>
<span id="cb116-63"><a href="#cb116-63" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND content-block)</span>
<span id="cb116-64"><a href="#cb116-64" aria-hidden="true" tabindex="-1"></a>      (command <span class="dv">#f</span> $2 &#39;() $3)<span class="op">]</span></span>
<span id="cb116-65"><a href="#cb116-65" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND option-list content-block)</span>
<span id="cb116-66"><a href="#cb116-66" aria-hidden="true" tabindex="-1"></a>      (command <span class="dv">#f</span> $2 $3 $4)<span class="op">]</span></span>
<span id="cb116-67"><a href="#cb116-67" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(paragraph)</span>
<span id="cb116-68"><a href="#cb116-68" aria-hidden="true" tabindex="-1"></a>      $1<span class="op">]</span>)</span>
<span id="cb116-69"><a href="#cb116-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-70"><a href="#cb116-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Options/arguments in square brackets</span></span>
<span id="cb116-71"><a href="#cb116-71" aria-hidden="true" tabindex="-1"></a>    (option-list</span>
<span id="cb116-72"><a href="#cb116-72" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(LBRACKET RBRACKET) &#39;()<span class="op">]</span></span>
<span id="cb116-73"><a href="#cb116-73" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(LBRACKET options RBRACKET) $2<span class="op">]</span>)</span>
<span id="cb116-74"><a href="#cb116-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-75"><a href="#cb116-75" aria-hidden="true" tabindex="-1"></a>    (options</span>
<span id="cb116-76"><a href="#cb116-76" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(option) (<span class="kw">list</span> $1)<span class="op">]</span></span>
<span id="cb116-77"><a href="#cb116-77" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(option options) (<span class="kw">cons</span> $1 $2)<span class="op">]</span>)</span>
<span id="cb116-78"><a href="#cb116-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-79"><a href="#cb116-79" aria-hidden="true" tabindex="-1"></a>    (option</span>
<span id="cb116-80"><a href="#cb116-80" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(KEYWORD expression) (<span class="kw">list</span> $1 $2)<span class="op">]</span></span>
<span id="cb116-81"><a href="#cb116-81" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(expression) $1<span class="op">]</span>)</span>
<span id="cb116-82"><a href="#cb116-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-83"><a href="#cb116-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Content blocks in curly braces</span></span>
<span id="cb116-84"><a href="#cb116-84" aria-hidden="true" tabindex="-1"></a>    (content-block</span>
<span id="cb116-85"><a href="#cb116-85" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(LBRACE RBRACE) &#39;()<span class="op">]</span></span>
<span id="cb116-86"><a href="#cb116-86" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(LBRACE content-list RBRACE) $2<span class="op">]</span>)</span>
<span id="cb116-87"><a href="#cb116-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-88"><a href="#cb116-88" aria-hidden="true" tabindex="-1"></a>    (content-list</span>
<span id="cb116-89"><a href="#cb116-89" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(content) (<span class="kw">list</span> $1)<span class="op">]</span></span>
<span id="cb116-90"><a href="#cb116-90" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(content content-list) (<span class="kw">cons</span> $1 $2)<span class="op">]</span>)</span>
<span id="cb116-91"><a href="#cb116-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-92"><a href="#cb116-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Content types</span></span>
<span id="cb116-93"><a href="#cb116-93" aria-hidden="true" tabindex="-1"></a>    (content</span>
<span id="cb116-94"><a href="#cb116-94" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(text) $1<span class="op">]</span></span>
<span id="cb116-95"><a href="#cb116-95" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(inline-command) $1<span class="op">]</span></span>
<span id="cb116-96"><a href="#cb116-96" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(expression) $1<span class="op">]</span>)</span>
<span id="cb116-97"><a href="#cb116-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-98"><a href="#cb116-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Text and strings</span></span>
<span id="cb116-99"><a href="#cb116-99" aria-hidden="true" tabindex="-1"></a>    (text</span>
<span id="cb116-100"><a href="#cb116-100" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(STRING) (text <span class="dv">#f</span> $1)<span class="op">]</span></span>
<span id="cb116-101"><a href="#cb116-101" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(NUMBER) (text <span class="dv">#f</span> (<span class="kw">number-&gt;string</span> $1))<span class="op">]</span>)</span>
<span id="cb116-102"><a href="#cb116-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-103"><a href="#cb116-103" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Inline commands</span></span>
<span id="cb116-104"><a href="#cb116-104" aria-hidden="true" tabindex="-1"></a>    (inline-command</span>
<span id="cb116-105"><a href="#cb116-105" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT IDENTIFIER)</span>
<span id="cb116-106"><a href="#cb116-106" aria-hidden="true" tabindex="-1"></a>      (command <span class="dv">#f</span> $2 &#39;() &#39;())<span class="op">]</span></span>
<span id="cb116-107"><a href="#cb116-107" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT IDENTIFIER option-list)</span>
<span id="cb116-108"><a href="#cb116-108" aria-hidden="true" tabindex="-1"></a>      (command <span class="dv">#f</span> $2 $3 &#39;())<span class="op">]</span></span>
<span id="cb116-109"><a href="#cb116-109" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT IDENTIFIER content-block)</span>
<span id="cb116-110"><a href="#cb116-110" aria-hidden="true" tabindex="-1"></a>      (command <span class="dv">#f</span> $2 &#39;() $3)<span class="op">]</span></span>
<span id="cb116-111"><a href="#cb116-111" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT IDENTIFIER option-list content-block)</span>
<span id="cb116-112"><a href="#cb116-112" aria-hidden="true" tabindex="-1"></a>      (command <span class="dv">#f</span> $2 $3 $4)<span class="op">]</span>)</span>
<span id="cb116-113"><a href="#cb116-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-114"><a href="#cb116-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Expressions (computation)</span></span>
<span id="cb116-115"><a href="#cb116-115" aria-hidden="true" tabindex="-1"></a>    (expression</span>
<span id="cb116-116"><a href="#cb116-116" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(IDENTIFIER) $1<span class="op">]</span></span>
<span id="cb116-117"><a href="#cb116-117" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(NUMBER) $1<span class="op">]</span></span>
<span id="cb116-118"><a href="#cb116-118" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(STRING) $1<span class="op">]</span></span>
<span id="cb116-119"><a href="#cb116-119" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(KEYWORD) $1<span class="op">]</span></span>
<span id="cb116-120"><a href="#cb116-120" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(s-expression) $1<span class="op">]</span>)</span>
<span id="cb116-121"><a href="#cb116-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-122"><a href="#cb116-122" aria-hidden="true" tabindex="-1"></a>    (s-expression</span>
<span id="cb116-123"><a href="#cb116-123" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(LPAREN RPAREN) &#39;()<span class="op">]</span></span>
<span id="cb116-124"><a href="#cb116-124" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(LPAREN expression-list RPAREN) $2<span class="op">]</span>)</span>
<span id="cb116-125"><a href="#cb116-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-126"><a href="#cb116-126" aria-hidden="true" tabindex="-1"></a>    (expression-list</span>
<span id="cb116-127"><a href="#cb116-127" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(expression) (<span class="kw">list</span> $1)<span class="op">]</span></span>
<span id="cb116-128"><a href="#cb116-128" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(expression expression-list) (<span class="kw">cons</span> $1 $2)<span class="op">]</span>)</span>
<span id="cb116-129"><a href="#cb116-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-130"><a href="#cb116-130" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Paragraphs (implicit)</span></span>
<span id="cb116-131"><a href="#cb116-131" aria-hidden="true" tabindex="-1"></a>    (paragraph</span>
<span id="cb116-132"><a href="#cb116-132" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(text-run) (paragraph <span class="dv">#f</span> $1)<span class="op">]</span>)</span>
<span id="cb116-133"><a href="#cb116-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb116-134"><a href="#cb116-134" aria-hidden="true" tabindex="-1"></a>    (text-run</span>
<span id="cb116-135"><a href="#cb116-135" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(STRING) (<span class="kw">list</span> (text <span class="dv">#f</span> $1))<span class="op">]</span></span>
<span id="cb116-136"><a href="#cb116-136" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(STRING text-run) (<span class="kw">cons</span> (text <span class="dv">#f</span> $1) $2)<span class="op">]</span>))))</span></code></pre></div>
<h3 id="parser-implementation">Parser Implementation</h3>
<p>Let’s implement the parser with error recovery and location
tracking:</p>
<div class="sourceCode" id="cb117"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; parser.rkt</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>(require parser-tools/yacc</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>         parser-tools/lex</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;token-types.rkt&quot;</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;ast.rkt&quot;</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;lexer.rkt&quot;</span>)</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>(provide parse-string</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>         parse-file</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>         parse-tokens)</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; Enhanced parser with error recovery</span></span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> shrdlu-parser</span></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>  (parser</span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>   (tokens value-tokens punctuation-tokens)</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>   (start document)</span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>   (end EOF)</span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Enable error recovery</span></span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">error</span> (λ (ok? name value start-pos end-pos)</span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>            (<span class="ex">define</span><span class="fu"> pos-info</span></span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>              (format <span class="st">&quot;~a:~a-~a:~a&quot;</span></span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>                      (position-line start-pos)</span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a>                      (position-col start-pos)</span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a>                      (position-line end-pos)</span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a>                      (position-col end-pos)))</span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a>            <span class="co">;; Try to recover based on context</span></span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">cond</span></span>
<span id="cb117-32"><a href="#cb117-32" aria-hidden="true" tabindex="-1"></a>              <span class="op">[</span>(<span class="kw">and</span> (<span class="kw">eq?</span> name &#39;RBRACE)</span>
<span id="cb117-33"><a href="#cb117-33" aria-hidden="true" tabindex="-1"></a>                    (looking-for-closing-brace?))</span>
<span id="cb117-34"><a href="#cb117-34" aria-hidden="true" tabindex="-1"></a>               <span class="co">;; Insert missing closing brace</span></span>
<span id="cb117-35"><a href="#cb117-35" aria-hidden="true" tabindex="-1"></a>               (parse-error-recovery &#39;insert-brace)<span class="op">]</span></span>
<span id="cb117-36"><a href="#cb117-36" aria-hidden="true" tabindex="-1"></a>              <span class="op">[</span>(unexpected-in-text? name)</span>
<span id="cb117-37"><a href="#cb117-37" aria-hidden="true" tabindex="-1"></a>               <span class="co">;; Skip token and continue</span></span>
<span id="cb117-38"><a href="#cb117-38" aria-hidden="true" tabindex="-1"></a>               (parse-error-recovery &#39;skip)<span class="op">]</span></span>
<span id="cb117-39"><a href="#cb117-39" aria-hidden="true" tabindex="-1"></a>              <span class="op">[</span><span class="kw">else</span></span>
<span id="cb117-40"><a href="#cb117-40" aria-hidden="true" tabindex="-1"></a>               <span class="co">;; Fatal error</span></span>
<span id="cb117-41"><a href="#cb117-41" aria-hidden="true" tabindex="-1"></a>               (raise-syntax-error </span>
<span id="cb117-42"><a href="#cb117-42" aria-hidden="true" tabindex="-1"></a>                &#39;parser</span>
<span id="cb117-43"><a href="#cb117-43" aria-hidden="true" tabindex="-1"></a>                (format <span class="st">&quot;~a: Unexpected ~a&quot;</span> pos-info name))<span class="op">]</span>)))</span>
<span id="cb117-44"><a href="#cb117-44" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb117-45"><a href="#cb117-45" aria-hidden="true" tabindex="-1"></a>   (grammar</span>
<span id="cb117-46"><a href="#cb117-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; ... grammar rules as before ...</span></span>
<span id="cb117-47"><a href="#cb117-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb117-48"><a href="#cb117-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Add error recovery productions</span></span>
<span id="cb117-49"><a href="#cb117-49" aria-hidden="true" tabindex="-1"></a>    (element</span>
<span id="cb117-50"><a href="#cb117-50" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(<span class="kw">error</span> SEMICOLON)</span>
<span id="cb117-51"><a href="#cb117-51" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Recover at semicolon</span></span>
<span id="cb117-52"><a href="#cb117-52" aria-hidden="true" tabindex="-1"></a>      (make-error-node <span class="st">&quot;Recovered at semicolon&quot;</span>)<span class="op">]</span></span>
<span id="cb117-53"><a href="#cb117-53" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(<span class="kw">error</span> RBRACE)</span>
<span id="cb117-54"><a href="#cb117-54" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Recover at closing brace</span></span>
<span id="cb117-55"><a href="#cb117-55" aria-hidden="true" tabindex="-1"></a>      (make-error-node <span class="st">&quot;Recovered at brace&quot;</span>)<span class="op">]</span>))))</span>
<span id="cb117-56"><a href="#cb117-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-57"><a href="#cb117-57" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parse a string</span></span>
<span id="cb117-58"><a href="#cb117-58" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(parse-string str #:source <span class="op">[</span>source <span class="st">&quot;string&quot;</span><span class="op">]</span>)</span>
<span id="cb117-59"><a href="#cb117-59" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tokens </span>(tokenize-string str #:source source))</span>
<span id="cb117-60"><a href="#cb117-60" aria-hidden="true" tabindex="-1"></a>  (parse-tokens tokens))</span>
<span id="cb117-61"><a href="#cb117-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-62"><a href="#cb117-62" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parse a file</span></span>
<span id="cb117-63"><a href="#cb117-63" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(parse-file path)</span>
<span id="cb117-64"><a href="#cb117-64" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tokens </span>(tokenize-file path))</span>
<span id="cb117-65"><a href="#cb117-65" aria-hidden="true" tabindex="-1"></a>  (parse-tokens tokens))</span>
<span id="cb117-66"><a href="#cb117-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-67"><a href="#cb117-67" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parse a token stream</span></span>
<span id="cb117-68"><a href="#cb117-68" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(parse-tokens tokens)</span>
<span id="cb117-69"><a href="#cb117-69" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(next-token)</span>
<span id="cb117-70"><a href="#cb117-70" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (<span class="kw">null?</span> tokens)</span>
<span id="cb117-71"><a href="#cb117-71" aria-hidden="true" tabindex="-1"></a>        (position-token &#39;EOF <span class="dv">#f</span> <span class="dv">#f</span> <span class="dv">#f</span>)</span>
<span id="cb117-72"><a href="#cb117-72" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">let</span> (<span class="op">[</span>tok (<span class="kw">car</span> tokens)<span class="op">]</span>)</span>
<span id="cb117-73"><a href="#cb117-73" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">set!</span> tokens (<span class="kw">cdr</span> tokens))</span>
<span id="cb117-74"><a href="#cb117-74" aria-hidden="true" tabindex="-1"></a>          tok)))</span>
<span id="cb117-75"><a href="#cb117-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-76"><a href="#cb117-76" aria-hidden="true" tabindex="-1"></a>  (shrdlu-parser next-token))</span>
<span id="cb117-77"><a href="#cb117-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-78"><a href="#cb117-78" aria-hidden="true" tabindex="-1"></a><span class="co">;; Error recovery strategies</span></span>
<span id="cb117-79"><a href="#cb117-79" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> current-recovery-strategy </span>(make-parameter &#39;skip))</span>
<span id="cb117-80"><a href="#cb117-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-81"><a href="#cb117-81" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(parse-error-recovery strategy)</span>
<span id="cb117-82"><a href="#cb117-82" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case</span> strategy</span>
<span id="cb117-83"><a href="#cb117-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(skip)</span>
<span id="cb117-84"><a href="#cb117-84" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Skip current token and try again</span></span>
<span id="cb117-85"><a href="#cb117-85" aria-hidden="true" tabindex="-1"></a>     (void)<span class="op">]</span></span>
<span id="cb117-86"><a href="#cb117-86" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(insert-brace)</span>
<span id="cb117-87"><a href="#cb117-87" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Synthesize missing brace</span></span>
<span id="cb117-88"><a href="#cb117-88" aria-hidden="true" tabindex="-1"></a>     (position-token &#39;RBRACE <span class="dv">#f</span> <span class="dv">#f</span> <span class="dv">#f</span>)<span class="op">]</span></span>
<span id="cb117-89"><a href="#cb117-89" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(panic)</span>
<span id="cb117-90"><a href="#cb117-90" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Skip until synchronization point</span></span>
<span id="cb117-91"><a href="#cb117-91" aria-hidden="true" tabindex="-1"></a>     (skip-until-sync-token)<span class="op">]</span>))</span>
<span id="cb117-92"><a href="#cb117-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-93"><a href="#cb117-93" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(skip-until-sync-token)</span>
<span id="cb117-94"><a href="#cb117-94" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Skip tokens until we find a good synchronization point</span></span>
<span id="cb117-95"><a href="#cb117-95" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> sync-tokens </span>&#39;(SEMICOLON RBRACE EOF))</span>
<span id="cb117-96"><a href="#cb117-96" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Implementation...</span></span>
<span id="cb117-97"><a href="#cb117-97" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<h3 id="advanced-grammar-features">Advanced Grammar Features</h3>
<p>Let’s extend our grammar to handle more sophisticated constructs:</p>
<div class="sourceCode" id="cb118"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; grammar-extended.rkt</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>(require parser-tools/yacc</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;ast.rkt&quot;</span>)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Extended grammar for computational constructs</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> extended-grammar</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>  &#39;(<span class="co">;; Function definitions</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    (definition</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND:define LBRACKET IDENTIFIER parameters RBRACKET </span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>       content-block)</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>      (definition <span class="dv">#f</span> $4 $5 $7)<span class="op">]</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND:define LBRACKET IDENTIFIER RBRACKET </span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>       content-block)</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>      (definition <span class="dv">#f</span> $4 &#39;() $6)<span class="op">]</span>)</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>    (parameters</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(IDENTIFIER) (<span class="kw">list</span> $1)<span class="op">]</span></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(IDENTIFIER parameters) (<span class="kw">cons</span> $1 $2)<span class="op">]</span>)</span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Conditionals</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>    (conditional</span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND:if LBRACKET expression RBRACKET </span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>       content-block content-block)</span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>      (conditional <span class="dv">#f</span> $4 $6 $7)<span class="op">]</span></span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND:if LBRACKET expression RBRACKET </span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>       content-block)</span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>      (conditional <span class="dv">#f</span> $4 $6 &#39;())<span class="op">]</span>)</span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Loops</span></span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a>    (loop</span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND:for LBRACKET binding AT COMMAND:in </span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a>       expression RBRACKET content-block)</span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a>      (loop <span class="dv">#f</span> &#39;for (<span class="kw">list</span> $4 $8) $10)<span class="op">]</span></span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND:while LBRACKET expression RBRACKET </span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a>       content-block)</span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a>      (loop <span class="dv">#f</span> &#39;while $4 $6)<span class="op">]</span>)</span>
<span id="cb118-39"><a href="#cb118-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-40"><a href="#cb118-40" aria-hidden="true" tabindex="-1"></a>    (binding</span>
<span id="cb118-41"><a href="#cb118-41" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(IDENTIFIER) $1<span class="op">]</span></span>
<span id="cb118-42"><a href="#cb118-42" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(LPAREN IDENTIFIER IDENTIFIER RPAREN) (<span class="kw">list</span> $2 $3)<span class="op">]</span>)</span>
<span id="cb118-43"><a href="#cb118-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-44"><a href="#cb118-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Template definitions</span></span>
<span id="cb118-45"><a href="#cb118-45" aria-hidden="true" tabindex="-1"></a>    (template</span>
<span id="cb118-46"><a href="#cb118-46" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND:define-template LBRACKET IDENTIFIER </span>
<span id="cb118-47"><a href="#cb118-47" aria-hidden="true" tabindex="-1"></a>       template-params RBRACKET content-block)</span>
<span id="cb118-48"><a href="#cb118-48" aria-hidden="true" tabindex="-1"></a>      (template <span class="dv">#f</span> $4 $5 $7)<span class="op">]</span>)</span>
<span id="cb118-49"><a href="#cb118-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-50"><a href="#cb118-50" aria-hidden="true" tabindex="-1"></a>    (template-params</span>
<span id="cb118-51"><a href="#cb118-51" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(LBRACKET RBRACKET) &#39;()<span class="op">]</span></span>
<span id="cb118-52"><a href="#cb118-52" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(LBRACKET template-param-list RBRACKET) $2<span class="op">]</span>)</span>
<span id="cb118-53"><a href="#cb118-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-54"><a href="#cb118-54" aria-hidden="true" tabindex="-1"></a>    (template-param-list</span>
<span id="cb118-55"><a href="#cb118-55" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(template-param) (<span class="kw">list</span> $1)<span class="op">]</span></span>
<span id="cb118-56"><a href="#cb118-56" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(template-param template-param-list) (<span class="kw">cons</span> $1 $2)<span class="op">]</span>)</span>
<span id="cb118-57"><a href="#cb118-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-58"><a href="#cb118-58" aria-hidden="true" tabindex="-1"></a>    (template-param</span>
<span id="cb118-59"><a href="#cb118-59" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(KEYWORD IDENTIFIER) (<span class="kw">list</span> $1 $2 <span class="dv">#f</span>)<span class="op">]</span></span>
<span id="cb118-60"><a href="#cb118-60" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(KEYWORD IDENTIFIER expression) (<span class="kw">list</span> $1 $2 $3)<span class="op">]</span>)</span>
<span id="cb118-61"><a href="#cb118-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-62"><a href="#cb118-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Mathematical expressions</span></span>
<span id="cb118-63"><a href="#cb118-63" aria-hidden="true" tabindex="-1"></a>    (math-expression</span>
<span id="cb118-64"><a href="#cb118-64" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND:math content-block)</span>
<span id="cb118-65"><a href="#cb118-65" aria-hidden="true" tabindex="-1"></a>      (math <span class="dv">#f</span> <span class="dv">#t</span> $3)<span class="op">]</span></span>
<span id="cb118-66"><a href="#cb118-66" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(AT COMMAND:equation LBRACKET options RBRACKET </span>
<span id="cb118-67"><a href="#cb118-67" aria-hidden="true" tabindex="-1"></a>       content-block)</span>
<span id="cb118-68"><a href="#cb118-68" aria-hidden="true" tabindex="-1"></a>      (math <span class="dv">#f</span> <span class="dv">#t</span> $3)<span class="op">]</span>)))</span></code></pre></div>
<h2 id="implementing-the-reader">Implementing the @ Reader</h2>
<p>The @ reader is the heart of Shrdlu’s syntax. It needs to handle the
complex interplay between text and code seamlessly.</p>
<div class="sourceCode" id="cb119"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; at-reader.rkt</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>(require syntax/parse</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>         syntax/srcloc)</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>(provide read-at</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>         make-at-reader)</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; The @ reader implementation</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(read-at char port src line col pos)</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; char is #\@, which triggered this reader</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> start-loc </span>(<span class="kw">list</span> src line col pos <span class="dv">1</span>))</span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Peek at next character to determine what follows @</span></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> next-ch </span>(<span class="kw">peek-char</span> port))</span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; @@ escapes to single @</span></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">char=?</span> next-ch <span class="ch">#\@</span>)</span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">read-char</span> port)  <span class="co">; consume second @</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">datum-&gt;syntax</span> <span class="dv">#f</span> <span class="st">&quot;@&quot;</span> start-loc)<span class="op">]</span></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; @; comment form</span></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">char=?</span> next-ch <span class="ch">#\;</span>)</span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">read-char</span> port)  <span class="co">; consume ;</span></span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>     (read-comment port)</span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>     (read-at char port src line col pos)<span class="op">]</span>  <span class="co">; Try again</span></span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; @(...) s-expression</span></span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">char=?</span> next-ch <span class="ch">#\(</span>)</span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> expr </span>(<span class="kw">read</span> port))</span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">datum-&gt;syntax</span> <span class="dv">#f</span> expr start-loc)<span class="op">]</span></span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; @[...] options only</span></span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">char=?</span> next-ch <span class="ch">#\[</span>)</span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> options </span>(read-options port))</span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">datum-&gt;syntax</span> <span class="dv">#f</span> `(at-options ,@options) start-loc)<span class="op">]</span></span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; @{...} content only</span></span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">char=?</span> next-ch <span class="ch">#\{</span>)</span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> content </span>(read-content port))</span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">datum-&gt;syntax</span> <span class="dv">#f</span> `(at-content ,@content) start-loc)<span class="op">]</span></span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; @command or @command[...]{...}</span></span>
<span id="cb119-46"><a href="#cb119-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">or</span> (<span class="kw">char-alphabetic?</span> next-ch)</span>
<span id="cb119-47"><a href="#cb119-47" aria-hidden="true" tabindex="-1"></a>         (char-in? next-ch <span class="st">&quot;-_&quot;</span>))</span>
<span id="cb119-48"><a href="#cb119-48" aria-hidden="true" tabindex="-1"></a>     (read-command port start-loc)<span class="op">]</span></span>
<span id="cb119-49"><a href="#cb119-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-50"><a href="#cb119-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Just @ by itself</span></span>
<span id="cb119-51"><a href="#cb119-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb119-52"><a href="#cb119-52" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">datum-&gt;syntax</span> <span class="dv">#f</span> &#39;at start-loc)<span class="op">]</span>))</span>
<span id="cb119-53"><a href="#cb119-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-54"><a href="#cb119-54" aria-hidden="true" tabindex="-1"></a><span class="co">;; Read a command form</span></span>
<span id="cb119-55"><a href="#cb119-55" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(read-command port start-loc)</span>
<span id="cb119-56"><a href="#cb119-56" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cmd-name </span>(read-command-name port))</span>
<span id="cb119-57"><a href="#cb119-57" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> options </span>(read-optional-options port))</span>
<span id="cb119-58"><a href="#cb119-58" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> contents </span>(read-optional-contents port))</span>
<span id="cb119-59"><a href="#cb119-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-60"><a href="#cb119-60" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">datum-&gt;syntax</span> </span>
<span id="cb119-61"><a href="#cb119-61" aria-hidden="true" tabindex="-1"></a>   <span class="dv">#f</span></span>
<span id="cb119-62"><a href="#cb119-62" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">cond</span></span>
<span id="cb119-63"><a href="#cb119-63" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>(<span class="kw">and</span> options contents)</span>
<span id="cb119-64"><a href="#cb119-64" aria-hidden="true" tabindex="-1"></a>      `(,cmd-name ,@options ,@contents)<span class="op">]</span></span>
<span id="cb119-65"><a href="#cb119-65" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>options</span>
<span id="cb119-66"><a href="#cb119-66" aria-hidden="true" tabindex="-1"></a>      `(,cmd-name ,@options)<span class="op">]</span></span>
<span id="cb119-67"><a href="#cb119-67" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>contents</span>
<span id="cb119-68"><a href="#cb119-68" aria-hidden="true" tabindex="-1"></a>      `(,cmd-name ,@contents)<span class="op">]</span></span>
<span id="cb119-69"><a href="#cb119-69" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="kw">else</span></span>
<span id="cb119-70"><a href="#cb119-70" aria-hidden="true" tabindex="-1"></a>      cmd-name<span class="op">]</span>)</span>
<span id="cb119-71"><a href="#cb119-71" aria-hidden="true" tabindex="-1"></a>   start-loc))</span>
<span id="cb119-72"><a href="#cb119-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-73"><a href="#cb119-73" aria-hidden="true" tabindex="-1"></a><span class="co">;; Read command name (identifier after @)</span></span>
<span id="cb119-74"><a href="#cb119-74" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(read-command-name port)</span>
<span id="cb119-75"><a href="#cb119-75" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(valid-cmd-char? ch)</span>
<span id="cb119-76"><a href="#cb119-76" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">or</span> (<span class="kw">char-alphabetic?</span> ch)</span>
<span id="cb119-77"><a href="#cb119-77" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">char-numeric?</span> ch)</span>
<span id="cb119-78"><a href="#cb119-78" aria-hidden="true" tabindex="-1"></a>        (char-in? ch <span class="st">&quot;-_!?*+/&quot;</span>)))</span>
<span id="cb119-79"><a href="#cb119-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-80"><a href="#cb119-80" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> chars</span></span>
<span id="cb119-81"><a href="#cb119-81" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> loop (<span class="op">[</span>chars &#39;()<span class="op">]</span>)</span>
<span id="cb119-82"><a href="#cb119-82" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> ch </span>(<span class="kw">peek-char</span> port))</span>
<span id="cb119-83"><a href="#cb119-83" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">if</span> (<span class="kw">and</span> (<span class="kw">char?</span> ch) (valid-cmd-char? ch))</span>
<span id="cb119-84"><a href="#cb119-84" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">begin</span></span>
<span id="cb119-85"><a href="#cb119-85" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">read-char</span> port)</span>
<span id="cb119-86"><a href="#cb119-86" aria-hidden="true" tabindex="-1"></a>            (loop (<span class="kw">cons</span> ch chars)))</span>
<span id="cb119-87"><a href="#cb119-87" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">reverse</span> chars))))</span>
<span id="cb119-88"><a href="#cb119-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-89"><a href="#cb119-89" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">string-&gt;symbol</span> (<span class="kw">list-&gt;string</span> chars)))</span>
<span id="cb119-90"><a href="#cb119-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-91"><a href="#cb119-91" aria-hidden="true" tabindex="-1"></a><span class="co">;; Read optional [...] arguments</span></span>
<span id="cb119-92"><a href="#cb119-92" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(read-optional-options port)</span>
<span id="cb119-93"><a href="#cb119-93" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="kw">char=?</span> (<span class="kw">peek-char</span> port) <span class="ch">#\[</span>)</span>
<span id="cb119-94"><a href="#cb119-94" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">begin</span></span>
<span id="cb119-95"><a href="#cb119-95" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">read-char</span> port)  <span class="co">; consume [</span></span>
<span id="cb119-96"><a href="#cb119-96" aria-hidden="true" tabindex="-1"></a>        (read-until-bracket port))</span>
<span id="cb119-97"><a href="#cb119-97" aria-hidden="true" tabindex="-1"></a>      <span class="dv">#f</span>))</span>
<span id="cb119-98"><a href="#cb119-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-99"><a href="#cb119-99" aria-hidden="true" tabindex="-1"></a><span class="co">;; Read optional {...} content blocks  </span></span>
<span id="cb119-100"><a href="#cb119-100" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(read-optional-contents port)</span>
<span id="cb119-101"><a href="#cb119-101" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(read-one-content)</span>
<span id="cb119-102"><a href="#cb119-102" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (<span class="kw">char=?</span> (<span class="kw">peek-char</span> port) <span class="ch">#\{</span>)</span>
<span id="cb119-103"><a href="#cb119-103" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">begin</span></span>
<span id="cb119-104"><a href="#cb119-104" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">read-char</span> port)  <span class="co">; consume {</span></span>
<span id="cb119-105"><a href="#cb119-105" aria-hidden="true" tabindex="-1"></a>          (read-until-brace port))</span>
<span id="cb119-106"><a href="#cb119-106" aria-hidden="true" tabindex="-1"></a>        <span class="dv">#f</span>))</span>
<span id="cb119-107"><a href="#cb119-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-108"><a href="#cb119-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Read multiple content blocks</span></span>
<span id="cb119-109"><a href="#cb119-109" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> loop (<span class="op">[</span>contents &#39;()<span class="op">]</span>)</span>
<span id="cb119-110"><a href="#cb119-110" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> content </span>(read-one-content))</span>
<span id="cb119-111"><a href="#cb119-111" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> content</span>
<span id="cb119-112"><a href="#cb119-112" aria-hidden="true" tabindex="-1"></a>        (loop (<span class="kw">cons</span> content contents))</span>
<span id="cb119-113"><a href="#cb119-113" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">if</span> (<span class="kw">null?</span> contents)</span>
<span id="cb119-114"><a href="#cb119-114" aria-hidden="true" tabindex="-1"></a>            <span class="dv">#f</span></span>
<span id="cb119-115"><a href="#cb119-115" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">reverse</span> contents)))))</span>
<span id="cb119-116"><a href="#cb119-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-117"><a href="#cb119-117" aria-hidden="true" tabindex="-1"></a><span class="co">;; Read content until closing bracket</span></span>
<span id="cb119-118"><a href="#cb119-118" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(read-until-bracket port)</span>
<span id="cb119-119"><a href="#cb119-119" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> loop (<span class="op">[</span>depth <span class="dv">1</span><span class="op">]</span> <span class="op">[</span>acc &#39;()<span class="op">]</span>)</span>
<span id="cb119-120"><a href="#cb119-120" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> ch </span>(<span class="kw">read-char</span> port))</span>
<span id="cb119-121"><a href="#cb119-121" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb119-122"><a href="#cb119-122" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">eof-object?</span> ch)</span>
<span id="cb119-123"><a href="#cb119-123" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">error</span> &#39;read-at <span class="st">&quot;Unexpected EOF in brackets&quot;</span>)<span class="op">]</span></span>
<span id="cb119-124"><a href="#cb119-124" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">char=?</span> ch <span class="ch">#\[</span>)</span>
<span id="cb119-125"><a href="#cb119-125" aria-hidden="true" tabindex="-1"></a>       (loop (<span class="op">+</span> depth <span class="dv">1</span>) (<span class="kw">cons</span> ch acc))<span class="op">]</span></span>
<span id="cb119-126"><a href="#cb119-126" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">char=?</span> ch <span class="ch">#\]</span>)</span>
<span id="cb119-127"><a href="#cb119-127" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">if</span> (<span class="op">=</span> depth <span class="dv">1</span>)</span>
<span id="cb119-128"><a href="#cb119-128" aria-hidden="true" tabindex="-1"></a>           (parse-bracket-content (<span class="kw">reverse</span> acc))</span>
<span id="cb119-129"><a href="#cb119-129" aria-hidden="true" tabindex="-1"></a>           (loop (<span class="op">-</span> depth <span class="dv">1</span>) (<span class="kw">cons</span> ch acc)))<span class="op">]</span></span>
<span id="cb119-130"><a href="#cb119-130" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb119-131"><a href="#cb119-131" aria-hidden="true" tabindex="-1"></a>       (loop depth (<span class="kw">cons</span> ch acc))<span class="op">]</span>)))</span>
<span id="cb119-132"><a href="#cb119-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-133"><a href="#cb119-133" aria-hidden="true" tabindex="-1"></a><span class="co">;; Read content until closing brace with @ processing</span></span>
<span id="cb119-134"><a href="#cb119-134" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(read-until-brace port)</span>
<span id="cb119-135"><a href="#cb119-135" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> loop (<span class="op">[</span>depth <span class="dv">1</span><span class="op">]</span> <span class="op">[</span>acc &#39;()<span class="op">]</span> <span class="op">[</span>text-acc &#39;()<span class="op">]</span>)</span>
<span id="cb119-136"><a href="#cb119-136" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> ch </span>(<span class="kw">read-char</span> port))</span>
<span id="cb119-137"><a href="#cb119-137" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb119-138"><a href="#cb119-138" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">eof-object?</span> ch)</span>
<span id="cb119-139"><a href="#cb119-139" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">error</span> &#39;read-at <span class="st">&quot;Unexpected EOF in braces&quot;</span>)<span class="op">]</span></span>
<span id="cb119-140"><a href="#cb119-140" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb119-141"><a href="#cb119-141" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">char=?</span> ch <span class="ch">#\@</span>)</span>
<span id="cb119-142"><a href="#cb119-142" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Process accumulated text first</span></span>
<span id="cb119-143"><a href="#cb119-143" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> text-part </span></span>
<span id="cb119-144"><a href="#cb119-144" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">if</span> (<span class="kw">null?</span> text-acc)</span>
<span id="cb119-145"><a href="#cb119-145" aria-hidden="true" tabindex="-1"></a>             &#39;()</span>
<span id="cb119-146"><a href="#cb119-146" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">list</span> (<span class="kw">list-&gt;string</span> (<span class="kw">reverse</span> text-acc)))))</span>
<span id="cb119-147"><a href="#cb119-147" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Read @ form</span></span>
<span id="cb119-148"><a href="#cb119-148" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> at-form </span>(read-at ch port <span class="dv">#f</span> <span class="dv">#f</span> <span class="dv">#f</span> <span class="dv">#f</span>))</span>
<span id="cb119-149"><a href="#cb119-149" aria-hidden="true" tabindex="-1"></a>       (loop depth </span>
<span id="cb119-150"><a href="#cb119-150" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">append</span> text-part (<span class="kw">list</span> at-form) acc)</span>
<span id="cb119-151"><a href="#cb119-151" aria-hidden="true" tabindex="-1"></a>             &#39;())<span class="op">]</span></span>
<span id="cb119-152"><a href="#cb119-152" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb119-153"><a href="#cb119-153" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">char=?</span> ch <span class="ch">#\{</span>)</span>
<span id="cb119-154"><a href="#cb119-154" aria-hidden="true" tabindex="-1"></a>       (loop (<span class="op">+</span> depth <span class="dv">1</span>) acc (<span class="kw">cons</span> ch text-acc))<span class="op">]</span></span>
<span id="cb119-155"><a href="#cb119-155" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb119-156"><a href="#cb119-156" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">char=?</span> ch <span class="ch">#\}</span>)</span>
<span id="cb119-157"><a href="#cb119-157" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">if</span> (<span class="op">=</span> depth <span class="dv">1</span>)</span>
<span id="cb119-158"><a href="#cb119-158" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; Done - process final text</span></span>
<span id="cb119-159"><a href="#cb119-159" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">let</span> (<span class="op">[</span>final-text</span>
<span id="cb119-160"><a href="#cb119-160" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">if</span> (<span class="kw">null?</span> text-acc)</span>
<span id="cb119-161"><a href="#cb119-161" aria-hidden="true" tabindex="-1"></a>                      acc</span>
<span id="cb119-162"><a href="#cb119-162" aria-hidden="true" tabindex="-1"></a>                      (<span class="kw">append</span> acc </span>
<span id="cb119-163"><a href="#cb119-163" aria-hidden="true" tabindex="-1"></a>                              (<span class="kw">list</span> (<span class="kw">list-&gt;string</span> </span>
<span id="cb119-164"><a href="#cb119-164" aria-hidden="true" tabindex="-1"></a>                                     (<span class="kw">reverse</span> text-acc)))))<span class="op">]</span>)</span>
<span id="cb119-165"><a href="#cb119-165" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">reverse</span> final-text))</span>
<span id="cb119-166"><a href="#cb119-166" aria-hidden="true" tabindex="-1"></a>           (loop (<span class="op">-</span> depth <span class="dv">1</span>) acc (<span class="kw">cons</span> ch text-acc)))<span class="op">]</span></span>
<span id="cb119-167"><a href="#cb119-167" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb119-168"><a href="#cb119-168" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb119-169"><a href="#cb119-169" aria-hidden="true" tabindex="-1"></a>       (loop depth acc (<span class="kw">cons</span> ch text-acc))<span class="op">]</span>)))</span>
<span id="cb119-170"><a href="#cb119-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-171"><a href="#cb119-171" aria-hidden="true" tabindex="-1"></a><span class="co">;; Helper to check if char is in a string</span></span>
<span id="cb119-172"><a href="#cb119-172" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(char-in? ch str)</span>
<span id="cb119-173"><a href="#cb119-173" aria-hidden="true" tabindex="-1"></a>  (string-contains? str (<span class="kw">string</span> ch)))</span>
<span id="cb119-174"><a href="#cb119-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-175"><a href="#cb119-175" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create a readtable with @ support</span></span>
<span id="cb119-176"><a href="#cb119-176" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-at-readtable)</span>
<span id="cb119-177"><a href="#cb119-177" aria-hidden="true" tabindex="-1"></a>  (make-readtable (current-readtable)</span>
<span id="cb119-178"><a href="#cb119-178" aria-hidden="true" tabindex="-1"></a>                  <span class="ch">#\@</span> &#39;terminating-macro read-at))</span>
<span id="cb119-179"><a href="#cb119-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-180"><a href="#cb119-180" aria-hidden="true" tabindex="-1"></a><span class="co">;; Module reader for #lang shrdlu</span></span>
<span id="cb119-181"><a href="#cb119-181" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-at-reader)</span>
<span id="cb119-182"><a href="#cb119-182" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> at-readtable </span>(make-at-readtable))</span>
<span id="cb119-183"><a href="#cb119-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-184"><a href="#cb119-184" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case-lambda</span></span>
<span id="cb119-185"><a href="#cb119-185" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; read</span></span>
<span id="cb119-186"><a href="#cb119-186" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(port)</span>
<span id="cb119-187"><a href="#cb119-187" aria-hidden="true" tabindex="-1"></a>     (parameterize (<span class="op">[</span>current-readtable at-readtable<span class="op">]</span>)</span>
<span id="cb119-188"><a href="#cb119-188" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">read</span> port))<span class="op">]</span></span>
<span id="cb119-189"><a href="#cb119-189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-190"><a href="#cb119-190" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; read-syntax</span></span>
<span id="cb119-191"><a href="#cb119-191" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(source port)</span>
<span id="cb119-192"><a href="#cb119-192" aria-hidden="true" tabindex="-1"></a>     (parameterize (<span class="op">[</span>current-readtable at-readtable<span class="op">]</span>)</span>
<span id="cb119-193"><a href="#cb119-193" aria-hidden="true" tabindex="-1"></a>       (read-syntax source port))<span class="op">]</span>))</span></code></pre></div>
<h3 id="location-tracking-and-error-reporting">Location Tracking and
Error Reporting</h3>
<p>Accurate source locations are crucial for good error messages:</p>
<div class="sourceCode" id="cb120"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; location-tracking.rkt</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>(require syntax/srcloc)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>(provide (struct-out source-span)</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>         make-location-tracker</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>         location-&gt;syntax</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>         format-source-location)</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Source span information</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>(struct source-span </span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>  (source    <span class="co">; file name or &#39;string</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>   line-start</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>   col-start</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>   pos-start</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>   line-end</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>   col-end</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>   pos-end)</span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a><span class="co">;; Location tracker for parser</span></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>(struct location-tracker </span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>  (<span class="op">[</span>line #:mutable<span class="op">]</span></span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>column #:mutable<span class="op">]</span></span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>position #:mutable<span class="op">]</span></span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>   source)</span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-location-tracker source)</span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a>  (location-tracker <span class="dv">1</span> <span class="dv">0</span> <span class="dv">0</span> source))</span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-33"><a href="#cb120-33" aria-hidden="true" tabindex="-1"></a><span class="co">;; Update tracker based on consumed text</span></span>
<span id="cb120-34"><a href="#cb120-34" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(update-location! tracker text)</span>
<span id="cb120-35"><a href="#cb120-35" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>ch (in-string text)<span class="op">]</span>)</span>
<span id="cb120-36"><a href="#cb120-36" aria-hidden="true" tabindex="-1"></a>    (set-location-tracker-position! </span>
<span id="cb120-37"><a href="#cb120-37" aria-hidden="true" tabindex="-1"></a>     tracker </span>
<span id="cb120-38"><a href="#cb120-38" aria-hidden="true" tabindex="-1"></a>     (add1 (location-tracker-position tracker)))</span>
<span id="cb120-39"><a href="#cb120-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-40"><a href="#cb120-40" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb120-41"><a href="#cb120-41" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">char=?</span> ch <span class="ch">#\</span><span class="er">newline</span>)</span>
<span id="cb120-42"><a href="#cb120-42" aria-hidden="true" tabindex="-1"></a>       (set-location-tracker-line!</span>
<span id="cb120-43"><a href="#cb120-43" aria-hidden="true" tabindex="-1"></a>        tracker</span>
<span id="cb120-44"><a href="#cb120-44" aria-hidden="true" tabindex="-1"></a>        (add1 (location-tracker-line tracker)))</span>
<span id="cb120-45"><a href="#cb120-45" aria-hidden="true" tabindex="-1"></a>       (set-location-tracker-column! tracker <span class="dv">0</span>)<span class="op">]</span></span>
<span id="cb120-46"><a href="#cb120-46" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb120-47"><a href="#cb120-47" aria-hidden="true" tabindex="-1"></a>       (set-location-tracker-column!</span>
<span id="cb120-48"><a href="#cb120-48" aria-hidden="true" tabindex="-1"></a>        tracker</span>
<span id="cb120-49"><a href="#cb120-49" aria-hidden="true" tabindex="-1"></a>        (add1 (location-tracker-column tracker)))<span class="op">]</span>)))</span>
<span id="cb120-50"><a href="#cb120-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-51"><a href="#cb120-51" aria-hidden="true" tabindex="-1"></a><span class="co">;; Convert location to syntax object</span></span>
<span id="cb120-52"><a href="#cb120-52" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(location-&gt;syntax loc datum)</span>
<span id="cb120-53"><a href="#cb120-53" aria-hidden="true" tabindex="-1"></a>  (match loc</span>
<span id="cb120-54"><a href="#cb120-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(source-span src ls cs ps le ce pe)</span>
<span id="cb120-55"><a href="#cb120-55" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">datum-&gt;syntax</span> <span class="dv">#f</span> </span>
<span id="cb120-56"><a href="#cb120-56" aria-hidden="true" tabindex="-1"></a>                    datum</span>
<span id="cb120-57"><a href="#cb120-57" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">list</span> src ls cs ps (<span class="op">-</span> pe ps)))<span class="op">]</span></span>
<span id="cb120-58"><a href="#cb120-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb120-59"><a href="#cb120-59" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">datum-&gt;syntax</span> <span class="dv">#f</span> datum)<span class="op">]</span>))</span>
<span id="cb120-60"><a href="#cb120-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-61"><a href="#cb120-61" aria-hidden="true" tabindex="-1"></a><span class="co">;; Format location for error messages</span></span>
<span id="cb120-62"><a href="#cb120-62" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(format-source-location loc)</span>
<span id="cb120-63"><a href="#cb120-63" aria-hidden="true" tabindex="-1"></a>  (match loc</span>
<span id="cb120-64"><a href="#cb120-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(source-span src ls cs <span class="op">_</span> le ce <span class="op">_</span>)</span>
<span id="cb120-65"><a href="#cb120-65" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> (<span class="kw">and</span> (<span class="op">=</span> ls le) (<span class="op">=</span> cs ce))</span>
<span id="cb120-66"><a href="#cb120-66" aria-hidden="true" tabindex="-1"></a>         (format <span class="st">&quot;~a:~a:~a&quot;</span> src ls cs)</span>
<span id="cb120-67"><a href="#cb120-67" aria-hidden="true" tabindex="-1"></a>         (format <span class="st">&quot;~a:~a:~a-~a:~a&quot;</span> src ls cs le ce))<span class="op">]</span></span>
<span id="cb120-68"><a href="#cb120-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> <span class="st">&quot;unknown location&quot;</span><span class="op">]</span>))</span>
<span id="cb120-69"><a href="#cb120-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-70"><a href="#cb120-70" aria-hidden="true" tabindex="-1"></a><span class="co">;; Enhanced error reporting</span></span>
<span id="cb120-71"><a href="#cb120-71" aria-hidden="true" tabindex="-1"></a>(struct parse-error exn:fail (location)</span>
<span id="cb120-72"><a href="#cb120-72" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb120-73"><a href="#cb120-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-74"><a href="#cb120-74" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(raise-parse-error message location)</span>
<span id="cb120-75"><a href="#cb120-75" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">raise</span> (parse-error</span>
<span id="cb120-76"><a href="#cb120-76" aria-hidden="true" tabindex="-1"></a>          (format <span class="st">&quot;~a: ~a&quot;</span></span>
<span id="cb120-77"><a href="#cb120-77" aria-hidden="true" tabindex="-1"></a>                  (format-source-location location)</span>
<span id="cb120-78"><a href="#cb120-78" aria-hidden="true" tabindex="-1"></a>                  message)</span>
<span id="cb120-79"><a href="#cb120-79" aria-hidden="true" tabindex="-1"></a>          (current-continuation-marks)</span>
<span id="cb120-80"><a href="#cb120-80" aria-hidden="true" tabindex="-1"></a>          location)))</span></code></pre></div>
<h2 id="testing-the-lexer-and-parser">Testing the Lexer and Parser</h2>
<p>Comprehensive testing ensures our language processor works
correctly:</p>
<div class="sourceCode" id="cb121"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; test-lexer-parser.rkt</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>(require rackunit</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;lexer.rkt&quot;</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;parser.rkt&quot;</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;ast.rkt&quot;</span>)</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Lexer tests</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Lexer: Basic tokens&quot;</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tokens </span>(tokenize-string <span class="st">&quot;@command[opt]{text}&quot;</span>))</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> tokens) <span class="dv">6</span>)</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>  (check-equal? (position-token-token (first tokens)) </span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>                (token-COMMAND <span class="st">&quot;command&quot;</span>)))</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Lexer: String escapes&quot;</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tokens </span>(tokenize-string <span class="st">&quot;</span><span class="ch">\&quot;</span><span class="st">hello</span><span class="ch">\\</span><span class="st">nworld</span><span class="ch">\&quot;</span><span class="st">&quot;</span>))</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>  (check-equal? (position-token-token (first tokens))</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>                (token-STRING <span class="st">&quot;hello</span><span class="ch">\n</span><span class="st">world&quot;</span>)))</span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Lexer: Numbers&quot;</span></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tokens </span>(tokenize-string <span class="st">&quot;42 3.14 -2.5e10&quot;</span>))</span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>  (check-equal? (map position-token-token tokens)</span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a>                (<span class="kw">list</span> (token-NUMBER <span class="dv">42</span>)</span>
<span id="cb121-25"><a href="#cb121-25" aria-hidden="true" tabindex="-1"></a>                      (token-NUMBER <span class="fl">3.14</span>)</span>
<span id="cb121-26"><a href="#cb121-26" aria-hidden="true" tabindex="-1"></a>                      (token-NUMBER -<span class="fl">2.5e10</span>))))</span>
<span id="cb121-27"><a href="#cb121-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-28"><a href="#cb121-28" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Lexer: Keywords&quot;</span></span>
<span id="cb121-29"><a href="#cb121-29" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tokens </span>(tokenize-string <span class="st">&quot;#:key #:another-key&quot;</span>))</span>
<span id="cb121-30"><a href="#cb121-30" aria-hidden="true" tabindex="-1"></a>  (check-equal? (map position-token-token tokens)</span>
<span id="cb121-31"><a href="#cb121-31" aria-hidden="true" tabindex="-1"></a>                (<span class="kw">list</span> (token-KEYWORD &#39;key)</span>
<span id="cb121-32"><a href="#cb121-32" aria-hidden="true" tabindex="-1"></a>                      (token-KEYWORD &#39;another-key))))</span>
<span id="cb121-33"><a href="#cb121-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-34"><a href="#cb121-34" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parser tests</span></span>
<span id="cb121-35"><a href="#cb121-35" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Parser: Simple document&quot;</span></span>
<span id="cb121-36"><a href="#cb121-36" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ast </span>(parse-string <span class="st">&quot;@section{Title} Hello world&quot;</span>))</span>
<span id="cb121-37"><a href="#cb121-37" aria-hidden="true" tabindex="-1"></a>  (check-true (document? ast))</span>
<span id="cb121-38"><a href="#cb121-38" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> (document-content ast)) <span class="dv">2</span>))</span>
<span id="cb121-39"><a href="#cb121-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-40"><a href="#cb121-40" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Parser: Nested structure&quot;</span></span>
<span id="cb121-41"><a href="#cb121-41" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ast </span>(parse-string </span>
<span id="cb121-42"><a href="#cb121-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;@section{Intro} @p{Text with @em{emphasis}}&quot;</span>))</span>
<span id="cb121-43"><a href="#cb121-43" aria-hidden="true" tabindex="-1"></a>  (match ast</span>
<span id="cb121-44"><a href="#cb121-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(document <span class="op">_</span> <span class="op">_</span> content)</span>
<span id="cb121-45"><a href="#cb121-45" aria-hidden="true" tabindex="-1"></a>     (match (first content)</span>
<span id="cb121-46"><a href="#cb121-46" aria-hidden="true" tabindex="-1"></a>       <span class="op">[</span>(command <span class="op">_</span> &#39;section <span class="op">_</span> (<span class="kw">list</span> title))</span>
<span id="cb121-47"><a href="#cb121-47" aria-hidden="true" tabindex="-1"></a>        (check-equal? title <span class="st">&quot;Intro&quot;</span>)<span class="op">]</span></span>
<span id="cb121-48"><a href="#cb121-48" aria-hidden="true" tabindex="-1"></a>       <span class="op">[</span><span class="kw">else</span> (fail <span class="st">&quot;Expected section&quot;</span>)<span class="op">]</span>)<span class="op">]</span>))</span>
<span id="cb121-49"><a href="#cb121-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-50"><a href="#cb121-50" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Parser: Function definition&quot;</span></span>
<span id="cb121-51"><a href="#cb121-51" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ast </span>(parse-string</span>
<span id="cb121-52"><a href="#cb121-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;@define[square x]{@* [x x]}&quot;</span>))</span>
<span id="cb121-53"><a href="#cb121-53" aria-hidden="true" tabindex="-1"></a>  (match ast</span>
<span id="cb121-54"><a href="#cb121-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(document <span class="op">_</span> <span class="op">_</span> (<span class="kw">list</span> def))</span>
<span id="cb121-55"><a href="#cb121-55" aria-hidden="true" tabindex="-1"></a>     (check-true (definition? def))</span>
<span id="cb121-56"><a href="#cb121-56" aria-hidden="true" tabindex="-1"></a>     (check-equal? (definition-name def) &#39;square)</span>
<span id="cb121-57"><a href="#cb121-57" aria-hidden="true" tabindex="-1"></a>     (check-equal? (definition-params def) &#39;(x))<span class="op">]</span>))</span>
<span id="cb121-58"><a href="#cb121-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-59"><a href="#cb121-59" aria-hidden="true" tabindex="-1"></a><span class="co">;; Error handling tests</span></span>
<span id="cb121-60"><a href="#cb121-60" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Parser: Error recovery&quot;</span></span>
<span id="cb121-61"><a href="#cb121-61" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ast </span>(parse-string <span class="st">&quot;@section{Unclosed&quot;</span>))</span>
<span id="cb121-62"><a href="#cb121-62" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Should recover and produce partial AST</span></span>
<span id="cb121-63"><a href="#cb121-63" aria-hidden="true" tabindex="-1"></a>  (check-true (document? ast)))</span>
<span id="cb121-64"><a href="#cb121-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-65"><a href="#cb121-65" aria-hidden="true" tabindex="-1"></a><span class="co">;; Property-based testing</span></span>
<span id="cb121-66"><a href="#cb121-66" aria-hidden="true" tabindex="-1"></a>(require quickcheck)</span>
<span id="cb121-67"><a href="#cb121-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-68"><a href="#cb121-68" aria-hidden="true" tabindex="-1"></a>(define-property lexer-parser-roundtrip</span>
<span id="cb121-69"><a href="#cb121-69" aria-hidden="true" tabindex="-1"></a>  (<span class="op">[</span>text (gen:string gen:char-alphanumeric)<span class="op">]</span>)</span>
<span id="cb121-70"><a href="#cb121-70" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tokens </span>(tokenize-string text))</span>
<span id="cb121-71"><a href="#cb121-71" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ast </span>(parse-tokens tokens))</span>
<span id="cb121-72"><a href="#cb121-72" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Property: lexing and parsing should not crash</span></span>
<span id="cb121-73"><a href="#cb121-73" aria-hidden="true" tabindex="-1"></a>  (check-true (<span class="kw">or</span> (document? ast) (error-node? ast))))</span>
<span id="cb121-74"><a href="#cb121-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-75"><a href="#cb121-75" aria-hidden="true" tabindex="-1"></a><span class="co">;; Performance benchmarks</span></span>
<span id="cb121-76"><a href="#cb121-76" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(benchmark-lexer size)</span>
<span id="cb121-77"><a href="#cb121-77" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> text </span>(<span class="kw">make-string</span> size <span class="ch">#\a</span>))</span>
<span id="cb121-78"><a href="#cb121-78" aria-hidden="true" tabindex="-1"></a>  (time (tokenize-string text)))</span>
<span id="cb121-79"><a href="#cb121-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-80"><a href="#cb121-80" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(benchmark-parser depth)</span>
<span id="cb121-81"><a href="#cb121-81" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> text </span></span>
<span id="cb121-82"><a href="#cb121-82" aria-hidden="true" tabindex="-1"></a>    (string-append* </span>
<span id="cb121-83"><a href="#cb121-83" aria-hidden="true" tabindex="-1"></a>     (for/list (<span class="op">[</span>i depth<span class="op">]</span>) </span>
<span id="cb121-84"><a href="#cb121-84" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;@section{@subsection{&quot;</span>)))</span>
<span id="cb121-85"><a href="#cb121-85" aria-hidden="true" tabindex="-1"></a>  (time (parse-string text)))</span></code></pre></div>
<h3 id="integration-tests">Integration Tests</h3>
<p>Testing the complete pipeline:</p>
<div class="sourceCode" id="cb122"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; test-integration.rkt</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>(require rackunit</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;lexer.rkt&quot;</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;parser.rkt&quot;</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;ast.rkt&quot;</span>)</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> test-documents</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>  &#39;(<span class="co">;; Technical blog post</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@document[#:title </span><span class="ch">\&quot;</span><span class="st">Parser Combinators</span><span class="ch">\&quot;</span><span class="st">]{</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a><span class="st">      @section{Introduction}</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a><span class="st">      Parser combinators are @em{functions} that...</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a><span class="st">      @code[#:lang </span><span class="ch">\&quot;</span><span class="st">racket</span><span class="ch">\&quot;</span><span class="st">]{</span></span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a><span class="st">        (define (many p)</span></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a><span class="st">          (alt (seq p (many p))</span></span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a><span class="st">               (pure &#39;())))</span></span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a><span class="st">    }&quot;</span></span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Academic paper</span></span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@document[</span></span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true" tabindex="-1"></a><span class="st">      #:class </span><span class="ch">\&quot;</span><span class="st">article</span><span class="ch">\&quot;</span></span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true" tabindex="-1"></a><span class="st">      #:author </span><span class="ch">\&quot;</span><span class="st">Jane Doe</span><span class="ch">\&quot;</span></span>
<span id="cb122-26"><a href="#cb122-26" aria-hidden="true" tabindex="-1"></a><span class="st">    ]{</span></span>
<span id="cb122-27"><a href="#cb122-27" aria-hidden="true" tabindex="-1"></a><span class="st">      @abstract{We present a new approach...}</span></span>
<span id="cb122-28"><a href="#cb122-28" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb122-29"><a href="#cb122-29" aria-hidden="true" tabindex="-1"></a><span class="st">      @section[#:label </span><span class="ch">\&quot;</span><span class="st">intro</span><span class="ch">\&quot;</span><span class="st">]{Introduction}</span></span>
<span id="cb122-30"><a href="#cb122-30" aria-hidden="true" tabindex="-1"></a><span class="st">      As shown by @cite[smith2020], the problem...</span></span>
<span id="cb122-31"><a href="#cb122-31" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb122-32"><a href="#cb122-32" aria-hidden="true" tabindex="-1"></a><span class="st">      @theorem[#:label </span><span class="ch">\&quot;</span><span class="st">main</span><span class="ch">\&quot;</span><span class="st">]{</span></span>
<span id="cb122-33"><a href="#cb122-33" aria-hidden="true" tabindex="-1"></a><span class="st">        For all @math{x ∈ ℝ}, we have @math{x² ≥ 0}.</span></span>
<span id="cb122-34"><a href="#cb122-34" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb122-35"><a href="#cb122-35" aria-hidden="true" tabindex="-1"></a><span class="st">    }&quot;</span></span>
<span id="cb122-36"><a href="#cb122-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-37"><a href="#cb122-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Computational document</span></span>
<span id="cb122-38"><a href="#cb122-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@document{</span></span>
<span id="cb122-39"><a href="#cb122-39" aria-hidden="true" tabindex="-1"></a><span class="st">      @define[fib n]{</span></span>
<span id="cb122-40"><a href="#cb122-40" aria-hidden="true" tabindex="-1"></a><span class="st">        @if[@&lt; [n 2]]{n}{</span></span>
<span id="cb122-41"><a href="#cb122-41" aria-hidden="true" tabindex="-1"></a><span class="st">          @+ [@fib[@- [n 1]]] [@fib[@- [n 2]]]</span></span>
<span id="cb122-42"><a href="#cb122-42" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb122-43"><a href="#cb122-43" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb122-44"><a href="#cb122-44" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb122-45"><a href="#cb122-45" aria-hidden="true" tabindex="-1"></a><span class="st">      The 10th Fibonacci number is @fib[10].</span></span>
<span id="cb122-46"><a href="#cb122-46" aria-hidden="true" tabindex="-1"></a><span class="st">      </span></span>
<span id="cb122-47"><a href="#cb122-47" aria-hidden="true" tabindex="-1"></a><span class="st">      @for[i @in [@range[1 11]]]{</span></span>
<span id="cb122-48"><a href="#cb122-48" aria-hidden="true" tabindex="-1"></a><span class="st">        F_@i = @fib[@i]@br{}</span></span>
<span id="cb122-49"><a href="#cb122-49" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb122-50"><a href="#cb122-50" aria-hidden="true" tabindex="-1"></a><span class="st">    }&quot;</span>))</span>
<span id="cb122-51"><a href="#cb122-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-52"><a href="#cb122-52" aria-hidden="true" tabindex="-1"></a>(for (<span class="op">[</span>doc test-documents<span class="op">]</span></span>
<span id="cb122-53"><a href="#cb122-53" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>idx (in-naturals)<span class="op">]</span>)</span>
<span id="cb122-54"><a href="#cb122-54" aria-hidden="true" tabindex="-1"></a>  (test-case (format <span class="st">&quot;Integration test ~a&quot;</span> idx)</span>
<span id="cb122-55"><a href="#cb122-55" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> ast </span>(parse-string doc))</span>
<span id="cb122-56"><a href="#cb122-56" aria-hidden="true" tabindex="-1"></a>    (check-true (document? ast))</span>
<span id="cb122-57"><a href="#cb122-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Verify structure</span></span>
<span id="cb122-58"><a href="#cb122-58" aria-hidden="true" tabindex="-1"></a>    (check-true (<span class="kw">list?</span> (document-content ast)))</span>
<span id="cb122-59"><a href="#cb122-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Could walk AST and verify specific properties</span></span>
<span id="cb122-60"><a href="#cb122-60" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb122-61"><a href="#cb122-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-62"><a href="#cb122-62" aria-hidden="true" tabindex="-1"></a><span class="co">;; Test error messages</span></span>
<span id="cb122-63"><a href="#cb122-63" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> error-cases</span></span>
<span id="cb122-64"><a href="#cb122-64" aria-hidden="true" tabindex="-1"></a>  &#39;((<span class="st">&quot;@section&quot;</span> <span class="st">&quot;Missing content block&quot;</span>)</span>
<span id="cb122-65"><a href="#cb122-65" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;@define[f]{&quot;</span> <span class="st">&quot;Unclosed brace&quot;</span>)</span>
<span id="cb122-66"><a href="#cb122-66" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;@if[&quot;</span> <span class="st">&quot;Unclosed bracket&quot;</span>)</span>
<span id="cb122-67"><a href="#cb122-67" aria-hidden="true" tabindex="-1"></a>    (<span class="st">&quot;@unknown-command&quot;</span> <span class="st">&quot;Should parse as command&quot;</span>)))</span>
<span id="cb122-68"><a href="#cb122-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-69"><a href="#cb122-69" aria-hidden="true" tabindex="-1"></a>(for (<span class="op">[</span><span class="kw">case</span> error-cases<span class="op">]</span>)</span>
<span id="cb122-70"><a href="#cb122-70" aria-hidden="true" tabindex="-1"></a>  (match-define (<span class="kw">list</span> input description) <span class="kw">case</span>)</span>
<span id="cb122-71"><a href="#cb122-71" aria-hidden="true" tabindex="-1"></a>  (test-case (format <span class="st">&quot;Error case: ~a&quot;</span> description)</span>
<span id="cb122-72"><a href="#cb122-72" aria-hidden="true" tabindex="-1"></a>    (with-handlers (<span class="op">[</span>exn:fail? (λ (e) (check-true <span class="dv">#t</span>))<span class="op">]</span>)</span>
<span id="cb122-73"><a href="#cb122-73" aria-hidden="true" tabindex="-1"></a>      (parse-string input)</span>
<span id="cb122-74"><a href="#cb122-74" aria-hidden="true" tabindex="-1"></a>      (fail <span class="st">&quot;Should have raised error&quot;</span>))))</span></code></pre></div>
<h2 id="performance-optimization">Performance Optimization</h2>
<p>Let’s optimize our lexer and parser for real-world use:</p>
<div class="sourceCode" id="cb123"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; optimization.rkt</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>(require racket/unsafe/ops</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>         ffi/unsafe)</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Optimized string building</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>(struct string-builder (<span class="op">[</span>chars #:mutable<span class="op">]</span> <span class="op">[</span>size #:mutable<span class="op">]</span>))</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-string-builder <span class="op">[</span>initial-capacity <span class="dv">256</span><span class="op">]</span>)</span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>  (string-builder (<span class="kw">make-vector</span> initial-capacity <span class="ch">#\</span><span class="er">null</span>) <span class="dv">0</span>))</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(string-builder-append! sb ch)</span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> chars </span>(string-builder-chars sb))</span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> size </span>(string-builder-size sb))</span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>  (when (<span class="op">&gt;=</span> size (<span class="kw">vector-length</span> chars))</span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Grow buffer</span></span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> new-chars </span>(<span class="kw">make-vector</span> (<span class="op">*</span> <span class="dv">2</span> (<span class="kw">vector-length</span> chars))))</span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>    (vector-copy! new-chars <span class="dv">0</span> chars)</span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a>    (set-string-builder-chars! sb new-chars))</span>
<span id="cb123-22"><a href="#cb123-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-23"><a href="#cb123-23" aria-hidden="true" tabindex="-1"></a>  (unsafe-vector-set! chars size ch)</span>
<span id="cb123-24"><a href="#cb123-24" aria-hidden="true" tabindex="-1"></a>  (set-string-builder-size! sb (unsafe-fx+ size <span class="dv">1</span>)))</span>
<span id="cb123-25"><a href="#cb123-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-26"><a href="#cb123-26" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(string-builder-&gt;string sb)</span>
<span id="cb123-27"><a href="#cb123-27" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> size </span>(string-builder-size sb))</span>
<span id="cb123-28"><a href="#cb123-28" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> str </span>(<span class="kw">make-string</span> size))</span>
<span id="cb123-29"><a href="#cb123-29" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>i (in-range size)<span class="op">]</span>)</span>
<span id="cb123-30"><a href="#cb123-30" aria-hidden="true" tabindex="-1"></a>    (unsafe-string-set! </span>
<span id="cb123-31"><a href="#cb123-31" aria-hidden="true" tabindex="-1"></a>     str i </span>
<span id="cb123-32"><a href="#cb123-32" aria-hidden="true" tabindex="-1"></a>     (unsafe-vector-ref (string-builder-chars sb) i)))</span>
<span id="cb123-33"><a href="#cb123-33" aria-hidden="true" tabindex="-1"></a>  str)</span>
<span id="cb123-34"><a href="#cb123-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-35"><a href="#cb123-35" aria-hidden="true" tabindex="-1"></a><span class="co">;; Optimized lexer with buffering</span></span>
<span id="cb123-36"><a href="#cb123-36" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-buffered-lexer port <span class="op">[</span>buffer-size <span class="dv">4096</span><span class="op">]</span>)</span>
<span id="cb123-37"><a href="#cb123-37" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> buffer </span>(<span class="kw">make-string</span> buffer-size))</span>
<span id="cb123-38"><a href="#cb123-38" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> buffer-pos </span><span class="dv">0</span>)</span>
<span id="cb123-39"><a href="#cb123-39" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> buffer-end </span><span class="dv">0</span>)</span>
<span id="cb123-40"><a href="#cb123-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-41"><a href="#cb123-41" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(refill-buffer!)</span>
<span id="cb123-42"><a href="#cb123-42" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> n </span>(read-string! buffer port))</span>
<span id="cb123-43"><a href="#cb123-43" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">set!</span> buffer-pos <span class="dv">0</span>)</span>
<span id="cb123-44"><a href="#cb123-44" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">set!</span> buffer-end (<span class="kw">or</span> n <span class="dv">0</span>))</span>
<span id="cb123-45"><a href="#cb123-45" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">not</span> (<span class="kw">zero?</span> buffer-end)))</span>
<span id="cb123-46"><a href="#cb123-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-47"><a href="#cb123-47" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(peek-char-fast)</span>
<span id="cb123-48"><a href="#cb123-48" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (<span class="op">&lt;</span> buffer-pos buffer-end)</span>
<span id="cb123-49"><a href="#cb123-49" aria-hidden="true" tabindex="-1"></a>        (unsafe-string-ref buffer buffer-pos)</span>
<span id="cb123-50"><a href="#cb123-50" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">and</span> (refill-buffer!)</span>
<span id="cb123-51"><a href="#cb123-51" aria-hidden="true" tabindex="-1"></a>             (unsafe-string-ref buffer buffer-pos))))</span>
<span id="cb123-52"><a href="#cb123-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-53"><a href="#cb123-53" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(read-char-fast)</span>
<span id="cb123-54"><a href="#cb123-54" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> ch </span>(peek-char-fast))</span>
<span id="cb123-55"><a href="#cb123-55" aria-hidden="true" tabindex="-1"></a>    (when ch</span>
<span id="cb123-56"><a href="#cb123-56" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">set!</span> buffer-pos (unsafe-fx+ buffer-pos <span class="dv">1</span>)))</span>
<span id="cb123-57"><a href="#cb123-57" aria-hidden="true" tabindex="-1"></a>    ch)</span>
<span id="cb123-58"><a href="#cb123-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-59"><a href="#cb123-59" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Return optimized lexer using fast I/O</span></span>
<span id="cb123-60"><a href="#cb123-60" aria-hidden="true" tabindex="-1"></a>  (make-shrdlu-lexer </span>
<span id="cb123-61"><a href="#cb123-61" aria-hidden="true" tabindex="-1"></a>   (make-custom-input-port <span class="st">&quot;buffered&quot;</span></span>
<span id="cb123-62"><a href="#cb123-62" aria-hidden="true" tabindex="-1"></a>                           (λ (str) <span class="op">...</span>)</span>
<span id="cb123-63"><a href="#cb123-63" aria-hidden="true" tabindex="-1"></a>                           peek-char-fast</span>
<span id="cb123-64"><a href="#cb123-64" aria-hidden="true" tabindex="-1"></a>                           void)))</span>
<span id="cb123-65"><a href="#cb123-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-66"><a href="#cb123-66" aria-hidden="true" tabindex="-1"></a><span class="co">;; Memoization for parser</span></span>
<span id="cb123-67"><a href="#cb123-67" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> parse-cache </span>(make-hash))</span>
<span id="cb123-68"><a href="#cb123-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-69"><a href="#cb123-69" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(cached-parse input)</span>
<span id="cb123-70"><a href="#cb123-70" aria-hidden="true" tabindex="-1"></a>  (hash-ref! parse-cache </span>
<span id="cb123-71"><a href="#cb123-71" aria-hidden="true" tabindex="-1"></a>             input</span>
<span id="cb123-72"><a href="#cb123-72" aria-hidden="true" tabindex="-1"></a>             (λ () (parse-string input))))</span>
<span id="cb123-73"><a href="#cb123-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-74"><a href="#cb123-74" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parallel parsing for large documents  </span></span>
<span id="cb123-75"><a href="#cb123-75" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(parallel-parse-file path)</span>
<span id="cb123-76"><a href="#cb123-76" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> sections </span>(split-file-into-sections path))</span>
<span id="cb123-77"><a href="#cb123-77" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> futures</span></span>
<span id="cb123-78"><a href="#cb123-78" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>section sections<span class="op">]</span>)</span>
<span id="cb123-79"><a href="#cb123-79" aria-hidden="true" tabindex="-1"></a>      (future (λ () (parse-string section)))))</span>
<span id="cb123-80"><a href="#cb123-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-81"><a href="#cb123-81" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> parsed-sections</span></span>
<span id="cb123-82"><a href="#cb123-82" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>f futures<span class="op">]</span>)</span>
<span id="cb123-83"><a href="#cb123-83" aria-hidden="true" tabindex="-1"></a>      (touch f)))</span>
<span id="cb123-84"><a href="#cb123-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb123-85"><a href="#cb123-85" aria-hidden="true" tabindex="-1"></a>  (combine-parsed-sections parsed-sections))</span></code></pre></div>
<h2 id="summary-3">Summary</h2>
<p>In this chapter, we’ve built a complete lexer and parser for the
Shrdlu markup language. Starting from token definitions, we progressed
through:</p>
<ol type="1">
<li><strong>Lexical Analysis</strong>: Breaking input into meaningful
tokens with position tracking</li>
<li><strong>Grammar Design</strong>: Creating an unambiguous, parseable
grammar</li>
<li><strong>AST Construction</strong>: Building structured
representations of documents<br />
</li>
<li><strong>The @ Reader</strong>: Implementing Shrdlu’s distinctive
syntax</li>
<li><strong>Error Handling</strong>: Providing helpful error messages
and recovery</li>
<li><strong>Testing</strong>: Ensuring correctness through comprehensive
tests</li>
<li><strong>Optimization</strong>: Making the parser fast enough for
real-world use</li>
</ol>
<p>The lexer and parser form the foundation for all of Shrdlu’s
processing. In the next chapter, we’ll build upon this foundation to
create the interpreter that brings our documents to life, executing the
computational elements and building the document model that will
eventually be rendered to multiple output formats.</p>
<h3 id="exercises-1">Exercises</h3>
<ol type="1">
<li><p><strong>Extend the Lexer</strong>: Add support for hexadecimal
numbers (<code>0x1234</code>) and binary numbers (<code>0b1010</code>).
Update the parser to handle these new token types.</p></li>
<li><p><strong>Grammar Enhancement</strong>: Add support for custom
operators like <code>@+</code>, <code>@-</code>, <code>@*</code> that
can be used in mathematical expressions. How would you handle operator
precedence?</p></li>
<li><p><strong>Error Recovery</strong>: Implement a more sophisticated
error recovery strategy that can recover from multiple missing closing
braces by tracking nesting depth.</p></li>
<li><p><strong>Performance Measurement</strong>: Create a benchmark
suite that measures lexer and parser performance on documents of varying
sizes and complexity. What are the bottlenecks?</p></li>
<li><p><strong>Syntax Extension</strong>: Design and implement a syntax
for tables that’s more readable than nested lists, perhaps using a
grid-like ASCII layout.</p></li>
<li><p><strong>Incremental Parsing</strong>: Implement an incremental
parser that can efficiently reparse only changed portions of a document
during editing.</p></li>
</ol>
<p>These exercises will deepen your understanding of language
implementation and prepare you for the interpreter construction in
Chapter 5. # Chapter 5: The Shrdlu Interpreter</p>
<h2 id="introduction-to-document-interpretation">Introduction to
Document Interpretation</h2>
<p>With our lexer and parser transforming Shrdlu markup into ASTs, we
now face the central challenge: interpretation. Unlike traditional
interpreters that execute programs to produce computation results,
Shrdlu’s interpreter executes documents to produce structured content.
This chapter explores how we breathe life into static markup, turning it
into a dynamic, computational medium.</p>
<p>The Shrdlu interpreter must handle several unique requirements: -
<strong>Mixed evaluation contexts</strong>: Some content should be
evaluated (computations), while other content should be preserved
(literal text) - <strong>Multiple output targets</strong>: The same
interpreted document must be suitable for HTML, PDF, and EPUB generation
- <strong>Environment management</strong>: Variables, functions, and
templates must be properly scoped - <strong>Side effects</strong>: File
inclusion, data loading, and external command execution - <strong>Error
handling</strong>: Graceful degradation when computations fail</p>
<h2 id="the-evaluation-model">The Evaluation Model</h2>
<p>Shrdlu follows a <strong>lazy evaluation model</strong> with explicit
forcing. This allows documents to reference expensive computations that
are only performed when actually needed for output.</p>
<div class="sourceCode" id="cb124"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; evaluation-model.rkt</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;ast.rkt&quot;</span>)</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>(provide (all-defined-out))</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Evaluation result types</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>(struct evaluated-doc (metadata elements env) #:transparent)</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>(struct evaluated-element (type attrs content) #:transparent)</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>(struct computed-value (thunk cached?) #:transparent)</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>(struct error-value (message location trace) #:transparent)</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; Environment for bindings</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>(struct environment </span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>  (bindings     <span class="co">; hash of name -&gt; value</span></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>   parent       <span class="co">; parent environment or #f</span></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>   metadata)    <span class="co">; document metadata</span></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create new environment</span></span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-env <span class="op">[</span>parent <span class="dv">#f</span><span class="op">]</span>)</span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>  (environment (make-hasheq) parent (hash)))</span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a><span class="co">;; Environment operations</span></span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(env-bind env name value)</span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a>  (hash-set! (environment-bindings env) name value)</span>
<span id="cb124-28"><a href="#cb124-28" aria-hidden="true" tabindex="-1"></a>  value)</span>
<span id="cb124-29"><a href="#cb124-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-30"><a href="#cb124-30" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(env-lookup env name)</span>
<span id="cb124-31"><a href="#cb124-31" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> bindings </span>(environment-bindings env))</span>
<span id="cb124-32"><a href="#cb124-32" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb124-33"><a href="#cb124-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(hash-has-key? bindings name)</span>
<span id="cb124-34"><a href="#cb124-34" aria-hidden="true" tabindex="-1"></a>     (hash-ref bindings name)<span class="op">]</span></span>
<span id="cb124-35"><a href="#cb124-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(environment-parent env)</span>
<span id="cb124-36"><a href="#cb124-36" aria-hidden="true" tabindex="-1"></a>     (env-lookup (environment-parent env) name)<span class="op">]</span></span>
<span id="cb124-37"><a href="#cb124-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb124-38"><a href="#cb124-38" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">error</span> &#39;env-lookup <span class="st">&quot;Unbound variable: ~a&quot;</span> name)<span class="op">]</span>))</span>
<span id="cb124-39"><a href="#cb124-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-40"><a href="#cb124-40" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(env-extend env bindings-alist)</span>
<span id="cb124-41"><a href="#cb124-41" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> new-env </span>(make-env env))</span>
<span id="cb124-42"><a href="#cb124-42" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>binding bindings-alist<span class="op">]</span>)</span>
<span id="cb124-43"><a href="#cb124-43" aria-hidden="true" tabindex="-1"></a>    (match-define (<span class="kw">list</span> name value) binding)</span>
<span id="cb124-44"><a href="#cb124-44" aria-hidden="true" tabindex="-1"></a>    (env-bind new-env name value))</span>
<span id="cb124-45"><a href="#cb124-45" aria-hidden="true" tabindex="-1"></a>  new-env)</span>
<span id="cb124-46"><a href="#cb124-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-47"><a href="#cb124-47" aria-hidden="true" tabindex="-1"></a><span class="co">;; Thunk for lazy evaluation</span></span>
<span id="cb124-48"><a href="#cb124-48" aria-hidden="true" tabindex="-1"></a>(struct thunk (proc env) #:transparent)</span>
<span id="cb124-49"><a href="#cb124-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-50"><a href="#cb124-50" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(force-value val)</span>
<span id="cb124-51"><a href="#cb124-51" aria-hidden="true" tabindex="-1"></a>  (match val</span>
<span id="cb124-52"><a href="#cb124-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(thunk proc env)</span>
<span id="cb124-53"><a href="#cb124-53" aria-hidden="true" tabindex="-1"></a>     (parameterize (<span class="op">[</span>current-eval-env env<span class="op">]</span>)</span>
<span id="cb124-54"><a href="#cb124-54" aria-hidden="true" tabindex="-1"></a>       (proc))<span class="op">]</span></span>
<span id="cb124-55"><a href="#cb124-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(computed-value thunk cached?)</span>
<span id="cb124-56"><a href="#cb124-56" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> cached?</span>
<span id="cb124-57"><a href="#cb124-57" aria-hidden="true" tabindex="-1"></a>         (computed-value-thunk val)</span>
<span id="cb124-58"><a href="#cb124-58" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">let</span> (<span class="op">[</span>result (force-value thunk)<span class="op">]</span>)</span>
<span id="cb124-59"><a href="#cb124-59" aria-hidden="true" tabindex="-1"></a>           (set-computed-value-thunk! val result)</span>
<span id="cb124-60"><a href="#cb124-60" aria-hidden="true" tabindex="-1"></a>           (set-computed-value-cached?! val <span class="dv">#t</span>)</span>
<span id="cb124-61"><a href="#cb124-61" aria-hidden="true" tabindex="-1"></a>           result))<span class="op">]</span></span>
<span id="cb124-62"><a href="#cb124-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> val<span class="op">]</span>))</span></code></pre></div>
<h2 id="core-interpreter-implementation">Core Interpreter
Implementation</h2>
<p>The interpreter walks the AST, evaluating nodes according to their
type:</p>
<div class="sourceCode" id="cb125"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; interpreter.rkt</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;ast.rkt&quot;</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;evaluation-model.rkt&quot;</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>         racket/generator)</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>(provide interpret-document</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>         interpret-node</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>         current-eval-env)</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Dynamic environment parameter</span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> current-eval-env </span>(make-parameter (make-env)))</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main entry point</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(interpret-document doc-ast)</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>  (match doc-ast</span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(document loc metadata content)</span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> env </span>(make-env))</span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Process metadata</span></span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> meta-hash</span></span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a>       (for/hash (<span class="op">[</span>meta metadata<span class="op">]</span>)</span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>         (match meta</span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(meta <span class="op">_</span> key value)</span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">values</span> key (interpret-node value env))<span class="op">]</span>)))</span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a>     (set-environment-metadata! env meta-hash)</span>
<span id="cb125-27"><a href="#cb125-27" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb125-28"><a href="#cb125-28" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Interpret content</span></span>
<span id="cb125-29"><a href="#cb125-29" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> interpreted-content</span></span>
<span id="cb125-30"><a href="#cb125-30" aria-hidden="true" tabindex="-1"></a>       (for/list (<span class="op">[</span>elem content<span class="op">]</span>)</span>
<span id="cb125-31"><a href="#cb125-31" aria-hidden="true" tabindex="-1"></a>         (interpret-node elem env)))</span>
<span id="cb125-32"><a href="#cb125-32" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb125-33"><a href="#cb125-33" aria-hidden="true" tabindex="-1"></a>     (evaluated-doc meta-hash interpreted-content env)<span class="op">]</span></span>
<span id="cb125-34"><a href="#cb125-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb125-35"><a href="#cb125-35" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">error</span> &#39;interpret-document <span class="st">&quot;Expected document node&quot;</span>)<span class="op">]</span>))</span>
<span id="cb125-36"><a href="#cb125-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-37"><a href="#cb125-37" aria-hidden="true" tabindex="-1"></a><span class="co">;; Interpret individual nodes</span></span>
<span id="cb125-38"><a href="#cb125-38" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(interpret-node node env)</span>
<span id="cb125-39"><a href="#cb125-39" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(interp node) (interpret-node node env))</span>
<span id="cb125-40"><a href="#cb125-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb125-41"><a href="#cb125-41" aria-hidden="true" tabindex="-1"></a>  (match node</span>
<span id="cb125-42"><a href="#cb125-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Literal text - pass through</span></span>
<span id="cb125-43"><a href="#cb125-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(text loc value) </span>
<span id="cb125-44"><a href="#cb125-44" aria-hidden="true" tabindex="-1"></a>     (evaluated-element &#39;text &#39;() value)<span class="op">]</span></span>
<span id="cb125-45"><a href="#cb125-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-46"><a href="#cb125-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Sections create structure</span></span>
<span id="cb125-47"><a href="#cb125-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(section loc level title label content)</span>
<span id="cb125-48"><a href="#cb125-48" aria-hidden="true" tabindex="-1"></a>     (evaluated-element </span>
<span id="cb125-49"><a href="#cb125-49" aria-hidden="true" tabindex="-1"></a>      &#39;section </span>
<span id="cb125-50"><a href="#cb125-50" aria-hidden="true" tabindex="-1"></a>      `((level ,level) (label ,label))</span>
<span id="cb125-51"><a href="#cb125-51" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">cons</span> (interp title)</span>
<span id="cb125-52"><a href="#cb125-52" aria-hidden="true" tabindex="-1"></a>            (map interp content)))<span class="op">]</span></span>
<span id="cb125-53"><a href="#cb125-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-54"><a href="#cb125-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Commands dispatch to handlers</span></span>
<span id="cb125-55"><a href="#cb125-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(command loc name args content)</span>
<span id="cb125-56"><a href="#cb125-56" aria-hidden="true" tabindex="-1"></a>     (interpret-command name args content env)<span class="op">]</span></span>
<span id="cb125-57"><a href="#cb125-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-58"><a href="#cb125-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Variable reference</span></span>
<span id="cb125-59"><a href="#cb125-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">?</span> <span class="kw">symbol?</span> var)</span>
<span id="cb125-60"><a href="#cb125-60" aria-hidden="true" tabindex="-1"></a>     (force-value (env-lookup env var))<span class="op">]</span></span>
<span id="cb125-61"><a href="#cb125-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-62"><a href="#cb125-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Numbers and strings evaluate to themselves</span></span>
<span id="cb125-63"><a href="#cb125-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">?</span> <span class="kw">number?</span> n) n<span class="op">]</span></span>
<span id="cb125-64"><a href="#cb125-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">?</span> <span class="kw">string?</span> s) s<span class="op">]</span></span>
<span id="cb125-65"><a href="#cb125-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-66"><a href="#cb125-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Lists represent function application</span></span>
<span id="cb125-67"><a href="#cb125-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">list</span> op args <span class="op">...</span>)</span>
<span id="cb125-68"><a href="#cb125-68" aria-hidden="true" tabindex="-1"></a>     (interpret-application op args env)<span class="op">]</span></span>
<span id="cb125-69"><a href="#cb125-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-70"><a href="#cb125-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Definitions bind variables</span></span>
<span id="cb125-71"><a href="#cb125-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(definition loc name params body)</span>
<span id="cb125-72"><a href="#cb125-72" aria-hidden="true" tabindex="-1"></a>     (interpret-definition name params body env)<span class="op">]</span></span>
<span id="cb125-73"><a href="#cb125-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-74"><a href="#cb125-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Conditionals</span></span>
<span id="cb125-75"><a href="#cb125-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(conditional loc test then <span class="kw">else</span>)</span>
<span id="cb125-76"><a href="#cb125-76" aria-hidden="true" tabindex="-1"></a>     (interpret-conditional test then <span class="kw">else</span> env)<span class="op">]</span></span>
<span id="cb125-77"><a href="#cb125-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-78"><a href="#cb125-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Loops</span></span>
<span id="cb125-79"><a href="#cb125-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(loop loc type bindings body)</span>
<span id="cb125-80"><a href="#cb125-80" aria-hidden="true" tabindex="-1"></a>     (interpret-loop type bindings body env)<span class="op">]</span></span>
<span id="cb125-81"><a href="#cb125-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-82"><a href="#cb125-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Unknown nodes</span></span>
<span id="cb125-83"><a href="#cb125-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb125-84"><a href="#cb125-84" aria-hidden="true" tabindex="-1"></a>     (error-value </span>
<span id="cb125-85"><a href="#cb125-85" aria-hidden="true" tabindex="-1"></a>      (format <span class="st">&quot;Unknown node type: ~a&quot;</span> node)</span>
<span id="cb125-86"><a href="#cb125-86" aria-hidden="true" tabindex="-1"></a>      (ast-node-location node)</span>
<span id="cb125-87"><a href="#cb125-87" aria-hidden="true" tabindex="-1"></a>      (current-continuation-marks))<span class="op">]</span>))</span>
<span id="cb125-88"><a href="#cb125-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-89"><a href="#cb125-89" aria-hidden="true" tabindex="-1"></a><span class="co">;; Command interpretation</span></span>
<span id="cb125-90"><a href="#cb125-90" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(interpret-command name args content env)</span>
<span id="cb125-91"><a href="#cb125-91" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> handler </span>(lookup-command-handler name))</span>
<span id="cb125-92"><a href="#cb125-92" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> handler</span>
<span id="cb125-93"><a href="#cb125-93" aria-hidden="true" tabindex="-1"></a>      (handler args content env)</span>
<span id="cb125-94"><a href="#cb125-94" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Unknown command - preserve as element</span></span>
<span id="cb125-95"><a href="#cb125-95" aria-hidden="true" tabindex="-1"></a>      (evaluated-element </span>
<span id="cb125-96"><a href="#cb125-96" aria-hidden="true" tabindex="-1"></a>       &#39;command</span>
<span id="cb125-97"><a href="#cb125-97" aria-hidden="true" tabindex="-1"></a>       `((name ,name))</span>
<span id="cb125-98"><a href="#cb125-98" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">append</span> (map (λ (a) (interpret-node a env)) args)</span>
<span id="cb125-99"><a href="#cb125-99" aria-hidden="true" tabindex="-1"></a>               (map (λ (c) (interpret-node c env)) content)))))</span>
<span id="cb125-100"><a href="#cb125-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-101"><a href="#cb125-101" aria-hidden="true" tabindex="-1"></a><span class="co">;; Command handler registry</span></span>
<span id="cb125-102"><a href="#cb125-102" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> command-handlers </span>(make-hasheq))</span>
<span id="cb125-103"><a href="#cb125-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-104"><a href="#cb125-104" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(register-command! name handler)</span>
<span id="cb125-105"><a href="#cb125-105" aria-hidden="true" tabindex="-1"></a>  (hash-set! command-handlers name handler))</span>
<span id="cb125-106"><a href="#cb125-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-107"><a href="#cb125-107" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(lookup-command-handler name)</span>
<span id="cb125-108"><a href="#cb125-108" aria-hidden="true" tabindex="-1"></a>  (hash-ref command-handlers name <span class="dv">#f</span>))</span>
<span id="cb125-109"><a href="#cb125-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-110"><a href="#cb125-110" aria-hidden="true" tabindex="-1"></a><span class="co">;; Built-in command handlers</span></span>
<span id="cb125-111"><a href="#cb125-111" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;em</span>
<span id="cb125-112"><a href="#cb125-112" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb125-113"><a href="#cb125-113" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;emphasis &#39;() </span>
<span id="cb125-114"><a href="#cb125-114" aria-hidden="true" tabindex="-1"></a>                      (map (λ (c) (interpret-node c env)) content))))</span>
<span id="cb125-115"><a href="#cb125-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-116"><a href="#cb125-116" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;strong  </span>
<span id="cb125-117"><a href="#cb125-117" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb125-118"><a href="#cb125-118" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;strong &#39;()</span>
<span id="cb125-119"><a href="#cb125-119" aria-hidden="true" tabindex="-1"></a>                      (map (λ (c) (interpret-node c env)) content))))</span>
<span id="cb125-120"><a href="#cb125-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-121"><a href="#cb125-121" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;code</span>
<span id="cb125-122"><a href="#cb125-122" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb125-123"><a href="#cb125-123" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> lang </span>(assoc-ref args &#39;lang <span class="st">&quot;text&quot;</span>))</span>
<span id="cb125-124"><a href="#cb125-124" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;code `((lang ,lang))</span>
<span id="cb125-125"><a href="#cb125-125" aria-hidden="true" tabindex="-1"></a>                      <span class="co">;; Don&#39;t evaluate code content</span></span>
<span id="cb125-126"><a href="#cb125-126" aria-hidden="true" tabindex="-1"></a>                      content)))</span>
<span id="cb125-127"><a href="#cb125-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-128"><a href="#cb125-128" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;math</span>
<span id="cb125-129"><a href="#cb125-129" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb125-130"><a href="#cb125-130" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;math &#39;()</span>
<span id="cb125-131"><a href="#cb125-131" aria-hidden="true" tabindex="-1"></a>                      <span class="co">;; Math content preserved as-is</span></span>
<span id="cb125-132"><a href="#cb125-132" aria-hidden="true" tabindex="-1"></a>                      content)))</span>
<span id="cb125-133"><a href="#cb125-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-134"><a href="#cb125-134" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;ref</span>
<span id="cb125-135"><a href="#cb125-135" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb125-136"><a href="#cb125-136" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> target </span>(first args))</span>
<span id="cb125-137"><a href="#cb125-137" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;ref `((target ,target)) &#39;())))</span>
<span id="cb125-138"><a href="#cb125-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-139"><a href="#cb125-139" aria-hidden="true" tabindex="-1"></a><span class="co">;; Helper to find keyword arguments</span></span>
<span id="cb125-140"><a href="#cb125-140" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(assoc-ref alist key <span class="op">[</span>default <span class="dv">#f</span><span class="op">]</span>)</span>
<span id="cb125-141"><a href="#cb125-141" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> pair </span>(<span class="kw">assoc</span> key alist))</span>
<span id="cb125-142"><a href="#cb125-142" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> pair (<span class="kw">cadr</span> pair) default))</span></code></pre></div>
<h2 id="advanced-interpretation-features">Advanced Interpretation
Features</h2>
<h3 id="function-definition-and-application">Function Definition and
Application</h3>
<div class="sourceCode" id="cb126"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; functions.rkt</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;interpreter.rkt&quot;</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;evaluation-model.rkt&quot;</span>)</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Interpret function definitions</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(interpret-definition name params body env)</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> closure</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">lambda</span> args</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Check arity</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>      (unless (<span class="op">=</span> (<span class="kw">length</span> args) (<span class="kw">length</span> params))</span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">error</span> name <span class="st">&quot;Expected ~a arguments, got ~a&quot;</span> </span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">length</span> params) (<span class="kw">length</span> args)))</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Create new environment with parameters bound</span></span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> body-env</span></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>        (env-extend env</span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>                    (map <span class="kw">list</span> params args)))</span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Evaluate body in extended environment</span></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>      (interpret-node body body-env)))</span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Bind function in environment</span></span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>  (env-bind env name closure)</span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Return empty element (definitions produce no output)</span></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>  (evaluated-element &#39;definition &#39;() &#39;()))</span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a><span class="co">;; Interpret function application</span></span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(interpret-application op args env)</span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> op-val </span>(interpret-node op env))</span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; User-defined function</span></span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">procedure?</span> op-val)</span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> arg-vals </span>(map (λ (a) (interpret-node a env)) args))</span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a>     (apply op-val arg-vals)<span class="op">]</span></span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Built-in operations</span></span>
<span id="cb126-37"><a href="#cb126-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">symbol?</span> op)</span>
<span id="cb126-38"><a href="#cb126-38" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> handler </span>(lookup-builtin-op op))</span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> handler</span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a>         (apply handler (map (λ (a) (interpret-node a env)) args))</span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">error</span> &#39;apply <span class="st">&quot;Unknown operation: ~a&quot;</span> op))<span class="op">]</span></span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">error</span> &#39;apply <span class="st">&quot;Not a function: ~a&quot;</span> op-val)<span class="op">]</span>))</span>
<span id="cb126-45"><a href="#cb126-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-46"><a href="#cb126-46" aria-hidden="true" tabindex="-1"></a><span class="co">;; Built-in operations</span></span>
<span id="cb126-47"><a href="#cb126-47" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> builtin-ops </span>(make-hasheq))</span>
<span id="cb126-48"><a href="#cb126-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-49"><a href="#cb126-49" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(register-builtin! name proc)</span>
<span id="cb126-50"><a href="#cb126-50" aria-hidden="true" tabindex="-1"></a>  (hash-set! builtin-ops name proc))</span>
<span id="cb126-51"><a href="#cb126-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-52"><a href="#cb126-52" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(lookup-builtin-op name)</span>
<span id="cb126-53"><a href="#cb126-53" aria-hidden="true" tabindex="-1"></a>  (hash-ref builtin-ops name <span class="dv">#f</span>))</span>
<span id="cb126-54"><a href="#cb126-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-55"><a href="#cb126-55" aria-hidden="true" tabindex="-1"></a><span class="co">;; Arithmetic</span></span>
<span id="cb126-56"><a href="#cb126-56" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;+ <span class="op">+</span>)</span>
<span id="cb126-57"><a href="#cb126-57" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;- <span class="op">-</span>)</span>
<span id="cb126-58"><a href="#cb126-58" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;* <span class="op">*</span>)</span>
<span id="cb126-59"><a href="#cb126-59" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;/ <span class="op">/</span>)</span>
<span id="cb126-60"><a href="#cb126-60" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;&lt; <span class="op">&lt;</span>)</span>
<span id="cb126-61"><a href="#cb126-61" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;&gt; <span class="op">&gt;</span>)</span>
<span id="cb126-62"><a href="#cb126-62" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;&lt;= <span class="op">&lt;=</span>)</span>
<span id="cb126-63"><a href="#cb126-63" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;&gt;= <span class="op">&gt;=</span>)</span>
<span id="cb126-64"><a href="#cb126-64" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;= <span class="op">=</span>)</span>
<span id="cb126-65"><a href="#cb126-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-66"><a href="#cb126-66" aria-hidden="true" tabindex="-1"></a><span class="co">;; String operations</span></span>
<span id="cb126-67"><a href="#cb126-67" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;string-append <span class="kw">string-append</span>)</span>
<span id="cb126-68"><a href="#cb126-68" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;string-length <span class="kw">string-length</span>)</span>
<span id="cb126-69"><a href="#cb126-69" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;substring <span class="kw">substring</span>)</span>
<span id="cb126-70"><a href="#cb126-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-71"><a href="#cb126-71" aria-hidden="true" tabindex="-1"></a><span class="co">;; List operations</span></span>
<span id="cb126-72"><a href="#cb126-72" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;list <span class="kw">list</span>)</span>
<span id="cb126-73"><a href="#cb126-73" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;cons <span class="kw">cons</span>)</span>
<span id="cb126-74"><a href="#cb126-74" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;car <span class="kw">car</span>)</span>
<span id="cb126-75"><a href="#cb126-75" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;cdr <span class="kw">cdr</span>)</span>
<span id="cb126-76"><a href="#cb126-76" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;length <span class="kw">length</span>)</span>
<span id="cb126-77"><a href="#cb126-77" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;map </span>
<span id="cb126-78"><a href="#cb126-78" aria-hidden="true" tabindex="-1"></a>  (λ (f lst)</span>
<span id="cb126-79"><a href="#cb126-79" aria-hidden="true" tabindex="-1"></a>    (map (λ (x) (f x)) lst)))</span>
<span id="cb126-80"><a href="#cb126-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-81"><a href="#cb126-81" aria-hidden="true" tabindex="-1"></a><span class="co">;; I/O operations (careful with security!)</span></span>
<span id="cb126-82"><a href="#cb126-82" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;read-file</span>
<span id="cb126-83"><a href="#cb126-83" aria-hidden="true" tabindex="-1"></a>  (λ (path)</span>
<span id="cb126-84"><a href="#cb126-84" aria-hidden="true" tabindex="-1"></a>    (with-handlers (<span class="op">[</span>exn:fail:filesystem? </span>
<span id="cb126-85"><a href="#cb126-85" aria-hidden="true" tabindex="-1"></a>                     (λ (e) (error-value (exn-message e) <span class="dv">#f</span> &#39;()))<span class="op">]</span>)</span>
<span id="cb126-86"><a href="#cb126-86" aria-hidden="true" tabindex="-1"></a>      (file-&gt;string path))))</span></code></pre></div>
<h3 id="control-flow">Control Flow</h3>
<div class="sourceCode" id="cb127"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; control-flow.rkt</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;interpreter.rkt&quot;</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;evaluation-model.rkt&quot;</span>)</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Conditionals</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(interpret-conditional test-expr then-expr else-expr env)</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> test-val </span>(interpret-node test-expr env))</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(error-value? test-val) test-val<span class="op">]</span>  <span class="co">; Propagate errors</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>test-val (interpret-node then-expr env)<span class="op">]</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> (interpret-node else-expr env)<span class="op">]</span>))</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; Enhanced conditionals with multiple branches</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;cond</span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> loop (<span class="op">[</span>clauses content<span class="op">]</span>)</span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>      (match clauses</span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>&#39;() (evaluated-element &#39;void &#39;() &#39;())<span class="op">]</span></span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="kw">cons</span> clause rest)</span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>         (match clause</span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="kw">list</span> test body)</span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>            (<span class="ex">define</span><span class="fu"> test-val </span>(interpret-node test env))</span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">if</span> test-val</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>                (interpret-node body env)</span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a>                (loop rest))<span class="op">]</span></span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span><span class="kw">else</span></span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">error</span> &#39;cond <span class="st">&quot;Malformed clause: ~a&quot;</span> clause)<span class="op">]</span>)<span class="op">]</span>))))</span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a><span class="co">;; Pattern matching</span></span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;match</span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> value </span>(interpret-node (first args) env))</span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> loop (<span class="op">[</span>clauses content<span class="op">]</span>)</span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a>      (match clauses</span>
<span id="cb127-37"><a href="#cb127-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>&#39;() (<span class="kw">error</span> &#39;match <span class="st">&quot;No matching clause for: ~a&quot;</span> value)<span class="op">]</span></span>
<span id="cb127-38"><a href="#cb127-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="kw">cons</span> clause rest)</span>
<span id="cb127-39"><a href="#cb127-39" aria-hidden="true" tabindex="-1"></a>         (match clause</span>
<span id="cb127-40"><a href="#cb127-40" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="kw">list</span> pattern body)</span>
<span id="cb127-41"><a href="#cb127-41" aria-hidden="true" tabindex="-1"></a>            (<span class="ex">define</span><span class="fu"> bindings </span>(match-pattern pattern value))</span>
<span id="cb127-42"><a href="#cb127-42" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">if</span> bindings</span>
<span id="cb127-43"><a href="#cb127-43" aria-hidden="true" tabindex="-1"></a>                (interpret-node body (env-extend env bindings))</span>
<span id="cb127-44"><a href="#cb127-44" aria-hidden="true" tabindex="-1"></a>                (loop rest))<span class="op">]</span>)<span class="op">]</span>))))</span>
<span id="cb127-45"><a href="#cb127-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-46"><a href="#cb127-46" aria-hidden="true" tabindex="-1"></a><span class="co">;; Simple pattern matching</span></span>
<span id="cb127-47"><a href="#cb127-47" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(match-pattern pattern value)</span>
<span id="cb127-48"><a href="#cb127-48" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb127-49"><a href="#cb127-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Variable pattern - always matches</span></span>
<span id="cb127-50"><a href="#cb127-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">symbol?</span> pattern)</span>
<span id="cb127-51"><a href="#cb127-51" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">list</span> (<span class="kw">list</span> pattern value))<span class="op">]</span></span>
<span id="cb127-52"><a href="#cb127-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-53"><a href="#cb127-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Literal pattern</span></span>
<span id="cb127-54"><a href="#cb127-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">or</span> (<span class="kw">number?</span> pattern) (<span class="kw">string?</span> pattern))</span>
<span id="cb127-55"><a href="#cb127-55" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">and</span> (<span class="kw">equal?</span> pattern value) &#39;())<span class="op">]</span></span>
<span id="cb127-56"><a href="#cb127-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-57"><a href="#cb127-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; List pattern</span></span>
<span id="cb127-58"><a href="#cb127-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">list?</span> pattern)</span>
<span id="cb127-59"><a href="#cb127-59" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">and</span> (<span class="kw">list?</span> value)</span>
<span id="cb127-60"><a href="#cb127-60" aria-hidden="true" tabindex="-1"></a>          (<span class="op">=</span> (<span class="kw">length</span> pattern) (<span class="kw">length</span> value))</span>
<span id="cb127-61"><a href="#cb127-61" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">let</span> loop (<span class="op">[</span>ps pattern<span class="op">]</span> <span class="op">[</span>vs value<span class="op">]</span> <span class="op">[</span>bindings &#39;()<span class="op">]</span>)</span>
<span id="cb127-62"><a href="#cb127-62" aria-hidden="true" tabindex="-1"></a>            (match* (ps vs)</span>
<span id="cb127-63"><a href="#cb127-63" aria-hidden="true" tabindex="-1"></a>              <span class="op">[</span>(&#39;() &#39;()) bindings<span class="op">]</span></span>
<span id="cb127-64"><a href="#cb127-64" aria-hidden="true" tabindex="-1"></a>              <span class="op">[</span>((<span class="kw">cons</span> p ps) (<span class="kw">cons</span> v vs))</span>
<span id="cb127-65"><a href="#cb127-65" aria-hidden="true" tabindex="-1"></a>               (<span class="ex">define</span><span class="fu"> new-bindings </span>(match-pattern p v))</span>
<span id="cb127-66"><a href="#cb127-66" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">and</span> new-bindings</span>
<span id="cb127-67"><a href="#cb127-67" aria-hidden="true" tabindex="-1"></a>                    (loop ps vs (<span class="kw">append</span> bindings new-bindings)))<span class="op">]</span></span>
<span id="cb127-68"><a href="#cb127-68" aria-hidden="true" tabindex="-1"></a>              <span class="op">[</span>(<span class="op">_</span> <span class="op">_</span>) <span class="dv">#f</span><span class="op">]</span>)))<span class="op">]</span></span>
<span id="cb127-69"><a href="#cb127-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-70"><a href="#cb127-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> <span class="dv">#f</span><span class="op">]</span>))</span>
<span id="cb127-71"><a href="#cb127-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-72"><a href="#cb127-72" aria-hidden="true" tabindex="-1"></a><span class="co">;; Loops</span></span>
<span id="cb127-73"><a href="#cb127-73" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(interpret-loop type bindings body env)</span>
<span id="cb127-74"><a href="#cb127-74" aria-hidden="true" tabindex="-1"></a>  (match type</span>
<span id="cb127-75"><a href="#cb127-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;for (interpret-for-loop bindings body env)<span class="op">]</span></span>
<span id="cb127-76"><a href="#cb127-76" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;while (interpret-while-loop bindings body env)<span class="op">]</span></span>
<span id="cb127-77"><a href="#cb127-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> (<span class="kw">error</span> &#39;loop <span class="st">&quot;Unknown loop type: ~a&quot;</span> type)<span class="op">]</span>))</span>
<span id="cb127-78"><a href="#cb127-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-79"><a href="#cb127-79" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(interpret-for-loop bindings body env)</span>
<span id="cb127-80"><a href="#cb127-80" aria-hidden="true" tabindex="-1"></a>  (match bindings</span>
<span id="cb127-81"><a href="#cb127-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">list</span> var collection-expr)</span>
<span id="cb127-82"><a href="#cb127-82" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> collection </span>(interpret-node collection-expr env))</span>
<span id="cb127-83"><a href="#cb127-83" aria-hidden="true" tabindex="-1"></a>     (evaluated-element</span>
<span id="cb127-84"><a href="#cb127-84" aria-hidden="true" tabindex="-1"></a>      &#39;sequence &#39;()</span>
<span id="cb127-85"><a href="#cb127-85" aria-hidden="true" tabindex="-1"></a>      (for/list (<span class="op">[</span>item collection<span class="op">]</span>)</span>
<span id="cb127-86"><a href="#cb127-86" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> loop-env </span>(env-extend env (<span class="kw">list</span> (<span class="kw">list</span> var item))))</span>
<span id="cb127-87"><a href="#cb127-87" aria-hidden="true" tabindex="-1"></a>        (interpret-node body loop-env)))<span class="op">]</span></span>
<span id="cb127-88"><a href="#cb127-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb127-89"><a href="#cb127-89" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">error</span> &#39;for <span class="st">&quot;Malformed for bindings: ~a&quot;</span> bindings)<span class="op">]</span>))</span>
<span id="cb127-90"><a href="#cb127-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-91"><a href="#cb127-91" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(interpret-while-loop test-expr body env)</span>
<span id="cb127-92"><a href="#cb127-92" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> results </span>&#39;())</span>
<span id="cb127-93"><a href="#cb127-93" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> loop ()</span>
<span id="cb127-94"><a href="#cb127-94" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> test-val </span>(interpret-node test-expr env))</span>
<span id="cb127-95"><a href="#cb127-95" aria-hidden="true" tabindex="-1"></a>    (when test-val</span>
<span id="cb127-96"><a href="#cb127-96" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> result </span>(interpret-node body env))</span>
<span id="cb127-97"><a href="#cb127-97" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">set!</span> results (<span class="kw">cons</span> result results))</span>
<span id="cb127-98"><a href="#cb127-98" aria-hidden="true" tabindex="-1"></a>      (loop)))</span>
<span id="cb127-99"><a href="#cb127-99" aria-hidden="true" tabindex="-1"></a>  (evaluated-element &#39;sequence &#39;() (<span class="kw">reverse</span> results)))</span>
<span id="cb127-100"><a href="#cb127-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-101"><a href="#cb127-101" aria-hidden="true" tabindex="-1"></a><span class="co">;; Sequence operations</span></span>
<span id="cb127-102"><a href="#cb127-102" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;range</span>
<span id="cb127-103"><a href="#cb127-103" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case-lambda</span></span>
<span id="cb127-104"><a href="#cb127-104" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(end) (range <span class="dv">0</span> end)<span class="op">]</span></span>
<span id="cb127-105"><a href="#cb127-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(start end) (range start end <span class="dv">1</span>)<span class="op">]</span></span>
<span id="cb127-106"><a href="#cb127-106" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(start end step)</span>
<span id="cb127-107"><a href="#cb127-107" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> loop (<span class="op">[</span>i start<span class="op">]</span> <span class="op">[</span>acc &#39;()<span class="op">]</span>)</span>
<span id="cb127-108"><a href="#cb127-108" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">if</span> ((<span class="kw">if</span> (<span class="kw">positive?</span> step) <span class="op">&gt;=</span> <span class="op">&lt;=</span>) i end)</span>
<span id="cb127-109"><a href="#cb127-109" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">reverse</span> acc)</span>
<span id="cb127-110"><a href="#cb127-110" aria-hidden="true" tabindex="-1"></a>           (loop (<span class="op">+</span> i step) (<span class="kw">cons</span> i acc))))<span class="op">]</span>))</span></code></pre></div>
<h3 id="template-system">Template System</h3>
<p>Templates are parameterized document fragments:</p>
<div class="sourceCode" id="cb128"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; templates.rkt  </span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;interpreter.rkt&quot;</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;evaluation-model.rkt&quot;</span>)</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template structure</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>(struct template (params defaults body) #:transparent)</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template definition</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;define-template</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>    (match args</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">list</span> name param-spec)</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> params </span>(parse-template-params param-spec))</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> tmpl </span>(template </span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>                     (map first params)</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>                     (map second params)</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>                     (first content)))</span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>       (env-bind env name tmpl)</span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>       (evaluated-element &#39;template-def &#39;() &#39;())<span class="op">]</span></span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">error</span> &#39;define-template <span class="st">&quot;Malformed template definition&quot;</span>)<span class="op">]</span>)))</span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parse parameter specification</span></span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(parse-template-params spec)</span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a>  (match spec</span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">list</span> &#39;list params <span class="op">...</span>)</span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a>     (for/list (<span class="op">[</span>p params<span class="op">]</span>)</span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a>       (match p</span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a>         <span class="op">[</span>(<span class="kw">list</span> name default) (<span class="kw">list</span> name default)<span class="op">]</span></span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a>         <span class="op">[</span>name (<span class="kw">list</span> name <span class="dv">#f</span>)<span class="op">]</span>))<span class="op">]</span></span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> &#39;()<span class="op">]</span>))</span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template instantiation</span></span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;instantiate</span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> template-name </span>(first args))</span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> tmpl </span>(env-lookup env template-name))</span>
<span id="cb128-40"><a href="#cb128-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb128-41"><a href="#cb128-41" aria-hidden="true" tabindex="-1"></a>    (unless (template? tmpl)</span>
<span id="cb128-42"><a href="#cb128-42" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> &#39;instantiate <span class="st">&quot;Not a template: ~a&quot;</span> template-name))</span>
<span id="cb128-43"><a href="#cb128-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb128-44"><a href="#cb128-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Parse arguments</span></span>
<span id="cb128-45"><a href="#cb128-45" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> arg-alist </span>(parse-template-args (rest args)))</span>
<span id="cb128-46"><a href="#cb128-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb128-47"><a href="#cb128-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Create environment with parameters</span></span>
<span id="cb128-48"><a href="#cb128-48" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> tmpl-env </span>(make-env env))</span>
<span id="cb128-49"><a href="#cb128-49" aria-hidden="true" tabindex="-1"></a>    (for (<span class="op">[</span>param (template-params tmpl)<span class="op">]</span></span>
<span id="cb128-50"><a href="#cb128-50" aria-hidden="true" tabindex="-1"></a>          <span class="op">[</span>default (template-defaults tmpl)<span class="op">]</span>)</span>
<span id="cb128-51"><a href="#cb128-51" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> value </span></span>
<span id="cb128-52"><a href="#cb128-52" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">or</span> (assoc-ref arg-alist param)</span>
<span id="cb128-53"><a href="#cb128-53" aria-hidden="true" tabindex="-1"></a>            default</span>
<span id="cb128-54"><a href="#cb128-54" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">error</span> &#39;instantiate <span class="st">&quot;Missing required parameter: ~a&quot;</span> param)))</span>
<span id="cb128-55"><a href="#cb128-55" aria-hidden="true" tabindex="-1"></a>      (env-bind tmpl-env param value))</span>
<span id="cb128-56"><a href="#cb128-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb128-57"><a href="#cb128-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Interpret template body</span></span>
<span id="cb128-58"><a href="#cb128-58" aria-hidden="true" tabindex="-1"></a>    (interpret-node (template-body tmpl) tmpl-env)))</span>
<span id="cb128-59"><a href="#cb128-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-60"><a href="#cb128-60" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parse template arguments</span></span>
<span id="cb128-61"><a href="#cb128-61" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(parse-template-args args)</span>
<span id="cb128-62"><a href="#cb128-62" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> loop (<span class="op">[</span>args args<span class="op">]</span> <span class="op">[</span>alist &#39;()<span class="op">]</span>)</span>
<span id="cb128-63"><a href="#cb128-63" aria-hidden="true" tabindex="-1"></a>    (match args</span>
<span id="cb128-64"><a href="#cb128-64" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>&#39;() alist<span class="op">]</span></span>
<span id="cb128-65"><a href="#cb128-65" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">cons</span> (<span class="op">?</span> keyword? k) (<span class="kw">cons</span> v rest))</span>
<span id="cb128-66"><a href="#cb128-66" aria-hidden="true" tabindex="-1"></a>       (loop rest (<span class="kw">cons</span> (<span class="kw">list</span> (keyword-&gt;symbol k) v) alist))<span class="op">]</span></span>
<span id="cb128-67"><a href="#cb128-67" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span> </span>
<span id="cb128-68"><a href="#cb128-68" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">error</span> &#39;template-args <span class="st">&quot;Invalid argument syntax&quot;</span>)<span class="op">]</span>)))</span>
<span id="cb128-69"><a href="#cb128-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-70"><a href="#cb128-70" aria-hidden="true" tabindex="-1"></a><span class="co">;; Partial application</span></span>
<span id="cb128-71"><a href="#cb128-71" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;partial</span>
<span id="cb128-72"><a href="#cb128-72" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb128-73"><a href="#cb128-73" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> template-name </span>(first args))</span>
<span id="cb128-74"><a href="#cb128-74" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> partial-args </span>(rest args))</span>
<span id="cb128-75"><a href="#cb128-75" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> tmpl </span>(env-lookup env template-name))</span>
<span id="cb128-76"><a href="#cb128-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb128-77"><a href="#cb128-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Create new template with some parameters pre-filled</span></span>
<span id="cb128-78"><a href="#cb128-78" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> new-params</span></span>
<span id="cb128-79"><a href="#cb128-79" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">filter</span> (λ (p) (<span class="kw">not</span> (assoc-ref partial-args p)))</span>
<span id="cb128-80"><a href="#cb128-80" aria-hidden="true" tabindex="-1"></a>              (template-params tmpl)))</span>
<span id="cb128-81"><a href="#cb128-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb128-82"><a href="#cb128-82" aria-hidden="true" tabindex="-1"></a>    (template new-params</span>
<span id="cb128-83"><a href="#cb128-83" aria-hidden="true" tabindex="-1"></a>              (template-defaults tmpl)</span>
<span id="cb128-84"><a href="#cb128-84" aria-hidden="true" tabindex="-1"></a>              `(instantiate ,template-name ,@partial-args </span>
<span id="cb128-85"><a href="#cb128-85" aria-hidden="true" tabindex="-1"></a>                           ,@(map (λ (p) (<span class="kw">list</span> (symbol-&gt;keyword p) p))</span>
<span id="cb128-86"><a href="#cb128-86" aria-hidden="true" tabindex="-1"></a>                                 new-params)))))</span></code></pre></div>
<h3 id="data-loading-and-processing">Data Loading and Processing</h3>
<div class="sourceCode" id="cb129"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; data-processing.rkt</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>(require json</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>         csv-reading</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;interpreter.rkt&quot;</span>)</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Load various data formats</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;load-data</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> path </span>(first args))</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> format </span>(<span class="kw">or</span> (assoc-ref args &#39;format)</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>                      (path-&gt;format path)))</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> data</span></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>      (with-handlers (<span class="op">[</span>exn:fail? </span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>                       (λ (e) </span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>                         (error-value </span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>                          (format <span class="st">&quot;Failed to load ~a: ~a&quot;</span> path (exn-message e))</span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>                          <span class="dv">#f</span> &#39;()))<span class="op">]</span>)</span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">case</span> format</span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a>          <span class="op">[</span>(json) (<span class="kw">call-with-input-file</span> path read-json)<span class="op">]</span></span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a>          <span class="op">[</span>(csv) (<span class="kw">call-with-input-file</span> path </span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a>                   (λ (in) (csv-&gt;list (make-csv-reader in))))<span class="op">]</span></span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a>          <span class="op">[</span>(sexp) (<span class="kw">call-with-input-file</span> path <span class="kw">read</span>)<span class="op">]</span></span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a>          <span class="op">[</span><span class="kw">else</span> (<span class="kw">error</span> &#39;load-data <span class="st">&quot;Unknown format: ~a&quot;</span> format)<span class="op">]</span>)))</span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a>    data))</span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-30"><a href="#cb129-30" aria-hidden="true" tabindex="-1"></a><span class="co">;; Infer format from extension</span></span>
<span id="cb129-31"><a href="#cb129-31" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(path-&gt;format path)</span>
<span id="cb129-32"><a href="#cb129-32" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ext </span>(path-get-extension path))</span>
<span id="cb129-33"><a href="#cb129-33" aria-hidden="true" tabindex="-1"></a>  (match ext</span>
<span id="cb129-34"><a href="#cb129-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="st">&quot;.json&quot;</span> &#39;json<span class="op">]</span></span>
<span id="cb129-35"><a href="#cb129-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="st">&quot;.csv&quot;</span> &#39;csv<span class="op">]</span></span>
<span id="cb129-36"><a href="#cb129-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="st">&quot;.rkt&quot;</span> &#39;sexp<span class="op">]</span></span>
<span id="cb129-37"><a href="#cb129-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="st">&quot;.scm&quot;</span> &#39;sexp<span class="op">]</span></span>
<span id="cb129-38"><a href="#cb129-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> <span class="dv">#f</span><span class="op">]</span>))</span>
<span id="cb129-39"><a href="#cb129-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-40"><a href="#cb129-40" aria-hidden="true" tabindex="-1"></a><span class="co">;; Data transformation</span></span>
<span id="cb129-41"><a href="#cb129-41" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;select</span>
<span id="cb129-42"><a href="#cb129-42" aria-hidden="true" tabindex="-1"></a>  (λ (data <span class="op">.</span> keys)</span>
<span id="cb129-43"><a href="#cb129-43" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb129-44"><a href="#cb129-44" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(hash? data)</span>
<span id="cb129-45"><a href="#cb129-45" aria-hidden="true" tabindex="-1"></a>       (for/hash (<span class="op">[</span>k keys<span class="op">]</span></span>
<span id="cb129-46"><a href="#cb129-46" aria-hidden="true" tabindex="-1"></a>                  #:when (hash-has-key? data k))</span>
<span id="cb129-47"><a href="#cb129-47" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">values</span> k (hash-ref data k)))<span class="op">]</span></span>
<span id="cb129-48"><a href="#cb129-48" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">list?</span> data)</span>
<span id="cb129-49"><a href="#cb129-49" aria-hidden="true" tabindex="-1"></a>       (for/list (<span class="op">[</span>row data<span class="op">]</span>)</span>
<span id="cb129-50"><a href="#cb129-50" aria-hidden="true" tabindex="-1"></a>         (for/hash (<span class="op">[</span>k keys<span class="op">]</span></span>
<span id="cb129-51"><a href="#cb129-51" aria-hidden="true" tabindex="-1"></a>                    #:when (hash-has-key? row k))</span>
<span id="cb129-52"><a href="#cb129-52" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">values</span> k (hash-ref row k))))<span class="op">]</span></span>
<span id="cb129-53"><a href="#cb129-53" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span> data<span class="op">]</span>)))</span>
<span id="cb129-54"><a href="#cb129-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-55"><a href="#cb129-55" aria-hidden="true" tabindex="-1"></a>(register-builtin! &#39;aggregate</span>
<span id="cb129-56"><a href="#cb129-56" aria-hidden="true" tabindex="-1"></a>  (λ (data key-fn agg-fn)</span>
<span id="cb129-57"><a href="#cb129-57" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> groups </span>(make-hash))</span>
<span id="cb129-58"><a href="#cb129-58" aria-hidden="true" tabindex="-1"></a>    (for (<span class="op">[</span>item data<span class="op">]</span>)</span>
<span id="cb129-59"><a href="#cb129-59" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> key </span>(key-fn item))</span>
<span id="cb129-60"><a href="#cb129-60" aria-hidden="true" tabindex="-1"></a>      (hash-update! groups key </span>
<span id="cb129-61"><a href="#cb129-61" aria-hidden="true" tabindex="-1"></a>                    (λ (items) (<span class="kw">cons</span> item items))</span>
<span id="cb129-62"><a href="#cb129-62" aria-hidden="true" tabindex="-1"></a>                    &#39;()))</span>
<span id="cb129-63"><a href="#cb129-63" aria-hidden="true" tabindex="-1"></a>    (for/hash (<span class="op">[</span>(k items) groups<span class="op">]</span>)</span>
<span id="cb129-64"><a href="#cb129-64" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">values</span> k (agg-fn items)))))</span>
<span id="cb129-65"><a href="#cb129-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-66"><a href="#cb129-66" aria-hidden="true" tabindex="-1"></a><span class="co">;; Plotting integration</span></span>
<span id="cb129-67"><a href="#cb129-67" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;plot</span>
<span id="cb129-68"><a href="#cb129-68" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb129-69"><a href="#cb129-69" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> data </span>(interpret-node (first content) env))</span>
<span id="cb129-70"><a href="#cb129-70" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> plot-type </span>(assoc-ref args &#39;type &#39;line))</span>
<span id="cb129-71"><a href="#cb129-71" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> width </span>(assoc-ref args &#39;width <span class="dv">400</span>))</span>
<span id="cb129-72"><a href="#cb129-72" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> height </span>(assoc-ref args &#39;height <span class="dv">300</span>))</span>
<span id="cb129-73"><a href="#cb129-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-74"><a href="#cb129-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Generate plot (returns path to generated image)</span></span>
<span id="cb129-75"><a href="#cb129-75" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> plot-path </span>(generate-plot data plot-type width height))</span>
<span id="cb129-76"><a href="#cb129-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-77"><a href="#cb129-77" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;figure</span>
<span id="cb129-78"><a href="#cb129-78" aria-hidden="true" tabindex="-1"></a>                      `((src ,plot-path)</span>
<span id="cb129-79"><a href="#cb129-79" aria-hidden="true" tabindex="-1"></a>                        (width ,width)</span>
<span id="cb129-80"><a href="#cb129-80" aria-hidden="true" tabindex="-1"></a>                        (height ,height))</span>
<span id="cb129-81"><a href="#cb129-81" aria-hidden="true" tabindex="-1"></a>                      &#39;())))</span>
<span id="cb129-82"><a href="#cb129-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-83"><a href="#cb129-83" aria-hidden="true" tabindex="-1"></a><span class="co">;; Simplified plot generation</span></span>
<span id="cb129-84"><a href="#cb129-84" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-plot data type width height)</span>
<span id="cb129-85"><a href="#cb129-85" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; In real implementation, would use plot library</span></span>
<span id="cb129-86"><a href="#cb129-86" aria-hidden="true" tabindex="-1"></a>  (format <span class="st">&quot;plot-~a.png&quot;</span> (current-milliseconds)))</span></code></pre></div>
<h3 id="include-and-module-system">Include and Module System</h3>
<div class="sourceCode" id="cb130"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; includes.rkt</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;interpreter.rkt&quot;</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;parser.rkt&quot;</span>)</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Include other Shrdlu files</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;include</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> path </span>(first args))</span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> included-ast</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>      (with-handlers (<span class="op">[</span>exn:fail? </span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>                       (λ (e)</span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>                         (error-value </span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>                          (format <span class="st">&quot;Failed to include ~a: ~a&quot;</span> </span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>                                  path (exn-message e))</span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>                          <span class="dv">#f</span> &#39;()))<span class="op">]</span>)</span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>        (parse-file path)))</span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Interpret in current environment</span></span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>    (interpret-node included-ast env)))</span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a><span class="co">;; Include with isolated environment</span></span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;import</span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> path </span>(first args))</span>
<span id="cb130-27"><a href="#cb130-27" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> only </span>(assoc-ref args &#39;only <span class="dv">#f</span>))</span>
<span id="cb130-28"><a href="#cb130-28" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> prefix </span>(assoc-ref args &#39;prefix <span class="dv">#f</span>))</span>
<span id="cb130-29"><a href="#cb130-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-30"><a href="#cb130-30" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> included-ast </span>(parse-file path))</span>
<span id="cb130-31"><a href="#cb130-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-32"><a href="#cb130-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Create isolated environment</span></span>
<span id="cb130-33"><a href="#cb130-33" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> import-env </span>(make-env))</span>
<span id="cb130-34"><a href="#cb130-34" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> result </span>(interpret-document included-ast))</span>
<span id="cb130-35"><a href="#cb130-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-36"><a href="#cb130-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Extract bindings</span></span>
<span id="cb130-37"><a href="#cb130-37" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> bindings </span></span>
<span id="cb130-38"><a href="#cb130-38" aria-hidden="true" tabindex="-1"></a>      (hash-&gt;list (environment-bindings </span>
<span id="cb130-39"><a href="#cb130-39" aria-hidden="true" tabindex="-1"></a>                   (evaluated-doc-env result))))</span>
<span id="cb130-40"><a href="#cb130-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-41"><a href="#cb130-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Filter and rename bindings</span></span>
<span id="cb130-42"><a href="#cb130-42" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> filtered-bindings</span></span>
<span id="cb130-43"><a href="#cb130-43" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">cond</span></span>
<span id="cb130-44"><a href="#cb130-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>only (<span class="kw">filter</span> (λ (b) (<span class="kw">member</span> (<span class="kw">car</span> b) only)) bindings)<span class="op">]</span></span>
<span id="cb130-45"><a href="#cb130-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span><span class="kw">else</span> bindings<span class="op">]</span>))</span>
<span id="cb130-46"><a href="#cb130-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-47"><a href="#cb130-47" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> final-bindings</span></span>
<span id="cb130-48"><a href="#cb130-48" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">if</span> prefix</span>
<span id="cb130-49"><a href="#cb130-49" aria-hidden="true" tabindex="-1"></a>          (map (λ (b) </span>
<span id="cb130-50"><a href="#cb130-50" aria-hidden="true" tabindex="-1"></a>                 (<span class="kw">cons</span> (<span class="kw">string-&gt;symbol</span> </span>
<span id="cb130-51"><a href="#cb130-51" aria-hidden="true" tabindex="-1"></a>                        (format <span class="st">&quot;~a~a&quot;</span> prefix (<span class="kw">car</span> b)))</span>
<span id="cb130-52"><a href="#cb130-52" aria-hidden="true" tabindex="-1"></a>                       (<span class="kw">cdr</span> b)))</span>
<span id="cb130-53"><a href="#cb130-53" aria-hidden="true" tabindex="-1"></a>               filtered-bindings)</span>
<span id="cb130-54"><a href="#cb130-54" aria-hidden="true" tabindex="-1"></a>          filtered-bindings))</span>
<span id="cb130-55"><a href="#cb130-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-56"><a href="#cb130-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Import into current environment</span></span>
<span id="cb130-57"><a href="#cb130-57" aria-hidden="true" tabindex="-1"></a>    (for (<span class="op">[</span>binding final-bindings<span class="op">]</span>)</span>
<span id="cb130-58"><a href="#cb130-58" aria-hidden="true" tabindex="-1"></a>      (env-bind env (<span class="kw">car</span> binding) (<span class="kw">cdr</span> binding)))</span>
<span id="cb130-59"><a href="#cb130-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-60"><a href="#cb130-60" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;import &#39;() &#39;())))</span>
<span id="cb130-61"><a href="#cb130-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-62"><a href="#cb130-62" aria-hidden="true" tabindex="-1"></a><span class="co">;; Dynamic loading of Racket modules</span></span>
<span id="cb130-63"><a href="#cb130-63" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;require</span>
<span id="cb130-64"><a href="#cb130-64" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb130-65"><a href="#cb130-65" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> module-spec </span>(first args))</span>
<span id="cb130-66"><a href="#cb130-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-67"><a href="#cb130-67" aria-hidden="true" tabindex="-1"></a>    (dynamic-require module-spec <span class="dv">#f</span>)</span>
<span id="cb130-68"><a href="#cb130-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-69"><a href="#cb130-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Import specific bindings</span></span>
<span id="cb130-70"><a href="#cb130-70" aria-hidden="true" tabindex="-1"></a>    (when (<span class="kw">pair?</span> content)</span>
<span id="cb130-71"><a href="#cb130-71" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> imports </span>(first content))</span>
<span id="cb130-72"><a href="#cb130-72" aria-hidden="true" tabindex="-1"></a>      (for (<span class="op">[</span>import imports<span class="op">]</span>)</span>
<span id="cb130-73"><a href="#cb130-73" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> value </span>(dynamic-require module-spec import))</span>
<span id="cb130-74"><a href="#cb130-74" aria-hidden="true" tabindex="-1"></a>        (env-bind env import value)))</span>
<span id="cb130-75"><a href="#cb130-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-76"><a href="#cb130-76" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;require &#39;() &#39;())))</span></code></pre></div>
<h2 id="error-handling-and-debugging">Error Handling and Debugging</h2>
<p>Robust error handling is crucial for a good user experience:</p>
<div class="sourceCode" id="cb131"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; error-handling.rkt</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;interpreter.rkt&quot;</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;evaluation-model.rkt&quot;</span>)</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Error recovery strategies</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> current-error-handler</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>  (make-parameter</span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>   (λ (err)</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>     (evaluated-element &#39;error </span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>                       `((message ,(error-value-message err)))</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>                       &#39;()))))</span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; Wrap interpretation with error handling</span></span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(safe-interpret-node node env)</span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>  (with-handlers (<span class="op">[</span>exn:fail?</span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>                   (λ (e)</span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a>                     (<span class="ex">define</span><span class="fu"> err </span>(error-value </span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>                                 (exn-message e)</span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>                                 (ast-node-location node)</span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>                                 (continuation-mark-set-&gt;list</span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a>                                  (exn-continuation-marks e)</span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a>                                  &#39;shrdlu-trace)))</span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a>                     ((current-error-handler) err))<span class="op">]</span>)</span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a>    (interpret-node node env)))</span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a><span class="co">;; Try-catch for documents</span></span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;try</span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> body </span>(first content))</span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> catch-clause </span>(<span class="kw">if</span> (<span class="op">&gt;</span> (<span class="kw">length</span> content) <span class="dv">1</span>)</span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a>                            (second content)</span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">#f</span>))</span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a>    (with-handlers (<span class="op">[</span>exn:fail?</span>
<span id="cb131-37"><a href="#cb131-37" aria-hidden="true" tabindex="-1"></a>                     (λ (e)</span>
<span id="cb131-38"><a href="#cb131-38" aria-hidden="true" tabindex="-1"></a>                       (<span class="kw">if</span> catch-clause</span>
<span id="cb131-39"><a href="#cb131-39" aria-hidden="true" tabindex="-1"></a>                           (interpret-node catch-clause</span>
<span id="cb131-40"><a href="#cb131-40" aria-hidden="true" tabindex="-1"></a>                                         (env-extend env </span>
<span id="cb131-41"><a href="#cb131-41" aria-hidden="true" tabindex="-1"></a>                                                   `((<span class="kw">error</span> ,e))))</span>
<span id="cb131-42"><a href="#cb131-42" aria-hidden="true" tabindex="-1"></a>                           (<span class="kw">raise</span> e)))<span class="op">]</span>)</span>
<span id="cb131-43"><a href="#cb131-43" aria-hidden="true" tabindex="-1"></a>      (interpret-node body env))))</span>
<span id="cb131-44"><a href="#cb131-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-45"><a href="#cb131-45" aria-hidden="true" tabindex="-1"></a><span class="co">;; Assertions</span></span>
<span id="cb131-46"><a href="#cb131-46" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;assert</span>
<span id="cb131-47"><a href="#cb131-47" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb131-48"><a href="#cb131-48" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> test </span>(interpret-node (first args) env))</span>
<span id="cb131-49"><a href="#cb131-49" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> message </span>(<span class="kw">if</span> (<span class="kw">pair?</span> (rest args))</span>
<span id="cb131-50"><a href="#cb131-50" aria-hidden="true" tabindex="-1"></a>                       (second args)</span>
<span id="cb131-51"><a href="#cb131-51" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;Assertion failed&quot;</span>))</span>
<span id="cb131-52"><a href="#cb131-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-53"><a href="#cb131-53" aria-hidden="true" tabindex="-1"></a>    (unless test</span>
<span id="cb131-54"><a href="#cb131-54" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> &#39;assert <span class="st">&quot;~a&quot;</span> message))</span>
<span id="cb131-55"><a href="#cb131-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-56"><a href="#cb131-56" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;void &#39;() &#39;())))</span>
<span id="cb131-57"><a href="#cb131-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-58"><a href="#cb131-58" aria-hidden="true" tabindex="-1"></a><span class="co">;; Debugging support</span></span>
<span id="cb131-59"><a href="#cb131-59" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> debug-mode </span>(make-parameter <span class="dv">#f</span>))</span>
<span id="cb131-60"><a href="#cb131-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-61"><a href="#cb131-61" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;debug</span>
<span id="cb131-62"><a href="#cb131-62" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb131-63"><a href="#cb131-63" aria-hidden="true" tabindex="-1"></a>    (when (debug-mode)</span>
<span id="cb131-64"><a href="#cb131-64" aria-hidden="true" tabindex="-1"></a>      (printf <span class="st">&quot;Debug: ~a</span><span class="ch">\n</span><span class="st">&quot;</span> args)</span>
<span id="cb131-65"><a href="#cb131-65" aria-hidden="true" tabindex="-1"></a>      (for (<span class="op">[</span>elem content<span class="op">]</span>)</span>
<span id="cb131-66"><a href="#cb131-66" aria-hidden="true" tabindex="-1"></a>        (printf <span class="st">&quot;  ~a</span><span class="ch">\n</span><span class="st">&quot;</span> (interpret-node elem env))))</span>
<span id="cb131-67"><a href="#cb131-67" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;void &#39;() &#39;())))</span>
<span id="cb131-68"><a href="#cb131-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-69"><a href="#cb131-69" aria-hidden="true" tabindex="-1"></a><span class="co">;; Tracing</span></span>
<span id="cb131-70"><a href="#cb131-70" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> trace-stack </span>(make-parameter &#39;()))</span>
<span id="cb131-71"><a href="#cb131-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-72"><a href="#cb131-72" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(with-trace name thunk)</span>
<span id="cb131-73"><a href="#cb131-73" aria-hidden="true" tabindex="-1"></a>  (parameterize (<span class="op">[</span>trace-stack (<span class="kw">cons</span> name (trace-stack))<span class="op">]</span>)</span>
<span id="cb131-74"><a href="#cb131-74" aria-hidden="true" tabindex="-1"></a>    (with-continuation-mark &#39;shrdlu-trace name</span>
<span id="cb131-75"><a href="#cb131-75" aria-hidden="true" tabindex="-1"></a>      (thunk))))</span>
<span id="cb131-76"><a href="#cb131-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-77"><a href="#cb131-77" aria-hidden="true" tabindex="-1"></a><span class="co">;; Enhanced interpretation with tracing</span></span>
<span id="cb131-78"><a href="#cb131-78" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(traced-interpret-node node env)</span>
<span id="cb131-79"><a href="#cb131-79" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> node-desc </span></span>
<span id="cb131-80"><a href="#cb131-80" aria-hidden="true" tabindex="-1"></a>    (match node</span>
<span id="cb131-81"><a href="#cb131-81" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(command <span class="op">_</span> name <span class="op">_</span> <span class="op">_</span>) (format <span class="st">&quot;command:~a&quot;</span> name)<span class="op">]</span></span>
<span id="cb131-82"><a href="#cb131-82" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(definition <span class="op">_</span> name <span class="op">_</span> <span class="op">_</span>) (format <span class="st">&quot;def:~a&quot;</span> name)<span class="op">]</span></span>
<span id="cb131-83"><a href="#cb131-83" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span> (format <span class="st">&quot;~a&quot;</span> (ast-node-type node))<span class="op">]</span>))</span>
<span id="cb131-84"><a href="#cb131-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-85"><a href="#cb131-85" aria-hidden="true" tabindex="-1"></a>  (with-trace node-desc</span>
<span id="cb131-86"><a href="#cb131-86" aria-hidden="true" tabindex="-1"></a>    (λ () (interpret-node node env))))</span></code></pre></div>
<h2 id="caching-and-optimization">Caching and Optimization</h2>
<p>For large documents with expensive computations, caching is
essential:</p>
<div class="sourceCode" id="cb132"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; caching.rkt</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;interpreter.rkt&quot;</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;evaluation-model.rkt&quot;</span>)</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Global cache</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> computation-cache </span>(make-hash))</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; Cache key generation</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-cache-key node env)</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> env-bindings </span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>    (sort (hash-&gt;list (environment-bindings env))</span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>          <span class="kw">string&lt;?</span> </span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>          #:key (compose <span class="kw">symbol-&gt;string</span> <span class="kw">car</span>)))</span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">list</span> node env-bindings))</span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a><span class="co">;; Memoized interpretation</span></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(memoized-interpret-node node env)</span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> key </span>(make-cache-key node env))</span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a>  (hash-ref! computation-cache key</span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a>             (λ () (interpret-node node env))))</span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true" tabindex="-1"></a><span class="co">;; Explicit caching command</span></span>
<span id="cb132-25"><a href="#cb132-25" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;cache</span>
<span id="cb132-26"><a href="#cb132-26" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb132-27"><a href="#cb132-27" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> key-expr </span>(first args))</span>
<span id="cb132-28"><a href="#cb132-28" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> body </span>(first content))</span>
<span id="cb132-29"><a href="#cb132-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-30"><a href="#cb132-30" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> key </span>(interpret-node key-expr env))</span>
<span id="cb132-31"><a href="#cb132-31" aria-hidden="true" tabindex="-1"></a>    (hash-ref! computation-cache key</span>
<span id="cb132-32"><a href="#cb132-32" aria-hidden="true" tabindex="-1"></a>               (λ () (interpret-node body env)))))</span>
<span id="cb132-33"><a href="#cb132-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-34"><a href="#cb132-34" aria-hidden="true" tabindex="-1"></a><span class="co">;; Lazy evaluation</span></span>
<span id="cb132-35"><a href="#cb132-35" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;lazy</span>
<span id="cb132-36"><a href="#cb132-36" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb132-37"><a href="#cb132-37" aria-hidden="true" tabindex="-1"></a>    (thunk (λ () (interpret-node (first content) env))</span>
<span id="cb132-38"><a href="#cb132-38" aria-hidden="true" tabindex="-1"></a>           env)))</span>
<span id="cb132-39"><a href="#cb132-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-40"><a href="#cb132-40" aria-hidden="true" tabindex="-1"></a><span class="co">;; Force lazy values</span></span>
<span id="cb132-41"><a href="#cb132-41" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;force</span>
<span id="cb132-42"><a href="#cb132-42" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb132-43"><a href="#cb132-43" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> val </span>(interpret-node (first args) env))</span>
<span id="cb132-44"><a href="#cb132-44" aria-hidden="true" tabindex="-1"></a>    (force-value val)))</span>
<span id="cb132-45"><a href="#cb132-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-46"><a href="#cb132-46" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parallel evaluation</span></span>
<span id="cb132-47"><a href="#cb132-47" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;parallel</span>
<span id="cb132-48"><a href="#cb132-48" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb132-49"><a href="#cb132-49" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> futures</span></span>
<span id="cb132-50"><a href="#cb132-50" aria-hidden="true" tabindex="-1"></a>      (for/list (<span class="op">[</span>expr content<span class="op">]</span>)</span>
<span id="cb132-51"><a href="#cb132-51" aria-hidden="true" tabindex="-1"></a>        (future (λ () (interpret-node expr env)))))</span>
<span id="cb132-52"><a href="#cb132-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb132-53"><a href="#cb132-53" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;sequence &#39;()</span>
<span id="cb132-54"><a href="#cb132-54" aria-hidden="true" tabindex="-1"></a>                      (map touch futures))))</span></code></pre></div>
<h2 id="integration-with-external-tools">Integration with External
Tools</h2>
<p>Shrdlu can integrate with external programs:</p>
<div class="sourceCode" id="cb133"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; external-integration.rkt</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;interpreter.rkt&quot;</span>)</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Run external command</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;exec</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> cmd </span>(first args))</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> cmd-args </span>(rest args))</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>    (define-values (proc stdout stdin stderr)</span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>      (subprocess <span class="dv">#f</span> <span class="dv">#f</span> <span class="dv">#f</span> </span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>                  (find-executable-path cmd)</span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a>                  cmd-args))</span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Send input if provided</span></span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a>    (when (<span class="kw">pair?</span> content)</span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> input </span>(interpret-node (first content) env))</span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a>      (write-string input stdin)</span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">close-output-port</span> stdin))</span>
<span id="cb133-22"><a href="#cb133-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb133-23"><a href="#cb133-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Read output</span></span>
<span id="cb133-24"><a href="#cb133-24" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> output </span>(port-&gt;string stdout))</span>
<span id="cb133-25"><a href="#cb133-25" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">close-input-port</span> stdout)</span>
<span id="cb133-26"><a href="#cb133-26" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">close-input-port</span> stderr)</span>
<span id="cb133-27"><a href="#cb133-27" aria-hidden="true" tabindex="-1"></a>    (subprocess-wait proc)</span>
<span id="cb133-28"><a href="#cb133-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb133-29"><a href="#cb133-29" aria-hidden="true" tabindex="-1"></a>    output))</span>
<span id="cb133-30"><a href="#cb133-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-31"><a href="#cb133-31" aria-hidden="true" tabindex="-1"></a><span class="co">;; Language-specific evaluation</span></span>
<span id="cb133-32"><a href="#cb133-32" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;eval-python</span>
<span id="cb133-33"><a href="#cb133-33" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb133-34"><a href="#cb133-34" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> code </span>(first content))</span>
<span id="cb133-35"><a href="#cb133-35" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> result</span></span>
<span id="cb133-36"><a href="#cb133-36" aria-hidden="true" tabindex="-1"></a>      (with-output-to-string</span>
<span id="cb133-37"><a href="#cb133-37" aria-hidden="true" tabindex="-1"></a>        (λ ()</span>
<span id="cb133-38"><a href="#cb133-38" aria-hidden="true" tabindex="-1"></a>          (system* (find-executable-path <span class="st">&quot;python3&quot;</span>)</span>
<span id="cb133-39"><a href="#cb133-39" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;-c&quot;</span> code))))</span>
<span id="cb133-40"><a href="#cb133-40" aria-hidden="true" tabindex="-1"></a>    result))</span>
<span id="cb133-41"><a href="#cb133-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-42"><a href="#cb133-42" aria-hidden="true" tabindex="-1"></a><span class="co">;; Database queries</span></span>
<span id="cb133-43"><a href="#cb133-43" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;query</span>
<span id="cb133-44"><a href="#cb133-44" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb133-45"><a href="#cb133-45" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> db-path </span>(assoc-ref args &#39;db))</span>
<span id="cb133-46"><a href="#cb133-46" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> query </span>(first content))</span>
<span id="cb133-47"><a href="#cb133-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb133-48"><a href="#cb133-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; In real implementation, would use db library</span></span>
<span id="cb133-49"><a href="#cb133-49" aria-hidden="true" tabindex="-1"></a>    (evaluated-element &#39;table &#39;() </span>
<span id="cb133-50"><a href="#cb133-50" aria-hidden="true" tabindex="-1"></a>                      &#39;((<span class="st">&quot;Results&quot;</span> <span class="st">&quot;would&quot;</span> <span class="st">&quot;go&quot;</span> <span class="st">&quot;here&quot;</span>)))))</span>
<span id="cb133-51"><a href="#cb133-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-52"><a href="#cb133-52" aria-hidden="true" tabindex="-1"></a><span class="co">;; HTTP requests</span></span>
<span id="cb133-53"><a href="#cb133-53" aria-hidden="true" tabindex="-1"></a>(register-command! &#39;fetch</span>
<span id="cb133-54"><a href="#cb133-54" aria-hidden="true" tabindex="-1"></a>  (λ (args content env)</span>
<span id="cb133-55"><a href="#cb133-55" aria-hidden="true" tabindex="-1"></a>    (require net/http-client)</span>
<span id="cb133-56"><a href="#cb133-56" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> url </span>(first args))</span>
<span id="cb133-57"><a href="#cb133-57" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> method </span>(assoc-ref args &#39;method <span class="st">&quot;GET&quot;</span>))</span>
<span id="cb133-58"><a href="#cb133-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb133-59"><a href="#cb133-59" aria-hidden="true" tabindex="-1"></a>    (define-values (status headers in)</span>
<span id="cb133-60"><a href="#cb133-60" aria-hidden="true" tabindex="-1"></a>      (http-sendrecv (url-host url)</span>
<span id="cb133-61"><a href="#cb133-61" aria-hidden="true" tabindex="-1"></a>                     (url-path url)</span>
<span id="cb133-62"><a href="#cb133-62" aria-hidden="true" tabindex="-1"></a>                     #:method method))</span>
<span id="cb133-63"><a href="#cb133-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb133-64"><a href="#cb133-64" aria-hidden="true" tabindex="-1"></a>    (port-&gt;string in)))</span></code></pre></div>
<h2 id="testing-the-interpreter">Testing the Interpreter</h2>
<p>Comprehensive tests ensure correctness:</p>
<div class="sourceCode" id="cb134"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; test-interpreter.rkt</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>(require rackunit</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;interpreter.rkt&quot;</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;parser.rkt&quot;</span>)</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Helper to interpret strings</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(eval-shrdlu str)</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>  (interpret-document (parse-string str)))</span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Basic interpretation</span></span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Basic text and commands&quot;</span></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> result </span>(eval-shrdlu <span class="st">&quot;@p{Hello @em{world}}&quot;</span>))</span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> (evaluated-doc-elements result)) <span class="dv">1</span>))</span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a><span class="co">;; Variables and computation</span></span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Variable binding and reference&quot;</span></span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> result </span>(eval-shrdlu </span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;@define[x 42]</span></span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a><span class="st">                   The answer is @x&quot;</span>))</span>
<span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> elements </span>(evaluated-doc-elements result))</span>
<span id="cb134-23"><a href="#cb134-23" aria-hidden="true" tabindex="-1"></a>  (check-equal? (evaluated-element-content (second elements))</span>
<span id="cb134-24"><a href="#cb134-24" aria-hidden="true" tabindex="-1"></a>                <span class="dv">42</span>))</span>
<span id="cb134-25"><a href="#cb134-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-26"><a href="#cb134-26" aria-hidden="true" tabindex="-1"></a><span class="co">;; Functions</span></span>
<span id="cb134-27"><a href="#cb134-27" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Function definition and application&quot;</span></span>
<span id="cb134-28"><a href="#cb134-28" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> result </span>(eval-shrdlu</span>
<span id="cb134-29"><a href="#cb134-29" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;@define[square x]{@* [x x]}</span></span>
<span id="cb134-30"><a href="#cb134-30" aria-hidden="true" tabindex="-1"></a><span class="st">                   @square[7]&quot;</span>))</span>
<span id="cb134-31"><a href="#cb134-31" aria-hidden="true" tabindex="-1"></a>  (check-equal? (evaluated-element-content (second (evaluated-doc-elements result)))</span>
<span id="cb134-32"><a href="#cb134-32" aria-hidden="true" tabindex="-1"></a>                <span class="dv">49</span>))</span>
<span id="cb134-33"><a href="#cb134-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-34"><a href="#cb134-34" aria-hidden="true" tabindex="-1"></a><span class="co">;; Control flow</span></span>
<span id="cb134-35"><a href="#cb134-35" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Conditionals&quot;</span></span>
<span id="cb134-36"><a href="#cb134-36" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> result </span>(eval-shrdlu</span>
<span id="cb134-37"><a href="#cb134-37" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;@define[x 10]</span></span>
<span id="cb134-38"><a href="#cb134-38" aria-hidden="true" tabindex="-1"></a><span class="st">                   @if[@&gt; [x 5]]{big}{small}&quot;</span>))</span>
<span id="cb134-39"><a href="#cb134-39" aria-hidden="true" tabindex="-1"></a>  (check-equal? (evaluated-element-content </span>
<span id="cb134-40"><a href="#cb134-40" aria-hidden="true" tabindex="-1"></a>                 (second (evaluated-doc-elements result)))</span>
<span id="cb134-41"><a href="#cb134-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;big&quot;</span>))</span>
<span id="cb134-42"><a href="#cb134-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-43"><a href="#cb134-43" aria-hidden="true" tabindex="-1"></a><span class="co">;; Loops</span></span>
<span id="cb134-44"><a href="#cb134-44" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;For loops&quot;</span>  </span>
<span id="cb134-45"><a href="#cb134-45" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> result </span>(eval-shrdlu</span>
<span id="cb134-46"><a href="#cb134-46" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;@for[i @in [@range[3]]]{@i }&quot;</span>))</span>
<span id="cb134-47"><a href="#cb134-47" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> elements </span>(evaluated-element-content </span>
<span id="cb134-48"><a href="#cb134-48" aria-hidden="true" tabindex="-1"></a>                   (first (evaluated-doc-elements result))))</span>
<span id="cb134-49"><a href="#cb134-49" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> elements) <span class="dv">3</span>))</span>
<span id="cb134-50"><a href="#cb134-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-51"><a href="#cb134-51" aria-hidden="true" tabindex="-1"></a><span class="co">;; Templates</span></span>
<span id="cb134-52"><a href="#cb134-52" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Template definition and instantiation&quot;</span></span>
<span id="cb134-53"><a href="#cb134-53" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> result </span>(eval-shrdlu</span>
<span id="cb134-54"><a href="#cb134-54" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;@define-template[card #:title #:body]{</span></span>
<span id="cb134-55"><a href="#cb134-55" aria-hidden="true" tabindex="-1"></a><span class="st">                    @div[#:class </span><span class="ch">\&quot;</span><span class="st">card</span><span class="ch">\&quot;</span><span class="st">]{</span></span>
<span id="cb134-56"><a href="#cb134-56" aria-hidden="true" tabindex="-1"></a><span class="st">                      @h2{@title}</span></span>
<span id="cb134-57"><a href="#cb134-57" aria-hidden="true" tabindex="-1"></a><span class="st">                      @p{@body}</span></span>
<span id="cb134-58"><a href="#cb134-58" aria-hidden="true" tabindex="-1"></a><span class="st">                    }</span></span>
<span id="cb134-59"><a href="#cb134-59" aria-hidden="true" tabindex="-1"></a><span class="st">                  }</span></span>
<span id="cb134-60"><a href="#cb134-60" aria-hidden="true" tabindex="-1"></a><span class="st">                  @instantiate[card #:title </span><span class="ch">\&quot;</span><span class="st">Hello</span><span class="ch">\&quot;</span><span class="st"> #:body </span><span class="ch">\&quot;</span><span class="st">World</span><span class="ch">\&quot;</span><span class="st">]&quot;</span>))</span>
<span id="cb134-61"><a href="#cb134-61" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check structure of instantiated template</span></span>
<span id="cb134-62"><a href="#cb134-62" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb134-63"><a href="#cb134-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-64"><a href="#cb134-64" aria-hidden="true" tabindex="-1"></a><span class="co">;; Error handling</span></span>
<span id="cb134-65"><a href="#cb134-65" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Error recovery&quot;</span></span>
<span id="cb134-66"><a href="#cb134-66" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> result </span>(eval-shrdlu</span>
<span id="cb134-67"><a href="#cb134-67" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;@try{</span></span>
<span id="cb134-68"><a href="#cb134-68" aria-hidden="true" tabindex="-1"></a><span class="st">                    @error[</span><span class="ch">\&quot;</span><span class="st">Something went wrong</span><span class="ch">\&quot;</span><span class="st">]</span></span>
<span id="cb134-69"><a href="#cb134-69" aria-hidden="true" tabindex="-1"></a><span class="st">                  }{</span></span>
<span id="cb134-70"><a href="#cb134-70" aria-hidden="true" tabindex="-1"></a><span class="st">                    Error caught!</span></span>
<span id="cb134-71"><a href="#cb134-71" aria-hidden="true" tabindex="-1"></a><span class="st">                  }&quot;</span>))</span>
<span id="cb134-72"><a href="#cb134-72" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Should contain &quot;Error caught!&quot;</span></span>
<span id="cb134-73"><a href="#cb134-73" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb134-74"><a href="#cb134-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-75"><a href="#cb134-75" aria-hidden="true" tabindex="-1"></a><span class="co">;; Performance benchmarks</span></span>
<span id="cb134-76"><a href="#cb134-76" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(benchmark-fibonacci n)</span>
<span id="cb134-77"><a href="#cb134-77" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> program </span>(format <span class="st">&quot;@define[fib n]{</span></span>
<span id="cb134-78"><a href="#cb134-78" aria-hidden="true" tabindex="-1"></a><span class="st">                            @if[@&lt; [n 2]]{n}{</span></span>
<span id="cb134-79"><a href="#cb134-79" aria-hidden="true" tabindex="-1"></a><span class="st">                              @+ [@fib[@- [n 1]]]</span></span>
<span id="cb134-80"><a href="#cb134-80" aria-hidden="true" tabindex="-1"></a><span class="st">                                 [@fib[@- [n 2]]]</span></span>
<span id="cb134-81"><a href="#cb134-81" aria-hidden="true" tabindex="-1"></a><span class="st">                            }</span></span>
<span id="cb134-82"><a href="#cb134-82" aria-hidden="true" tabindex="-1"></a><span class="st">                          }</span></span>
<span id="cb134-83"><a href="#cb134-83" aria-hidden="true" tabindex="-1"></a><span class="st">                          @fib[~a]&quot;</span> n))</span>
<span id="cb134-84"><a href="#cb134-84" aria-hidden="true" tabindex="-1"></a>  (time (eval-shrdlu program)))</span></code></pre></div>
<h2 id="the-document-model">The Document Model</h2>
<p>After interpretation, we have an evaluated document. This needs to be
transformed into a document model suitable for rendering:</p>
<div class="sourceCode" id="cb135"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; document-model.rkt</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>(provide (all-defined-out))</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Document model structures</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>(struct doc-model </span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>  (metadata    <span class="co">; hash of metadata</span></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>   sections    <span class="co">; list of sections</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>   references  <span class="co">; hash of label -&gt; target</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>   footnotes   <span class="co">; list of footnotes</span></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>   citations   <span class="co">; list of citations</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>   figures     <span class="co">; list of figures</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>   tables)     <span class="co">; list of tables</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build document model from evaluated document</span></span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-document-model evaluated-doc)</span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> sections </span>&#39;())</span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> references </span>(make-hash))</span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> footnotes </span>&#39;())</span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> citations </span>&#39;())</span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> figures </span>&#39;()) </span>
<span id="cb135-24"><a href="#cb135-24" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tables </span>&#39;())</span>
<span id="cb135-25"><a href="#cb135-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-26"><a href="#cb135-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Walk the evaluated document</span></span>
<span id="cb135-27"><a href="#cb135-27" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(process-element elem path)</span>
<span id="cb135-28"><a href="#cb135-28" aria-hidden="true" tabindex="-1"></a>    (match elem</span>
<span id="cb135-29"><a href="#cb135-29" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(evaluated-element &#39;section attrs content)</span>
<span id="cb135-30"><a href="#cb135-30" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> label </span>(<span class="kw">assoc</span> &#39;label attrs))</span>
<span id="cb135-31"><a href="#cb135-31" aria-hidden="true" tabindex="-1"></a>       (when label</span>
<span id="cb135-32"><a href="#cb135-32" aria-hidden="true" tabindex="-1"></a>         (hash-set! references (<span class="kw">cadr</span> label) path))</span>
<span id="cb135-33"><a href="#cb135-33" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> section-content</span></span>
<span id="cb135-34"><a href="#cb135-34" aria-hidden="true" tabindex="-1"></a>         (for/list (<span class="op">[</span>child content<span class="op">]</span></span>
<span id="cb135-35"><a href="#cb135-35" aria-hidden="true" tabindex="-1"></a>                    <span class="op">[</span>idx (in-naturals)<span class="op">]</span>)</span>
<span id="cb135-36"><a href="#cb135-36" aria-hidden="true" tabindex="-1"></a>           (process-element child (<span class="kw">append</span> path (<span class="kw">list</span> idx)))))</span>
<span id="cb135-37"><a href="#cb135-37" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> sections (<span class="kw">append</span> sections (<span class="kw">list</span> elem)))<span class="op">]</span></span>
<span id="cb135-38"><a href="#cb135-38" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb135-39"><a href="#cb135-39" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(evaluated-element &#39;ref attrs <span class="op">_</span>)</span>
<span id="cb135-40"><a href="#cb135-40" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> target </span>(<span class="kw">assoc</span> &#39;target attrs))</span>
<span id="cb135-41"><a href="#cb135-41" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Record reference for later resolution</span></span>
<span id="cb135-42"><a href="#cb135-42" aria-hidden="true" tabindex="-1"></a>       elem<span class="op">]</span></span>
<span id="cb135-43"><a href="#cb135-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb135-44"><a href="#cb135-44" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(evaluated-element &#39;footnote attrs content)</span>
<span id="cb135-45"><a href="#cb135-45" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> note-num </span>(add1 (<span class="kw">length</span> footnotes)))</span>
<span id="cb135-46"><a href="#cb135-46" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> footnotes (<span class="kw">append</span> footnotes (<span class="kw">list</span> elem)))</span>
<span id="cb135-47"><a href="#cb135-47" aria-hidden="true" tabindex="-1"></a>       (evaluated-element &#39;footnote-ref `((num ,note-num)) &#39;())<span class="op">]</span></span>
<span id="cb135-48"><a href="#cb135-48" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb135-49"><a href="#cb135-49" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(evaluated-element &#39;cite attrs <span class="op">_</span>)</span>
<span id="cb135-50"><a href="#cb135-50" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> citations (<span class="kw">append</span> citations (<span class="kw">list</span> elem)))</span>
<span id="cb135-51"><a href="#cb135-51" aria-hidden="true" tabindex="-1"></a>       elem<span class="op">]</span></span>
<span id="cb135-52"><a href="#cb135-52" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb135-53"><a href="#cb135-53" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(evaluated-element &#39;figure attrs content)</span>
<span id="cb135-54"><a href="#cb135-54" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> figures (<span class="kw">append</span> figures (<span class="kw">list</span> elem)))</span>
<span id="cb135-55"><a href="#cb135-55" aria-hidden="true" tabindex="-1"></a>       elem<span class="op">]</span></span>
<span id="cb135-56"><a href="#cb135-56" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb135-57"><a href="#cb135-57" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(evaluated-element &#39;table attrs content)</span>
<span id="cb135-58"><a href="#cb135-58" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> tables (<span class="kw">append</span> tables (<span class="kw">list</span> elem)))</span>
<span id="cb135-59"><a href="#cb135-59" aria-hidden="true" tabindex="-1"></a>       elem<span class="op">]</span></span>
<span id="cb135-60"><a href="#cb135-60" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb135-61"><a href="#cb135-61" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span> elem<span class="op">]</span>))</span>
<span id="cb135-62"><a href="#cb135-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-63"><a href="#cb135-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Process all elements</span></span>
<span id="cb135-64"><a href="#cb135-64" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>elem (evaluated-doc-elements evaluated-doc)<span class="op">]</span></span>
<span id="cb135-65"><a href="#cb135-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>idx (in-naturals)<span class="op">]</span>)</span>
<span id="cb135-66"><a href="#cb135-66" aria-hidden="true" tabindex="-1"></a>    (process-element elem (<span class="kw">list</span> idx)))</span>
<span id="cb135-67"><a href="#cb135-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-68"><a href="#cb135-68" aria-hidden="true" tabindex="-1"></a>  (doc-model (evaluated-doc-metadata evaluated-doc)</span>
<span id="cb135-69"><a href="#cb135-69" aria-hidden="true" tabindex="-1"></a>             sections</span>
<span id="cb135-70"><a href="#cb135-70" aria-hidden="true" tabindex="-1"></a>             references</span>
<span id="cb135-71"><a href="#cb135-71" aria-hidden="true" tabindex="-1"></a>             footnotes</span>
<span id="cb135-72"><a href="#cb135-72" aria-hidden="true" tabindex="-1"></a>             citations</span>
<span id="cb135-73"><a href="#cb135-73" aria-hidden="true" tabindex="-1"></a>             figures</span>
<span id="cb135-74"><a href="#cb135-74" aria-hidden="true" tabindex="-1"></a>             tables))</span>
<span id="cb135-75"><a href="#cb135-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-76"><a href="#cb135-76" aria-hidden="true" tabindex="-1"></a><span class="co">;; Cross-reference resolution</span></span>
<span id="cb135-77"><a href="#cb135-77" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(resolve-references doc-model)</span>
<span id="cb135-78"><a href="#cb135-78" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Second pass to resolve all references</span></span>
<span id="cb135-79"><a href="#cb135-79" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(resolve-element elem)</span>
<span id="cb135-80"><a href="#cb135-80" aria-hidden="true" tabindex="-1"></a>    (match elem</span>
<span id="cb135-81"><a href="#cb135-81" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(evaluated-element &#39;ref attrs <span class="op">_</span>)</span>
<span id="cb135-82"><a href="#cb135-82" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> target </span>(<span class="kw">cadr</span> (<span class="kw">assoc</span> &#39;target attrs)))</span>
<span id="cb135-83"><a href="#cb135-83" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> path </span>(hash-ref (doc-model-references doc-model) </span>
<span id="cb135-84"><a href="#cb135-84" aria-hidden="true" tabindex="-1"></a>                             target </span>
<span id="cb135-85"><a href="#cb135-85" aria-hidden="true" tabindex="-1"></a>                             <span class="dv">#f</span>))</span>
<span id="cb135-86"><a href="#cb135-86" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">if</span> path</span>
<span id="cb135-87"><a href="#cb135-87" aria-hidden="true" tabindex="-1"></a>           (evaluated-element &#39;ref </span>
<span id="cb135-88"><a href="#cb135-88" aria-hidden="true" tabindex="-1"></a>                            `((target ,target)</span>
<span id="cb135-89"><a href="#cb135-89" aria-hidden="true" tabindex="-1"></a>                              (path ,path))</span>
<span id="cb135-90"><a href="#cb135-90" aria-hidden="true" tabindex="-1"></a>                            &#39;())</span>
<span id="cb135-91"><a href="#cb135-91" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">error</span> &#39;ref <span class="st">&quot;Undefined reference: ~a&quot;</span> target))<span class="op">]</span></span>
<span id="cb135-92"><a href="#cb135-92" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb135-93"><a href="#cb135-93" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(evaluated-element type attrs content)</span>
<span id="cb135-94"><a href="#cb135-94" aria-hidden="true" tabindex="-1"></a>       (evaluated-element type attrs</span>
<span id="cb135-95"><a href="#cb135-95" aria-hidden="true" tabindex="-1"></a>                         (map resolve-element content))<span class="op">]</span></span>
<span id="cb135-96"><a href="#cb135-96" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb135-97"><a href="#cb135-97" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span> elem<span class="op">]</span>))</span>
<span id="cb135-98"><a href="#cb135-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-99"><a href="#cb135-99" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Update model with resolved references</span></span>
<span id="cb135-100"><a href="#cb135-100" aria-hidden="true" tabindex="-1"></a>  (struct-copy doc-model doc-model</span>
<span id="cb135-101"><a href="#cb135-101" aria-hidden="true" tabindex="-1"></a>               <span class="op">[</span>sections (map resolve-element </span>
<span id="cb135-102"><a href="#cb135-102" aria-hidden="true" tabindex="-1"></a>                             (doc-model-sections doc-model))<span class="op">]</span>))</span></code></pre></div>
<h2 id="summary-4">Summary</h2>
<p>In this chapter, we’ve built a sophisticated interpreter for the
Shrdlu markup language that:</p>
<ol type="1">
<li><strong>Evaluates Computations</strong>: Turning a static document
into a dynamic one</li>
<li><strong>Manages Environments</strong>: Proper lexical scoping for
variables and functions</li>
<li><strong>Provides Control Flow</strong>: Conditionals, loops, and
pattern matching</li>
<li><strong>Supports Templates</strong>: Reusable, parameterized
document fragments</li>
<li><strong>Integrates Data</strong>: Loading and processing external
data sources</li>
<li><strong>Handles Errors Gracefully</strong>: With try-catch and
debugging support</li>
<li><strong>Optimizes Performance</strong>: Through caching and lazy
evaluation</li>
</ol>
<p>The interpreter bridges the gap between markup and programming,
allowing documents to be truly computational. In the next chapter, we’ll
explore how to take these interpreted documents and render them to
multiple output formats, completing the journey from source to final
document.</p>
<h3 id="exercises-2">Exercises</h3>
<ol type="1">
<li><p><strong>Macro System</strong>: Implement a macro system that
allows users to define new syntactic forms that expand at interpretation
time.</p></li>
<li><p><strong>Type Checking</strong>: Add optional type annotations and
implement a simple type checker that runs before
interpretation.</p></li>
<li><p><strong>Streaming Interpretation</strong>: Modify the interpreter
to work in a streaming fashion, producing output as it goes rather than
building the entire result in memory.</p></li>
<li><p><strong>Sandboxing</strong>: Implement security restrictions to
safely run untrusted Shrdlu documents, limiting file system access and
execution time.</p></li>
<li><p><strong>Incremental Evaluation</strong>: Create an incremental
interpreter that can efficiently re-evaluate only changed portions of a
document.</p></li>
<li><p><strong>Custom Environments</strong>: Design a system for
creating custom evaluation environments with different sets of built-in
functions for different document types (e.g., academic papers vs. blog
posts). # Chapter 6: Document Model and Intermediate
Representation</p></li>
</ol>
<h2 id="the-need-for-an-intermediate-representation">The Need for an
Intermediate Representation</h2>
<p>Between the interpreted AST and the final rendered output lies a
critical abstraction: the document model. This intermediate
representation (IR) serves as the bridge between computation and
presentation, decoupling the semantic structure of a document from its
various output formats.</p>
<p>Consider the journey of a cross-reference: it begins as
<code>@ref[theorem:fermat]</code> in the source, becomes a reference
node in the AST, gets resolved to a specific section during
interpretation, and finally renders as “Theorem 3.2” in PDF,
<code>&lt;a href="#theorem-fermat"&gt;Theorem 3.2&lt;/a&gt;</code> in
HTML, and a hyperlinked reference in EPUB. The document model is where
this transformation crystallizes.</p>
<p>The IR must satisfy several competing demands: - <strong>Format
Independence</strong>: Rich enough to support all target formats without
bias - <strong>Semantic Preservation</strong>: Maintaining the meaning
and relationships of content - <strong>Optimization
Opportunities</strong>: Enabling efficient rendering and caching -
<strong>Extensibility</strong>: Supporting custom elements and future
format additions</p>
<h2 id="core-document-model-architecture">Core Document Model
Architecture</h2>
<div class="sourceCode" id="cb136"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; document-model.rkt</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>(provide (all-defined-out))</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Base node type with common attributes</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>(struct node </span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>  (id           <span class="co">; unique identifier</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>   class        <span class="co">; semantic class (paragraph, heading, etc.)</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>   attributes   <span class="co">; hash of attributes</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>   metadata     <span class="co">; hash of metadata</span></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>   children)    <span class="co">; list of child nodes</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>  #:transparent</span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>  #:mutable)</span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a><span class="co">;; Document root</span></span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>(struct document node</span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>  (title        <span class="co">; document title</span></span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>   authors      <span class="co">; list of author info</span></span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>   date         <span class="co">; publication date</span></span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>   abstract     <span class="co">; abstract content</span></span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a>   sections     <span class="co">; main content sections</span></span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a>   appendices   <span class="co">; appendix sections</span></span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a>   bibliography <span class="co">; bibliography entries</span></span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a>   index        <span class="co">; index entries</span></span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a>   styles       <span class="co">; custom styles</span></span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a>   scripts)     <span class="co">; embedded scripts</span></span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb136-29"><a href="#cb136-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-30"><a href="#cb136-30" aria-hidden="true" tabindex="-1"></a><span class="co">;; Structural elements</span></span>
<span id="cb136-31"><a href="#cb136-31" aria-hidden="true" tabindex="-1"></a>(struct section node</span>
<span id="cb136-32"><a href="#cb136-32" aria-hidden="true" tabindex="-1"></a>  (level       <span class="co">; 1-6, heading level</span></span>
<span id="cb136-33"><a href="#cb136-33" aria-hidden="true" tabindex="-1"></a>   number      <span class="co">; section number (e.g., &quot;3.2.1&quot;)</span></span>
<span id="cb136-34"><a href="#cb136-34" aria-hidden="true" tabindex="-1"></a>   title       <span class="co">; section title</span></span>
<span id="cb136-35"><a href="#cb136-35" aria-hidden="true" tabindex="-1"></a>   label)      <span class="co">; reference label</span></span>
<span id="cb136-36"><a href="#cb136-36" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb136-37"><a href="#cb136-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-38"><a href="#cb136-38" aria-hidden="true" tabindex="-1"></a>(struct paragraph node () #:transparent)</span>
<span id="cb136-39"><a href="#cb136-39" aria-hidden="true" tabindex="-1"></a>(struct block-quote node (cite) #:transparent)</span>
<span id="cb136-40"><a href="#cb136-40" aria-hidden="true" tabindex="-1"></a>(struct list-container node (ordered start-num) #:transparent)</span>
<span id="cb136-41"><a href="#cb136-41" aria-hidden="true" tabindex="-1"></a>(struct list-item node (marker) #:transparent)</span>
<span id="cb136-42"><a href="#cb136-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-43"><a href="#cb136-43" aria-hidden="true" tabindex="-1"></a><span class="co">;; Inline elements  </span></span>
<span id="cb136-44"><a href="#cb136-44" aria-hidden="true" tabindex="-1"></a>(struct text-run node (content) #:transparent)</span>
<span id="cb136-45"><a href="#cb136-45" aria-hidden="true" tabindex="-1"></a>(struct emphasis node (level) #:transparent)  <span class="co">; 1=em, 2=strong</span></span>
<span id="cb136-46"><a href="#cb136-46" aria-hidden="true" tabindex="-1"></a>(struct code-inline node (language) #:transparent)</span>
<span id="cb136-47"><a href="#cb136-47" aria-hidden="true" tabindex="-1"></a>(struct hyperlink node (href title) #:transparent)</span>
<span id="cb136-48"><a href="#cb136-48" aria-hidden="true" tabindex="-1"></a>(struct footnote-ref node (number target) #:transparent)</span>
<span id="cb136-49"><a href="#cb136-49" aria-hidden="true" tabindex="-1"></a>(struct citation node (key) #:transparent)</span>
<span id="cb136-50"><a href="#cb136-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-51"><a href="#cb136-51" aria-hidden="true" tabindex="-1"></a><span class="co">;; Block elements</span></span>
<span id="cb136-52"><a href="#cb136-52" aria-hidden="true" tabindex="-1"></a>(struct code-block node </span>
<span id="cb136-53"><a href="#cb136-53" aria-hidden="true" tabindex="-1"></a>  (language    <span class="co">; programming language</span></span>
<span id="cb136-54"><a href="#cb136-54" aria-hidden="true" tabindex="-1"></a>   executable  <span class="co">; can be executed?</span></span>
<span id="cb136-55"><a href="#cb136-55" aria-hidden="true" tabindex="-1"></a>   output)     <span class="co">; execution output</span></span>
<span id="cb136-56"><a href="#cb136-56" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb136-57"><a href="#cb136-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-58"><a href="#cb136-58" aria-hidden="true" tabindex="-1"></a>(struct equation node</span>
<span id="cb136-59"><a href="#cb136-59" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">display</span>     <span class="co">; inline or display</span></span>
<span id="cb136-60"><a href="#cb136-60" aria-hidden="true" tabindex="-1"></a>   numbered    <span class="co">; has equation number?</span></span>
<span id="cb136-61"><a href="#cb136-61" aria-hidden="true" tabindex="-1"></a>   label)      <span class="co">; reference label</span></span>
<span id="cb136-62"><a href="#cb136-62" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb136-63"><a href="#cb136-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-64"><a href="#cb136-64" aria-hidden="true" tabindex="-1"></a>(struct figure node</span>
<span id="cb136-65"><a href="#cb136-65" aria-hidden="true" tabindex="-1"></a>  (caption     <span class="co">; figure caption</span></span>
<span id="cb136-66"><a href="#cb136-66" aria-hidden="true" tabindex="-1"></a>   label       <span class="co">; reference label  </span></span>
<span id="cb136-67"><a href="#cb136-67" aria-hidden="true" tabindex="-1"></a>   source      <span class="co">; image source</span></span>
<span id="cb136-68"><a href="#cb136-68" aria-hidden="true" tabindex="-1"></a>   width       <span class="co">; display width</span></span>
<span id="cb136-69"><a href="#cb136-69" aria-hidden="true" tabindex="-1"></a>   height)     <span class="co">; display height</span></span>
<span id="cb136-70"><a href="#cb136-70" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb136-71"><a href="#cb136-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-72"><a href="#cb136-72" aria-hidden="true" tabindex="-1"></a>(struct table node</span>
<span id="cb136-73"><a href="#cb136-73" aria-hidden="true" tabindex="-1"></a>  (caption     <span class="co">; table caption</span></span>
<span id="cb136-74"><a href="#cb136-74" aria-hidden="true" tabindex="-1"></a>   label       <span class="co">; reference label</span></span>
<span id="cb136-75"><a href="#cb136-75" aria-hidden="true" tabindex="-1"></a>   headers     <span class="co">; column headers</span></span>
<span id="cb136-76"><a href="#cb136-76" aria-hidden="true" tabindex="-1"></a>   rows        <span class="co">; table rows</span></span>
<span id="cb136-77"><a href="#cb136-77" aria-hidden="true" tabindex="-1"></a>   alignment)  <span class="co">; column alignment</span></span>
<span id="cb136-78"><a href="#cb136-78" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb136-79"><a href="#cb136-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-80"><a href="#cb136-80" aria-hidden="true" tabindex="-1"></a><span class="co">;; Computed elements</span></span>
<span id="cb136-81"><a href="#cb136-81" aria-hidden="true" tabindex="-1"></a>(struct generated-content node</span>
<span id="cb136-82"><a href="#cb136-82" aria-hidden="true" tabindex="-1"></a>  (generator   <span class="co">; function to generate content</span></span>
<span id="cb136-83"><a href="#cb136-83" aria-hidden="true" tabindex="-1"></a>   params      <span class="co">; parameters for generation</span></span>
<span id="cb136-84"><a href="#cb136-84" aria-hidden="true" tabindex="-1"></a>   cached)     <span class="co">; cached result</span></span>
<span id="cb136-85"><a href="#cb136-85" aria-hidden="true" tabindex="-1"></a>  #:transparent</span>
<span id="cb136-86"><a href="#cb136-86" aria-hidden="true" tabindex="-1"></a>  #:mutable)</span>
<span id="cb136-87"><a href="#cb136-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-88"><a href="#cb136-88" aria-hidden="true" tabindex="-1"></a>(struct cross-reference node</span>
<span id="cb136-89"><a href="#cb136-89" aria-hidden="true" tabindex="-1"></a>  (target      <span class="co">; reference target</span></span>
<span id="cb136-90"><a href="#cb136-90" aria-hidden="true" tabindex="-1"></a>   type        <span class="co">; ref, pageref, etc.</span></span>
<span id="cb136-91"><a href="#cb136-91" aria-hidden="true" tabindex="-1"></a>   resolved)   <span class="co">; resolved target info</span></span>
<span id="cb136-92"><a href="#cb136-92" aria-hidden="true" tabindex="-1"></a>  #:transparent</span>
<span id="cb136-93"><a href="#cb136-93" aria-hidden="true" tabindex="-1"></a>  #:mutable)</span>
<span id="cb136-94"><a href="#cb136-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-95"><a href="#cb136-95" aria-hidden="true" tabindex="-1"></a><span class="co">;; Metadata elements</span></span>
<span id="cb136-96"><a href="#cb136-96" aria-hidden="true" tabindex="-1"></a>(struct author</span>
<span id="cb136-97"><a href="#cb136-97" aria-hidden="true" tabindex="-1"></a>  (name        <span class="co">; author name</span></span>
<span id="cb136-98"><a href="#cb136-98" aria-hidden="true" tabindex="-1"></a>   email       <span class="co">; email address</span></span>
<span id="cb136-99"><a href="#cb136-99" aria-hidden="true" tabindex="-1"></a>   affiliation <span class="co">; institutional affiliation</span></span>
<span id="cb136-100"><a href="#cb136-100" aria-hidden="true" tabindex="-1"></a>   orcid)      <span class="co">; ORCID identifier</span></span>
<span id="cb136-101"><a href="#cb136-101" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb136-102"><a href="#cb136-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-103"><a href="#cb136-103" aria-hidden="true" tabindex="-1"></a>(struct bibliography-entry</span>
<span id="cb136-104"><a href="#cb136-104" aria-hidden="true" tabindex="-1"></a>  (key         <span class="co">; citation key</span></span>
<span id="cb136-105"><a href="#cb136-105" aria-hidden="true" tabindex="-1"></a>   type        <span class="co">; entry type (article, book, etc.)</span></span>
<span id="cb136-106"><a href="#cb136-106" aria-hidden="true" tabindex="-1"></a>   fields)     <span class="co">; bibliographic fields</span></span>
<span id="cb136-107"><a href="#cb136-107" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb136-108"><a href="#cb136-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-109"><a href="#cb136-109" aria-hidden="true" tabindex="-1"></a><span class="co">;; Node creation helpers</span></span>
<span id="cb136-110"><a href="#cb136-110" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> node-counter </span>(box <span class="dv">0</span>))</span>
<span id="cb136-111"><a href="#cb136-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-112"><a href="#cb136-112" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-node-id)</span>
<span id="cb136-113"><a href="#cb136-113" aria-hidden="true" tabindex="-1"></a>  (begin0</span>
<span id="cb136-114"><a href="#cb136-114" aria-hidden="true" tabindex="-1"></a>    (format <span class="st">&quot;node-~a&quot;</span> (unbox node-counter))</span>
<span id="cb136-115"><a href="#cb136-115" aria-hidden="true" tabindex="-1"></a>    (set-box! node-counter (add1 (unbox node-counter)))))</span>
<span id="cb136-116"><a href="#cb136-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-117"><a href="#cb136-117" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(create-node class #:attributes <span class="op">[</span>attrs (hash)<span class="op">]</span></span>
<span id="cb136-118"><a href="#cb136-118" aria-hidden="true" tabindex="-1"></a>                          #:metadata <span class="op">[</span>meta (hash)<span class="op">]</span></span>
<span id="cb136-119"><a href="#cb136-119" aria-hidden="true" tabindex="-1"></a>                          #:children <span class="op">[</span>children &#39;()<span class="op">]</span>)</span>
<span id="cb136-120"><a href="#cb136-120" aria-hidden="true" tabindex="-1"></a>  (node (make-node-id) class attrs meta children))</span></code></pre></div>
<h2 id="building-the-document-model">Building the Document Model</h2>
<p>The transformation from evaluated AST to document model involves
several passes:</p>
<div class="sourceCode" id="cb137"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; model-builder.rkt</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;interpreter.rkt&quot;</span>)</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main entry point</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-model evaluated-doc)</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> builder </span>(make-model-builder))</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>  (build-document builder evaluated-doc))</span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Builder state</span></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>(struct model-builder</span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>  (current-section   <span class="co">; current section being built</span></span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a>   section-stack     <span class="co">; stack of nested sections</span></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>   counters         <span class="co">; various counters (figures, equations, etc.)</span></span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a>   references       <span class="co">; label -&gt; node mapping</span></span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a>   footnotes        <span class="co">; accumulated footnotes</span></span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a>   citations        <span class="co">; accumulated citations</span></span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true" tabindex="-1"></a>   styles           <span class="co">; collected styles</span></span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true" tabindex="-1"></a>   options)         <span class="co">; build options</span></span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true" tabindex="-1"></a>  #:mutable)</span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-model-builder)</span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true" tabindex="-1"></a>  (model-builder <span class="dv">#f</span> &#39;() (make-hash) (make-hash)</span>
<span id="cb137-26"><a href="#cb137-26" aria-hidden="true" tabindex="-1"></a>                 &#39;() &#39;() &#39;() (hash)))</span>
<span id="cb137-27"><a href="#cb137-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-28"><a href="#cb137-28" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build document from evaluated AST</span></span>
<span id="cb137-29"><a href="#cb137-29" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-document builder evaluated-doc)</span>
<span id="cb137-30"><a href="#cb137-30" aria-hidden="true" tabindex="-1"></a>  (match evaluated-doc</span>
<span id="cb137-31"><a href="#cb137-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-doc metadata elements env)</span>
<span id="cb137-32"><a href="#cb137-32" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Extract document metadata</span></span>
<span id="cb137-33"><a href="#cb137-33" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> title </span>(hash-ref metadata &#39;title <span class="st">&quot;Untitled&quot;</span>))</span>
<span id="cb137-34"><a href="#cb137-34" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> authors </span>(parse-authors (hash-ref metadata &#39;authors &#39;())))</span>
<span id="cb137-35"><a href="#cb137-35" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> date </span>(hash-ref metadata &#39;date (current-date)))</span>
<span id="cb137-36"><a href="#cb137-36" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> abstract </span>(hash-ref metadata &#39;abstract <span class="dv">#f</span>))</span>
<span id="cb137-37"><a href="#cb137-37" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb137-38"><a href="#cb137-38" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Process document elements</span></span>
<span id="cb137-39"><a href="#cb137-39" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> sections </span>&#39;())</span>
<span id="cb137-40"><a href="#cb137-40" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> appendices </span>&#39;())</span>
<span id="cb137-41"><a href="#cb137-41" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> in-appendix? </span><span class="dv">#f</span>)</span>
<span id="cb137-42"><a href="#cb137-42" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb137-43"><a href="#cb137-43" aria-hidden="true" tabindex="-1"></a>     (for (<span class="op">[</span>elem elements<span class="op">]</span>)</span>
<span id="cb137-44"><a href="#cb137-44" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> node </span>(build-element builder elem))</span>
<span id="cb137-45"><a href="#cb137-45" aria-hidden="true" tabindex="-1"></a>       (when node</span>
<span id="cb137-46"><a href="#cb137-46" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">cond</span></span>
<span id="cb137-47"><a href="#cb137-47" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(is-appendix-marker? node)</span>
<span id="cb137-48"><a href="#cb137-48" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">set!</span> in-appendix? <span class="dv">#t</span>)<span class="op">]</span></span>
<span id="cb137-49"><a href="#cb137-49" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>in-appendix?</span>
<span id="cb137-50"><a href="#cb137-50" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">set!</span> appendices (<span class="kw">append</span> appendices (<span class="kw">list</span> node)))<span class="op">]</span></span>
<span id="cb137-51"><a href="#cb137-51" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span><span class="kw">else</span></span>
<span id="cb137-52"><a href="#cb137-52" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">set!</span> sections (<span class="kw">append</span> sections (<span class="kw">list</span> node)))<span class="op">]</span>)))</span>
<span id="cb137-53"><a href="#cb137-53" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb137-54"><a href="#cb137-54" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Build bibliography</span></span>
<span id="cb137-55"><a href="#cb137-55" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> bibliography </span></span>
<span id="cb137-56"><a href="#cb137-56" aria-hidden="true" tabindex="-1"></a>       (build-bibliography (model-builder-citations builder)))</span>
<span id="cb137-57"><a href="#cb137-57" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb137-58"><a href="#cb137-58" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Build index</span></span>
<span id="cb137-59"><a href="#cb137-59" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> index </span>(build-index sections appendices))</span>
<span id="cb137-60"><a href="#cb137-60" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb137-61"><a href="#cb137-61" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Create document node</span></span>
<span id="cb137-62"><a href="#cb137-62" aria-hidden="true" tabindex="-1"></a>     (document (make-node-id)</span>
<span id="cb137-63"><a href="#cb137-63" aria-hidden="true" tabindex="-1"></a>               &#39;document</span>
<span id="cb137-64"><a href="#cb137-64" aria-hidden="true" tabindex="-1"></a>               (hash)</span>
<span id="cb137-65"><a href="#cb137-65" aria-hidden="true" tabindex="-1"></a>               metadata</span>
<span id="cb137-66"><a href="#cb137-66" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">list</span>) <span class="co">; no direct children, use sections</span></span>
<span id="cb137-67"><a href="#cb137-67" aria-hidden="true" tabindex="-1"></a>               title</span>
<span id="cb137-68"><a href="#cb137-68" aria-hidden="true" tabindex="-1"></a>               authors</span>
<span id="cb137-69"><a href="#cb137-69" aria-hidden="true" tabindex="-1"></a>               date</span>
<span id="cb137-70"><a href="#cb137-70" aria-hidden="true" tabindex="-1"></a>               abstract</span>
<span id="cb137-71"><a href="#cb137-71" aria-hidden="true" tabindex="-1"></a>               sections</span>
<span id="cb137-72"><a href="#cb137-72" aria-hidden="true" tabindex="-1"></a>               appendices</span>
<span id="cb137-73"><a href="#cb137-73" aria-hidden="true" tabindex="-1"></a>               bibliography</span>
<span id="cb137-74"><a href="#cb137-74" aria-hidden="true" tabindex="-1"></a>               index</span>
<span id="cb137-75"><a href="#cb137-75" aria-hidden="true" tabindex="-1"></a>               (model-builder-styles builder)</span>
<span id="cb137-76"><a href="#cb137-76" aria-hidden="true" tabindex="-1"></a>               &#39;())<span class="op">]</span>))</span>
<span id="cb137-77"><a href="#cb137-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-78"><a href="#cb137-78" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build individual elements</span></span>
<span id="cb137-79"><a href="#cb137-79" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-element builder elem)</span>
<span id="cb137-80"><a href="#cb137-80" aria-hidden="true" tabindex="-1"></a>  (match elem</span>
<span id="cb137-81"><a href="#cb137-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Sections</span></span>
<span id="cb137-82"><a href="#cb137-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-element &#39;section attrs content)</span>
<span id="cb137-83"><a href="#cb137-83" aria-hidden="true" tabindex="-1"></a>     (build-section builder attrs content)<span class="op">]</span></span>
<span id="cb137-84"><a href="#cb137-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-85"><a href="#cb137-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Paragraphs</span></span>
<span id="cb137-86"><a href="#cb137-86" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-element &#39;paragraph attrs content)</span>
<span id="cb137-87"><a href="#cb137-87" aria-hidden="true" tabindex="-1"></a>     (paragraph (make-node-id)</span>
<span id="cb137-88"><a href="#cb137-88" aria-hidden="true" tabindex="-1"></a>                &#39;paragraph</span>
<span id="cb137-89"><a href="#cb137-89" aria-hidden="true" tabindex="-1"></a>                (attrs-&gt;hash attrs)</span>
<span id="cb137-90"><a href="#cb137-90" aria-hidden="true" tabindex="-1"></a>                (hash)</span>
<span id="cb137-91"><a href="#cb137-91" aria-hidden="true" tabindex="-1"></a>                (map (λ (c) (build-element builder c)) content))<span class="op">]</span></span>
<span id="cb137-92"><a href="#cb137-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-93"><a href="#cb137-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Text runs</span></span>
<span id="cb137-94"><a href="#cb137-94" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">?</span> <span class="kw">string?</span> text)</span>
<span id="cb137-95"><a href="#cb137-95" aria-hidden="true" tabindex="-1"></a>     (text-run (make-node-id) &#39;text (hash) (hash) &#39;() text)<span class="op">]</span></span>
<span id="cb137-96"><a href="#cb137-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-97"><a href="#cb137-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Emphasis</span></span>
<span id="cb137-98"><a href="#cb137-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-element &#39;emphasis attrs content)</span>
<span id="cb137-99"><a href="#cb137-99" aria-hidden="true" tabindex="-1"></a>     (emphasis (make-node-id)</span>
<span id="cb137-100"><a href="#cb137-100" aria-hidden="true" tabindex="-1"></a>               &#39;emphasis</span>
<span id="cb137-101"><a href="#cb137-101" aria-hidden="true" tabindex="-1"></a>               (attrs-&gt;hash attrs)</span>
<span id="cb137-102"><a href="#cb137-102" aria-hidden="true" tabindex="-1"></a>               (hash)</span>
<span id="cb137-103"><a href="#cb137-103" aria-hidden="true" tabindex="-1"></a>               (map (λ (c) (build-element builder c)) content)</span>
<span id="cb137-104"><a href="#cb137-104" aria-hidden="true" tabindex="-1"></a>               <span class="dv">1</span>)<span class="op">]</span></span>
<span id="cb137-105"><a href="#cb137-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-106"><a href="#cb137-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Code blocks</span></span>
<span id="cb137-107"><a href="#cb137-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-element &#39;code attrs content)</span>
<span id="cb137-108"><a href="#cb137-108" aria-hidden="true" tabindex="-1"></a>     (build-code-block builder attrs content)<span class="op">]</span></span>
<span id="cb137-109"><a href="#cb137-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-110"><a href="#cb137-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Mathematics</span></span>
<span id="cb137-111"><a href="#cb137-111" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-element &#39;math attrs content)</span>
<span id="cb137-112"><a href="#cb137-112" aria-hidden="true" tabindex="-1"></a>     (build-equation builder attrs content)<span class="op">]</span></span>
<span id="cb137-113"><a href="#cb137-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-114"><a href="#cb137-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Figures</span></span>
<span id="cb137-115"><a href="#cb137-115" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-element &#39;figure attrs content)</span>
<span id="cb137-116"><a href="#cb137-116" aria-hidden="true" tabindex="-1"></a>     (build-figure builder attrs content)<span class="op">]</span></span>
<span id="cb137-117"><a href="#cb137-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-118"><a href="#cb137-118" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Tables</span></span>
<span id="cb137-119"><a href="#cb137-119" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-element &#39;table attrs content)</span>
<span id="cb137-120"><a href="#cb137-120" aria-hidden="true" tabindex="-1"></a>     (build-table builder attrs content)<span class="op">]</span></span>
<span id="cb137-121"><a href="#cb137-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-122"><a href="#cb137-122" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Cross-references</span></span>
<span id="cb137-123"><a href="#cb137-123" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-element &#39;ref attrs content)</span>
<span id="cb137-124"><a href="#cb137-124" aria-hidden="true" tabindex="-1"></a>     (build-cross-reference builder attrs)<span class="op">]</span></span>
<span id="cb137-125"><a href="#cb137-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-126"><a href="#cb137-126" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Lists</span></span>
<span id="cb137-127"><a href="#cb137-127" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-element &#39;list attrs content)</span>
<span id="cb137-128"><a href="#cb137-128" aria-hidden="true" tabindex="-1"></a>     (build-list builder attrs content)<span class="op">]</span></span>
<span id="cb137-129"><a href="#cb137-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-130"><a href="#cb137-130" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Unknown elements - preserve as generic nodes</span></span>
<span id="cb137-131"><a href="#cb137-131" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(evaluated-element type attrs content)</span>
<span id="cb137-132"><a href="#cb137-132" aria-hidden="true" tabindex="-1"></a>     (create-node type</span>
<span id="cb137-133"><a href="#cb137-133" aria-hidden="true" tabindex="-1"></a>                  #:attributes (attrs-&gt;hash attrs)</span>
<span id="cb137-134"><a href="#cb137-134" aria-hidden="true" tabindex="-1"></a>                  #:children (map (λ (c) (build-element builder c)) </span>
<span id="cb137-135"><a href="#cb137-135" aria-hidden="true" tabindex="-1"></a>                                content))<span class="op">]</span></span>
<span id="cb137-136"><a href="#cb137-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-137"><a href="#cb137-137" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> <span class="dv">#f</span><span class="op">]</span>))</span>
<span id="cb137-138"><a href="#cb137-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-139"><a href="#cb137-139" aria-hidden="true" tabindex="-1"></a><span class="co">;; Section building with automatic numbering</span></span>
<span id="cb137-140"><a href="#cb137-140" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-section builder attrs content)</span>
<span id="cb137-141"><a href="#cb137-141" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> level </span>(<span class="kw">or</span> (assoc-ref attrs &#39;level) <span class="dv">1</span>))</span>
<span id="cb137-142"><a href="#cb137-142" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> label </span>(assoc-ref attrs &#39;label))</span>
<span id="cb137-143"><a href="#cb137-143" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> title-elem </span>(first content))</span>
<span id="cb137-144"><a href="#cb137-144" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> body-elems </span>(rest content))</span>
<span id="cb137-145"><a href="#cb137-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-146"><a href="#cb137-146" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Update section numbering</span></span>
<span id="cb137-147"><a href="#cb137-147" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> number </span>(generate-section-number builder level))</span>
<span id="cb137-148"><a href="#cb137-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-149"><a href="#cb137-149" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Build section node</span></span>
<span id="cb137-150"><a href="#cb137-150" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> section-node</span></span>
<span id="cb137-151"><a href="#cb137-151" aria-hidden="true" tabindex="-1"></a>    (section (make-node-id)</span>
<span id="cb137-152"><a href="#cb137-152" aria-hidden="true" tabindex="-1"></a>             &#39;section</span>
<span id="cb137-153"><a href="#cb137-153" aria-hidden="true" tabindex="-1"></a>             (attrs-&gt;hash attrs)</span>
<span id="cb137-154"><a href="#cb137-154" aria-hidden="true" tabindex="-1"></a>             (hash)</span>
<span id="cb137-155"><a href="#cb137-155" aria-hidden="true" tabindex="-1"></a>             (map (λ (c) (build-element builder c)) body-elems)</span>
<span id="cb137-156"><a href="#cb137-156" aria-hidden="true" tabindex="-1"></a>             level</span>
<span id="cb137-157"><a href="#cb137-157" aria-hidden="true" tabindex="-1"></a>             number</span>
<span id="cb137-158"><a href="#cb137-158" aria-hidden="true" tabindex="-1"></a>             (build-element builder title-elem)</span>
<span id="cb137-159"><a href="#cb137-159" aria-hidden="true" tabindex="-1"></a>             label))</span>
<span id="cb137-160"><a href="#cb137-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-161"><a href="#cb137-161" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Register label if present</span></span>
<span id="cb137-162"><a href="#cb137-162" aria-hidden="true" tabindex="-1"></a>  (when label</span>
<span id="cb137-163"><a href="#cb137-163" aria-hidden="true" tabindex="-1"></a>    (register-reference builder label section-node))</span>
<span id="cb137-164"><a href="#cb137-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-165"><a href="#cb137-165" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Update builder state</span></span>
<span id="cb137-166"><a href="#cb137-166" aria-hidden="true" tabindex="-1"></a>  (push-section builder section-node)</span>
<span id="cb137-167"><a href="#cb137-167" aria-hidden="true" tabindex="-1"></a>  section-node)</span>
<span id="cb137-168"><a href="#cb137-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-169"><a href="#cb137-169" aria-hidden="true" tabindex="-1"></a><span class="co">;; Section numbering</span></span>
<span id="cb137-170"><a href="#cb137-170" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-section-number builder level)</span>
<span id="cb137-171"><a href="#cb137-171" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> counters </span>(model-builder-counters builder))</span>
<span id="cb137-172"><a href="#cb137-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-173"><a href="#cb137-173" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Initialize counters if needed</span></span>
<span id="cb137-174"><a href="#cb137-174" aria-hidden="true" tabindex="-1"></a>  (unless (hash-has-key? counters &#39;sections)</span>
<span id="cb137-175"><a href="#cb137-175" aria-hidden="true" tabindex="-1"></a>    (hash-set! counters &#39;sections (<span class="kw">make-vector</span> <span class="dv">6</span> <span class="dv">0</span>)))</span>
<span id="cb137-176"><a href="#cb137-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-177"><a href="#cb137-177" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> section-counters </span>(hash-ref counters &#39;sections))</span>
<span id="cb137-178"><a href="#cb137-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-179"><a href="#cb137-179" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Increment counter at current level</span></span>
<span id="cb137-180"><a href="#cb137-180" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">vector-set!</span> section-counters (sub1 level)</span>
<span id="cb137-181"><a href="#cb137-181" aria-hidden="true" tabindex="-1"></a>               (add1 (<span class="kw">vector-ref</span> section-counters (sub1 level))))</span>
<span id="cb137-182"><a href="#cb137-182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-183"><a href="#cb137-183" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Reset deeper level counters</span></span>
<span id="cb137-184"><a href="#cb137-184" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>i (in-range level <span class="dv">6</span>)<span class="op">]</span>)</span>
<span id="cb137-185"><a href="#cb137-185" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">vector-set!</span> section-counters i <span class="dv">0</span>))</span>
<span id="cb137-186"><a href="#cb137-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-187"><a href="#cb137-187" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate number string (e.g., &quot;2.3.1&quot;)</span></span>
<span id="cb137-188"><a href="#cb137-188" aria-hidden="true" tabindex="-1"></a>  (string-join</span>
<span id="cb137-189"><a href="#cb137-189" aria-hidden="true" tabindex="-1"></a>   (for/list (<span class="op">[</span>i (in-range level)<span class="op">]</span></span>
<span id="cb137-190"><a href="#cb137-190" aria-hidden="true" tabindex="-1"></a>              #:when (<span class="op">&gt;</span> (<span class="kw">vector-ref</span> section-counters i) <span class="dv">0</span>))</span>
<span id="cb137-191"><a href="#cb137-191" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">number-&gt;string</span> (<span class="kw">vector-ref</span> section-counters i)))</span>
<span id="cb137-192"><a href="#cb137-192" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;.&quot;</span>))</span>
<span id="cb137-193"><a href="#cb137-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-194"><a href="#cb137-194" aria-hidden="true" tabindex="-1"></a><span class="co">;; Helper functions</span></span>
<span id="cb137-195"><a href="#cb137-195" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(attrs-&gt;hash attrs)</span>
<span id="cb137-196"><a href="#cb137-196" aria-hidden="true" tabindex="-1"></a>  (for/hash (<span class="op">[</span>attr attrs<span class="op">]</span>)</span>
<span id="cb137-197"><a href="#cb137-197" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">values</span> (<span class="kw">car</span> attr) (<span class="kw">cadr</span> attr))))</span>
<span id="cb137-198"><a href="#cb137-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-199"><a href="#cb137-199" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(assoc-ref attrs key <span class="op">[</span>default <span class="dv">#f</span><span class="op">]</span>)</span>
<span id="cb137-200"><a href="#cb137-200" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> pair </span>(<span class="kw">assoc</span> key attrs))</span>
<span id="cb137-201"><a href="#cb137-201" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> pair (<span class="kw">cadr</span> pair) default))</span>
<span id="cb137-202"><a href="#cb137-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-203"><a href="#cb137-203" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(push-section builder section)</span>
<span id="cb137-204"><a href="#cb137-204" aria-hidden="true" tabindex="-1"></a>  (set-model-builder-section-stack!</span>
<span id="cb137-205"><a href="#cb137-205" aria-hidden="true" tabindex="-1"></a>   builder</span>
<span id="cb137-206"><a href="#cb137-206" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">cons</span> section (model-builder-section-stack builder))))</span>
<span id="cb137-207"><a href="#cb137-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-208"><a href="#cb137-208" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(register-reference builder label node)</span>
<span id="cb137-209"><a href="#cb137-209" aria-hidden="true" tabindex="-1"></a>  (hash-set! (model-builder-references builder) label node))</span></code></pre></div>
<h2 id="cross-reference-resolution">Cross-Reference Resolution</h2>
<p>Cross-references require special handling to resolve targets across
the document:</p>
<div class="sourceCode" id="cb138"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; cross-references.rkt</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span>)</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build cross-reference node</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-cross-reference builder attrs)</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> target </span>(assoc-ref attrs &#39;target))</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> type </span>(<span class="kw">or</span> (assoc-ref attrs &#39;type) &#39;ref))</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>  (cross-reference (make-node-id)</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>                   &#39;cross-reference</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>                   (attrs-&gt;hash attrs)</span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>                   (hash)</span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>                   &#39;()</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>                   target</span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>                   type</span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">#f</span>)) <span class="co">; Will be resolved later</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a><span class="co">;; Resolve all cross-references in document</span></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(resolve-references doc)</span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ref-map </span>(build-reference-map doc))</span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(resolve-node node)</span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(cross-reference? node)</span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> target </span>(cross-reference-target node))</span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> resolved </span>(hash-ref ref-map target <span class="dv">#f</span>))</span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">if</span> resolved</span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">begin</span></span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a>             (set-cross-reference-resolved! node resolved)</span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a>             node)</span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">error</span> &#39;resolve-ref </span>
<span id="cb138-34"><a href="#cb138-34" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Undefined reference: ~a&quot;</span> target))<span class="op">]</span></span>
<span id="cb138-35"><a href="#cb138-35" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-36"><a href="#cb138-36" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(node? node)</span>
<span id="cb138-37"><a href="#cb138-37" aria-hidden="true" tabindex="-1"></a>       (set-node-children! </span>
<span id="cb138-38"><a href="#cb138-38" aria-hidden="true" tabindex="-1"></a>        node</span>
<span id="cb138-39"><a href="#cb138-39" aria-hidden="true" tabindex="-1"></a>        (map resolve-node (node-children node)))</span>
<span id="cb138-40"><a href="#cb138-40" aria-hidden="true" tabindex="-1"></a>       node<span class="op">]</span></span>
<span id="cb138-41"><a href="#cb138-41" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-42"><a href="#cb138-42" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span> node<span class="op">]</span>))</span>
<span id="cb138-43"><a href="#cb138-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-44"><a href="#cb138-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Recursively resolve all nodes</span></span>
<span id="cb138-45"><a href="#cb138-45" aria-hidden="true" tabindex="-1"></a>  (resolve-node doc))</span>
<span id="cb138-46"><a href="#cb138-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-47"><a href="#cb138-47" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build map of labels to nodes</span></span>
<span id="cb138-48"><a href="#cb138-48" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-reference-map doc)</span>
<span id="cb138-49"><a href="#cb138-49" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ref-map </span>(make-hash))</span>
<span id="cb138-50"><a href="#cb138-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-51"><a href="#cb138-51" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(scan-node node path)</span>
<span id="cb138-52"><a href="#cb138-52" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb138-53"><a href="#cb138-53" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(section? node)</span>
<span id="cb138-54"><a href="#cb138-54" aria-hidden="true" tabindex="-1"></a>       (when (section-label node)</span>
<span id="cb138-55"><a href="#cb138-55" aria-hidden="true" tabindex="-1"></a>         (hash-set! ref-map </span>
<span id="cb138-56"><a href="#cb138-56" aria-hidden="true" tabindex="-1"></a>                   (section-label node)</span>
<span id="cb138-57"><a href="#cb138-57" aria-hidden="true" tabindex="-1"></a>                   (make-reference-info &#39;section </span>
<span id="cb138-58"><a href="#cb138-58" aria-hidden="true" tabindex="-1"></a>                                      (section-number node)</span>
<span id="cb138-59"><a href="#cb138-59" aria-hidden="true" tabindex="-1"></a>                                      (section-title node)</span>
<span id="cb138-60"><a href="#cb138-60" aria-hidden="true" tabindex="-1"></a>                                      path)))</span>
<span id="cb138-61"><a href="#cb138-61" aria-hidden="true" tabindex="-1"></a>       (scan-children node path)<span class="op">]</span></span>
<span id="cb138-62"><a href="#cb138-62" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-63"><a href="#cb138-63" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(figure? node)</span>
<span id="cb138-64"><a href="#cb138-64" aria-hidden="true" tabindex="-1"></a>       (when (figure-label node)</span>
<span id="cb138-65"><a href="#cb138-65" aria-hidden="true" tabindex="-1"></a>         (<span class="ex">define</span><span class="fu"> fig-num </span>(get-counter-value &#39;figure))</span>
<span id="cb138-66"><a href="#cb138-66" aria-hidden="true" tabindex="-1"></a>         (hash-set! ref-map</span>
<span id="cb138-67"><a href="#cb138-67" aria-hidden="true" tabindex="-1"></a>                   (figure-label node)</span>
<span id="cb138-68"><a href="#cb138-68" aria-hidden="true" tabindex="-1"></a>                   (make-reference-info &#39;figure</span>
<span id="cb138-69"><a href="#cb138-69" aria-hidden="true" tabindex="-1"></a>                                      fig-num</span>
<span id="cb138-70"><a href="#cb138-70" aria-hidden="true" tabindex="-1"></a>                                      (figure-caption node)</span>
<span id="cb138-71"><a href="#cb138-71" aria-hidden="true" tabindex="-1"></a>                                      path)))</span>
<span id="cb138-72"><a href="#cb138-72" aria-hidden="true" tabindex="-1"></a>       (scan-children node path)<span class="op">]</span></span>
<span id="cb138-73"><a href="#cb138-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-74"><a href="#cb138-74" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(table? node)</span>
<span id="cb138-75"><a href="#cb138-75" aria-hidden="true" tabindex="-1"></a>       (when (table-label node)</span>
<span id="cb138-76"><a href="#cb138-76" aria-hidden="true" tabindex="-1"></a>         (<span class="ex">define</span><span class="fu"> table-num </span>(get-counter-value &#39;table))</span>
<span id="cb138-77"><a href="#cb138-77" aria-hidden="true" tabindex="-1"></a>         (hash-set! ref-map</span>
<span id="cb138-78"><a href="#cb138-78" aria-hidden="true" tabindex="-1"></a>                   (table-label node)</span>
<span id="cb138-79"><a href="#cb138-79" aria-hidden="true" tabindex="-1"></a>                   (make-reference-info &#39;table</span>
<span id="cb138-80"><a href="#cb138-80" aria-hidden="true" tabindex="-1"></a>                                      table-num</span>
<span id="cb138-81"><a href="#cb138-81" aria-hidden="true" tabindex="-1"></a>                                      (table-caption node)</span>
<span id="cb138-82"><a href="#cb138-82" aria-hidden="true" tabindex="-1"></a>                                      path)))</span>
<span id="cb138-83"><a href="#cb138-83" aria-hidden="true" tabindex="-1"></a>       (scan-children node path)<span class="op">]</span></span>
<span id="cb138-84"><a href="#cb138-84" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-85"><a href="#cb138-85" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(equation? node)</span>
<span id="cb138-86"><a href="#cb138-86" aria-hidden="true" tabindex="-1"></a>       (when (<span class="kw">and</span> (equation-label node)</span>
<span id="cb138-87"><a href="#cb138-87" aria-hidden="true" tabindex="-1"></a>                 (equation-numbered node))</span>
<span id="cb138-88"><a href="#cb138-88" aria-hidden="true" tabindex="-1"></a>         (<span class="ex">define</span><span class="fu"> eq-num </span>(get-counter-value &#39;equation))</span>
<span id="cb138-89"><a href="#cb138-89" aria-hidden="true" tabindex="-1"></a>         (hash-set! ref-map</span>
<span id="cb138-90"><a href="#cb138-90" aria-hidden="true" tabindex="-1"></a>                   (equation-label node)</span>
<span id="cb138-91"><a href="#cb138-91" aria-hidden="true" tabindex="-1"></a>                   (make-reference-info &#39;equation</span>
<span id="cb138-92"><a href="#cb138-92" aria-hidden="true" tabindex="-1"></a>                                      eq-num</span>
<span id="cb138-93"><a href="#cb138-93" aria-hidden="true" tabindex="-1"></a>                                      <span class="dv">#f</span></span>
<span id="cb138-94"><a href="#cb138-94" aria-hidden="true" tabindex="-1"></a>                                      path)))<span class="op">]</span></span>
<span id="cb138-95"><a href="#cb138-95" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-96"><a href="#cb138-96" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(node? node)</span>
<span id="cb138-97"><a href="#cb138-97" aria-hidden="true" tabindex="-1"></a>       (scan-children node path)<span class="op">]</span></span>
<span id="cb138-98"><a href="#cb138-98" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-99"><a href="#cb138-99" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span> void<span class="op">]</span>))</span>
<span id="cb138-100"><a href="#cb138-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-101"><a href="#cb138-101" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(scan-children node path)</span>
<span id="cb138-102"><a href="#cb138-102" aria-hidden="true" tabindex="-1"></a>    (for (<span class="op">[</span>child (node-children node)<span class="op">]</span></span>
<span id="cb138-103"><a href="#cb138-103" aria-hidden="true" tabindex="-1"></a>          <span class="op">[</span>idx (in-naturals)<span class="op">]</span>)</span>
<span id="cb138-104"><a href="#cb138-104" aria-hidden="true" tabindex="-1"></a>      (scan-node child (<span class="kw">append</span> path (<span class="kw">list</span> idx)))))</span>
<span id="cb138-105"><a href="#cb138-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-106"><a href="#cb138-106" aria-hidden="true" tabindex="-1"></a>  (scan-node doc &#39;())</span>
<span id="cb138-107"><a href="#cb138-107" aria-hidden="true" tabindex="-1"></a>  ref-map)</span>
<span id="cb138-108"><a href="#cb138-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-109"><a href="#cb138-109" aria-hidden="true" tabindex="-1"></a><span class="co">;; Reference information</span></span>
<span id="cb138-110"><a href="#cb138-110" aria-hidden="true" tabindex="-1"></a>(struct reference-info</span>
<span id="cb138-111"><a href="#cb138-111" aria-hidden="true" tabindex="-1"></a>  (type     <span class="co">; section, figure, table, equation, etc.</span></span>
<span id="cb138-112"><a href="#cb138-112" aria-hidden="true" tabindex="-1"></a>   number   <span class="co">; formatted number</span></span>
<span id="cb138-113"><a href="#cb138-113" aria-hidden="true" tabindex="-1"></a>   title    <span class="co">; title or caption</span></span>
<span id="cb138-114"><a href="#cb138-114" aria-hidden="true" tabindex="-1"></a>   path)    <span class="co">; path in document tree</span></span>
<span id="cb138-115"><a href="#cb138-115" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb138-116"><a href="#cb138-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-117"><a href="#cb138-117" aria-hidden="true" tabindex="-1"></a><span class="co">;; Counter management</span></span>
<span id="cb138-118"><a href="#cb138-118" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> counters </span>(make-hash))</span>
<span id="cb138-119"><a href="#cb138-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-120"><a href="#cb138-120" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(get-counter-value name)</span>
<span id="cb138-121"><a href="#cb138-121" aria-hidden="true" tabindex="-1"></a>  (hash-ref counters name <span class="dv">0</span>))</span>
<span id="cb138-122"><a href="#cb138-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-123"><a href="#cb138-123" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(increment-counter! name)</span>
<span id="cb138-124"><a href="#cb138-124" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> current </span>(get-counter-value name))</span>
<span id="cb138-125"><a href="#cb138-125" aria-hidden="true" tabindex="-1"></a>  (hash-set! counters name (add1 current))</span>
<span id="cb138-126"><a href="#cb138-126" aria-hidden="true" tabindex="-1"></a>  (add1 current))</span></code></pre></div>
<h2 id="mathematical-content-representation">Mathematical Content
Representation</h2>
<p>Mathematics requires special attention to preserve semantics across
formats:</p>
<div class="sourceCode" id="cb139"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; math-model.rkt</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span>)</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Math expression types</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>(struct math-expr () #:transparent)</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>(struct math-symbol math-expr (name) #:transparent)</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>(struct math-number math-expr (value) #:transparent)</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>(struct math-operator math-expr (op) #:transparent)</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>(struct</span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a># Chapter <span class="dv">7</span>: HTML Generation Pipeline</span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>## From Document Model to Web</span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>The HTML generation pipeline transforms our intermediate representation into semantic, accessible web content. Unlike traditional template-based generators, our approach leverages the structured document model to produce HTML that preserves both the document&#39;s semantic meaning <span class="kw">and</span> its visual presentation requirements.</span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>This chapter explores the complete pipeline: from traversing the document model, through generating semantic HTML5 markup, to producing the supporting assets like CSS <span class="kw">and</span> JavaScript. We&#39;ll pay special attention to mathematical content rendering, code highlighting, <span class="kw">and</span> responsive design considerations.</span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>## Core HTML Renderer Architecture</span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a>The renderer operates as a visitor over the document model, transforming each node type into appropriate HTML:</span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>```scheme</span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a><span class="co">;; html-renderer.rkt</span></span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb139-29"><a href="#cb139-29" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;cross-references.rkt&quot;</span></span>
<span id="cb139-30"><a href="#cb139-30" aria-hidden="true" tabindex="-1"></a>         xml)</span>
<span id="cb139-31"><a href="#cb139-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-32"><a href="#cb139-32" aria-hidden="true" tabindex="-1"></a>(provide render-html</span>
<span id="cb139-33"><a href="#cb139-33" aria-hidden="true" tabindex="-1"></a>         render-html-to-file)</span>
<span id="cb139-34"><a href="#cb139-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-35"><a href="#cb139-35" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main rendering entry point</span></span>
<span id="cb139-36"><a href="#cb139-36" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-html doc #:options <span class="op">[</span>options (make-render-options)<span class="op">]</span>)</span>
<span id="cb139-37"><a href="#cb139-37" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ctx </span>(make-render-context options))</span>
<span id="cb139-38"><a href="#cb139-38" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> resolved-doc </span>(resolve-references doc))</span>
<span id="cb139-39"><a href="#cb139-39" aria-hidden="true" tabindex="-1"></a>  (render-document ctx resolved-doc))</span>
<span id="cb139-40"><a href="#cb139-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-41"><a href="#cb139-41" aria-hidden="true" tabindex="-1"></a><span class="co">;; Rendering context</span></span>
<span id="cb139-42"><a href="#cb139-42" aria-hidden="true" tabindex="-1"></a>(struct render-context</span>
<span id="cb139-43"><a href="#cb139-43" aria-hidden="true" tabindex="-1"></a>  (options          <span class="co">; rendering options</span></span>
<span id="cb139-44"><a href="#cb139-44" aria-hidden="true" tabindex="-1"></a>   depth            <span class="co">; current nesting depth</span></span>
<span id="cb139-45"><a href="#cb139-45" aria-hidden="true" tabindex="-1"></a>   footnotes        <span class="co">; accumulated footnotes</span></span>
<span id="cb139-46"><a href="#cb139-46" aria-hidden="true" tabindex="-1"></a>   styles           <span class="co">; collected CSS styles</span></span>
<span id="cb139-47"><a href="#cb139-47" aria-hidden="true" tabindex="-1"></a>   scripts          <span class="co">; collected JS scripts</span></span>
<span id="cb139-48"><a href="#cb139-48" aria-hidden="true" tabindex="-1"></a>   toc              <span class="co">; table of contents</span></span>
<span id="cb139-49"><a href="#cb139-49" aria-hidden="true" tabindex="-1"></a>   current-section  <span class="co">; current section for context</span></span>
<span id="cb139-50"><a href="#cb139-50" aria-hidden="true" tabindex="-1"></a>   id-map)          <span class="co">; map of generated IDs</span></span>
<span id="cb139-51"><a href="#cb139-51" aria-hidden="true" tabindex="-1"></a>  #:mutable)</span>
<span id="cb139-52"><a href="#cb139-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-53"><a href="#cb139-53" aria-hidden="true" tabindex="-1"></a>(struct render-options</span>
<span id="cb139-54"><a href="#cb139-54" aria-hidden="true" tabindex="-1"></a>  (math-renderer    <span class="co">; &#39;mathjax or &#39;katex</span></span>
<span id="cb139-55"><a href="#cb139-55" aria-hidden="true" tabindex="-1"></a>   code-highlighter <span class="co">; &#39;prism or &#39;highlight.js</span></span>
<span id="cb139-56"><a href="#cb139-56" aria-hidden="true" tabindex="-1"></a>   theme            <span class="co">; color theme</span></span>
<span id="cb139-57"><a href="#cb139-57" aria-hidden="true" tabindex="-1"></a>   responsive       <span class="co">; responsive design?</span></span>
<span id="cb139-58"><a href="#cb139-58" aria-hidden="true" tabindex="-1"></a>   minify           <span class="co">; minify output?</span></span>
<span id="cb139-59"><a href="#cb139-59" aria-hidden="true" tabindex="-1"></a>   standalone)      <span class="co">; standalone HTML file?</span></span>
<span id="cb139-60"><a href="#cb139-60" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb139-61"><a href="#cb139-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-62"><a href="#cb139-62" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-render-options)</span>
<span id="cb139-63"><a href="#cb139-63" aria-hidden="true" tabindex="-1"></a>  (render-options &#39;katex &#39;prism &#39;default <span class="dv">#t</span> <span class="dv">#f</span> <span class="dv">#t</span>))</span>
<span id="cb139-64"><a href="#cb139-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-65"><a href="#cb139-65" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-render-context options)</span>
<span id="cb139-66"><a href="#cb139-66" aria-hidden="true" tabindex="-1"></a>  (render-context options <span class="dv">0</span> &#39;() &#39;() &#39;() &#39;() <span class="dv">#f</span> (make-hash)))</span>
<span id="cb139-67"><a href="#cb139-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-68"><a href="#cb139-68" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main document renderer</span></span>
<span id="cb139-69"><a href="#cb139-69" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-document ctx doc)</span>
<span id="cb139-70"><a href="#cb139-70" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> head </span>(render-document-head ctx doc))</span>
<span id="cb139-71"><a href="#cb139-71" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> body </span>(render-document-body ctx doc))</span>
<span id="cb139-72"><a href="#cb139-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-73"><a href="#cb139-73" aria-hidden="true" tabindex="-1"></a>  `(html ((lang <span class="st">&quot;en&quot;</span>))</span>
<span id="cb139-74"><a href="#cb139-74" aria-hidden="true" tabindex="-1"></a>     ,head</span>
<span id="cb139-75"><a href="#cb139-75" aria-hidden="true" tabindex="-1"></a>     ,body))</span>
<span id="cb139-76"><a href="#cb139-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-77"><a href="#cb139-77" aria-hidden="true" tabindex="-1"></a><span class="co">;; Document head generation</span></span>
<span id="cb139-78"><a href="#cb139-78" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-document-head ctx doc)</span>
<span id="cb139-79"><a href="#cb139-79" aria-hidden="true" tabindex="-1"></a>  `(head</span>
<span id="cb139-80"><a href="#cb139-80" aria-hidden="true" tabindex="-1"></a>     (meta ((charset <span class="st">&quot;utf-8&quot;</span>)))</span>
<span id="cb139-81"><a href="#cb139-81" aria-hidden="true" tabindex="-1"></a>     (meta ((name <span class="st">&quot;viewport&quot;</span>)</span>
<span id="cb139-82"><a href="#cb139-82" aria-hidden="true" tabindex="-1"></a>            (content <span class="st">&quot;width=device-width, initial-scale=1.0&quot;</span>)))</span>
<span id="cb139-83"><a href="#cb139-83" aria-hidden="true" tabindex="-1"></a>     (title ,(render-text (document-title doc)))</span>
<span id="cb139-84"><a href="#cb139-84" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb139-85"><a href="#cb139-85" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Meta tags for SEO and social media</span></span>
<span id="cb139-86"><a href="#cb139-86" aria-hidden="true" tabindex="-1"></a>     ,@(render-meta-tags ctx doc)</span>
<span id="cb139-87"><a href="#cb139-87" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb139-88"><a href="#cb139-88" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; CSS includes</span></span>
<span id="cb139-89"><a href="#cb139-89" aria-hidden="true" tabindex="-1"></a>     ,@(render-stylesheets ctx doc)</span>
<span id="cb139-90"><a href="#cb139-90" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb139-91"><a href="#cb139-91" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Math renderer setup</span></span>
<span id="cb139-92"><a href="#cb139-92" aria-hidden="true" tabindex="-1"></a>     ,@(setup-math-renderer ctx)</span>
<span id="cb139-93"><a href="#cb139-93" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb139-94"><a href="#cb139-94" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Code highlighter setup</span></span>
<span id="cb139-95"><a href="#cb139-95" aria-hidden="true" tabindex="-1"></a>     ,@(setup-code-highlighter ctx)))</span>
<span id="cb139-96"><a href="#cb139-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-97"><a href="#cb139-97" aria-hidden="true" tabindex="-1"></a><span class="co">;; Document body generation</span></span>
<span id="cb139-98"><a href="#cb139-98" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-document-body ctx doc)</span>
<span id="cb139-99"><a href="#cb139-99" aria-hidden="true" tabindex="-1"></a>  `(body</span>
<span id="cb139-100"><a href="#cb139-100" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Skip navigation for accessibility</span></span>
<span id="cb139-101"><a href="#cb139-101" aria-hidden="true" tabindex="-1"></a>     (a ((href <span class="st">&quot;#main-content&quot;</span>)</span>
<span id="cb139-102"><a href="#cb139-102" aria-hidden="true" tabindex="-1"></a>         (class <span class="st">&quot;skip-nav&quot;</span>))</span>
<span id="cb139-103"><a href="#cb139-103" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Skip to main content&quot;</span>)</span>
<span id="cb139-104"><a href="#cb139-104" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb139-105"><a href="#cb139-105" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Header with title and metadata</span></span>
<span id="cb139-106"><a href="#cb139-106" aria-hidden="true" tabindex="-1"></a>     ,(render-header ctx doc)</span>
<span id="cb139-107"><a href="#cb139-107" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb139-108"><a href="#cb139-108" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Navigation with table of contents</span></span>
<span id="cb139-109"><a href="#cb139-109" aria-hidden="true" tabindex="-1"></a>     ,(render-navigation ctx doc)</span>
<span id="cb139-110"><a href="#cb139-110" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb139-111"><a href="#cb139-111" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Main content area</span></span>
<span id="cb139-112"><a href="#cb139-112" aria-hidden="true" tabindex="-1"></a>     (main ((id <span class="st">&quot;main-content&quot;</span>)</span>
<span id="cb139-113"><a href="#cb139-113" aria-hidden="true" tabindex="-1"></a>            (role <span class="st">&quot;main&quot;</span>))</span>
<span id="cb139-114"><a href="#cb139-114" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Abstract if present</span></span>
<span id="cb139-115"><a href="#cb139-115" aria-hidden="true" tabindex="-1"></a>       ,@(<span class="kw">if</span> (document-abstract doc)</span>
<span id="cb139-116"><a href="#cb139-116" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">list</span> (render-abstract ctx (document-abstract doc)))</span>
<span id="cb139-117"><a href="#cb139-117" aria-hidden="true" tabindex="-1"></a>             &#39;())</span>
<span id="cb139-118"><a href="#cb139-118" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb139-119"><a href="#cb139-119" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Main sections</span></span>
<span id="cb139-120"><a href="#cb139-120" aria-hidden="true" tabindex="-1"></a>       ,@(map (λ (section) (render-node ctx section))</span>
<span id="cb139-121"><a href="#cb139-121" aria-hidden="true" tabindex="-1"></a>              (document-sections doc))</span>
<span id="cb139-122"><a href="#cb139-122" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb139-123"><a href="#cb139-123" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Appendices</span></span>
<span id="cb139-124"><a href="#cb139-124" aria-hidden="true" tabindex="-1"></a>       ,@(<span class="kw">if</span> (<span class="kw">not</span> (<span class="kw">null?</span> (document-appendices doc)))</span>
<span id="cb139-125"><a href="#cb139-125" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">cons</span> `(h1 ((class <span class="st">&quot;appendices-header&quot;</span>)) <span class="st">&quot;Appendices&quot;</span>)</span>
<span id="cb139-126"><a href="#cb139-126" aria-hidden="true" tabindex="-1"></a>                   (map (λ (appendix) (render-node ctx appendix))</span>
<span id="cb139-127"><a href="#cb139-127" aria-hidden="true" tabindex="-1"></a>                        (document-appendices doc)))</span>
<span id="cb139-128"><a href="#cb139-128" aria-hidden="true" tabindex="-1"></a>             &#39;())</span>
<span id="cb139-129"><a href="#cb139-129" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb139-130"><a href="#cb139-130" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Bibliography</span></span>
<span id="cb139-131"><a href="#cb139-131" aria-hidden="true" tabindex="-1"></a>       ,@(<span class="kw">if</span> (<span class="kw">not</span> (<span class="kw">null?</span> (document-bibliography doc)))</span>
<span id="cb139-132"><a href="#cb139-132" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">list</span> (render-bibliography ctx (document-bibliography doc)))</span>
<span id="cb139-133"><a href="#cb139-133" aria-hidden="true" tabindex="-1"></a>             &#39;())</span>
<span id="cb139-134"><a href="#cb139-134" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb139-135"><a href="#cb139-135" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Footnotes</span></span>
<span id="cb139-136"><a href="#cb139-136" aria-hidden="true" tabindex="-1"></a>       ,@(<span class="kw">if</span> (<span class="kw">not</span> (<span class="kw">null?</span> (render-context-footnotes ctx)))</span>
<span id="cb139-137"><a href="#cb139-137" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">list</span> (render-footnotes ctx))</span>
<span id="cb139-138"><a href="#cb139-138" aria-hidden="true" tabindex="-1"></a>             &#39;()))</span>
<span id="cb139-139"><a href="#cb139-139" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb139-140"><a href="#cb139-140" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Footer</span></span>
<span id="cb139-141"><a href="#cb139-141" aria-hidden="true" tabindex="-1"></a>     ,(render-footer ctx doc)</span>
<span id="cb139-142"><a href="#cb139-142" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb139-143"><a href="#cb139-143" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Scripts at end of body</span></span>
<span id="cb139-144"><a href="#cb139-144" aria-hidden="true" tabindex="-1"></a>     ,@(render-scripts ctx doc)))</span></code></pre></div>
<h2 id="node-specific-rendering">Node-Specific Rendering</h2>
<p>Each document node type requires specialized rendering logic:</p>
<div class="sourceCode" id="cb140"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; node-renderers.rkt</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;html-renderer.rkt&quot;</span>)</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main node dispatcher</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-node ctx node)</span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(section? node) (render-section ctx node)<span class="op">]</span></span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(paragraph? node) (render-paragraph ctx node)<span class="op">]</span></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(text-run? node) (render-text-run ctx node)<span class="op">]</span></span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(emphasis? node) (render-emphasis ctx node)<span class="op">]</span></span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(hyperlink? node) (render-hyperlink ctx node)<span class="op">]</span></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(code-block? node) (render-code-block ctx node)<span class="op">]</span></span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(code-inline? node) (render-code-inline ctx node)<span class="op">]</span></span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(equation? node) (render-equation ctx node)<span class="op">]</span></span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(figure? node) (render-figure ctx node)<span class="op">]</span></span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(table? node) (render-table ctx node)<span class="op">]</span></span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(list-container? node) (render-list ctx node)<span class="op">]</span></span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(list-item? node) (render-list-item ctx node)<span class="op">]</span></span>
<span id="cb140-22"><a href="#cb140-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(block-quote? node) (render-block-quote ctx node)<span class="op">]</span></span>
<span id="cb140-23"><a href="#cb140-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(cross-reference? node) (render-cross-reference ctx node)<span class="op">]</span></span>
<span id="cb140-24"><a href="#cb140-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(footnote-ref? node) (render-footnote-ref ctx node)<span class="op">]</span></span>
<span id="cb140-25"><a href="#cb140-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> (render-generic-node ctx node)<span class="op">]</span>))</span>
<span id="cb140-26"><a href="#cb140-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-27"><a href="#cb140-27" aria-hidden="true" tabindex="-1"></a><span class="co">;; Section rendering with proper heading levels</span></span>
<span id="cb140-28"><a href="#cb140-28" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-section ctx section)</span>
<span id="cb140-29"><a href="#cb140-29" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> level </span>(section-level section))</span>
<span id="cb140-30"><a href="#cb140-30" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> heading-tag </span>(<span class="kw">string-&gt;symbol</span> (format <span class="st">&quot;h~a&quot;</span> (<span class="kw">min</span> level <span class="dv">6</span>))))</span>
<span id="cb140-31"><a href="#cb140-31" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> section-id </span>(generate-id ctx section))</span>
<span id="cb140-32"><a href="#cb140-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-33"><a href="#cb140-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Update context</span></span>
<span id="cb140-34"><a href="#cb140-34" aria-hidden="true" tabindex="-1"></a>  (set-render-context-current-section! ctx section)</span>
<span id="cb140-35"><a href="#cb140-35" aria-hidden="true" tabindex="-1"></a>  (increment-depth! ctx)</span>
<span id="cb140-36"><a href="#cb140-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-37"><a href="#cb140-37" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> rendered</span></span>
<span id="cb140-38"><a href="#cb140-38" aria-hidden="true" tabindex="-1"></a>    `(section ((id ,section-id)</span>
<span id="cb140-39"><a href="#cb140-39" aria-hidden="true" tabindex="-1"></a>               (class ,(format <span class="st">&quot;section level-~a&quot;</span> level))</span>
<span id="cb140-40"><a href="#cb140-40" aria-hidden="true" tabindex="-1"></a>               ,@(render-attributes section))</span>
<span id="cb140-41"><a href="#cb140-41" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Section heading</span></span>
<span id="cb140-42"><a href="#cb140-42" aria-hidden="true" tabindex="-1"></a>       (,heading-tag ((class <span class="st">&quot;section-heading&quot;</span>))</span>
<span id="cb140-43"><a href="#cb140-43" aria-hidden="true" tabindex="-1"></a>         ,@(<span class="kw">if</span> (section-number section)</span>
<span id="cb140-44"><a href="#cb140-44" aria-hidden="true" tabindex="-1"></a>               `((span ((class <span class="st">&quot;section-number&quot;</span>))</span>
<span id="cb140-45"><a href="#cb140-45" aria-hidden="true" tabindex="-1"></a>                      ,(section-number section) <span class="st">&quot;. &quot;</span>))</span>
<span id="cb140-46"><a href="#cb140-46" aria-hidden="true" tabindex="-1"></a>               &#39;())</span>
<span id="cb140-47"><a href="#cb140-47" aria-hidden="true" tabindex="-1"></a>         ,(render-node ctx (section-title section))</span>
<span id="cb140-48"><a href="#cb140-48" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb140-49"><a href="#cb140-49" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Permalink for deep linking</span></span>
<span id="cb140-50"><a href="#cb140-50" aria-hidden="true" tabindex="-1"></a>         (a ((href ,(format <span class="st">&quot;#~a&quot;</span> section-id))</span>
<span id="cb140-51"><a href="#cb140-51" aria-hidden="true" tabindex="-1"></a>             (class <span class="st">&quot;permalink&quot;</span>)</span>
<span id="cb140-52"><a href="#cb140-52" aria-hidden="true" tabindex="-1"></a>             (aria-label <span class="st">&quot;Permalink&quot;</span>))</span>
<span id="cb140-53"><a href="#cb140-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;¶&quot;</span>))</span>
<span id="cb140-54"><a href="#cb140-54" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb140-55"><a href="#cb140-55" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Section content</span></span>
<span id="cb140-56"><a href="#cb140-56" aria-hidden="true" tabindex="-1"></a>       ,@(map (λ (child) (render-node ctx child))</span>
<span id="cb140-57"><a href="#cb140-57" aria-hidden="true" tabindex="-1"></a>              (node-children section))))</span>
<span id="cb140-58"><a href="#cb140-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-59"><a href="#cb140-59" aria-hidden="true" tabindex="-1"></a>  (decrement-depth! ctx)</span>
<span id="cb140-60"><a href="#cb140-60" aria-hidden="true" tabindex="-1"></a>  rendered)</span>
<span id="cb140-61"><a href="#cb140-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-62"><a href="#cb140-62" aria-hidden="true" tabindex="-1"></a><span class="co">;; Paragraph rendering</span></span>
<span id="cb140-63"><a href="#cb140-63" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-paragraph ctx para)</span>
<span id="cb140-64"><a href="#cb140-64" aria-hidden="true" tabindex="-1"></a>  `(p ((class <span class="st">&quot;paragraph&quot;</span>)</span>
<span id="cb140-65"><a href="#cb140-65" aria-hidden="true" tabindex="-1"></a>       ,@(render-attributes para))</span>
<span id="cb140-66"><a href="#cb140-66" aria-hidden="true" tabindex="-1"></a>      ,@(map (λ (child) (render-node ctx child))</span>
<span id="cb140-67"><a href="#cb140-67" aria-hidden="true" tabindex="-1"></a>             (node-children para))))</span>
<span id="cb140-68"><a href="#cb140-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-69"><a href="#cb140-69" aria-hidden="true" tabindex="-1"></a><span class="co">;; Text run rendering with smart typography</span></span>
<span id="cb140-70"><a href="#cb140-70" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-text-run ctx text-node)</span>
<span id="cb140-71"><a href="#cb140-71" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> content </span>(text-run-content text-node))</span>
<span id="cb140-72"><a href="#cb140-72" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Apply smart typography transformations</span></span>
<span id="cb140-73"><a href="#cb140-73" aria-hidden="true" tabindex="-1"></a>  (smart-typography content))</span>
<span id="cb140-74"><a href="#cb140-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-75"><a href="#cb140-75" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(smart-typography text)</span>
<span id="cb140-76"><a href="#cb140-76" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Convert quotes, dashes, ellipses</span></span>
<span id="cb140-77"><a href="#cb140-77" aria-hidden="true" tabindex="-1"></a>  (regexp-replace* #px<span class="st">&quot;</span><span class="ch">\\</span><span class="st">.</span><span class="ch">\\</span><span class="st">.</span><span class="ch">\\</span><span class="st">.&quot;</span> </span>
<span id="cb140-78"><a href="#cb140-78" aria-hidden="true" tabindex="-1"></a>    (regexp-replace* #px<span class="st">&quot;--&quot;</span></span>
<span id="cb140-79"><a href="#cb140-79" aria-hidden="true" tabindex="-1"></a>      (regexp-replace* #px<span class="st">&quot;``&quot;</span> </span>
<span id="cb140-80"><a href="#cb140-80" aria-hidden="true" tabindex="-1"></a>        (regexp-replace* #px<span class="st">&quot;&#39;&#39;&quot;</span> text <span class="st">&quot;&quot;&quot;)</span></span>
<span id="cb140-81"><a href="#cb140-81" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span>)</span>
<span id="cb140-82"><a href="#cb140-82" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;—&quot;</span>)</span>
<span id="cb140-83"><a href="#cb140-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;…&quot;</span>))</span>
<span id="cb140-84"><a href="#cb140-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-85"><a href="#cb140-85" aria-hidden="true" tabindex="-1"></a><span class="co">;; Emphasis rendering</span></span>
<span id="cb140-86"><a href="#cb140-86" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-emphasis ctx emp)</span>
<span id="cb140-87"><a href="#cb140-87" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tag </span>(<span class="kw">if</span> (<span class="op">=</span> (emphasis-level emp) <span class="dv">2</span>) &#39;strong &#39;em))</span>
<span id="cb140-88"><a href="#cb140-88" aria-hidden="true" tabindex="-1"></a>  `(,tag ((class ,(format <span class="st">&quot;emphasis-~a&quot;</span> (emphasis-level emp))))</span>
<span id="cb140-89"><a href="#cb140-89" aria-hidden="true" tabindex="-1"></a>         ,@(map (λ (child) (render-node ctx child))</span>
<span id="cb140-90"><a href="#cb140-90" aria-hidden="true" tabindex="-1"></a>                (node-children emp))))</span>
<span id="cb140-91"><a href="#cb140-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-92"><a href="#cb140-92" aria-hidden="true" tabindex="-1"></a><span class="co">;; Code block rendering with syntax highlighting</span></span>
<span id="cb140-93"><a href="#cb140-93" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-code-block ctx code)</span>
<span id="cb140-94"><a href="#cb140-94" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> lang </span>(code-block-language code))</span>
<span id="cb140-95"><a href="#cb140-95" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> code-id </span>(generate-id ctx code))</span>
<span id="cb140-96"><a href="#cb140-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-97"><a href="#cb140-97" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">div</span> ((class <span class="st">&quot;code-block-container&quot;</span>))</span>
<span id="cb140-98"><a href="#cb140-98" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Language indicator</span></span>
<span id="cb140-99"><a href="#cb140-99" aria-hidden="true" tabindex="-1"></a>     ,@(<span class="kw">if</span> lang</span>
<span id="cb140-100"><a href="#cb140-100" aria-hidden="true" tabindex="-1"></a>           `((<span class="kw">div</span> ((class <span class="st">&quot;code-language&quot;</span>)) ,lang))</span>
<span id="cb140-101"><a href="#cb140-101" aria-hidden="true" tabindex="-1"></a>           &#39;())</span>
<span id="cb140-102"><a href="#cb140-102" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb140-103"><a href="#cb140-103" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Copy button</span></span>
<span id="cb140-104"><a href="#cb140-104" aria-hidden="true" tabindex="-1"></a>     (button ((class <span class="st">&quot;code-copy&quot;</span>)</span>
<span id="cb140-105"><a href="#cb140-105" aria-hidden="true" tabindex="-1"></a>              (data-target ,code-id)</span>
<span id="cb140-106"><a href="#cb140-106" aria-hidden="true" tabindex="-1"></a>              (aria-label <span class="st">&quot;Copy code&quot;</span>))</span>
<span id="cb140-107"><a href="#cb140-107" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;Copy&quot;</span>)</span>
<span id="cb140-108"><a href="#cb140-108" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb140-109"><a href="#cb140-109" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Code block</span></span>
<span id="cb140-110"><a href="#cb140-110" aria-hidden="true" tabindex="-1"></a>     (pre ((class ,(format <span class="st">&quot;code-block language-~a&quot;</span> (<span class="kw">or</span> lang <span class="st">&quot;plain&quot;</span>)))</span>
<span id="cb140-111"><a href="#cb140-111" aria-hidden="true" tabindex="-1"></a>           (id ,code-id))</span>
<span id="cb140-112"><a href="#cb140-112" aria-hidden="true" tabindex="-1"></a>       (code ,@(map (λ (child) (render-node ctx child))</span>
<span id="cb140-113"><a href="#cb140-113" aria-hidden="true" tabindex="-1"></a>                    (node-children code))))</span>
<span id="cb140-114"><a href="#cb140-114" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb140-115"><a href="#cb140-115" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Execution output if present</span></span>
<span id="cb140-116"><a href="#cb140-116" aria-hidden="true" tabindex="-1"></a>     ,@(<span class="kw">if</span> (code-block-output code)</span>
<span id="cb140-117"><a href="#cb140-117" aria-hidden="true" tabindex="-1"></a>           `((<span class="kw">div</span> ((class <span class="st">&quot;code-output&quot;</span>))</span>
<span id="cb140-118"><a href="#cb140-118" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">div</span> ((class <span class="st">&quot;output-label&quot;</span>)) <span class="st">&quot;Output:&quot;</span>)</span>
<span id="cb140-119"><a href="#cb140-119" aria-hidden="true" tabindex="-1"></a>               (pre ,(code-block-output code))))</span>
<span id="cb140-120"><a href="#cb140-120" aria-hidden="true" tabindex="-1"></a>           &#39;())))</span>
<span id="cb140-121"><a href="#cb140-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-122"><a href="#cb140-122" aria-hidden="true" tabindex="-1"></a><span class="co">;; Mathematics rendering</span></span>
<span id="cb140-123"><a href="#cb140-123" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-equation ctx eq)</span>
<span id="cb140-124"><a href="#cb140-124" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> math-content </span>(render-math-content ctx (node-children eq)))</span>
<span id="cb140-125"><a href="#cb140-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-126"><a href="#cb140-126" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb140-127"><a href="#cb140-127" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(eq &#39;display (equation-display eq))</span>
<span id="cb140-128"><a href="#cb140-128" aria-hidden="true" tabindex="-1"></a>     `(<span class="kw">div</span> ((class <span class="st">&quot;equation display&quot;</span>)</span>
<span id="cb140-129"><a href="#cb140-129" aria-hidden="true" tabindex="-1"></a>            ,@(<span class="kw">if</span> (equation-label eq)</span>
<span id="cb140-130"><a href="#cb140-130" aria-hidden="true" tabindex="-1"></a>                  `((id ,(<span class="kw">symbol-&gt;string</span> (equation-label eq))))</span>
<span id="cb140-131"><a href="#cb140-131" aria-hidden="true" tabindex="-1"></a>                  &#39;()))</span>
<span id="cb140-132"><a href="#cb140-132" aria-hidden="true" tabindex="-1"></a>        ,@(<span class="kw">if</span> (equation-numbered eq)</span>
<span id="cb140-133"><a href="#cb140-133" aria-hidden="true" tabindex="-1"></a>              `((span ((class <span class="st">&quot;equation-number&quot;</span>))</span>
<span id="cb140-134"><a href="#cb140-134" aria-hidden="true" tabindex="-1"></a>                     ,(format <span class="st">&quot;(~a)&quot;</span> (get-equation-number ctx eq))))</span>
<span id="cb140-135"><a href="#cb140-135" aria-hidden="true" tabindex="-1"></a>              &#39;())</span>
<span id="cb140-136"><a href="#cb140-136" aria-hidden="true" tabindex="-1"></a>        ,math-content)<span class="op">]</span></span>
<span id="cb140-137"><a href="#cb140-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-138"><a href="#cb140-138" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span>  <span class="co">; inline</span></span>
<span id="cb140-139"><a href="#cb140-139" aria-hidden="true" tabindex="-1"></a>     `(span ((class <span class="st">&quot;equation inline&quot;</span>))</span>
<span id="cb140-140"><a href="#cb140-140" aria-hidden="true" tabindex="-1"></a>            ,math-content)<span class="op">]</span>))</span>
<span id="cb140-141"><a href="#cb140-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-142"><a href="#cb140-142" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-math-content ctx content)</span>
<span id="cb140-143"><a href="#cb140-143" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> options </span>(render-context-options ctx))</span>
<span id="cb140-144"><a href="#cb140-144" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case</span> (render-options-math-renderer options)</span>
<span id="cb140-145"><a href="#cb140-145" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(katex)</span>
<span id="cb140-146"><a href="#cb140-146" aria-hidden="true" tabindex="-1"></a>     `(span ((class <span class="st">&quot;katex-math&quot;</span>)</span>
<span id="cb140-147"><a href="#cb140-147" aria-hidden="true" tabindex="-1"></a>             (data-latex ,(math-to-latex content))))<span class="op">]</span></span>
<span id="cb140-148"><a href="#cb140-148" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(mathjax)</span>
<span id="cb140-149"><a href="#cb140-149" aria-hidden="true" tabindex="-1"></a>     `(script ((type <span class="st">&quot;math/tex&quot;</span>))</span>
<span id="cb140-150"><a href="#cb140-150" aria-hidden="true" tabindex="-1"></a>              ,(math-to-latex content))<span class="op">]</span>))</span></code></pre></div>
<h2 id="table-and-figure-rendering">Table and Figure Rendering</h2>
<p>Complex structures like tables and figures require careful HTML
generation:</p>
<div class="sourceCode" id="cb141"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; complex-elements.rkt</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;html-renderer.rkt&quot;</span>)</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Table rendering with responsive wrapper</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-table ctx tbl)</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> table-id </span>(generate-id ctx tbl))</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> table-num </span>(increment-counter! ctx &#39;table))</span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">div</span> ((class <span class="st">&quot;table-container&quot;</span>)</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>         (id ,table-id))</span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Table caption</span></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a>     ,@(<span class="kw">if</span> (table-caption tbl)</span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>           `((<span class="kw">div</span> ((class <span class="st">&quot;table-caption&quot;</span>))</span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>               (span ((class <span class="st">&quot;table-label&quot;</span>))</span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a>                     ,(format <span class="st">&quot;Table ~a: &quot;</span> table-num))</span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>               ,(render-node ctx (table-caption tbl))))</span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a>           &#39;())</span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Responsive wrapper</span></span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">div</span> ((class <span class="st">&quot;table-responsive&quot;</span>))</span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a>       (table ((class <span class="st">&quot;data-table&quot;</span>))</span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Table header</span></span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a>         ,@(<span class="kw">if</span> (table-headers tbl)</span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a>               `((thead</span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a>                   (tr ,@(map (λ (header)</span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a>                               `(th ,(render-node ctx header)))</span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a>                             (table-headers tbl)))))</span>
<span id="cb141-31"><a href="#cb141-31" aria-hidden="true" tabindex="-1"></a>               &#39;())</span>
<span id="cb141-32"><a href="#cb141-32" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb141-33"><a href="#cb141-33" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Table body</span></span>
<span id="cb141-34"><a href="#cb141-34" aria-hidden="true" tabindex="-1"></a>         (tbody</span>
<span id="cb141-35"><a href="#cb141-35" aria-hidden="true" tabindex="-1"></a>           ,@(map (λ (row)</span>
<span id="cb141-36"><a href="#cb141-36" aria-hidden="true" tabindex="-1"></a>                   `(tr ,@(map (λ (cell)</span>
<span id="cb141-37"><a href="#cb141-37" aria-hidden="true" tabindex="-1"></a>                                `(td ,(render-node ctx cell)))</span>
<span id="cb141-38"><a href="#cb141-38" aria-hidden="true" tabindex="-1"></a>                              row)))</span>
<span id="cb141-39"><a href="#cb141-39" aria-hidden="true" tabindex="-1"></a>                 (table-rows tbl)))))))</span>
<span id="cb141-40"><a href="#cb141-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-41"><a href="#cb141-41" aria-hidden="true" tabindex="-1"></a><span class="co">;; Figure rendering with multiple formats</span></span>
<span id="cb141-42"><a href="#cb141-42" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-figure ctx fig)</span>
<span id="cb141-43"><a href="#cb141-43" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> fig-id </span>(generate-id ctx fig))</span>
<span id="cb141-44"><a href="#cb141-44" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> fig-num </span>(increment-counter! ctx &#39;figure))</span>
<span id="cb141-45"><a href="#cb141-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-46"><a href="#cb141-46" aria-hidden="true" tabindex="-1"></a>  `(figure ((class <span class="st">&quot;figure&quot;</span>)</span>
<span id="cb141-47"><a href="#cb141-47" aria-hidden="true" tabindex="-1"></a>            (id ,fig-id))</span>
<span id="cb141-48"><a href="#cb141-48" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Picture element for responsive images</span></span>
<span id="cb141-49"><a href="#cb141-49" aria-hidden="true" tabindex="-1"></a>     (picture</span>
<span id="cb141-50"><a href="#cb141-50" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; WebP version for modern browsers</span></span>
<span id="cb141-51"><a href="#cb141-51" aria-hidden="true" tabindex="-1"></a>       (source ((srcset ,(path-with-extension (figure-source fig) <span class="st">&quot;.webp&quot;</span>))</span>
<span id="cb141-52"><a href="#cb141-52" aria-hidden="true" tabindex="-1"></a>                (type <span class="st">&quot;image/webp&quot;</span>)))</span>
<span id="cb141-53"><a href="#cb141-53" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb141-54"><a href="#cb141-54" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Original format fallback</span></span>
<span id="cb141-55"><a href="#cb141-55" aria-hidden="true" tabindex="-1"></a>       (img ((src ,(figure-source fig))</span>
<span id="cb141-56"><a href="#cb141-56" aria-hidden="true" tabindex="-1"></a>             (alt ,(<span class="kw">or</span> (extract-alt-text (figure-caption fig))</span>
<span id="cb141-57"><a href="#cb141-57" aria-hidden="true" tabindex="-1"></a>                      (format <span class="st">&quot;Figure ~a&quot;</span> fig-num)))</span>
<span id="cb141-58"><a href="#cb141-58" aria-hidden="true" tabindex="-1"></a>             ,@(<span class="kw">if</span> (figure-width fig)</span>
<span id="cb141-59"><a href="#cb141-59" aria-hidden="true" tabindex="-1"></a>                   `((width ,(figure-width fig)))</span>
<span id="cb141-60"><a href="#cb141-60" aria-hidden="true" tabindex="-1"></a>                   &#39;())</span>
<span id="cb141-61"><a href="#cb141-61" aria-hidden="true" tabindex="-1"></a>             ,@(<span class="kw">if</span> (figure-height fig)</span>
<span id="cb141-62"><a href="#cb141-62" aria-hidden="true" tabindex="-1"></a>                   `((height ,(figure-height fig)))</span>
<span id="cb141-63"><a href="#cb141-63" aria-hidden="true" tabindex="-1"></a>                   &#39;())</span>
<span id="cb141-64"><a href="#cb141-64" aria-hidden="true" tabindex="-1"></a>             (loading <span class="st">&quot;lazy&quot;</span>))))</span>
<span id="cb141-65"><a href="#cb141-65" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb141-66"><a href="#cb141-66" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Figure caption</span></span>
<span id="cb141-67"><a href="#cb141-67" aria-hidden="true" tabindex="-1"></a>     ,@(<span class="kw">if</span> (figure-caption fig)</span>
<span id="cb141-68"><a href="#cb141-68" aria-hidden="true" tabindex="-1"></a>           `((figcaption</span>
<span id="cb141-69"><a href="#cb141-69" aria-hidden="true" tabindex="-1"></a>               (span ((class <span class="st">&quot;figure-label&quot;</span>))</span>
<span id="cb141-70"><a href="#cb141-70" aria-hidden="true" tabindex="-1"></a>                     ,(format <span class="st">&quot;Figure ~a: &quot;</span> fig-num))</span>
<span id="cb141-71"><a href="#cb141-71" aria-hidden="true" tabindex="-1"></a>               ,(render-node ctx (figure-caption fig))))</span>
<span id="cb141-72"><a href="#cb141-72" aria-hidden="true" tabindex="-1"></a>           &#39;())))</span>
<span id="cb141-73"><a href="#cb141-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-74"><a href="#cb141-74" aria-hidden="true" tabindex="-1"></a><span class="co">;; Cross-reference rendering</span></span>
<span id="cb141-75"><a href="#cb141-75" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-cross-reference ctx ref)</span>
<span id="cb141-76"><a href="#cb141-76" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> resolved </span>(cross-reference-resolved ref))</span>
<span id="cb141-77"><a href="#cb141-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-78"><a href="#cb141-78" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> resolved</span>
<span id="cb141-79"><a href="#cb141-79" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">let</span> (<span class="op">[</span>ref-type (reference-info-type resolved)<span class="op">]</span></span>
<span id="cb141-80"><a href="#cb141-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span>ref-num (reference-info-number resolved)<span class="op">]</span></span>
<span id="cb141-81"><a href="#cb141-81" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span>ref-title (reference-info-title resolved)<span class="op">]</span>)</span>
<span id="cb141-82"><a href="#cb141-82" aria-hidden="true" tabindex="-1"></a>        `(a ((href ,(format <span class="st">&quot;#~a&quot;</span> (cross-reference-target ref)))</span>
<span id="cb141-83"><a href="#cb141-83" aria-hidden="true" tabindex="-1"></a>             (class ,(format <span class="st">&quot;cross-ref ref-~a&quot;</span> ref-type)))</span>
<span id="cb141-84"><a href="#cb141-84" aria-hidden="true" tabindex="-1"></a>            ,(format-reference ref-type ref-num)))</span>
<span id="cb141-85"><a href="#cb141-85" aria-hidden="true" tabindex="-1"></a>      `(span ((class <span class="st">&quot;broken-ref&quot;</span>))</span>
<span id="cb141-86"><a href="#cb141-86" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;??&quot;</span>)))</span>
<span id="cb141-87"><a href="#cb141-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-88"><a href="#cb141-88" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(format-reference type number)</span>
<span id="cb141-89"><a href="#cb141-89" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case</span> type</span>
<span id="cb141-90"><a href="#cb141-90" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(section) (format <span class="st">&quot;Section ~a&quot;</span> number)<span class="op">]</span></span>
<span id="cb141-91"><a href="#cb141-91" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(figure) (format <span class="st">&quot;Figure ~a&quot;</span> number)<span class="op">]</span></span>
<span id="cb141-92"><a href="#cb141-92" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(table) (format <span class="st">&quot;Table ~a&quot;</span> number)<span class="op">]</span></span>
<span id="cb141-93"><a href="#cb141-93" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(equation) (format <span class="st">&quot;(~a)&quot;</span> number)<span class="op">]</span></span>
<span id="cb141-94"><a href="#cb141-94" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> number<span class="op">]</span>))</span></code></pre></div>
<h2 id="css-generation-and-theming">CSS Generation and Theming</h2>
<p>The pipeline generates CSS dynamically based on the document
structure and theme:</p>
<div class="sourceCode" id="cb142"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; css-generator.rkt</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>(require css-expr)</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>(provide generate-css</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>         generate-theme-css)</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate main stylesheet</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-css ctx doc)</span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> theme </span>(get-theme ctx))</span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>  (css</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Reset and base styles</span></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>    (rule <span class="st">&quot;*&quot;</span> </span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>      (margin <span class="dv">0</span>)</span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>      (padding <span class="dv">0</span>)</span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>      (box-sizing &#39;border-box))</span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>    (rule <span class="st">&quot;html&quot;</span></span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>      (font-family (theme-font-family theme))</span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>      (font-size (theme-base-font-size theme))</span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>      (line-height <span class="fl">1.6</span>)</span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>      (color (theme-text-color theme))</span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>      (background-color (theme-bg-color theme)))</span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Typography</span></span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>    (rule <span class="st">&quot;h1, h2, h3, h4, h5, h6&quot;</span></span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a>      (font-family (theme-heading-font theme))</span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a>      (margin-top &#39;<span class="fl">1.5</span>em)</span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>      (margin-bottom &#39;<span class="fl">0.5</span>em)</span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a>      (line-height <span class="fl">1.2</span>))</span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true" tabindex="-1"></a>    (rule <span class="st">&quot;h1&quot;</span> (font-size &#39;<span class="fl">2.5</span>em))</span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true" tabindex="-1"></a>    (rule <span class="st">&quot;h2&quot;</span> (font-size &#39;<span class="dv">2</span>em))</span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true" tabindex="-1"></a>    (rule <span class="st">&quot;h3&quot;</span> (font-size &#39;<span class="fl">1.5</span>em))</span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Main layout</span></span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true" tabindex="-1"></a>    (rule <span class="st">&quot;body&quot;</span></span>
<span id="cb142-40"><a href="#cb142-40" aria-hidden="true" tabindex="-1"></a>      (max-width &#39;<span class="dv">48</span>em)</span>
<span id="cb142-41"><a href="#cb142-41" aria-hidden="true" tabindex="-1"></a>      (margin &#39;<span class="dv">0</span> &#39;auto)</span>
<span id="cb142-42"><a href="#cb142-42" aria-hidden="true" tabindex="-1"></a>      (padding &#39;<span class="dv">2</span>em))</span>
<span id="cb142-43"><a href="#cb142-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-44"><a href="#cb142-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Responsive design</span></span>
<span id="cb142-45"><a href="#cb142-45" aria-hidden="true" tabindex="-1"></a>    (media <span class="st">&quot;(max-width: 768px)&quot;</span></span>
<span id="cb142-46"><a href="#cb142-46" aria-hidden="true" tabindex="-1"></a>      (rule <span class="st">&quot;body&quot;</span></span>
<span id="cb142-47"><a href="#cb142-47" aria-hidden="true" tabindex="-1"></a>        (padding &#39;<span class="dv">1</span>em))</span>
<span id="cb142-48"><a href="#cb142-48" aria-hidden="true" tabindex="-1"></a>      (rule <span class="st">&quot;.table-responsive&quot;</span></span>
<span id="cb142-49"><a href="#cb142-49" aria-hidden="true" tabindex="-1"></a>        (overflow-x &#39;auto)))</span>
<span id="cb142-50"><a href="#cb142-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-51"><a href="#cb142-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Code blocks</span></span>
<span id="cb142-52"><a href="#cb142-52" aria-hidden="true" tabindex="-1"></a>    (rule <span class="st">&quot;pre.code-block&quot;</span></span>
<span id="cb142-53"><a href="#cb142-53" aria-hidden="true" tabindex="-1"></a># Chapter <span class="dv">8</span>: PDF Generation with Racket</span>
<span id="cb142-54"><a href="#cb142-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-55"><a href="#cb142-55" aria-hidden="true" tabindex="-1"></a>## The Challenge of Print-Quality Output</span>
<span id="cb142-56"><a href="#cb142-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-57"><a href="#cb142-57" aria-hidden="true" tabindex="-1"></a>While HTML excels at responsive, interactive content, PDF remains the gold standard for print-quality documents. Our static site generator must produce PDFs that rival those created by professional typesetting systems. This means precise control over typography, sophisticated page layout algorithms, <span class="kw">and</span> proper handling of floating elements like figures <span class="kw">and</span> tables.</span>
<span id="cb142-58"><a href="#cb142-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-59"><a href="#cb142-59" aria-hidden="true" tabindex="-1"></a>Racket&#39;s PDF generation capabilities, built on the `racket/draw` library, provide low-level primitives for creating PDF documents. We&#39;ll build a higher-level abstraction that transforms our document model into beautifully typeset PDFs, complete with automatic page breaking, widow/orphan control, <span class="kw">and</span> professional-quality mathematical typesetting.</span>
<span id="cb142-60"><a href="#cb142-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-61"><a href="#cb142-61" aria-hidden="true" tabindex="-1"></a>## PDF Generation Architecture</span>
<span id="cb142-62"><a href="#cb142-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-63"><a href="#cb142-63" aria-hidden="true" tabindex="-1"></a>Our PDF pipeline operates in multiple passes to handle the complexities of print layout:</span>
<span id="cb142-64"><a href="#cb142-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-65"><a href="#cb142-65" aria-hidden="true" tabindex="-1"></a>```scheme</span>
<span id="cb142-66"><a href="#cb142-66" aria-hidden="true" tabindex="-1"></a><span class="co">;; pdf-renderer.rkt</span></span>
<span id="cb142-67"><a href="#cb142-67" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb142-68"><a href="#cb142-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-69"><a href="#cb142-69" aria-hidden="true" tabindex="-1"></a>(require racket/draw</span>
<span id="cb142-70"><a href="#cb142-70" aria-hidden="true" tabindex="-1"></a>         racket/class</span>
<span id="cb142-71"><a href="#cb142-71" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb142-72"><a href="#cb142-72" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;cross-references.rkt&quot;</span>)</span>
<span id="cb142-73"><a href="#cb142-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-74"><a href="#cb142-74" aria-hidden="true" tabindex="-1"></a>(provide render-pdf</span>
<span id="cb142-75"><a href="#cb142-75" aria-hidden="true" tabindex="-1"></a>         render-pdf-to-file)</span>
<span id="cb142-76"><a href="#cb142-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-77"><a href="#cb142-77" aria-hidden="true" tabindex="-1"></a><span class="co">;; PDF rendering context</span></span>
<span id="cb142-78"><a href="#cb142-78" aria-hidden="true" tabindex="-1"></a>(struct pdf-context</span>
<span id="cb142-79"><a href="#cb142-79" aria-hidden="true" tabindex="-1"></a>  (dc              <span class="co">; drawing context</span></span>
<span id="cb142-80"><a href="#cb142-80" aria-hidden="true" tabindex="-1"></a>   current-page    <span class="co">; current page number</span></span>
<span id="cb142-81"><a href="#cb142-81" aria-hidden="true" tabindex="-1"></a>   current-y       <span class="co">; current y position</span></span>
<span id="cb142-82"><a href="#cb142-82" aria-hidden="true" tabindex="-1"></a>   page-height     <span class="co">; usable page height</span></span>
<span id="cb142-83"><a href="#cb142-83" aria-hidden="true" tabindex="-1"></a>   page-width      <span class="co">; usable page width</span></span>
<span id="cb142-84"><a href="#cb142-84" aria-hidden="true" tabindex="-1"></a>   margin          <span class="co">; page margins</span></span>
<span id="cb142-85"><a href="#cb142-85" aria-hidden="true" tabindex="-1"></a>   styles          <span class="co">; style stack</span></span>
<span id="cb142-86"><a href="#cb142-86" aria-hidden="true" tabindex="-1"></a>   fonts           <span class="co">; font cache</span></span>
<span id="cb142-87"><a href="#cb142-87" aria-hidden="true" tabindex="-1"></a>   pending-floats  <span class="co">; figures/tables waiting for placement</span></span>
<span id="cb142-88"><a href="#cb142-88" aria-hidden="true" tabindex="-1"></a>   footnotes       <span class="co">; footnotes for current page</span></span>
<span id="cb142-89"><a href="#cb142-89" aria-hidden="true" tabindex="-1"></a>   page-breaks     <span class="co">; calculated page breaks</span></span>
<span id="cb142-90"><a href="#cb142-90" aria-hidden="true" tabindex="-1"></a>   cross-refs)     <span class="co">; cross-reference positions</span></span>
<span id="cb142-91"><a href="#cb142-91" aria-hidden="true" tabindex="-1"></a>  #:mutable)</span>
<span id="cb142-92"><a href="#cb142-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-93"><a href="#cb142-93" aria-hidden="true" tabindex="-1"></a><span class="co">;; PDF generation options</span></span>
<span id="cb142-94"><a href="#cb142-94" aria-hidden="true" tabindex="-1"></a>(struct pdf-options</span>
<span id="cb142-95"><a href="#cb142-95" aria-hidden="true" tabindex="-1"></a>  (page-size      <span class="co">; &#39;letter, &#39;a4, etc.</span></span>
<span id="cb142-96"><a href="#cb142-96" aria-hidden="true" tabindex="-1"></a>   orientation    <span class="co">; &#39;portrait or &#39;landscape</span></span>
<span id="cb142-97"><a href="#cb142-97" aria-hidden="true" tabindex="-1"></a>   margins        <span class="co">; margin specification</span></span>
<span id="cb142-98"><a href="#cb142-98" aria-hidden="true" tabindex="-1"></a>   font-family    <span class="co">; base font family</span></span>
<span id="cb142-99"><a href="#cb142-99" aria-hidden="true" tabindex="-1"></a>   font-size      <span class="co">; base font size</span></span>
<span id="cb142-100"><a href="#cb142-100" aria-hidden="true" tabindex="-1"></a>   line-height    <span class="co">; line height multiplier</span></span>
<span id="cb142-101"><a href="#cb142-101" aria-hidden="true" tabindex="-1"></a>   columns        <span class="co">; number of columns</span></span>
<span id="cb142-102"><a href="#cb142-102" aria-hidden="true" tabindex="-1"></a>   toc            <span class="co">; include table of contents?</span></span>
<span id="cb142-103"><a href="#cb142-103" aria-hidden="true" tabindex="-1"></a>   index)         <span class="co">; include index?</span></span>
<span id="cb142-104"><a href="#cb142-104" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb142-105"><a href="#cb142-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-106"><a href="#cb142-106" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main entry point</span></span>
<span id="cb142-107"><a href="#cb142-107" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-pdf doc #:options <span class="op">[</span>options (default-pdf-options)<span class="op">]</span>)</span>
<span id="cb142-108"><a href="#cb142-108" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> resolved-doc </span>(resolve-references doc))</span>
<span id="cb142-109"><a href="#cb142-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-110"><a href="#cb142-110" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; First pass: measure content and calculate layout</span></span>
<span id="cb142-111"><a href="#cb142-111" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> layout-info </span>(calculate-layout resolved-doc options))</span>
<span id="cb142-112"><a href="#cb142-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-113"><a href="#cb142-113" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Second pass: render with known page breaks</span></span>
<span id="cb142-114"><a href="#cb142-114" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> pdf-doc </span>(render-with-layout resolved-doc layout-info options))</span>
<span id="cb142-115"><a href="#cb142-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-116"><a href="#cb142-116" aria-hidden="true" tabindex="-1"></a>  pdf-doc)</span>
<span id="cb142-117"><a href="#cb142-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-118"><a href="#cb142-118" aria-hidden="true" tabindex="-1"></a><span class="co">;; Default options</span></span>
<span id="cb142-119"><a href="#cb142-119" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(default-pdf-options)</span>
<span id="cb142-120"><a href="#cb142-120" aria-hidden="true" tabindex="-1"></a>  (pdf-options &#39;letter &#39;portrait </span>
<span id="cb142-121"><a href="#cb142-121" aria-hidden="true" tabindex="-1"></a>               (margins <span class="dv">72</span> <span class="dv">72</span> <span class="dv">72</span> <span class="dv">72</span>)  <span class="co">; 1 inch margins</span></span>
<span id="cb142-122"><a href="#cb142-122" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;Times&quot;</span> <span class="dv">11</span> <span class="fl">1.5</span> <span class="dv">1</span> <span class="dv">#t</span> <span class="dv">#t</span>))</span>
<span id="cb142-123"><a href="#cb142-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-124"><a href="#cb142-124" aria-hidden="true" tabindex="-1"></a><span class="co">;; Layout calculation pass</span></span>
<span id="cb142-125"><a href="#cb142-125" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(calculate-layout doc options)</span>
<span id="cb142-126"><a href="#cb142-126" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(new pdf-dc% </span>
<span id="cb142-127"><a href="#cb142-127" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>output-port (open-output-bytes)<span class="op">]</span></span>
<span id="cb142-128"><a href="#cb142-128" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>width (page-width options)<span class="op">]</span></span>
<span id="cb142-129"><a href="#cb142-129" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>height (page-height options)<span class="op">]</span>))</span>
<span id="cb142-130"><a href="#cb142-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-131"><a href="#cb142-131" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ctx </span>(make-pdf-context dc options))</span>
<span id="cb142-132"><a href="#cb142-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-133"><a href="#cb142-133" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Measure all content</span></span>
<span id="cb142-134"><a href="#cb142-134" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> measurements </span>(measure-document ctx doc))</span>
<span id="cb142-135"><a href="#cb142-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-136"><a href="#cb142-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Calculate optimal page breaks</span></span>
<span id="cb142-137"><a href="#cb142-137" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> breaks </span>(calculate-page-breaks measurements ctx))</span>
<span id="cb142-138"><a href="#cb142-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-139"><a href="#cb142-139" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Assign floats to pages</span></span>
<span id="cb142-140"><a href="#cb142-140" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> float-placement </span>(place-floats measurements breaks ctx))</span>
<span id="cb142-141"><a href="#cb142-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-142"><a href="#cb142-142" aria-hidden="true" tabindex="-1"></a>  (layout-info measurements breaks float-placement))</span>
<span id="cb142-143"><a href="#cb142-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-144"><a href="#cb142-144" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main rendering pass</span></span>
<span id="cb142-145"><a href="#cb142-145" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-with-layout doc layout options)</span>
<span id="cb142-146"><a href="#cb142-146" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> filename </span>(make-temporary-file <span class="st">&quot;shrdlu-pdf-~a.pdf&quot;</span>))</span>
<span id="cb142-147"><a href="#cb142-147" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(new pdf-dc% </span>
<span id="cb142-148"><a href="#cb142-148" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>output-port (<span class="kw">open-output-file</span> filename #:exists &#39;replace)<span class="op">]</span></span>
<span id="cb142-149"><a href="#cb142-149" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>width (page-width options)<span class="op">]</span></span>
<span id="cb142-150"><a href="#cb142-150" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>height (page-height options)<span class="op">]</span>))</span>
<span id="cb142-151"><a href="#cb142-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-152"><a href="#cb142-152" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ctx </span>(make-pdf-context dc options))</span>
<span id="cb142-153"><a href="#cb142-153" aria-hidden="true" tabindex="-1"></a>  (set-pdf-context-page-breaks! ctx (layout-info-breaks layout))</span>
<span id="cb142-154"><a href="#cb142-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-155"><a href="#cb142-155" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Start document</span></span>
<span id="cb142-156"><a href="#cb142-156" aria-hidden="true" tabindex="-1"></a>  (send dc start-doc <span class="st">&quot;Generated Document&quot;</span>)</span>
<span id="cb142-157"><a href="#cb142-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-158"><a href="#cb142-158" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Render front matter</span></span>
<span id="cb142-159"><a href="#cb142-159" aria-hidden="true" tabindex="-1"></a>  (render-title-page ctx doc)</span>
<span id="cb142-160"><a href="#cb142-160" aria-hidden="true" tabindex="-1"></a>  (when (pdf-options-toc options)</span>
<span id="cb142-161"><a href="#cb142-161" aria-hidden="true" tabindex="-1"></a>    (render-table-of-contents ctx doc))</span>
<span id="cb142-162"><a href="#cb142-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-163"><a href="#cb142-163" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Render main content</span></span>
<span id="cb142-164"><a href="#cb142-164" aria-hidden="true" tabindex="-1"></a>  (render-document-content ctx doc)</span>
<span id="cb142-165"><a href="#cb142-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-166"><a href="#cb142-166" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Render back matter</span></span>
<span id="cb142-167"><a href="#cb142-167" aria-hidden="true" tabindex="-1"></a>  (render-bibliography-pdf ctx doc)</span>
<span id="cb142-168"><a href="#cb142-168" aria-hidden="true" tabindex="-1"></a>  (when (pdf-options-index options)</span>
<span id="cb142-169"><a href="#cb142-169" aria-hidden="true" tabindex="-1"></a>    (render-index-pdf ctx doc))</span>
<span id="cb142-170"><a href="#cb142-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-171"><a href="#cb142-171" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Finish document</span></span>
<span id="cb142-172"><a href="#cb142-172" aria-hidden="true" tabindex="-1"></a>  (send dc end-doc)</span>
<span id="cb142-173"><a href="#cb142-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-174"><a href="#cb142-174" aria-hidden="true" tabindex="-1"></a>  filename)</span></code></pre></div>
<h2 id="text-layout-and-line-breaking">Text Layout and Line
Breaking</h2>
<p>Professional typesetting requires sophisticated line breaking
algorithms:</p>
<div class="sourceCode" id="cb143"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; text-layout.rkt</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>(require racket/draw)</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Paragraph layout with optimal line breaking</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(layout-paragraph ctx para-node)</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> text </span>(extract-text para-node))</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> width </span>(<span class="op">-</span> (pdf-context-page-width ctx)</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>                  (<span class="op">*</span> <span class="dv">2</span> (margin-left (pdf-context-margin ctx)))))</span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Use Knuth-Plass line breaking algorithm</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> lines </span>(break-paragraph text width ctx))</span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Calculate paragraph metrics</span></span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> metrics</span></span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a>    (paragraph-metrics</span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a>     lines</span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a>     (calculate-paragraph-height lines ctx)</span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a>     (check-widow-orphan lines))))</span>
<span id="cb143-21"><a href="#cb143-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-22"><a href="#cb143-22" aria-hidden="true" tabindex="-1"></a><span class="co">;; Knuth-Plass line breaking</span></span>
<span id="cb143-23"><a href="#cb143-23" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(break-paragraph text width ctx)</span>
<span id="cb143-24"><a href="#cb143-24" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> words </span>(tokenize-text text))</span>
<span id="cb143-25"><a href="#cb143-25" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> nodes </span>(create-break-nodes words ctx))</span>
<span id="cb143-26"><a href="#cb143-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-27"><a href="#cb143-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Calculate optimal breakpoints</span></span>
<span id="cb143-28"><a href="#cb143-28" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> breaks </span>(find-optimal-breaks nodes width))</span>
<span id="cb143-29"><a href="#cb143-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-30"><a href="#cb143-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Build lines from breakpoints</span></span>
<span id="cb143-31"><a href="#cb143-31" aria-hidden="true" tabindex="-1"></a>  (build-lines nodes breaks ctx))</span>
<span id="cb143-32"><a href="#cb143-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-33"><a href="#cb143-33" aria-hidden="true" tabindex="-1"></a><span class="co">;; Break node for line breaking algorithm</span></span>
<span id="cb143-34"><a href="#cb143-34" aria-hidden="true" tabindex="-1"></a>(struct break-node</span>
<span id="cb143-35"><a href="#cb143-35" aria-hidden="true" tabindex="-1"></a>  (type        <span class="co">; &#39;box, &#39;glue, &#39;penalty</span></span>
<span id="cb143-36"><a href="#cb143-36" aria-hidden="true" tabindex="-1"></a>   content     <span class="co">; text content or nil</span></span>
<span id="cb143-37"><a href="#cb143-37" aria-hidden="true" tabindex="-1"></a>   width       <span class="co">; natural width</span></span>
<span id="cb143-38"><a href="#cb143-38" aria-hidden="true" tabindex="-1"></a>   stretch     <span class="co">; stretchability</span></span>
<span id="cb143-39"><a href="#cb143-39" aria-hidden="true" tabindex="-1"></a>   shrink      <span class="co">; shrinkability</span></span>
<span id="cb143-40"><a href="#cb143-40" aria-hidden="true" tabindex="-1"></a>   penalty     <span class="co">; break penalty</span></span>
<span id="cb143-41"><a href="#cb143-41" aria-hidden="true" tabindex="-1"></a>   flagged)    <span class="co">; flagged penalty?</span></span>
<span id="cb143-42"><a href="#cb143-42" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb143-43"><a href="#cb143-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-44"><a href="#cb143-44" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create nodes from words</span></span>
<span id="cb143-45"><a href="#cb143-45" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(create-break-nodes words ctx)</span>
<span id="cb143-46"><a href="#cb143-46" aria-hidden="true" tabindex="-1"></a>  (append-map</span>
<span id="cb143-47"><a href="#cb143-47" aria-hidden="true" tabindex="-1"></a>   (λ (word)</span>
<span id="cb143-48"><a href="#cb143-48" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">list</span></span>
<span id="cb143-49"><a href="#cb143-49" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Word box</span></span>
<span id="cb143-50"><a href="#cb143-50" aria-hidden="true" tabindex="-1"></a>      (break-node &#39;box word (measure-word word ctx) <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">#f</span>)</span>
<span id="cb143-51"><a href="#cb143-51" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Inter-word glue</span></span>
<span id="cb143-52"><a href="#cb143-52" aria-hidden="true" tabindex="-1"></a>      (break-node &#39;glue <span class="dv">#f</span> </span>
<span id="cb143-53"><a href="#cb143-53" aria-hidden="true" tabindex="-1"></a>                  (space-width ctx)</span>
<span id="cb143-54"><a href="#cb143-54" aria-hidden="true" tabindex="-1"></a>                  (space-stretch ctx)</span>
<span id="cb143-55"><a href="#cb143-55" aria-hidden="true" tabindex="-1"></a>                  (space-shrink ctx)</span>
<span id="cb143-56"><a href="#cb143-56" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">0</span> <span class="dv">#f</span>)))</span>
<span id="cb143-57"><a href="#cb143-57" aria-hidden="true" tabindex="-1"></a>   words))</span>
<span id="cb143-58"><a href="#cb143-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-59"><a href="#cb143-59" aria-hidden="true" tabindex="-1"></a><span class="co">;; Dynamic programming line breaker</span></span>
<span id="cb143-60"><a href="#cb143-60" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(find-optimal-breaks nodes target-width)</span>
<span id="cb143-61"><a href="#cb143-61" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> n </span>(<span class="kw">length</span> nodes))</span>
<span id="cb143-62"><a href="#cb143-62" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> costs </span>(<span class="kw">make-vector</span> n +inf.0))</span>
<span id="cb143-63"><a href="#cb143-63" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> breaks </span>(<span class="kw">make-vector</span> n -<span class="dv">1</span>))</span>
<span id="cb143-64"><a href="#cb143-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-65"><a href="#cb143-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Initialize</span></span>
<span id="cb143-66"><a href="#cb143-66" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">vector-set!</span> costs <span class="dv">0</span> <span class="dv">0</span>)</span>
<span id="cb143-67"><a href="#cb143-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-68"><a href="#cb143-68" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Fill DP table</span></span>
<span id="cb143-69"><a href="#cb143-69" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>j (in-range <span class="dv">1</span> n)<span class="op">]</span>)</span>
<span id="cb143-70"><a href="#cb143-70" aria-hidden="true" tabindex="-1"></a>    (for (<span class="op">[</span>i (in-range j)<span class="op">]</span>)</span>
<span id="cb143-71"><a href="#cb143-71" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> line-cost </span>(calculate-line-cost nodes i j target-width))</span>
<span id="cb143-72"><a href="#cb143-72" aria-hidden="true" tabindex="-1"></a>      (when (<span class="op">&lt;</span> line-cost +inf.0)</span>
<span id="cb143-73"><a href="#cb143-73" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> total-cost </span>(<span class="op">+</span> (<span class="kw">vector-ref</span> costs i) line-cost))</span>
<span id="cb143-74"><a href="#cb143-74" aria-hidden="true" tabindex="-1"></a>        (when (<span class="op">&lt;</span> total-cost (<span class="kw">vector-ref</span> costs j))</span>
<span id="cb143-75"><a href="#cb143-75" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">vector-set!</span> costs j total-cost)</span>
<span id="cb143-76"><a href="#cb143-76" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">vector-set!</span> breaks j i)))))</span>
<span id="cb143-77"><a href="#cb143-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-78"><a href="#cb143-78" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Reconstruct break points</span></span>
<span id="cb143-79"><a href="#cb143-79" aria-hidden="true" tabindex="-1"></a>  (reconstruct-breaks breaks n))</span>
<span id="cb143-80"><a href="#cb143-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-81"><a href="#cb143-81" aria-hidden="true" tabindex="-1"></a><span class="co">;; Page breaking with float placement</span></span>
<span id="cb143-82"><a href="#cb143-82" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(calculate-page-breaks measurements ctx)</span>
<span id="cb143-83"><a href="#cb143-83" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> pages </span>&#39;())</span>
<span id="cb143-84"><a href="#cb143-84" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> current-page </span>(make-page))</span>
<span id="cb143-85"><a href="#cb143-85" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> available-height </span>(pdf-context-page-height ctx))</span>
<span id="cb143-86"><a href="#cb143-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-87"><a href="#cb143-87" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>element measurements<span class="op">]</span>)</span>
<span id="cb143-88"><a href="#cb143-88" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb143-89"><a href="#cb143-89" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Element fits on current page</span></span>
<span id="cb143-90"><a href="#cb143-90" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="op">&lt;=</span> (<span class="op">+</span> (page-height current-page) </span>
<span id="cb143-91"><a href="#cb143-91" aria-hidden="true" tabindex="-1"></a>              (element-height element))</span>
<span id="cb143-92"><a href="#cb143-92" aria-hidden="true" tabindex="-1"></a>           available-height)</span>
<span id="cb143-93"><a href="#cb143-93" aria-hidden="true" tabindex="-1"></a>       (add-to-page! current-page element)<span class="op">]</span></span>
<span id="cb143-94"><a href="#cb143-94" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb143-95"><a href="#cb143-95" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Need new page</span></span>
<span id="cb143-96"><a href="#cb143-96" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb143-97"><a href="#cb143-97" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> pages (<span class="kw">cons</span> current-page pages))</span>
<span id="cb143-98"><a href="#cb143-98" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> current-page (make-page))</span>
<span id="cb143-99"><a href="#cb143-99" aria-hidden="true" tabindex="-1"></a>       (add-to-page! current-page element)<span class="op">]</span>))</span>
<span id="cb143-100"><a href="#cb143-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb143-101"><a href="#cb143-101" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Don&#39;t forget last page</span></span>
<span id="cb143-102"><a href="#cb143-102" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">reverse</span> (<span class="kw">cons</span> current-page pages)))</span></code></pre></div>
<h2 id="rendering-document-elements">Rendering Document Elements</h2>
<p>Each element type requires specialized PDF rendering:</p>
<div class="sourceCode" id="cb144"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; pdf-elements.rkt</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>(require racket/draw</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;text-layout.rkt&quot;</span>)</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Render document content</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-document-content ctx doc)</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>section (document-sections doc)<span class="op">]</span>)</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>    (render-section-pdf ctx section))</span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Handle pending floats</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>  (flush-pending-floats ctx))</span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a><span class="co">;; Section rendering</span></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-section-pdf ctx section)</span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check if we need a page break</span></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>  (when (section-starts-page? section ctx)</span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>    (new-page ctx))</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Render section heading</span></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a>  (render-heading ctx section)</span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Render section content</span></span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>element (node-children section)<span class="op">]</span>)</span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a>    (render-element-pdf ctx element)))</span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a><span class="co">;; Heading rendering with style</span></span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-heading ctx section)</span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> level </span>(section-level section))</span>
<span id="cb144-32"><a href="#cb144-32" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> font-size </span>(heading-font-size level))</span>
<span id="cb144-33"><a href="#cb144-33" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> font </span>(get-heading-font ctx level))</span>
<span id="cb144-34"><a href="#cb144-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-35"><a href="#cb144-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Save graphics state</span></span>
<span id="cb144-36"><a href="#cb144-36" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(pdf-context-dc ctx))</span>
<span id="cb144-37"><a href="#cb144-37" aria-hidden="true" tabindex="-1"></a>  (send dc set-font font)</span>
<span id="cb144-38"><a href="#cb144-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-39"><a href="#cb144-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add space before heading</span></span>
<span id="cb144-40"><a href="#cb144-40" aria-hidden="true" tabindex="-1"></a>  (advance-y ctx (<span class="op">*</span> <span class="dv">2</span> (pdf-context-line-height ctx)))</span>
<span id="cb144-41"><a href="#cb144-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-42"><a href="#cb144-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Render section number</span></span>
<span id="cb144-43"><a href="#cb144-43" aria-hidden="true" tabindex="-1"></a>  (when (section-number section)</span>
<span id="cb144-44"><a href="#cb144-44" aria-hidden="true" tabindex="-1"></a>    (draw-text dc </span>
<span id="cb144-45"><a href="#cb144-45" aria-hidden="true" tabindex="-1"></a>               (format <span class="st">&quot;~a  &quot;</span> (section-number section))</span>
<span id="cb144-46"><a href="#cb144-46" aria-hidden="true" tabindex="-1"></a>               (current-x ctx)</span>
<span id="cb144-47"><a href="#cb144-47" aria-hidden="true" tabindex="-1"></a>               (current-y ctx)))</span>
<span id="cb144-48"><a href="#cb144-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-49"><a href="#cb144-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Render heading text</span></span>
<span id="cb144-50"><a href="#cb144-50" aria-hidden="true" tabindex="-1"></a>  (draw-text dc</span>
<span id="cb144-51"><a href="#cb144-51" aria-hidden="true" tabindex="-1"></a>             (extract-text (section-title section))</span>
<span id="cb144-52"><a href="#cb144-52" aria-hidden="true" tabindex="-1"></a>             (<span class="op">+</span> (current-x ctx) </span>
<span id="cb144-53"><a href="#cb144-53" aria-hidden="true" tabindex="-1"></a>                (<span class="kw">if</span> (section-number section) <span class="dv">50</span> <span class="dv">0</span>))</span>
<span id="cb144-54"><a href="#cb144-54" aria-hidden="true" tabindex="-1"></a>             (current-y ctx))</span>
<span id="cb144-55"><a href="#cb144-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-56"><a href="#cb144-56" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add space after heading</span></span>
<span id="cb144-57"><a href="#cb144-57" aria-hidden="true" tabindex="-1"></a>  (advance-y ctx (<span class="op">*</span> <span class="fl">1.5</span> font-size))</span>
<span id="cb144-58"><a href="#cb144-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-59"><a href="#cb144-59" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Register for TOC</span></span>
<span id="cb144-60"><a href="#cb144-60" aria-hidden="true" tabindex="-1"></a>  (register-toc-entry ctx section))</span>
<span id="cb144-61"><a href="#cb144-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-62"><a href="#cb144-62" aria-hidden="true" tabindex="-1"></a><span class="co">;; Paragraph rendering with justification</span></span>
<span id="cb144-63"><a href="#cb144-63" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-paragraph-pdf ctx para)</span>
<span id="cb144-64"><a href="#cb144-64" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> layout </span>(layout-paragraph ctx para))</span>
<span id="cb144-65"><a href="#cb144-65" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(pdf-context-dc ctx))</span>
<span id="cb144-66"><a href="#cb144-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-67"><a href="#cb144-67" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check if paragraph fits on page</span></span>
<span id="cb144-68"><a href="#cb144-68" aria-hidden="true" tabindex="-1"></a>  (when (<span class="op">&gt;</span> (<span class="op">+</span> (current-y ctx) (paragraph-metrics-height layout))</span>
<span id="cb144-69"><a href="#cb144-69" aria-hidden="true" tabindex="-1"></a>           (pdf-context-page-height ctx))</span>
<span id="cb144-70"><a href="#cb144-70" aria-hidden="true" tabindex="-1"></a>    (new-page ctx))</span>
<span id="cb144-71"><a href="#cb144-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-72"><a href="#cb144-72" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Render each line</span></span>
<span id="cb144-73"><a href="#cb144-73" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>line (paragraph-metrics-lines layout)<span class="op">]</span>)</span>
<span id="cb144-74"><a href="#cb144-74" aria-hidden="true" tabindex="-1"></a>    (render-line ctx line))</span>
<span id="cb144-75"><a href="#cb144-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-76"><a href="#cb144-76" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add paragraph spacing</span></span>
<span id="cb144-77"><a href="#cb144-77" aria-hidden="true" tabindex="-1"></a>  (advance-y ctx (paragraph-spacing ctx)))</span>
<span id="cb144-78"><a href="#cb144-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-79"><a href="#cb144-79" aria-hidden="true" tabindex="-1"></a><span class="co">;; Justified line rendering</span></span>
<span id="cb144-80"><a href="#cb144-80" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-line ctx line)</span>
<span id="cb144-81"><a href="#cb144-81" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(pdf-context-dc ctx))</span>
<span id="cb144-82"><a href="#cb144-82" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> words </span>(line-words line))</span>
<span id="cb144-83"><a href="#cb144-83" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> spaces </span>(line-spaces line))</span>
<span id="cb144-84"><a href="#cb144-84" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> justify? </span>(line-justify? line))</span>
<span id="cb144-85"><a href="#cb144-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-86"><a href="#cb144-86" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> x </span>(current-x ctx))</span>
<span id="cb144-87"><a href="#cb144-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-88"><a href="#cb144-88" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>word words<span class="op">]</span></span>
<span id="cb144-89"><a href="#cb144-89" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>i (in-naturals)<span class="op">]</span>)</span>
<span id="cb144-90"><a href="#cb144-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Draw word</span></span>
<span id="cb144-91"><a href="#cb144-91" aria-hidden="true" tabindex="-1"></a>    (draw-text dc word x (current-y ctx))</span>
<span id="cb144-92"><a href="#cb144-92" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">set!</span> x (<span class="op">+</span> x (measure-text dc word)))</span>
<span id="cb144-93"><a href="#cb144-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-94"><a href="#cb144-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Add space</span></span>
<span id="cb144-95"><a href="#cb144-95" aria-hidden="true" tabindex="-1"></a>    (when (<span class="op">&lt;</span> i (sub1 (<span class="kw">length</span> words)))</span>
<span id="cb144-96"><a href="#cb144-96" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">set!</span> x (<span class="op">+</span> x (<span class="kw">if</span> justify?</span>
<span id="cb144-97"><a href="#cb144-97" aria-hidden="true" tabindex="-1"></a>                       (<span class="kw">list-ref</span> spaces i)</span>
<span id="cb144-98"><a href="#cb144-98" aria-hidden="true" tabindex="-1"></a>                       (space-width ctx))))))</span>
<span id="cb144-99"><a href="#cb144-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-100"><a href="#cb144-100" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Advance to next line</span></span>
<span id="cb144-101"><a href="#cb144-101" aria-hidden="true" tabindex="-1"></a>  (advance-y ctx (line-height ctx)))</span>
<span id="cb144-102"><a href="#cb144-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-103"><a href="#cb144-103" aria-hidden="true" tabindex="-1"></a><span class="co">;; Mathematical equation rendering</span></span>
<span id="cb144-104"><a href="#cb144-104" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-equation-pdf ctx eq)</span>
<span id="cb144-105"><a href="#cb144-105" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(pdf-context-dc ctx))</span>
<span id="cb144-106"><a href="#cb144-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-107"><a href="#cb144-107" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb144-108"><a href="#cb144-108" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(eq &#39;display (equation-display eq))</span>
<span id="cb144-109"><a href="#cb144-109" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Display equation - centered</span></span>
<span id="cb144-110"><a href="#cb144-110" aria-hidden="true" tabindex="-1"></a>     (advance-y ctx (equation-spacing-before ctx))</span>
<span id="cb144-111"><a href="#cb144-111" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb144-112"><a href="#cb144-112" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> eq-width </span>(measure-equation ctx eq))</span>
<span id="cb144-113"><a href="#cb144-113" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> x </span>(<span class="op">/</span> (<span class="op">-</span> (pdf-context-page-width ctx) eq-width) <span class="dv">2</span>))</span>
<span id="cb144-114"><a href="#cb144-114" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb144-115"><a href="#cb144-115" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Render equation</span></span>
<span id="cb144-116"><a href="#cb144-116" aria-hidden="true" tabindex="-1"></a>     (render-math-pdf dc (equation-content eq) x (current-y ctx))</span>
<span id="cb144-117"><a href="#cb144-117" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb144-118"><a href="#cb144-118" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Equation number if needed</span></span>
<span id="cb144-119"><a href="#cb144-119" aria-hidden="true" tabindex="-1"></a>     (when (equation-numbered eq)</span>
<span id="cb144-120"><a href="#cb144-120" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> num-text </span>(format <span class="st">&quot;(~a)&quot;</span> (equation-number eq)))</span>
<span id="cb144-121"><a href="#cb144-121" aria-hidden="true" tabindex="-1"></a>       (draw-text dc num-text</span>
<span id="cb144-122"><a href="#cb144-122" aria-hidden="true" tabindex="-1"></a>                  (<span class="op">-</span> (pdf-context-page-width ctx) </span>
<span id="cb144-123"><a href="#cb144-123" aria-hidden="true" tabindex="-1"></a>                     (margin-right (pdf-context-margin ctx))</span>
<span id="cb144-124"><a href="#cb144-124" aria-hidden="true" tabindex="-1"></a>                     (measure-text dc num-text))</span>
<span id="cb144-125"><a href="#cb144-125" aria-hidden="true" tabindex="-1"></a>                  (current-y ctx)))</span>
<span id="cb144-126"><a href="#cb144-126" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb144-127"><a href="#cb144-127" aria-hidden="true" tabindex="-1"></a>     (advance-y ctx (<span class="op">+</span> (equation-height eq)</span>
<span id="cb144-128"><a href="#cb144-128" aria-hidden="true" tabindex="-1"></a>                      (equation-spacing-after ctx)))<span class="op">]</span></span>
<span id="cb144-129"><a href="#cb144-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-130"><a href="#cb144-130" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb144-131"><a href="#cb144-131" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Inline equation</span></span>
<span id="cb144-132"><a href="#cb144-132" aria-hidden="true" tabindex="-1"></a>     (render-math-inline dc (equation-content eq) </span>
<span id="cb144-133"><a href="#cb144-133" aria-hidden="true" tabindex="-1"></a>                        (current-x ctx) (current-y ctx))<span class="op">]</span>))</span>
<span id="cb144-134"><a href="#cb144-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-135"><a href="#cb144-135" aria-hidden="true" tabindex="-1"></a><span class="co">;; Figure rendering with captions</span></span>
<span id="cb144-136"><a href="#cb144-136" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-figure-pdf ctx fig)</span>
<span id="cb144-137"><a href="#cb144-137" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check if figure fits on current page</span></span>
<span id="cb144-138"><a href="#cb144-138" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> fig-height </span>(calculate-figure-height ctx fig))</span>
<span id="cb144-139"><a href="#cb144-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-140"><a href="#cb144-140" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb144-141"><a href="#cb144-141" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(fits-on-page? ctx fig-height)</span>
<span id="cb144-142"><a href="#cb144-142" aria-hidden="true" tabindex="-1"></a>     (render-figure-immediate ctx fig)<span class="op">]</span></span>
<span id="cb144-143"><a href="#cb144-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-144"><a href="#cb144-144" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(floatable? fig ctx)</span>
<span id="cb144-145"><a href="#cb144-145" aria-hidden="true" tabindex="-1"></a>     (add-pending-float ctx fig)<span class="op">]</span></span>
<span id="cb144-146"><a href="#cb144-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-147"><a href="#cb144-147" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb144-148"><a href="#cb144-148" aria-hidden="true" tabindex="-1"></a>     (new-page ctx)</span>
<span id="cb144-149"><a href="#cb144-149" aria-hidden="true" tabindex="-1"></a>     (render-figure-immediate ctx fig)<span class="op">]</span>))</span>
<span id="cb144-150"><a href="#cb144-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-151"><a href="#cb144-151" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-figure-immediate ctx fig)</span>
<span id="cb144-152"><a href="#cb144-152" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(pdf-context-dc ctx))</span>
<span id="cb144-153"><a href="#cb144-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-154"><a href="#cb144-154" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Load and scale image</span></span>
<span id="cb144-155"><a href="#cb144-155" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> bitmap </span>(load-figure-bitmap (figure-source fig)))</span>
<span id="cb144-156"><a href="#cb144-156" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> scale </span>(calculate-figure-scale bitmap ctx fig))</span>
<span id="cb144-157"><a href="#cb144-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-158"><a href="#cb144-158" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Center figure</span></span>
<span id="cb144-159"><a href="#cb144-159" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> width </span>(<span class="op">*</span> scale (send bitmap get-width)))</span>
<span id="cb144-160"><a href="#cb144-160" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> x </span>(<span class="op">/</span> (<span class="op">-</span> (pdf-context-page-width ctx) width) <span class="dv">2</span>))</span>
<span id="cb144-161"><a href="#cb144-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-162"><a href="#cb144-162" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Draw image</span></span>
<span id="cb144-163"><a href="#cb144-163" aria-hidden="true" tabindex="-1"></a>  (send dc draw-bitmap bitmap x (current-y ctx)</span>
<span id="cb144-164"><a href="#cb144-164" aria-hidden="true" tabindex="-1"></a>        &#39;solid (make-color <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span>) <span class="co">; mask color</span></span>
<span id="cb144-165"><a href="#cb144-165" aria-hidden="true" tabindex="-1"></a>        <span class="dv">#f</span>) <span class="co">; mask</span></span>
<span id="cb144-166"><a href="#cb144-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-167"><a href="#cb144-167" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Render caption</span></span>
<span id="cb144-168"><a href="#cb144-168" aria-hidden="true" tabindex="-1"></a>  (when (figure-caption fig)</span>
<span id="cb144-169"><a href="#cb144-169" aria-hidden="true" tabindex="-1"></a>    (advance-y ctx (<span class="op">*</span> scale (send bitmap get-height)))</span>
<span id="cb144-170"><a href="#cb144-170" aria-hidden="true" tabindex="-1"></a>    (render-caption ctx (figure-caption fig) </span>
<span id="cb144-171"><a href="#cb144-171" aria-hidden="true" tabindex="-1"></a>                   (figure-number fig) <span class="st">&quot;Figure&quot;</span>)))</span></code></pre></div>
<h2 id="advanced-pdf-features">Advanced PDF Features</h2>
<p>Professional PDFs require features like hyperlinks, bookmarks, and
metadata:</p>
<div class="sourceCode" id="cb145"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; pdf-features.rkt</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>(require racket/draw)</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Table of contents generation</span></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-table-of-contents ctx doc)</span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>  (new-page ctx)</span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; TOC heading</span></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>  (render-toc-heading ctx <span class="st">&quot;Contents&quot;</span>)</span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Collect all sections with page numbers</span></span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> entries </span>(collect-toc-entries doc ctx))</span>
<span id="cb145-15"><a href="#cb145-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-16"><a href="#cb145-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Render TOC entries</span></span>
<span id="cb145-17"><a href="#cb145-17" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>entry entries<span class="op">]</span>)</span>
<span id="cb145-18"><a href="#cb145-18" aria-hidden="true" tabindex="-1"></a>    (render-toc-entry ctx entry)))</span>
<span id="cb145-19"><a href="#cb145-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-20"><a href="#cb145-20" aria-hidden="true" tabindex="-1"></a>(struct toc-entry</span>
<span id="cb145-21"><a href="#cb145-21" aria-hidden="true" tabindex="-1"></a>  (level title number page) </span>
<span id="cb145-22"><a href="#cb145-22" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb145-23"><a href="#cb145-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-24"><a href="#cb145-24" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-toc-entry ctx entry)</span>
<span id="cb145-25"><a href="#cb145-25" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(pdf-context-dc ctx))</span>
<span id="cb145-26"><a href="#cb145-26" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> indent </span>(<span class="op">*</span> (toc-entry-level entry) <span class="dv">20</span>))</span>
<span id="cb145-27"><a href="#cb145-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-28"><a href="#cb145-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Entry text</span></span>
<span id="cb145-29"><a href="#cb145-29" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> text</span></span>
<span id="cb145-30"><a href="#cb145-30" aria-hidden="true" tabindex="-1"></a>    (format <span class="st">&quot;~a~a&quot;</span></span>
<span id="cb145-31"><a href="#cb145-31" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">if</span> (toc-entry-number entry)</span>
<span id="cb145-32"><a href="#cb145-32" aria-hidden="true" tabindex="-1"></a>                (format <span class="st">&quot;~a  &quot;</span> (toc-entry-number entry))</span>
<span id="cb145-33"><a href="#cb145-33" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;&quot;</span>)</span>
<span id="cb145-34"><a href="#cb145-34" aria-hidden="true" tabindex="-1"></a>            (toc-entry-title entry)))</span>
<span id="cb145-35"><a href="#cb145-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-36"><a href="#cb145-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Draw entry with dots</span></span>
<span id="cb145-37"><a href="#cb145-37" aria-hidden="true" tabindex="-1"></a>  (draw-text dc text </span>
<span id="cb145-38"><a href="#cb145-38" aria-hidden="true" tabindex="-1"></a>             (<span class="op">+</span> (margin-left (pdf-context-margin ctx)) indent)</span>
<span id="cb145-39"><a href="#cb145-39" aria-hidden="true" tabindex="-1"></a>             (current-y ctx))</span>
<span id="cb145-40"><a href="#cb145-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-41"><a href="#cb145-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Draw page number</span></span>
<span id="cb145-42"><a href="#cb145-42" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> page-text </span>(<span class="kw">number-&gt;string</span> (toc-entry-page entry)))</span>
<span id="cb145-43"><a href="#cb145-43" aria-hidden="true" tabindex="-1"></a>  (draw-text dc page-text</span>
<span id="cb145-44"><a href="#cb145-44" aria-hidden="true" tabindex="-1"></a>             (<span class="op">-</span> (pdf-context-page-width ctx)</span>
<span id="cb145-45"><a href="#cb145-45" aria-hidden="true" tabindex="-1"></a>                (margin-right (pdf-context-margin ctx))</span>
<span id="cb145-46"><a href="#cb145-46" aria-hidden="true" tabindex="-1"></a>                (measure-text dc page-text))</span>
<span id="cb145-47"><a href="#cb145-47" aria-hidden="true" tabindex="-1"></a>             (current-y ctx))</span>
<span id="cb145-48"><a href="#cb145-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-49"><a href="#cb145-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Draw dots between title and page</span></span>
<span id="cb145-50"><a href="#cb145-50" aria-hidden="true" tabindex="-1"></a>  (draw-leader-dots ctx </span>
<span id="cb145-51"><a href="#cb145-51" aria-hidden="true" tabindex="-1"></a>                   (<span class="op">+</span> (margin-left (pdf-context-margin ctx)) </span>
<span id="cb145-52"><a href="#cb145-52" aria-hidden="true" tabindex="-1"></a>                      indent</span>
<span id="cb145-53"><a href="#cb145-53" aria-hidden="true" tabindex="-1"></a>                      (measure-text dc text))</span>
<span id="cb145-54"><a href="#cb145-54" aria-hidden="true" tabindex="-1"></a>                   (<span class="op">-</span> (pdf-context-page-width ctx)</span>
<span id="cb145-55"><a href="#cb145-55" aria-hidden="true" tabindex="-1"></a>                      (margin-right (pdf-context-margin ctx))</span>
<span id="cb145-56"><a href="#cb145-56" aria-hidden="true" tabindex="-1"></a>                      (measure-text dc page-text)</span>
<span id="cb145-57"><a href="#cb145-57" aria-hidden="true" tabindex="-1"></a>                      <span class="dv">10</span>))</span>
<span id="cb145-58"><a href="#cb145-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-59"><a href="#cb145-59" aria-hidden="true" tabindex="-1"></a>  (advance-y ctx (line-height ctx)))</span>
<span id="cb145-60"><a href="#cb145-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-61"><a href="#cb145-61" aria-hidden="true" tabindex="-1"></a><span class="co">;; PDF metadata</span></span>
<span id="cb145-62"><a href="#cb145-62" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(set-pdf-metadata ctx doc)</span>
<span id="cb145-63"><a href="#cb145-63" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(pdf-context-dc ctx))</span>
<span id="cb145-64"><a href="#cb145-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-65"><a href="#cb145-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Set document properties</span></span>
<span id="cb145-66"><a href="#cb145-66" aria-hidden="true" tabindex="-1"></a>  (send dc set-pdf-info &#39;Title (document-title doc))</span>
<span id="cb145-67"><a href="#cb145-67" aria-hidden="true" tabindex="-1"></a>  (send dc set-pdf-info &#39;Author </span>
<span id="cb145-68"><a href="#cb145-68" aria-hidden="true" tabindex="-1"></a>        (string-join (map author-name (document-authors doc)) <span class="st">&quot;, &quot;</span>))</span>
<span id="cb145-69"><a href="#cb145-69" aria-hidden="true" tabindex="-1"></a>  (send dc set-pdf-info &#39;Subject (<span class="kw">or</span> (document-subject doc) <span class="st">&quot;&quot;</span>))</span>
<span id="cb145-70"><a href="#cb145-70" aria-hidden="true" tabindex="-1"></a>  (send dc set-pdf-info &#39;Keywords </span>
<span id="cb145-71"><a href="#cb145-71" aria-hidden="true" tabindex="-1"></a>        (string-join (<span class="kw">or</span> (document-keywords doc) &#39;()) <span class="st">&quot;, &quot;</span>))</span>
<span id="cb145-72"><a href="#cb145-72" aria-hidden="true" tabindex="-1"></a>  (send dc set-pdf-info &#39;Creator <span class="st">&quot;Shrdlu Static Site Generator&quot;</span>)</span>
<span id="cb145-73"><a href="#cb145-73" aria-hidden="true" tabindex="-1"></a>  (send dc set-pdf-info &#39;Producer <span class="st">&quot;Racket PDF Generation&quot;</span>))</span>
<span id="cb145-74"><a href="#cb145-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-75"><a href="#cb145-75" aria-hidden="true" tabindex="-1"></a><span class="co">;; Hyperlink support</span></span>
<span id="cb145-76"><a href="#cb145-76" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-hyperlink-pdf ctx link)</span>
<span id="cb145-77"><a href="#cb145-77" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dc </span>(pdf-context-dc ctx))</span>
<span id="cb145-78"><a href="#cb145-78" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> text </span>(extract-text link))</span>
<span id="cb145-79"><a href="#cb145-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-80"><a href="#cb145-80" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Measure link text</span></span>
<span id="cb145-81"><a href="#cb145-81" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> width </span>(measure-text dc text))</span>
<span id="cb145-82"><a href="#cb145-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-83"><a href="#cb145-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create link annotation</span></span>
<span id="cb145-84"><a href="#cb145-84" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> link-rect</span></span>
<span id="cb145-85"><a href="#cb145-85" aria-hidden="true" tabindex="-1"></a>    (make-rect (current-x ctx)</span>
<span id="cb145-86"><a href="#cb145-86" aria-hidden="true" tabindex="-1"></a>               (<span class="op">-</span> (current-y ctx) (font-ascent ctx))</span>
<span id="cb145-87"><a href="#cb145-87" aria-hidden="true" tabindex="-1"></a>               width</span>
<span id="cb145-88"><a href="#cb145-88" aria-hidden="true" tabindex="-1"></a>               (font-height ctx)))</span>
<span id="cb145-89"><a href="#cb145-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-90"><a href="#cb145-90" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add link to PDF</span></span>
<span id="cb145-91"><a href="#cb145-91" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb145-92"><a href="#cb145-92" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(internal-link? link)</span>
<span id="cb145-93"><a href="#cb145-93" aria-hidden="true" tabindex="-1"></a>     (add-internal-link dc link-rect (hyperlink-target link))<span class="op">]</span></span>
<span id="cb145-94"><a href="#cb145-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb145-95"><a href="#cb145-95" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb145-96"><a href="#cb145-96" aria-hidden="true" tabindex="-1"></a>     (add-external-link dc link-rect (hyperlink-href link))<span class="op">]</span>)</span>
<span id="cb145-97"><a href="#cb145-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-98"><a href="#cb145-98" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Draw link text in blue</span></span>
<span id="cb145-99"><a href="#cb145-99" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> old-color </span>(send dc get-text-foreground))</span>
<span id="cb145-100"><a href="#cb145-100" aria-hidden="true" tabindex="-1"></a>  (send dc set-text-foreground (make-color <span class="dv">0</span> <span class="dv">0</span> <span class="dv">255</span>))</span>
<span id="cb145-101"><a href="#cb145-101" aria-hidden="true" tabindex="-1"></a>  (draw-text dc text (current-x ctx) (current-y ctx))</span>
<span id="cb145-102"><a href="#cb145-102" aria-hidden="true" tabindex="-1"></a>  (send dc set-text-foreground old-color)</span>
<span id="cb145-103"><a href="#cb145-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-104"><a href="#cb145-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Advance position</span></span>
<span id="cb145-105"><a href="#cb145-105" aria-hidden="true" tabindex="-1"></a>  (advance-x ctx width))</span>
<span id="cb145-106"><a href="#cb145-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-107"><a href="#cb145-107" aria-hidden="true" tabindex="-1"></a><span class="co">;; Bookmark generation</span></span>
<span id="cb145-108"><a href="#cb145-108" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-bookmarks ctx doc)</span>
<span id="cb145-109"><a href="#cb145-109" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> bookmarks </span>&#39;())</span>
<span id="cb145-110"><a href="#cb145-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-111"><a href="#cb145-111" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(process-section section level parent)</span>
<span id="cb145-112"><a href="#cb145-112" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> bookmark</span></span>
<span id="cb145-113"><a href="#cb145-113" aria-hidden="true" tabindex="-1"></a>      (pdf-bookmark</span>
<span id="cb145-114"><a href="#cb145-114" aria-hidden="true" tabindex="-1"></a>       (format <span class="st">&quot;~a ~a&quot;</span></span>
<span id="cb145-115"><a href="#cb145-115" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">or</span> (section-number section) <span class="st">&quot;&quot;</span>)</span>
<span id="cb145-116"><a href="#cb145-116" aria-hidden="true" tabindex="-1"></a>               (extract-text (section-title section)))</span>
<span id="cb145-117"><a href="#cb145-117" aria-hidden="true" tabindex="-1"></a>       (section-page section ctx)</span>
<span id="cb145-118"><a href="#cb145-118" aria-hidden="true" tabindex="-1"></a>       level</span>
<span id="cb145-119"><a href="#cb145-119" aria-hidden="true" tabindex="-1"></a>       parent))</span>
<span id="cb145-120"><a href="#cb145-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb145-121"><a href="#cb145-121" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">set!</span> bookmarks (<span class="kw">cons</span> bookmark bookmarks))</span>
<span id="cb145-122"><a href="#cb145-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb145-123"><a href="#cb145-123" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Process subsections</span></span>
<span id="cb145-124"><a href="#cb145-124" aria-hidden="true" tabindex="-1"></a>    (for (<span class="op">[</span>child (node-children section)<span class="op">]</span></span>
<span id="cb145-125"><a href="#cb145-125" aria-hidden="true" tabindex="-1"></a>          #:when (section? child))</span>
<span id="cb145-126"><a href="#cb145-126" aria-hidden="true" tabindex="-1"></a>      (process-section child (add1 level) bookmark)))</span>
<span id="cb145-127"><a href="#cb145-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-128"><a href="#cb145-128" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Process all top-level sections</span></span>
<span id="cb145-129"><a href="#cb145-129" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>section (document-sections doc)<span class="op">]</span>)</span>
<span id="cb145-130"><a href="#cb145-130" aria-hidden="true" tabindex="-1"></a>    (process-section section <span class="dv">0</span> <span class="dv">#f</span>))</span>
<span id="cb145-131"><a href="#cb145-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-132"><a href="#cb145-132" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">reverse</span> bookmarks))</span>
<span id="cb145-133"><a href="#cb145-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-134"><a href="#cb145-134" aria-hidden="true" tabindex="-1"></a><span class="co">;; Font embedding and subsetting</span></span>
<span id="cb145-135"><a href="#cb145-135" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(setup-fonts ctx)</span>
<span id="cb145-136"><a href="#cb145-136" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> font-paths</span></span>
<span id="cb145-137"><a href="#cb145-137" aria-hidden="true" tabindex="-1"></a>    (hash &#39;serif     <span class="st">&quot;/usr/share/fonts/liberation/LiberationSerif-Regular.ttf&quot;</span></span>
<span id="cb145-138"><a href="#cb145-138" aria-hidden="true" tabindex="-1"></a>          &#39;serif-bold <span class="st">&quot;/usr/share/fonts/liberation/LiberationSerif-Bold.ttf&quot;</span></span>
<span id="cb145-139"><a href="#cb145-139" aria-hidden="true" tabindex="-1"></a>          &#39;serif-italic <span class="st">&quot;/usr/share/fonts/liberation/LiberationSerif-Italic.ttf&quot;</span></span>
<span id="cb145-140"><a href="#cb145-140" aria-hidden="true" tabindex="-1"></a>          &#39;sans      <span class="st">&quot;/usr/share/fonts/liberation/LiberationSans-Regular.ttf&quot;</span></span>
<span id="cb145-141"><a href="#cb145-141" aria-hidden="true" tabindex="-1"></a>          &#39;mono      <span class="st">&quot;/usr/share/fonts/liberation/LiberationMono-Regular.ttf&quot;</span>))</span>
<span id="cb145-142"><a href="#cb145-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-143"><a href="#cb145-143" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Load and register fonts</span></span>
<span id="cb145-144"><a href="#cb145-144" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>(name path) font-paths<span class="op">]</span>)</span>
<span id="cb145-145"><a href="#cb145-145" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> font </span>(load-font path))</span>
<span id="cb145-146"><a href="#cb145-146" aria-hidden="true" tabindex="-1"></a>    (register-font ctx name font)))</span>
<span id="cb145-147"><a href="#cb145-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-148"><a href="#cb145-148" aria-hidden="true" tabindex="-1"></a><span class="co">;; Multi-column layout</span></span>
<span id="cb145-149"><a href="#cb145-149" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(setup-columns ctx num-columns)</span>
<span id="cb145-150"><a href="#cb145-150" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> total-width </span></span>
<span id="cb145-151"><a href="#cb145-151" aria-hidden="true" tabindex="-1"></a>    (<span class="op">-</span> (pdf-context-page-width ctx)</span>
<span id="cb145-152"><a href="#cb145-152" aria-hidden="true" tabindex="-1"></a>       (margin-left (pdf-context-margin ctx))</span>
<span id="cb145-153"><a href="#cb145-153" aria-hidden="true" tabindex="-1"></a>       (margin-right (pdf-context-margin ctx))))</span>
<span id="cb145-154"><a href="#cb145-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-155"><a href="#cb145-155" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> gutter </span><span class="dv">20</span>) <span class="co">; space between columns</span></span>
<span id="cb145-156"><a href="#cb145-156" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> column-width </span></span>
<span id="cb145-157"><a href="#cb145-157" aria-hidden="true" tabindex="-1"></a>    (<span class="op">/</span> (<span class="op">-</span> total-width (<span class="op">*</span> gutter (sub1 num-columns)))</span>
<span id="cb145-158"><a href="#cb145-158" aria-hidden="true" tabindex="-1"></a>       num-columns))</span>
<span id="cb145-159"><a href="#cb145-159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-160"><a href="#cb145-160" aria-hidden="true" tabindex="-1"></a>  (set-pdf-context-columns! </span>
<span id="cb145-161"><a href="#cb145-161" aria-hidden="true" tabindex="-1"></a>   ctx</span>
<span id="cb145-162"><a href="#cb145-162" aria-hidden="true" tabindex="-1"></a>   (for/list (<span class="op">[</span>i num-columns<span class="op">]</span>)</span>
<span id="cb145-163"><a href="#cb145-163" aria-hidden="true" tabindex="-1"></a>     (column (<span class="op">+</span> (margin-left (pdf-context-margin ctx))</span>
<span id="cb145-164"><a href="#cb145-164" aria-hidden="true" tabindex="-1"></a>               (<span class="op">*</span> i (<span class="op">+</span> column-width gutter)))</span>
<span id="cb145-165"><a href="#cb145-165" aria-hidden="true" tabindex="-1"></a>            column-width))))</span></code></pre></div>
<h2 id="integration-and-export">Integration and Export</h2>
<p>The complete PDF generation pipeline:</p>
<div class="sourceCode" id="cb146"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; pdf-export.rkt  </span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;pdf-renderer.rkt&quot;</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;document-model.rkt&quot;</span>)</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>(provide export-to-pdf)</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main export function</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(export-to-pdf doc output-path #:options <span class="op">[</span>options <span class="dv">#f</span><span class="op">]</span>)</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> pdf-options </span>(<span class="kw">or</span> options (default-pdf-options)))</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate PDF</span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> temp-file </span>(render-pdf doc #:options pdf-options))</span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Post-process if needed</span></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>  (when (pdf-options-optimize pdf-options)</span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>    (optimize-pdf temp-file))</span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Move to final location</span></span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>  (rename-file-or-directory temp-file output-path <span class="dv">#t</span>)</span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a>  output-path)</span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a><span class="co">;; PDF optimization</span></span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(optimize-pdf pdf-file)</span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Compress streams</span></span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a>  (compress-pdf-streams pdf-file)</span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Remove redundant objects</span></span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a>  (clean-pdf-objects pdf-file)</span>
<span id="cb146-32"><a href="#cb146-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-33"><a href="#cb146-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Optimize images</span></span>
<span id="cb146-34"><a href="#cb146-34" aria-hidden="true" tabindex="-1"></a>  (optimize-pdf-images pdf-file))</span></code></pre></div>
<p>The PDF generation pipeline demonstrates how Racket’s drawing
capabilities can be leveraged to create professional-quality documents.
By implementing sophisticated typesetting algorithms and maintaining
precise control over layout, we achieve output quality that rivals
dedicated typesetting systems.</p>
<h2 id="exercises-3">Exercises</h2>
<ol type="1">
<li><p><strong>Implement widow/orphan control</strong>: Extend the page
breaking algorithm to prevent single lines at the top or bottom of
pages.</p></li>
<li><p><strong>Add margin notes</strong>: Implement a system for placing
notes in the page margins, with proper alignment and overflow
handling.</p></li>
<li><p><strong>Create a two-pass justification system</strong>:
Implement paragraph-at-once justification that considers all lines
together for optimal spacing.</p></li>
<li><p><strong>Build a mathematical typesetting engine</strong>: Create
a subsystem that can properly typeset complex mathematical formulas with
correct spacing and alignment. # Chapter 9: EPUB Generation</p></li>
</ol>
<h2 id="the-electronic-publishing-challenge">The Electronic Publishing
Challenge</h2>
<p>EPUB has emerged as the dominant standard for electronic books,
providing a reflowable, accessible format that adapts to different
screen sizes and reading preferences. Unlike PDF’s fixed layout, EPUB
requires us to think differently about document structure, packaging
multiple files into a carefully organized container that e-readers can
interpret correctly.</p>
<p>Our static site generator must produce EPUB files that are not only
technically compliant with the EPUB 3.2 specification but also provide
an excellent reading experience across diverse devices, from e-ink
readers to tablets and smartphones.</p>
<h2 id="epub-structure-and-architecture">EPUB Structure and
Architecture</h2>
<p>An EPUB file is essentially a ZIP archive with a specific internal
structure:</p>
<div class="sourceCode" id="cb147"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; epub-generator.rkt</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>(require racket/zip</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>         racket/file</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>         xml</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;cross-references.rkt&quot;</span>)</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>(provide generate-epub</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>         epub-options)</span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a><span class="co">;; EPUB generation options</span></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>(struct epub-options</span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>  (version          <span class="co">; &#39;2.0 or &#39;3.0</span></span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>   cover-image      <span class="co">; path to cover image</span></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>   stylesheet       <span class="co">; custom CSS path</span></span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>   embed-fonts      <span class="co">; list of font files to embed</span></span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>   split-level      <span class="co">; where to split chapters (1-6)</span></span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>   toc-depth        <span class="co">; TOC nesting depth</span></span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>   metadata         <span class="co">; additional metadata</span></span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a>   accessibility)   <span class="co">; accessibility features</span></span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a><span class="co">;; EPUB generation context</span></span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a>(struct epub-context</span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a>  (temp-dir        <span class="co">; temporary working directory</span></span>
<span id="cb147-28"><a href="#cb147-28" aria-hidden="true" tabindex="-1"></a>   content-dir     <span class="co">; OEBPS content directory</span></span>
<span id="cb147-29"><a href="#cb147-29" aria-hidden="true" tabindex="-1"></a>   manifest        <span class="co">; manifest entries</span></span>
<span id="cb147-30"><a href="#cb147-30" aria-hidden="true" tabindex="-1"></a>   spine           <span class="co">; spine entries</span></span>
<span id="cb147-31"><a href="#cb147-31" aria-hidden="true" tabindex="-1"></a>   nav-points      <span class="co">; navigation points</span></span>
<span id="cb147-32"><a href="#cb147-32" aria-hidden="true" tabindex="-1"></a>   current-id      <span class="co">; ID counter</span></span>
<span id="cb147-33"><a href="#cb147-33" aria-hidden="true" tabindex="-1"></a>   options)        <span class="co">; generation options</span></span>
<span id="cb147-34"><a href="#cb147-34" aria-hidden="true" tabindex="-1"></a>  #:mutable)</span>
<span id="cb147-35"><a href="#cb147-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-36"><a href="#cb147-36" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main EPUB generation function</span></span>
<span id="cb147-37"><a href="#cb147-37" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-epub doc output-path #:options <span class="op">[</span>options (default-epub-options)<span class="op">]</span>)</span>
<span id="cb147-38"><a href="#cb147-38" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> resolved-doc </span>(resolve-references doc))</span>
<span id="cb147-39"><a href="#cb147-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-40"><a href="#cb147-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create temporary directory structure</span></span>
<span id="cb147-41"><a href="#cb147-41" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> temp-dir </span>(make-temporary-directory <span class="st">&quot;shrdlu-epub-&quot;</span>))</span>
<span id="cb147-42"><a href="#cb147-42" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ctx </span>(initialize-epub-context temp-dir options))</span>
<span id="cb147-43"><a href="#cb147-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-44"><a href="#cb147-44" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">dynamic-wind</span></span>
<span id="cb147-45"><a href="#cb147-45" aria-hidden="true" tabindex="-1"></a>    (λ () <span class="dv">#f</span>)</span>
<span id="cb147-46"><a href="#cb147-46" aria-hidden="true" tabindex="-1"></a>    (λ ()</span>
<span id="cb147-47"><a href="#cb147-47" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Generate EPUB structure</span></span>
<span id="cb147-48"><a href="#cb147-48" aria-hidden="true" tabindex="-1"></a>      (create-epub-skeleton ctx)</span>
<span id="cb147-49"><a href="#cb147-49" aria-hidden="true" tabindex="-1"></a>      (generate-content-documents ctx resolved-doc)</span>
<span id="cb147-50"><a href="#cb147-50" aria-hidden="true" tabindex="-1"></a>      (generate-navigation ctx resolved-doc)</span>
<span id="cb147-51"><a href="#cb147-51" aria-hidden="true" tabindex="-1"></a>      (generate-metadata-files ctx resolved-doc)</span>
<span id="cb147-52"><a href="#cb147-52" aria-hidden="true" tabindex="-1"></a>      (copy-resources ctx resolved-doc)</span>
<span id="cb147-53"><a href="#cb147-53" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb147-54"><a href="#cb147-54" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Package into EPUB file</span></span>
<span id="cb147-55"><a href="#cb147-55" aria-hidden="true" tabindex="-1"></a>      (package-epub temp-dir output-path))</span>
<span id="cb147-56"><a href="#cb147-56" aria-hidden="true" tabindex="-1"></a>    (λ ()</span>
<span id="cb147-57"><a href="#cb147-57" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Cleanup</span></span>
<span id="cb147-58"><a href="#cb147-58" aria-hidden="true" tabindex="-1"></a>      (delete-directory/files temp-dir))))</span>
<span id="cb147-59"><a href="#cb147-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-60"><a href="#cb147-60" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create EPUB directory structure</span></span>
<span id="cb147-61"><a href="#cb147-61" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(create-epub-skeleton ctx)</span>
<span id="cb147-62"><a href="#cb147-62" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> base-dir </span>(epub-context-temp-dir ctx))</span>
<span id="cb147-63"><a href="#cb147-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-64"><a href="#cb147-64" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create required directories</span></span>
<span id="cb147-65"><a href="#cb147-65" aria-hidden="true" tabindex="-1"></a>  (make-directory (build-path base-dir <span class="st">&quot;META-INF&quot;</span>))</span>
<span id="cb147-66"><a href="#cb147-66" aria-hidden="true" tabindex="-1"></a>  (make-directory (build-path base-dir <span class="st">&quot;OEBPS&quot;</span>))</span>
<span id="cb147-67"><a href="#cb147-67" aria-hidden="true" tabindex="-1"></a>  (make-directory (build-path base-dir <span class="st">&quot;OEBPS&quot;</span> <span class="st">&quot;css&quot;</span>))</span>
<span id="cb147-68"><a href="#cb147-68" aria-hidden="true" tabindex="-1"></a>  (make-directory (build-path base-dir <span class="st">&quot;OEBPS&quot;</span> <span class="st">&quot;images&quot;</span>))</span>
<span id="cb147-69"><a href="#cb147-69" aria-hidden="true" tabindex="-1"></a>  (make-directory (build-path base-dir <span class="st">&quot;OEBPS&quot;</span> <span class="st">&quot;fonts&quot;</span>))</span>
<span id="cb147-70"><a href="#cb147-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb147-71"><a href="#cb147-71" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Write mimetype file (must be first file, uncompressed)</span></span>
<span id="cb147-72"><a href="#cb147-72" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-with-output-file</span> (build-path base-dir <span class="st">&quot;mimetype&quot;</span>)</span>
<span id="cb147-73"><a href="#cb147-73" aria-hidden="true" tabindex="-1"></a>    (λ (out)</span>
<span id="cb147-74"><a href="#cb147-74" aria-hidden="true" tabindex="-1"></a>      (write-string <span class="st">&quot;application/epub+zip&quot;</span> out))</span>
<span id="cb147-75"><a href="#cb147-75" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;replace))</span>
<span id="cb147-76"><a href="#cb147-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-77"><a href="#cb147-77" aria-hidden="true" tabindex="-1"></a><span class="co">;; Initialize EPUB context</span></span>
<span id="cb147-78"><a href="#cb147-78" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(initialize-epub-context temp-dir options)</span>
<span id="cb147-79"><a href="#cb147-79" aria-hidden="true" tabindex="-1"></a>  (epub-context temp-dir </span>
<span id="cb147-80"><a href="#cb147-80" aria-hidden="true" tabindex="-1"></a>                (build-path temp-dir <span class="st">&quot;OEBPS&quot;</span>)</span>
<span id="cb147-81"><a href="#cb147-81" aria-hidden="true" tabindex="-1"></a>                &#39;()  <span class="co">; manifest</span></span>
<span id="cb147-82"><a href="#cb147-82" aria-hidden="true" tabindex="-1"></a>                &#39;()  <span class="co">; spine</span></span>
<span id="cb147-83"><a href="#cb147-83" aria-hidden="true" tabindex="-1"></a>                &#39;()  <span class="co">; nav</span></span>
<span id="cb147-84"><a href="#cb147-84" aria-hidden="true" tabindex="-1"></a>                <span class="dv">0</span>    <span class="co">; ID counter</span></span>
<span id="cb147-85"><a href="#cb147-85" aria-hidden="true" tabindex="-1"></a>                options))</span></code></pre></div>
<h2 id="content-generation-and-splitting">Content Generation and
Splitting</h2>
<p>EPUB readers perform better with smaller HTML files, so we split
content intelligently:</p>
<div class="sourceCode" id="cb148"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; epub-content.rkt</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>(require xml</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;html-renderer.rkt&quot;</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;document-model.rkt&quot;</span>)</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate content documents</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-content-documents ctx doc)</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> split-level </span>(epub-options-split-level (epub-context-options ctx)))</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Split document into chunks</span></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> chunks </span>(split-document doc split-level))</span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate HTML for each chunk</span></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>chunk chunks<span class="op">]</span></span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>index (in-naturals)<span class="op">]</span>)</span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> filename </span>(format <span class="st">&quot;chapter~a.xhtml&quot;</span> index))</span>
<span id="cb148-19"><a href="#cb148-19" aria-hidden="true" tabindex="-1"></a>    (generate-content-file ctx chunk filename index))</span>
<span id="cb148-20"><a href="#cb148-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-21"><a href="#cb148-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate cover page if specified</span></span>
<span id="cb148-22"><a href="#cb148-22" aria-hidden="true" tabindex="-1"></a>  (when (epub-options-cover-image (epub-context-options ctx))</span>
<span id="cb148-23"><a href="#cb148-23" aria-hidden="true" tabindex="-1"></a>    (generate-cover-page ctx)))</span>
<span id="cb148-24"><a href="#cb148-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-25"><a href="#cb148-25" aria-hidden="true" tabindex="-1"></a><span class="co">;; Split document at specified heading level</span></span>
<span id="cb148-26"><a href="#cb148-26" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(split-document doc level)</span>
<span id="cb148-27"><a href="#cb148-27" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> chunks </span>&#39;())</span>
<span id="cb148-28"><a href="#cb148-28" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> current-chunk </span>&#39;())</span>
<span id="cb148-29"><a href="#cb148-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-30"><a href="#cb148-30" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(process-node node)</span>
<span id="cb148-31"><a href="#cb148-31" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb148-32"><a href="#cb148-32" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">and</span> (section? node)</span>
<span id="cb148-33"><a href="#cb148-33" aria-hidden="true" tabindex="-1"></a>            (<span class="op">&lt;=</span> (section-level node) level)</span>
<span id="cb148-34"><a href="#cb148-34" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">not</span> (<span class="kw">null?</span> current-chunk)))</span>
<span id="cb148-35"><a href="#cb148-35" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Start new chunk</span></span>
<span id="cb148-36"><a href="#cb148-36" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> chunks (<span class="kw">cons</span> (<span class="kw">reverse</span> current-chunk) chunks))</span>
<span id="cb148-37"><a href="#cb148-37" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> current-chunk (<span class="kw">list</span> node))<span class="op">]</span></span>
<span id="cb148-38"><a href="#cb148-38" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb148-39"><a href="#cb148-39" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb148-40"><a href="#cb148-40" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Add to current chunk</span></span>
<span id="cb148-41"><a href="#cb148-41" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> current-chunk (<span class="kw">cons</span> node current-chunk))<span class="op">]</span>))</span>
<span id="cb148-42"><a href="#cb148-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-43"><a href="#cb148-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Process all content</span></span>
<span id="cb148-44"><a href="#cb148-44" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>section (document-sections doc)<span class="op">]</span>)</span>
<span id="cb148-45"><a href="#cb148-45" aria-hidden="true" tabindex="-1"></a>    (process-node section))</span>
<span id="cb148-46"><a href="#cb148-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-47"><a href="#cb148-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Don&#39;t forget last chunk</span></span>
<span id="cb148-48"><a href="#cb148-48" aria-hidden="true" tabindex="-1"></a>  (when (<span class="kw">not</span> (<span class="kw">null?</span> current-chunk))</span>
<span id="cb148-49"><a href="#cb148-49" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">set!</span> chunks (<span class="kw">cons</span> (<span class="kw">reverse</span> current-chunk) chunks)))</span>
<span id="cb148-50"><a href="#cb148-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-51"><a href="#cb148-51" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">reverse</span> chunks))</span>
<span id="cb148-52"><a href="#cb148-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-53"><a href="#cb148-53" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate XHTML content file</span></span>
<span id="cb148-54"><a href="#cb148-54" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-content-file ctx chunk filename index)</span>
<span id="cb148-55"><a href="#cb148-55" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> content-path </span>(build-path (epub-context-content-dir ctx) filename))</span>
<span id="cb148-56"><a href="#cb148-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-57"><a href="#cb148-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate XHTML</span></span>
<span id="cb148-58"><a href="#cb148-58" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> xhtml-doc</span></span>
<span id="cb148-59"><a href="#cb148-59" aria-hidden="true" tabindex="-1"></a>    `(html ((xmlns <span class="st">&quot;http://www.w3.org/1999/xhtml&quot;</span>)</span>
<span id="cb148-60"><a href="#cb148-60" aria-hidden="true" tabindex="-1"></a>            (xml:lang <span class="st">&quot;en&quot;</span>))</span>
<span id="cb148-61"><a href="#cb148-61" aria-hidden="true" tabindex="-1"></a>       (head</span>
<span id="cb148-62"><a href="#cb148-62" aria-hidden="true" tabindex="-1"></a>        (meta ((charset <span class="st">&quot;utf-8&quot;</span>)))</span>
<span id="cb148-63"><a href="#cb148-63" aria-hidden="true" tabindex="-1"></a>        (title ,(extract-chapter-title chunk))</span>
<span id="cb148-64"><a href="#cb148-64" aria-hidden="true" tabindex="-1"></a>        (link ((rel <span class="st">&quot;stylesheet&quot;</span>)</span>
<span id="cb148-65"><a href="#cb148-65" aria-hidden="true" tabindex="-1"></a>               (type <span class="st">&quot;text/css&quot;</span>)</span>
<span id="cb148-66"><a href="#cb148-66" aria-hidden="true" tabindex="-1"></a>               (href <span class="st">&quot;css/style.css&quot;</span>))))</span>
<span id="cb148-67"><a href="#cb148-67" aria-hidden="true" tabindex="-1"></a>       (body</span>
<span id="cb148-68"><a href="#cb148-68" aria-hidden="true" tabindex="-1"></a>        ,@(map (λ (node) (render-node-epub ctx node)) chunk))))</span>
<span id="cb148-69"><a href="#cb148-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-70"><a href="#cb148-70" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Write XHTML file</span></span>
<span id="cb148-71"><a href="#cb148-71" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-with-output-file</span> content-path</span>
<span id="cb148-72"><a href="#cb148-72" aria-hidden="true" tabindex="-1"></a>    (λ (out)</span>
<span id="cb148-73"><a href="#cb148-73" aria-hidden="true" tabindex="-1"></a>      (write-xhtml xhtml-doc out))</span>
<span id="cb148-74"><a href="#cb148-74" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;replace)</span>
<span id="cb148-75"><a href="#cb148-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-76"><a href="#cb148-76" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add to manifest and spine</span></span>
<span id="cb148-77"><a href="#cb148-77" aria-hidden="true" tabindex="-1"></a>  (add-manifest-entry ctx (format <span class="st">&quot;content-~a&quot;</span> index)</span>
<span id="cb148-78"><a href="#cb148-78" aria-hidden="true" tabindex="-1"></a>                     filename <span class="st">&quot;application/xhtml+xml&quot;</span>)</span>
<span id="cb148-79"><a href="#cb148-79" aria-hidden="true" tabindex="-1"></a>  (add-spine-entry ctx (format <span class="st">&quot;content-~a&quot;</span> index))</span>
<span id="cb148-80"><a href="#cb148-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-81"><a href="#cb148-81" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Extract navigation points</span></span>
<span id="cb148-82"><a href="#cb148-82" aria-hidden="true" tabindex="-1"></a>  (extract-nav-points ctx chunk filename))</span>
<span id="cb148-83"><a href="#cb148-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-84"><a href="#cb148-84" aria-hidden="true" tabindex="-1"></a><span class="co">;; EPUB-specific HTML rendering</span></span>
<span id="cb148-85"><a href="#cb148-85" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-node-epub ctx node)</span>
<span id="cb148-86"><a href="#cb148-86" aria-hidden="true" tabindex="-1"></a>  (match node</span>
<span id="cb148-87"><a href="#cb148-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(section level number title children id)</span>
<span id="cb148-88"><a href="#cb148-88" aria-hidden="true" tabindex="-1"></a>     `(section ((id ,id))</span>
<span id="cb148-89"><a href="#cb148-89" aria-hidden="true" tabindex="-1"></a>        ,(render-heading-epub level number title)</span>
<span id="cb148-90"><a href="#cb148-90" aria-hidden="true" tabindex="-1"></a>        ,@(map (λ (child) (render-node-epub ctx child)) children))<span class="op">]</span></span>
<span id="cb148-91"><a href="#cb148-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-92"><a href="#cb148-92" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(paragraph children)</span>
<span id="cb148-93"><a href="#cb148-93" aria-hidden="true" tabindex="-1"></a>     `(p ,@(map (λ (child) (render-inline-epub ctx child)) children))<span class="op">]</span></span>
<span id="cb148-94"><a href="#cb148-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-95"><a href="#cb148-95" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(figure source caption alt id)</span>
<span id="cb148-96"><a href="#cb148-96" aria-hidden="true" tabindex="-1"></a>     (render-figure-epub ctx source caption alt id)<span class="op">]</span></span>
<span id="cb148-97"><a href="#cb148-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-98"><a href="#cb148-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(table caption headers rows id)</span>
<span id="cb148-99"><a href="#cb148-99" aria-hidden="true" tabindex="-1"></a>     (render-table-epub ctx caption headers rows id)<span class="op">]</span></span>
<span id="cb148-100"><a href="#cb148-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-101"><a href="#cb148-101" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(code-block lang content id)</span>
<span id="cb148-102"><a href="#cb148-102" aria-hidden="true" tabindex="-1"></a>     `(pre ((class ,(format <span class="st">&quot;language-~a&quot;</span> lang)))</span>
<span id="cb148-103"><a href="#cb148-103" aria-hidden="true" tabindex="-1"></a>        (code ,content))<span class="op">]</span></span>
<span id="cb148-104"><a href="#cb148-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-105"><a href="#cb148-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(equation <span class="kw">display</span> content numbered id)</span>
<span id="cb148-106"><a href="#cb148-106" aria-hidden="true" tabindex="-1"></a>     (render-math-epub ctx <span class="kw">display</span> content numbered id)<span class="op">]</span></span>
<span id="cb148-107"><a href="#cb148-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-108"><a href="#cb148-108" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb148-109"><a href="#cb148-109" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Default handling</span></span>
<span id="cb148-110"><a href="#cb148-110" aria-hidden="true" tabindex="-1"></a>     `(<span class="kw">div</span> ,(format <span class="st">&quot;Unknown node type: ~a&quot;</span> node))<span class="op">]</span>))</span>
<span id="cb148-111"><a href="#cb148-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-112"><a href="#cb148-112" aria-hidden="true" tabindex="-1"></a><span class="co">;; Render inline elements for EPUB</span></span>
<span id="cb148-113"><a href="#cb148-113" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-inline-epub ctx node)</span>
<span id="cb148-114"><a href="#cb148-114" aria-hidden="true" tabindex="-1"></a>  (match node</span>
<span id="cb148-115"><a href="#cb148-115" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(text-run content)</span>
<span id="cb148-116"><a href="#cb148-116" aria-hidden="true" tabindex="-1"></a>     (escape-html content)<span class="op">]</span></span>
<span id="cb148-117"><a href="#cb148-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-118"><a href="#cb148-118" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(emphasis level children)</span>
<span id="cb148-119"><a href="#cb148-119" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> (<span class="op">=</span> level <span class="dv">2</span>)</span>
<span id="cb148-120"><a href="#cb148-120" aria-hidden="true" tabindex="-1"></a>         `(strong ,@(map (λ (c) (render-inline-epub ctx c)) children))</span>
<span id="cb148-121"><a href="#cb148-121" aria-hidden="true" tabindex="-1"></a>         `(em ,@(map (λ (c) (render-inline-epub ctx c)) children)))<span class="op">]</span></span>
<span id="cb148-122"><a href="#cb148-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-123"><a href="#cb148-123" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(inline-code content)</span>
<span id="cb148-124"><a href="#cb148-124" aria-hidden="true" tabindex="-1"></a>     `(code ,content)<span class="op">]</span></span>
<span id="cb148-125"><a href="#cb148-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-126"><a href="#cb148-126" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(hyperlink href children)</span>
<span id="cb148-127"><a href="#cb148-127" aria-hidden="true" tabindex="-1"></a>     (render-link-epub ctx href children)<span class="op">]</span></span>
<span id="cb148-128"><a href="#cb148-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-129"><a href="#cb148-129" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(cross-reference type target)</span>
<span id="cb148-130"><a href="#cb148-130" aria-hidden="true" tabindex="-1"></a>     (render-cross-ref-epub ctx type target)<span class="op">]</span></span>
<span id="cb148-131"><a href="#cb148-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-132"><a href="#cb148-132" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> content<span class="op">]</span>))</span>
<span id="cb148-133"><a href="#cb148-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-134"><a href="#cb148-134" aria-hidden="true" tabindex="-1"></a><span class="co">;; Handle cross-references in EPUB</span></span>
<span id="cb148-135"><a href="#cb148-135" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-cross-ref-epub ctx type target)</span>
<span id="cb148-136"><a href="#cb148-136" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> target-info </span>(lookup-target ctx target))</span>
<span id="cb148-137"><a href="#cb148-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-138"><a href="#cb148-138" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb148-139"><a href="#cb148-139" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(same-file-reference? target-info)</span>
<span id="cb148-140"><a href="#cb148-140" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Internal link within same XHTML file</span></span>
<span id="cb148-141"><a href="#cb148-141" aria-hidden="true" tabindex="-1"></a>     `(a ((href ,(format <span class="st">&quot;#~a&quot;</span> (target-id target-info))))</span>
<span id="cb148-142"><a href="#cb148-142" aria-hidden="true" tabindex="-1"></a>         ,(format-reference type target-info))<span class="op">]</span></span>
<span id="cb148-143"><a href="#cb148-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-144"><a href="#cb148-144" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb148-145"><a href="#cb148-145" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Link to different XHTML file</span></span>
<span id="cb148-146"><a href="#cb148-146" aria-hidden="true" tabindex="-1"></a>     `(a ((href ,(format <span class="st">&quot;~a#~a&quot;</span> </span>
<span id="cb148-147"><a href="#cb148-147" aria-hidden="true" tabindex="-1"></a>                        (target-file target-info)</span>
<span id="cb148-148"><a href="#cb148-148" aria-hidden="true" tabindex="-1"></a>                        (target-id target-info))))</span>
<span id="cb148-149"><a href="#cb148-149" aria-hidden="true" tabindex="-1"></a>         ,(format-reference type target-info))<span class="op">]</span>))</span>
<span id="cb148-150"><a href="#cb148-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-151"><a href="#cb148-151" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate cover page</span></span>
<span id="cb148-152"><a href="#cb148-152" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-cover-page ctx)</span>
<span id="cb148-153"><a href="#cb148-153" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cover-path </span>(epub-options-cover-image (epub-context-options ctx)))</span>
<span id="cb148-154"><a href="#cb148-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-155"><a href="#cb148-155" aria-hidden="true" tabindex="-1"></a>  (when cover-path</span>
<span id="cb148-156"><a href="#cb148-156" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> xhtml</span></span>
<span id="cb148-157"><a href="#cb148-157" aria-hidden="true" tabindex="-1"></a>      `(html ((xmlns <span class="st">&quot;http://www.w3.org/1999/xhtml&quot;</span>))</span>
<span id="cb148-158"><a href="#cb148-158" aria-hidden="true" tabindex="-1"></a>         (head</span>
<span id="cb148-159"><a href="#cb148-159" aria-hidden="true" tabindex="-1"></a>          (title <span class="st">&quot;Cover&quot;</span>)</span>
<span id="cb148-160"><a href="#cb148-160" aria-hidden="true" tabindex="-1"></a>          (style ((type <span class="st">&quot;text/css&quot;</span>))</span>
<span id="cb148-161"><a href="#cb148-161" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;body { margin: 0; padding: 0; }</span></span>
<span id="cb148-162"><a href="#cb148-162" aria-hidden="true" tabindex="-1"></a><span class="st">             img { max-width: 100%; height: 100vh; object-fit: contain; }&quot;</span>))</span>
<span id="cb148-163"><a href="#cb148-163" aria-hidden="true" tabindex="-1"></a>         (body</span>
<span id="cb148-164"><a href="#cb148-164" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">div</span> ((id <span class="st">&quot;cover-image&quot;</span>))</span>
<span id="cb148-165"><a href="#cb148-165" aria-hidden="true" tabindex="-1"></a>            (img ((src ,(format <span class="st">&quot;images/~a&quot;</span> (file-name-from-path cover-path)))</span>
<span id="cb148-166"><a href="#cb148-166" aria-hidden="true" tabindex="-1"></a>                  (alt <span class="st">&quot;Book cover&quot;</span>)))))))</span>
<span id="cb148-167"><a href="#cb148-167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-168"><a href="#cb148-168" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Write cover XHTML</span></span>
<span id="cb148-169"><a href="#cb148-169" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">call-with-output-file</span> </span>
<span id="cb148-170"><a href="#cb148-170" aria-hidden="true" tabindex="-1"></a>     (build-path (epub-context-content-dir ctx) <span class="st">&quot;cover.xhtml&quot;</span>)</span>
<span id="cb148-171"><a href="#cb148-171" aria-hidden="true" tabindex="-1"></a>     (λ (out) (write-xhtml xhtml out))</span>
<span id="cb148-172"><a href="#cb148-172" aria-hidden="true" tabindex="-1"></a>     #:exists &#39;replace)</span>
<span id="cb148-173"><a href="#cb148-173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-174"><a href="#cb148-174" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Copy cover image</span></span>
<span id="cb148-175"><a href="#cb148-175" aria-hidden="true" tabindex="-1"></a>    (copy-file cover-path</span>
<span id="cb148-176"><a href="#cb148-176" aria-hidden="true" tabindex="-1"></a>               (build-path (epub-context-content-dir ctx) </span>
<span id="cb148-177"><a href="#cb148-177" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;images&quot;</span></span>
<span id="cb148-178"><a href="#cb148-178" aria-hidden="true" tabindex="-1"></a>                          (file-name-from-path cover-path))</span>
<span id="cb148-179"><a href="#cb148-179" aria-hidden="true" tabindex="-1"></a>               <span class="dv">#t</span>)</span>
<span id="cb148-180"><a href="#cb148-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-181"><a href="#cb148-181" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Add to manifest and spine</span></span>
<span id="cb148-182"><a href="#cb148-182" aria-hidden="true" tabindex="-1"></a>    (add-manifest-entry ctx <span class="st">&quot;cover&quot;</span> <span class="st">&quot;cover.xhtml&quot;</span> <span class="st">&quot;application/xhtml+xml&quot;</span>)</span>
<span id="cb148-183"><a href="#cb148-183" aria-hidden="true" tabindex="-1"></a>    (add-spine-entry ctx <span class="st">&quot;cover&quot;</span>)))</span></code></pre></div>
<h2 id="navigation-and-metadata">Navigation and Metadata</h2>
<p>EPUB requires sophisticated navigation structures and rich
metadata:</p>
<div class="sourceCode" id="cb149"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; epub-navigation.rkt</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>(require xml)</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate navigation documents</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-navigation ctx doc)</span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> nav-doc </span>(build-navigation-document ctx doc))</span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; EPUB 3 navigation document</span></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>  (when (<span class="kw">eq?</span> (epub-options-version (epub-context-options ctx)) &#39;<span class="fl">3.0</span>)</span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>    (generate-nav-xhtml ctx nav-doc))</span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; EPUB 2 NCX file (backwards compatibility)</span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a>  (generate-ncx ctx nav-doc))</span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build navigation structure</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-navigation-document ctx doc)</span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> toc-depth </span>(epub-options-toc-depth (epub-context-options ctx)))</span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(process-section section depth)</span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a>    (when (<span class="op">&lt;=</span> depth toc-depth)</span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a>      (nav-entry</span>
<span id="cb149-24"><a href="#cb149-24" aria-hidden="true" tabindex="-1"></a>       (section-id section)</span>
<span id="cb149-25"><a href="#cb149-25" aria-hidden="true" tabindex="-1"></a>       (format-nav-title section)</span>
<span id="cb149-26"><a href="#cb149-26" aria-hidden="true" tabindex="-1"></a>       (section-file ctx section)</span>
<span id="cb149-27"><a href="#cb149-27" aria-hidden="true" tabindex="-1"></a>       (append-map (λ (child)</span>
<span id="cb149-28"><a href="#cb149-28" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">if</span> (section? child)</span>
<span id="cb149-29"><a href="#cb149-29" aria-hidden="true" tabindex="-1"></a>                        (process-section child (add1 depth))</span>
<span id="cb149-30"><a href="#cb149-30" aria-hidden="true" tabindex="-1"></a>                        &#39;()))</span>
<span id="cb149-31"><a href="#cb149-31" aria-hidden="true" tabindex="-1"></a>                  (node-children section)))))</span>
<span id="cb149-32"><a href="#cb149-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-33"><a href="#cb149-33" aria-hidden="true" tabindex="-1"></a>  (navigation-doc</span>
<span id="cb149-34"><a href="#cb149-34" aria-hidden="true" tabindex="-1"></a>   (document-title doc)</span>
<span id="cb149-35"><a href="#cb149-35" aria-hidden="true" tabindex="-1"></a>   (filter-map (λ (s) (process-section s <span class="dv">1</span>))</span>
<span id="cb149-36"><a href="#cb149-36" aria-hidden="true" tabindex="-1"></a>              (document-sections doc))))</span>
<span id="cb149-37"><a href="#cb149-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-38"><a href="#cb149-38" aria-hidden="true" tabindex="-1"></a><span class="co">;; EPUB 3 navigation document</span></span>
<span id="cb149-39"><a href="#cb149-39" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-nav-xhtml ctx nav-doc)</span>
<span id="cb149-40"><a href="#cb149-40" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> nav-path </span>(build-path (epub-context-content-dir ctx) <span class="st">&quot;nav.xhtml&quot;</span>))</span>
<span id="cb149-41"><a href="#cb149-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-42"><a href="#cb149-42" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> xhtml</span></span>
<span id="cb149-43"><a href="#cb149-43" aria-hidden="true" tabindex="-1"></a>    `(html ((xmlns <span class="st">&quot;http://www.w3.org/1999/xhtml&quot;</span>)</span>
<span id="cb149-44"><a href="#cb149-44" aria-hidden="true" tabindex="-1"></a>            (xmlns:epub <span class="st">&quot;http://www.idpf.org/2007/ops&quot;</span>))</span>
<span id="cb149-45"><a href="#cb149-45" aria-hidden="true" tabindex="-1"></a>       (head</span>
<span id="cb149-46"><a href="#cb149-46" aria-hidden="true" tabindex="-1"></a>        (meta ((charset <span class="st">&quot;utf-8&quot;</span>)))</span>
<span id="cb149-47"><a href="#cb149-47" aria-hidden="true" tabindex="-1"></a>        (title <span class="st">&quot;Navigation&quot;</span>))</span>
<span id="cb149-48"><a href="#cb149-48" aria-hidden="true" tabindex="-1"></a>       (body</span>
<span id="cb149-49"><a href="#cb149-49" aria-hidden="true" tabindex="-1"></a>        (nav ((epub:type <span class="st">&quot;toc&quot;</span>)</span>
<span id="cb149-50"><a href="#cb149-50" aria-hidden="true" tabindex="-1"></a>              (id <span class="st">&quot;toc&quot;</span>))</span>
<span id="cb149-51"><a href="#cb149-51" aria-hidden="true" tabindex="-1"></a>          (h1 <span class="st">&quot;Table of Contents&quot;</span>)</span>
<span id="cb149-52"><a href="#cb149-52" aria-hidden="true" tabindex="-1"></a>          ,(generate-nav-ol (navigation-doc-entries nav-doc)))</span>
<span id="cb149-53"><a href="#cb149-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb149-54"><a href="#cb149-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Landmarks navigation</span></span>
<span id="cb149-55"><a href="#cb149-55" aria-hidden="true" tabindex="-1"></a>        (nav ((epub:type <span class="st">&quot;landmarks&quot;</span>)</span>
<span id="cb149-56"><a href="#cb149-56" aria-hidden="true" tabindex="-1"></a>              (hidden <span class="st">&quot;hidden&quot;</span>))</span>
<span id="cb149-57"><a href="#cb149-57" aria-hidden="true" tabindex="-1"></a>          (ol</span>
<span id="cb149-58"><a href="#cb149-58" aria-hidden="true" tabindex="-1"></a>           (li (a ((epub:type <span class="st">&quot;cover&quot;</span>)</span>
<span id="cb149-59"><a href="#cb149-59" aria-hidden="true" tabindex="-1"></a>                   (href <span class="st">&quot;cover.xhtml&quot;</span>))</span>
<span id="cb149-60"><a href="#cb149-60" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Cover&quot;</span>))</span>
<span id="cb149-61"><a href="#cb149-61" aria-hidden="true" tabindex="-1"></a>           (li (a ((epub:type <span class="st">&quot;toc&quot;</span>)</span>
<span id="cb149-62"><a href="#cb149-62" aria-hidden="true" tabindex="-1"></a>                   (href <span class="st">&quot;nav.xhtml&quot;</span>))</span>
<span id="cb149-63"><a href="#cb149-63" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Table of Contents&quot;</span>))</span>
<span id="cb149-64"><a href="#cb149-64" aria-hidden="true" tabindex="-1"></a>           (li (a ((epub:type <span class="st">&quot;bodymatter&quot;</span>)</span>
<span id="cb149-65"><a href="#cb149-65" aria-hidden="true" tabindex="-1"></a>                   (href <span class="st">&quot;chapter0.xhtml&quot;</span>))</span>
<span id="cb149-66"><a href="#cb149-66" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Start of Content&quot;</span>)))))))</span>
<span id="cb149-67"><a href="#cb149-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-68"><a href="#cb149-68" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-with-output-file</span> nav-path</span>
<span id="cb149-69"><a href="#cb149-69" aria-hidden="true" tabindex="-1"></a>    (λ (out) (write-xhtml xhtml out))</span>
<span id="cb149-70"><a href="#cb149-70" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;replace)</span>
<span id="cb149-71"><a href="#cb149-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-72"><a href="#cb149-72" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add to manifest</span></span>
<span id="cb149-73"><a href="#cb149-73" aria-hidden="true" tabindex="-1"></a>  (add-manifest-entry ctx <span class="st">&quot;nav&quot;</span> <span class="st">&quot;nav.xhtml&quot;</span> </span>
<span id="cb149-74"><a href="#cb149-74" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;application/xhtml+xml&quot;</span></span>
<span id="cb149-75"><a href="#cb149-75" aria-hidden="true" tabindex="-1"></a>                     &#39;((properties <span class="st">&quot;nav&quot;</span>))))</span>
<span id="cb149-76"><a href="#cb149-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-77"><a href="#cb149-77" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate navigation ordered list</span></span>
<span id="cb149-78"><a href="#cb149-78" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-nav-ol entries)</span>
<span id="cb149-79"><a href="#cb149-79" aria-hidden="true" tabindex="-1"></a>  `(ol ,@(map generate-nav-li entries)))</span>
<span id="cb149-80"><a href="#cb149-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-81"><a href="#cb149-81" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-nav-li entry)</span>
<span id="cb149-82"><a href="#cb149-82" aria-hidden="true" tabindex="-1"></a>  `(li </span>
<span id="cb149-83"><a href="#cb149-83" aria-hidden="true" tabindex="-1"></a>    (a ((href ,(format <span class="st">&quot;~a#~a&quot;</span> </span>
<span id="cb149-84"><a href="#cb149-84" aria-hidden="true" tabindex="-1"></a>                      (nav-entry-file entry)</span>
<span id="cb149-85"><a href="#cb149-85" aria-hidden="true" tabindex="-1"></a>                      (nav-entry-id entry))))</span>
<span id="cb149-86"><a href="#cb149-86" aria-hidden="true" tabindex="-1"></a>       ,(nav-entry-title entry))</span>
<span id="cb149-87"><a href="#cb149-87" aria-hidden="true" tabindex="-1"></a>    ,@(<span class="kw">if</span> (<span class="kw">null?</span> (nav-entry-children entry))</span>
<span id="cb149-88"><a href="#cb149-88" aria-hidden="true" tabindex="-1"></a>          &#39;()</span>
<span id="cb149-89"><a href="#cb149-89" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">list</span> (generate-nav-ol (nav-entry-children entry))))))</span>
<span id="cb149-90"><a href="#cb149-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-91"><a href="#cb149-91" aria-hidden="true" tabindex="-1"></a><span class="co">;; EPUB 2 NCX generation</span></span>
<span id="cb149-92"><a href="#cb149-92" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-ncx ctx nav-doc)</span>
<span id="cb149-93"><a href="#cb149-93" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ncx-path </span>(build-path (epub-context-content-dir ctx) <span class="st">&quot;toc.ncx&quot;</span>))</span>
<span id="cb149-94"><a href="#cb149-94" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> play-order </span><span class="dv">0</span>)</span>
<span id="cb149-95"><a href="#cb149-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-96"><a href="#cb149-96" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(next-play-order!)</span>
<span id="cb149-97"><a href="#cb149-97" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">set!</span> play-order (add1 play-order))</span>
<span id="cb149-98"><a href="#cb149-98" aria-hidden="true" tabindex="-1"></a>    play-order)</span>
<span id="cb149-99"><a href="#cb149-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-100"><a href="#cb149-100" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ncx</span></span>
<span id="cb149-101"><a href="#cb149-101" aria-hidden="true" tabindex="-1"></a>    `(ncx ((xmlns <span class="st">&quot;http://www.daisy.org/z3986/2005/ncx/&quot;</span>)</span>
<span id="cb149-102"><a href="#cb149-102" aria-hidden="true" tabindex="-1"></a>           (version <span class="st">&quot;2005-1&quot;</span>))</span>
<span id="cb149-103"><a href="#cb149-103" aria-hidden="true" tabindex="-1"></a>       (head</span>
<span id="cb149-104"><a href="#cb149-104" aria-hidden="true" tabindex="-1"></a>        (meta ((name <span class="st">&quot;dtb:uid&quot;</span>)</span>
<span id="cb149-105"><a href="#cb149-105" aria-hidden="true" tabindex="-1"></a>               (content ,(generate-uuid))))</span>
<span id="cb149-106"><a href="#cb149-106" aria-hidden="true" tabindex="-1"></a>        (meta ((name <span class="st">&quot;dtb:depth&quot;</span>)</span>
<span id="cb149-107"><a href="#cb149-107" aria-hidden="true" tabindex="-1"></a>               (content ,(<span class="kw">number-&gt;string</span> (calculate-toc-depth nav-doc)))))</span>
<span id="cb149-108"><a href="#cb149-108" aria-hidden="true" tabindex="-1"></a>        (meta ((name <span class="st">&quot;dtb:totalPageCount&quot;</span>)</span>
<span id="cb149-109"><a href="#cb149-109" aria-hidden="true" tabindex="-1"></a>               (content <span class="st">&quot;0&quot;</span>)))</span>
<span id="cb149-110"><a href="#cb149-110" aria-hidden="true" tabindex="-1"></a>        (meta ((name <span class="st">&quot;dtb:maxPageNumber&quot;</span>)</span>
<span id="cb149-111"><a href="#cb149-111" aria-hidden="true" tabindex="-1"></a>               (content <span class="st">&quot;0&quot;</span>))))</span>
<span id="cb149-112"><a href="#cb149-112" aria-hidden="true" tabindex="-1"></a>       (docTitle</span>
<span id="cb149-113"><a href="#cb149-113" aria-hidden="true" tabindex="-1"></a>        (text ,(navigation-doc-title nav-doc)))</span>
<span id="cb149-114"><a href="#cb149-114" aria-hidden="true" tabindex="-1"></a>       (navMap</span>
<span id="cb149-115"><a href="#cb149-115" aria-hidden="true" tabindex="-1"></a>        ,@(map (λ (entry) (generate-nav-point entry next-play-order!))</span>
<span id="cb149-116"><a href="#cb149-116" aria-hidden="true" tabindex="-1"></a>               (navigation-doc-entries nav-doc)))))</span>
<span id="cb149-117"><a href="#cb149-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-118"><a href="#cb149-118" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-with-output-file</span> ncx-path</span>
<span id="cb149-119"><a href="#cb149-119" aria-hidden="true" tabindex="-1"></a>    (λ (out) (write-xml ncx out))</span>
<span id="cb149-120"><a href="#cb149-120" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;replace)</span>
<span id="cb149-121"><a href="#cb149-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-122"><a href="#cb149-122" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add to manifest</span></span>
<span id="cb149-123"><a href="#cb149-123" aria-hidden="true" tabindex="-1"></a>  (add-manifest-entry ctx <span class="st">&quot;ncx&quot;</span> <span class="st">&quot;toc.ncx&quot;</span> <span class="st">&quot;application/x-dtbncx+xml&quot;</span>))</span>
<span id="cb149-124"><a href="#cb149-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-125"><a href="#cb149-125" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate NCX navigation point</span></span>
<span id="cb149-126"><a href="#cb149-126" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-nav-point entry play-order-fn)</span>
<span id="cb149-127"><a href="#cb149-127" aria-hidden="true" tabindex="-1"></a>  `(navPoint ((id ,(nav-entry-id entry))</span>
<span id="cb149-128"><a href="#cb149-128" aria-hidden="true" tabindex="-1"></a>              (playOrder ,(<span class="kw">number-&gt;string</span> (play-order-fn))))</span>
<span id="cb149-129"><a href="#cb149-129" aria-hidden="true" tabindex="-1"></a>     (navLabel</span>
<span id="cb149-130"><a href="#cb149-130" aria-hidden="true" tabindex="-1"></a>      (text ,(nav-entry-title entry)))</span>
<span id="cb149-131"><a href="#cb149-131" aria-hidden="true" tabindex="-1"></a>     (content ((src ,(format <span class="st">&quot;~a#~a&quot;</span></span>
<span id="cb149-132"><a href="#cb149-132" aria-hidden="true" tabindex="-1"></a>                            (nav-entry-file entry)</span>
<span id="cb149-133"><a href="#cb149-133" aria-hidden="true" tabindex="-1"></a>                            (nav-entry-id entry)))))</span>
<span id="cb149-134"><a href="#cb149-134" aria-hidden="true" tabindex="-1"></a>     ,@(map (λ (child) (generate-nav-point child play-order-fn))</span>
<span id="cb149-135"><a href="#cb149-135" aria-hidden="true" tabindex="-1"></a>            (nav-entry-children entry))))</span>
<span id="cb149-136"><a href="#cb149-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-137"><a href="#cb149-137" aria-hidden="true" tabindex="-1"></a><span class="co">;; Package metadata (content.opf)</span></span>
<span id="cb149-138"><a href="#cb149-138" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-metadata-files ctx doc)</span>
<span id="cb149-139"><a href="#cb149-139" aria-hidden="true" tabindex="-1"></a>  (generate-container-xml ctx)</span>
<span id="cb149-140"><a href="#cb149-140" aria-hidden="true" tabindex="-1"></a>  (generate-content-opf ctx doc))</span>
<span id="cb149-141"><a href="#cb149-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-142"><a href="#cb149-142" aria-hidden="true" tabindex="-1"></a><span class="co">;; container.xml in META-INF</span></span>
<span id="cb149-143"><a href="#cb149-143" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-container-xml ctx)</span>
<span id="cb149-144"><a href="#cb149-144" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> container-path </span></span>
<span id="cb149-145"><a href="#cb149-145" aria-hidden="true" tabindex="-1"></a>    (build-path (epub-context-temp-dir ctx) <span class="st">&quot;META-INF&quot;</span> <span class="st">&quot;container.xml&quot;</span>))</span>
<span id="cb149-146"><a href="#cb149-146" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-147"><a href="#cb149-147" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> container</span></span>
<span id="cb149-148"><a href="#cb149-148" aria-hidden="true" tabindex="-1"></a>    `(container ((version <span class="st">&quot;1.0&quot;</span>)</span>
<span id="cb149-149"><a href="#cb149-149" aria-hidden="true" tabindex="-1"></a>                 (xmlns <span class="st">&quot;urn:oasis:names:tc:opendocument:xmlns:container&quot;</span>))</span>
<span id="cb149-150"><a href="#cb149-150" aria-hidden="true" tabindex="-1"></a>       (rootfiles</span>
<span id="cb149-151"><a href="#cb149-151" aria-hidden="true" tabindex="-1"></a>        (rootfile ((full-path <span class="st">&quot;OEBPS/content.opf&quot;</span>)</span>
<span id="cb149-152"><a href="#cb149-152" aria-hidden="true" tabindex="-1"></a>                   (media-type <span class="st">&quot;application/oebps-package+xml&quot;</span>))))))</span>
<span id="cb149-153"><a href="#cb149-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-154"><a href="#cb149-154" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-with-output-file</span> container-path</span>
<span id="cb149-155"><a href="#cb149-155" aria-hidden="true" tabindex="-1"></a>    (λ (out) (write-xml container out))</span>
<span id="cb149-156"><a href="#cb149-156" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;replace))</span>
<span id="cb149-157"><a href="#cb149-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-158"><a href="#cb149-158" aria-hidden="true" tabindex="-1"></a><span class="co">;; content.opf - the package document</span></span>
<span id="cb149-159"><a href="#cb149-159" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-content-opf ctx doc)</span>
<span id="cb149-160"><a href="#cb149-160" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> opf-path </span></span>
<span id="cb149-161"><a href="#cb149-161" aria-hidden="true" tabindex="-1"></a>    (build-path (epub-context-content-dir ctx) <span class="st">&quot;content.opf&quot;</span>))</span>
<span id="cb149-162"><a href="#cb149-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-163"><a href="#cb149-163" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> opf</span></span>
<span id="cb149-164"><a href="#cb149-164" aria-hidden="true" tabindex="-1"></a>    `(package ((xmlns <span class="st">&quot;http://www.idpf.org/2007/opf&quot;</span>)</span>
<span id="cb149-165"><a href="#cb149-165" aria-hidden="true" tabindex="-1"></a>               (version ,(<span class="kw">if</span> (<span class="kw">eq?</span> (epub-options-version </span>
<span id="cb149-166"><a href="#cb149-166" aria-hidden="true" tabindex="-1"></a>                                  (epub-context-options ctx)) &#39;<span class="fl">3.0</span>)</span>
<span id="cb149-167"><a href="#cb149-167" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;3.0&quot;</span></span>
<span id="cb149-168"><a href="#cb149-168" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&quot;2.0&quot;</span>))</span>
<span id="cb149-169"><a href="#cb149-169" aria-hidden="true" tabindex="-1"></a>               (unique-identifier <span class="st">&quot;book-id&quot;</span>))</span>
<span id="cb149-170"><a href="#cb149-170" aria-hidden="true" tabindex="-1"></a>       (metadata ((xmlns:dc <span class="st">&quot;http://purl.org/dc/elements/1.1/&quot;</span>))</span>
<span id="cb149-171"><a href="#cb149-171" aria-hidden="true" tabindex="-1"></a>         (dc:identifier ((id <span class="st">&quot;book-id&quot;</span>)) ,(generate-uuid))</span>
<span id="cb149-172"><a href="#cb149-172" aria-hidden="true" tabindex="-1"></a>         (dc:title ,(document-title doc))</span>
<span id="cb149-173"><a href="#cb149-173" aria-hidden="true" tabindex="-1"></a>         ,@(map (λ (author)</span>
<span id="cb149-174"><a href="#cb149-174" aria-hidden="true" tabindex="-1"></a>                 `(dc:creator ((id ,(format <span class="st">&quot;creator~a&quot;</span> </span>
<span id="cb149-175"><a href="#cb149-175" aria-hidden="true" tabindex="-1"></a>                                          (author-id author))))</span>
<span id="cb149-176"><a href="#cb149-176" aria-hidden="true" tabindex="-1"></a>                    ,(author-name author)))</span>
<span id="cb149-177"><a href="#cb149-177" aria-hidden="true" tabindex="-1"></a>               (document-authors doc))</span>
<span id="cb149-178"><a href="#cb149-178" aria-hidden="true" tabindex="-1"></a>         (dc:language <span class="st">&quot;en&quot;</span>)</span>
<span id="cb149-179"><a href="#cb149-179" aria-hidden="true" tabindex="-1"></a>         (dc:date ,(current-date-string))</span>
<span id="cb149-180"><a href="#cb149-180" aria-hidden="true" tabindex="-1"></a>         ,@(<span class="kw">if</span> (document-description doc)</span>
<span id="cb149-181"><a href="#cb149-181" aria-hidden="true" tabindex="-1"></a>               `((dc:description ,(document-description doc)))</span>
<span id="cb149-182"><a href="#cb149-182" aria-hidden="true" tabindex="-1"></a>               &#39;())</span>
<span id="cb149-183"><a href="#cb149-183" aria-hidden="true" tabindex="-1"></a>         ,@(generate-additional-metadata ctx doc))</span>
<span id="cb149-184"><a href="#cb149-184" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb149-185"><a href="#cb149-185" aria-hidden="true" tabindex="-1"></a>       (manifest</span>
<span id="cb149-186"><a href="#cb149-186" aria-hidden="true" tabindex="-1"></a>        ,@(<span class="kw">reverse</span> (epub-context-manifest ctx)))</span>
<span id="cb149-187"><a href="#cb149-187" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb149-188"><a href="#cb149-188" aria-hidden="true" tabindex="-1"></a>       (spine ((toc <span class="st">&quot;ncx&quot;</span>))</span>
<span id="cb149-189"><a href="#cb149-189" aria-hidden="true" tabindex="-1"></a>         ,@(<span class="kw">reverse</span> (epub-context-spine ctx)))</span>
<span id="cb149-190"><a href="#cb149-190" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb149-191"><a href="#cb149-191" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; EPUB 2 guide (deprecated in EPUB 3)</span></span>
<span id="cb149-192"><a href="#cb149-192" aria-hidden="true" tabindex="-1"></a>       ,@(<span class="kw">if</span> (<span class="kw">eq?</span> (epub-options-version (epub-context-options ctx)) &#39;<span class="fl">2.0</span>)</span>
<span id="cb149-193"><a href="#cb149-193" aria-hidden="true" tabindex="-1"></a>             `((guide</span>
<span id="cb149-194"><a href="#cb149-194" aria-hidden="true" tabindex="-1"></a>                (reference ((type <span class="st">&quot;cover&quot;</span>)</span>
<span id="cb149-195"><a href="#cb149-195" aria-hidden="true" tabindex="-1"></a>                           (title <span class="st">&quot;Cover&quot;</span>)</span>
<span id="cb149-196"><a href="#cb149-196" aria-hidden="true" tabindex="-1"></a>                           (href <span class="st">&quot;cover.xhtml&quot;</span>)))</span>
<span id="cb149-197"><a href="#cb149-197" aria-hidden="true" tabindex="-1"></a>                (reference ((type <span class="st">&quot;toc&quot;</span>)</span>
<span id="cb149-198"><a href="#cb149-198" aria-hidden="true" tabindex="-1"></a>                           (title <span class="st">&quot;Table of Contents&quot;</span>)</span>
<span id="cb149-199"><a href="#cb149-199" aria-hidden="true" tabindex="-1"></a>                           (href <span class="st">&quot;nav.xhtml&quot;</span>)))))</span>
<span id="cb149-200"><a href="#cb149-200" aria-hidden="true" tabindex="-1"></a>             &#39;())))</span>
<span id="cb149-201"><a href="#cb149-201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-202"><a href="#cb149-202" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-with-output-file</span> opf-path</span>
<span id="cb149-203"><a href="#cb149-203" aria-hidden="true" tabindex="-1"></a>    (λ (out) (write-xml opf out))</span>
<span id="cb149-204"><a href="#cb149-204" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;replace))</span></code></pre></div>
<h2 id="styling-and-resources">Styling and Resources</h2>
<p>EPUB styling requires careful consideration of device
capabilities:</p>
<div class="sourceCode" id="cb150"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; epub-styling.rkt</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>(require css-expr</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;document-model.rkt&quot;</span>)</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate EPUB-compatible CSS</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-epub-styles ctx doc)</span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> css-path </span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>    (build-path (epub-context-content-dir ctx) <span class="st">&quot;css&quot;</span> <span class="st">&quot;style.css&quot;</span>))</span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Use custom stylesheet if provided</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(epub-options-stylesheet (epub-context-options ctx))</span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>     (copy-file (epub-options-stylesheet (epub-context-options ctx))</span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>                css-path</span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>                <span class="dv">#t</span>)<span class="op">]</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Generate default stylesheet</span></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">call-with-output-file</span> css-path</span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a>       (λ (out)</span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a>         (write-string (generate-default-epub-css) out))</span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>       #:exists &#39;replace)<span class="op">]</span>)</span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add to manifest</span></span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a>  (add-manifest-entry ctx <span class="st">&quot;stylesheet&quot;</span> <span class="st">&quot;css/style.css&quot;</span> <span class="st">&quot;text/css&quot;</span>))</span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a><span class="co">;; Default EPUB CSS</span></span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-default-epub-css)</span>
<span id="cb150-31"><a href="#cb150-31" aria-hidden="true" tabindex="-1"></a>  (css</span>
<span id="cb150-32"><a href="#cb150-32" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Reset and base styles</span></span>
<span id="cb150-33"><a href="#cb150-33" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;body&quot;</span></span>
<span id="cb150-34"><a href="#cb150-34" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>margin <span class="st">&quot;1em&quot;</span><span class="op">]</span></span>
<span id="cb150-35"><a href="#cb150-35" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-family <span class="st">&quot;serif&quot;</span><span class="op">]</span></span>
<span id="cb150-36"><a href="#cb150-36" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>line-height <span class="st">&quot;1.6&quot;</span><span class="op">]</span></span>
<span id="cb150-37"><a href="#cb150-37" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>text-align <span class="st">&quot;justify&quot;</span><span class="op">]</span></span>
<span id="cb150-38"><a href="#cb150-38" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>hyphens <span class="st">&quot;auto&quot;</span><span class="op">]</span>)</span>
<span id="cb150-39"><a href="#cb150-39" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-40"><a href="#cb150-40" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Typography</span></span>
<span id="cb150-41"><a href="#cb150-41" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;h1, h2, h3, h4, h5, h6&quot;</span></span>
<span id="cb150-42"><a href="#cb150-42" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-family <span class="st">&quot;sans-serif&quot;</span><span class="op">]</span></span>
<span id="cb150-43"><a href="#cb150-43" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>line-height <span class="st">&quot;1.2&quot;</span><span class="op">]</span></span>
<span id="cb150-44"><a href="#cb150-44" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>text-align <span class="st">&quot;left&quot;</span><span class="op">]</span></span>
<span id="cb150-45"><a href="#cb150-45" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>page-break-after <span class="st">&quot;avoid&quot;</span><span class="op">]</span></span>
<span id="cb150-46"><a href="#cb150-46" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>margin-top <span class="st">&quot;1.5em&quot;</span><span class="op">]</span></span>
<span id="cb150-47"><a href="#cb150-47" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>margin-bottom <span class="st">&quot;0.5em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-48"><a href="#cb150-48" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-49"><a href="#cb150-49" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;h1&quot;</span> <span class="op">[</span>font-size <span class="st">&quot;1.8em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-50"><a href="#cb150-50" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;h2&quot;</span> <span class="op">[</span>font-size <span class="st">&quot;1.5em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-51"><a href="#cb150-51" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;h3&quot;</span> <span class="op">[</span>font-size <span class="st">&quot;1.3em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-52"><a href="#cb150-52" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;h4&quot;</span> <span class="op">[</span>font-size <span class="st">&quot;1.1em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-53"><a href="#cb150-53" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;h5&quot;</span> <span class="op">[</span>font-size <span class="st">&quot;1.0em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-54"><a href="#cb150-54" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;h6&quot;</span> <span class="op">[</span>font-size <span class="st">&quot;0.9em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-55"><a href="#cb150-55" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-56"><a href="#cb150-56" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Paragraphs</span></span>
<span id="cb150-57"><a href="#cb150-57" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;p&quot;</span></span>
<span id="cb150-58"><a href="#cb150-58" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>margin <span class="st">&quot;0&quot;</span><span class="op">]</span></span>
<span id="cb150-59"><a href="#cb150-59" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>text-indent <span class="st">&quot;1.5em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-60"><a href="#cb150-60" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-61"><a href="#cb150-61" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;p:first-child, h1 + p, h2 + p, h3 + p&quot;</span></span>
<span id="cb150-62"><a href="#cb150-62" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>text-indent <span class="st">&quot;0&quot;</span><span class="op">]</span>)</span>
<span id="cb150-63"><a href="#cb150-63" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-64"><a href="#cb150-64" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Code blocks</span></span>
<span id="cb150-65"><a href="#cb150-65" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;pre&quot;</span></span>
<span id="cb150-66"><a href="#cb150-66" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-family <span class="st">&quot;monospace&quot;</span><span class="op">]</span></span>
<span id="cb150-67"><a href="#cb150-67" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>white-space <span class="st">&quot;pre-wrap&quot;</span><span class="op">]</span></span>
<span id="cb150-68"><a href="#cb150-68" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>background-color <span class="st">&quot;#f5f5f5&quot;</span><span class="op">]</span></span>
<span id="cb150-69"><a href="#cb150-69" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>padding <span class="st">&quot;0.5em&quot;</span><span class="op">]</span></span>
<span id="cb150-70"><a href="#cb150-70" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>margin <span class="st">&quot;1em 0&quot;</span><span class="op">]</span></span>
<span id="cb150-71"><a href="#cb150-71" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>overflow-x <span class="st">&quot;auto&quot;</span><span class="op">]</span>)</span>
<span id="cb150-72"><a href="#cb150-72" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-73"><a href="#cb150-73" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;code&quot;</span></span>
<span id="cb150-74"><a href="#cb150-74" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-family <span class="st">&quot;monospace&quot;</span><span class="op">]</span></span>
<span id="cb150-75"><a href="#cb150-75" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-size <span class="st">&quot;0.9em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-76"><a href="#cb150-76" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-77"><a href="#cb150-77" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Figures and images</span></span>
<span id="cb150-78"><a href="#cb150-78" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;figure&quot;</span></span>
<span id="cb150-79"><a href="#cb150-79" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>margin <span class="st">&quot;1em 0&quot;</span><span class="op">]</span></span>
<span id="cb150-80"><a href="#cb150-80" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>text-align <span class="st">&quot;center&quot;</span><span class="op">]</span></span>
<span id="cb150-81"><a href="#cb150-81" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>page-break-inside <span class="st">&quot;avoid&quot;</span><span class="op">]</span>)</span>
<span id="cb150-82"><a href="#cb150-82" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-83"><a href="#cb150-83" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;img&quot;</span></span>
<span id="cb150-84"><a href="#cb150-84" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>max-width <span class="st">&quot;100%&quot;</span><span class="op">]</span></span>
<span id="cb150-85"><a href="#cb150-85" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>height <span class="st">&quot;auto&quot;</span><span class="op">]</span>)</span>
<span id="cb150-86"><a href="#cb150-86" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-87"><a href="#cb150-87" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;figcaption&quot;</span></span>
<span id="cb150-88"><a href="#cb150-88" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-size <span class="st">&quot;0.9em&quot;</span><span class="op">]</span></span>
<span id="cb150-89"><a href="#cb150-89" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-style <span class="st">&quot;italic&quot;</span><span class="op">]</span></span>
<span id="cb150-90"><a href="#cb150-90" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>margin-top <span class="st">&quot;0.5em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-91"><a href="#cb150-91" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-92"><a href="#cb150-92" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Tables</span></span>
<span id="cb150-93"><a href="#cb150-93" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;table&quot;</span></span>
<span id="cb150-94"><a href="#cb150-94" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>border-collapse <span class="st">&quot;collapse&quot;</span><span class="op">]</span></span>
<span id="cb150-95"><a href="#cb150-95" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>margin <span class="st">&quot;1em auto&quot;</span><span class="op">]</span></span>
<span id="cb150-96"><a href="#cb150-96" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-size <span class="st">&quot;0.9em&quot;</span><span class="op">]</span>)</span>
<span id="cb150-97"><a href="#cb150-97" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-98"><a href="#cb150-98" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;th, td&quot;</span></span>
<span id="cb150-99"><a href="#cb150-99" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>padding <span class="st">&quot;0.5em&quot;</span><span class="op">]</span></span>
<span id="cb150-100"><a href="#cb150-100" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>border <span class="st">&quot;1px solid #ddd&quot;</span><span class="op">]</span>)</span>
<span id="cb150-101"><a href="#cb150-101" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-102"><a href="#cb150-102" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;th&quot;</span></span>
<span id="cb150-103"><a href="#cb150-103" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>background-color <span class="st">&quot;#f5f5f5&quot;</span><span class="op">]</span></span>
<span id="cb150-104"><a href="#cb150-104" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-weight <span class="st">&quot;bold&quot;</span><span class="op">]</span>)</span>
<span id="cb150-105"><a href="#cb150-105" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-106"><a href="#cb150-106" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Mathematical content</span></span>
<span id="cb150-107"><a href="#cb150-107" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;.math&quot;</span></span>
<span id="cb150-108"><a href="#cb150-108" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-family <span class="st">&quot;serif&quot;</span><span class="op">]</span></span>
<span id="cb150-109"><a href="#cb150-109" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>font-style <span class="st">&quot;italic&quot;</span><span class="op">]</span>)</span>
<span id="cb150-110"><a href="#cb150-110" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-111"><a href="#cb150-111" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;.math-display&quot;</span></span>
<span id="cb150-112"><a href="#cb150-112" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="kw">display</span> <span class="st">&quot;block&quot;</span><span class="op">]</span></span>
<span id="cb150-113"><a href="#cb150-113" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>margin <span class="st">&quot;1em 0&quot;</span><span class="op">]</span></span>
<span id="cb150-114"><a href="#cb150-114" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>text-align <span class="st">&quot;center&quot;</span><span class="op">]</span>)</span>
<span id="cb150-115"><a href="#cb150-115" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-116"><a href="#cb150-116" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Links</span></span>
<span id="cb150-117"><a href="#cb150-117" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;a&quot;</span></span>
<span id="cb150-118"><a href="#cb150-118" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>color <span class="st">&quot;#0066cc&quot;</span><span class="op">]</span></span>
<span id="cb150-119"><a href="#cb150-119" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>text-decoration <span class="st">&quot;none&quot;</span><span class="op">]</span>)</span>
<span id="cb150-120"><a href="#cb150-120" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-121"><a href="#cb150-121" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;a:hover&quot;</span></span>
<span id="cb150-122"><a href="#cb150-122" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>text-decoration <span class="st">&quot;underline&quot;</span><span class="op">]</span>)</span>
<span id="cb150-123"><a href="#cb150-123" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-124"><a href="#cb150-124" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Page breaks</span></span>
<span id="cb150-125"><a href="#cb150-125" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;.page-break&quot;</span></span>
<span id="cb150-126"><a href="#cb150-126" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>page-break-before <span class="st">&quot;always&quot;</span><span class="op">]</span>)</span>
<span id="cb150-127"><a href="#cb150-127" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb150-128"><a href="#cb150-128" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Accessibility</span></span>
<span id="cb150-129"><a href="#cb150-129" aria-hidden="true" tabindex="-1"></a>   (rule <span class="st">&quot;.sr-only&quot;</span></span>
<span id="cb150-130"><a href="#cb150-130" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>position <span class="st">&quot;absolute&quot;</span><span class="op">]</span></span>
<span id="cb150-131"><a href="#cb150-131" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>width <span class="st">&quot;1px&quot;</span><span class="op">]</span></span>
<span id="cb150-132"><a href="#cb150-132" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>height <span class="st">&quot;1px&quot;</span><span class="op">]</span></span>
<span id="cb150-133"><a href="#cb150-133" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>padding <span class="st">&quot;0&quot;</span><span class="op">]</span></span>
<span id="cb150-134"><a href="#cb150-134" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>margin <span class="st">&quot;-1px&quot;</span><span class="op">]</span></span>
<span id="cb150-135"><a href="#cb150-135" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>overflow <span class="st">&quot;hidden&quot;</span><span class="op">]</span></span>
<span id="cb150-136"><a href="#cb150-136" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>clip <span class="st">&quot;rect(0,0,0,0)&quot;</span><span class="op">]</span></span>
<span id="cb150-137"><a href="#cb150-137" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>white-space <span class="st">&quot;nowrap&quot;</span><span class="op">]</span></span>
<span id="cb150-138"><a href="#cb150-138" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span>border <span class="st">&quot;0&quot;</span><span class="op">]</span>)))</span>
<span id="cb150-139"><a href="#cb150-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-140"><a href="#cb150-140" aria-hidden="true" tabindex="-1"></a><span class="co">;; Copy and process resources</span></span>
<span id="cb150-141"><a href="#cb150-141" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(copy-resources ctx doc)</span>
<span id="cb150-142"><a href="#cb150-142" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Copy images</span></span>
<span id="cb150-143"><a href="#cb150-143" aria-hidden="true" tabindex="-1"></a>  (copy-document-images ctx doc)</span>
<span id="cb150-144"><a href="#cb150-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-145"><a href="#cb150-145" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Embed fonts if requested</span></span>
<span id="cb150-146"><a href="#cb150-146" aria-hidden="true" tabindex="-1"></a>  (when (epub-options-embed-fonts (epub-context-options ctx))</span>
<span id="cb150-147"><a href="#cb150-147" aria-hidden="true" tabindex="-1"></a>    (embed-fonts ctx))</span>
<span id="cb150-148"><a href="#cb150-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-149"><a href="#cb150-149" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate stylesheet</span></span>
<span id="cb150-150"><a href="#cb150-150" aria-hidden="true" tabindex="-1"></a>  (generate-epub-styles ctx doc))</span>
<span id="cb150-151"><a href="#cb150-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-152"><a href="#cb150-152" aria-hidden="true" tabindex="-1"></a><span class="co">;; Copy images and update manifest</span></span>
<span id="cb150-153"><a href="#cb150-153" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(copy-document-images ctx doc)</span>
<span id="cb150-154"><a href="#cb150-154" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> images </span>(extract-all-images doc))</span>
<span id="cb150-155"><a href="#cb150-155" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> image-dir </span>(build-path (epub-context-content-dir ctx) <span class="st">&quot;images&quot;</span>))</span>
<span id="cb150-156"><a href="#cb150-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-157"><a href="#cb150-157" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>img-path images<span class="op">]</span>)</span>
<span id="cb150-158"><a href="#cb150-158" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> filename </span>(file-name-from-path img-path))</span>
<span id="cb150-159"><a href="#cb150-159" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> dest-path </span>(build-path image-dir filename))</span>
<span id="cb150-160"><a href="#cb150-160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-161"><a href="#cb150-161" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Copy image file</span></span>
<span id="cb150-162"><a href="#cb150-162" aria-hidden="true" tabindex="-1"></a>    (copy-file img-path dest-path <span class="dv">#t</span>)</span>
<span id="cb150-163"><a href="#cb150-163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-164"><a href="#cb150-164" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Add to manifest</span></span>
<span id="cb150-165"><a href="#cb150-165" aria-hidden="true" tabindex="-1"></a>    (add-manifest-entry ctx </span>
<span id="cb150-166"><a href="#cb150-166" aria-hidden="true" tabindex="-1"></a>                       (format <span class="st">&quot;image-~a&quot;</span> (path-&gt;string filename))</span>
<span id="cb150-167"><a href="#cb150-167" aria-hidden="true" tabindex="-1"></a>                       (format <span class="st">&quot;images/~a&quot;</span> filename)</span>
<span id="cb150-168"><a href="#cb150-168" aria-hidden="true" tabindex="-1"></a>                       (image-mime-type img-path))))</span>
<span id="cb150-169"><a href="#cb150-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-170"><a href="#cb150-170" aria-hidden="true" tabindex="-1"></a><span class="co">;; Embed fonts</span></span>
<span id="cb150-171"><a href="#cb150-171" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(embed-fonts ctx)</span>
<span id="cb150-172"><a href="#cb150-172" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> fonts </span>(epub-options-embed-fonts (epub-context-options ctx)))</span>
<span id="cb150-173"><a href="#cb150-173" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> font-dir </span>(build-path (epub-context-content-dir ctx) <span class="st">&quot;fonts&quot;</span>))</span>
<span id="cb150-174"><a href="#cb150-174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-175"><a href="#cb150-175" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>font-path fonts<span class="op">]</span>)</span>
<span id="cb150-176"><a href="#cb150-176" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> filename </span>(file-name-from-path font-path))</span>
<span id="cb150-177"><a href="#cb150-177" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> dest-path </span>(build-path font-dir filename))</span>
<span id="cb150-178"><a href="#cb150-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-179"><a href="#cb150-179" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Copy font file</span></span>
<span id="cb150-180"><a href="#cb150-180" aria-hidden="true" tabindex="-1"></a>    (copy-file font-path dest-path <span class="dv">#t</span>)</span>
<span id="cb150-181"><a href="#cb150-181" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-182"><a href="#cb150-182" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Add to manifest</span></span>
<span id="cb150-183"><a href="#cb150-183" aria-hidden="true" tabindex="-1"></a>    (add-manifest-entry ctx</span>
<span id="cb150-184"><a href="#cb150-184" aria-hidden="true" tabindex="-1"></a>                       (format <span class="st">&quot;font-~a&quot;</span> (path-&gt;string filename))</span>
<span id="cb150-185"><a href="#cb150-185" aria-hidden="true" tabindex="-1"></a>                       (format <span class="st">&quot;fonts/~a&quot;</span> filename)</span>
<span id="cb150-186"><a href="#cb150-186" aria-hidden="true" tabindex="-1"></a>                       (font-mime-type font-path))))</span></code></pre></div>
<h2 id="mathematical-content-in-epub">Mathematical Content in EPUB</h2>
<p>Handling mathematics in EPUB requires special consideration:</p>
<div class="sourceCode" id="cb151"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; epub-math.rkt</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;mathjax-renderer.rkt&quot;</span>)</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Render mathematical content for EPUB</span></span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-math-epub ctx <span class="kw">display</span> content numbered id)</span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> options </span>(epub-context-options ctx))</span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; EPUB 3 with MathML support</span></span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">and</span> (<span class="kw">eq?</span> (epub-options-version options) &#39;<span class="fl">3.0</span>)</span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>          (epub-options-mathml options))</span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a>     (render-mathml-epub content <span class="kw">display</span> id)<span class="op">]</span></span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Fallback to SVG</span></span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(epub-options-svg-math options)</span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a>     (render-math-svg content <span class="kw">display</span> id)<span class="op">]</span></span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Simple HTML+CSS fallback</span></span>
<span id="cb151-21"><a href="#cb151-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb151-22"><a href="#cb151-22" aria-hidden="true" tabindex="-1"></a>     (render-math-html-fallback content <span class="kw">display</span>)<span class="op">]</span>))</span>
<span id="cb151-23"><a href="#cb151-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-24"><a href="#cb151-24" aria-hidden="true" tabindex="-1"></a><span class="co">;; MathML rendering for EPUB 3</span></span>
<span id="cb151-25"><a href="#cb151-25" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-mathml-epub latex-content <span class="kw">display</span> id)</span>
<span id="cb151-26"><a href="#cb151-26" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> mathml </span>(latex-&gt;mathml latex-content))</span>
<span id="cb151-27"><a href="#cb151-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-28"><a href="#cb151-28" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> <span class="kw">display</span></span>
<span id="cb151-29"><a href="#cb151-29" aria-hidden="true" tabindex="-1"></a>      `(<span class="kw">div</span> ((class <span class="st">&quot;math-display&quot;</span>)</span>
<span id="cb151-30"><a href="#cb151-30" aria-hidden="true" tabindex="-1"></a>             (id ,id))</span>
<span id="cb151-31"><a href="#cb151-31" aria-hidden="true" tabindex="-1"></a>         ,mathml)</span>
<span id="cb151-32"><a href="#cb151-32" aria-hidden="true" tabindex="-1"></a>      `(span ((class <span class="st">&quot;math-inline&quot;</span>))</span>
<span id="cb151-33"><a href="#cb151-33" aria-hidden="true" tabindex="-1"></a>         ,mathml)))</span>
<span id="cb151-34"><a href="#cb151-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-35"><a href="#cb151-35" aria-hidden="true" tabindex="-1"></a><span class="co">;; SVG rendering for mathematics</span></span>
<span id="cb151-36"><a href="#cb151-36" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-math-svg latex-content <span class="kw">display</span> id)</span>
<span id="cb151-37"><a href="#cb151-37" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> svg-content </span>(latex-&gt;svg latex-content))</span>
<span id="cb151-38"><a href="#cb151-38" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> svg-filename </span>(format <span class="st">&quot;math-~a.svg&quot;</span> id))</span>
<span id="cb151-39"><a href="#cb151-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-40"><a href="#cb151-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Save SVG file</span></span>
<span id="cb151-41"><a href="#cb151-41" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-with-output-file</span> </span>
<span id="cb151-42"><a href="#cb151-42" aria-hidden="true" tabindex="-1"></a>   (build-path (epub-context-content-dir ctx) <span class="st">&quot;images&quot;</span> svg-filename)</span>
<span id="cb151-43"><a href="#cb151-43" aria-hidden="true" tabindex="-1"></a>   (λ (out) (write-string svg-content out))</span>
<span id="cb151-44"><a href="#cb151-44" aria-hidden="true" tabindex="-1"></a>   #:exists &#39;replace)</span>
<span id="cb151-45"><a href="#cb151-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-46"><a href="#cb151-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add to manifest</span></span>
<span id="cb151-47"><a href="#cb151-47" aria-hidden="true" tabindex="-1"></a>  (add-manifest-entry ctx</span>
<span id="cb151-48"><a href="#cb151-48" aria-hidden="true" tabindex="-1"></a>                     (format <span class="st">&quot;math-svg-~a&quot;</span> id)</span>
<span id="cb151-49"><a href="#cb151-49" aria-hidden="true" tabindex="-1"></a>                     (format <span class="st">&quot;images/~a&quot;</span> svg-filename)</span>
<span id="cb151-50"><a href="#cb151-50" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;image/svg+xml&quot;</span>)</span>
<span id="cb151-51"><a href="#cb151-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-52"><a href="#cb151-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Return img element</span></span>
<span id="cb151-53"><a href="#cb151-53" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> <span class="kw">display</span></span>
<span id="cb151-54"><a href="#cb151-54" aria-hidden="true" tabindex="-1"></a>      `(<span class="kw">div</span> ((class <span class="st">&quot;math-display&quot;</span>))</span>
<span id="cb151-55"><a href="#cb151-55" aria-hidden="true" tabindex="-1"></a>         (img ((src ,(format <span class="st">&quot;images/~a&quot;</span> svg-filename))</span>
<span id="cb151-56"><a href="#cb151-56" aria-hidden="true" tabindex="-1"></a>               (alt ,latex-content)</span>
<span id="cb151-57"><a href="#cb151-57" aria-hidden="true" tabindex="-1"></a>               (role <span class="st">&quot;math&quot;</span>))))</span>
<span id="cb151-58"><a href="#cb151-58" aria-hidden="true" tabindex="-1"></a>      `(img ((src ,(format <span class="st">&quot;images/~a&quot;</span> svg-filename))</span>
<span id="cb151-59"><a href="#cb151-59" aria-hidden="true" tabindex="-1"></a>             (alt ,latex-content)</span>
<span id="cb151-60"><a href="#cb151-60" aria-hidden="true" tabindex="-1"></a>             (role <span class="st">&quot;math&quot;</span>)</span>
<span id="cb151-61"><a href="#cb151-61" aria-hidden="true" tabindex="-1"></a>             (class <span class="st">&quot;math-inline&quot;</span>)))))</span>
<span id="cb151-62"><a href="#cb151-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-63"><a href="#cb151-63" aria-hidden="true" tabindex="-1"></a><span class="co">;; HTML+CSS fallback for simple math</span></span>
<span id="cb151-64"><a href="#cb151-64" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-math-html-fallback content <span class="kw">display</span>)</span>
<span id="cb151-65"><a href="#cb151-65" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> <span class="kw">display</span></span>
<span id="cb151-66"><a href="#cb151-66" aria-hidden="true" tabindex="-1"></a>      `(<span class="kw">div</span> ((class <span class="st">&quot;math-display math-fallback&quot;</span>))</span>
<span id="cb151-67"><a href="#cb151-67" aria-hidden="true" tabindex="-1"></a>         ,(simplify-math-notation content))</span>
<span id="cb151-68"><a href="#cb151-68" aria-hidden="true" tabindex="-1"></a>      `(span ((class <span class="st">&quot;math-inline math-fallback&quot;</span>))</span>
<span id="cb151-69"><a href="#cb151-69" aria-hidden="true" tabindex="-1"></a>         ,(simplify-math-notation content))))</span></code></pre></div>
<h2 id="packaging-and-validation">Packaging and Validation</h2>
<p>The final step creates a valid EPUB file:</p>
<div class="sourceCode" id="cb152"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; epub-package.rkt</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>(require racket/zip</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>         file/zip)</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Package EPUB file</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(package-epub temp-dir output-path)</span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create EPUB zip file with correct structure</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>  (parameterize (<span class="op">[</span>current-directory temp-dir<span class="op">]</span>)</span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; EPUB requires specific ordering</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> files </span>(find-files (<span class="kw">lambda</span> (p) <span class="dv">#t</span>)))</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Sort to ensure mimetype is first and uncompressed</span></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> sorted-files</span></span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>      (sort files</span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>            (λ (a b)</span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>              (<span class="kw">cond</span></span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>                <span class="op">[</span>(<span class="kw">equal?</span> (path-&gt;string a) <span class="st">&quot;mimetype&quot;</span>) <span class="dv">#t</span><span class="op">]</span></span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>                <span class="op">[</span>(<span class="kw">equal?</span> (path-&gt;string b) <span class="st">&quot;mimetype&quot;</span>) <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>                <span class="op">[</span><span class="kw">else</span> (<span class="kw">string&lt;?</span> (path-&gt;string a) (path-&gt;string b))<span class="op">]</span>))))</span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Create zip with special handling for mimetype</span></span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">call-with-output-file</span> output-path</span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>      (λ (out)</span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> zip-writer </span>(open-output-zip out))</span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Write mimetype first, uncompressed</span></span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a>        (write-zip-entry zip-writer</span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;mimetype&quot;</span></span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a>                        (file-&gt;bytes <span class="st">&quot;mimetype&quot;</span>)</span>
<span id="cb152-32"><a href="#cb152-32" aria-hidden="true" tabindex="-1"></a>                        #:compress? <span class="dv">#f</span>)</span>
<span id="cb152-33"><a href="#cb152-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb152-34"><a href="#cb152-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Write remaining files</span></span>
<span id="cb152-35"><a href="#cb152-35" aria-hidden="true" tabindex="-1"></a>        (for (<span class="op">[</span>file (<span class="kw">cdr</span> sorted-files)<span class="op">]</span>)</span>
<span id="cb152-36"><a href="#cb152-36" aria-hidden="true" tabindex="-1"></a>          (write-zip-entry zip-writer</span>
<span id="cb152-37"><a href="#cb152-37" aria-hidden="true" tabindex="-1"></a>                          (path-&gt;string file)</span>
<span id="cb152-38"><a href="#cb152-38" aria-hidden="true" tabindex="-1"></a>                          (file-&gt;bytes file)</span>
<span id="cb152-39"><a href="#cb152-39" aria-hidden="true" tabindex="-1"></a>                          #:compress? <span class="dv">#t</span>))</span>
<span id="cb152-40"><a href="#cb152-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb152-41"><a href="#cb152-41" aria-hidden="true" tabindex="-1"></a>        (close-output-zip zip-writer))</span>
<span id="cb152-42"><a href="#cb152-42" aria-hidden="true" tabindex="-1"></a>      #:exists &#39;replace)))</span>
<span id="cb152-43"><a href="#cb152-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-44"><a href="#cb152-44" aria-hidden="true" tabindex="-1"></a><span class="co">;; EPUB validation</span></span>
<span id="cb152-45"><a href="#cb152-45" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(validate-epub epub-path)</span>
<span id="cb152-46"><a href="#cb152-46" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> errors </span>&#39;())</span>
<span id="cb152-47"><a href="#cb152-47" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> warnings </span>&#39;())</span>
<span id="cb152-48"><a href="#cb152-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb152-49"><a href="#cb152-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check EPUB structure</span></span>
<span id="cb152-50"><a href="#cb152-50" aria-hidden="true" tabindex="-1"></a>  (with-unzip epub-path</span>
<span id="cb152-51"><a href="#cb152-51" aria-hidden="true" tabindex="-1"></a>    (λ (temp-dir)</span>
<span id="cb152-52"><a href="#cb152-52" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Verify mimetype</span></span>
<span id="cb152-53"><a href="#cb152-53" aria-hidden="true" tabindex="-1"></a>      (unless (check-mimetype temp-dir)</span>
<span id="cb152-54"><a href="#cb152-54" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">set!</span> errors (<span class="kw">cons</span> <span class="st">&quot;Invalid or missing mimetype&quot;</span> errors)))</span>
<span id="cb152-55"><a href="#cb152-55" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-56"><a href="#cb152-56" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Validate container.xml</span></span>
<span id="cb152-57"><a href="#cb152-57" aria-hidden="true" tabindex="-1"></a>      (unless (validate-container temp-dir)</span>
<span id="cb152-58"><a href="#cb152-58" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">set!</span> errors (<span class="kw">cons</span> <span class="st">&quot;Invalid container.xml&quot;</span> errors)))</span>
<span id="cb152-59"><a href="#cb152-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-60"><a href="#cb152-60" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Validate content.opf</span></span>
<span id="cb152-61"><a href="#cb152-61" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> opf-errors </span>(validate-package-document temp-dir))</span>
<span id="cb152-62"><a href="#cb152-62" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">set!</span> errors (<span class="kw">append</span> opf-errors errors))</span>
<span id="cb152-63"><a href="#cb152-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-64"><a href="#cb152-64" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Check all referenced files exist</span></span>
<span id="cb152-65"><a href="#cb152-65" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> missing </span>(check-referenced-files temp-dir))</span>
<span id="cb152-66"><a href="#cb152-66" aria-hidden="true" tabindex="-1"></a>      (when (<span class="kw">not</span> (<span class="kw">null?</span> missing))</span>
<span id="cb152-67"><a href="#cb152-67" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">set!</span> errors (<span class="kw">cons</span> (format <span class="st">&quot;Missing files: ~a&quot;</span> missing) errors)))</span>
<span id="cb152-68"><a href="#cb152-68" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-69"><a href="#cb152-69" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Validate XHTML files</span></span>
<span id="cb152-70"><a href="#cb152-70" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> xhtml-errors </span>(validate-all-xhtml temp-dir))</span>
<span id="cb152-71"><a href="#cb152-71" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">set!</span> errors (<span class="kw">append</span> xhtml-errors errors))))</span>
<span id="cb152-72"><a href="#cb152-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb152-73"><a href="#cb152-73" aria-hidden="true" tabindex="-1"></a>  (validation-result errors warnings))</span>
<span id="cb152-74"><a href="#cb152-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-75"><a href="#cb152-75" aria-hidden="true" tabindex="-1"></a><span class="co">;; Check EPUB mimetype</span></span>
<span id="cb152-76"><a href="#cb152-76" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(check-mimetype temp-dir)</span>
<span id="cb152-77"><a href="#cb152-77" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> mimetype-path </span>(build-path temp-dir <span class="st">&quot;mimetype&quot;</span>))</span>
<span id="cb152-78"><a href="#cb152-78" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">and</span> (<span class="kw">file-exists?</span> mimetype-path)</span>
<span id="cb152-79"><a href="#cb152-79" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">equal?</span> (file-&gt;string mimetype-path) <span class="st">&quot;application/epub+zip&quot;</span>)))</span>
<span id="cb152-80"><a href="#cb152-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-81"><a href="#cb152-81" aria-hidden="true" tabindex="-1"></a><span class="co">;; Validate container.xml</span></span>
<span id="cb152-82"><a href="#cb152-82" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(validate-container temp-dir)</span>
<span id="cb152-83"><a href="#cb152-83" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> container-path </span></span>
<span id="cb152-84"><a href="#cb152-84" aria-hidden="true" tabindex="-1"></a>    (build-path temp-dir <span class="st">&quot;META-INF&quot;</span> <span class="st">&quot;container.xml&quot;</span>))</span>
<span id="cb152-85"><a href="#cb152-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb152-86"><a href="#cb152-86" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">and</span> (<span class="kw">file-exists?</span> container-path)</span>
<span id="cb152-87"><a href="#cb152-87" aria-hidden="true" tabindex="-1"></a>       (valid-xml? container-path)</span>
<span id="cb152-88"><a href="#cb152-88" aria-hidden="true" tabindex="-1"></a>       (check-container-structure container-path)))</span>
<span id="cb152-89"><a href="#cb152-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-90"><a href="#cb152-90" aria-hidden="true" tabindex="-1"></a><span class="co">;; Integration with main generator</span></span>
<span id="cb152-91"><a href="#cb152-91" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-epub-with-validation doc output-path #:options <span class="op">[</span>options <span class="dv">#f</span><span class="op">]</span>)</span>
<span id="cb152-92"><a href="#cb152-92" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> epub-path </span>(generate-epub doc output-path #:options options))</span>
<span id="cb152-93"><a href="#cb152-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb152-94"><a href="#cb152-94" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Validate generated EPUB</span></span>
<span id="cb152-95"><a href="#cb152-95" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> validation </span>(validate-epub epub-path))</span>
<span id="cb152-96"><a href="#cb152-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb152-97"><a href="#cb152-97" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb152-98"><a href="#cb152-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">null?</span> (validation-result-errors validation))</span>
<span id="cb152-99"><a href="#cb152-99" aria-hidden="true" tabindex="-1"></a>     (printf <span class="st">&quot;EPUB generated successfully: ~a</span><span class="ch">\n</span><span class="st">&quot;</span> epub-path)</span>
<span id="cb152-100"><a href="#cb152-100" aria-hidden="true" tabindex="-1"></a>     epub-path<span class="op">]</span></span>
<span id="cb152-101"><a href="#cb152-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-102"><a href="#cb152-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb152-103"><a href="#cb152-103" aria-hidden="true" tabindex="-1"></a>     (printf <span class="st">&quot;EPUB validation errors:</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb152-104"><a href="#cb152-104" aria-hidden="true" tabindex="-1"></a>     (for (<span class="op">[</span><span class="kw">error</span> (validation-result-errors validation)<span class="op">]</span>)</span>
<span id="cb152-105"><a href="#cb152-105" aria-hidden="true" tabindex="-1"></a>       (printf <span class="st">&quot;  - ~a</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="kw">error</span>))</span>
<span id="cb152-106"><a href="#cb152-106" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">error</span> <span class="st">&quot;EPUB validation failed&quot;</span>)<span class="op">]</span>))</span></code></pre></div>
<h2 id="testing-epub-generation">Testing EPUB Generation</h2>
<p>Comprehensive tests ensure reliable EPUB output:</p>
<div class="sourceCode" id="cb153"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; epub-tests.rkt</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>(require rackunit</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;epub-generator.rkt&quot;</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;document-model.rkt&quot;</span>)</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> test-doc</span></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>  (document</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;Test Document&quot;</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span> (author <span class="st">&quot;Test Author&quot;</span> <span class="st">&quot;test@example.com&quot;</span>))</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>   (date <span class="dv">2024</span> <span class="dv">10</span> <span class="dv">1</span>)</span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>    (section <span class="dv">1</span> <span class="st">&quot;1&quot;</span> <span class="st">&quot;Introduction&quot;</span> </span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">list</span> (paragraph (<span class="kw">list</span> (text-run <span class="st">&quot;Test content&quot;</span>))))</span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;intro&quot;</span>))))</span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;EPUB generation&quot;</span></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> output-path </span>(make-temporary-file <span class="st">&quot;test-~a.epub&quot;</span>))</span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">dynamic-wind</span></span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a>    (λ () <span class="dv">#f</span>)</span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>    (λ ()</span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Generate EPUB</span></span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a>      (generate-epub test-doc output-path)</span>
<span id="cb153-26"><a href="#cb153-26" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb153-27"><a href="#cb153-27" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Verify it&#39;s a valid zip file</span></span>
<span id="cb153-28"><a href="#cb153-28" aria-hidden="true" tabindex="-1"></a>      (check-true (valid-zip? output-path))</span>
<span id="cb153-29"><a href="#cb153-29" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb153-30"><a href="#cb153-30" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Check internal structure</span></span>
<span id="cb153-31"><a href="#cb153-31" aria-hidden="true" tabindex="-1"></a>      (with-unzip output-path</span>
<span id="cb153-32"><a href="#cb153-32" aria-hidden="true" tabindex="-1"></a>        (λ (temp-dir)</span>
<span id="cb153-33"><a href="#cb153-33" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Check required files</span></span>
<span id="cb153-34"><a href="#cb153-34" aria-hidden="true" tabindex="-1"></a>          (check-true (<span class="kw">file-exists?</span> (build-path temp-dir <span class="st">&quot;mimetype&quot;</span>)))</span>
<span id="cb153-35"><a href="#cb153-35" aria-hidden="true" tabindex="-1"></a>          (check-true (<span class="kw">file-exists?</span> </span>
<span id="cb153-36"><a href="#cb153-36" aria-hidden="true" tabindex="-1"></a>                      (build-path temp-dir <span class="st">&quot;META-INF&quot;</span> <span class="st">&quot;container.xml&quot;</span>)))</span>
<span id="cb153-37"><a href="#cb153-37" aria-hidden="true" tabindex="-1"></a>          (check-true (<span class="kw">file-exists?</span> </span>
<span id="cb153-38"><a href="#cb153-38" aria-hidden="true" tabindex="-1"></a>                      (build-path temp-dir <span class="st">&quot;OEBPS&quot;</span> <span class="st">&quot;content.opf&quot;</span>)))</span>
<span id="cb153-39"><a href="#cb153-39" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb153-40"><a href="#cb153-40" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Validate structure</span></span>
<span id="cb153-41"><a href="#cb153-41" aria-hidden="true" tabindex="-1"></a>          (<span class="ex">define</span><span class="fu"> validation </span>(validate-epub output-path))</span>
<span id="cb153-42"><a href="#cb153-42" aria-hidden="true" tabindex="-1"></a>          (check-equal? (validation-result-errors validation) &#39;()))))</span>
<span id="cb153-43"><a href="#cb153-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-44"><a href="#cb153-44" aria-hidden="true" tabindex="-1"></a>    (λ ()</span>
<span id="cb153-45"><a href="#cb153-45" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Cleanup</span></span>
<span id="cb153-46"><a href="#cb153-46" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">delete-file</span> output-path))))</span>
<span id="cb153-47"><a href="#cb153-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-48"><a href="#cb153-48" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;EPUB 3 features&quot;</span></span>
<span id="cb153-49"><a href="#cb153-49" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> options </span>(epub-options &#39;<span class="fl">3.0</span> <span class="dv">#f</span> <span class="dv">#f</span> &#39;() <span class="dv">2</span> <span class="dv">3</span> &#39;() <span class="dv">#t</span>))</span>
<span id="cb153-50"><a href="#cb153-50" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> output-path </span>(make-temporary-file <span class="st">&quot;test-epub3-~a.epub&quot;</span>))</span>
<span id="cb153-51"><a href="#cb153-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-52"><a href="#cb153-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Test EPUB 3 specific features</span></span>
<span id="cb153-53"><a href="#cb153-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; ... additional tests ...</span></span>
<span id="cb153-54"><a href="#cb153-54" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>The EPUB generation pipeline demonstrates how to create
standards-compliant electronic books that provide an excellent reading
experience across diverse devices. By carefully handling content
splitting, navigation generation, and resource management, we ensure our
EPUBs work well on everything from dedicated e-readers to
smartphones.</p>
<h2 id="exercises-4">Exercises</h2>
<ol type="1">
<li><p><strong>Implement fixed-layout EPUB</strong>: Extend the
generator to support fixed-layout EPUBs for content that requires
precise positioning.</p></li>
<li><p><strong>Add media overlay support</strong>: Implement EPUB 3
media overlays for synchronized audio narration.</p></li>
<li><p><strong>Create an EPUB preview system</strong>: Build a web-based
EPUB previewer that shows how content will appear on different
devices.</p></li>
<li><p><strong>Optimize image handling</strong>: Implement automatic
image optimization with format conversion and resolution adjustment
based on target devices. # Chapter 10: Site Structure and
Organization</p></li>
</ol>
<h2 id="the-architecture-of-knowledge">The Architecture of
Knowledge</h2>
<p>A static site generator must do more than convert documents—it must
organize knowledge into a coherent, navigable structure. The way we
organize content profoundly affects how users discover, understand, and
engage with information. This chapter explores how Shrdlu creates
sophisticated site architectures that scale from simple blogs to complex
documentation systems.</p>
<h2 id="site-configuration-and-project-structure">Site Configuration and
Project Structure</h2>
<p>At the heart of every Shrdlu project lies a configuration that
defines not just what to build, but how to organize it:</p>
<div class="sourceCode" id="cb154"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; site-config.rkt</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>(require racket/contract</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;file-utils.rkt&quot;</span>)</span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>(provide site-config</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>         site-config?</span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>         load-site-config</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>         default-site-config)</span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a><span class="co">;; Site configuration structure</span></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>(struct site-config</span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>  (title           <span class="co">; Site title</span></span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>   base-url        <span class="co">; Base URL for absolute links</span></span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>   author          <span class="co">; Default author</span></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>   description     <span class="co">; Site description</span></span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>   language        <span class="co">; Primary language (ISO code)</span></span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a>   input-dir       <span class="co">; Source directory</span></span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a>   output-dir      <span class="co">; Build directory</span></span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a>   assets-dir      <span class="co">; Static assets directory</span></span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>   templates-dir   <span class="co">; Template directory</span></span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Content organization</span></span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a>   content-map     <span class="co">; Content type -&gt; directory mapping</span></span>
<span id="cb154-27"><a href="#cb154-27" aria-hidden="true" tabindex="-1"></a>   url-scheme      <span class="co">; URL generation scheme</span></span>
<span id="cb154-28"><a href="#cb154-28" aria-hidden="true" tabindex="-1"></a>   index-pages     <span class="co">; Auto-generated index pages</span></span>
<span id="cb154-29"><a href="#cb154-29" aria-hidden="true" tabindex="-1"></a>   taxonomies      <span class="co">; Categories, tags, etc.</span></span>
<span id="cb154-30"><a href="#cb154-30" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb154-31"><a href="#cb154-31" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Build options</span></span>
<span id="cb154-32"><a href="#cb154-32" aria-hidden="true" tabindex="-1"></a>   formats         <span class="co">; Output formats (html, pdf, epub)</span></span>
<span id="cb154-33"><a href="#cb154-33" aria-hidden="true" tabindex="-1"></a>   plugins         <span class="co">; Active plugins</span></span>
<span id="cb154-34"><a href="#cb154-34" aria-hidden="true" tabindex="-1"></a>   preprocessors   <span class="co">; Document preprocessors</span></span>
<span id="cb154-35"><a href="#cb154-35" aria-hidden="true" tabindex="-1"></a>   postprocessors  <span class="co">; Output postprocessors</span></span>
<span id="cb154-36"><a href="#cb154-36" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb154-37"><a href="#cb154-37" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Advanced options</span></span>
<span id="cb154-38"><a href="#cb154-38" aria-hidden="true" tabindex="-1"></a>   collections     <span class="co">; Document collections</span></span>
<span id="cb154-39"><a href="#cb154-39" aria-hidden="true" tabindex="-1"></a>   navigation      <span class="co">; Navigation structure</span></span>
<span id="cb154-40"><a href="#cb154-40" aria-hidden="true" tabindex="-1"></a>   redirects       <span class="co">; URL redirects</span></span>
<span id="cb154-41"><a href="#cb154-41" aria-hidden="true" tabindex="-1"></a>   aliases)        <span class="co">; URL aliases</span></span>
<span id="cb154-42"><a href="#cb154-42" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb154-43"><a href="#cb154-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-44"><a href="#cb154-44" aria-hidden="true" tabindex="-1"></a><span class="co">;; Load configuration from file</span></span>
<span id="cb154-45"><a href="#cb154-45" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(load-site-config path)</span>
<span id="cb154-46"><a href="#cb154-46" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> config-data</span></span>
<span id="cb154-47"><a href="#cb154-47" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">with-input-from-file</span> path</span>
<span id="cb154-48"><a href="#cb154-48" aria-hidden="true" tabindex="-1"></a>      (λ () (<span class="kw">read</span>))))</span>
<span id="cb154-49"><a href="#cb154-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-50"><a href="#cb154-50" aria-hidden="true" tabindex="-1"></a>  (parse-config-data config-data))</span>
<span id="cb154-51"><a href="#cb154-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-52"><a href="#cb154-52" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parse configuration s-expression</span></span>
<span id="cb154-53"><a href="#cb154-53" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(parse-config-data data)</span>
<span id="cb154-54"><a href="#cb154-54" aria-hidden="true" tabindex="-1"></a>  (match data</span>
<span id="cb154-55"><a href="#cb154-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>`(site-config</span>
<span id="cb154-56"><a href="#cb154-56" aria-hidden="true" tabindex="-1"></a>       ,@settings)</span>
<span id="cb154-57"><a href="#cb154-57" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> config-table </span>(make-hash))</span>
<span id="cb154-58"><a href="#cb154-58" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb154-59"><a href="#cb154-59" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Process each setting</span></span>
<span id="cb154-60"><a href="#cb154-60" aria-hidden="true" tabindex="-1"></a>     (for (<span class="op">[</span>setting settings<span class="op">]</span>)</span>
<span id="cb154-61"><a href="#cb154-61" aria-hidden="true" tabindex="-1"></a>       (match setting</span>
<span id="cb154-62"><a href="#cb154-62" aria-hidden="true" tabindex="-1"></a>         <span class="op">[</span>`(,key ,value)</span>
<span id="cb154-63"><a href="#cb154-63" aria-hidden="true" tabindex="-1"></a>          (hash-set! config-table key (process-config-value key value))<span class="op">]</span></span>
<span id="cb154-64"><a href="#cb154-64" aria-hidden="true" tabindex="-1"></a>         <span class="op">[</span><span class="kw">else</span></span>
<span id="cb154-65"><a href="#cb154-65" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">error</span> &#39;parse-config <span class="st">&quot;Invalid setting format&quot;</span> setting)<span class="op">]</span>))</span>
<span id="cb154-66"><a href="#cb154-66" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb154-67"><a href="#cb154-67" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Build configuration struct</span></span>
<span id="cb154-68"><a href="#cb154-68" aria-hidden="true" tabindex="-1"></a>     (site-config</span>
<span id="cb154-69"><a href="#cb154-69" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;title <span class="st">&quot;My Site&quot;</span>)</span>
<span id="cb154-70"><a href="#cb154-70" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;base-url <span class="st">&quot;&quot;</span>)</span>
<span id="cb154-71"><a href="#cb154-71" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;author (author <span class="st">&quot;Anonymous&quot;</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb154-72"><a href="#cb154-72" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;description <span class="st">&quot;&quot;</span>)</span>
<span id="cb154-73"><a href="#cb154-73" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;language <span class="st">&quot;en&quot;</span>)</span>
<span id="cb154-74"><a href="#cb154-74" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;input-dir <span class="st">&quot;content&quot;</span>)</span>
<span id="cb154-75"><a href="#cb154-75" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;output-dir <span class="st">&quot;public&quot;</span>)</span>
<span id="cb154-76"><a href="#cb154-76" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;assets-dir <span class="st">&quot;assets&quot;</span>)</span>
<span id="cb154-77"><a href="#cb154-77" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;templates-dir <span class="st">&quot;templates&quot;</span>)</span>
<span id="cb154-78"><a href="#cb154-78" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb154-79"><a href="#cb154-79" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Content organization</span></span>
<span id="cb154-80"><a href="#cb154-80" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;content-map (default-content-map))</span>
<span id="cb154-81"><a href="#cb154-81" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;url-scheme &#39;hierarchical)</span>
<span id="cb154-82"><a href="#cb154-82" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;index-pages &#39;())</span>
<span id="cb154-83"><a href="#cb154-83" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;taxonomies &#39;())</span>
<span id="cb154-84"><a href="#cb154-84" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb154-85"><a href="#cb154-85" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Build options</span></span>
<span id="cb154-86"><a href="#cb154-86" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;formats &#39;(html))</span>
<span id="cb154-87"><a href="#cb154-87" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;plugins &#39;())</span>
<span id="cb154-88"><a href="#cb154-88" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;preprocessors &#39;())</span>
<span id="cb154-89"><a href="#cb154-89" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;postprocessors &#39;())</span>
<span id="cb154-90"><a href="#cb154-90" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb154-91"><a href="#cb154-91" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Advanced</span></span>
<span id="cb154-92"><a href="#cb154-92" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;collections &#39;())</span>
<span id="cb154-93"><a href="#cb154-93" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;navigation <span class="dv">#f</span>)</span>
<span id="cb154-94"><a href="#cb154-94" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;redirects &#39;())</span>
<span id="cb154-95"><a href="#cb154-95" aria-hidden="true" tabindex="-1"></a>      (hash-ref config-table &#39;aliases &#39;()))<span class="op">]</span>))</span>
<span id="cb154-96"><a href="#cb154-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-97"><a href="#cb154-97" aria-hidden="true" tabindex="-1"></a><span class="co">;; Default content type mapping</span></span>
<span id="cb154-98"><a href="#cb154-98" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(default-content-map)</span>
<span id="cb154-99"><a href="#cb154-99" aria-hidden="true" tabindex="-1"></a>  (hash &#39;post <span class="st">&quot;posts&quot;</span></span>
<span id="cb154-100"><a href="#cb154-100" aria-hidden="true" tabindex="-1"></a>        &#39;page <span class="st">&quot;pages&quot;</span></span>
<span id="cb154-101"><a href="#cb154-101" aria-hidden="true" tabindex="-1"></a>        &#39;documentation <span class="st">&quot;docs&quot;</span></span>
<span id="cb154-102"><a href="#cb154-102" aria-hidden="true" tabindex="-1"></a>        &#39;tutorial <span class="st">&quot;tutorials&quot;</span></span>
<span id="cb154-103"><a href="#cb154-103" aria-hidden="true" tabindex="-1"></a>        &#39;reference <span class="st">&quot;reference&quot;</span>))</span>
<span id="cb154-104"><a href="#cb154-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-105"><a href="#cb154-105" aria-hidden="true" tabindex="-1"></a><span class="co">;; Process configuration values</span></span>
<span id="cb154-106"><a href="#cb154-106" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(process-config-value key value)</span>
<span id="cb154-107"><a href="#cb154-107" aria-hidden="true" tabindex="-1"></a>  (match key</span>
<span id="cb154-108"><a href="#cb154-108" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;author</span>
<span id="cb154-109"><a href="#cb154-109" aria-hidden="true" tabindex="-1"></a>     (match value</span>
<span id="cb154-110"><a href="#cb154-110" aria-hidden="true" tabindex="-1"></a>       <span class="op">[</span>`(,name ,email) (author name email)<span class="op">]</span></span>
<span id="cb154-111"><a href="#cb154-111" aria-hidden="true" tabindex="-1"></a>       <span class="op">[</span>name (author name <span class="st">&quot;&quot;</span>)<span class="op">]</span>)<span class="op">]</span></span>
<span id="cb154-112"><a href="#cb154-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-113"><a href="#cb154-113" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;content-map</span>
<span id="cb154-114"><a href="#cb154-114" aria-hidden="true" tabindex="-1"></a>     (apply hash (flatten value))<span class="op">]</span></span>
<span id="cb154-115"><a href="#cb154-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-116"><a href="#cb154-116" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;formats</span>
<span id="cb154-117"><a href="#cb154-117" aria-hidden="true" tabindex="-1"></a>     (map <span class="kw">string-&gt;symbol</span> value)<span class="op">]</span></span>
<span id="cb154-118"><a href="#cb154-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-119"><a href="#cb154-119" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;taxonomies</span>
<span id="cb154-120"><a href="#cb154-120" aria-hidden="true" tabindex="-1"></a>     (map parse-taxonomy value)<span class="op">]</span></span>
<span id="cb154-121"><a href="#cb154-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-122"><a href="#cb154-122" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;collections</span>
<span id="cb154-123"><a href="#cb154-123" aria-hidden="true" tabindex="-1"></a>     (map parse-collection value)<span class="op">]</span></span>
<span id="cb154-124"><a href="#cb154-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-125"><a href="#cb154-125" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> value<span class="op">]</span>))</span></code></pre></div>
<h2 id="content-organization-and-collections">Content Organization and
Collections</h2>
<p>Shrdlu supports sophisticated content collections that go beyond
simple directory structures:</p>
<div class="sourceCode" id="cb155"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; collections.rkt</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;frontmatter.rkt&quot;</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;file-utils.rkt&quot;</span>)</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>(provide collection</span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>         collection?</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>         define-collection</span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>         build-collection</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>         query-collection)</span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; Collection definition</span></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>(struct collection</span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a>  (name           <span class="co">; Collection identifier</span></span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a>   source         <span class="co">; Source pattern or directory</span></span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a>   <span class="kw">filter</span>         <span class="co">; Document filter predicate</span></span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>   sort           <span class="co">; Sort function</span></span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a>   metadata       <span class="co">; Default metadata</span></span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a>   url-pattern    <span class="co">; URL generation pattern</span></span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>   index          <span class="co">; Index page configuration</span></span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a>   paginate)      <span class="co">; Pagination settings</span></span>
<span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb155-25"><a href="#cb155-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-26"><a href="#cb155-26" aria-hidden="true" tabindex="-1"></a><span class="co">;; Define a document collection</span></span>
<span id="cb155-27"><a href="#cb155-27" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(define-collection name #:source source</span>
<span id="cb155-28"><a href="#cb155-28" aria-hidden="true" tabindex="-1"></a>                          #:filter <span class="op">[</span><span class="kw">filter</span> (λ (doc) <span class="dv">#t</span>)<span class="op">]</span></span>
<span id="cb155-29"><a href="#cb155-29" aria-hidden="true" tabindex="-1"></a>                          #:sort <span class="op">[</span>sort <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb155-30"><a href="#cb155-30" aria-hidden="true" tabindex="-1"></a>                          #:metadata <span class="op">[</span>metadata &#39;()<span class="op">]</span></span>
<span id="cb155-31"><a href="#cb155-31" aria-hidden="true" tabindex="-1"></a>                          #:url-pattern <span class="op">[</span>url-pattern <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb155-32"><a href="#cb155-32" aria-hidden="true" tabindex="-1"></a>                          #:index <span class="op">[</span>index <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb155-33"><a href="#cb155-33" aria-hidden="true" tabindex="-1"></a>                          #:paginate <span class="op">[</span>paginate <span class="dv">#f</span><span class="op">]</span>)</span>
<span id="cb155-34"><a href="#cb155-34" aria-hidden="true" tabindex="-1"></a>  (collection name source <span class="kw">filter</span> sort metadata url-pattern index paginate))</span>
<span id="cb155-35"><a href="#cb155-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-36"><a href="#cb155-36" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build collection from filesystem</span></span>
<span id="cb155-37"><a href="#cb155-37" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-collection config coll)</span>
<span id="cb155-38"><a href="#cb155-38" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> source-path </span></span>
<span id="cb155-39"><a href="#cb155-39" aria-hidden="true" tabindex="-1"></a>    (build-path (site-config-input-dir config)</span>
<span id="cb155-40"><a href="#cb155-40" aria-hidden="true" tabindex="-1"></a>                (collection-source coll)))</span>
<span id="cb155-41"><a href="#cb155-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-42"><a href="#cb155-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Find all documents</span></span>
<span id="cb155-43"><a href="#cb155-43" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> doc-files</span></span>
<span id="cb155-44"><a href="#cb155-44" aria-hidden="true" tabindex="-1"></a>    (find-files-matching source-path <span class="st">&quot;*.md&quot;</span>))</span>
<span id="cb155-45"><a href="#cb155-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-46"><a href="#cb155-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Load and process documents</span></span>
<span id="cb155-47"><a href="#cb155-47" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> docs</span></span>
<span id="cb155-48"><a href="#cb155-48" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>file doc-files<span class="op">]</span>)</span>
<span id="cb155-49"><a href="#cb155-49" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> doc </span>(load-document file))</span>
<span id="cb155-50"><a href="#cb155-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb155-51"><a href="#cb155-51" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Apply collection metadata</span></span>
<span id="cb155-52"><a href="#cb155-52" aria-hidden="true" tabindex="-1"></a>      (merge-document-metadata doc (collection-metadata coll))))</span>
<span id="cb155-53"><a href="#cb155-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-54"><a href="#cb155-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Filter documents</span></span>
<span id="cb155-55"><a href="#cb155-55" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> filtered-docs</span></span>
<span id="cb155-56"><a href="#cb155-56" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">filter</span> (collection-filter coll) docs))</span>
<span id="cb155-57"><a href="#cb155-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-58"><a href="#cb155-58" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Sort if specified</span></span>
<span id="cb155-59"><a href="#cb155-59" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> sorted-docs</span></span>
<span id="cb155-60"><a href="#cb155-60" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (collection-sort coll)</span>
<span id="cb155-61"><a href="#cb155-61" aria-hidden="true" tabindex="-1"></a>        (sort filtered-docs (collection-sort coll))</span>
<span id="cb155-62"><a href="#cb155-62" aria-hidden="true" tabindex="-1"></a>        filtered-docs))</span>
<span id="cb155-63"><a href="#cb155-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-64"><a href="#cb155-64" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate collection structure</span></span>
<span id="cb155-65"><a href="#cb155-65" aria-hidden="true" tabindex="-1"></a>  (collection-result</span>
<span id="cb155-66"><a href="#cb155-66" aria-hidden="true" tabindex="-1"></a>   (collection-name coll)</span>
<span id="cb155-67"><a href="#cb155-67" aria-hidden="true" tabindex="-1"></a>   sorted-docs</span>
<span id="cb155-68"><a href="#cb155-68" aria-hidden="true" tabindex="-1"></a>   (generate-collection-index coll sorted-docs)</span>
<span id="cb155-69"><a href="#cb155-69" aria-hidden="true" tabindex="-1"></a>   (generate-collection-pages coll sorted-docs)))</span>
<span id="cb155-70"><a href="#cb155-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-71"><a href="#cb155-71" aria-hidden="true" tabindex="-1"></a><span class="co">;; Collection querying</span></span>
<span id="cb155-72"><a href="#cb155-72" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(query-collection coll-result #:limit <span class="op">[</span>limit <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb155-73"><a href="#cb155-73" aria-hidden="true" tabindex="-1"></a>                         #:offset <span class="op">[</span>offset <span class="dv">0</span><span class="op">]</span></span>
<span id="cb155-74"><a href="#cb155-74" aria-hidden="true" tabindex="-1"></a>                         #:where <span class="op">[</span>predicate <span class="dv">#f</span><span class="op">]</span>)</span>
<span id="cb155-75"><a href="#cb155-75" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> docs </span>(collection-result-documents coll-result))</span>
<span id="cb155-76"><a href="#cb155-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-77"><a href="#cb155-77" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Apply predicate filter</span></span>
<span id="cb155-78"><a href="#cb155-78" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> filtered</span></span>
<span id="cb155-79"><a href="#cb155-79" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> predicate</span>
<span id="cb155-80"><a href="#cb155-80" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">filter</span> predicate docs)</span>
<span id="cb155-81"><a href="#cb155-81" aria-hidden="true" tabindex="-1"></a>        docs))</span>
<span id="cb155-82"><a href="#cb155-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-83"><a href="#cb155-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Apply pagination</span></span>
<span id="cb155-84"><a href="#cb155-84" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> start </span>offset)</span>
<span id="cb155-85"><a href="#cb155-85" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> end </span>(<span class="kw">if</span> limit (<span class="op">+</span> offset limit) (<span class="kw">length</span> filtered)))</span>
<span id="cb155-86"><a href="#cb155-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-87"><a href="#cb155-87" aria-hidden="true" tabindex="-1"></a>  (sublist filtered start end))</span>
<span id="cb155-88"><a href="#cb155-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-89"><a href="#cb155-89" aria-hidden="true" tabindex="-1"></a><span class="co">;; Common collection definitions</span></span>
<span id="cb155-90"><a href="#cb155-90" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> blog-posts</span></span>
<span id="cb155-91"><a href="#cb155-91" aria-hidden="true" tabindex="-1"></a>  (define-collection &#39;blog-posts</span>
<span id="cb155-92"><a href="#cb155-92" aria-hidden="true" tabindex="-1"></a>    #:source <span class="st">&quot;posts&quot;</span></span>
<span id="cb155-93"><a href="#cb155-93" aria-hidden="true" tabindex="-1"></a>    #:filter (λ (doc) (document-metadata-ref doc &#39;published <span class="dv">#t</span>))</span>
<span id="cb155-94"><a href="#cb155-94" aria-hidden="true" tabindex="-1"></a>    #:sort (λ (a b)</span>
<span id="cb155-95"><a href="#cb155-95" aria-hidden="true" tabindex="-1"></a>            (date&gt;? (document-metadata-ref a &#39;date)</span>
<span id="cb155-96"><a href="#cb155-96" aria-hidden="true" tabindex="-1"></a>                    (document-metadata-ref b &#39;date)))</span>
<span id="cb155-97"><a href="#cb155-97" aria-hidden="true" tabindex="-1"></a>    #:url-pattern <span class="st">&quot;/blog/{year}/{month}/{slug}&quot;</span></span>
<span id="cb155-98"><a href="#cb155-98" aria-hidden="true" tabindex="-1"></a>    #:index &#39;((template <span class="op">.</span> <span class="st">&quot;blog-index.html&quot;</span>)</span>
<span id="cb155-99"><a href="#cb155-99" aria-hidden="true" tabindex="-1"></a>             (title <span class="op">.</span> <span class="st">&quot;Blog&quot;</span>))</span>
<span id="cb155-100"><a href="#cb155-100" aria-hidden="true" tabindex="-1"></a>    #:paginate &#39;((per-page <span class="op">.</span> <span class="dv">10</span>)</span>
<span id="cb155-101"><a href="#cb155-101" aria-hidden="true" tabindex="-1"></a>                (path-pattern <span class="op">.</span> <span class="st">&quot;/blog/page/{page}&quot;</span>))))</span>
<span id="cb155-102"><a href="#cb155-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-103"><a href="#cb155-103" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> documentation</span></span>
<span id="cb155-104"><a href="#cb155-104" aria-hidden="true" tabindex="-1"></a>  (define-collection &#39;documentation</span>
<span id="cb155-105"><a href="#cb155-105" aria-hidden="true" tabindex="-1"></a>    #:source <span class="st">&quot;docs&quot;</span></span>
<span id="cb155-106"><a href="#cb155-106" aria-hidden="true" tabindex="-1"></a>    #:filter (λ (doc) <span class="dv">#t</span>)</span>
<span id="cb155-107"><a href="#cb155-107" aria-hidden="true" tabindex="-1"></a>    #:sort (λ (a b)</span>
<span id="cb155-108"><a href="#cb155-108" aria-hidden="true" tabindex="-1"></a>            (version&lt;? (document-metadata-ref a &#39;version <span class="st">&quot;0&quot;</span>)</span>
<span id="cb155-109"><a href="#cb155-109" aria-hidden="true" tabindex="-1"></a>                       (document-metadata-ref b &#39;version <span class="st">&quot;0&quot;</span>)))</span>
<span id="cb155-110"><a href="#cb155-110" aria-hidden="true" tabindex="-1"></a>    #:url-pattern <span class="st">&quot;/docs/{version}/{path}&quot;</span></span>
<span id="cb155-111"><a href="#cb155-111" aria-hidden="true" tabindex="-1"></a>    #:index &#39;((template <span class="op">.</span> <span class="st">&quot;docs-index.html&quot;</span>)</span>
<span id="cb155-112"><a href="#cb155-112" aria-hidden="true" tabindex="-1"></a>             (title <span class="op">.</span> <span class="st">&quot;Documentation&quot;</span>))))</span></code></pre></div>
<h2 id="navigation-generation">Navigation Generation</h2>
<p>Sophisticated sites require intelligent navigation structures:</p>
<div class="sourceCode" id="cb156"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; navigation.rkt</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;collections.rkt&quot;</span>)</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>(provide navigation-tree</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>         navigation-node</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>         build-navigation</span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>         render-navigation)</span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Navigation tree structure</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>(struct navigation-node</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>  (title          <span class="co">; Display title</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>   url            <span class="co">; Target URL</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>   active?        <span class="co">; Currently active?</span></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>   children       <span class="co">; Child nodes</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>   metadata)      <span class="co">; Additional data</span></span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>(struct navigation-tree</span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>  (root           <span class="co">; Root node</span></span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>   current-path   <span class="co">; Current page path</span></span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>   depth-limit)   <span class="co">; Maximum depth</span></span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build navigation from site structure</span></span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-navigation config docs current-path)</span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> nav-config </span>(site-config-navigation config))</span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb156-32"><a href="#cb156-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Explicit navigation configuration</span></span>
<span id="cb156-33"><a href="#cb156-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>nav-config</span>
<span id="cb156-34"><a href="#cb156-34" aria-hidden="true" tabindex="-1"></a>     (build-configured-navigation nav-config docs current-path)<span class="op">]</span></span>
<span id="cb156-35"><a href="#cb156-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-36"><a href="#cb156-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Auto-generate from content structure</span></span>
<span id="cb156-37"><a href="#cb156-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb156-38"><a href="#cb156-38" aria-hidden="true" tabindex="-1"></a>     (build-auto-navigation config docs current-path)<span class="op">]</span>))</span>
<span id="cb156-39"><a href="#cb156-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-40"><a href="#cb156-40" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build from explicit configuration</span></span>
<span id="cb156-41"><a href="#cb156-41" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-configured-navigation nav-config docs current-path)</span>
<span id="cb156-42"><a href="#cb156-42" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(process-nav-item item)</span>
<span id="cb156-43"><a href="#cb156-43" aria-hidden="true" tabindex="-1"></a>    (match item</span>
<span id="cb156-44"><a href="#cb156-44" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Simple link</span></span>
<span id="cb156-45"><a href="#cb156-45" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>`(,title ,url)</span>
<span id="cb156-46"><a href="#cb156-46" aria-hidden="true" tabindex="-1"></a>       (navigation-node title url </span>
<span id="cb156-47"><a href="#cb156-47" aria-hidden="true" tabindex="-1"></a>                       (path-active? url current-path)</span>
<span id="cb156-48"><a href="#cb156-48" aria-hidden="true" tabindex="-1"></a>                       &#39;()</span>
<span id="cb156-49"><a href="#cb156-49" aria-hidden="true" tabindex="-1"></a>                       &#39;())<span class="op">]</span></span>
<span id="cb156-50"><a href="#cb156-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-51"><a href="#cb156-51" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Link with children</span></span>
<span id="cb156-52"><a href="#cb156-52" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>`(,title ,url ,children <span class="op">...</span>)</span>
<span id="cb156-53"><a href="#cb156-53" aria-hidden="true" tabindex="-1"></a>       (navigation-node title url</span>
<span id="cb156-54"><a href="#cb156-54" aria-hidden="true" tabindex="-1"></a>                       (path-active? url current-path)</span>
<span id="cb156-55"><a href="#cb156-55" aria-hidden="true" tabindex="-1"></a>                       (map process-nav-item children)</span>
<span id="cb156-56"><a href="#cb156-56" aria-hidden="true" tabindex="-1"></a>                       &#39;())<span class="op">]</span></span>
<span id="cb156-57"><a href="#cb156-57" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-58"><a href="#cb156-58" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Dynamic collection</span></span>
<span id="cb156-59"><a href="#cb156-59" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>`(collection ,name ,@options)</span>
<span id="cb156-60"><a href="#cb156-60" aria-hidden="true" tabindex="-1"></a>       (build-collection-nav name docs options)<span class="op">]</span></span>
<span id="cb156-61"><a href="#cb156-61" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-62"><a href="#cb156-62" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Separator</span></span>
<span id="cb156-63"><a href="#cb156-63" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>&#39;separator</span>
<span id="cb156-64"><a href="#cb156-64" aria-hidden="true" tabindex="-1"></a>       (navigation-node <span class="dv">#f</span> <span class="dv">#f</span> <span class="dv">#f</span> &#39;() &#39;((type <span class="op">.</span> separator)))<span class="op">]</span>))</span>
<span id="cb156-65"><a href="#cb156-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-66"><a href="#cb156-66" aria-hidden="true" tabindex="-1"></a>  (navigation-tree</span>
<span id="cb156-67"><a href="#cb156-67" aria-hidden="true" tabindex="-1"></a>   (navigation-node <span class="st">&quot;Site&quot;</span> <span class="st">&quot;/&quot;</span></span>
<span id="cb156-68"><a href="#cb156-68" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">equal?</span> <span class="st">&quot;/&quot;</span> current-path)</span>
<span id="cb156-69"><a href="#cb156-69" aria-hidden="true" tabindex="-1"></a>                   (map process-nav-item nav-config)</span>
<span id="cb156-70"><a href="#cb156-70" aria-hidden="true" tabindex="-1"></a>                   &#39;())</span>
<span id="cb156-71"><a href="#cb156-71" aria-hidden="true" tabindex="-1"></a>   current-path</span>
<span id="cb156-72"><a href="#cb156-72" aria-hidden="true" tabindex="-1"></a>   <span class="dv">3</span>))</span>
<span id="cb156-73"><a href="#cb156-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-74"><a href="#cb156-74" aria-hidden="true" tabindex="-1"></a><span class="co">;; Auto-generate navigation</span></span>
<span id="cb156-75"><a href="#cb156-75" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-auto-navigation config docs current-path)</span>
<span id="cb156-76"><a href="#cb156-76" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> content-tree </span>(organize-content-tree docs))</span>
<span id="cb156-77"><a href="#cb156-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-78"><a href="#cb156-78" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(tree-&gt;nav tree path-prefix)</span>
<span id="cb156-79"><a href="#cb156-79" aria-hidden="true" tabindex="-1"></a>    (match tree</span>
<span id="cb156-80"><a href="#cb156-80" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(content-node name path doc children)</span>
<span id="cb156-81"><a href="#cb156-81" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> full-path </span>(<span class="kw">string-append</span> path-prefix <span class="st">&quot;/&quot;</span> path))</span>
<span id="cb156-82"><a href="#cb156-82" aria-hidden="true" tabindex="-1"></a>       (navigation-node</span>
<span id="cb156-83"><a href="#cb156-83" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">or</span> (document-title doc) name)</span>
<span id="cb156-84"><a href="#cb156-84" aria-hidden="true" tabindex="-1"></a>        full-path</span>
<span id="cb156-85"><a href="#cb156-85" aria-hidden="true" tabindex="-1"></a>        (path-active? full-path current-path)</span>
<span id="cb156-86"><a href="#cb156-86" aria-hidden="true" tabindex="-1"></a>        (map (λ (child) (tree-&gt;nav child full-path)) children)</span>
<span id="cb156-87"><a href="#cb156-87" aria-hidden="true" tabindex="-1"></a>        `((document <span class="op">.</span> ,doc)))<span class="op">]</span></span>
<span id="cb156-88"><a href="#cb156-88" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-89"><a href="#cb156-89" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(content-dir name children)</span>
<span id="cb156-90"><a href="#cb156-90" aria-hidden="true" tabindex="-1"></a>       (navigation-node</span>
<span id="cb156-91"><a href="#cb156-91" aria-hidden="true" tabindex="-1"></a>        (titleize name)</span>
<span id="cb156-92"><a href="#cb156-92" aria-hidden="true" tabindex="-1"></a>        <span class="dv">#f</span></span>
<span id="cb156-93"><a href="#cb156-93" aria-hidden="true" tabindex="-1"></a>        <span class="dv">#f</span></span>
<span id="cb156-94"><a href="#cb156-94" aria-hidden="true" tabindex="-1"></a>        (map (λ (child) (tree-&gt;nav child path-prefix)) children)</span>
<span id="cb156-95"><a href="#cb156-95" aria-hidden="true" tabindex="-1"></a>        &#39;((type <span class="op">.</span> directory)))<span class="op">]</span>))</span>
<span id="cb156-96"><a href="#cb156-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-97"><a href="#cb156-97" aria-hidden="true" tabindex="-1"></a>  (navigation-tree</span>
<span id="cb156-98"><a href="#cb156-98" aria-hidden="true" tabindex="-1"></a>   (tree-&gt;nav content-tree <span class="st">&quot;&quot;</span>)</span>
<span id="cb156-99"><a href="#cb156-99" aria-hidden="true" tabindex="-1"></a>   current-path</span>
<span id="cb156-100"><a href="#cb156-100" aria-hidden="true" tabindex="-1"></a>   <span class="dv">3</span>))</span>
<span id="cb156-101"><a href="#cb156-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-102"><a href="#cb156-102" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build collection navigation</span></span>
<span id="cb156-103"><a href="#cb156-103" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-collection-nav name docs options)</span>
<span id="cb156-104"><a href="#cb156-104" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> coll-docs </span>(filter-collection-docs name docs))</span>
<span id="cb156-105"><a href="#cb156-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-106"><a href="#cb156-106" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Group by specified criteria</span></span>
<span id="cb156-107"><a href="#cb156-107" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> groups</span></span>
<span id="cb156-108"><a href="#cb156-108" aria-hidden="true" tabindex="-1"></a>    (match (<span class="kw">assoc</span> &#39;group-by options)</span>
<span id="cb156-109"><a href="#cb156-109" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">cons</span> &#39;group-by &#39;year)</span>
<span id="cb156-110"><a href="#cb156-110" aria-hidden="true" tabindex="-1"></a>       (group-docs-by-year coll-docs)<span class="op">]</span></span>
<span id="cb156-111"><a href="#cb156-111" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">cons</span> &#39;group-by &#39;category)</span>
<span id="cb156-112"><a href="#cb156-112" aria-hidden="true" tabindex="-1"></a>       (group-docs-by-category coll-docs)<span class="op">]</span></span>
<span id="cb156-113"><a href="#cb156-113" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb156-114"><a href="#cb156-114" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">list</span> (<span class="kw">cons</span> <span class="st">&quot;All&quot;</span> coll-docs))<span class="op">]</span>))</span>
<span id="cb156-115"><a href="#cb156-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-116"><a href="#cb156-116" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Build navigation nodes</span></span>
<span id="cb156-117"><a href="#cb156-117" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[</span>group groups<span class="op">]</span>)</span>
<span id="cb156-118"><a href="#cb156-118" aria-hidden="true" tabindex="-1"></a>    (match-define (<span class="kw">cons</span> group-name group-docs) group)</span>
<span id="cb156-119"><a href="#cb156-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-120"><a href="#cb156-120" aria-hidden="true" tabindex="-1"></a>    (navigation-node</span>
<span id="cb156-121"><a href="#cb156-121" aria-hidden="true" tabindex="-1"></a>     group-name</span>
<span id="cb156-122"><a href="#cb156-122" aria-hidden="true" tabindex="-1"></a>     <span class="dv">#f</span></span>
<span id="cb156-123"><a href="#cb156-123" aria-hidden="true" tabindex="-1"></a>     <span class="dv">#f</span></span>
<span id="cb156-124"><a href="#cb156-124" aria-hidden="true" tabindex="-1"></a>     (for/list (<span class="op">[</span>doc (take group-docs </span>
<span id="cb156-125"><a href="#cb156-125" aria-hidden="true" tabindex="-1"></a>                          (assoc-ref options &#39;limit <span class="dv">10</span>))<span class="op">]</span>)</span>
<span id="cb156-126"><a href="#cb156-126" aria-hidden="true" tabindex="-1"></a>       (navigation-node</span>
<span id="cb156-127"><a href="#cb156-127" aria-hidden="true" tabindex="-1"></a>        (document-title doc)</span>
<span id="cb156-128"><a href="#cb156-128" aria-hidden="true" tabindex="-1"></a>        (document-url doc)</span>
<span id="cb156-129"><a href="#cb156-129" aria-hidden="true" tabindex="-1"></a>        <span class="dv">#f</span></span>
<span id="cb156-130"><a href="#cb156-130" aria-hidden="true" tabindex="-1"></a>        &#39;()</span>
<span id="cb156-131"><a href="#cb156-131" aria-hidden="true" tabindex="-1"></a>        `((document <span class="op">.</span> ,doc))))</span>
<span id="cb156-132"><a href="#cb156-132" aria-hidden="true" tabindex="-1"></a>     `((type <span class="op">.</span> collection-group)</span>
<span id="cb156-133"><a href="#cb156-133" aria-hidden="true" tabindex="-1"></a>       (count <span class="op">.</span> ,(<span class="kw">length</span> group-docs))))))</span>
<span id="cb156-134"><a href="#cb156-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-135"><a href="#cb156-135" aria-hidden="true" tabindex="-1"></a><span class="co">;; Render navigation to HTML</span></span>
<span id="cb156-136"><a href="#cb156-136" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-navigation nav-tree #:renderer <span class="op">[</span>renderer &#39;nested-list<span class="op">]</span>)</span>
<span id="cb156-137"><a href="#cb156-137" aria-hidden="true" tabindex="-1"></a>  (match renderer</span>
<span id="cb156-138"><a href="#cb156-138" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;nested-list (render-nested-list nav-tree)<span class="op">]</span></span>
<span id="cb156-139"><a href="#cb156-139" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;breadcrumb (render-breadcrumb nav-tree)<span class="op">]</span></span>
<span id="cb156-140"><a href="#cb156-140" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;sitemap (render-sitemap nav-tree)<span class="op">]</span></span>
<span id="cb156-141"><a href="#cb156-141" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> (<span class="kw">error</span> <span class="st">&quot;Unknown navigation renderer&quot;</span> renderer)<span class="op">]</span>))</span>
<span id="cb156-142"><a href="#cb156-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-143"><a href="#cb156-143" aria-hidden="true" tabindex="-1"></a><span class="co">;; Render as nested list</span></span>
<span id="cb156-144"><a href="#cb156-144" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-nested-list nav-tree)</span>
<span id="cb156-145"><a href="#cb156-145" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(render-node node depth)</span>
<span id="cb156-146"><a href="#cb156-146" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb156-147"><a href="#cb156-147" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Separator</span></span>
<span id="cb156-148"><a href="#cb156-148" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">equal?</span> (assoc-ref (navigation-node-metadata node) &#39;type)</span>
<span id="cb156-149"><a href="#cb156-149" aria-hidden="true" tabindex="-1"></a>               &#39;separator)</span>
<span id="cb156-150"><a href="#cb156-150" aria-hidden="true" tabindex="-1"></a>       `(li ((class <span class="st">&quot;nav-separator&quot;</span>)))<span class="op">]</span></span>
<span id="cb156-151"><a href="#cb156-151" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb156-152"><a href="#cb156-152" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Regular node</span></span>
<span id="cb156-153"><a href="#cb156-153" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb156-154"><a href="#cb156-154" aria-hidden="true" tabindex="-1"></a>       `(li ((class ,(string-join</span>
<span id="cb156-155"><a href="#cb156-155" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">filter</span> identity</span>
<span id="cb156-156"><a href="#cb156-156" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">list</span> <span class="st">&quot;nav-item&quot;</span></span>
<span id="cb156-157"><a href="#cb156-157" aria-hidden="true" tabindex="-1"></a>                                  (format <span class="st">&quot;nav-depth-~a&quot;</span> depth)</span>
<span id="cb156-158"><a href="#cb156-158" aria-hidden="true" tabindex="-1"></a>                                  (<span class="kw">if</span> (navigation-node-active? node)</span>
<span id="cb156-159"><a href="#cb156-159" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">&quot;active&quot;</span></span>
<span id="cb156-160"><a href="#cb156-160" aria-hidden="true" tabindex="-1"></a>                                      <span class="dv">#f</span>)))</span>
<span id="cb156-161"><a href="#cb156-161" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot; &quot;</span>)))</span>
<span id="cb156-162"><a href="#cb156-162" aria-hidden="true" tabindex="-1"></a>          ,@(<span class="kw">if</span> (navigation-node-url node)</span>
<span id="cb156-163"><a href="#cb156-163" aria-hidden="true" tabindex="-1"></a>                `((a ((href ,(navigation-node-url node)))</span>
<span id="cb156-164"><a href="#cb156-164" aria-hidden="true" tabindex="-1"></a>                    ,(navigation-node-title node)))</span>
<span id="cb156-165"><a href="#cb156-165" aria-hidden="true" tabindex="-1"></a>                `(,(navigation-node-title node)))</span>
<span id="cb156-166"><a href="#cb156-166" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb156-167"><a href="#cb156-167" aria-hidden="true" tabindex="-1"></a>          ,@(<span class="kw">if</span> (<span class="kw">null?</span> (navigation-node-children node))</span>
<span id="cb156-168"><a href="#cb156-168" aria-hidden="true" tabindex="-1"></a>                &#39;()</span>
<span id="cb156-169"><a href="#cb156-169" aria-hidden="true" tabindex="-1"></a>                `((ul ((class <span class="st">&quot;nav-children&quot;</span>))</span>
<span id="cb156-170"><a href="#cb156-170" aria-hidden="true" tabindex="-1"></a>                     ,@(map (λ (child) </span>
<span id="cb156-171"><a href="#cb156-171" aria-hidden="true" tabindex="-1"></a>                             (render-node child (<span class="op">+</span> depth <span class="dv">1</span>)))</span>
<span id="cb156-172"><a href="#cb156-172" aria-hidden="true" tabindex="-1"></a>                           (navigation-node-children node))))))<span class="op">]</span>))</span>
<span id="cb156-173"><a href="#cb156-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-174"><a href="#cb156-174" aria-hidden="true" tabindex="-1"></a>  `(nav ((class <span class="st">&quot;site-navigation&quot;</span>))</span>
<span id="cb156-175"><a href="#cb156-175" aria-hidden="true" tabindex="-1"></a>     (ul ((class <span class="st">&quot;nav-list&quot;</span>))</span>
<span id="cb156-176"><a href="#cb156-176" aria-hidden="true" tabindex="-1"></a>        ,@(map (λ (node) (render-node node <span class="dv">0</span>))</span>
<span id="cb156-177"><a href="#cb156-177" aria-hidden="true" tabindex="-1"></a>              (navigation-node-children </span>
<span id="cb156-178"><a href="#cb156-178" aria-hidden="true" tabindex="-1"></a>               (navigation-tree-root nav-tree))))))</span>
<span id="cb156-179"><a href="#cb156-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-180"><a href="#cb156-180" aria-hidden="true" tabindex="-1"></a><span class="co">;; Breadcrumb navigation</span></span>
<span id="cb156-181"><a href="#cb156-181" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-breadcrumb nav-tree)</span>
<span id="cb156-182"><a href="#cb156-182" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> path </span>(build-active-path nav-tree))</span>
<span id="cb156-183"><a href="#cb156-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb156-184"><a href="#cb156-184" aria-hidden="true" tabindex="-1"></a>  `(nav ((class <span class="st">&quot;breadcrumb&quot;</span>)</span>
<span id="cb156-185"><a href="#cb156-185" aria-hidden="true" tabindex="-1"></a>         (aria-label <span class="st">&quot;Breadcrumb&quot;</span>))</span>
<span id="cb156-186"><a href="#cb156-186" aria-hidden="true" tabindex="-1"></a>     (ol ((class <span class="st">&quot;breadcrumb-list&quot;</span>))</span>
<span id="cb156-187"><a href="#cb156-187" aria-hidden="true" tabindex="-1"></a>        ,@(for/list (<span class="op">[</span>node path<span class="op">]</span></span>
<span id="cb156-188"><a href="#cb156-188" aria-hidden="true" tabindex="-1"></a>                    <span class="op">[</span>index (in-naturals)<span class="op">]</span>)</span>
<span id="cb156-189"><a href="#cb156-189" aria-hidden="true" tabindex="-1"></a>           `(li ((class <span class="st">&quot;breadcrumb-item&quot;</span>))</span>
<span id="cb156-190"><a href="#cb156-190" aria-hidden="true" tabindex="-1"></a>               ,@(<span class="kw">if</span> (navigation-node-url node)</span>
<span id="cb156-191"><a href="#cb156-191" aria-hidden="true" tabindex="-1"></a>                     `((a ((href ,(navigation-node-url node))</span>
<span id="cb156-192"><a href="#cb156-192" aria-hidden="true" tabindex="-1"></a>                          ,@(<span class="kw">if</span> (<span class="op">=</span> index (<span class="op">-</span> (<span class="kw">length</span> path) <span class="dv">1</span>))</span>
<span id="cb156-193"><a href="#cb156-193" aria-hidden="true" tabindex="-1"></a>                                &#39;((aria-current <span class="st">&quot;page&quot;</span>))</span>
<span id="cb156-194"><a href="#cb156-194" aria-hidden="true" tabindex="-1"></a>                                &#39;()))</span>
<span id="cb156-195"><a href="#cb156-195" aria-hidden="true" tabindex="-1"></a>                         ,(navigation-node-title node)))</span>
<span id="cb156-196"><a href="#cb156-196" aria-hidden="true" tabindex="-1"></a>                     `(,(navigation-node-title node))))))))</span></code></pre></div>
<h2 id="url-schemes-and-routing">URL Schemes and Routing</h2>
<p>Flexible URL generation creates intuitive site structures:</p>
<div class="sourceCode" id="cb157"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; url-schemes.rkt</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>         racket/date)</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>(provide generate-url</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>         url-scheme?</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>         define-url-scheme</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>         standard-schemes)</span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; URL scheme definition</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>(struct url-scheme</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>  (name           <span class="co">; Scheme identifier  </span></span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>   pattern        <span class="co">; URL pattern with placeholders</span></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>   generator      <span class="co">; Function to generate URL</span></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>   validator)     <span class="co">; Function to validate URL</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate URL for document</span></span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-url doc scheme-name config)</span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> scheme </span>(get-url-scheme scheme-name))</span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a>  ((url-scheme-generator scheme) doc config))</span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a><span class="co">;; Define custom URL scheme</span></span>
<span id="cb157-27"><a href="#cb157-27" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(define-url-scheme name pattern generator </span>
<span id="cb157-28"><a href="#cb157-28" aria-hidden="true" tabindex="-1"></a>                          #:validator <span class="op">[</span>validator (λ (url) <span class="dv">#t</span>)<span class="op">]</span>)</span>
<span id="cb157-29"><a href="#cb157-29" aria-hidden="true" tabindex="-1"></a>  (url-scheme name pattern generator validator))</span>
<span id="cb157-30"><a href="#cb157-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-31"><a href="#cb157-31" aria-hidden="true" tabindex="-1"></a><span class="co">;; Standard URL schemes</span></span>
<span id="cb157-32"><a href="#cb157-32" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> standard-schemes</span></span>
<span id="cb157-33"><a href="#cb157-33" aria-hidden="true" tabindex="-1"></a>  (hash</span>
<span id="cb157-34"><a href="#cb157-34" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Hierarchical paths from content structure</span></span>
<span id="cb157-35"><a href="#cb157-35" aria-hidden="true" tabindex="-1"></a>   &#39;hierarchical</span>
<span id="cb157-36"><a href="#cb157-36" aria-hidden="true" tabindex="-1"></a>   (define-url-scheme &#39;hierarchical</span>
<span id="cb157-37"><a href="#cb157-37" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;/{path}&quot;</span></span>
<span id="cb157-38"><a href="#cb157-38" aria-hidden="true" tabindex="-1"></a>     (λ (doc config)</span>
<span id="cb157-39"><a href="#cb157-39" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> rel-path </span></span>
<span id="cb157-40"><a href="#cb157-40" aria-hidden="true" tabindex="-1"></a>         (find-relative-path </span>
<span id="cb157-41"><a href="#cb157-41" aria-hidden="true" tabindex="-1"></a>          (site-config-input-dir config)</span>
<span id="cb157-42"><a href="#cb157-42" aria-hidden="true" tabindex="-1"></a>          (document-source-path doc)))</span>
<span id="cb157-43"><a href="#cb157-43" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb157-44"><a href="#cb157-44" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Convert to URL path</span></span>
<span id="cb157-45"><a href="#cb157-45" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">string-append</span> <span class="st">&quot;/&quot;</span></span>
<span id="cb157-46"><a href="#cb157-46" aria-hidden="true" tabindex="-1"></a>                     (string-join</span>
<span id="cb157-47"><a href="#cb157-47" aria-hidden="true" tabindex="-1"></a>                      (map path-&gt;string</span>
<span id="cb157-48"><a href="#cb157-48" aria-hidden="true" tabindex="-1"></a>                           (explode-path </span>
<span id="cb157-49"><a href="#cb157-49" aria-hidden="true" tabindex="-1"></a>                            (path-replace-extension rel-path #<span class="st">&quot;&quot;</span>)))</span>
<span id="cb157-50"><a href="#cb157-50" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;/&quot;</span>))))</span>
<span id="cb157-51"><a href="#cb157-51" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb157-52"><a href="#cb157-52" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Date-based URLs</span></span>
<span id="cb157-53"><a href="#cb157-53" aria-hidden="true" tabindex="-1"></a>   &#39;date-based</span>
<span id="cb157-54"><a href="#cb157-54" aria-hidden="true" tabindex="-1"></a>   (define-url-scheme &#39;date-based</span>
<span id="cb157-55"><a href="#cb157-55" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;/{year}/{month}/{day}/{slug}&quot;</span></span>
<span id="cb157-56"><a href="#cb157-56" aria-hidden="true" tabindex="-1"></a>     (λ (doc config)</span>
<span id="cb157-57"><a href="#cb157-57" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> date </span>(document-metadata-ref doc &#39;date))</span>
<span id="cb157-58"><a href="#cb157-58" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> slug </span>(<span class="kw">or</span> (document-metadata-ref doc &#39;slug)</span>
<span id="cb157-59"><a href="#cb157-59" aria-hidden="true" tabindex="-1"></a>                       (slugify (document-title doc))))</span>
<span id="cb157-60"><a href="#cb157-60" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb157-61"><a href="#cb157-61" aria-hidden="true" tabindex="-1"></a>       (format <span class="st">&quot;/~a/~a/~a/~a&quot;</span></span>
<span id="cb157-62"><a href="#cb157-62" aria-hidden="true" tabindex="-1"></a>               (date-year date)</span>
<span id="cb157-63"><a href="#cb157-63" aria-hidden="true" tabindex="-1"></a>               (~r (date-month date) #:min-width <span class="dv">2</span> #:pad-string <span class="st">&quot;0&quot;</span>)</span>
<span id="cb157-64"><a href="#cb157-64" aria-hidden="true" tabindex="-1"></a>               (~r (date-day date) #:min-width <span class="dv">2</span> #:pad-string <span class="st">&quot;0&quot;</span>)</span>
<span id="cb157-65"><a href="#cb157-65" aria-hidden="true" tabindex="-1"></a>               slug)))</span>
<span id="cb157-66"><a href="#cb157-66" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb157-67"><a href="#cb157-67" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Category-based URLs</span></span>
<span id="cb157-68"><a href="#cb157-68" aria-hidden="true" tabindex="-1"></a>   &#39;category-based</span>
<span id="cb157-69"><a href="#cb157-69" aria-hidden="true" tabindex="-1"></a>   (define-url-scheme &#39;category-based</span>
<span id="cb157-70"><a href="#cb157-70" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;/{category}/{slug}&quot;</span></span>
<span id="cb157-71"><a href="#cb157-71" aria-hidden="true" tabindex="-1"></a>     (λ (doc config)</span>
<span id="cb157-72"><a href="#cb157-72" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> category </span></span>
<span id="cb157-73"><a href="#cb157-73" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">or</span> (document-metadata-ref doc &#39;category)</span>
<span id="cb157-74"><a href="#cb157-74" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;uncategorized&quot;</span>))</span>
<span id="cb157-75"><a href="#cb157-75" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> slug </span></span>
<span id="cb157-76"><a href="#cb157-76" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">or</span> (document-metadata-ref doc &#39;slug)</span>
<span id="cb157-77"><a href="#cb157-77" aria-hidden="true" tabindex="-1"></a>             (slugify (document-title doc))))</span>
<span id="cb157-78"><a href="#cb157-78" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb157-79"><a href="#cb157-79" aria-hidden="true" tabindex="-1"></a>       (format <span class="st">&quot;/~a/~a&quot;</span> (slugify category) slug)))</span>
<span id="cb157-80"><a href="#cb157-80" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb157-81"><a href="#cb157-81" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Flat URLs with just slug</span></span>
<span id="cb157-82"><a href="#cb157-82" aria-hidden="true" tabindex="-1"></a>   &#39;flat</span>
<span id="cb157-83"><a href="#cb157-83" aria-hidden="true" tabindex="-1"></a>   (define-url-scheme &#39;flat</span>
<span id="cb157-84"><a href="#cb157-84" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;/{slug}&quot;</span></span>
<span id="cb157-85"><a href="#cb157-85" aria-hidden="true" tabindex="-1"></a>     (λ (doc config)</span>
<span id="cb157-86"><a href="#cb157-86" aria-hidden="true" tabindex="-1"></a>       (format <span class="st">&quot;/~a&quot;</span></span>
<span id="cb157-87"><a href="#cb157-87" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">or</span> (document-metadata-ref doc &#39;slug)</span>
<span id="cb157-88"><a href="#cb157-88" aria-hidden="true" tabindex="-1"></a>                   (slugify (document-title doc))))))</span>
<span id="cb157-89"><a href="#cb157-89" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb157-90"><a href="#cb157-90" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Version-based for documentation</span></span>
<span id="cb157-91"><a href="#cb157-91" aria-hidden="true" tabindex="-1"></a>   &#39;versioned</span>
<span id="cb157-92"><a href="#cb157-92" aria-hidden="true" tabindex="-1"></a>   (define-url-scheme &#39;versioned</span>
<span id="cb157-93"><a href="#cb157-93" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;/{type}/{version}/{path}&quot;</span></span>
<span id="cb157-94"><a href="#cb157-94" aria-hidden="true" tabindex="-1"></a>     (λ (doc config)</span>
<span id="cb157-95"><a href="#cb157-95" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> type </span>(document-metadata-ref doc &#39;type <span class="st">&quot;docs&quot;</span>))</span>
<span id="cb157-96"><a href="#cb157-96" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> version </span>(document-metadata-ref doc &#39;version <span class="st">&quot;latest&quot;</span>))</span>
<span id="cb157-97"><a href="#cb157-97" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> path </span>(document-metadata-ref doc &#39;path</span>
<span id="cb157-98"><a href="#cb157-98" aria-hidden="true" tabindex="-1"></a>                                         (slugify (document-title doc))))</span>
<span id="cb157-99"><a href="#cb157-99" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb157-100"><a href="#cb157-100" aria-hidden="true" tabindex="-1"></a>       (format <span class="st">&quot;/~a/~a/~a&quot;</span> type version path)))))</span>
<span id="cb157-101"><a href="#cb157-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-102"><a href="#cb157-102" aria-hidden="true" tabindex="-1"></a><span class="co">;; URL utilities</span></span>
<span id="cb157-103"><a href="#cb157-103" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(slugify text)</span>
<span id="cb157-104"><a href="#cb157-104" aria-hidden="true" tabindex="-1"></a>  (regexp-replace* #px<span class="st">&quot;[^a-z0-9-]+&quot;</span> </span>
<span id="cb157-105"><a href="#cb157-105" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">string-downcase</span> text)</span>
<span id="cb157-106"><a href="#cb157-106" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;-&quot;</span>))</span>
<span id="cb157-107"><a href="#cb157-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-108"><a href="#cb157-108" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(path-&gt;url-path path base-dir)</span>
<span id="cb157-109"><a href="#cb157-109" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> rel-path </span></span>
<span id="cb157-110"><a href="#cb157-110" aria-hidden="true" tabindex="-1"></a>    (find-relative-path base-dir path))</span>
<span id="cb157-111"><a href="#cb157-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-112"><a href="#cb157-112" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">string-append</span> <span class="st">&quot;/&quot;</span></span>
<span id="cb157-113"><a href="#cb157-113" aria-hidden="true" tabindex="-1"></a>                (path-&gt;string </span>
<span id="cb157-114"><a href="#cb157-114" aria-hidden="true" tabindex="-1"></a>                 (path-replace-extension rel-path #<span class="st">&quot;&quot;</span>))))</span></code></pre></div>
<h2 id="taxonomy-systems">Taxonomy Systems</h2>
<p>Categories, tags, and custom taxonomies organize content
semantically:</p>
<div class="sourceCode" id="cb158"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; taxonomies.rkt</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span>)</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>(provide taxonomy</span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>         taxonomy?</span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>         define-taxonomy</span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>         build-taxonomy-index</span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>         get-taxonomy-terms)</span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Taxonomy definition</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>(struct taxonomy</span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>  (name           <span class="co">; Taxonomy identifier</span></span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>   singular       <span class="co">; Singular name</span></span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>   plural         <span class="co">; Plural name  </span></span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a>   hierarchical?  <span class="co">; Support hierarchy?</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a>   required?      <span class="co">; Required for documents?</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>   multiple?      <span class="co">; Allow multiple values?</span></span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a>   url-pattern)   <span class="co">; URL pattern for term pages</span></span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a><span class="co">;; Define a taxonomy</span></span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(define-taxonomy name </span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a>                        #:singular <span class="op">[</span>singular name<span class="op">]</span></span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a>                        #:plural <span class="op">[</span>plural (<span class="kw">string-append</span> name <span class="st">&quot;s&quot;</span>)<span class="op">]</span></span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a>                        #:hierarchical? <span class="op">[</span>hierarchical? <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a>                        #:required? <span class="op">[</span>required? <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb158-29"><a href="#cb158-29" aria-hidden="true" tabindex="-1"></a>                        #:multiple? <span class="op">[</span>multiple? <span class="dv">#t</span><span class="op">]</span></span>
<span id="cb158-30"><a href="#cb158-30" aria-hidden="true" tabindex="-1"></a>                        #:url-pattern <span class="op">[</span>url-pattern </span>
<span id="cb158-31"><a href="#cb158-31" aria-hidden="true" tabindex="-1"></a>                                     (format <span class="st">&quot;/~a/{slug}&quot;</span> plural)<span class="op">]</span>)</span>
<span id="cb158-32"><a href="#cb158-32" aria-hidden="true" tabindex="-1"></a>  (taxonomy name singular plural hierarchical? </span>
<span id="cb158-33"><a href="#cb158-33" aria-hidden="true" tabindex="-1"></a>           required? multiple? url-pattern))</span>
<span id="cb158-34"><a href="#cb158-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-35"><a href="#cb158-35" aria-hidden="true" tabindex="-1"></a><span class="co">;; Standard taxonomies</span></span>
<span id="cb158-36"><a href="#cb158-36" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> category-taxonomy</span></span>
<span id="cb158-37"><a href="#cb158-37" aria-hidden="true" tabindex="-1"></a>  (define-taxonomy <span class="st">&quot;category&quot;</span></span>
<span id="cb158-38"><a href="#cb158-38" aria-hidden="true" tabindex="-1"></a>    #:singular <span class="st">&quot;category&quot;</span></span>
<span id="cb158-39"><a href="#cb158-39" aria-hidden="true" tabindex="-1"></a>    #:plural <span class="st">&quot;categories&quot;</span></span>
<span id="cb158-40"><a href="#cb158-40" aria-hidden="true" tabindex="-1"></a>    #:hierarchical? <span class="dv">#t</span></span>
<span id="cb158-41"><a href="#cb158-41" aria-hidden="true" tabindex="-1"></a>    #:multiple? <span class="dv">#f</span>))</span>
<span id="cb158-42"><a href="#cb158-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-43"><a href="#cb158-43" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> tag-taxonomy</span></span>
<span id="cb158-44"><a href="#cb158-44" aria-hidden="true" tabindex="-1"></a>  (define-taxonomy <span class="st">&quot;tag&quot;</span></span>
<span id="cb158-45"><a href="#cb158-45" aria-hidden="true" tabindex="-1"></a>    #:singular <span class="st">&quot;tag&quot;</span></span>
<span id="cb158-46"><a href="#cb158-46" aria-hidden="true" tabindex="-1"></a>    #:plural <span class="st">&quot;tags&quot;</span></span>
<span id="cb158-47"><a href="#cb158-47" aria-hidden="true" tabindex="-1"></a>    #:hierarchical? <span class="dv">#f</span></span>
<span id="cb158-48"><a href="#cb158-48" aria-hidden="true" tabindex="-1"></a>    #:multiple? <span class="dv">#t</span>))</span>
<span id="cb158-49"><a href="#cb158-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-50"><a href="#cb158-50" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build taxonomy index</span></span>
<span id="cb158-51"><a href="#cb158-51" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-taxonomy-index docs taxonomy-def)</span>
<span id="cb158-52"><a href="#cb158-52" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> term-map </span>(make-hash))</span>
<span id="cb158-53"><a href="#cb158-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-54"><a href="#cb158-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Collect terms from documents</span></span>
<span id="cb158-55"><a href="#cb158-55" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>doc docs<span class="op">]</span>)</span>
<span id="cb158-56"><a href="#cb158-56" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> terms </span>(get-document-terms doc taxonomy-def))</span>
<span id="cb158-57"><a href="#cb158-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-58"><a href="#cb158-58" aria-hidden="true" tabindex="-1"></a>    (for (<span class="op">[</span>term terms<span class="op">]</span>)</span>
<span id="cb158-59"><a href="#cb158-59" aria-hidden="true" tabindex="-1"></a>      (hash-update! term-map term</span>
<span id="cb158-60"><a href="#cb158-60" aria-hidden="true" tabindex="-1"></a>                   (λ (docs) (<span class="kw">cons</span> doc docs))</span>
<span id="cb158-61"><a href="#cb158-61" aria-hidden="true" tabindex="-1"></a>                   &#39;())))</span>
<span id="cb158-62"><a href="#cb158-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-63"><a href="#cb158-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create taxonomy pages</span></span>
<span id="cb158-64"><a href="#cb158-64" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[</span>(term docs) (in-hash term-map)<span class="op">]</span>)</span>
<span id="cb158-65"><a href="#cb158-65" aria-hidden="true" tabindex="-1"></a>    (taxonomy-page</span>
<span id="cb158-66"><a href="#cb158-66" aria-hidden="true" tabindex="-1"></a>     taxonomy-def</span>
<span id="cb158-67"><a href="#cb158-67" aria-hidden="true" tabindex="-1"></a>     term</span>
<span id="cb158-68"><a href="#cb158-68" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">reverse</span> docs)</span>
<span id="cb158-69"><a href="#cb158-69" aria-hidden="true" tabindex="-1"></a>     (generate-term-url term taxonomy-def))))</span>
<span id="cb158-70"><a href="#cb158-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-71"><a href="#cb158-71" aria-hidden="true" tabindex="-1"></a><span class="co">;; Taxonomy page structure</span></span>
<span id="cb158-72"><a href="#cb158-72" aria-hidden="true" tabindex="-1"></a>(struct taxonomy-page</span>
<span id="cb158-73"><a href="#cb158-73" aria-hidden="true" tabindex="-1"></a>  (taxonomy       <span class="co">; Taxonomy definition</span></span>
<span id="cb158-74"><a href="#cb158-74" aria-hidden="true" tabindex="-1"></a>   term          <span class="co">; Term name</span></span>
<span id="cb158-75"><a href="#cb158-75" aria-hidden="true" tabindex="-1"></a>   documents     <span class="co">; Documents with this term</span></span>
<span id="cb158-76"><a href="#cb158-76" aria-hidden="true" tabindex="-1"></a>   url)          <span class="co">; Page URL</span></span>
<span id="cb158-77"><a href="#cb158-77" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb158-78"><a href="#cb158-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-79"><a href="#cb158-79" aria-hidden="true" tabindex="-1"></a><span class="co">;; Get document terms for taxonomy</span></span>
<span id="cb158-80"><a href="#cb158-80" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(get-document-terms doc taxonomy-def)</span>
<span id="cb158-81"><a href="#cb158-81" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> term-value </span></span>
<span id="cb158-82"><a href="#cb158-82" aria-hidden="true" tabindex="-1"></a>    (document-metadata-ref doc </span>
<span id="cb158-83"><a href="#cb158-83" aria-hidden="true" tabindex="-1"></a>                          (<span class="kw">string-&gt;symbol</span> (taxonomy-name taxonomy-def))</span>
<span id="cb158-84"><a href="#cb158-84" aria-hidden="true" tabindex="-1"></a>                          &#39;()))</span>
<span id="cb158-85"><a href="#cb158-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-86"><a href="#cb158-86" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb158-87"><a href="#cb158-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">list?</span> term-value) term-value<span class="op">]</span></span>
<span id="cb158-88"><a href="#cb158-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">string?</span> term-value) (<span class="kw">list</span> term-value)<span class="op">]</span></span>
<span id="cb158-89"><a href="#cb158-89" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> &#39;()<span class="op">]</span>))</span>
<span id="cb158-90"><a href="#cb158-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-91"><a href="#cb158-91" aria-hidden="true" tabindex="-1"></a><span class="co">;; Hierarchical taxonomy support</span></span>
<span id="cb158-92"><a href="#cb158-92" aria-hidden="true" tabindex="-1"></a>(struct taxonomy-term</span>
<span id="cb158-93"><a href="#cb158-93" aria-hidden="true" tabindex="-1"></a>  (name           <span class="co">; Term name</span></span>
<span id="cb158-94"><a href="#cb158-94" aria-hidden="true" tabindex="-1"></a>   slug           <span class="co">; URL slug</span></span>
<span id="cb158-95"><a href="#cb158-95" aria-hidden="true" tabindex="-1"></a>   parent         <span class="co">; Parent term</span></span>
<span id="cb158-96"><a href="#cb158-96" aria-hidden="true" tabindex="-1"></a>   children       <span class="co">; Child terms</span></span>
<span id="cb158-97"><a href="#cb158-97" aria-hidden="true" tabindex="-1"></a>   metadata)      <span class="co">; Additional data</span></span>
<span id="cb158-98"><a href="#cb158-98" aria-hidden="true" tabindex="-1"></a>  #:mutable</span>
<span id="cb158-99"><a href="#cb158-99" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb158-100"><a href="#cb158-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-101"><a href="#cb158-101" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build hierarchical taxonomy tree</span></span>
<span id="cb158-102"><a href="#cb158-102" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-taxonomy-tree terms)</span>
<span id="cb158-103"><a href="#cb158-103" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> term-map </span>(make-hash))</span>
<span id="cb158-104"><a href="#cb158-104" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> roots </span>&#39;())</span>
<span id="cb158-105"><a href="#cb158-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-106"><a href="#cb158-106" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; First pass: create all terms</span></span>
<span id="cb158-107"><a href="#cb158-107" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>term-spec terms<span class="op">]</span>)</span>
<span id="cb158-108"><a href="#cb158-108" aria-hidden="true" tabindex="-1"></a>    (match term-spec</span>
<span id="cb158-109"><a href="#cb158-109" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">list</span> name parent-name)</span>
<span id="cb158-110"><a href="#cb158-110" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> term </span>(taxonomy-term name </span>
<span id="cb158-111"><a href="#cb158-111" aria-hidden="true" tabindex="-1"></a>                                  (slugify name)</span>
<span id="cb158-112"><a href="#cb158-112" aria-hidden="true" tabindex="-1"></a>                                  parent-name</span>
<span id="cb158-113"><a href="#cb158-113" aria-hidden="true" tabindex="-1"></a>                                  &#39;()</span>
<span id="cb158-114"><a href="#cb158-114" aria-hidden="true" tabindex="-1"></a>                                  &#39;()))</span>
<span id="cb158-115"><a href="#cb158-115" aria-hidden="true" tabindex="-1"></a>       (hash-set! term-map name term)<span class="op">]</span></span>
<span id="cb158-116"><a href="#cb158-116" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb158-117"><a href="#cb158-117" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>name</span>
<span id="cb158-118"><a href="#cb158-118" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> term </span>(taxonomy-term name</span>
<span id="cb158-119"><a href="#cb158-119" aria-hidden="true" tabindex="-1"></a>                                  (slugify name)</span>
<span id="cb158-120"><a href="#cb158-120" aria-hidden="true" tabindex="-1"></a>                                  <span class="dv">#f</span></span>
<span id="cb158-121"><a href="#cb158-121" aria-hidden="true" tabindex="-1"></a>                                  &#39;()</span>
<span id="cb158-122"><a href="#cb158-122" aria-hidden="true" tabindex="-1"></a>                                  &#39;()))</span>
<span id="cb158-123"><a href="#cb158-123" aria-hidden="true" tabindex="-1"></a>       (hash-set! term-map name term)</span>
<span id="cb158-124"><a href="#cb158-124" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> roots (<span class="kw">cons</span> term roots))<span class="op">]</span>))</span>
<span id="cb158-125"><a href="#cb158-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-126"><a href="#cb158-126" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Second pass: link parents and children</span></span>
<span id="cb158-127"><a href="#cb158-127" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>(name term) (in-hash term-map)<span class="op">]</span>)</span>
<span id="cb158-128"><a href="#cb158-128" aria-hidden="true" tabindex="-1"></a>    (when (taxonomy-term-parent term)</span>
<span id="cb158-129"><a href="#cb158-129" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> parent </span>(hash-ref term-map (taxonomy-term-parent term) <span class="dv">#f</span>))</span>
<span id="cb158-130"><a href="#cb158-130" aria-hidden="true" tabindex="-1"></a>      (when parent</span>
<span id="cb158-131"><a href="#cb158-131" aria-hidden="true" tabindex="-1"></a>        (set-taxonomy-term-children! </span>
<span id="cb158-132"><a href="#cb158-132" aria-hidden="true" tabindex="-1"></a>         parent </span>
<span id="cb158-133"><a href="#cb158-133" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">cons</span> term (taxonomy-term-children parent))))))</span>
<span id="cb158-134"><a href="#cb158-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb158-135"><a href="#cb158-135" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">reverse</span> roots))</span>
<span id="cb158-136"><a href="#cb158-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-137"><a href="#cb158-137" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate taxonomy term pages</span></span>
<span id="cb158-138"><a href="#cb158-138" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-taxonomy-pages config taxonomies docs)</span>
<span id="cb158-139"><a href="#cb158-139" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[</span>tax-def taxonomies<span class="op">]</span>)</span>
<span id="cb158-140"><a href="#cb158-140" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> index </span>(build-taxonomy-index docs tax-def))</span>
<span id="cb158-141"><a href="#cb158-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-142"><a href="#cb158-142" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Generate index page</span></span>
<span id="cb158-143"><a href="#cb158-143" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> index-page</span></span>
<span id="cb158-144"><a href="#cb158-144" aria-hidden="true" tabindex="-1"></a>      (generated-page</span>
<span id="cb158-145"><a href="#cb158-145" aria-hidden="true" tabindex="-1"></a>       (format <span class="st">&quot;~a Index&quot;</span> (taxonomy-plural tax-def))</span>
<span id="cb158-146"><a href="#cb158-146" aria-hidden="true" tabindex="-1"></a>       (render-taxonomy-index tax-def index)</span>
<span id="cb158-147"><a href="#cb158-147" aria-hidden="true" tabindex="-1"></a>       (format <span class="st">&quot;/~a/&quot;</span> (taxonomy-plural tax-def))))</span>
<span id="cb158-148"><a href="#cb158-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-149"><a href="#cb158-149" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Generate individual term pages</span></span>
<span id="cb158-150"><a href="#cb158-150" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> term-pages</span></span>
<span id="cb158-151"><a href="#cb158-151" aria-hidden="true" tabindex="-1"></a>      (for/list (<span class="op">[</span>term-page index<span class="op">]</span>)</span>
<span id="cb158-152"><a href="#cb158-152" aria-hidden="true" tabindex="-1"></a>        (generated-page</span>
<span id="cb158-153"><a href="#cb158-153" aria-hidden="true" tabindex="-1"></a>         (format <span class="st">&quot;~a: ~a&quot;</span> </span>
<span id="cb158-154"><a href="#cb158-154" aria-hidden="true" tabindex="-1"></a>                (taxonomy-singular tax-def)</span>
<span id="cb158-155"><a href="#cb158-155" aria-hidden="true" tabindex="-1"></a>                (taxonomy-page-term term-page))</span>
<span id="cb158-156"><a href="#cb158-156" aria-hidden="true" tabindex="-1"></a>         (render-taxonomy-term-page term-page)</span>
<span id="cb158-157"><a href="#cb158-157" aria-hidden="true" tabindex="-1"></a>         (taxonomy-page-url term-page))))</span>
<span id="cb158-158"><a href="#cb158-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-159"><a href="#cb158-159" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cons</span> index-page term-pages)))</span></code></pre></div>
<h2 id="index-generation-and-sitemaps">Index Generation and
Sitemaps</h2>
<p>Automatic index generation creates navigable content hierarchies:</p>
<div class="sourceCode" id="cb159"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; index-generation.rkt</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;collections.rkt&quot;</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>         xml)</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>(provide generate-indices</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>         generate-sitemap</span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>         index-config?)</span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Index configuration</span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>(struct index-config</span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>  (path           <span class="co">; Output path</span></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>   title          <span class="co">; Page title</span></span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a>   collection     <span class="co">; Source collection</span></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>   template       <span class="co">; Template name</span></span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a>   sort-by        <span class="co">; Sort field</span></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a>   group-by       <span class="co">; Grouping field</span></span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a>   per-page)      <span class="co">; Items per page</span></span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate index pages</span></span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-indices config docs)</span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> index-configs </span>(site-config-index-pages config))</span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[</span>idx-config index-configs<span class="op">]</span>)</span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a>    (generate-index-page idx-config docs config)))</span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate single index page</span></span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-index-page idx-config docs config)</span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> coll-docs</span></span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (index-config-collection idx-config)</span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a>        (query-collection-docs (index-config-collection idx-config) docs)</span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a>        docs))</span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Sort documents</span></span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> sorted-docs</span></span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (index-config-sort-by idx-config)</span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a>        (sort coll-docs</span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a>              (make-sort-fn (index-config-sort-by idx-config)))</span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a>        coll-docs))</span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Group if specified</span></span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> grouped-docs</span></span>
<span id="cb159-46"><a href="#cb159-46" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (index-config-group-by idx-config)</span>
<span id="cb159-47"><a href="#cb159-47" aria-hidden="true" tabindex="-1"></a>        (group-documents sorted-docs (index-config-group-by idx-config))</span>
<span id="cb159-48"><a href="#cb159-48" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">list</span> (<span class="kw">cons</span> <span class="st">&quot;All&quot;</span> sorted-docs))))</span>
<span id="cb159-49"><a href="#cb159-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-50"><a href="#cb159-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate pages with pagination</span></span>
<span id="cb159-51"><a href="#cb159-51" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (index-config-per-page idx-config)</span>
<span id="cb159-52"><a href="#cb159-52" aria-hidden="true" tabindex="-1"></a>      (generate-paginated-indices idx-config grouped-docs)</span>
<span id="cb159-53"><a href="#cb159-53" aria-hidden="true" tabindex="-1"></a>      (generate-single-index idx-config grouped-docs)))</span>
<span id="cb159-54"><a href="#cb159-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-55"><a href="#cb159-55" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate paginated index pages</span></span>
<span id="cb159-56"><a href="#cb159-56" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-paginated-indices idx-config grouped-docs)</span>
<span id="cb159-57"><a href="#cb159-57" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> per-page </span>(index-config-per-page idx-config))</span>
<span id="cb159-58"><a href="#cb159-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-59"><a href="#cb159-59" aria-hidden="true" tabindex="-1"></a>  (for*/list (<span class="op">[</span>group grouped-docs<span class="op">]</span></span>
<span id="cb159-60"><a href="#cb159-60" aria-hidden="true" tabindex="-1"></a>              <span class="op">[</span>page-num (in-naturals <span class="dv">1</span>)<span class="op">]</span></span>
<span id="cb159-61"><a href="#cb159-61" aria-hidden="true" tabindex="-1"></a>              #:break (empty? (<span class="kw">cdr</span> group)))</span>
<span id="cb159-62"><a href="#cb159-62" aria-hidden="true" tabindex="-1"></a>    (match-define (<span class="kw">cons</span> group-name group-docs) group)</span>
<span id="cb159-63"><a href="#cb159-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-64"><a href="#cb159-64" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> start </span>(<span class="op">*</span> (<span class="op">-</span> page-num <span class="dv">1</span>) per-page))</span>
<span id="cb159-65"><a href="#cb159-65" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> end </span>(<span class="kw">min</span> (<span class="op">*</span> page-num per-page) (<span class="kw">length</span> group-docs)))</span>
<span id="cb159-66"><a href="#cb159-66" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> page-docs </span>(sublist group-docs start end))</span>
<span id="cb159-67"><a href="#cb159-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-68"><a href="#cb159-68" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> total-pages </span></span>
<span id="cb159-69"><a href="#cb159-69" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">ceiling</span> (<span class="op">/</span> (<span class="kw">length</span> group-docs) per-page)))</span>
<span id="cb159-70"><a href="#cb159-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-71"><a href="#cb159-71" aria-hidden="true" tabindex="-1"></a>    (generated-page</span>
<span id="cb159-72"><a href="#cb159-72" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> (<span class="op">=</span> page-num <span class="dv">1</span>)</span>
<span id="cb159-73"><a href="#cb159-73" aria-hidden="true" tabindex="-1"></a>         (index-config-title idx-config)</span>
<span id="cb159-74"><a href="#cb159-74" aria-hidden="true" tabindex="-1"></a>         (format <span class="st">&quot;~a - Page ~a&quot;</span> </span>
<span id="cb159-75"><a href="#cb159-75" aria-hidden="true" tabindex="-1"></a>                (index-config-title idx-config)</span>
<span id="cb159-76"><a href="#cb159-76" aria-hidden="true" tabindex="-1"></a>                page-num))</span>
<span id="cb159-77"><a href="#cb159-77" aria-hidden="true" tabindex="-1"></a>     (render-index-content page-docs</span>
<span id="cb159-78"><a href="#cb159-78" aria-hidden="true" tabindex="-1"></a>                          group-name</span>
<span id="cb159-79"><a href="#cb159-79" aria-hidden="true" tabindex="-1"></a>                          page-num</span>
<span id="cb159-80"><a href="#cb159-80" aria-hidden="true" tabindex="-1"></a>                          total-pages)</span>
<span id="cb159-81"><a href="#cb159-81" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> (<span class="op">=</span> page-num <span class="dv">1</span>)</span>
<span id="cb159-82"><a href="#cb159-82" aria-hidden="true" tabindex="-1"></a>         (index-config-path idx-config)</span>
<span id="cb159-83"><a href="#cb159-83" aria-hidden="true" tabindex="-1"></a>         (format <span class="st">&quot;~a/page/~a&quot;</span></span>
<span id="cb159-84"><a href="#cb159-84" aria-hidden="true" tabindex="-1"></a>                (index-config-path idx-config)</span>
<span id="cb159-85"><a href="#cb159-85" aria-hidden="true" tabindex="-1"></a>                page-num)))))</span>
<span id="cb159-86"><a href="#cb159-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-87"><a href="#cb159-87" aria-hidden="true" tabindex="-1"></a><span class="co">;; XML Sitemap generation</span></span>
<span id="cb159-88"><a href="#cb159-88" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-sitemap config docs base-url)</span>
<span id="cb159-89"><a href="#cb159-89" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> urls</span></span>
<span id="cb159-90"><a href="#cb159-90" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>doc docs<span class="op">]</span></span>
<span id="cb159-91"><a href="#cb159-91" aria-hidden="true" tabindex="-1"></a>               #:when (<span class="kw">not</span> (document-metadata-ref doc &#39;draft <span class="dv">#f</span>)))</span>
<span id="cb159-92"><a href="#cb159-92" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> url </span>(<span class="kw">string-append</span> base-url (document-url doc)))</span>
<span id="cb159-93"><a href="#cb159-93" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> lastmod </span>(document-last-modified doc))</span>
<span id="cb159-94"><a href="#cb159-94" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> priority </span>(calculate-priority doc))</span>
<span id="cb159-95"><a href="#cb159-95" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> changefreq </span>(calculate-changefreq doc))</span>
<span id="cb159-96"><a href="#cb159-96" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-97"><a href="#cb159-97" aria-hidden="true" tabindex="-1"></a>      `(url</span>
<span id="cb159-98"><a href="#cb159-98" aria-hidden="true" tabindex="-1"></a>        (loc ,url)</span>
<span id="cb159-99"><a href="#cb159-99" aria-hidden="true" tabindex="-1"></a>        ,@(<span class="kw">if</span> lastmod</span>
<span id="cb159-100"><a href="#cb159-100" aria-hidden="true" tabindex="-1"></a>              `((lastmod ,(date-&gt;iso8601 lastmod)))</span>
<span id="cb159-101"><a href="#cb159-101" aria-hidden="true" tabindex="-1"></a>              &#39;())</span>
<span id="cb159-102"><a href="#cb159-102" aria-hidden="true" tabindex="-1"></a>        ,@(<span class="kw">if</span> priority</span>
<span id="cb159-103"><a href="#cb159-103" aria-hidden="true" tabindex="-1"></a>              `((priority ,(<span class="kw">number-&gt;string</span> priority)))</span>
<span id="cb159-104"><a href="#cb159-104" aria-hidden="true" tabindex="-1"></a>              &#39;())</span>
<span id="cb159-105"><a href="#cb159-105" aria-hidden="true" tabindex="-1"></a>        ,@(<span class="kw">if</span> changefreq</span>
<span id="cb159-106"><a href="#cb159-106" aria-hidden="true" tabindex="-1"></a>              `((changefreq ,changefreq))</span>
<span id="cb159-107"><a href="#cb159-107" aria-hidden="true" tabindex="-1"></a>              &#39;()))))</span>
<span id="cb159-108"><a href="#cb159-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-109"><a href="#cb159-109" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate sitemap XML</span></span>
<span id="cb159-110"><a href="#cb159-110" aria-hidden="true" tabindex="-1"></a>  `(urlset ((xmlns <span class="st">&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span>))</span>
<span id="cb159-111"><a href="#cb159-111" aria-hidden="true" tabindex="-1"></a>     ,@urls))</span>
<span id="cb159-112"><a href="#cb159-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-113"><a href="#cb159-113" aria-hidden="true" tabindex="-1"></a><span class="co">;; Calculate document priority</span></span>
<span id="cb159-114"><a href="#cb159-114" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(calculate-priority doc)</span>
<span id="cb159-115"><a href="#cb159-115" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb159-116"><a href="#cb159-116" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(document-metadata-ref doc &#39;priority <span class="dv">#f</span>)<span class="op">]</span></span>
<span id="cb159-117"><a href="#cb159-117" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">equal?</span> (document-metadata-ref doc &#39;type) <span class="st">&quot;page&quot;</span>) <span class="fl">0.8</span><span class="op">]</span></span>
<span id="cb159-118"><a href="#cb159-118" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">equal?</span> (document-metadata-ref doc &#39;type) <span class="st">&quot;post&quot;</span>) <span class="fl">0.6</span><span class="op">]</span></span>
<span id="cb159-119"><a href="#cb159-119" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> <span class="fl">0.5</span><span class="op">]</span>))</span>
<span id="cb159-120"><a href="#cb159-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-121"><a href="#cb159-121" aria-hidden="true" tabindex="-1"></a><span class="co">;; Calculate change frequency</span></span>
<span id="cb159-122"><a href="#cb159-122" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(calculate-changefreq doc)</span>
<span id="cb159-123"><a href="#cb159-123" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> age-days </span></span>
<span id="cb159-124"><a href="#cb159-124" aria-hidden="true" tabindex="-1"></a>    (days-since (document-metadata-ref doc &#39;date)))</span>
<span id="cb159-125"><a href="#cb159-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-126"><a href="#cb159-126" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb159-127"><a href="#cb159-127" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">&lt;</span> age-days <span class="dv">7</span>) <span class="st">&quot;daily&quot;</span><span class="op">]</span></span>
<span id="cb159-128"><a href="#cb159-128" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">&lt;</span> age-days <span class="dv">30</span>) <span class="st">&quot;weekly&quot;</span><span class="op">]</span></span>
<span id="cb159-129"><a href="#cb159-129" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">&lt;</span> age-days <span class="dv">365</span>) <span class="st">&quot;monthly&quot;</span><span class="op">]</span></span>
<span id="cb159-130"><a href="#cb159-130" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> <span class="st">&quot;yearly&quot;</span><span class="op">]</span>))</span>
<span id="cb159-131"><a href="#cb159-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-132"><a href="#cb159-132" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate RSS/Atom feeds</span></span>
<span id="cb159-133"><a href="#cb159-133" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-feeds config collections)</span>
<span id="cb159-134"><a href="#cb159-134" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[</span>coll collections<span class="op">]</span></span>
<span id="cb159-135"><a href="#cb159-135" aria-hidden="true" tabindex="-1"></a>             #:when (collection-feed-enabled? coll))</span>
<span id="cb159-136"><a href="#cb159-136" aria-hidden="true" tabindex="-1"></a>    (generate-collection-feed config coll)))</span>
<span id="cb159-137"><a href="#cb159-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-138"><a href="#cb159-138" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate feed for collection</span></span>
<span id="cb159-139"><a href="#cb159-139" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-collection-feed config coll)</span>
<span id="cb159-140"><a href="#cb159-140" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> docs </span>(take (collection-documents coll) <span class="dv">20</span>))</span>
<span id="cb159-141"><a href="#cb159-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-142"><a href="#cb159-142" aria-hidden="true" tabindex="-1"></a>  `(rss ((version <span class="st">&quot;2.0&quot;</span>)</span>
<span id="cb159-143"><a href="#cb159-143" aria-hidden="true" tabindex="-1"></a>         (xmlns:atom <span class="st">&quot;http://www.w3.org/2005/Atom&quot;</span>))</span>
<span id="cb159-144"><a href="#cb159-144" aria-hidden="true" tabindex="-1"></a>     (channel</span>
<span id="cb159-145"><a href="#cb159-145" aria-hidden="true" tabindex="-1"></a>      (title ,(collection-title coll))</span>
<span id="cb159-146"><a href="#cb159-146" aria-hidden="true" tabindex="-1"></a>      (link ,(<span class="kw">string-append</span> (site-config-base-url config)</span>
<span id="cb159-147"><a href="#cb159-147" aria-hidden="true" tabindex="-1"></a>                           (collection-url coll)))</span>
<span id="cb159-148"><a href="#cb159-148" aria-hidden="true" tabindex="-1"></a>      (description ,(collection-description coll))</span>
<span id="cb159-149"><a href="#cb159-149" aria-hidden="true" tabindex="-1"></a>      (language ,(site-config-language config))</span>
<span id="cb159-150"><a href="#cb159-150" aria-hidden="true" tabindex="-1"></a>      (lastBuildDate ,(date-&gt;rfc822 (current-date)))</span>
<span id="cb159-151"><a href="#cb159-151" aria-hidden="true" tabindex="-1"></a>      (atom:link ((href ,(<span class="kw">string-append</span> </span>
<span id="cb159-152"><a href="#cb159-152" aria-hidden="true" tabindex="-1"></a>                         (site-config-base-url config)</span>
<span id="cb159-153"><a href="#cb159-153" aria-hidden="true" tabindex="-1"></a>                         (collection-feed-url coll)))</span>
<span id="cb159-154"><a href="#cb159-154" aria-hidden="true" tabindex="-1"></a>                  (rel <span class="st">&quot;self&quot;</span>)</span>
<span id="cb159-155"><a href="#cb159-155" aria-hidden="true" tabindex="-1"></a>                  (type <span class="st">&quot;application/rss+xml&quot;</span>)))</span>
<span id="cb159-156"><a href="#cb159-156" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb159-157"><a href="#cb159-157" aria-hidden="true" tabindex="-1"></a>      ,@(for/list (<span class="op">[</span>doc docs<span class="op">]</span>)</span>
<span id="cb159-158"><a href="#cb159-158" aria-hidden="true" tabindex="-1"></a>          `(item</span>
<span id="cb159-159"><a href="#cb159-159" aria-hidden="true" tabindex="-1"></a>            (title ,(document-title doc))</span>
<span id="cb159-160"><a href="#cb159-160" aria-hidden="true" tabindex="-1"></a>            (link ,(<span class="kw">string-append</span> (site-config-base-url config)</span>
<span id="cb159-161"><a href="#cb159-161" aria-hidden="true" tabindex="-1"></a>                                 (document-url doc)))</span>
<span id="cb159-162"><a href="#cb159-162" aria-hidden="true" tabindex="-1"></a>            (description ,(<span class="kw">or</span> (document-metadata-ref doc &#39;summary)</span>
<span id="cb159-163"><a href="#cb159-163" aria-hidden="true" tabindex="-1"></a>                             (extract-summary doc)))</span>
<span id="cb159-164"><a href="#cb159-164" aria-hidden="true" tabindex="-1"></a>            (pubDate ,(date-&gt;rfc822 </span>
<span id="cb159-165"><a href="#cb159-165" aria-hidden="true" tabindex="-1"></a>                      (document-metadata-ref doc &#39;date)))</span>
<span id="cb159-166"><a href="#cb159-166" aria-hidden="true" tabindex="-1"></a>            (guid ,(<span class="kw">string-append</span> (site-config-base-url config)</span>
<span id="cb159-167"><a href="#cb159-167" aria-hidden="true" tabindex="-1"></a>                                 (document-url doc))))))))</span></code></pre></div>
<h2 id="testing-site-organization">Testing Site Organization</h2>
<p>Comprehensive tests ensure robust site generation:</p>
<div class="sourceCode" id="cb160"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; site-structure-tests.rkt</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>(require rackunit</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;site-config.rkt&quot;</span></span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;navigation.rkt&quot;</span></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;taxonomies.rkt&quot;</span>)</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> test-config</span></span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>  (site-config</span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;Test Site&quot;</span>                    <span class="co">; title</span></span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;https://example.com&quot;</span>          <span class="co">; base-url</span></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>   (author <span class="st">&quot;Test&quot;</span> <span class="st">&quot;test@example.com&quot;</span>) <span class="co">; author</span></span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;Test site&quot;</span>                    <span class="co">; description</span></span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;en&quot;</span>                          <span class="co">; language</span></span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;content&quot;</span>                     <span class="co">; input-dir</span></span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;public&quot;</span>                      <span class="co">; output-dir</span></span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;assets&quot;</span>                      <span class="co">; assets-dir</span></span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;templates&quot;</span>                   <span class="co">; templates-dir</span></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>   (hash &#39;post <span class="st">&quot;posts&quot;</span>           <span class="co">; content-map</span></span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>         &#39;page <span class="st">&quot;pages&quot;</span>)</span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>   &#39;hierarchical                 <span class="co">; url-scheme</span></span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a>   &#39;()                          <span class="co">; index-pages</span></span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span> category-taxonomy       <span class="co">; taxonomies</span></span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a>         tag-taxonomy)</span>
<span id="cb160-26"><a href="#cb160-26" aria-hidden="true" tabindex="-1"></a>   &#39;(html)                      <span class="co">; formats</span></span>
<span id="cb160-27"><a href="#cb160-27" aria-hidden="true" tabindex="-1"></a>   &#39;()                          <span class="co">; plugins</span></span>
<span id="cb160-28"><a href="#cb160-28" aria-hidden="true" tabindex="-1"></a>   &#39;()                          <span class="co">; preprocessors</span></span>
<span id="cb160-29"><a href="#cb160-29" aria-hidden="true" tabindex="-1"></a>   &#39;()                          <span class="co">; postprocessors</span></span>
<span id="cb160-30"><a href="#cb160-30" aria-hidden="true" tabindex="-1"></a>   &#39;()                          <span class="co">; collections</span></span>
<span id="cb160-31"><a href="#cb160-31" aria-hidden="true" tabindex="-1"></a>   <span class="dv">#f</span>                           <span class="co">; navigation</span></span>
<span id="cb160-32"><a href="#cb160-32" aria-hidden="true" tabindex="-1"></a>   &#39;()                          <span class="co">; redirects</span></span>
<span id="cb160-33"><a href="#cb160-33" aria-hidden="true" tabindex="-1"></a>   &#39;()))                        <span class="co">; aliases</span></span>
<span id="cb160-34"><a href="#cb160-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-35"><a href="#cb160-35" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;URL generation&quot;</span></span>
<span id="cb160-36"><a href="#cb160-36" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> doc</span></span>
<span id="cb160-37"><a href="#cb160-37" aria-hidden="true" tabindex="-1"></a>    (document <span class="st">&quot;Test Post&quot;</span></span>
<span id="cb160-38"><a href="#cb160-38" aria-hidden="true" tabindex="-1"></a>              (<span class="kw">list</span> (author <span class="st">&quot;Test&quot;</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb160-39"><a href="#cb160-39" aria-hidden="true" tabindex="-1"></a>              (date <span class="dv">2024</span> <span class="dv">10</span> <span class="dv">1</span>)</span>
<span id="cb160-40"><a href="#cb160-40" aria-hidden="true" tabindex="-1"></a>              &#39;()</span>
<span id="cb160-41"><a href="#cb160-41" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;test-post&quot;</span></span>
<span id="cb160-42"><a href="#cb160-42" aria-hidden="true" tabindex="-1"></a>              (hash &#39;slug <span class="st">&quot;test-post&quot;</span></span>
<span id="cb160-43"><a href="#cb160-43" aria-hidden="true" tabindex="-1"></a>                    &#39;category <span class="st">&quot;tutorials&quot;</span>)))</span>
<span id="cb160-44"><a href="#cb160-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-45"><a href="#cb160-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Test different URL schemes</span></span>
<span id="cb160-46"><a href="#cb160-46" aria-hidden="true" tabindex="-1"></a>  (check-equal? (generate-url doc &#39;hierarchical test-config)</span>
<span id="cb160-47"><a href="#cb160-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;/test-post&quot;</span>)</span>
<span id="cb160-48"><a href="#cb160-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-49"><a href="#cb160-49" aria-hidden="true" tabindex="-1"></a>  (check-equal? (generate-url doc &#39;date-based test-config)</span>
<span id="cb160-50"><a href="#cb160-50" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;/2024/10/01/test-post&quot;</span>)</span>
<span id="cb160-51"><a href="#cb160-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-52"><a href="#cb160-52" aria-hidden="true" tabindex="-1"></a>  (check-equal? (generate-url doc &#39;category-based test-config)</span>
<span id="cb160-53"><a href="#cb160-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;/tutorials/test-post&quot;</span>))</span>
<span id="cb160-54"><a href="#cb160-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-55"><a href="#cb160-55" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Navigation building&quot;</span></span>
<span id="cb160-56"><a href="#cb160-56" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> docs</span></span>
<span id="cb160-57"><a href="#cb160-57" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">list</span></span>
<span id="cb160-58"><a href="#cb160-58" aria-hidden="true" tabindex="-1"></a>     (document <span class="st">&quot;Home&quot;</span> &#39;() (current-date) &#39;() <span class="st">&quot;index&quot;</span> (hash))</span>
<span id="cb160-59"><a href="#cb160-59" aria-hidden="true" tabindex="-1"></a>     (document <span class="st">&quot;About&quot;</span> &#39;() (current-date) &#39;() <span class="st">&quot;about&quot;</span> (hash))</span>
<span id="cb160-60"><a href="#cb160-60" aria-hidden="true" tabindex="-1"></a>     (document <span class="st">&quot;Blog Post&quot;</span> &#39;() (current-date) &#39;() <span class="st">&quot;blog/post&quot;</span> (hash))))</span>
<span id="cb160-61"><a href="#cb160-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-62"><a href="#cb160-62" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> nav </span>(build-navigation test-config docs <span class="st">&quot;/about&quot;</span>))</span>
<span id="cb160-63"><a href="#cb160-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-64"><a href="#cb160-64" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Verify navigation structure</span></span>
<span id="cb160-65"><a href="#cb160-65" aria-hidden="true" tabindex="-1"></a>  (check-true (navigation-tree? nav))</span>
<span id="cb160-66"><a href="#cb160-66" aria-hidden="true" tabindex="-1"></a>  (check-equal? (navigation-tree-current-path nav) <span class="st">&quot;/about&quot;</span>))</span>
<span id="cb160-67"><a href="#cb160-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-68"><a href="#cb160-68" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Taxonomy building&quot;</span></span>
<span id="cb160-69"><a href="#cb160-69" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> docs</span></span>
<span id="cb160-70"><a href="#cb160-70" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">list</span></span>
<span id="cb160-71"><a href="#cb160-71" aria-hidden="true" tabindex="-1"></a>     (document <span class="st">&quot;Post 1&quot;</span> &#39;() (current-date) &#39;() <span class="st">&quot;post1&quot;</span> </span>
<span id="cb160-72"><a href="#cb160-72" aria-hidden="true" tabindex="-1"></a>              (hash &#39;category <span class="st">&quot;tech&quot;</span> &#39;tags &#39;(<span class="st">&quot;racket&quot;</span> <span class="st">&quot;lisp&quot;</span>)))</span>
<span id="cb160-73"><a href="#cb160-73" aria-hidden="true" tabindex="-1"></a>     (document <span class="st">&quot;Post 2&quot;</span> &#39;() (current-date) &#39;() <span class="st">&quot;post2&quot;</span></span>
<span id="cb160-74"><a href="#cb160-74" aria-hidden="true" tabindex="-1"></a>              (hash &#39;category <span class="st">&quot;tech&quot;</span> &#39;tags &#39;(<span class="st">&quot;python&quot;</span>)))</span>
<span id="cb160-75"><a href="#cb160-75" aria-hidden="true" tabindex="-1"></a>     (document <span class="st">&quot;Post 3&quot;</span> &#39;() (current-date) &#39;() <span class="st">&quot;post3&quot;</span></span>
<span id="cb160-76"><a href="#cb160-76" aria-hidden="true" tabindex="-1"></a>              (hash &#39;category <span class="st">&quot;misc&quot;</span> &#39;tags &#39;(<span class="st">&quot;racket&quot;</span>)))))</span>
<span id="cb160-77"><a href="#cb160-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-78"><a href="#cb160-78" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cat-index </span>(build-taxonomy-index docs category-taxonomy))</span>
<span id="cb160-79"><a href="#cb160-79" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tag-index </span>(build-taxonomy-index docs tag-taxonomy))</span>
<span id="cb160-80"><a href="#cb160-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-81"><a href="#cb160-81" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check category index</span></span>
<span id="cb160-82"><a href="#cb160-82" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> cat-index) <span class="dv">2</span>) <span class="co">; tech and misc</span></span>
<span id="cb160-83"><a href="#cb160-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-84"><a href="#cb160-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check tag index</span></span>
<span id="cb160-85"><a href="#cb160-85" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> tag-index) <span class="dv">3</span>) <span class="co">; racket, lisp, python</span></span>
<span id="cb160-86"><a href="#cb160-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-87"><a href="#cb160-87" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Verify document associations</span></span>
<span id="cb160-88"><a href="#cb160-88" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> racket-tag-page</span></span>
<span id="cb160-89"><a href="#cb160-89" aria-hidden="true" tabindex="-1"></a>    (findf (λ (page) (<span class="kw">equal?</span> (taxonomy-page-term page) <span class="st">&quot;racket&quot;</span>))</span>
<span id="cb160-90"><a href="#cb160-90" aria-hidden="true" tabindex="-1"></a>           tag-index))</span>
<span id="cb160-91"><a href="#cb160-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-92"><a href="#cb160-92" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> (taxonomy-page-documents racket-tag-page)) <span class="dv">2</span>))</span></code></pre></div>
<p>The site structure and organization system demonstrates how static
site generators can create sophisticated information architectures. By
combining flexible configuration, intelligent navigation generation, and
powerful taxonomy systems, we enable users to build sites that scale
from simple blogs to complex documentation portals while maintaining
clarity and navigability.</p>
<h2 id="exercises-5">Exercises</h2>
<ol type="1">
<li><p><strong>Implement multilingual support</strong>: Extend the site
structure to handle multiple language versions with proper URL schemes
and cross-language navigation.</p></li>
<li><p><strong>Add search functionality</strong>: Build a client-side
search system that indexes site content and provides real-time search
results.</p></li>
<li><p><strong>Create a plugin system</strong>: Design a plugin
architecture that allows extending site functionality without modifying
core code.</p></li>
<li><p><strong>Implement content relationships</strong>: Add support for
related content, series, and prerequisite relationships between
documents. # Chapter 11: The Build Engine</p></li>
</ol>
<h2 id="orchestrating-the-symphony-of-generation">Orchestrating the
Symphony of Generation</h2>
<p>At the heart of every static site generator lies a build engine—a
sophisticated orchestrator that transforms a collection of source files
into a complete website. This engine must handle dependencies, manage
incremental rebuilds, coordinate parallel processing, and maintain
consistency across thousands of files. In this chapter, we explore how
Shrdlu’s build engine achieves efficiency, reliability, and
extensibility.</p>
<h2 id="build-architecture-overview">Build Architecture Overview</h2>
<p>The build engine coordinates multiple subsystems to transform
content:</p>
<div class="sourceCode" id="cb161"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; build-engine.rkt</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>(require racket/async-channel</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>         racket/place</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;document-model.rkt&quot;</span></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;site-config.rkt&quot;</span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;dependency-graph.rkt&quot;</span>)</span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>(provide build-site</span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>         build-context</span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>         build-pipeline</span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>         build-result)</span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build context maintains state across build</span></span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a>(struct build-context</span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a>  (config           <span class="co">; Site configuration</span></span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a>   source-files     <span class="co">; Source file list</span></span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a>   output-files     <span class="co">; Generated files</span></span>
<span id="cb161-20"><a href="#cb161-20" aria-hidden="true" tabindex="-1"></a>   dependencies     <span class="co">; Dependency graph</span></span>
<span id="cb161-21"><a href="#cb161-21" aria-hidden="true" tabindex="-1"></a>   cache           <span class="co">; Build cache</span></span>
<span id="cb161-22"><a href="#cb161-22" aria-hidden="true" tabindex="-1"></a>   stats           <span class="co">; Build statistics</span></span>
<span id="cb161-23"><a href="#cb161-23" aria-hidden="true" tabindex="-1"></a>   errors          <span class="co">; Error accumulator</span></span>
<span id="cb161-24"><a href="#cb161-24" aria-hidden="true" tabindex="-1"></a>   warnings)       <span class="co">; Warning accumulator</span></span>
<span id="cb161-25"><a href="#cb161-25" aria-hidden="true" tabindex="-1"></a>  #:mutable</span>
<span id="cb161-26"><a href="#cb161-26" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb161-27"><a href="#cb161-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-28"><a href="#cb161-28" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build pipeline stages</span></span>
<span id="cb161-29"><a href="#cb161-29" aria-hidden="true" tabindex="-1"></a>(struct build-pipeline</span>
<span id="cb161-30"><a href="#cb161-30" aria-hidden="true" tabindex="-1"></a>  (name            <span class="co">; Pipeline identifier</span></span>
<span id="cb161-31"><a href="#cb161-31" aria-hidden="true" tabindex="-1"></a>   stages          <span class="co">; List of build stages</span></span>
<span id="cb161-32"><a href="#cb161-32" aria-hidden="true" tabindex="-1"></a>   parallel?       <span class="co">; Can stages run in parallel?</span></span>
<span id="cb161-33"><a href="#cb161-33" aria-hidden="true" tabindex="-1"></a>   continue-on-error?) <span class="co">; Continue if stage fails?</span></span>
<span id="cb161-34"><a href="#cb161-34" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb161-35"><a href="#cb161-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-36"><a href="#cb161-36" aria-hidden="true" tabindex="-1"></a><span class="co">;; Individual build stage</span></span>
<span id="cb161-37"><a href="#cb161-37" aria-hidden="true" tabindex="-1"></a>(struct build-stage</span>
<span id="cb161-38"><a href="#cb161-38" aria-hidden="true" tabindex="-1"></a>  (name            <span class="co">; Stage identifier</span></span>
<span id="cb161-39"><a href="#cb161-39" aria-hidden="true" tabindex="-1"></a>   process         <span class="co">; Processing function</span></span>
<span id="cb161-40"><a href="#cb161-40" aria-hidden="true" tabindex="-1"></a>   input-filter    <span class="co">; Which files to process</span></span>
<span id="cb161-41"><a href="#cb161-41" aria-hidden="true" tabindex="-1"></a>   output-type     <span class="co">; Type of output produced</span></span>
<span id="cb161-42"><a href="#cb161-42" aria-hidden="true" tabindex="-1"></a>   dependencies    <span class="co">; Stage dependencies</span></span>
<span id="cb161-43"><a href="#cb161-43" aria-hidden="true" tabindex="-1"></a>   parallel-limit) <span class="co">; Max parallel tasks</span></span>
<span id="cb161-44"><a href="#cb161-44" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb161-45"><a href="#cb161-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-46"><a href="#cb161-46" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build result</span></span>
<span id="cb161-47"><a href="#cb161-47" aria-hidden="true" tabindex="-1"></a>(struct build-result</span>
<span id="cb161-48"><a href="#cb161-48" aria-hidden="true" tabindex="-1"></a>  (success?        <span class="co">; Build completed successfully?</span></span>
<span id="cb161-49"><a href="#cb161-49" aria-hidden="true" tabindex="-1"></a>   files-built     <span class="co">; Number of files generated</span></span>
<span id="cb161-50"><a href="#cb161-50" aria-hidden="true" tabindex="-1"></a>   time-taken      <span class="co">; Build duration</span></span>
<span id="cb161-51"><a href="#cb161-51" aria-hidden="true" tabindex="-1"></a>   errors          <span class="co">; List of errors</span></span>
<span id="cb161-52"><a href="#cb161-52" aria-hidden="true" tabindex="-1"></a>   warnings        <span class="co">; List of warnings</span></span>
<span id="cb161-53"><a href="#cb161-53" aria-hidden="true" tabindex="-1"></a>   statistics)     <span class="co">; Detailed statistics</span></span>
<span id="cb161-54"><a href="#cb161-54" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb161-55"><a href="#cb161-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-56"><a href="#cb161-56" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main build orchestrator</span></span>
<span id="cb161-57"><a href="#cb161-57" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-site config)</span>
<span id="cb161-58"><a href="#cb161-58" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> start-time </span>(current-inexact-milliseconds))</span>
<span id="cb161-59"><a href="#cb161-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb161-60"><a href="#cb161-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Initialize build context</span></span>
<span id="cb161-61"><a href="#cb161-61" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ctx </span>(initialize-build-context config))</span>
<span id="cb161-62"><a href="#cb161-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb161-63"><a href="#cb161-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create build pipeline</span></span>
<span id="cb161-64"><a href="#cb161-64" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> pipeline </span>(create-build-pipeline config))</span>
<span id="cb161-65"><a href="#cb161-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb161-66"><a href="#cb161-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Execute pipeline</span></span>
<span id="cb161-67"><a href="#cb161-67" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> success?</span></span>
<span id="cb161-68"><a href="#cb161-68" aria-hidden="true" tabindex="-1"></a>    (with-handlers (<span class="op">[</span>exn:fail? </span>
<span id="cb161-69"><a href="#cb161-69" aria-hidden="true" tabindex="-1"></a>                     (λ (e) </span>
<span id="cb161-70"><a href="#cb161-70" aria-hidden="true" tabindex="-1"></a>                       (add-build-error! ctx e)</span>
<span id="cb161-71"><a href="#cb161-71" aria-hidden="true" tabindex="-1"></a>                       <span class="dv">#f</span>)<span class="op">]</span>)</span>
<span id="cb161-72"><a href="#cb161-72" aria-hidden="true" tabindex="-1"></a>      (execute-pipeline pipeline ctx)))</span>
<span id="cb161-73"><a href="#cb161-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb161-74"><a href="#cb161-74" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate build result</span></span>
<span id="cb161-75"><a href="#cb161-75" aria-hidden="true" tabindex="-1"></a>  (build-result</span>
<span id="cb161-76"><a href="#cb161-76" aria-hidden="true" tabindex="-1"></a>   success?</span>
<span id="cb161-77"><a href="#cb161-77" aria-hidden="true" tabindex="-1"></a>   (hash-count (build-context-output-files ctx))</span>
<span id="cb161-78"><a href="#cb161-78" aria-hidden="true" tabindex="-1"></a>   (<span class="op">-</span> (current-inexact-milliseconds) start-time)</span>
<span id="cb161-79"><a href="#cb161-79" aria-hidden="true" tabindex="-1"></a>   (build-context-errors ctx)</span>
<span id="cb161-80"><a href="#cb161-80" aria-hidden="true" tabindex="-1"></a>   (build-context-warnings ctx)</span>
<span id="cb161-81"><a href="#cb161-81" aria-hidden="true" tabindex="-1"></a>   (build-context-stats ctx)))</span>
<span id="cb161-82"><a href="#cb161-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-83"><a href="#cb161-83" aria-hidden="true" tabindex="-1"></a><span class="co">;; Initialize build context</span></span>
<span id="cb161-84"><a href="#cb161-84" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(initialize-build-context config)</span>
<span id="cb161-85"><a href="#cb161-85" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> source-files </span>(discover-source-files config))</span>
<span id="cb161-86"><a href="#cb161-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb161-87"><a href="#cb161-87" aria-hidden="true" tabindex="-1"></a>  (build-context</span>
<span id="cb161-88"><a href="#cb161-88" aria-hidden="true" tabindex="-1"></a>   config</span>
<span id="cb161-89"><a href="#cb161-89" aria-hidden="true" tabindex="-1"></a>   source-files</span>
<span id="cb161-90"><a href="#cb161-90" aria-hidden="true" tabindex="-1"></a>   (make-hash)      <span class="co">; output-files</span></span>
<span id="cb161-91"><a href="#cb161-91" aria-hidden="true" tabindex="-1"></a>   (make-hash)      <span class="co">; dependencies</span></span>
<span id="cb161-92"><a href="#cb161-92" aria-hidden="true" tabindex="-1"></a>   (load-build-cache config)</span>
<span id="cb161-93"><a href="#cb161-93" aria-hidden="true" tabindex="-1"></a>   (make-build-stats)</span>
<span id="cb161-94"><a href="#cb161-94" aria-hidden="true" tabindex="-1"></a>   &#39;()              <span class="co">; errors</span></span>
<span id="cb161-95"><a href="#cb161-95" aria-hidden="true" tabindex="-1"></a>   &#39;()))            <span class="co">; warnings</span></span>
<span id="cb161-96"><a href="#cb161-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-97"><a href="#cb161-97" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create standard build pipeline</span></span>
<span id="cb161-98"><a href="#cb161-98" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(create-build-pipeline config)</span>
<span id="cb161-99"><a href="#cb161-99" aria-hidden="true" tabindex="-1"></a>  (build-pipeline</span>
<span id="cb161-100"><a href="#cb161-100" aria-hidden="true" tabindex="-1"></a>   &#39;main</span>
<span id="cb161-101"><a href="#cb161-101" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span></span>
<span id="cb161-102"><a href="#cb161-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Clean previous build</span></span>
<span id="cb161-103"><a href="#cb161-103" aria-hidden="true" tabindex="-1"></a>    (build-stage &#39;clean</span>
<span id="cb161-104"><a href="#cb161-104" aria-hidden="true" tabindex="-1"></a>                clean-output-directory</span>
<span id="cb161-105"><a href="#cb161-105" aria-hidden="true" tabindex="-1"></a>                (λ (f) <span class="dv">#t</span>)</span>
<span id="cb161-106"><a href="#cb161-106" aria-hidden="true" tabindex="-1"></a>                <span class="dv">#f</span></span>
<span id="cb161-107"><a href="#cb161-107" aria-hidden="true" tabindex="-1"></a>                &#39;()</span>
<span id="cb161-108"><a href="#cb161-108" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span>)</span>
<span id="cb161-109"><a href="#cb161-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-110"><a href="#cb161-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Copy static assets</span></span>
<span id="cb161-111"><a href="#cb161-111" aria-hidden="true" tabindex="-1"></a>    (build-stage &#39;assets</span>
<span id="cb161-112"><a href="#cb161-112" aria-hidden="true" tabindex="-1"></a>                copy-static-assets</span>
<span id="cb161-113"><a href="#cb161-113" aria-hidden="true" tabindex="-1"></a>                is-asset-file?</span>
<span id="cb161-114"><a href="#cb161-114" aria-hidden="true" tabindex="-1"></a>                &#39;asset</span>
<span id="cb161-115"><a href="#cb161-115" aria-hidden="true" tabindex="-1"></a>                &#39;(clean)</span>
<span id="cb161-116"><a href="#cb161-116" aria-hidden="true" tabindex="-1"></a>                <span class="dv">10</span>)</span>
<span id="cb161-117"><a href="#cb161-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-118"><a href="#cb161-118" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Process content files</span></span>
<span id="cb161-119"><a href="#cb161-119" aria-hidden="true" tabindex="-1"></a>    (build-stage &#39;content</span>
<span id="cb161-120"><a href="#cb161-120" aria-hidden="true" tabindex="-1"></a>                process-content-files</span>
<span id="cb161-121"><a href="#cb161-121" aria-hidden="true" tabindex="-1"></a>                is-content-file?</span>
<span id="cb161-122"><a href="#cb161-122" aria-hidden="true" tabindex="-1"></a>                &#39;document</span>
<span id="cb161-123"><a href="#cb161-123" aria-hidden="true" tabindex="-1"></a>                &#39;(clean)</span>
<span id="cb161-124"><a href="#cb161-124" aria-hidden="true" tabindex="-1"></a>                (processor-count))</span>
<span id="cb161-125"><a href="#cb161-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-126"><a href="#cb161-126" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Generate indices and feeds</span></span>
<span id="cb161-127"><a href="#cb161-127" aria-hidden="true" tabindex="-1"></a>    (build-stage &#39;indices</span>
<span id="cb161-128"><a href="#cb161-128" aria-hidden="true" tabindex="-1"></a>                generate-indices-and-feeds</span>
<span id="cb161-129"><a href="#cb161-129" aria-hidden="true" tabindex="-1"></a>                (λ (f) <span class="dv">#f</span>)  <span class="co">; No input files</span></span>
<span id="cb161-130"><a href="#cb161-130" aria-hidden="true" tabindex="-1"></a>                &#39;generated</span>
<span id="cb161-131"><a href="#cb161-131" aria-hidden="true" tabindex="-1"></a>                &#39;(content)</span>
<span id="cb161-132"><a href="#cb161-132" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span>)</span>
<span id="cb161-133"><a href="#cb161-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-134"><a href="#cb161-134" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Render output formats</span></span>
<span id="cb161-135"><a href="#cb161-135" aria-hidden="true" tabindex="-1"></a>    (build-stage &#39;render</span>
<span id="cb161-136"><a href="#cb161-136" aria-hidden="true" tabindex="-1"></a>                render-output-formats</span>
<span id="cb161-137"><a href="#cb161-137" aria-hidden="true" tabindex="-1"></a>                is-document?</span>
<span id="cb161-138"><a href="#cb161-138" aria-hidden="true" tabindex="-1"></a>                &#39;output</span>
<span id="cb161-139"><a href="#cb161-139" aria-hidden="true" tabindex="-1"></a>                &#39;(content indices)</span>
<span id="cb161-140"><a href="#cb161-140" aria-hidden="true" tabindex="-1"></a>                (processor-count))</span>
<span id="cb161-141"><a href="#cb161-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-142"><a href="#cb161-142" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Post-processing</span></span>
<span id="cb161-143"><a href="#cb161-143" aria-hidden="true" tabindex="-1"></a>    (build-stage &#39;post-process</span>
<span id="cb161-144"><a href="#cb161-144" aria-hidden="true" tabindex="-1"></a>                run-post-processors</span>
<span id="cb161-145"><a href="#cb161-145" aria-hidden="true" tabindex="-1"></a>                (λ (f) <span class="dv">#t</span>)</span>
<span id="cb161-146"><a href="#cb161-146" aria-hidden="true" tabindex="-1"></a>                &#39;final</span>
<span id="cb161-147"><a href="#cb161-147" aria-hidden="true" tabindex="-1"></a>                &#39;(render)</span>
<span id="cb161-148"><a href="#cb161-148" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span>))</span>
<span id="cb161-149"><a href="#cb161-149" aria-hidden="true" tabindex="-1"></a>   <span class="dv">#f</span>    <span class="co">; Sequential pipeline</span></span>
<span id="cb161-150"><a href="#cb161-150" aria-hidden="true" tabindex="-1"></a>   <span class="dv">#f</span>))  <span class="co">; Stop on error</span></span></code></pre></div>
<h2 id="dependency-tracking-and-incremental-builds">Dependency Tracking
and Incremental Builds</h2>
<p>Efficient rebuilds require sophisticated dependency tracking:</p>
<div class="sourceCode" id="cb162"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; dependency-graph.rkt</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>(require graph)</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>(provide dependency-graph</span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>         track-dependency!</span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>         get-dependencies</span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>         get-dependents</span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>         build-dependency-order)</span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Dependency graph wrapper</span></span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>(struct dependency-graph</span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>  (graph          <span class="co">; Directed graph structure</span></span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>   file-hashes    <span class="co">; File content hashes</span></span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a>   metadata)      <span class="co">; Additional tracking data</span></span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a>  #:mutable</span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create new dependency graph</span></span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-dependency-graph)</span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a>  (dependency-graph</span>
<span id="cb162-23"><a href="#cb162-23" aria-hidden="true" tabindex="-1"></a>   (unweighted-graph/directed &#39;())</span>
<span id="cb162-24"><a href="#cb162-24" aria-hidden="true" tabindex="-1"></a>   (make-hash)</span>
<span id="cb162-25"><a href="#cb162-25" aria-hidden="true" tabindex="-1"></a>   (make-hash)))</span>
<span id="cb162-26"><a href="#cb162-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-27"><a href="#cb162-27" aria-hidden="true" tabindex="-1"></a><span class="co">;; Track dependency between files</span></span>
<span id="cb162-28"><a href="#cb162-28" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(track-dependency! dep-graph source target reason)</span>
<span id="cb162-29"><a href="#cb162-29" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> g </span>(dependency-graph-graph dep-graph))</span>
<span id="cb162-30"><a href="#cb162-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-31"><a href="#cb162-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add vertices if needed</span></span>
<span id="cb162-32"><a href="#cb162-32" aria-hidden="true" tabindex="-1"></a>  (unless (has-vertex? g source)</span>
<span id="cb162-33"><a href="#cb162-33" aria-hidden="true" tabindex="-1"></a>    (add-vertex! g source))</span>
<span id="cb162-34"><a href="#cb162-34" aria-hidden="true" tabindex="-1"></a>  (unless (has-vertex? g target)</span>
<span id="cb162-35"><a href="#cb162-35" aria-hidden="true" tabindex="-1"></a>    (add-vertex! g target))</span>
<span id="cb162-36"><a href="#cb162-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-37"><a href="#cb162-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add edge with metadata</span></span>
<span id="cb162-38"><a href="#cb162-38" aria-hidden="true" tabindex="-1"></a>  (add-directed-edge! g source target reason))</span>
<span id="cb162-39"><a href="#cb162-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-40"><a href="#cb162-40" aria-hidden="true" tabindex="-1"></a><span class="co">;; Check if file needs rebuild</span></span>
<span id="cb162-41"><a href="#cb162-41" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(needs-rebuild? dep-graph file)</span>
<span id="cb162-42"><a href="#cb162-42" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span></span>
<span id="cb162-43"><a href="#cb162-43" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; File doesn&#39;t exist</span></span>
<span id="cb162-44"><a href="#cb162-44" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">not</span> (<span class="kw">file-exists?</span> (output-path file)))</span>
<span id="cb162-45"><a href="#cb162-45" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb162-46"><a href="#cb162-46" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Source file changed</span></span>
<span id="cb162-47"><a href="#cb162-47" aria-hidden="true" tabindex="-1"></a>   (file-content-changed? dep-graph file)</span>
<span id="cb162-48"><a href="#cb162-48" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb162-49"><a href="#cb162-49" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Any dependency changed</span></span>
<span id="cb162-50"><a href="#cb162-50" aria-hidden="true" tabindex="-1"></a>   (any-dependency-changed? dep-graph file)))</span>
<span id="cb162-51"><a href="#cb162-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-52"><a href="#cb162-52" aria-hidden="true" tabindex="-1"></a><span class="co">;; Check if file content changed</span></span>
<span id="cb162-53"><a href="#cb162-53" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(file-content-changed? dep-graph file)</span>
<span id="cb162-54"><a href="#cb162-54" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> stored-hash </span></span>
<span id="cb162-55"><a href="#cb162-55" aria-hidden="true" tabindex="-1"></a>    (hash-ref (dependency-graph-file-hashes dep-graph) file <span class="dv">#f</span>))</span>
<span id="cb162-56"><a href="#cb162-56" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> current-hash </span>(compute-file-hash file))</span>
<span id="cb162-57"><a href="#cb162-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-58"><a href="#cb162-58" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">or</span> (<span class="kw">not</span> stored-hash)</span>
<span id="cb162-59"><a href="#cb162-59" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">not</span> (<span class="kw">equal?</span> stored-hash current-hash))))</span>
<span id="cb162-60"><a href="#cb162-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-61"><a href="#cb162-61" aria-hidden="true" tabindex="-1"></a><span class="co">;; Get topological build order</span></span>
<span id="cb162-62"><a href="#cb162-62" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-dependency-order dep-graph files)</span>
<span id="cb162-63"><a href="#cb162-63" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> g </span>(dependency-graph-graph dep-graph))</span>
<span id="cb162-64"><a href="#cb162-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-65"><a href="#cb162-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create subgraph with only specified files</span></span>
<span id="cb162-66"><a href="#cb162-66" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> subgraph </span></span>
<span id="cb162-67"><a href="#cb162-67" aria-hidden="true" tabindex="-1"></a>    (filter-vertices g (λ (v) (<span class="kw">member</span> v files))))</span>
<span id="cb162-68"><a href="#cb162-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-69"><a href="#cb162-69" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Topological sort for build order</span></span>
<span id="cb162-70"><a href="#cb162-70" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> sorted </span>(topological-sort subgraph))</span>
<span id="cb162-71"><a href="#cb162-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-72"><a href="#cb162-72" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Group by dependency level for parallel builds</span></span>
<span id="cb162-73"><a href="#cb162-73" aria-hidden="true" tabindex="-1"></a>  (group-by-dependency-level subgraph sorted))</span>
<span id="cb162-74"><a href="#cb162-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-75"><a href="#cb162-75" aria-hidden="true" tabindex="-1"></a><span class="co">;; Incremental build analyzer</span></span>
<span id="cb162-76"><a href="#cb162-76" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(analyze-incremental-build ctx changed-files)</span>
<span id="cb162-77"><a href="#cb162-77" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dep-graph </span>(build-context-dependencies ctx))</span>
<span id="cb162-78"><a href="#cb162-78" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> affected </span>(make-hash))</span>
<span id="cb162-79"><a href="#cb162-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-80"><a href="#cb162-80" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Mark changed files</span></span>
<span id="cb162-81"><a href="#cb162-81" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>file changed-files<span class="op">]</span>)</span>
<span id="cb162-82"><a href="#cb162-82" aria-hidden="true" tabindex="-1"></a>    (hash-set! affected file &#39;source-changed))</span>
<span id="cb162-83"><a href="#cb162-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-84"><a href="#cb162-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Find affected dependents</span></span>
<span id="cb162-85"><a href="#cb162-85" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> to-check </span>(list-&gt;mutable-set changed-files))</span>
<span id="cb162-86"><a href="#cb162-86" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> checked </span>(make-hash))</span>
<span id="cb162-87"><a href="#cb162-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-88"><a href="#cb162-88" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> loop ()</span>
<span id="cb162-89"><a href="#cb162-89" aria-hidden="true" tabindex="-1"></a>    (unless (set-empty? to-check)</span>
<span id="cb162-90"><a href="#cb162-90" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> current </span>(set-first to-check))</span>
<span id="cb162-91"><a href="#cb162-91" aria-hidden="true" tabindex="-1"></a>      (set-remove! to-check current)</span>
<span id="cb162-92"><a href="#cb162-92" aria-hidden="true" tabindex="-1"></a>      (hash-set! checked current <span class="dv">#t</span>)</span>
<span id="cb162-93"><a href="#cb162-93" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb162-94"><a href="#cb162-94" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Get dependents</span></span>
<span id="cb162-95"><a href="#cb162-95" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> dependents </span>(get-dependents dep-graph current))</span>
<span id="cb162-96"><a href="#cb162-96" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb162-97"><a href="#cb162-97" aria-hidden="true" tabindex="-1"></a>      (for (<span class="op">[</span>dep dependents<span class="op">]</span>)</span>
<span id="cb162-98"><a href="#cb162-98" aria-hidden="true" tabindex="-1"></a>        (unless (hash-has-key? checked dep)</span>
<span id="cb162-99"><a href="#cb162-99" aria-hidden="true" tabindex="-1"></a>          (hash-set! affected dep &#39;dependency-changed)</span>
<span id="cb162-100"><a href="#cb162-100" aria-hidden="true" tabindex="-1"></a>          (set-add! to-check dep)))</span>
<span id="cb162-101"><a href="#cb162-101" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb162-102"><a href="#cb162-102" aria-hidden="true" tabindex="-1"></a>      (loop)))</span>
<span id="cb162-103"><a href="#cb162-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-104"><a href="#cb162-104" aria-hidden="true" tabindex="-1"></a>  affected)</span>
<span id="cb162-105"><a href="#cb162-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-106"><a href="#cb162-106" aria-hidden="true" tabindex="-1"></a><span class="co">;; Smart rebuild scheduler</span></span>
<span id="cb162-107"><a href="#cb162-107" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(schedule-rebuild ctx affected-files)</span>
<span id="cb162-108"><a href="#cb162-108" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dep-graph </span>(build-context-dependencies ctx))</span>
<span id="cb162-109"><a href="#cb162-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-110"><a href="#cb162-110" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Determine build order</span></span>
<span id="cb162-111"><a href="#cb162-111" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> build-order </span></span>
<span id="cb162-112"><a href="#cb162-112" aria-hidden="true" tabindex="-1"></a>    (build-dependency-order dep-graph (hash-keys affected-files)))</span>
<span id="cb162-113"><a href="#cb162-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-114"><a href="#cb162-114" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create build tasks</span></span>
<span id="cb162-115"><a href="#cb162-115" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[</span>level build-order<span class="op">]</span>)</span>
<span id="cb162-116"><a href="#cb162-116" aria-hidden="true" tabindex="-1"></a>    (build-task-group</span>
<span id="cb162-117"><a href="#cb162-117" aria-hidden="true" tabindex="-1"></a>     (for/list (<span class="op">[</span>file level<span class="op">]</span>)</span>
<span id="cb162-118"><a href="#cb162-118" aria-hidden="true" tabindex="-1"></a>       (build-task</span>
<span id="cb162-119"><a href="#cb162-119" aria-hidden="true" tabindex="-1"></a>        file</span>
<span id="cb162-120"><a href="#cb162-120" aria-hidden="true" tabindex="-1"></a>        (hash-ref affected-files file)</span>
<span id="cb162-121"><a href="#cb162-121" aria-hidden="true" tabindex="-1"></a>        (get-dependencies dep-graph file)</span>
<span id="cb162-122"><a href="#cb162-122" aria-hidden="true" tabindex="-1"></a>        (estimate-build-time file))))))</span></code></pre></div>
<h2 id="parallel-build-execution">Parallel Build Execution</h2>
<p>Maximize performance through intelligent parallelization:</p>
<div class="sourceCode" id="cb163"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; parallel-build.rkt</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>(require racket/place</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>         racket/future)</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>(provide parallel-build-manager</span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>         execute-parallel-build</span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>         build-worker)</span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parallel build manager</span></span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a>(struct parallel-build-manager</span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a>  (worker-count    <span class="co">; Number of worker processes</span></span>
<span id="cb163-14"><a href="#cb163-14" aria-hidden="true" tabindex="-1"></a>   task-queue      <span class="co">; Pending tasks</span></span>
<span id="cb163-15"><a href="#cb163-15" aria-hidden="true" tabindex="-1"></a>   active-tasks    <span class="co">; Currently executing</span></span>
<span id="cb163-16"><a href="#cb163-16" aria-hidden="true" tabindex="-1"></a>   completed       <span class="co">; Completed tasks</span></span>
<span id="cb163-17"><a href="#cb163-17" aria-hidden="true" tabindex="-1"></a>   place-channels) <span class="co">; Communication channels</span></span>
<span id="cb163-18"><a href="#cb163-18" aria-hidden="true" tabindex="-1"></a>  #:mutable</span>
<span id="cb163-19"><a href="#cb163-19" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb163-20"><a href="#cb163-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-21"><a href="#cb163-21" aria-hidden="true" tabindex="-1"></a><span class="co">;; Initialize parallel build system</span></span>
<span id="cb163-22"><a href="#cb163-22" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-parallel-build-manager <span class="op">[</span>worker-count (processor-count)<span class="op">]</span>)</span>
<span id="cb163-23"><a href="#cb163-23" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> channels</span></span>
<span id="cb163-24"><a href="#cb163-24" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>i (in-range worker-count)<span class="op">]</span>)</span>
<span id="cb163-25"><a href="#cb163-25" aria-hidden="true" tabindex="-1"></a>      (define-values (to-worker from-worker)</span>
<span id="cb163-26"><a href="#cb163-26" aria-hidden="true" tabindex="-1"></a>        (place-channel))</span>
<span id="cb163-27"><a href="#cb163-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb163-28"><a href="#cb163-28" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Start worker place</span></span>
<span id="cb163-29"><a href="#cb163-29" aria-hidden="true" tabindex="-1"></a>      (place/context ctx</span>
<span id="cb163-30"><a href="#cb163-30" aria-hidden="true" tabindex="-1"></a>        (build-worker from-worker to-worker))</span>
<span id="cb163-31"><a href="#cb163-31" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb163-32"><a href="#cb163-32" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">cons</span> to-worker from-worker)))</span>
<span id="cb163-33"><a href="#cb163-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-34"><a href="#cb163-34" aria-hidden="true" tabindex="-1"></a>  (parallel-build-manager</span>
<span id="cb163-35"><a href="#cb163-35" aria-hidden="true" tabindex="-1"></a>   worker-count</span>
<span id="cb163-36"><a href="#cb163-36" aria-hidden="true" tabindex="-1"></a>   (make-async-channel)</span>
<span id="cb163-37"><a href="#cb163-37" aria-hidden="true" tabindex="-1"></a>   (make-hash)</span>
<span id="cb163-38"><a href="#cb163-38" aria-hidden="true" tabindex="-1"></a>   (make-hash)</span>
<span id="cb163-39"><a href="#cb163-39" aria-hidden="true" tabindex="-1"></a>   channels))</span>
<span id="cb163-40"><a href="#cb163-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-41"><a href="#cb163-41" aria-hidden="true" tabindex="-1"></a><span class="co">;; Execute parallel build</span></span>
<span id="cb163-42"><a href="#cb163-42" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(execute-parallel-build manager tasks)</span>
<span id="cb163-43"><a href="#cb163-43" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> total-tasks </span>(<span class="kw">length</span> tasks))</span>
<span id="cb163-44"><a href="#cb163-44" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> completed </span><span class="dv">0</span>)</span>
<span id="cb163-45"><a href="#cb163-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-46"><a href="#cb163-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Queue all tasks</span></span>
<span id="cb163-47"><a href="#cb163-47" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>task tasks<span class="op">]</span>)</span>
<span id="cb163-48"><a href="#cb163-48" aria-hidden="true" tabindex="-1"></a>    (async-channel-put (parallel-build-manager-task-queue manager) task))</span>
<span id="cb163-49"><a href="#cb163-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-50"><a href="#cb163-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Process tasks</span></span>
<span id="cb163-51"><a href="#cb163-51" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> results</span></span>
<span id="cb163-52"><a href="#cb163-52" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[_</span> (in-range total-tasks)<span class="op">]</span>)</span>
<span id="cb163-53"><a href="#cb163-53" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Find available worker</span></span>
<span id="cb163-54"><a href="#cb163-54" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> worker-id </span>(find-available-worker manager))</span>
<span id="cb163-55"><a href="#cb163-55" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb163-56"><a href="#cb163-56" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Get next task</span></span>
<span id="cb163-57"><a href="#cb163-57" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> task </span>(async-channel-get </span>
<span id="cb163-58"><a href="#cb163-58" aria-hidden="true" tabindex="-1"></a>                   (parallel-build-manager-task-queue manager)))</span>
<span id="cb163-59"><a href="#cb163-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb163-60"><a href="#cb163-60" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Assign to worker</span></span>
<span id="cb163-61"><a href="#cb163-61" aria-hidden="true" tabindex="-1"></a>      (assign-task-to-worker manager worker-id task)</span>
<span id="cb163-62"><a href="#cb163-62" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb163-63"><a href="#cb163-63" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Collect result when ready</span></span>
<span id="cb163-64"><a href="#cb163-64" aria-hidden="true" tabindex="-1"></a>      (collect-worker-result manager)))</span>
<span id="cb163-65"><a href="#cb163-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-66"><a href="#cb163-66" aria-hidden="true" tabindex="-1"></a>  results)</span>
<span id="cb163-67"><a href="#cb163-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-68"><a href="#cb163-68" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build worker process</span></span>
<span id="cb163-69"><a href="#cb163-69" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-worker in-channel out-channel)</span>
<span id="cb163-70"><a href="#cb163-70" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> loop ()</span>
<span id="cb163-71"><a href="#cb163-71" aria-hidden="true" tabindex="-1"></a>    (match (place-channel-get in-channel)</span>
<span id="cb163-72"><a href="#cb163-72" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>&#39;shutdown (void)<span class="op">]</span></span>
<span id="cb163-73"><a href="#cb163-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb163-74"><a href="#cb163-74" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">list</span> &#39;build-file file options)</span>
<span id="cb163-75"><a href="#cb163-75" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> result</span></span>
<span id="cb163-76"><a href="#cb163-76" aria-hidden="true" tabindex="-1"></a>         (with-handlers (<span class="op">[</span>exn:fail? (λ (e) `(<span class="kw">error</span> ,file ,e))<span class="op">]</span>)</span>
<span id="cb163-77"><a href="#cb163-77" aria-hidden="true" tabindex="-1"></a>           (build-single-file file options)))</span>
<span id="cb163-78"><a href="#cb163-78" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb163-79"><a href="#cb163-79" aria-hidden="true" tabindex="-1"></a>       (place-channel-put out-channel `(complete ,file ,result))</span>
<span id="cb163-80"><a href="#cb163-80" aria-hidden="true" tabindex="-1"></a>       (loop)<span class="op">]</span></span>
<span id="cb163-81"><a href="#cb163-81" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb163-82"><a href="#cb163-82" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">list</span> &#39;process-content content-data)</span>
<span id="cb163-83"><a href="#cb163-83" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> result </span>(process-content-data content-data))</span>
<span id="cb163-84"><a href="#cb163-84" aria-hidden="true" tabindex="-1"></a>       (place-channel-put out-channel `(processed ,result))</span>
<span id="cb163-85"><a href="#cb163-85" aria-hidden="true" tabindex="-1"></a>       (loop)<span class="op">]</span>)))</span>
<span id="cb163-86"><a href="#cb163-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-87"><a href="#cb163-87" aria-hidden="true" tabindex="-1"></a><span class="co">;; Task batching for efficiency</span></span>
<span id="cb163-88"><a href="#cb163-88" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(batch-tasks tasks batch-size)</span>
<span id="cb163-89"><a href="#cb163-89" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> num-batches </span>(<span class="kw">ceiling</span> (<span class="op">/</span> (<span class="kw">length</span> tasks) batch-size)))</span>
<span id="cb163-90"><a href="#cb163-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-91"><a href="#cb163-91" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[</span>i (in-range num-batches)<span class="op">]</span>)</span>
<span id="cb163-92"><a href="#cb163-92" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> start </span>(<span class="op">*</span> i batch-size))</span>
<span id="cb163-93"><a href="#cb163-93" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> end </span>(<span class="kw">min</span> (<span class="op">*</span> (<span class="op">+</span> i <span class="dv">1</span>) batch-size) (<span class="kw">length</span> tasks)))</span>
<span id="cb163-94"><a href="#cb163-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb163-95"><a href="#cb163-95" aria-hidden="true" tabindex="-1"></a>    (task-batch</span>
<span id="cb163-96"><a href="#cb163-96" aria-hidden="true" tabindex="-1"></a>     i</span>
<span id="cb163-97"><a href="#cb163-97" aria-hidden="true" tabindex="-1"></a>     (sublist tasks start end)</span>
<span id="cb163-98"><a href="#cb163-98" aria-hidden="true" tabindex="-1"></a>     (estimate-batch-time (<span class="op">-</span> end start)))))</span>
<span id="cb163-99"><a href="#cb163-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-100"><a href="#cb163-100" aria-hidden="true" tabindex="-1"></a><span class="co">;; Adaptive load balancing</span></span>
<span id="cb163-101"><a href="#cb163-101" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(balance-workload manager)</span>
<span id="cb163-102"><a href="#cb163-102" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> worker-loads </span>(get-worker-loads manager))</span>
<span id="cb163-103"><a href="#cb163-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-104"><a href="#cb163-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Find overloaded and underloaded workers</span></span>
<span id="cb163-105"><a href="#cb163-105" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> avg-load </span>(<span class="op">/</span> (apply <span class="op">+</span> worker-loads) </span>
<span id="cb163-106"><a href="#cb163-106" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">length</span> worker-loads)))</span>
<span id="cb163-107"><a href="#cb163-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-108"><a href="#cb163-108" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> overloaded</span></span>
<span id="cb163-109"><a href="#cb163-109" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">filter</span> (λ (w) (<span class="op">&gt;</span> (second w) (<span class="op">*</span> avg-load <span class="fl">1.5</span>)))</span>
<span id="cb163-110"><a href="#cb163-110" aria-hidden="true" tabindex="-1"></a>            (enumerate worker-loads)))</span>
<span id="cb163-111"><a href="#cb163-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-112"><a href="#cb163-112" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> underloaded</span></span>
<span id="cb163-113"><a href="#cb163-113" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">filter</span> (λ (w) (<span class="op">&lt;</span> (second w) (<span class="op">*</span> avg-load <span class="fl">0.5</span>)))</span>
<span id="cb163-114"><a href="#cb163-114" aria-hidden="true" tabindex="-1"></a>            (enumerate worker-loads)))</span>
<span id="cb163-115"><a href="#cb163-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-116"><a href="#cb163-116" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Redistribute tasks</span></span>
<span id="cb163-117"><a href="#cb163-117" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>over overloaded<span class="op">]</span></span>
<span id="cb163-118"><a href="#cb163-118" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>under underloaded<span class="op">]</span>)</span>
<span id="cb163-119"><a href="#cb163-119" aria-hidden="true" tabindex="-1"></a>    (redistribute-tasks manager </span>
<span id="cb163-120"><a href="#cb163-120" aria-hidden="true" tabindex="-1"></a>                       (first over) </span>
<span id="cb163-121"><a href="#cb163-121" aria-hidden="true" tabindex="-1"></a>                       (first under))))</span></code></pre></div>
<h2 id="build-cache-system">Build Cache System</h2>
<p>Accelerate rebuilds with intelligent caching:</p>
<div class="sourceCode" id="cb164"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; build-cache.rkt</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>(require racket/serialize</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>         crypto)</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>(provide build-cache</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>         cache-get</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>         cache-put!</span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>         invalidate-cache!)</span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build cache structure</span></span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>(struct build-cache</span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>  (entries         <span class="co">; Hash of cache entries</span></span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a>   metadata        <span class="co">; Cache metadata</span></span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a>   stats)          <span class="co">; Usage statistics</span></span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a>  #:mutable</span>
<span id="cb164-18"><a href="#cb164-18" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb164-19"><a href="#cb164-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-20"><a href="#cb164-20" aria-hidden="true" tabindex="-1"></a><span class="co">;; Cache entry</span></span>
<span id="cb164-21"><a href="#cb164-21" aria-hidden="true" tabindex="-1"></a>(struct cache-entry</span>
<span id="cb164-22"><a href="#cb164-22" aria-hidden="true" tabindex="-1"></a>  (key            <span class="co">; Unique identifier</span></span>
<span id="cb164-23"><a href="#cb164-23" aria-hidden="true" tabindex="-1"></a>   value          <span class="co">; Cached data</span></span>
<span id="cb164-24"><a href="#cb164-24" aria-hidden="true" tabindex="-1"></a>   hash           <span class="co">; Content hash</span></span>
<span id="cb164-25"><a href="#cb164-25" aria-hidden="true" tabindex="-1"></a>   dependencies   <span class="co">; Dependency hashes</span></span>
<span id="cb164-26"><a href="#cb164-26" aria-hidden="true" tabindex="-1"></a>   timestamp      <span class="co">; Creation time</span></span>
<span id="cb164-27"><a href="#cb164-27" aria-hidden="true" tabindex="-1"></a>   hits)          <span class="co">; Access count</span></span>
<span id="cb164-28"><a href="#cb164-28" aria-hidden="true" tabindex="-1"></a>  #:mutable</span>
<span id="cb164-29"><a href="#cb164-29" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb164-30"><a href="#cb164-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-31"><a href="#cb164-31" aria-hidden="true" tabindex="-1"></a><span class="co">;; Load or create build cache</span></span>
<span id="cb164-32"><a href="#cb164-32" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(load-build-cache config)</span>
<span id="cb164-33"><a href="#cb164-33" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cache-path </span>(build-cache-path config))</span>
<span id="cb164-34"><a href="#cb164-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-35"><a href="#cb164-35" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="kw">file-exists?</span> cache-path)</span>
<span id="cb164-36"><a href="#cb164-36" aria-hidden="true" tabindex="-1"></a>      (deserialize-cache cache-path)</span>
<span id="cb164-37"><a href="#cb164-37" aria-hidden="true" tabindex="-1"></a>      (make-fresh-cache)))</span>
<span id="cb164-38"><a href="#cb164-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-39"><a href="#cb164-39" aria-hidden="true" tabindex="-1"></a><span class="co">;; Cache key generation</span></span>
<span id="cb164-40"><a href="#cb164-40" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-cache-key file operation options)</span>
<span id="cb164-41"><a href="#cb164-41" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> key-parts</span></span>
<span id="cb164-42"><a href="#cb164-42" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">list</span> (path-&gt;string file)</span>
<span id="cb164-43"><a href="#cb164-43" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">symbol-&gt;string</span> operation)</span>
<span id="cb164-44"><a href="#cb164-44" aria-hidden="true" tabindex="-1"></a>          (serialize-options options)))</span>
<span id="cb164-45"><a href="#cb164-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-46"><a href="#cb164-46" aria-hidden="true" tabindex="-1"></a>  (bytes-&gt;hex-string</span>
<span id="cb164-47"><a href="#cb164-47" aria-hidden="true" tabindex="-1"></a>   (sha256 (string-&gt;bytes/utf-8 </span>
<span id="cb164-48"><a href="#cb164-48" aria-hidden="true" tabindex="-1"></a>           (string-join key-parts <span class="st">&quot;:&quot;</span>)))))</span>
<span id="cb164-49"><a href="#cb164-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-50"><a href="#cb164-50" aria-hidden="true" tabindex="-1"></a><span class="co">;; Get from cache with validation</span></span>
<span id="cb164-51"><a href="#cb164-51" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(cache-get cache key validator)</span>
<span id="cb164-52"><a href="#cb164-52" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> entry </span>(hash-ref (build-cache-entries cache) key <span class="dv">#f</span>))</span>
<span id="cb164-53"><a href="#cb164-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-54"><a href="#cb164-54" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb164-55"><a href="#cb164-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">not</span> entry) <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb164-56"><a href="#cb164-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-57"><a href="#cb164-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Validate entry</span></span>
<span id="cb164-58"><a href="#cb164-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">not</span> (validate-cache-entry entry validator))</span>
<span id="cb164-59"><a href="#cb164-59" aria-hidden="true" tabindex="-1"></a>     (invalidate-cache-entry! cache key)</span>
<span id="cb164-60"><a href="#cb164-60" aria-hidden="true" tabindex="-1"></a>     <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb164-61"><a href="#cb164-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-62"><a href="#cb164-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Update statistics and return</span></span>
<span id="cb164-63"><a href="#cb164-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb164-64"><a href="#cb164-64" aria-hidden="true" tabindex="-1"></a>     (set-cache-entry-hits! entry (<span class="op">+</span> (cache-entry-hits entry) <span class="dv">1</span>))</span>
<span id="cb164-65"><a href="#cb164-65" aria-hidden="true" tabindex="-1"></a>     (update-cache-stats! cache &#39;hit)</span>
<span id="cb164-66"><a href="#cb164-66" aria-hidden="true" tabindex="-1"></a>     (cache-entry-value entry)<span class="op">]</span>))</span>
<span id="cb164-67"><a href="#cb164-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-68"><a href="#cb164-68" aria-hidden="true" tabindex="-1"></a><span class="co">;; Add to cache</span></span>
<span id="cb164-69"><a href="#cb164-69" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(cache-put! cache key value dependencies)</span>
<span id="cb164-70"><a href="#cb164-70" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> entry</span></span>
<span id="cb164-71"><a href="#cb164-71" aria-hidden="true" tabindex="-1"></a>    (cache-entry</span>
<span id="cb164-72"><a href="#cb164-72" aria-hidden="true" tabindex="-1"></a>     key</span>
<span id="cb164-73"><a href="#cb164-73" aria-hidden="true" tabindex="-1"></a>     value</span>
<span id="cb164-74"><a href="#cb164-74" aria-hidden="true" tabindex="-1"></a>     (compute-value-hash value)</span>
<span id="cb164-75"><a href="#cb164-75" aria-hidden="true" tabindex="-1"></a>     (map compute-value-hash dependencies)</span>
<span id="cb164-76"><a href="#cb164-76" aria-hidden="true" tabindex="-1"></a>     (current-seconds)</span>
<span id="cb164-77"><a href="#cb164-77" aria-hidden="true" tabindex="-1"></a>     <span class="dv">0</span>))</span>
<span id="cb164-78"><a href="#cb164-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-79"><a href="#cb164-79" aria-hidden="true" tabindex="-1"></a>  (hash-set! (build-cache-entries cache) key entry)</span>
<span id="cb164-80"><a href="#cb164-80" aria-hidden="true" tabindex="-1"></a>  (update-cache-stats! cache &#39;put))</span>
<span id="cb164-81"><a href="#cb164-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-82"><a href="#cb164-82" aria-hidden="true" tabindex="-1"></a><span class="co">;; Multi-level cache system</span></span>
<span id="cb164-83"><a href="#cb164-83" aria-hidden="true" tabindex="-1"></a>(struct multi-level-cache</span>
<span id="cb164-84"><a href="#cb164-84" aria-hidden="true" tabindex="-1"></a>  (memory-cache    <span class="co">; Fast in-memory cache</span></span>
<span id="cb164-85"><a href="#cb164-85" aria-hidden="true" tabindex="-1"></a>   disk-cache      <span class="co">; Persistent disk cache</span></span>
<span id="cb164-86"><a href="#cb164-86" aria-hidden="true" tabindex="-1"></a>   remote-cache)   <span class="co">; Optional distributed cache</span></span>
<span id="cb164-87"><a href="#cb164-87" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb164-88"><a href="#cb164-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-89"><a href="#cb164-89" aria-hidden="true" tabindex="-1"></a><span class="co">;; Memory cache with LRU eviction</span></span>
<span id="cb164-90"><a href="#cb164-90" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-memory-cache max-size)</span>
<span id="cb164-91"><a href="#cb164-91" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cache </span>(make-hash))</span>
<span id="cb164-92"><a href="#cb164-92" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> access-order </span>(make-hash))</span>
<span id="cb164-93"><a href="#cb164-93" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> access-counter </span><span class="dv">0</span>)</span>
<span id="cb164-94"><a href="#cb164-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-95"><a href="#cb164-95" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(get key)</span>
<span id="cb164-96"><a href="#cb164-96" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> value </span>(hash-ref cache key <span class="dv">#f</span>))</span>
<span id="cb164-97"><a href="#cb164-97" aria-hidden="true" tabindex="-1"></a>    (when value</span>
<span id="cb164-98"><a href="#cb164-98" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">set!</span> access-counter (<span class="op">+</span> access-counter <span class="dv">1</span>))</span>
<span id="cb164-99"><a href="#cb164-99" aria-hidden="true" tabindex="-1"></a>      (hash-set! access-order key access-counter))</span>
<span id="cb164-100"><a href="#cb164-100" aria-hidden="true" tabindex="-1"></a>    value)</span>
<span id="cb164-101"><a href="#cb164-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-102"><a href="#cb164-102" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(put! key value)</span>
<span id="cb164-103"><a href="#cb164-103" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Evict if needed</span></span>
<span id="cb164-104"><a href="#cb164-104" aria-hidden="true" tabindex="-1"></a>    (when (<span class="op">&gt;=</span> (hash-count cache) max-size)</span>
<span id="cb164-105"><a href="#cb164-105" aria-hidden="true" tabindex="-1"></a>      (evict-lru!))</span>
<span id="cb164-106"><a href="#cb164-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-107"><a href="#cb164-107" aria-hidden="true" tabindex="-1"></a>    (hash-set! cache key value)</span>
<span id="cb164-108"><a href="#cb164-108" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">set!</span> access-counter (<span class="op">+</span> access-counter <span class="dv">1</span>))</span>
<span id="cb164-109"><a href="#cb164-109" aria-hidden="true" tabindex="-1"></a>    (hash-set! access-order key access-counter))</span>
<span id="cb164-110"><a href="#cb164-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-111"><a href="#cb164-111" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(evict-lru!)</span>
<span id="cb164-112"><a href="#cb164-112" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> lru-key</span></span>
<span id="cb164-113"><a href="#cb164-113" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">car</span> (sort (hash-keys access-order)</span>
<span id="cb164-114"><a href="#cb164-114" aria-hidden="true" tabindex="-1"></a>                 (λ (a b)</span>
<span id="cb164-115"><a href="#cb164-115" aria-hidden="true" tabindex="-1"></a>                   (<span class="op">&lt;</span> (hash-ref access-order a)</span>
<span id="cb164-116"><a href="#cb164-116" aria-hidden="true" tabindex="-1"></a>                      (hash-ref access-order b))))))</span>
<span id="cb164-117"><a href="#cb164-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-118"><a href="#cb164-118" aria-hidden="true" tabindex="-1"></a>    (hash-remove! cache lru-key)</span>
<span id="cb164-119"><a href="#cb164-119" aria-hidden="true" tabindex="-1"></a>    (hash-remove! access-order lru-key))</span>
<span id="cb164-120"><a href="#cb164-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-121"><a href="#cb164-121" aria-hidden="true" tabindex="-1"></a>  (memory-cache-interface get put!))</span>
<span id="cb164-122"><a href="#cb164-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-123"><a href="#cb164-123" aria-hidden="true" tabindex="-1"></a><span class="co">;; Cache warming strategies</span></span>
<span id="cb164-124"><a href="#cb164-124" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(warm-cache cache config)</span>
<span id="cb164-125"><a href="#cb164-125" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> warmup-tasks</span></span>
<span id="cb164-126"><a href="#cb164-126" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">list</span></span>
<span id="cb164-127"><a href="#cb164-127" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Template compilation</span></span>
<span id="cb164-128"><a href="#cb164-128" aria-hidden="true" tabindex="-1"></a>     (λ () (warm-template-cache cache config))</span>
<span id="cb164-129"><a href="#cb164-129" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb164-130"><a href="#cb164-130" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Common document processing</span></span>
<span id="cb164-131"><a href="#cb164-131" aria-hidden="true" tabindex="-1"></a>     (λ () (warm-document-cache cache config))</span>
<span id="cb164-132"><a href="#cb164-132" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb164-133"><a href="#cb164-133" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Asset optimization</span></span>
<span id="cb164-134"><a href="#cb164-134" aria-hidden="true" tabindex="-1"></a>     (λ () (warm-asset-cache cache config))))</span>
<span id="cb164-135"><a href="#cb164-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-136"><a href="#cb164-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Execute warmup in parallel</span></span>
<span id="cb164-137"><a href="#cb164-137" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> futures</span></span>
<span id="cb164-138"><a href="#cb164-138" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>task warmup-tasks<span class="op">]</span>)</span>
<span id="cb164-139"><a href="#cb164-139" aria-hidden="true" tabindex="-1"></a>      (future task)))</span>
<span id="cb164-140"><a href="#cb164-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb164-141"><a href="#cb164-141" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Wait for completion</span></span>
<span id="cb164-142"><a href="#cb164-142" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>f futures<span class="op">]</span>)</span>
<span id="cb164-143"><a href="#cb164-143" aria-hidden="true" tabindex="-1"></a>    (touch f)))</span></code></pre></div>
<h2 id="file-watching-and-live-reload">File Watching and Live
Reload</h2>
<p>Enable rapid development with automatic rebuilds:</p>
<div class="sourceCode" id="cb165"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; file-watcher.rkt</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>(require racket/async-channel</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>         racket/tcp)</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>(provide file-watcher</span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>         start-watching</span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>         live-reload-server)</span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; File watcher configuration</span></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>(struct file-watcher</span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>  (directories     <span class="co">; Directories to watch</span></span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>   patterns        <span class="co">; File patterns to match</span></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>   ignore-patterns <span class="co">; Patterns to ignore</span></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>   callback        <span class="co">; Change callback</span></span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a>   debounce-ms     <span class="co">; Debounce period</span></span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a>   recursive?)     <span class="co">; Watch recursively?</span></span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a><span class="co">;; Start file watching</span></span>
<span id="cb165-22"><a href="#cb165-22" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(start-watching watcher)</span>
<span id="cb165-23"><a href="#cb165-23" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> change-channel </span>(make-async-channel))</span>
<span id="cb165-24"><a href="#cb165-24" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> watcher-thread</span></span>
<span id="cb165-25"><a href="#cb165-25" aria-hidden="true" tabindex="-1"></a>    (thread</span>
<span id="cb165-26"><a href="#cb165-26" aria-hidden="true" tabindex="-1"></a>     (λ ()</span>
<span id="cb165-27"><a href="#cb165-27" aria-hidden="true" tabindex="-1"></a>       (watch-loop watcher change-channel))))</span>
<span id="cb165-28"><a href="#cb165-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-29"><a href="#cb165-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Debounced callback</span></span>
<span id="cb165-30"><a href="#cb165-30" aria-hidden="true" tabindex="-1"></a>  (thread</span>
<span id="cb165-31"><a href="#cb165-31" aria-hidden="true" tabindex="-1"></a>   (λ ()</span>
<span id="cb165-32"><a href="#cb165-32" aria-hidden="true" tabindex="-1"></a>     (process-changes watcher change-channel)))</span>
<span id="cb165-33"><a href="#cb165-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-34"><a href="#cb165-34" aria-hidden="true" tabindex="-1"></a>  watcher-thread)</span>
<span id="cb165-35"><a href="#cb165-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-36"><a href="#cb165-36" aria-hidden="true" tabindex="-1"></a><span class="co">;; File watching implementation</span></span>
<span id="cb165-37"><a href="#cb165-37" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(watch-loop watcher change-channel)</span>
<span id="cb165-38"><a href="#cb165-38" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> watched-files </span>(make-hash))</span>
<span id="cb165-39"><a href="#cb165-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-40"><a href="#cb165-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Initial scan</span></span>
<span id="cb165-41"><a href="#cb165-41" aria-hidden="true" tabindex="-1"></a>  (scan-directories watcher watched-files)</span>
<span id="cb165-42"><a href="#cb165-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-43"><a href="#cb165-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Polling loop (cross-platform compatible)</span></span>
<span id="cb165-44"><a href="#cb165-44" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> loop ()</span>
<span id="cb165-45"><a href="#cb165-45" aria-hidden="true" tabindex="-1"></a>    (sleep <span class="fl">0.1</span>)  <span class="co">; Poll every 100ms</span></span>
<span id="cb165-46"><a href="#cb165-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-47"><a href="#cb165-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Check for changes</span></span>
<span id="cb165-48"><a href="#cb165-48" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> changes </span>(detect-changes watcher watched-files))</span>
<span id="cb165-49"><a href="#cb165-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-50"><a href="#cb165-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Send changes to processing thread</span></span>
<span id="cb165-51"><a href="#cb165-51" aria-hidden="true" tabindex="-1"></a>    (for (<span class="op">[</span>change changes<span class="op">]</span>)</span>
<span id="cb165-52"><a href="#cb165-52" aria-hidden="true" tabindex="-1"></a>      (async-channel-put change-channel change))</span>
<span id="cb165-53"><a href="#cb165-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-54"><a href="#cb165-54" aria-hidden="true" tabindex="-1"></a>    (loop)))</span>
<span id="cb165-55"><a href="#cb165-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-56"><a href="#cb165-56" aria-hidden="true" tabindex="-1"></a><span class="co">;; Detect file changes</span></span>
<span id="cb165-57"><a href="#cb165-57" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(detect-changes watcher watched-files)</span>
<span id="cb165-58"><a href="#cb165-58" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> changes </span>&#39;())</span>
<span id="cb165-59"><a href="#cb165-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-60"><a href="#cb165-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Scan current state</span></span>
<span id="cb165-61"><a href="#cb165-61" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> current-files </span>(scan-current-files watcher))</span>
<span id="cb165-62"><a href="#cb165-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-63"><a href="#cb165-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check for modifications and additions</span></span>
<span id="cb165-64"><a href="#cb165-64" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>(path info) (in-hash current-files)<span class="op">]</span>)</span>
<span id="cb165-65"><a href="#cb165-65" aria-hidden="true" tabindex="-1"></a>    (match (hash-ref watched-files path <span class="dv">#f</span>)</span>
<span id="cb165-66"><a href="#cb165-66" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="dv">#f</span>  <span class="co">; New file</span></span>
<span id="cb165-67"><a href="#cb165-67" aria-hidden="true" tabindex="-1"></a>       (hash-set! watched-files path info)</span>
<span id="cb165-68"><a href="#cb165-68" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> changes (<span class="kw">cons</span> (file-change &#39;created path info) changes))<span class="op">]</span></span>
<span id="cb165-69"><a href="#cb165-69" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb165-70"><a href="#cb165-70" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>old-info</span>
<span id="cb165-71"><a href="#cb165-71" aria-hidden="true" tabindex="-1"></a>       (when (<span class="op">&gt;</span> (file-info-mtime info) (file-info-mtime old-info))</span>
<span id="cb165-72"><a href="#cb165-72" aria-hidden="true" tabindex="-1"></a>         (hash-set! watched-files path info)</span>
<span id="cb165-73"><a href="#cb165-73" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">set!</span> changes (<span class="kw">cons</span> (file-change &#39;modified path info) changes)))<span class="op">]</span>))</span>
<span id="cb165-74"><a href="#cb165-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-75"><a href="#cb165-75" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check for deletions</span></span>
<span id="cb165-76"><a href="#cb165-76" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>(path info) (in-hash watched-files)<span class="op">]</span>)</span>
<span id="cb165-77"><a href="#cb165-77" aria-hidden="true" tabindex="-1"></a>    (unless (hash-has-key? current-files path)</span>
<span id="cb165-78"><a href="#cb165-78" aria-hidden="true" tabindex="-1"></a>      (hash-remove! watched-files path)</span>
<span id="cb165-79"><a href="#cb165-79" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">set!</span> changes (<span class="kw">cons</span> (file-change &#39;deleted path info) changes))))</span>
<span id="cb165-80"><a href="#cb165-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-81"><a href="#cb165-81" aria-hidden="true" tabindex="-1"></a>  changes)</span>
<span id="cb165-82"><a href="#cb165-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-83"><a href="#cb165-83" aria-hidden="true" tabindex="-1"></a><span class="co">;; Live reload server</span></span>
<span id="cb165-84"><a href="#cb165-84" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(start-live-reload-server port build-callback)</span>
<span id="cb165-85"><a href="#cb165-85" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> clients </span>(make-hash))</span>
<span id="cb165-86"><a href="#cb165-86" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> reload-script </span>(generate-reload-script port))</span>
<span id="cb165-87"><a href="#cb165-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-88"><a href="#cb165-88" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; WebSocket-like server</span></span>
<span id="cb165-89"><a href="#cb165-89" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> server-thread</span></span>
<span id="cb165-90"><a href="#cb165-90" aria-hidden="true" tabindex="-1"></a>    (thread</span>
<span id="cb165-91"><a href="#cb165-91" aria-hidden="true" tabindex="-1"></a>     (λ ()</span>
<span id="cb165-92"><a href="#cb165-92" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> listener </span>(tcp-listen port))</span>
<span id="cb165-93"><a href="#cb165-93" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb165-94"><a href="#cb165-94" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">let</span> accept-loop ()</span>
<span id="cb165-95"><a href="#cb165-95" aria-hidden="true" tabindex="-1"></a>         (define-values (in out) (tcp-accept listener))</span>
<span id="cb165-96"><a href="#cb165-96" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb165-97"><a href="#cb165-97" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Handle client</span></span>
<span id="cb165-98"><a href="#cb165-98" aria-hidden="true" tabindex="-1"></a>         (thread</span>
<span id="cb165-99"><a href="#cb165-99" aria-hidden="true" tabindex="-1"></a>          (λ ()</span>
<span id="cb165-100"><a href="#cb165-100" aria-hidden="true" tabindex="-1"></a>            (handle-live-reload-client in out clients)))</span>
<span id="cb165-101"><a href="#cb165-101" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb165-102"><a href="#cb165-102" aria-hidden="true" tabindex="-1"></a>         (accept-loop)))))</span>
<span id="cb165-103"><a href="#cb165-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-104"><a href="#cb165-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; File watcher integration</span></span>
<span id="cb165-105"><a href="#cb165-105" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> watcher</span></span>
<span id="cb165-106"><a href="#cb165-106" aria-hidden="true" tabindex="-1"></a>    (file-watcher</span>
<span id="cb165-107"><a href="#cb165-107" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">list</span> <span class="st">&quot;content&quot;</span> <span class="st">&quot;templates&quot;</span> <span class="st">&quot;assets&quot;</span>)</span>
<span id="cb165-108"><a href="#cb165-108" aria-hidden="true" tabindex="-1"></a>     &#39;(<span class="st">&quot;*.md&quot;</span> <span class="st">&quot;*.html&quot;</span> <span class="st">&quot;*.css&quot;</span> <span class="st">&quot;*.js&quot;</span>)</span>
<span id="cb165-109"><a href="#cb165-109" aria-hidden="true" tabindex="-1"></a>     &#39;(<span class="st">&quot;*.tmp&quot;</span> <span class="st">&quot;.git/*&quot;</span> <span class="st">&quot;node_modules/*&quot;</span>)</span>
<span id="cb165-110"><a href="#cb165-110" aria-hidden="true" tabindex="-1"></a>     (λ (changes)</span>
<span id="cb165-111"><a href="#cb165-111" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Rebuild affected files</span></span>
<span id="cb165-112"><a href="#cb165-112" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> rebuilt </span>(build-callback changes))</span>
<span id="cb165-113"><a href="#cb165-113" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb165-114"><a href="#cb165-114" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Notify clients</span></span>
<span id="cb165-115"><a href="#cb165-115" aria-hidden="true" tabindex="-1"></a>       (broadcast-reload clients rebuilt))</span>
<span id="cb165-116"><a href="#cb165-116" aria-hidden="true" tabindex="-1"></a>     <span class="dv">200</span>  <span class="co">; 200ms debounce</span></span>
<span id="cb165-117"><a href="#cb165-117" aria-hidden="true" tabindex="-1"></a>     <span class="dv">#t</span>)) <span class="co">; Recursive</span></span>
<span id="cb165-118"><a href="#cb165-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-119"><a href="#cb165-119" aria-hidden="true" tabindex="-1"></a>  (start-watching watcher)</span>
<span id="cb165-120"><a href="#cb165-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-121"><a href="#cb165-121" aria-hidden="true" tabindex="-1"></a>  (live-reload-info server-thread reload-script))</span>
<span id="cb165-122"><a href="#cb165-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-123"><a href="#cb165-123" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate client-side reload script</span></span>
<span id="cb165-124"><a href="#cb165-124" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-reload-script port)</span>
<span id="cb165-125"><a href="#cb165-125" aria-hidden="true" tabindex="-1"></a>  (format <span class="st">#&lt;&lt;SCRIPT</span></span>
<span id="cb165-126"><a href="#cb165-126" aria-hidden="true" tabindex="-1"></a><span class="ot">(function() {</span></span>
<span id="cb165-127"><a href="#cb165-127" aria-hidden="true" tabindex="-1"></a><span class="ot">  var ws = new WebSocket(&#39;ws://localhost:~a/livereload&#39;);</span></span>
<span id="cb165-128"><a href="#cb165-128" aria-hidden="true" tabindex="-1"></a><span class="ot">  var reconnectInterval = 1000;</span></span>
<span id="cb165-129"><a href="#cb165-129" aria-hidden="true" tabindex="-1"></a><span class="ot">  </span></span>
<span id="cb165-130"><a href="#cb165-130" aria-hidden="true" tabindex="-1"></a><span class="ot">  function connect() {</span></span>
<span id="cb165-131"><a href="#cb165-131" aria-hidden="true" tabindex="-1"></a><span class="ot">    ws = new WebSocket(&#39;ws://localhost:~a/livereload&#39;);</span></span>
<span id="cb165-132"><a href="#cb165-132" aria-hidden="true" tabindex="-1"></a><span class="ot">    </span></span>
<span id="cb165-133"><a href="#cb165-133" aria-hidden="true" tabindex="-1"></a><span class="ot">    ws.onopen = function() {</span></span>
<span id="cb165-134"><a href="#cb165-134" aria-hidden="true" tabindex="-1"></a><span class="ot">      console.log(&#39;Live reload connected&#39;);</span></span>
<span id="cb165-135"><a href="#cb165-135" aria-hidden="true" tabindex="-1"></a><span class="ot">      reconnectInterval = 1000;</span></span>
<span id="cb165-136"><a href="#cb165-136" aria-hidden="true" tabindex="-1"></a><span class="ot">    };</span></span>
<span id="cb165-137"><a href="#cb165-137" aria-hidden="true" tabindex="-1"></a><span class="ot">    </span></span>
<span id="cb165-138"><a href="#cb165-138" aria-hidden="true" tabindex="-1"></a><span class="ot">    ws.onmessage = function(event) {</span></span>
<span id="cb165-139"><a href="#cb165-139" aria-hidden="true" tabindex="-1"></a><span class="ot">      var data = JSON.parse(event.data);</span></span>
<span id="cb165-140"><a href="#cb165-140" aria-hidden="true" tabindex="-1"></a><span class="ot">      </span></span>
<span id="cb165-141"><a href="#cb165-141" aria-hidden="true" tabindex="-1"></a><span class="ot">      if (data.command === &#39;reload&#39;) {</span></span>
<span id="cb165-142"><a href="#cb165-142" aria-hidden="true" tabindex="-1"></a><span class="ot">        if (data.path &amp;&amp; data.path.endsWith(&#39;.css&#39;)) {</span></span>
<span id="cb165-143"><a href="#cb165-143" aria-hidden="true" tabindex="-1"></a><span class="ot">          // Hot reload CSS</span></span>
<span id="cb165-144"><a href="#cb165-144" aria-hidden="true" tabindex="-1"></a><span class="ot">          reloadCSS(data.path);</span></span>
<span id="cb165-145"><a href="#cb165-145" aria-hidden="true" tabindex="-1"></a><span class="ot">        } else {</span></span>
<span id="cb165-146"><a href="#cb165-146" aria-hidden="true" tabindex="-1"></a><span class="ot">          // Full page reload</span></span>
<span id="cb165-147"><a href="#cb165-147" aria-hidden="true" tabindex="-1"></a><span class="ot">          location.reload();</span></span>
<span id="cb165-148"><a href="#cb165-148" aria-hidden="true" tabindex="-1"></a><span class="ot">        }</span></span>
<span id="cb165-149"><a href="#cb165-149" aria-hidden="true" tabindex="-1"></a><span class="ot">      }</span></span>
<span id="cb165-150"><a href="#cb165-150" aria-hidden="true" tabindex="-1"></a><span class="ot">    };</span></span>
<span id="cb165-151"><a href="#cb165-151" aria-hidden="true" tabindex="-1"></a><span class="ot">    </span></span>
<span id="cb165-152"><a href="#cb165-152" aria-hidden="true" tabindex="-1"></a><span class="ot">    ws.onclose = function() {</span></span>
<span id="cb165-153"><a href="#cb165-153" aria-hidden="true" tabindex="-1"></a><span class="ot">      setTimeout(connect, reconnectInterval);</span></span>
<span id="cb165-154"><a href="#cb165-154" aria-hidden="true" tabindex="-1"></a><span class="ot">      reconnectInterval = Math.min(reconnectInterval * 2, 30000);</span></span>
<span id="cb165-155"><a href="#cb165-155" aria-hidden="true" tabindex="-1"></a><span class="ot">    };</span></span>
<span id="cb165-156"><a href="#cb165-156" aria-hidden="true" tabindex="-1"></a><span class="ot">  }</span></span>
<span id="cb165-157"><a href="#cb165-157" aria-hidden="true" tabindex="-1"></a><span class="ot">  </span></span>
<span id="cb165-158"><a href="#cb165-158" aria-hidden="true" tabindex="-1"></a><span class="ot">  function reloadCSS(path) {</span></span>
<span id="cb165-159"><a href="#cb165-159" aria-hidden="true" tabindex="-1"></a><span class="ot">    var links = document.querySelectorAll(&#39;link[rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="ot">]&#39;);</span></span>
<span id="cb165-160"><a href="#cb165-160" aria-hidden="true" tabindex="-1"></a><span class="ot">    var found = false;</span></span>
<span id="cb165-161"><a href="#cb165-161" aria-hidden="true" tabindex="-1"></a><span class="ot">    </span></span>
<span id="cb165-162"><a href="#cb165-162" aria-hidden="true" tabindex="-1"></a><span class="ot">    links.forEach(function(link) {</span></span>
<span id="cb165-163"><a href="#cb165-163" aria-hidden="true" tabindex="-1"></a><span class="ot">      var href = link.href;</span></span>
<span id="cb165-164"><a href="#cb165-164" aria-hidden="true" tabindex="-1"></a><span class="ot">      if (href.includes(path)) {</span></span>
<span id="cb165-165"><a href="#cb165-165" aria-hidden="true" tabindex="-1"></a><span class="ot">        link.href = href.split(&#39;?&#39;)[0] + &#39;?reload=</span><span class="st">&#39; + Date.now();</span></span>
<span id="cb165-166"><a href="#cb165-166" aria-hidden="true" tabindex="-1"></a><span class="st">        found = true;</span></span>
<span id="cb165-167"><a href="#cb165-167" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb165-168"><a href="#cb165-168" aria-hidden="true" tabindex="-1"></a><span class="st">    });</span></span>
<span id="cb165-169"><a href="#cb165-169" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb165-170"><a href="#cb165-170" aria-hidden="true" tabindex="-1"></a><span class="st">    if (found) {</span></span>
<span id="cb165-171"><a href="#cb165-171" aria-hidden="true" tabindex="-1"></a><span class="st">      console.log(&#39;</span><span class="ot">Reloaded CSS: &#39; + path);</span></span>
<span id="cb165-172"><a href="#cb165-172" aria-hidden="true" tabindex="-1"></a><span class="ot">    }</span></span>
<span id="cb165-173"><a href="#cb165-173" aria-hidden="true" tabindex="-1"></a><span class="ot">  }</span></span>
<span id="cb165-174"><a href="#cb165-174" aria-hidden="true" tabindex="-1"></a><span class="ot">  </span></span>
<span id="cb165-175"><a href="#cb165-175" aria-hidden="true" tabindex="-1"></a><span class="ot">  connect();</span></span>
<span id="cb165-176"><a href="#cb165-176" aria-hidden="true" tabindex="-1"></a><span class="ot">})();</span></span>
<span id="cb165-177"><a href="#cb165-177" aria-hidden="true" tabindex="-1"></a><span class="ot">SCRIPT</span></span>
<span id="cb165-178"><a href="#cb165-178" aria-hidden="true" tabindex="-1"></a><span class="ot">    port port))</span></span></code></pre></div>
<h2 id="build-statistics-and-reporting">Build Statistics and
Reporting</h2>
<p>Track and visualize build performance:</p>
<div class="sourceCode" id="cb166"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; build-stats.rkt</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>(require plot)</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>(provide build-statistics</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>         collect-stats</span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>         generate-report)</span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build statistics collector</span></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>(struct build-statistics</span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>  (start-time      <span class="co">; Build start time</span></span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>   end-time        <span class="co">; Build end time</span></span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a>   file-counts     <span class="co">; Files processed by type</span></span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a>   stage-timings   <span class="co">; Time per build stage</span></span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a>   memory-usage    <span class="co">; Memory usage samples</span></span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a>   cache-stats     <span class="co">; Cache hit/miss rates</span></span>
<span id="cb166-18"><a href="#cb166-18" aria-hidden="true" tabindex="-1"></a>   error-count     <span class="co">; Number of errors</span></span>
<span id="cb166-19"><a href="#cb166-19" aria-hidden="true" tabindex="-1"></a>   warning-count)  <span class="co">; Number of warnings</span></span>
<span id="cb166-20"><a href="#cb166-20" aria-hidden="true" tabindex="-1"></a>  #:mutable</span>
<span id="cb166-21"><a href="#cb166-21" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb166-22"><a href="#cb166-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-23"><a href="#cb166-23" aria-hidden="true" tabindex="-1"></a><span class="co">;; Collect build statistics</span></span>
<span id="cb166-24"><a href="#cb166-24" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(collect-build-stats ctx)</span>
<span id="cb166-25"><a href="#cb166-25" aria-hidden="true" tabindex="-1"></a>  (build-statistics</span>
<span id="cb166-26"><a href="#cb166-26" aria-hidden="true" tabindex="-1"></a>   (build-context-start-time ctx)</span>
<span id="cb166-27"><a href="#cb166-27" aria-hidden="true" tabindex="-1"></a>   (current-inexact-milliseconds)</span>
<span id="cb166-28"><a href="#cb166-28" aria-hidden="true" tabindex="-1"></a>   (count-files-by-type ctx)</span>
<span id="cb166-29"><a href="#cb166-29" aria-hidden="true" tabindex="-1"></a>   (collect-stage-timings ctx)</span>
<span id="cb166-30"><a href="#cb166-30" aria-hidden="true" tabindex="-1"></a>   (collect-memory-usage ctx)</span>
<span id="cb166-31"><a href="#cb166-31" aria-hidden="true" tabindex="-1"></a>   (collect-cache-stats ctx)</span>
<span id="cb166-32"><a href="#cb166-32" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">length</span> (build-context-errors ctx))</span>
<span id="cb166-33"><a href="#cb166-33" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">length</span> (build-context-warnings ctx))))</span>
<span id="cb166-34"><a href="#cb166-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-35"><a href="#cb166-35" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate build report</span></span>
<span id="cb166-36"><a href="#cb166-36" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-build-report stats output-path)</span>
<span id="cb166-37"><a href="#cb166-37" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> report</span></span>
<span id="cb166-38"><a href="#cb166-38" aria-hidden="true" tabindex="-1"></a>    `(html</span>
<span id="cb166-39"><a href="#cb166-39" aria-hidden="true" tabindex="-1"></a>      (head</span>
<span id="cb166-40"><a href="#cb166-40" aria-hidden="true" tabindex="-1"></a>       (title <span class="st">&quot;Build Report&quot;</span>)</span>
<span id="cb166-41"><a href="#cb166-41" aria-hidden="true" tabindex="-1"></a>       (style ,report-css))</span>
<span id="cb166-42"><a href="#cb166-42" aria-hidden="true" tabindex="-1"></a>      (body</span>
<span id="cb166-43"><a href="#cb166-43" aria-hidden="true" tabindex="-1"></a>       (h1 <span class="st">&quot;Build Report&quot;</span>)</span>
<span id="cb166-44"><a href="#cb166-44" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb166-45"><a href="#cb166-45" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Summary section</span></span>
<span id="cb166-46"><a href="#cb166-46" aria-hidden="true" tabindex="-1"></a>       ,(generate-summary-section stats)</span>
<span id="cb166-47"><a href="#cb166-47" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb166-48"><a href="#cb166-48" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Performance charts</span></span>
<span id="cb166-49"><a href="#cb166-49" aria-hidden="true" tabindex="-1"></a>       ,(generate-performance-charts stats)</span>
<span id="cb166-50"><a href="#cb166-50" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb166-51"><a href="#cb166-51" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Detailed timings</span></span>
<span id="cb166-52"><a href="#cb166-52" aria-hidden="true" tabindex="-1"></a>       ,(generate-timing-table stats)</span>
<span id="cb166-53"><a href="#cb166-53" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb166-54"><a href="#cb166-54" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Memory usage</span></span>
<span id="cb166-55"><a href="#cb166-55" aria-hidden="true" tabindex="-1"></a>       ,(generate-memory-chart stats)</span>
<span id="cb166-56"><a href="#cb166-56" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb166-57"><a href="#cb166-57" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Cache effectiveness</span></span>
<span id="cb166-58"><a href="#cb166-58" aria-hidden="true" tabindex="-1"></a>       ,(generate-cache-report stats)</span>
<span id="cb166-59"><a href="#cb166-59" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb166-60"><a href="#cb166-60" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Errors and warnings</span></span>
<span id="cb166-61"><a href="#cb166-61" aria-hidden="true" tabindex="-1"></a>       ,(generate-issues-section stats))))</span>
<span id="cb166-62"><a href="#cb166-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-63"><a href="#cb166-63" aria-hidden="true" tabindex="-1"></a>  (write-html-file output-path report))</span>
<span id="cb166-64"><a href="#cb166-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-65"><a href="#cb166-65" aria-hidden="true" tabindex="-1"></a><span class="co">;; Performance visualization</span></span>
<span id="cb166-66"><a href="#cb166-66" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-performance-charts stats)</span>
<span id="cb166-67"><a href="#cb166-67" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> timings </span>(build-statistics-stage-timings stats))</span>
<span id="cb166-68"><a href="#cb166-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-69"><a href="#cb166-69" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Stage timing pie chart</span></span>
<span id="cb166-70"><a href="#cb166-70" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> stage-plot</span></span>
<span id="cb166-71"><a href="#cb166-71" aria-hidden="true" tabindex="-1"></a>    (plot-file</span>
<span id="cb166-72"><a href="#cb166-72" aria-hidden="true" tabindex="-1"></a>     (pie-slices</span>
<span id="cb166-73"><a href="#cb166-73" aria-hidden="true" tabindex="-1"></a>      (map (λ (stage)</span>
<span id="cb166-74"><a href="#cb166-74" aria-hidden="true" tabindex="-1"></a>             (pie-slice</span>
<span id="cb166-75"><a href="#cb166-75" aria-hidden="true" tabindex="-1"></a>              (<span class="op">*</span> (<span class="op">/</span> (<span class="kw">cdr</span> stage) (total-time stats)) <span class="dv">360</span>)</span>
<span id="cb166-76"><a href="#cb166-76" aria-hidden="true" tabindex="-1"></a>              (<span class="kw">car</span> stage)</span>
<span id="cb166-77"><a href="#cb166-77" aria-hidden="true" tabindex="-1"></a>              #:color (stage-color (<span class="kw">car</span> stage))))</span>
<span id="cb166-78"><a href="#cb166-78" aria-hidden="true" tabindex="-1"></a>           timings))</span>
<span id="cb166-79"><a href="#cb166-79" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;build-stages.png&quot;</span></span>
<span id="cb166-80"><a href="#cb166-80" aria-hidden="true" tabindex="-1"></a>     #:width <span class="dv">400</span></span>
<span id="cb166-81"><a href="#cb166-81" aria-hidden="true" tabindex="-1"></a>     #:height <span class="dv">300</span>))</span>
<span id="cb166-82"><a href="#cb166-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-83"><a href="#cb166-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; File processing bar chart</span></span>
<span id="cb166-84"><a href="#cb166-84" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> file-plot</span></span>
<span id="cb166-85"><a href="#cb166-85" aria-hidden="true" tabindex="-1"></a>    (plot-file</span>
<span id="cb166-86"><a href="#cb166-86" aria-hidden="true" tabindex="-1"></a>     (discrete-histogram</span>
<span id="cb166-87"><a href="#cb166-87" aria-hidden="true" tabindex="-1"></a>      (hash-&gt;list (build-statistics-file-counts stats))</span>
<span id="cb166-88"><a href="#cb166-88" aria-hidden="true" tabindex="-1"></a>      #:color <span class="st">&quot;blue&quot;</span></span>
<span id="cb166-89"><a href="#cb166-89" aria-hidden="true" tabindex="-1"></a>      #:line-color <span class="st">&quot;darkblue&quot;</span>)</span>
<span id="cb166-90"><a href="#cb166-90" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;file-counts.png&quot;</span></span>
<span id="cb166-91"><a href="#cb166-91" aria-hidden="true" tabindex="-1"></a>     #:width <span class="dv">500</span></span>
<span id="cb166-92"><a href="#cb166-92" aria-hidden="true" tabindex="-1"></a>     #:height <span class="dv">300</span></span>
<span id="cb166-93"><a href="#cb166-93" aria-hidden="true" tabindex="-1"></a>     #:x-label <span class="st">&quot;File Type&quot;</span></span>
<span id="cb166-94"><a href="#cb166-94" aria-hidden="true" tabindex="-1"></a>     #:y-label <span class="st">&quot;Count&quot;</span>))</span>
<span id="cb166-95"><a href="#cb166-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-96"><a href="#cb166-96" aria-hidden="true" tabindex="-1"></a>  `(<span class="kw">div</span> ((class <span class="st">&quot;performance-charts&quot;</span>))</span>
<span id="cb166-97"><a href="#cb166-97" aria-hidden="true" tabindex="-1"></a>     (h2 <span class="st">&quot;Performance Analysis&quot;</span>)</span>
<span id="cb166-98"><a href="#cb166-98" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">div</span> ((class <span class="st">&quot;chart&quot;</span>))</span>
<span id="cb166-99"><a href="#cb166-99" aria-hidden="true" tabindex="-1"></a>          (img ((src <span class="st">&quot;build-stages.png&quot;</span>)</span>
<span id="cb166-100"><a href="#cb166-100" aria-hidden="true" tabindex="-1"></a>                (alt <span class="st">&quot;Build stages timing&quot;</span>))))</span>
<span id="cb166-101"><a href="#cb166-101" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">div</span> ((class <span class="st">&quot;chart&quot;</span>))</span>
<span id="cb166-102"><a href="#cb166-102" aria-hidden="true" tabindex="-1"></a>          (img ((src <span class="st">&quot;file-counts.png&quot;</span>)</span>
<span id="cb166-103"><a href="#cb166-103" aria-hidden="true" tabindex="-1"></a>                (alt <span class="st">&quot;Files processed&quot;</span>))))))</span>
<span id="cb166-104"><a href="#cb166-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-105"><a href="#cb166-105" aria-hidden="true" tabindex="-1"></a><span class="co">;; Console progress reporter</span></span>
<span id="cb166-106"><a href="#cb166-106" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-progress-reporter total-items)</span>
<span id="cb166-107"><a href="#cb166-107" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> current </span><span class="dv">0</span>)</span>
<span id="cb166-108"><a href="#cb166-108" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> start-time </span>(current-inexact-milliseconds))</span>
<span id="cb166-109"><a href="#cb166-109" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> last-update </span><span class="dv">0</span>)</span>
<span id="cb166-110"><a href="#cb166-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb166-111"><a href="#cb166-111" aria-hidden="true" tabindex="-1"></a>  (λ (item status)</span>
<span id="cb166-112"><a href="#cb166-112" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">set!</span> current (<span class="op">+</span> current <span class="dv">1</span>))</span>
<span id="cb166-113"><a href="#cb166-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-114"><a href="#cb166-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Update every 100ms or on completion</span></span>
<span id="cb166-115"><a href="#cb166-115" aria-hidden="true" tabindex="-1"></a>    (when (<span class="kw">or</span> (<span class="op">=</span> current total-items)</span>
<span id="cb166-116"><a href="#cb166-116" aria-hidden="true" tabindex="-1"></a>              (<span class="op">&gt;</span> (<span class="op">-</span> (current-inexact-milliseconds) last-update) <span class="dv">100</span>))</span>
<span id="cb166-117"><a href="#cb166-117" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">set!</span> last-update (current-inexact-milliseconds))</span>
<span id="cb166-118"><a href="#cb166-118" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb166-119"><a href="#cb166-119" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> progress </span>(<span class="op">*</span> <span class="fl">100.0</span> (<span class="op">/</span> current total-items)))</span>
<span id="cb166-120"><a href="#cb166-120" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> elapsed </span>(<span class="op">/</span> (<span class="op">-</span> (current-inexact-milliseconds) start-time) <span class="dv">1000</span>))</span>
<span id="cb166-121"><a href="#cb166-121" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> rate </span>(<span class="op">/</span> current elapsed))</span>
<span id="cb166-122"><a href="#cb166-122" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> eta </span>(<span class="op">/</span> (<span class="op">-</span> total-items current) rate))</span>
<span id="cb166-123"><a href="#cb166-123" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb166-124"><a href="#cb166-124" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Clear line and print progress</span></span>
<span id="cb166-125"><a href="#cb166-125" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">display</span> <span class="st">&quot;</span><span class="ch">\r</span><span class="st">&quot;</span>)</span>
<span id="cb166-126"><a href="#cb166-126" aria-hidden="true" tabindex="-1"></a>      (printf <span class="st">&quot;[~a~a] ~a% (~a/~a) ~a/s ETA: ~as    &quot;</span></span>
<span id="cb166-127"><a href="#cb166-127" aria-hidden="true" tabindex="-1"></a>              (<span class="kw">make-string</span> (<span class="kw">floor</span> (<span class="op">/</span> progress <span class="dv">2</span>)) <span class="ch">#\=</span>)</span>
<span id="cb166-128"><a href="#cb166-128" aria-hidden="true" tabindex="-1"></a>              (<span class="kw">make-string</span> (<span class="op">-</span> <span class="dv">50</span> (<span class="kw">floor</span> (<span class="op">/</span> progress <span class="dv">2</span>))) <span class="ch">#\</span><span class="er">space</span>)</span>
<span id="cb166-129"><a href="#cb166-129" aria-hidden="true" tabindex="-1"></a>              (~r progress #:precision <span class="dv">1</span>)</span>
<span id="cb166-130"><a href="#cb166-130" aria-hidden="true" tabindex="-1"></a>              current</span>
<span id="cb166-131"><a href="#cb166-131" aria-hidden="true" tabindex="-1"></a>              total-items</span>
<span id="cb166-132"><a href="#cb166-132" aria-hidden="true" tabindex="-1"></a>              (~r rate #:precision <span class="dv">1</span>)</span>
<span id="cb166-133"><a href="#cb166-133" aria-hidden="true" tabindex="-1"></a>              (~r eta #:precision <span class="dv">0</span>))</span>
<span id="cb166-134"><a href="#cb166-134" aria-hidden="true" tabindex="-1"></a>      (flush-output))))</span></code></pre></div>
<h2 id="testing-the-build-engine">Testing the Build Engine</h2>
<p>Comprehensive tests ensure build reliability:</p>
<div class="sourceCode" id="cb167"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; build-engine-tests.rkt</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>(require rackunit</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;build-engine.rkt&quot;</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;dependency-graph.rkt&quot;</span>)</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> test-config</span></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>  (site-config</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;Test Site&quot;</span></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;https://test.com&quot;</span></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>   (author <span class="st">&quot;Test&quot;</span> <span class="st">&quot;test@test.com&quot;</span>)</span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;Test&quot;</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;en&quot;</span></span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;test-content&quot;</span></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;test-output&quot;</span></span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;test-assets&quot;</span></span>
<span id="cb167-18"><a href="#cb167-18" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;test-templates&quot;</span></span>
<span id="cb167-19"><a href="#cb167-19" aria-hidden="true" tabindex="-1"></a>   (hash)</span>
<span id="cb167-20"><a href="#cb167-20" aria-hidden="true" tabindex="-1"></a>   &#39;hierarchical</span>
<span id="cb167-21"><a href="#cb167-21" aria-hidden="true" tabindex="-1"></a>   &#39;()</span>
<span id="cb167-22"><a href="#cb167-22" aria-hidden="true" tabindex="-1"></a>   &#39;()</span>
<span id="cb167-23"><a href="#cb167-23" aria-hidden="true" tabindex="-1"></a>   &#39;(html)</span>
<span id="cb167-24"><a href="#cb167-24" aria-hidden="true" tabindex="-1"></a>   &#39;()</span>
<span id="cb167-25"><a href="#cb167-25" aria-hidden="true" tabindex="-1"></a>   &#39;()</span>
<span id="cb167-26"><a href="#cb167-26" aria-hidden="true" tabindex="-1"></a>   &#39;()</span>
<span id="cb167-27"><a href="#cb167-27" aria-hidden="true" tabindex="-1"></a>   &#39;()</span>
<span id="cb167-28"><a href="#cb167-28" aria-hidden="true" tabindex="-1"></a>   <span class="dv">#f</span></span>
<span id="cb167-29"><a href="#cb167-29" aria-hidden="true" tabindex="-1"></a>   &#39;()</span>
<span id="cb167-30"><a href="#cb167-30" aria-hidden="true" tabindex="-1"></a>   &#39;()))</span>
<span id="cb167-31"><a href="#cb167-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-32"><a href="#cb167-32" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Dependency tracking&quot;</span></span>
<span id="cb167-33"><a href="#cb167-33" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> dep-graph </span>(make-dependency-graph))</span>
<span id="cb167-34"><a href="#cb167-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-35"><a href="#cb167-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Track some dependencies</span></span>
<span id="cb167-36"><a href="#cb167-36" aria-hidden="true" tabindex="-1"></a>  (track-dependency! dep-graph <span class="st">&quot;a.md&quot;</span> <span class="st">&quot;a.html&quot;</span> &#39;render)</span>
<span id="cb167-37"><a href="#cb167-37" aria-hidden="true" tabindex="-1"></a>  (track-dependency! dep-graph <span class="st">&quot;template.html&quot;</span> <span class="st">&quot;a.html&quot;</span> &#39;template)</span>
<span id="cb167-38"><a href="#cb167-38" aria-hidden="true" tabindex="-1"></a>  (track-dependency! dep-graph <span class="st">&quot;b.md&quot;</span> <span class="st">&quot;b.html&quot;</span> &#39;render)</span>
<span id="cb167-39"><a href="#cb167-39" aria-hidden="true" tabindex="-1"></a>  (track-dependency! dep-graph <span class="st">&quot;a.html&quot;</span> <span class="st">&quot;index.html&quot;</span> &#39;include)</span>
<span id="cb167-40"><a href="#cb167-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-41"><a href="#cb167-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Test dependency queries</span></span>
<span id="cb167-42"><a href="#cb167-42" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> (get-dependencies dep-graph <span class="st">&quot;a.html&quot;</span>)) <span class="dv">2</span>)</span>
<span id="cb167-43"><a href="#cb167-43" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> (get-dependents dep-graph <span class="st">&quot;a.md&quot;</span>)) <span class="dv">1</span>)</span>
<span id="cb167-44"><a href="#cb167-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-45"><a href="#cb167-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Test build order</span></span>
<span id="cb167-46"><a href="#cb167-46" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> order </span>(build-dependency-order </span>
<span id="cb167-47"><a href="#cb167-47" aria-hidden="true" tabindex="-1"></a>                dep-graph </span>
<span id="cb167-48"><a href="#cb167-48" aria-hidden="true" tabindex="-1"></a>                &#39;(<span class="st">&quot;a.md&quot;</span> <span class="st">&quot;b.md&quot;</span> <span class="st">&quot;template.html&quot;</span>)))</span>
<span id="cb167-49"><a href="#cb167-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-50"><a href="#cb167-50" aria-hidden="true" tabindex="-1"></a>  (check-true (<span class="kw">list?</span> order))</span>
<span id="cb167-51"><a href="#cb167-51" aria-hidden="true" tabindex="-1"></a>  (check-true (appears-before? <span class="st">&quot;a.md&quot;</span> <span class="st">&quot;a.html&quot;</span> order))</span>
<span id="cb167-52"><a href="#cb167-52" aria-hidden="true" tabindex="-1"></a>  (check-true (appears-before? <span class="st">&quot;template.html&quot;</span> <span class="st">&quot;a.html&quot;</span> order)))</span>
<span id="cb167-53"><a href="#cb167-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-54"><a href="#cb167-54" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Incremental build detection&quot;</span></span>
<span id="cb167-55"><a href="#cb167-55" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ctx </span>(initialize-build-context test-config))</span>
<span id="cb167-56"><a href="#cb167-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-57"><a href="#cb167-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Simulate some files</span></span>
<span id="cb167-58"><a href="#cb167-58" aria-hidden="true" tabindex="-1"></a>  (track-dependency! (build-context-dependencies ctx)</span>
<span id="cb167-59"><a href="#cb167-59" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;post1.md&quot;</span> <span class="st">&quot;post1.html&quot;</span> &#39;render)</span>
<span id="cb167-60"><a href="#cb167-60" aria-hidden="true" tabindex="-1"></a>  (track-dependency! (build-context-dependencies ctx)</span>
<span id="cb167-61"><a href="#cb167-61" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;template.html&quot;</span> <span class="st">&quot;post1.html&quot;</span> &#39;template)</span>
<span id="cb167-62"><a href="#cb167-62" aria-hidden="true" tabindex="-1"></a>  (track-dependency! (build-context-dependencies ctx)</span>
<span id="cb167-63"><a href="#cb167-63" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;post1.html&quot;</span> <span class="st">&quot;index.html&quot;</span> &#39;index)</span>
<span id="cb167-64"><a href="#cb167-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-65"><a href="#cb167-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Analyze what needs rebuild when template changes</span></span>
<span id="cb167-66"><a href="#cb167-66" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> affected </span>(analyze-incremental-build ctx &#39;(<span class="st">&quot;template.html&quot;</span>)))</span>
<span id="cb167-67"><a href="#cb167-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-68"><a href="#cb167-68" aria-hidden="true" tabindex="-1"></a>  (check-true (hash-has-key? affected <span class="st">&quot;template.html&quot;</span>))</span>
<span id="cb167-69"><a href="#cb167-69" aria-hidden="true" tabindex="-1"></a>  (check-true (hash-has-key? affected <span class="st">&quot;post1.html&quot;</span>))</span>
<span id="cb167-70"><a href="#cb167-70" aria-hidden="true" tabindex="-1"></a>  (check-true (hash-has-key? affected <span class="st">&quot;index.html&quot;</span>)))</span>
<span id="cb167-71"><a href="#cb167-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-72"><a href="#cb167-72" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Parallel task batching&quot;</span></span>
<span id="cb167-73"><a href="#cb167-73" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tasks</span></span>
<span id="cb167-74"><a href="#cb167-74" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>i (in-range <span class="dv">100</span>)<span class="op">]</span>)</span>
<span id="cb167-75"><a href="#cb167-75" aria-hidden="true" tabindex="-1"></a>      (build-task (format <span class="st">&quot;file~a.md&quot;</span> i) &#39;process &#39;() <span class="fl">0.1</span>)))</span>
<span id="cb167-76"><a href="#cb167-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-77"><a href="#cb167-77" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> batches </span>(batch-tasks tasks <span class="dv">10</span>))</span>
<span id="cb167-78"><a href="#cb167-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-79"><a href="#cb167-79" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> batches) <span class="dv">10</span>)</span>
<span id="cb167-80"><a href="#cb167-80" aria-hidden="true" tabindex="-1"></a>  (check-equal? (<span class="kw">length</span> (task-batch-tasks (first batches))) <span class="dv">10</span>))</span>
<span id="cb167-81"><a href="#cb167-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-82"><a href="#cb167-82" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Cache effectiveness&quot;</span></span>
<span id="cb167-83"><a href="#cb167-83" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cache </span>(make-build-cache))</span>
<span id="cb167-84"><a href="#cb167-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-85"><a href="#cb167-85" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add some entries</span></span>
<span id="cb167-86"><a href="#cb167-86" aria-hidden="true" tabindex="-1"></a>  (cache-put! cache <span class="st">&quot;key1&quot;</span> <span class="st">&quot;value1&quot;</span> &#39;())</span>
<span id="cb167-87"><a href="#cb167-87" aria-hidden="true" tabindex="-1"></a>  (cache-put! cache <span class="st">&quot;key2&quot;</span> <span class="st">&quot;value2&quot;</span> &#39;(<span class="st">&quot;dep1&quot;</span>))</span>
<span id="cb167-88"><a href="#cb167-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-89"><a href="#cb167-89" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Test retrieval</span></span>
<span id="cb167-90"><a href="#cb167-90" aria-hidden="true" tabindex="-1"></a>  (check-equal? (cache-get cache <span class="st">&quot;key1&quot;</span> (λ (e) <span class="dv">#t</span>)) <span class="st">&quot;value1&quot;</span>)</span>
<span id="cb167-91"><a href="#cb167-91" aria-hidden="true" tabindex="-1"></a>  (check-false (cache-get cache <span class="st">&quot;key3&quot;</span> (λ (e) <span class="dv">#t</span>)))</span>
<span id="cb167-92"><a href="#cb167-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-93"><a href="#cb167-93" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Test validation</span></span>
<span id="cb167-94"><a href="#cb167-94" aria-hidden="true" tabindex="-1"></a>  (check-false (cache-get cache <span class="st">&quot;key2&quot;</span> (λ (e) <span class="dv">#f</span>)))</span>
<span id="cb167-95"><a href="#cb167-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb167-96"><a href="#cb167-96" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check statistics</span></span>
<span id="cb167-97"><a href="#cb167-97" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> stats </span>(build-cache-stats cache))</span>
<span id="cb167-98"><a href="#cb167-98" aria-hidden="true" tabindex="-1"></a>  (check-equal? (hash-ref stats &#39;puts) <span class="dv">2</span>)</span>
<span id="cb167-99"><a href="#cb167-99" aria-hidden="true" tabindex="-1"></a>  (check-equal? (hash-ref stats &#39;hits) <span class="dv">1</span>))</span></code></pre></div>
<p>The build engine represents the culmination of our static site
generator’s architecture. By combining intelligent dependency tracking,
parallel execution, sophisticated caching, and live development
features, we create a system that scales from simple blogs to complex
documentation sites while maintaining fast build times and excellent
developer experience.</p>
<h2 id="exercises-6">Exercises</h2>
<ol type="1">
<li><p><strong>Implement distributed builds</strong>: Extend the build
system to support distributing work across multiple machines for very
large sites.</p></li>
<li><p><strong>Add build profiling</strong>: Create detailed profiling
tools that identify performance bottlenecks in the build
pipeline.</p></li>
<li><p><strong>Design a plugin API</strong>: Create a comprehensive
plugin system that allows extending the build pipeline without modifying
core code.</p></li>
<li><p><strong>Implement smart caching</strong>: Develop more
intelligent cache invalidation strategies based on content analysis and
historical patterns. # Chapter 12: Web Server and Request
Handling</p></li>
</ol>
<h2 id="beyond-static-files-adding-dynamic-capabilities">Beyond Static
Files: Adding Dynamic Capabilities</h2>
<p>While Shrdlu primarily generates static websites, a development
server with dynamic capabilities dramatically improves the authoring
experience. This chapter explores how to build a sophisticated web
server that serves static files, handles dynamic routes, provides API
endpoints, and integrates with the build system for hot reloading and
live previews.</p>
<h2 id="server-architecture">Server Architecture</h2>
<p>Our web server provides both development and production
capabilities:</p>
<div class="sourceCode" id="cb168"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; web-server.rkt</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>(require racket/tcp</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>         racket/async-channel</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>         net/url</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>         web-server/servlet</span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>         web-server/servlet-env</span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>         web-server/dispatchers/dispatch</span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;site-config.rkt&quot;</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;build-engine.rkt&quot;</span>)</span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>(provide shrdlu-server</span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>         start-server</span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>         server-config</span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>         make-request-handler)</span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a><span class="co">;; Server configuration</span></span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a>(struct server-config</span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>  (port              <span class="co">; Server port</span></span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a>   host              <span class="co">; Bind address</span></span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>   root-path         <span class="co">; Document root</span></span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a>   enable-cors?      <span class="co">; CORS headers</span></span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>   enable-gzip?      <span class="co">; Gzip compression</span></span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a>   enable-cache?     <span class="co">; Client caching</span></span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>   enable-ssl?       <span class="co">; HTTPS support</span></span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a>   ssl-cert          <span class="co">; SSL certificate path</span></span>
<span id="cb168-28"><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a>   ssl-key           <span class="co">; SSL key path</span></span>
<span id="cb168-29"><a href="#cb168-29" aria-hidden="true" tabindex="-1"></a>   max-connections   <span class="co">; Connection limit</span></span>
<span id="cb168-30"><a href="#cb168-30" aria-hidden="true" tabindex="-1"></a>   timeout-seconds   <span class="co">; Request timeout</span></span>
<span id="cb168-31"><a href="#cb168-31" aria-hidden="true" tabindex="-1"></a>   dev-mode?         <span class="co">; Development features</span></span>
<span id="cb168-32"><a href="#cb168-32" aria-hidden="true" tabindex="-1"></a>   middleware)       <span class="co">; Middleware stack</span></span>
<span id="cb168-33"><a href="#cb168-33" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb168-34"><a href="#cb168-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-35"><a href="#cb168-35" aria-hidden="true" tabindex="-1"></a><span class="co">;; Server instance</span></span>
<span id="cb168-36"><a href="#cb168-36" aria-hidden="true" tabindex="-1"></a>(struct shrdlu-server</span>
<span id="cb168-37"><a href="#cb168-37" aria-hidden="true" tabindex="-1"></a>  (config            <span class="co">; Server configuration</span></span>
<span id="cb168-38"><a href="#cb168-38" aria-hidden="true" tabindex="-1"></a>   site-config       <span class="co">; Site configuration</span></span>
<span id="cb168-39"><a href="#cb168-39" aria-hidden="true" tabindex="-1"></a>   dispatcher        <span class="co">; Request dispatcher</span></span>
<span id="cb168-40"><a href="#cb168-40" aria-hidden="true" tabindex="-1"></a>   build-context     <span class="co">; Build system integration</span></span>
<span id="cb168-41"><a href="#cb168-41" aria-hidden="true" tabindex="-1"></a>   connections       <span class="co">; Active connections</span></span>
<span id="cb168-42"><a href="#cb168-42" aria-hidden="true" tabindex="-1"></a>   statistics        <span class="co">; Server statistics</span></span>
<span id="cb168-43"><a href="#cb168-43" aria-hidden="true" tabindex="-1"></a>   shutdown-channel) <span class="co">; Shutdown coordination</span></span>
<span id="cb168-44"><a href="#cb168-44" aria-hidden="true" tabindex="-1"></a>  #:mutable</span>
<span id="cb168-45"><a href="#cb168-45" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb168-46"><a href="#cb168-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-47"><a href="#cb168-47" aria-hidden="true" tabindex="-1"></a><span class="co">;; Default server configuration</span></span>
<span id="cb168-48"><a href="#cb168-48" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(default-server-config root-path #:dev-mode? <span class="op">[</span>dev? <span class="dv">#t</span><span class="op">]</span>)</span>
<span id="cb168-49"><a href="#cb168-49" aria-hidden="true" tabindex="-1"></a>  (server-config</span>
<span id="cb168-50"><a href="#cb168-50" aria-hidden="true" tabindex="-1"></a>   <span class="dv">8080</span>                    <span class="co">; port</span></span>
<span id="cb168-51"><a href="#cb168-51" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;localhost&quot;</span>             <span class="co">; host  </span></span>
<span id="cb168-52"><a href="#cb168-52" aria-hidden="true" tabindex="-1"></a>   root-path              <span class="co">; root-path</span></span>
<span id="cb168-53"><a href="#cb168-53" aria-hidden="true" tabindex="-1"></a>   dev?                   <span class="co">; enable-cors?</span></span>
<span id="cb168-54"><a href="#cb168-54" aria-hidden="true" tabindex="-1"></a>   <span class="dv">#t</span>                     <span class="co">; enable-gzip?</span></span>
<span id="cb168-55"><a href="#cb168-55" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">not</span> dev?)             <span class="co">; enable-cache?</span></span>
<span id="cb168-56"><a href="#cb168-56" aria-hidden="true" tabindex="-1"></a>   <span class="dv">#f</span>                     <span class="co">; enable-ssl?</span></span>
<span id="cb168-57"><a href="#cb168-57" aria-hidden="true" tabindex="-1"></a>   <span class="dv">#f</span>                     <span class="co">; ssl-cert</span></span>
<span id="cb168-58"><a href="#cb168-58" aria-hidden="true" tabindex="-1"></a>   <span class="dv">#f</span>                     <span class="co">; ssl-key</span></span>
<span id="cb168-59"><a href="#cb168-59" aria-hidden="true" tabindex="-1"></a>   <span class="dv">100</span>                    <span class="co">; max-connections</span></span>
<span id="cb168-60"><a href="#cb168-60" aria-hidden="true" tabindex="-1"></a>   <span class="dv">30</span>                     <span class="co">; timeout-seconds</span></span>
<span id="cb168-61"><a href="#cb168-61" aria-hidden="true" tabindex="-1"></a>   dev?                   <span class="co">; dev-mode?</span></span>
<span id="cb168-62"><a href="#cb168-62" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">if</span> dev?</span>
<span id="cb168-63"><a href="#cb168-63" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">list</span> logging-middleware</span>
<span id="cb168-64"><a href="#cb168-64" aria-hidden="true" tabindex="-1"></a>             error-handling-middleware</span>
<span id="cb168-65"><a href="#cb168-65" aria-hidden="true" tabindex="-1"></a>             development-middleware)</span>
<span id="cb168-66"><a href="#cb168-66" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">list</span> logging-middleware</span>
<span id="cb168-67"><a href="#cb168-67" aria-hidden="true" tabindex="-1"></a>             error-handling-middleware</span>
<span id="cb168-68"><a href="#cb168-68" aria-hidden="true" tabindex="-1"></a>             security-middleware))))</span>
<span id="cb168-69"><a href="#cb168-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-70"><a href="#cb168-70" aria-hidden="true" tabindex="-1"></a><span class="co">;; Start server</span></span>
<span id="cb168-71"><a href="#cb168-71" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(start-server config site-config)</span>
<span id="cb168-72"><a href="#cb168-72" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> server</span></span>
<span id="cb168-73"><a href="#cb168-73" aria-hidden="true" tabindex="-1"></a>    (shrdlu-server</span>
<span id="cb168-74"><a href="#cb168-74" aria-hidden="true" tabindex="-1"></a>     config</span>
<span id="cb168-75"><a href="#cb168-75" aria-hidden="true" tabindex="-1"></a>     site-config</span>
<span id="cb168-76"><a href="#cb168-76" aria-hidden="true" tabindex="-1"></a>     (create-dispatcher config site-config)</span>
<span id="cb168-77"><a href="#cb168-77" aria-hidden="true" tabindex="-1"></a>     (when (server-config-dev-mode? config)</span>
<span id="cb168-78"><a href="#cb168-78" aria-hidden="true" tabindex="-1"></a>       (initialize-build-context site-config))</span>
<span id="cb168-79"><a href="#cb168-79" aria-hidden="true" tabindex="-1"></a>     (make-hash)      <span class="co">; connections</span></span>
<span id="cb168-80"><a href="#cb168-80" aria-hidden="true" tabindex="-1"></a>     (make-statistics) <span class="co">; statistics</span></span>
<span id="cb168-81"><a href="#cb168-81" aria-hidden="true" tabindex="-1"></a>     (make-async-channel))) <span class="co">; shutdown</span></span>
<span id="cb168-82"><a href="#cb168-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-83"><a href="#cb168-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Configure and launch</span></span>
<span id="cb168-84"><a href="#cb168-84" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> stop</span></span>
<span id="cb168-85"><a href="#cb168-85" aria-hidden="true" tabindex="-1"></a>    (serve/servlet</span>
<span id="cb168-86"><a href="#cb168-86" aria-hidden="true" tabindex="-1"></a>     (make-request-handler server)</span>
<span id="cb168-87"><a href="#cb168-87" aria-hidden="true" tabindex="-1"></a>     #:port (server-config-port config)</span>
<span id="cb168-88"><a href="#cb168-88" aria-hidden="true" tabindex="-1"></a>     #:listen-ip (server-config-host config)</span>
<span id="cb168-89"><a href="#cb168-89" aria-hidden="true" tabindex="-1"></a>     #:servlet-regexp #rx<span class="st">&quot;&quot;</span></span>
<span id="cb168-90"><a href="#cb168-90" aria-hidden="true" tabindex="-1"></a>     #:server-root-path (server-config-root-path config)</span>
<span id="cb168-91"><a href="#cb168-91" aria-hidden="true" tabindex="-1"></a>     #:file-not-found-responder (make-404-handler server)</span>
<span id="cb168-92"><a href="#cb168-92" aria-hidden="true" tabindex="-1"></a>     #:stateless? <span class="dv">#t</span>))</span>
<span id="cb168-93"><a href="#cb168-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-94"><a href="#cb168-94" aria-hidden="true" tabindex="-1"></a>  (printf <span class="st">&quot;Server running at http://~a:~a</span><span class="ch">\n</span><span class="st">&quot;</span></span>
<span id="cb168-95"><a href="#cb168-95" aria-hidden="true" tabindex="-1"></a>          (server-config-host config)</span>
<span id="cb168-96"><a href="#cb168-96" aria-hidden="true" tabindex="-1"></a>          (server-config-port config))</span>
<span id="cb168-97"><a href="#cb168-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb168-98"><a href="#cb168-98" aria-hidden="true" tabindex="-1"></a>  server)</span>
<span id="cb168-99"><a href="#cb168-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-100"><a href="#cb168-100" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create request dispatcher</span></span>
<span id="cb168-101"><a href="#cb168-101" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(create-dispatcher config site-config)</span>
<span id="cb168-102"><a href="#cb168-102" aria-hidden="true" tabindex="-1"></a>  (sequencer</span>
<span id="cb168-103"><a href="#cb168-103" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Middleware pipeline</span></span>
<span id="cb168-104"><a href="#cb168-104" aria-hidden="true" tabindex="-1"></a>   (apply compose1 </span>
<span id="cb168-105"><a href="#cb168-105" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">reverse</span> (server-config-middleware config)))</span>
<span id="cb168-106"><a href="#cb168-106" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb168-107"><a href="#cb168-107" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Route dispatchers</span></span>
<span id="cb168-108"><a href="#cb168-108" aria-hidden="true" tabindex="-1"></a>   (choose</span>
<span id="cb168-109"><a href="#cb168-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; API routes</span></span>
<span id="cb168-110"><a href="#cb168-110" aria-hidden="true" tabindex="-1"></a>    (when (server-config-dev-mode? config)</span>
<span id="cb168-111"><a href="#cb168-111" aria-hidden="true" tabindex="-1"></a>      (api-dispatcher site-config))</span>
<span id="cb168-112"><a href="#cb168-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb168-113"><a href="#cb168-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; WebSocket routes</span></span>
<span id="cb168-114"><a href="#cb168-114" aria-hidden="true" tabindex="-1"></a>    (when (server-config-dev-mode? config)</span>
<span id="cb168-115"><a href="#cb168-115" aria-hidden="true" tabindex="-1"></a>      (websocket-dispatcher))</span>
<span id="cb168-116"><a href="#cb168-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb168-117"><a href="#cb168-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Dynamic content routes</span></span>
<span id="cb168-118"><a href="#cb168-118" aria-hidden="true" tabindex="-1"></a>    (dynamic-content-dispatcher site-config)</span>
<span id="cb168-119"><a href="#cb168-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb168-120"><a href="#cb168-120" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Static file server</span></span>
<span id="cb168-121"><a href="#cb168-121" aria-hidden="true" tabindex="-1"></a>    (static-file-dispatcher config)</span>
<span id="cb168-122"><a href="#cb168-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb168-123"><a href="#cb168-123" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; 404 handler</span></span>
<span id="cb168-124"><a href="#cb168-124" aria-hidden="true" tabindex="-1"></a>    (not-found-dispatcher))))</span></code></pre></div>
<h2 id="request-routing-and-dispatch">Request Routing and Dispatch</h2>
<p>Flexible routing system for handling various request types:</p>
<div class="sourceCode" id="cb169"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; routing.rkt</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>(require net/url</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>         web-server/http)</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>(provide route</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>         route-dispatcher</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>         make-route-table</span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>         match-route)</span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Route definition</span></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>(struct route</span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>  (method          <span class="co">; HTTP method or #f for any</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>   pattern         <span class="co">; URL pattern with parameters</span></span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>   handler         <span class="co">; Request handler function</span></span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>   name            <span class="co">; Optional route name</span></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>   middleware      <span class="co">; Route-specific middleware</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>   constraints)    <span class="co">; Parameter constraints</span></span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a><span class="co">;; Route table</span></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a>(struct route-table</span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a>  (routes          <span class="co">; List of routes</span></span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a>   named-routes    <span class="co">; Hash of named routes</span></span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a>   prefix)         <span class="co">; URL prefix</span></span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create route dispatcher</span></span>
<span id="cb169-30"><a href="#cb169-30" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(route-dispatcher routes)</span>
<span id="cb169-31"><a href="#cb169-31" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb169-32"><a href="#cb169-32" aria-hidden="true" tabindex="-1"></a>    (define-values (matched params)</span>
<span id="cb169-33"><a href="#cb169-33" aria-hidden="true" tabindex="-1"></a>      (match-request-route req routes))</span>
<span id="cb169-34"><a href="#cb169-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-35"><a href="#cb169-35" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> matched</span>
<span id="cb169-36"><a href="#cb169-36" aria-hidden="true" tabindex="-1"></a>        (call-route-handler matched req params)</span>
<span id="cb169-37"><a href="#cb169-37" aria-hidden="true" tabindex="-1"></a>        (next-dispatcher))))</span>
<span id="cb169-38"><a href="#cb169-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-39"><a href="#cb169-39" aria-hidden="true" tabindex="-1"></a><span class="co">;; Route pattern matching</span></span>
<span id="cb169-40"><a href="#cb169-40" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(match-route pattern path)</span>
<span id="cb169-41"><a href="#cb169-41" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> pattern-parts </span>(string-split pattern <span class="st">&quot;/&quot;</span>))</span>
<span id="cb169-42"><a href="#cb169-42" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> path-parts </span>(string-split path <span class="st">&quot;/&quot;</span>))</span>
<span id="cb169-43"><a href="#cb169-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb169-44"><a href="#cb169-44" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">and</span> (<span class="op">=</span> (<span class="kw">length</span> pattern-parts) (<span class="kw">length</span> path-parts))</span>
<span id="cb169-45"><a href="#cb169-45" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">let</span> loop (<span class="op">[</span>patterns pattern-parts<span class="op">]</span></span>
<span id="cb169-46"><a href="#cb169-46" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>paths path-parts<span class="op">]</span></span>
<span id="cb169-47"><a href="#cb169-47" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>params &#39;()<span class="op">]</span>)</span>
<span id="cb169-48"><a href="#cb169-48" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">cond</span></span>
<span id="cb169-49"><a href="#cb169-49" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="kw">null?</span> patterns) (<span class="kw">reverse</span> params)<span class="op">]</span></span>
<span id="cb169-50"><a href="#cb169-50" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb169-51"><a href="#cb169-51" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; Parameter capture</span></span>
<span id="cb169-52"><a href="#cb169-52" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(string-prefix? (<span class="kw">car</span> patterns) <span class="st">&quot;:&quot;</span>)</span>
<span id="cb169-53"><a href="#cb169-53" aria-hidden="true" tabindex="-1"></a>            (loop (<span class="kw">cdr</span> patterns)</span>
<span id="cb169-54"><a href="#cb169-54" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">cdr</span> paths)</span>
<span id="cb169-55"><a href="#cb169-55" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">cons</span> (<span class="kw">cons</span> (<span class="kw">substring</span> (<span class="kw">car</span> patterns) <span class="dv">1</span>)</span>
<span id="cb169-56"><a href="#cb169-56" aria-hidden="true" tabindex="-1"></a>                             (<span class="kw">car</span> paths))</span>
<span id="cb169-57"><a href="#cb169-57" aria-hidden="true" tabindex="-1"></a>                        params))<span class="op">]</span></span>
<span id="cb169-58"><a href="#cb169-58" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb169-59"><a href="#cb169-59" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; Wildcard</span></span>
<span id="cb169-60"><a href="#cb169-60" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="kw">equal?</span> (<span class="kw">car</span> patterns) <span class="st">&quot;*&quot;</span>)</span>
<span id="cb169-61"><a href="#cb169-61" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">reverse</span> (<span class="kw">cons</span> (<span class="kw">cons</span> &#39;splat (string-join paths <span class="st">&quot;/&quot;</span>))</span>
<span id="cb169-62"><a href="#cb169-62" aria-hidden="true" tabindex="-1"></a>                          params))<span class="op">]</span></span>
<span id="cb169-63"><a href="#cb169-63" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb169-64"><a href="#cb169-64" aria-hidden="true" tabindex="-1"></a>           <span class="co">;; Exact match</span></span>
<span id="cb169-65"><a href="#cb169-65" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="kw">equal?</span> (<span class="kw">car</span> patterns) (<span class="kw">car</span> paths))</span>
<span id="cb169-66"><a href="#cb169-66" aria-hidden="true" tabindex="-1"></a>            (loop (<span class="kw">cdr</span> patterns) (<span class="kw">cdr</span> paths) params)<span class="op">]</span></span>
<span id="cb169-67"><a href="#cb169-67" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb169-68"><a href="#cb169-68" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span><span class="kw">else</span> <span class="dv">#f</span><span class="op">]</span>))))</span>
<span id="cb169-69"><a href="#cb169-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-70"><a href="#cb169-70" aria-hidden="true" tabindex="-1"></a><span class="co">;; Route builder DSL</span></span>
<span id="cb169-71"><a href="#cb169-71" aria-hidden="true" tabindex="-1"></a>(define-syntax-rule (routes spec <span class="op">...</span>)</span>
<span id="cb169-72"><a href="#cb169-72" aria-hidden="true" tabindex="-1"></a>  (make-route-table</span>
<span id="cb169-73"><a href="#cb169-73" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span> (build-route spec) <span class="op">...</span>)))</span>
<span id="cb169-74"><a href="#cb169-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-75"><a href="#cb169-75" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> build-route</span></span>
<span id="cb169-76"><a href="#cb169-76" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-rules</span> (get post put delete any)</span>
<span id="cb169-77"><a href="#cb169-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(build-route (get pattern handler opts <span class="op">...</span>))</span>
<span id="cb169-78"><a href="#cb169-78" aria-hidden="true" tabindex="-1"></a>     (route &#39;GET pattern handler opts <span class="op">...</span>)<span class="op">]</span></span>
<span id="cb169-79"><a href="#cb169-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(build-route (post pattern handler opts <span class="op">...</span>))</span>
<span id="cb169-80"><a href="#cb169-80" aria-hidden="true" tabindex="-1"></a>     (route &#39;POST pattern handler opts <span class="op">...</span>)<span class="op">]</span></span>
<span id="cb169-81"><a href="#cb169-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(build-route (put pattern handler opts <span class="op">...</span>))</span>
<span id="cb169-82"><a href="#cb169-82" aria-hidden="true" tabindex="-1"></a>     (route &#39;PUT pattern handler opts <span class="op">...</span>)<span class="op">]</span></span>
<span id="cb169-83"><a href="#cb169-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(build-route (delete pattern handler opts <span class="op">...</span>))</span>
<span id="cb169-84"><a href="#cb169-84" aria-hidden="true" tabindex="-1"></a>     (route &#39;DELETE pattern handler opts <span class="op">...</span>)<span class="op">]</span></span>
<span id="cb169-85"><a href="#cb169-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(build-route (any pattern handler opts <span class="op">...</span>))</span>
<span id="cb169-86"><a href="#cb169-86" aria-hidden="true" tabindex="-1"></a>     (route <span class="dv">#f</span> pattern handler opts <span class="op">...</span>)<span class="op">]</span>))</span>
<span id="cb169-87"><a href="#cb169-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-88"><a href="#cb169-88" aria-hidden="true" tabindex="-1"></a><span class="co">;; Example route definitions</span></span>
<span id="cb169-89"><a href="#cb169-89" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> site-routes</span></span>
<span id="cb169-90"><a href="#cb169-90" aria-hidden="true" tabindex="-1"></a>  (routes</span>
<span id="cb169-91"><a href="#cb169-91" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Home page</span></span>
<span id="cb169-92"><a href="#cb169-92" aria-hidden="true" tabindex="-1"></a>   (get <span class="st">&quot;/&quot;</span> home-handler </span>
<span id="cb169-93"><a href="#cb169-93" aria-hidden="true" tabindex="-1"></a>        #:name &#39;home)</span>
<span id="cb169-94"><a href="#cb169-94" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb169-95"><a href="#cb169-95" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Blog routes</span></span>
<span id="cb169-96"><a href="#cb169-96" aria-hidden="true" tabindex="-1"></a>   (get <span class="st">&quot;/blog&quot;</span> blog-index-handler</span>
<span id="cb169-97"><a href="#cb169-97" aria-hidden="true" tabindex="-1"></a>        #:name &#39;blog-index)</span>
<span id="cb169-98"><a href="#cb169-98" aria-hidden="true" tabindex="-1"></a>   (get <span class="st">&quot;/blog/:year/:month/:slug&quot;</span> blog-post-handler</span>
<span id="cb169-99"><a href="#cb169-99" aria-hidden="true" tabindex="-1"></a>        #:name &#39;blog-post</span>
<span id="cb169-100"><a href="#cb169-100" aria-hidden="true" tabindex="-1"></a>        #:constraints &#39;((year <span class="op">.</span> #px<span class="st">&quot;</span><span class="ch">\\</span><span class="st">d{4}&quot;</span>)</span>
<span id="cb169-101"><a href="#cb169-101" aria-hidden="true" tabindex="-1"></a>                       (month <span class="op">.</span> #px<span class="st">&quot;</span><span class="ch">\\</span><span class="st">d{2}&quot;</span>)</span>
<span id="cb169-102"><a href="#cb169-102" aria-hidden="true" tabindex="-1"></a>                       (slug <span class="op">.</span> #px<span class="st">&quot;[a-z0-9-]+&quot;</span>)))</span>
<span id="cb169-103"><a href="#cb169-103" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb169-104"><a href="#cb169-104" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; API routes</span></span>
<span id="cb169-105"><a href="#cb169-105" aria-hidden="true" tabindex="-1"></a>   (get <span class="st">&quot;/api/search&quot;</span> search-handler)</span>
<span id="cb169-106"><a href="#cb169-106" aria-hidden="true" tabindex="-1"></a>   (post <span class="st">&quot;/api/preview&quot;</span> preview-handler</span>
<span id="cb169-107"><a href="#cb169-107" aria-hidden="true" tabindex="-1"></a>         #:middleware &#39;(json-body-parser))</span>
<span id="cb169-108"><a href="#cb169-108" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb169-109"><a href="#cb169-109" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Catch-all static files</span></span>
<span id="cb169-110"><a href="#cb169-110" aria-hidden="true" tabindex="-1"></a>   (get <span class="st">&quot;/*&quot;</span> static-file-handler)))</span>
<span id="cb169-111"><a href="#cb169-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-112"><a href="#cb169-112" aria-hidden="true" tabindex="-1"></a><span class="co">;; Route handler utilities</span></span>
<span id="cb169-113"><a href="#cb169-113" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(with-params handler param-names)</span>
<span id="cb169-114"><a href="#cb169-114" aria-hidden="true" tabindex="-1"></a>  (λ (req params)</span>
<span id="cb169-115"><a href="#cb169-115" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> args</span></span>
<span id="cb169-116"><a href="#cb169-116" aria-hidden="true" tabindex="-1"></a>      (for/list (<span class="op">[</span>name param-names<span class="op">]</span>)</span>
<span id="cb169-117"><a href="#cb169-117" aria-hidden="true" tabindex="-1"></a>        (hash-ref params name <span class="dv">#f</span>)))</span>
<span id="cb169-118"><a href="#cb169-118" aria-hidden="true" tabindex="-1"></a>    (apply handler req args)))</span>
<span id="cb169-119"><a href="#cb169-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-120"><a href="#cb169-120" aria-hidden="true" tabindex="-1"></a><span class="co">;; URL generation from routes</span></span>
<span id="cb169-121"><a href="#cb169-121" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(url-for route-name <span class="op">[</span>params &#39;()<span class="op">]</span> <span class="op">[</span>query &#39;()<span class="op">]</span>)</span>
<span id="cb169-122"><a href="#cb169-122" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> route </span>(get-named-route route-name))</span>
<span id="cb169-123"><a href="#cb169-123" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> path </span>(route-pattern route))</span>
<span id="cb169-124"><a href="#cb169-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb169-125"><a href="#cb169-125" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Substitute parameters</span></span>
<span id="cb169-126"><a href="#cb169-126" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> expanded-path</span></span>
<span id="cb169-127"><a href="#cb169-127" aria-hidden="true" tabindex="-1"></a>    (regexp-replace* #rx<span class="st">&quot;:([^/]+)&quot;</span></span>
<span id="cb169-128"><a href="#cb169-128" aria-hidden="true" tabindex="-1"></a>                     path</span>
<span id="cb169-129"><a href="#cb169-129" aria-hidden="true" tabindex="-1"></a>                     (λ (match param-name)</span>
<span id="cb169-130"><a href="#cb169-130" aria-hidden="true" tabindex="-1"></a>                       (hash-ref params </span>
<span id="cb169-131"><a href="#cb169-131" aria-hidden="true" tabindex="-1"></a>                                (<span class="kw">string-&gt;symbol</span> param-name)</span>
<span id="cb169-132"><a href="#cb169-132" aria-hidden="true" tabindex="-1"></a>                                match))))</span>
<span id="cb169-133"><a href="#cb169-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb169-134"><a href="#cb169-134" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add query parameters</span></span>
<span id="cb169-135"><a href="#cb169-135" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="kw">null?</span> query)</span>
<span id="cb169-136"><a href="#cb169-136" aria-hidden="true" tabindex="-1"></a>      expanded-path</span>
<span id="cb169-137"><a href="#cb169-137" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">string-append</span> expanded-path <span class="st">&quot;?&quot;</span></span>
<span id="cb169-138"><a href="#cb169-138" aria-hidden="true" tabindex="-1"></a>                     (alist-&gt;form-urlencoded query))))</span></code></pre></div>
<h2 id="static-file-serving">Static File Serving</h2>
<p>Efficient static file serving with caching and compression:</p>
<div class="sourceCode" id="cb170"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; static-files.rkt</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>(require file/gzip</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>         net/mime-type</span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>         web-server/http/response)</span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>(provide static-file-handler</span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>         serve-static-file</span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>         file-response)</span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; MIME type detection</span></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> common-mime-types</span></span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>  #hash((<span class="st">&quot;html&quot;</span> <span class="op">.</span> <span class="st">&quot;text/html; charset=utf-8&quot;</span>)</span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;css&quot;</span> <span class="op">.</span> <span class="st">&quot;text/css; charset=utf-8&quot;</span>)</span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;js&quot;</span> <span class="op">.</span> <span class="st">&quot;application/javascript; charset=utf-8&quot;</span>)</span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;json&quot;</span> <span class="op">.</span> <span class="st">&quot;application/json; charset=utf-8&quot;</span>)</span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;xml&quot;</span> <span class="op">.</span> <span class="st">&quot;application/xml; charset=utf-8&quot;</span>)</span>
<span id="cb170-19"><a href="#cb170-19" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;pdf&quot;</span> <span class="op">.</span> <span class="st">&quot;application/pdf&quot;</span>)</span>
<span id="cb170-20"><a href="#cb170-20" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;png&quot;</span> <span class="op">.</span> <span class="st">&quot;image/png&quot;</span>)</span>
<span id="cb170-21"><a href="#cb170-21" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;jpg&quot;</span> <span class="op">.</span> <span class="st">&quot;image/jpeg&quot;</span>)</span>
<span id="cb170-22"><a href="#cb170-22" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;jpeg&quot;</span> <span class="op">.</span> <span class="st">&quot;image/jpeg&quot;</span>)</span>
<span id="cb170-23"><a href="#cb170-23" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;gif&quot;</span> <span class="op">.</span> <span class="st">&quot;image/gif&quot;</span>)</span>
<span id="cb170-24"><a href="#cb170-24" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;svg&quot;</span> <span class="op">.</span> <span class="st">&quot;image/svg+xml&quot;</span>)</span>
<span id="cb170-25"><a href="#cb170-25" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;ico&quot;</span> <span class="op">.</span> <span class="st">&quot;image/x-icon&quot;</span>)</span>
<span id="cb170-26"><a href="#cb170-26" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;woff&quot;</span> <span class="op">.</span> <span class="st">&quot;font/woff&quot;</span>)</span>
<span id="cb170-27"><a href="#cb170-27" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;woff2&quot;</span> <span class="op">.</span> <span class="st">&quot;font/woff2&quot;</span>)</span>
<span id="cb170-28"><a href="#cb170-28" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;ttf&quot;</span> <span class="op">.</span> <span class="st">&quot;font/ttf&quot;</span>)</span>
<span id="cb170-29"><a href="#cb170-29" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;eot&quot;</span> <span class="op">.</span> <span class="st">&quot;application/vnd.ms-fontobject&quot;</span>)))</span>
<span id="cb170-30"><a href="#cb170-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-31"><a href="#cb170-31" aria-hidden="true" tabindex="-1"></a><span class="co">;; Static file handler</span></span>
<span id="cb170-32"><a href="#cb170-32" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(static-file-handler root-path)</span>
<span id="cb170-33"><a href="#cb170-33" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb170-34"><a href="#cb170-34" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> path </span>(request-path req))</span>
<span id="cb170-35"><a href="#cb170-35" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> file-path </span>(build-path root-path path))</span>
<span id="cb170-36"><a href="#cb170-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-37"><a href="#cb170-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Security check</span></span>
<span id="cb170-38"><a href="#cb170-38" aria-hidden="true" tabindex="-1"></a>    (unless (safe-path? file-path root-path)</span>
<span id="cb170-39"><a href="#cb170-39" aria-hidden="true" tabindex="-1"></a>      (response/full</span>
<span id="cb170-40"><a href="#cb170-40" aria-hidden="true" tabindex="-1"></a>       <span class="dv">403</span> #<span class="st">&quot;Forbidden&quot;</span></span>
<span id="cb170-41"><a href="#cb170-41" aria-hidden="true" tabindex="-1"></a>       (current-seconds)</span>
<span id="cb170-42"><a href="#cb170-42" aria-hidden="true" tabindex="-1"></a>       TEXT/HTML-MIME-TYPE</span>
<span id="cb170-43"><a href="#cb170-43" aria-hidden="true" tabindex="-1"></a>       &#39;()</span>
<span id="cb170-44"><a href="#cb170-44" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">list</span> #<span class="st">&quot;Access denied&quot;</span>)))</span>
<span id="cb170-45"><a href="#cb170-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-46"><a href="#cb170-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Serve file</span></span>
<span id="cb170-47"><a href="#cb170-47" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb170-48"><a href="#cb170-48" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">file-exists?</span> file-path)</span>
<span id="cb170-49"><a href="#cb170-49" aria-hidden="true" tabindex="-1"></a>       (serve-static-file file-path req)<span class="op">]</span></span>
<span id="cb170-50"><a href="#cb170-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb170-51"><a href="#cb170-51" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(directory-exists? file-path)</span>
<span id="cb170-52"><a href="#cb170-52" aria-hidden="true" tabindex="-1"></a>       (serve-directory-index file-path req)<span class="op">]</span></span>
<span id="cb170-53"><a href="#cb170-53" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb170-54"><a href="#cb170-54" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb170-55"><a href="#cb170-55" aria-hidden="true" tabindex="-1"></a>       (next-dispatcher)<span class="op">]</span>)))</span>
<span id="cb170-56"><a href="#cb170-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-57"><a href="#cb170-57" aria-hidden="true" tabindex="-1"></a><span class="co">;; Serve a static file with optimizations</span></span>
<span id="cb170-58"><a href="#cb170-58" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(serve-static-file path req)</span>
<span id="cb170-59"><a href="#cb170-59" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> config </span>(current-server-config))</span>
<span id="cb170-60"><a href="#cb170-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-61"><a href="#cb170-61" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check cache headers</span></span>
<span id="cb170-62"><a href="#cb170-62" aria-hidden="true" tabindex="-1"></a>  (when (not-modified? path req)</span>
<span id="cb170-63"><a href="#cb170-63" aria-hidden="true" tabindex="-1"></a>    (return (response/full</span>
<span id="cb170-64"><a href="#cb170-64" aria-hidden="true" tabindex="-1"></a>             <span class="dv">304</span> #<span class="st">&quot;Not Modified&quot;</span></span>
<span id="cb170-65"><a href="#cb170-65" aria-hidden="true" tabindex="-1"></a>             (current-seconds)</span>
<span id="cb170-66"><a href="#cb170-66" aria-hidden="true" tabindex="-1"></a>             <span class="dv">#f</span> &#39;() &#39;())))</span>
<span id="cb170-67"><a href="#cb170-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-68"><a href="#cb170-68" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Determine content type</span></span>
<span id="cb170-69"><a href="#cb170-69" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> content-type</span></span>
<span id="cb170-70"><a href="#cb170-70" aria-hidden="true" tabindex="-1"></a>    (path-&gt;mime-type path))</span>
<span id="cb170-71"><a href="#cb170-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-72"><a href="#cb170-72" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Read file content</span></span>
<span id="cb170-73"><a href="#cb170-73" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> content </span>(file-&gt;bytes path))</span>
<span id="cb170-74"><a href="#cb170-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-75"><a href="#cb170-75" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Apply compression if enabled</span></span>
<span id="cb170-76"><a href="#cb170-76" aria-hidden="true" tabindex="-1"></a>  (define-values (final-content encoding)</span>
<span id="cb170-77"><a href="#cb170-77" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (<span class="kw">and</span> (server-config-enable-gzip? config)</span>
<span id="cb170-78"><a href="#cb170-78" aria-hidden="true" tabindex="-1"></a>             (accepts-gzip? req)</span>
<span id="cb170-79"><a href="#cb170-79" aria-hidden="true" tabindex="-1"></a>             (compressible? content-type))</span>
<span id="cb170-80"><a href="#cb170-80" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">values</span> (gzip-bytes content) <span class="st">&quot;gzip&quot;</span>)</span>
<span id="cb170-81"><a href="#cb170-81" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">values</span> content <span class="dv">#f</span>)))</span>
<span id="cb170-82"><a href="#cb170-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-83"><a href="#cb170-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Build response headers</span></span>
<span id="cb170-84"><a href="#cb170-84" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> headers</span></span>
<span id="cb170-85"><a href="#cb170-85" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">append</span></span>
<span id="cb170-86"><a href="#cb170-86" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">list</span> (make-header #<span class="st">&quot;Content-Type&quot;</span> </span>
<span id="cb170-87"><a href="#cb170-87" aria-hidden="true" tabindex="-1"></a>                       (string-&gt;bytes/utf-8 content-type)))</span>
<span id="cb170-88"><a href="#cb170-88" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb170-89"><a href="#cb170-89" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Compression</span></span>
<span id="cb170-90"><a href="#cb170-90" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> encoding</span>
<span id="cb170-91"><a href="#cb170-91" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">list</span> (make-header #<span class="st">&quot;Content-Encoding&quot;</span></span>
<span id="cb170-92"><a href="#cb170-92" aria-hidden="true" tabindex="-1"></a>                           (string-&gt;bytes/utf-8 encoding)))</span>
<span id="cb170-93"><a href="#cb170-93" aria-hidden="true" tabindex="-1"></a>         &#39;())</span>
<span id="cb170-94"><a href="#cb170-94" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb170-95"><a href="#cb170-95" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Caching</span></span>
<span id="cb170-96"><a href="#cb170-96" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> (server-config-enable-cache? config)</span>
<span id="cb170-97"><a href="#cb170-97" aria-hidden="true" tabindex="-1"></a>         (cache-headers path)</span>
<span id="cb170-98"><a href="#cb170-98" aria-hidden="true" tabindex="-1"></a>         &#39;())</span>
<span id="cb170-99"><a href="#cb170-99" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb170-100"><a href="#cb170-100" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; CORS</span></span>
<span id="cb170-101"><a href="#cb170-101" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> (server-config-enable-cors? config)</span>
<span id="cb170-102"><a href="#cb170-102" aria-hidden="true" tabindex="-1"></a>         (cors-headers req)</span>
<span id="cb170-103"><a href="#cb170-103" aria-hidden="true" tabindex="-1"></a>         &#39;())</span>
<span id="cb170-104"><a href="#cb170-104" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb170-105"><a href="#cb170-105" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Security headers</span></span>
<span id="cb170-106"><a href="#cb170-106" aria-hidden="true" tabindex="-1"></a>     (security-headers)))</span>
<span id="cb170-107"><a href="#cb170-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-108"><a href="#cb170-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Send response</span></span>
<span id="cb170-109"><a href="#cb170-109" aria-hidden="true" tabindex="-1"></a>  (response/full</span>
<span id="cb170-110"><a href="#cb170-110" aria-hidden="true" tabindex="-1"></a>   <span class="dv">200</span> #<span class="st">&quot;OK&quot;</span></span>
<span id="cb170-111"><a href="#cb170-111" aria-hidden="true" tabindex="-1"></a>   (current-seconds)</span>
<span id="cb170-112"><a href="#cb170-112" aria-hidden="true" tabindex="-1"></a>   content-type</span>
<span id="cb170-113"><a href="#cb170-113" aria-hidden="true" tabindex="-1"></a>   headers</span>
<span id="cb170-114"><a href="#cb170-114" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span> final-content)))</span>
<span id="cb170-115"><a href="#cb170-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-116"><a href="#cb170-116" aria-hidden="true" tabindex="-1"></a><span class="co">;; Cache control headers</span></span>
<span id="cb170-117"><a href="#cb170-117" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(cache-headers path)</span>
<span id="cb170-118"><a href="#cb170-118" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ext </span>(path-get-extension path))</span>
<span id="cb170-119"><a href="#cb170-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-120"><a href="#cb170-120" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cache-duration</span></span>
<span id="cb170-121"><a href="#cb170-121" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb170-122"><a href="#cb170-122" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Immutable assets (with hash in filename)</span></span>
<span id="cb170-123"><a href="#cb170-123" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(regexp-match? #rx<span class="st">&quot;</span><span class="ch">\\</span><span class="st">.[0-9a-f]{8}</span><span class="ch">\\</span><span class="st">.&quot;</span> path)</span>
<span id="cb170-124"><a href="#cb170-124" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;public, max-age=31536000, immutable&quot;</span><span class="op">]</span></span>
<span id="cb170-125"><a href="#cb170-125" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb170-126"><a href="#cb170-126" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Images and fonts</span></span>
<span id="cb170-127"><a href="#cb170-127" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">member</span> ext &#39;(<span class="st">&quot;.png&quot;</span> <span class="st">&quot;.jpg&quot;</span> <span class="st">&quot;.jpeg&quot;</span> <span class="st">&quot;.gif&quot;</span> <span class="st">&quot;.woff&quot;</span> <span class="st">&quot;.woff2&quot;</span>))</span>
<span id="cb170-128"><a href="#cb170-128" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;public, max-age=2592000&quot;</span><span class="op">]</span></span>
<span id="cb170-129"><a href="#cb170-129" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb170-130"><a href="#cb170-130" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; CSS and JS</span></span>
<span id="cb170-131"><a href="#cb170-131" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">member</span> ext &#39;(<span class="st">&quot;.css&quot;</span> <span class="st">&quot;.js&quot;</span>))</span>
<span id="cb170-132"><a href="#cb170-132" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;public, max-age=86400&quot;</span><span class="op">]</span></span>
<span id="cb170-133"><a href="#cb170-133" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb170-134"><a href="#cb170-134" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; HTML</span></span>
<span id="cb170-135"><a href="#cb170-135" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">equal?</span> ext <span class="st">&quot;.html&quot;</span>)</span>
<span id="cb170-136"><a href="#cb170-136" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;public, max-age=3600&quot;</span><span class="op">]</span></span>
<span id="cb170-137"><a href="#cb170-137" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb170-138"><a href="#cb170-138" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Default</span></span>
<span id="cb170-139"><a href="#cb170-139" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb170-140"><a href="#cb170-140" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;public, max-age=3600&quot;</span><span class="op">]</span>))</span>
<span id="cb170-141"><a href="#cb170-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-142"><a href="#cb170-142" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">list</span></span>
<span id="cb170-143"><a href="#cb170-143" aria-hidden="true" tabindex="-1"></a>   (make-header #<span class="st">&quot;Cache-Control&quot;</span></span>
<span id="cb170-144"><a href="#cb170-144" aria-hidden="true" tabindex="-1"></a>                (string-&gt;bytes/utf-8 cache-duration))</span>
<span id="cb170-145"><a href="#cb170-145" aria-hidden="true" tabindex="-1"></a>   (make-header #<span class="st">&quot;ETag&quot;</span></span>
<span id="cb170-146"><a href="#cb170-146" aria-hidden="true" tabindex="-1"></a>                (generate-etag path))))</span>
<span id="cb170-147"><a href="#cb170-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-148"><a href="#cb170-148" aria-hidden="true" tabindex="-1"></a><span class="co">;; Range request support</span></span>
<span id="cb170-149"><a href="#cb170-149" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(handle-range-request path req)</span>
<span id="cb170-150"><a href="#cb170-150" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> range-header</span></span>
<span id="cb170-151"><a href="#cb170-151" aria-hidden="true" tabindex="-1"></a>    (headers-assq* #<span class="st">&quot;Range&quot;</span> (request-headers/raw req)))</span>
<span id="cb170-152"><a href="#cb170-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-153"><a href="#cb170-153" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb170-154"><a href="#cb170-154" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">not</span> range-header) <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb170-155"><a href="#cb170-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-156"><a href="#cb170-156" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(regexp-match #rx<span class="st">&quot;bytes=([0-9]+)-([0-9]*)&quot;</span> range-header)</span>
<span id="cb170-157"><a href="#cb170-157" aria-hidden="true" tabindex="-1"></a>     <span class="op">=&gt;</span> (λ (matches)</span>
<span id="cb170-158"><a href="#cb170-158" aria-hidden="true" tabindex="-1"></a>          (<span class="ex">define</span><span class="fu"> start </span>(<span class="kw">string-&gt;number</span> (second matches)))</span>
<span id="cb170-159"><a href="#cb170-159" aria-hidden="true" tabindex="-1"></a>          (<span class="ex">define</span><span class="fu"> end </span>(<span class="kw">if</span> (<span class="kw">equal?</span> (third matches) <span class="st">&quot;&quot;</span>)</span>
<span id="cb170-160"><a href="#cb170-160" aria-hidden="true" tabindex="-1"></a>                         (<span class="op">-</span> (file-size path) <span class="dv">1</span>)</span>
<span id="cb170-161"><a href="#cb170-161" aria-hidden="true" tabindex="-1"></a>                         (<span class="kw">string-&gt;number</span> (third matches))))</span>
<span id="cb170-162"><a href="#cb170-162" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb170-163"><a href="#cb170-163" aria-hidden="true" tabindex="-1"></a>          (serve-partial-content path start end req))<span class="op">]</span></span>
<span id="cb170-164"><a href="#cb170-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-165"><a href="#cb170-165" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> <span class="dv">#f</span><span class="op">]</span>))</span>
<span id="cb170-166"><a href="#cb170-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-167"><a href="#cb170-167" aria-hidden="true" tabindex="-1"></a><span class="co">;; Directory listing</span></span>
<span id="cb170-168"><a href="#cb170-168" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(serve-directory-index dir req)</span>
<span id="cb170-169"><a href="#cb170-169" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> index-files </span>&#39;(<span class="st">&quot;index.html&quot;</span> <span class="st">&quot;index.htm&quot;</span>))</span>
<span id="cb170-170"><a href="#cb170-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-171"><a href="#cb170-171" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Look for index file</span></span>
<span id="cb170-172"><a href="#cb170-172" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> index-file</span></span>
<span id="cb170-173"><a href="#cb170-173" aria-hidden="true" tabindex="-1"></a>    (for/or (<span class="op">[</span>name index-files<span class="op">]</span>)</span>
<span id="cb170-174"><a href="#cb170-174" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> path </span>(build-path dir name))</span>
<span id="cb170-175"><a href="#cb170-175" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">and</span> (<span class="kw">file-exists?</span> path) path)))</span>
<span id="cb170-176"><a href="#cb170-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-177"><a href="#cb170-177" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> index-file</span>
<span id="cb170-178"><a href="#cb170-178" aria-hidden="true" tabindex="-1"></a>      (serve-static-file index-file req)</span>
<span id="cb170-179"><a href="#cb170-179" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">if</span> (server-config-dev-mode? (current-server-config))</span>
<span id="cb170-180"><a href="#cb170-180" aria-hidden="true" tabindex="-1"></a>          (serve-directory-listing dir req)</span>
<span id="cb170-181"><a href="#cb170-181" aria-hidden="true" tabindex="-1"></a>          (next-dispatcher))))</span>
<span id="cb170-182"><a href="#cb170-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-183"><a href="#cb170-183" aria-hidden="true" tabindex="-1"></a><span class="co">;; Development directory listing</span></span>
<span id="cb170-184"><a href="#cb170-184" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(serve-directory-listing dir req)</span>
<span id="cb170-185"><a href="#cb170-185" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> entries</span></span>
<span id="cb170-186"><a href="#cb170-186" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>entry (directory-list dir)<span class="op">]</span>)</span>
<span id="cb170-187"><a href="#cb170-187" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> path </span>(build-path dir entry))</span>
<span id="cb170-188"><a href="#cb170-188" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> is-dir? </span>(directory-exists? path))</span>
<span id="cb170-189"><a href="#cb170-189" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb170-190"><a href="#cb170-190" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">list</span> entry</span>
<span id="cb170-191"><a href="#cb170-191" aria-hidden="true" tabindex="-1"></a>            is-dir?</span>
<span id="cb170-192"><a href="#cb170-192" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">if</span> is-dir? <span class="dv">0</span> (file-size path))</span>
<span id="cb170-193"><a href="#cb170-193" aria-hidden="true" tabindex="-1"></a>            (file-or-directory-modify-seconds path))))</span>
<span id="cb170-194"><a href="#cb170-194" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-195"><a href="#cb170-195" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Sort entries (directories first)</span></span>
<span id="cb170-196"><a href="#cb170-196" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> sorted-entries</span></span>
<span id="cb170-197"><a href="#cb170-197" aria-hidden="true" tabindex="-1"></a>    (sort entries</span>
<span id="cb170-198"><a href="#cb170-198" aria-hidden="true" tabindex="-1"></a>          (λ (a b)</span>
<span id="cb170-199"><a href="#cb170-199" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">or</span> (<span class="kw">and</span> (second a) (<span class="kw">not</span> (second b)))</span>
<span id="cb170-200"><a href="#cb170-200" aria-hidden="true" tabindex="-1"></a>                (<span class="kw">string&lt;?</span> (path-&gt;string (first a))</span>
<span id="cb170-201"><a href="#cb170-201" aria-hidden="true" tabindex="-1"></a>                         (path-&gt;string (first b)))))))</span>
<span id="cb170-202"><a href="#cb170-202" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-203"><a href="#cb170-203" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate HTML</span></span>
<span id="cb170-204"><a href="#cb170-204" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> html</span></span>
<span id="cb170-205"><a href="#cb170-205" aria-hidden="true" tabindex="-1"></a>    (xexpr-&gt;string</span>
<span id="cb170-206"><a href="#cb170-206" aria-hidden="true" tabindex="-1"></a>     `(html</span>
<span id="cb170-207"><a href="#cb170-207" aria-hidden="true" tabindex="-1"></a>       (head</span>
<span id="cb170-208"><a href="#cb170-208" aria-hidden="true" tabindex="-1"></a>        (title ,(format <span class="st">&quot;Directory: ~a&quot;</span> dir))</span>
<span id="cb170-209"><a href="#cb170-209" aria-hidden="true" tabindex="-1"></a>        (style ,directory-listing-css))</span>
<span id="cb170-210"><a href="#cb170-210" aria-hidden="true" tabindex="-1"></a>       (body</span>
<span id="cb170-211"><a href="#cb170-211" aria-hidden="true" tabindex="-1"></a>        (h1 ,(format <span class="st">&quot;Index of ~a&quot;</span> (request-path req)))</span>
<span id="cb170-212"><a href="#cb170-212" aria-hidden="true" tabindex="-1"></a>        (table</span>
<span id="cb170-213"><a href="#cb170-213" aria-hidden="true" tabindex="-1"></a>         (thead</span>
<span id="cb170-214"><a href="#cb170-214" aria-hidden="true" tabindex="-1"></a>          (tr (th <span class="st">&quot;Name&quot;</span>) (th <span class="st">&quot;Size&quot;</span>) (th <span class="st">&quot;Modified&quot;</span>)))</span>
<span id="cb170-215"><a href="#cb170-215" aria-hidden="true" tabindex="-1"></a>         (tbody</span>
<span id="cb170-216"><a href="#cb170-216" aria-hidden="true" tabindex="-1"></a>          ,@(for/list (<span class="op">[</span>entry sorted-entries<span class="op">]</span>)</span>
<span id="cb170-217"><a href="#cb170-217" aria-hidden="true" tabindex="-1"></a>              (match-define (<span class="kw">list</span> name is-dir? size mtime) entry)</span>
<span id="cb170-218"><a href="#cb170-218" aria-hidden="true" tabindex="-1"></a>              `(tr</span>
<span id="cb170-219"><a href="#cb170-219" aria-hidden="true" tabindex="-1"></a>                (td (a ((href ,(path-&gt;string name)))</span>
<span id="cb170-220"><a href="#cb170-220" aria-hidden="true" tabindex="-1"></a>                      ,(format <span class="st">&quot;~a~a&quot;</span> </span>
<span id="cb170-221"><a href="#cb170-221" aria-hidden="true" tabindex="-1"></a>                               (path-&gt;string name)</span>
<span id="cb170-222"><a href="#cb170-222" aria-hidden="true" tabindex="-1"></a>                               (<span class="kw">if</span> is-dir? <span class="st">&quot;/&quot;</span> <span class="st">&quot;&quot;</span>))))</span>
<span id="cb170-223"><a href="#cb170-223" aria-hidden="true" tabindex="-1"></a>                (td ,(<span class="kw">if</span> is-dir? <span class="st">&quot;-&quot;</span> (format-file-size size)))</span>
<span id="cb170-224"><a href="#cb170-224" aria-hidden="true" tabindex="-1"></a>                (td ,(format-timestamp mtime))))))))))</span>
<span id="cb170-225"><a href="#cb170-225" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-226"><a href="#cb170-226" aria-hidden="true" tabindex="-1"></a>  (response/xexpr html))</span></code></pre></div>
<h2 id="api-endpoints-and-json-handling">API Endpoints and JSON
Handling</h2>
<p>RESTful API support for dynamic features:</p>
<div class="sourceCode" id="cb171"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; api-endpoints.rkt</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>(require json</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>         web-server/http)</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>(provide api-dispatcher</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>         json-response</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>         api-route)</span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; API route builder</span></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(api-dispatcher site-config)</span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>  (route-dispatcher</span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>   (routes</span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Search API</span></span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a>    (get <span class="st">&quot;/api/search&quot;</span> </span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a>         (search-handler site-config))</span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Content preview</span></span>
<span id="cb171-20"><a href="#cb171-20" aria-hidden="true" tabindex="-1"></a>    (post <span class="st">&quot;/api/preview&quot;</span></span>
<span id="cb171-21"><a href="#cb171-21" aria-hidden="true" tabindex="-1"></a>          (preview-handler site-config)</span>
<span id="cb171-22"><a href="#cb171-22" aria-hidden="true" tabindex="-1"></a>          #:middleware &#39;(json-body))</span>
<span id="cb171-23"><a href="#cb171-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-24"><a href="#cb171-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Site metadata</span></span>
<span id="cb171-25"><a href="#cb171-25" aria-hidden="true" tabindex="-1"></a>    (get <span class="st">&quot;/api/site/meta&quot;</span></span>
<span id="cb171-26"><a href="#cb171-26" aria-hidden="true" tabindex="-1"></a>         (site-metadata-handler site-config))</span>
<span id="cb171-27"><a href="#cb171-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-28"><a href="#cb171-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Build status</span></span>
<span id="cb171-29"><a href="#cb171-29" aria-hidden="true" tabindex="-1"></a>    (get <span class="st">&quot;/api/build/status&quot;</span></span>
<span id="cb171-30"><a href="#cb171-30" aria-hidden="true" tabindex="-1"></a>         (build-status-handler))</span>
<span id="cb171-31"><a href="#cb171-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-32"><a href="#cb171-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; WebSocket info</span></span>
<span id="cb171-33"><a href="#cb171-33" aria-hidden="true" tabindex="-1"></a>    (get <span class="st">&quot;/api/websocket/info&quot;</span></span>
<span id="cb171-34"><a href="#cb171-34" aria-hidden="true" tabindex="-1"></a>         (websocket-info-handler)))))</span>
<span id="cb171-35"><a href="#cb171-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-36"><a href="#cb171-36" aria-hidden="true" tabindex="-1"></a><span class="co">;; JSON response helper</span></span>
<span id="cb171-37"><a href="#cb171-37" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(json-response data <span class="op">[</span>status <span class="dv">200</span><span class="op">]</span> <span class="op">[</span>headers &#39;()<span class="op">]</span>)</span>
<span id="cb171-38"><a href="#cb171-38" aria-hidden="true" tabindex="-1"></a>  (response/full</span>
<span id="cb171-39"><a href="#cb171-39" aria-hidden="true" tabindex="-1"></a>   status</span>
<span id="cb171-40"><a href="#cb171-40" aria-hidden="true" tabindex="-1"></a>   (status-&gt;message status)</span>
<span id="cb171-41"><a href="#cb171-41" aria-hidden="true" tabindex="-1"></a>   (current-seconds)</span>
<span id="cb171-42"><a href="#cb171-42" aria-hidden="true" tabindex="-1"></a>   #<span class="st">&quot;application/json; charset=utf-8&quot;</span></span>
<span id="cb171-43"><a href="#cb171-43" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">append</span> headers</span>
<span id="cb171-44"><a href="#cb171-44" aria-hidden="true" tabindex="-1"></a>           &#39;((#<span class="st">&quot;Cache-Control&quot;</span> <span class="op">.</span> #<span class="st">&quot;no-cache&quot;</span>)))</span>
<span id="cb171-45"><a href="#cb171-45" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span> (string-&gt;bytes/utf-8</span>
<span id="cb171-46"><a href="#cb171-46" aria-hidden="true" tabindex="-1"></a>          (jsexpr-&gt;string data)))))</span>
<span id="cb171-47"><a href="#cb171-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-48"><a href="#cb171-48" aria-hidden="true" tabindex="-1"></a><span class="co">;; Error response</span></span>
<span id="cb171-49"><a href="#cb171-49" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(api-error message <span class="op">[</span>status <span class="dv">400</span><span class="op">]</span> <span class="op">[</span>details <span class="dv">#f</span><span class="op">]</span>)</span>
<span id="cb171-50"><a href="#cb171-50" aria-hidden="true" tabindex="-1"></a>  (json-response</span>
<span id="cb171-51"><a href="#cb171-51" aria-hidden="true" tabindex="-1"></a>   (hash &#39;error <span class="dv">#t</span></span>
<span id="cb171-52"><a href="#cb171-52" aria-hidden="true" tabindex="-1"></a>         &#39;message message</span>
<span id="cb171-53"><a href="#cb171-53" aria-hidden="true" tabindex="-1"></a>         &#39;details details)</span>
<span id="cb171-54"><a href="#cb171-54" aria-hidden="true" tabindex="-1"></a>   status))</span>
<span id="cb171-55"><a href="#cb171-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-56"><a href="#cb171-56" aria-hidden="true" tabindex="-1"></a><span class="co">;; Search endpoint</span></span>
<span id="cb171-57"><a href="#cb171-57" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(search-handler site-config)</span>
<span id="cb171-58"><a href="#cb171-58" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb171-59"><a href="#cb171-59" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> params </span>(request-query req))</span>
<span id="cb171-60"><a href="#cb171-60" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> query </span>(hash-ref params &#39;q <span class="st">&quot;&quot;</span>))</span>
<span id="cb171-61"><a href="#cb171-61" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> limit </span>(<span class="kw">string-&gt;number</span> </span>
<span id="cb171-62"><a href="#cb171-62" aria-hidden="true" tabindex="-1"></a>                  (hash-ref params &#39;limit <span class="st">&quot;10&quot;</span>)))</span>
<span id="cb171-63"><a href="#cb171-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-64"><a href="#cb171-64" aria-hidden="true" tabindex="-1"></a>    (with-handlers (<span class="op">[</span>exn:fail? </span>
<span id="cb171-65"><a href="#cb171-65" aria-hidden="true" tabindex="-1"></a>                    (λ (e)</span>
<span id="cb171-66"><a href="#cb171-66" aria-hidden="true" tabindex="-1"></a>                      (api-error <span class="st">&quot;Search failed&quot;</span></span>
<span id="cb171-67"><a href="#cb171-67" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">500</span></span>
<span id="cb171-68"><a href="#cb171-68" aria-hidden="true" tabindex="-1"></a>                                (exn-message e)))<span class="op">]</span>)</span>
<span id="cb171-69"><a href="#cb171-69" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> results</span></span>
<span id="cb171-70"><a href="#cb171-70" aria-hidden="true" tabindex="-1"></a>        (perform-search site-config query limit))</span>
<span id="cb171-71"><a href="#cb171-71" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb171-72"><a href="#cb171-72" aria-hidden="true" tabindex="-1"></a>      (json-response</span>
<span id="cb171-73"><a href="#cb171-73" aria-hidden="true" tabindex="-1"></a>       (hash &#39;query query</span>
<span id="cb171-74"><a href="#cb171-74" aria-hidden="true" tabindex="-1"></a>             &#39;results results</span>
<span id="cb171-75"><a href="#cb171-75" aria-hidden="true" tabindex="-1"></a>             &#39;count (<span class="kw">length</span> results))))))</span>
<span id="cb171-76"><a href="#cb171-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-77"><a href="#cb171-77" aria-hidden="true" tabindex="-1"></a><span class="co">;; Content preview endpoint</span></span>
<span id="cb171-78"><a href="#cb171-78" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(preview-handler site-config)</span>
<span id="cb171-79"><a href="#cb171-79" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb171-80"><a href="#cb171-80" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> data </span>(request-json req))</span>
<span id="cb171-81"><a href="#cb171-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-82"><a href="#cb171-82" aria-hidden="true" tabindex="-1"></a>    (unless data</span>
<span id="cb171-83"><a href="#cb171-83" aria-hidden="true" tabindex="-1"></a>      (return (api-error <span class="st">&quot;Invalid JSON body&quot;</span>)))</span>
<span id="cb171-84"><a href="#cb171-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-85"><a href="#cb171-85" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> content </span>(hash-ref data &#39;content <span class="st">&quot;&quot;</span>))</span>
<span id="cb171-86"><a href="#cb171-86" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> format </span>(hash-ref data &#39;format <span class="st">&quot;markdown&quot;</span>))</span>
<span id="cb171-87"><a href="#cb171-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-88"><a href="#cb171-88" aria-hidden="true" tabindex="-1"></a>    (with-handlers (<span class="op">[</span>exn:fail?</span>
<span id="cb171-89"><a href="#cb171-89" aria-hidden="true" tabindex="-1"></a>                    (λ (e)</span>
<span id="cb171-90"><a href="#cb171-90" aria-hidden="true" tabindex="-1"></a>                      (api-error <span class="st">&quot;Preview failed&quot;</span> </span>
<span id="cb171-91"><a href="#cb171-91" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">500</span> </span>
<span id="cb171-92"><a href="#cb171-92" aria-hidden="true" tabindex="-1"></a>                                (exn-message e)))<span class="op">]</span>)</span>
<span id="cb171-93"><a href="#cb171-93" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Process content</span></span>
<span id="cb171-94"><a href="#cb171-94" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> html</span></span>
<span id="cb171-95"><a href="#cb171-95" aria-hidden="true" tabindex="-1"></a>        (render-preview site-config content format))</span>
<span id="cb171-96"><a href="#cb171-96" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb171-97"><a href="#cb171-97" aria-hidden="true" tabindex="-1"></a>      (json-response</span>
<span id="cb171-98"><a href="#cb171-98" aria-hidden="true" tabindex="-1"></a>       (hash &#39;html html</span>
<span id="cb171-99"><a href="#cb171-99" aria-hidden="true" tabindex="-1"></a>             &#39;wordCount (count-words content)</span>
<span id="cb171-100"><a href="#cb171-100" aria-hidden="true" tabindex="-1"></a>             &#39;readingTime (estimate-reading-time content))))))</span>
<span id="cb171-101"><a href="#cb171-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-102"><a href="#cb171-102" aria-hidden="true" tabindex="-1"></a><span class="co">;; Request JSON parsing</span></span>
<span id="cb171-103"><a href="#cb171-103" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(request-json req)</span>
<span id="cb171-104"><a href="#cb171-104" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> content-type</span></span>
<span id="cb171-105"><a href="#cb171-105" aria-hidden="true" tabindex="-1"></a>    (headers-assq* #<span class="st">&quot;Content-Type&quot;</span> </span>
<span id="cb171-106"><a href="#cb171-106" aria-hidden="true" tabindex="-1"></a>                   (request-headers/raw req)))</span>
<span id="cb171-107"><a href="#cb171-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-108"><a href="#cb171-108" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">and</span> content-type</span>
<span id="cb171-109"><a href="#cb171-109" aria-hidden="true" tabindex="-1"></a>       (regexp-match? #rx<span class="st">&quot;application/json&quot;</span> content-type)</span>
<span id="cb171-110"><a href="#cb171-110" aria-hidden="true" tabindex="-1"></a>       (with-handlers (<span class="op">[</span>exn:fail? (λ (e) <span class="dv">#f</span>)<span class="op">]</span>)</span>
<span id="cb171-111"><a href="#cb171-111" aria-hidden="true" tabindex="-1"></a>         (bytes-&gt;jsexpr (request-post-data/raw req)))))</span>
<span id="cb171-112"><a href="#cb171-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-113"><a href="#cb171-113" aria-hidden="true" tabindex="-1"></a><span class="co">;; JSON body middleware</span></span>
<span id="cb171-114"><a href="#cb171-114" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(json-body-middleware handler)</span>
<span id="cb171-115"><a href="#cb171-115" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb171-116"><a href="#cb171-116" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> json </span>(request-json req))</span>
<span id="cb171-117"><a href="#cb171-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-118"><a href="#cb171-118" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (<span class="kw">and</span> (request-post-data/raw req)</span>
<span id="cb171-119"><a href="#cb171-119" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">not</span> json))</span>
<span id="cb171-120"><a href="#cb171-120" aria-hidden="true" tabindex="-1"></a>        (api-error <span class="st">&quot;Invalid JSON body&quot;</span> <span class="dv">400</span>)</span>
<span id="cb171-121"><a href="#cb171-121" aria-hidden="true" tabindex="-1"></a>        (handler (struct-copy request req</span>
<span id="cb171-122"><a href="#cb171-122" aria-hidden="true" tabindex="-1"></a>                             <span class="op">[</span>post-data/raw json<span class="op">]</span>)))))</span>
<span id="cb171-123"><a href="#cb171-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-124"><a href="#cb171-124" aria-hidden="true" tabindex="-1"></a><span class="co">;; Pagination helpers</span></span>
<span id="cb171-125"><a href="#cb171-125" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(paginate-response items page per-page total)</span>
<span id="cb171-126"><a href="#cb171-126" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> total-pages </span>(<span class="kw">ceiling</span> (<span class="op">/</span> total per-page)))</span>
<span id="cb171-127"><a href="#cb171-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb171-128"><a href="#cb171-128" aria-hidden="true" tabindex="-1"></a>  (hash &#39;items items</span>
<span id="cb171-129"><a href="#cb171-129" aria-hidden="true" tabindex="-1"></a>        &#39;pagination</span>
<span id="cb171-130"><a href="#cb171-130" aria-hidden="true" tabindex="-1"></a>        (hash &#39;page page</span>
<span id="cb171-131"><a href="#cb171-131" aria-hidden="true" tabindex="-1"></a>              &#39;perPage per-page</span>
<span id="cb171-132"><a href="#cb171-132" aria-hidden="true" tabindex="-1"></a>              &#39;total total</span>
<span id="cb171-133"><a href="#cb171-133" aria-hidden="true" tabindex="-1"></a>              &#39;totalPages total-pages</span>
<span id="cb171-134"><a href="#cb171-134" aria-hidden="true" tabindex="-1"></a>              &#39;hasNext (<span class="op">&lt;</span> page total-pages)</span>
<span id="cb171-135"><a href="#cb171-135" aria-hidden="true" tabindex="-1"></a>              &#39;hasPrev (<span class="op">&gt;</span> page <span class="dv">1</span>))))</span>
<span id="cb171-136"><a href="#cb171-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-137"><a href="#cb171-137" aria-hidden="true" tabindex="-1"></a><span class="co">;; API rate limiting</span></span>
<span id="cb171-138"><a href="#cb171-138" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> rate-limiter</span></span>
<span id="cb171-139"><a href="#cb171-139" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> (<span class="op">[</span>requests (make-hash)<span class="op">]</span></span>
<span id="cb171-140"><a href="#cb171-140" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>window <span class="dv">60</span><span class="op">]</span>) <span class="co">; 60 seconds</span></span>
<span id="cb171-141"><a href="#cb171-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-142"><a href="#cb171-142" aria-hidden="true" tabindex="-1"></a>    (λ (key limit)</span>
<span id="cb171-143"><a href="#cb171-143" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> now </span>(current-seconds))</span>
<span id="cb171-144"><a href="#cb171-144" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> user-requests</span></span>
<span id="cb171-145"><a href="#cb171-145" aria-hidden="true" tabindex="-1"></a>        (hash-ref requests key &#39;()))</span>
<span id="cb171-146"><a href="#cb171-146" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb171-147"><a href="#cb171-147" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Clean old requests</span></span>
<span id="cb171-148"><a href="#cb171-148" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> recent</span></span>
<span id="cb171-149"><a href="#cb171-149" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">filter</span> (λ (t) (<span class="op">&gt;</span> t (<span class="op">-</span> now window)))</span>
<span id="cb171-150"><a href="#cb171-150" aria-hidden="true" tabindex="-1"></a>                user-requests))</span>
<span id="cb171-151"><a href="#cb171-151" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb171-152"><a href="#cb171-152" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Check limit</span></span>
<span id="cb171-153"><a href="#cb171-153" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">cond</span></span>
<span id="cb171-154"><a href="#cb171-154" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="op">&gt;=</span> (<span class="kw">length</span> recent) limit)</span>
<span id="cb171-155"><a href="#cb171-155" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">values</span> <span class="dv">#f</span> (<span class="op">-</span> (<span class="op">+</span> (first recent) window) now))<span class="op">]</span></span>
<span id="cb171-156"><a href="#cb171-156" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb171-157"><a href="#cb171-157" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span><span class="kw">else</span></span>
<span id="cb171-158"><a href="#cb171-158" aria-hidden="true" tabindex="-1"></a>         (hash-set! requests key (<span class="kw">cons</span> now recent))</span>
<span id="cb171-159"><a href="#cb171-159" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">values</span> <span class="dv">#t</span> <span class="dv">#f</span>)<span class="op">]</span>))))</span>
<span id="cb171-160"><a href="#cb171-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-161"><a href="#cb171-161" aria-hidden="true" tabindex="-1"></a><span class="co">;; Rate limiting middleware</span></span>
<span id="cb171-162"><a href="#cb171-162" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(rate-limit-middleware limit)</span>
<span id="cb171-163"><a href="#cb171-163" aria-hidden="true" tabindex="-1"></a>  (λ (handler)</span>
<span id="cb171-164"><a href="#cb171-164" aria-hidden="true" tabindex="-1"></a>    (λ (req)</span>
<span id="cb171-165"><a href="#cb171-165" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> client-ip </span>(request-client-ip req))</span>
<span id="cb171-166"><a href="#cb171-166" aria-hidden="true" tabindex="-1"></a>      (define-values (allowed? retry-after)</span>
<span id="cb171-167"><a href="#cb171-167" aria-hidden="true" tabindex="-1"></a>        (rate-limiter client-ip limit))</span>
<span id="cb171-168"><a href="#cb171-168" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb171-169"><a href="#cb171-169" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">if</span> allowed?</span>
<span id="cb171-170"><a href="#cb171-170" aria-hidden="true" tabindex="-1"></a>          (handler req)</span>
<span id="cb171-171"><a href="#cb171-171" aria-hidden="true" tabindex="-1"></a>          (response/full</span>
<span id="cb171-172"><a href="#cb171-172" aria-hidden="true" tabindex="-1"></a>           <span class="dv">429</span> #<span class="st">&quot;Too Many Requests&quot;</span></span>
<span id="cb171-173"><a href="#cb171-173" aria-hidden="true" tabindex="-1"></a>           (current-seconds)</span>
<span id="cb171-174"><a href="#cb171-174" aria-hidden="true" tabindex="-1"></a>           TEXT/HTML-MIME-TYPE</span>
<span id="cb171-175"><a href="#cb171-175" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">list</span> (make-header #<span class="st">&quot;Retry-After&quot;</span></span>
<span id="cb171-176"><a href="#cb171-176" aria-hidden="true" tabindex="-1"></a>                             (string-&gt;bytes/utf-8</span>
<span id="cb171-177"><a href="#cb171-177" aria-hidden="true" tabindex="-1"></a>                              (<span class="kw">number-&gt;string</span> retry-after))))</span>
<span id="cb171-178"><a href="#cb171-178" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">list</span> #<span class="st">&quot;Rate limit exceeded&quot;</span>))))))</span></code></pre></div>
<h2 id="websocket-support">WebSocket Support</h2>
<p>Real-time communication for live features:</p>
<div class="sourceCode" id="cb172"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; websocket-server.rkt</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>(require net/websocket</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>         net/websocket/server)</span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>(provide websocket-dispatcher</span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>         broadcast-message</span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a>         websocket-handler)</span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; WebSocket connection manager</span></span>
<span id="cb172-12"><a href="#cb172-12" aria-hidden="true" tabindex="-1"></a>(struct ws-manager</span>
<span id="cb172-13"><a href="#cb172-13" aria-hidden="true" tabindex="-1"></a>  (connections     <span class="co">; Active connections</span></span>
<span id="cb172-14"><a href="#cb172-14" aria-hidden="true" tabindex="-1"></a>   topics          <span class="co">; Topic subscriptions</span></span>
<span id="cb172-15"><a href="#cb172-15" aria-hidden="true" tabindex="-1"></a>   handlers        <span class="co">; Message handlers</span></span>
<span id="cb172-16"><a href="#cb172-16" aria-hidden="true" tabindex="-1"></a>   stats)          <span class="co">; Connection statistics</span></span>
<span id="cb172-17"><a href="#cb172-17" aria-hidden="true" tabindex="-1"></a>  #:mutable</span>
<span id="cb172-18"><a href="#cb172-18" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb172-19"><a href="#cb172-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-20"><a href="#cb172-20" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> current-ws-manager </span>(make-parameter <span class="dv">#f</span>))</span>
<span id="cb172-21"><a href="#cb172-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-22"><a href="#cb172-22" aria-hidden="true" tabindex="-1"></a><span class="co">;; Initialize WebSocket manager</span></span>
<span id="cb172-23"><a href="#cb172-23" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-websocket-manager)</span>
<span id="cb172-24"><a href="#cb172-24" aria-hidden="true" tabindex="-1"></a>  (ws-manager</span>
<span id="cb172-25"><a href="#cb172-25" aria-hidden="true" tabindex="-1"></a>   (make-hash)     <span class="co">; connections</span></span>
<span id="cb172-26"><a href="#cb172-26" aria-hidden="true" tabindex="-1"></a>   (make-hash)     <span class="co">; topics</span></span>
<span id="cb172-27"><a href="#cb172-27" aria-hidden="true" tabindex="-1"></a>   (make-hash)     <span class="co">; handlers</span></span>
<span id="cb172-28"><a href="#cb172-28" aria-hidden="true" tabindex="-1"></a>   (make-hash)))   <span class="co">; stats</span></span>
<span id="cb172-29"><a href="#cb172-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-30"><a href="#cb172-30" aria-hidden="true" tabindex="-1"></a><span class="co">;; WebSocket route handler</span></span>
<span id="cb172-31"><a href="#cb172-31" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(websocket-dispatcher)</span>
<span id="cb172-32"><a href="#cb172-32" aria-hidden="true" tabindex="-1"></a>  (routes</span>
<span id="cb172-33"><a href="#cb172-33" aria-hidden="true" tabindex="-1"></a>   (get <span class="st">&quot;/ws&quot;</span> websocket-endpoint)</span>
<span id="cb172-34"><a href="#cb172-34" aria-hidden="true" tabindex="-1"></a>   (get <span class="st">&quot;/ws/livereload&quot;</span> livereload-endpoint)</span>
<span id="cb172-35"><a href="#cb172-35" aria-hidden="true" tabindex="-1"></a>   (get <span class="st">&quot;/ws/api&quot;</span> api-websocket-endpoint)))</span>
<span id="cb172-36"><a href="#cb172-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-37"><a href="#cb172-37" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main WebSocket endpoint</span></span>
<span id="cb172-38"><a href="#cb172-38" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(websocket-endpoint req)</span>
<span id="cb172-39"><a href="#cb172-39" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> conn-id </span>(generate-connection-id))</span>
<span id="cb172-40"><a href="#cb172-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-41"><a href="#cb172-41" aria-hidden="true" tabindex="-1"></a>  (ws-serve</span>
<span id="cb172-42"><a href="#cb172-42" aria-hidden="true" tabindex="-1"></a>   #:port (request-port req)</span>
<span id="cb172-43"><a href="#cb172-43" aria-hidden="true" tabindex="-1"></a>   (λ (conn)</span>
<span id="cb172-44"><a href="#cb172-44" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Register connection</span></span>
<span id="cb172-45"><a href="#cb172-45" aria-hidden="true" tabindex="-1"></a>     (register-connection! conn-id conn)</span>
<span id="cb172-46"><a href="#cb172-46" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb172-47"><a href="#cb172-47" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Connection handler</span></span>
<span id="cb172-48"><a href="#cb172-48" aria-hidden="true" tabindex="-1"></a>     (with-handlers (<span class="op">[</span>exn:fail? </span>
<span id="cb172-49"><a href="#cb172-49" aria-hidden="true" tabindex="-1"></a>                     (λ (e)</span>
<span id="cb172-50"><a href="#cb172-50" aria-hidden="true" tabindex="-1"></a>                       (log-error <span class="st">&quot;WebSocket error: ~a&quot;</span> e)</span>
<span id="cb172-51"><a href="#cb172-51" aria-hidden="true" tabindex="-1"></a>                       (close-connection! conn-id))<span class="op">]</span>)</span>
<span id="cb172-52"><a href="#cb172-52" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Send welcome message</span></span>
<span id="cb172-53"><a href="#cb172-53" aria-hidden="true" tabindex="-1"></a>       (ws-send! conn </span>
<span id="cb172-54"><a href="#cb172-54" aria-hidden="true" tabindex="-1"></a>                (jsexpr-&gt;string</span>
<span id="cb172-55"><a href="#cb172-55" aria-hidden="true" tabindex="-1"></a>                 (hash &#39;type <span class="st">&quot;welcome&quot;</span></span>
<span id="cb172-56"><a href="#cb172-56" aria-hidden="true" tabindex="-1"></a>                       &#39;id conn-id)))</span>
<span id="cb172-57"><a href="#cb172-57" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb172-58"><a href="#cb172-58" aria-hidden="true" tabindex="-1"></a>       <span class="co">;; Message loop</span></span>
<span id="cb172-59"><a href="#cb172-59" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">let</span> loop ()</span>
<span id="cb172-60"><a href="#cb172-60" aria-hidden="true" tabindex="-1"></a>         (<span class="ex">define</span><span class="fu"> msg </span>(ws-recv conn))</span>
<span id="cb172-61"><a href="#cb172-61" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb172-62"><a href="#cb172-62" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">cond</span></span>
<span id="cb172-63"><a href="#cb172-63" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="kw">eof-object?</span> msg)</span>
<span id="cb172-64"><a href="#cb172-64" aria-hidden="true" tabindex="-1"></a>            (close-connection! conn-id)<span class="op">]</span></span>
<span id="cb172-65"><a href="#cb172-65" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb172-66"><a href="#cb172-66" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(<span class="kw">string?</span> msg)</span>
<span id="cb172-67"><a href="#cb172-67" aria-hidden="true" tabindex="-1"></a>            (handle-text-message conn-id msg)</span>
<span id="cb172-68"><a href="#cb172-68" aria-hidden="true" tabindex="-1"></a>            (loop)<span class="op">]</span></span>
<span id="cb172-69"><a href="#cb172-69" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb172-70"><a href="#cb172-70" aria-hidden="true" tabindex="-1"></a>           <span class="op">[</span>(bytes? msg)</span>
<span id="cb172-71"><a href="#cb172-71" aria-hidden="true" tabindex="-1"></a>            (handle-binary-message conn-id msg)</span>
<span id="cb172-72"><a href="#cb172-72" aria-hidden="true" tabindex="-1"></a>            (loop)<span class="op">]</span>))))))</span>
<span id="cb172-73"><a href="#cb172-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-74"><a href="#cb172-74" aria-hidden="true" tabindex="-1"></a><span class="co">;; Handle incoming messages</span></span>
<span id="cb172-75"><a href="#cb172-75" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(handle-text-message conn-id message)</span>
<span id="cb172-76"><a href="#cb172-76" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> data</span></span>
<span id="cb172-77"><a href="#cb172-77" aria-hidden="true" tabindex="-1"></a>    (with-handlers (<span class="op">[</span>exn:fail? (λ (e) <span class="dv">#f</span>)<span class="op">]</span>)</span>
<span id="cb172-78"><a href="#cb172-78" aria-hidden="true" tabindex="-1"></a>      (string-&gt;jsexpr message)))</span>
<span id="cb172-79"><a href="#cb172-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-80"><a href="#cb172-80" aria-hidden="true" tabindex="-1"></a>  (when data</span>
<span id="cb172-81"><a href="#cb172-81" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> msg-type </span>(hash-ref data &#39;type <span class="dv">#f</span>))</span>
<span id="cb172-82"><a href="#cb172-82" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> handler </span>(get-message-handler msg-type))</span>
<span id="cb172-83"><a href="#cb172-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb172-84"><a href="#cb172-84" aria-hidden="true" tabindex="-1"></a>    (when handler</span>
<span id="cb172-85"><a href="#cb172-85" aria-hidden="true" tabindex="-1"></a>      (handler conn-id data))))</span>
<span id="cb172-86"><a href="#cb172-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-87"><a href="#cb172-87" aria-hidden="true" tabindex="-1"></a><span class="co">;; Message handlers</span></span>
<span id="cb172-88"><a href="#cb172-88" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(register-message-handlers!)</span>
<span id="cb172-89"><a href="#cb172-89" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> manager </span>(current-ws-manager))</span>
<span id="cb172-90"><a href="#cb172-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-91"><a href="#cb172-91" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Subscribe to topic</span></span>
<span id="cb172-92"><a href="#cb172-92" aria-hidden="true" tabindex="-1"></a>  (register-handler! &#39;subscribe</span>
<span id="cb172-93"><a href="#cb172-93" aria-hidden="true" tabindex="-1"></a>    (λ (conn-id data)</span>
<span id="cb172-94"><a href="#cb172-94" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> topic </span>(hash-ref data &#39;topic))</span>
<span id="cb172-95"><a href="#cb172-95" aria-hidden="true" tabindex="-1"></a>      (subscribe-to-topic! conn-id topic)))</span>
<span id="cb172-96"><a href="#cb172-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-97"><a href="#cb172-97" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Unsubscribe from topic</span></span>
<span id="cb172-98"><a href="#cb172-98" aria-hidden="true" tabindex="-1"></a>  (register-handler! &#39;unsubscribe</span>
<span id="cb172-99"><a href="#cb172-99" aria-hidden="true" tabindex="-1"></a>    (λ (conn-id data)</span>
<span id="cb172-100"><a href="#cb172-100" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> topic </span>(hash-ref data &#39;topic))</span>
<span id="cb172-101"><a href="#cb172-101" aria-hidden="true" tabindex="-1"></a>      (unsubscribe-from-topic! conn-id topic)))</span>
<span id="cb172-102"><a href="#cb172-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-103"><a href="#cb172-103" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Echo message (for testing)</span></span>
<span id="cb172-104"><a href="#cb172-104" aria-hidden="true" tabindex="-1"></a>  (register-handler! &#39;echo</span>
<span id="cb172-105"><a href="#cb172-105" aria-hidden="true" tabindex="-1"></a>    (λ (conn-id data)</span>
<span id="cb172-106"><a href="#cb172-106" aria-hidden="true" tabindex="-1"></a>      (send-to-connection conn-id data)))</span>
<span id="cb172-107"><a href="#cb172-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-108"><a href="#cb172-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Broadcast to topic</span></span>
<span id="cb172-109"><a href="#cb172-109" aria-hidden="true" tabindex="-1"></a>  (register-handler! &#39;broadcast</span>
<span id="cb172-110"><a href="#cb172-110" aria-hidden="true" tabindex="-1"></a>    (λ (conn-id data)</span>
<span id="cb172-111"><a href="#cb172-111" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> topic </span>(hash-ref data &#39;topic))</span>
<span id="cb172-112"><a href="#cb172-112" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> message </span>(hash-ref data &#39;message))</span>
<span id="cb172-113"><a href="#cb172-113" aria-hidden="true" tabindex="-1"></a>      (broadcast-to-topic topic message))))</span>
<span id="cb172-114"><a href="#cb172-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-115"><a href="#cb172-115" aria-hidden="true" tabindex="-1"></a><span class="co">;; Topic pub/sub</span></span>
<span id="cb172-116"><a href="#cb172-116" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(subscribe-to-topic! conn-id topic)</span>
<span id="cb172-117"><a href="#cb172-117" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> manager </span>(current-ws-manager))</span>
<span id="cb172-118"><a href="#cb172-118" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> topics </span>(ws-manager-topics manager))</span>
<span id="cb172-119"><a href="#cb172-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-120"><a href="#cb172-120" aria-hidden="true" tabindex="-1"></a>  (hash-update! topics topic</span>
<span id="cb172-121"><a href="#cb172-121" aria-hidden="true" tabindex="-1"></a>                (λ (conns) (set-add conns conn-id))</span>
<span id="cb172-122"><a href="#cb172-122" aria-hidden="true" tabindex="-1"></a>                (set)))</span>
<span id="cb172-123"><a href="#cb172-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-124"><a href="#cb172-124" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(broadcast-to-topic topic message)</span>
<span id="cb172-125"><a href="#cb172-125" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> manager </span>(current-ws-manager))</span>
<span id="cb172-126"><a href="#cb172-126" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> topics </span>(ws-manager-topics manager))</span>
<span id="cb172-127"><a href="#cb172-127" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> subscribers </span>(hash-ref topics topic (set)))</span>
<span id="cb172-128"><a href="#cb172-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-129"><a href="#cb172-129" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>conn-id (in-set subscribers)<span class="op">]</span>)</span>
<span id="cb172-130"><a href="#cb172-130" aria-hidden="true" tabindex="-1"></a>    (send-to-connection </span>
<span id="cb172-131"><a href="#cb172-131" aria-hidden="true" tabindex="-1"></a>     conn-id</span>
<span id="cb172-132"><a href="#cb172-132" aria-hidden="true" tabindex="-1"></a>     (hash &#39;type <span class="st">&quot;message&quot;</span></span>
<span id="cb172-133"><a href="#cb172-133" aria-hidden="true" tabindex="-1"></a>           &#39;topic topic</span>
<span id="cb172-134"><a href="#cb172-134" aria-hidden="true" tabindex="-1"></a>           &#39;data message))))</span>
<span id="cb172-135"><a href="#cb172-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-136"><a href="#cb172-136" aria-hidden="true" tabindex="-1"></a><span class="co">;; Live reload WebSocket</span></span>
<span id="cb172-137"><a href="#cb172-137" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(livereload-endpoint req)</span>
<span id="cb172-138"><a href="#cb172-138" aria-hidden="true" tabindex="-1"></a>  (ws-serve</span>
<span id="cb172-139"><a href="#cb172-139" aria-hidden="true" tabindex="-1"></a>   #:port (request-port req)</span>
<span id="cb172-140"><a href="#cb172-140" aria-hidden="true" tabindex="-1"></a>   (λ (conn)</span>
<span id="cb172-141"><a href="#cb172-141" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> conn-id </span>(generate-connection-id))</span>
<span id="cb172-142"><a href="#cb172-142" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb172-143"><a href="#cb172-143" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Register as live reload client</span></span>
<span id="cb172-144"><a href="#cb172-144" aria-hidden="true" tabindex="-1"></a>     (subscribe-to-topic! conn-id &#39;livereload)</span>
<span id="cb172-145"><a href="#cb172-145" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb172-146"><a href="#cb172-146" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Send initial status</span></span>
<span id="cb172-147"><a href="#cb172-147" aria-hidden="true" tabindex="-1"></a>     (ws-send! conn</span>
<span id="cb172-148"><a href="#cb172-148" aria-hidden="true" tabindex="-1"></a>              (jsexpr-&gt;string</span>
<span id="cb172-149"><a href="#cb172-149" aria-hidden="true" tabindex="-1"></a>               (hash &#39;command <span class="st">&quot;hello&quot;</span></span>
<span id="cb172-150"><a href="#cb172-150" aria-hidden="true" tabindex="-1"></a>                     &#39;protocols &#39;(<span class="st">&quot;http://livereload.com/protocols/official-7&quot;</span>))))</span>
<span id="cb172-151"><a href="#cb172-151" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb172-152"><a href="#cb172-152" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Keep alive</span></span>
<span id="cb172-153"><a href="#cb172-153" aria-hidden="true" tabindex="-1"></a>     (thread</span>
<span id="cb172-154"><a href="#cb172-154" aria-hidden="true" tabindex="-1"></a>      (λ ()</span>
<span id="cb172-155"><a href="#cb172-155" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">let</span> loop ()</span>
<span id="cb172-156"><a href="#cb172-156" aria-hidden="true" tabindex="-1"></a>          (sleep <span class="dv">30</span>)</span>
<span id="cb172-157"><a href="#cb172-157" aria-hidden="true" tabindex="-1"></a>          (with-handlers (<span class="op">[</span>exn:fail? void<span class="op">]</span>)</span>
<span id="cb172-158"><a href="#cb172-158" aria-hidden="true" tabindex="-1"></a>            (ws-send! conn</span>
<span id="cb172-159"><a href="#cb172-159" aria-hidden="true" tabindex="-1"></a>                     (jsexpr-&gt;string</span>
<span id="cb172-160"><a href="#cb172-160" aria-hidden="true" tabindex="-1"></a>                      (hash &#39;command <span class="st">&quot;ping&quot;</span>)))</span>
<span id="cb172-161"><a href="#cb172-161" aria-hidden="true" tabindex="-1"></a>            (loop)))))</span>
<span id="cb172-162"><a href="#cb172-162" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb172-163"><a href="#cb172-163" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Message handling</span></span>
<span id="cb172-164"><a href="#cb172-164" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> loop ()</span>
<span id="cb172-165"><a href="#cb172-165" aria-hidden="true" tabindex="-1"></a>       (<span class="ex">define</span><span class="fu"> msg </span>(ws-recv conn))</span>
<span id="cb172-166"><a href="#cb172-166" aria-hidden="true" tabindex="-1"></a>       (unless (<span class="kw">eof-object?</span> msg)</span>
<span id="cb172-167"><a href="#cb172-167" aria-hidden="true" tabindex="-1"></a>         (loop))))))</span>
<span id="cb172-168"><a href="#cb172-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-169"><a href="#cb172-169" aria-hidden="true" tabindex="-1"></a><span class="co">;; Notify file changes for live reload</span></span>
<span id="cb172-170"><a href="#cb172-170" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(notify-file-change path type)</span>
<span id="cb172-171"><a href="#cb172-171" aria-hidden="true" tabindex="-1"></a>  (broadcast-to-topic</span>
<span id="cb172-172"><a href="#cb172-172" aria-hidden="true" tabindex="-1"></a>   &#39;livereload</span>
<span id="cb172-173"><a href="#cb172-173" aria-hidden="true" tabindex="-1"></a>   (hash &#39;command <span class="st">&quot;reload&quot;</span></span>
<span id="cb172-174"><a href="#cb172-174" aria-hidden="true" tabindex="-1"></a>         &#39;path path</span>
<span id="cb172-175"><a href="#cb172-175" aria-hidden="true" tabindex="-1"></a>         &#39;type type)))</span>
<span id="cb172-176"><a href="#cb172-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-177"><a href="#cb172-177" aria-hidden="true" tabindex="-1"></a><span class="co">;; WebSocket statistics</span></span>
<span id="cb172-178"><a href="#cb172-178" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(get-websocket-stats)</span>
<span id="cb172-179"><a href="#cb172-179" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> manager </span>(current-ws-manager))</span>
<span id="cb172-180"><a href="#cb172-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-181"><a href="#cb172-181" aria-hidden="true" tabindex="-1"></a>  (hash &#39;connections (hash-count (ws-manager-connections manager))</span>
<span id="cb172-182"><a href="#cb172-182" aria-hidden="true" tabindex="-1"></a>        &#39;topics (hash-count (ws-manager-topics manager))</span>
<span id="cb172-183"><a href="#cb172-183" aria-hidden="true" tabindex="-1"></a>        &#39;messages (hash-ref (ws-manager-stats manager) &#39;total-messages <span class="dv">0</span>)</span>
<span id="cb172-184"><a href="#cb172-184" aria-hidden="true" tabindex="-1"></a>        &#39;errors (hash-ref (ws-manager-stats manager) &#39;errors <span class="dv">0</span>)))</span></code></pre></div>
<h2 id="security-and-middleware">Security and Middleware</h2>
<p>Comprehensive security measures and middleware pipeline:</p>
<div class="sourceCode" id="cb173"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; security.rkt</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>(require net/base64</span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>         crypto</span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>         crypto/all)</span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>(provide security-middleware</span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>         csrf-protection</span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>         authentication-middleware</span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>         authorization-middleware)</span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a><span class="co">;; Security headers middleware</span></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(security-middleware handler)</span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> resp </span>(handler req))</span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Add security headers</span></span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a>    (struct-copy response resp</span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>headers </span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">append</span> (response-headers resp)</span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a>               (security-headers))<span class="op">]</span>)))</span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate security headers</span></span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(security-headers)</span>
<span id="cb173-26"><a href="#cb173-26" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">list</span></span>
<span id="cb173-27"><a href="#cb173-27" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; XSS Protection</span></span>
<span id="cb173-28"><a href="#cb173-28" aria-hidden="true" tabindex="-1"></a>   (make-header #<span class="st">&quot;X-XSS-Protection&quot;</span> #<span class="st">&quot;1; mode=block&quot;</span>)</span>
<span id="cb173-29"><a href="#cb173-29" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb173-30"><a href="#cb173-30" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Frame options</span></span>
<span id="cb173-31"><a href="#cb173-31" aria-hidden="true" tabindex="-1"></a>   (make-header #<span class="st">&quot;X-Frame-Options&quot;</span> #<span class="st">&quot;SAMEORIGIN&quot;</span>)</span>
<span id="cb173-32"><a href="#cb173-32" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb173-33"><a href="#cb173-33" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Content type options</span></span>
<span id="cb173-34"><a href="#cb173-34" aria-hidden="true" tabindex="-1"></a>   (make-header #<span class="st">&quot;X-Content-Type-Options&quot;</span> #<span class="st">&quot;nosniff&quot;</span>)</span>
<span id="cb173-35"><a href="#cb173-35" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb173-36"><a href="#cb173-36" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; CSP</span></span>
<span id="cb173-37"><a href="#cb173-37" aria-hidden="true" tabindex="-1"></a>   (make-header #<span class="st">&quot;Content-Security-Policy&quot;</span></span>
<span id="cb173-38"><a href="#cb173-38" aria-hidden="true" tabindex="-1"></a>                #<span class="st">&quot;default-src &#39;self&#39;; script-src &#39;self&#39; &#39;unsafe-inline&#39;; style-src &#39;self&#39; &#39;unsafe-inline&#39;&quot;</span>)</span>
<span id="cb173-39"><a href="#cb173-39" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb173-40"><a href="#cb173-40" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Referrer policy</span></span>
<span id="cb173-41"><a href="#cb173-41" aria-hidden="true" tabindex="-1"></a>   (make-header #<span class="st">&quot;Referrer-Policy&quot;</span> #<span class="st">&quot;strict-origin-when-cross-origin&quot;</span>)</span>
<span id="cb173-42"><a href="#cb173-42" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb173-43"><a href="#cb173-43" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Feature policy</span></span>
<span id="cb173-44"><a href="#cb173-44" aria-hidden="true" tabindex="-1"></a>   (make-header #<span class="st">&quot;Feature-Policy&quot;</span></span>
<span id="cb173-45"><a href="#cb173-45" aria-hidden="true" tabindex="-1"></a>                #<span class="st">&quot;geolocation &#39;none&#39;; microphone &#39;none&#39;; camera &#39;none&#39;&quot;</span>)))</span>
<span id="cb173-46"><a href="#cb173-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-47"><a href="#cb173-47" aria-hidden="true" tabindex="-1"></a><span class="co">;; CSRF protection</span></span>
<span id="cb173-48"><a href="#cb173-48" aria-hidden="true" tabindex="-1"></a>(struct csrf-token</span>
<span id="cb173-49"><a href="#cb173-49" aria-hidden="true" tabindex="-1"></a>  (value</span>
<span id="cb173-50"><a href="#cb173-50" aria-hidden="true" tabindex="-1"></a>   timestamp</span>
<span id="cb173-51"><a href="#cb173-51" aria-hidden="true" tabindex="-1"></a>   session-id)</span>
<span id="cb173-52"><a href="#cb173-52" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb173-53"><a href="#cb173-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-54"><a href="#cb173-54" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(csrf-protection handler)</span>
<span id="cb173-55"><a href="#cb173-55" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb173-56"><a href="#cb173-56" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> method </span>(request-method req))</span>
<span id="cb173-57"><a href="#cb173-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-58"><a href="#cb173-58" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb173-59"><a href="#cb173-59" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Safe methods don&#39;t need CSRF</span></span>
<span id="cb173-60"><a href="#cb173-60" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">member</span> method &#39;(GET HEAD OPTIONS))</span>
<span id="cb173-61"><a href="#cb173-61" aria-hidden="true" tabindex="-1"></a>       (handler req)<span class="op">]</span></span>
<span id="cb173-62"><a href="#cb173-62" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb173-63"><a href="#cb173-63" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Check CSRF token</span></span>
<span id="cb173-64"><a href="#cb173-64" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(valid-csrf-token? req)</span>
<span id="cb173-65"><a href="#cb173-65" aria-hidden="true" tabindex="-1"></a>       (handler req)<span class="op">]</span></span>
<span id="cb173-66"><a href="#cb173-66" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb173-67"><a href="#cb173-67" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb173-68"><a href="#cb173-68" aria-hidden="true" tabindex="-1"></a>       (response/full</span>
<span id="cb173-69"><a href="#cb173-69" aria-hidden="true" tabindex="-1"></a>        <span class="dv">403</span> #<span class="st">&quot;Forbidden&quot;</span></span>
<span id="cb173-70"><a href="#cb173-70" aria-hidden="true" tabindex="-1"></a>        (current-seconds)</span>
<span id="cb173-71"><a href="#cb173-71" aria-hidden="true" tabindex="-1"></a>        TEXT/HTML-MIME-TYPE</span>
<span id="cb173-72"><a href="#cb173-72" aria-hidden="true" tabindex="-1"></a>        &#39;()</span>
<span id="cb173-73"><a href="#cb173-73" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">list</span> #<span class="st">&quot;CSRF token validation failed&quot;</span>))<span class="op">]</span>)))</span>
<span id="cb173-74"><a href="#cb173-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-75"><a href="#cb173-75" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate CSRF token</span></span>
<span id="cb173-76"><a href="#cb173-76" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-csrf-token session-id)</span>
<span id="cb173-77"><a href="#cb173-77" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> value</span></span>
<span id="cb173-78"><a href="#cb173-78" aria-hidden="true" tabindex="-1"></a>    (base64-encode</span>
<span id="cb173-79"><a href="#cb173-79" aria-hidden="true" tabindex="-1"></a>     (crypto-random-bytes <span class="dv">32</span>)))</span>
<span id="cb173-80"><a href="#cb173-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-81"><a href="#cb173-81" aria-hidden="true" tabindex="-1"></a>  (csrf-token value (current-seconds) session-id))</span>
<span id="cb173-82"><a href="#cb173-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-83"><a href="#cb173-83" aria-hidden="true" tabindex="-1"></a><span class="co">;; Validate CSRF token</span></span>
<span id="cb173-84"><a href="#cb173-84" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(valid-csrf-token? req)</span>
<span id="cb173-85"><a href="#cb173-85" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> token-header</span></span>
<span id="cb173-86"><a href="#cb173-86" aria-hidden="true" tabindex="-1"></a>    (headers-assq* #<span class="st">&quot;X-CSRF-Token&quot;</span> </span>
<span id="cb173-87"><a href="#cb173-87" aria-hidden="true" tabindex="-1"></a>                   (request-headers/raw req)))</span>
<span id="cb173-88"><a href="#cb173-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-89"><a href="#cb173-89" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> token-param</span></span>
<span id="cb173-90"><a href="#cb173-90" aria-hidden="true" tabindex="-1"></a>    (hash-ref (request-post-data/raw req) </span>
<span id="cb173-91"><a href="#cb173-91" aria-hidden="true" tabindex="-1"></a>              &#39;csrf_token </span>
<span id="cb173-92"><a href="#cb173-92" aria-hidden="true" tabindex="-1"></a>              <span class="dv">#f</span>))</span>
<span id="cb173-93"><a href="#cb173-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-94"><a href="#cb173-94" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> token </span>(<span class="kw">or</span> token-header token-param))</span>
<span id="cb173-95"><a href="#cb173-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-96"><a href="#cb173-96" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">and</span> token</span>
<span id="cb173-97"><a href="#cb173-97" aria-hidden="true" tabindex="-1"></a>       (validate-token-value token)))</span>
<span id="cb173-98"><a href="#cb173-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-99"><a href="#cb173-99" aria-hidden="true" tabindex="-1"></a><span class="co">;; Rate limiting with sliding window</span></span>
<span id="cb173-100"><a href="#cb173-100" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-rate-limiter window-seconds max-requests)</span>
<span id="cb173-101"><a href="#cb173-101" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> requests </span>(make-hash))</span>
<span id="cb173-102"><a href="#cb173-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-103"><a href="#cb173-103" aria-hidden="true" tabindex="-1"></a>  (λ (key)</span>
<span id="cb173-104"><a href="#cb173-104" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> now </span>(current-inexact-milliseconds))</span>
<span id="cb173-105"><a href="#cb173-105" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> window-start </span>(<span class="op">-</span> now (<span class="op">*</span> window-seconds <span class="dv">1000</span>)))</span>
<span id="cb173-106"><a href="#cb173-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-107"><a href="#cb173-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Get and filter old requests</span></span>
<span id="cb173-108"><a href="#cb173-108" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> key-requests</span></span>
<span id="cb173-109"><a href="#cb173-109" aria-hidden="true" tabindex="-1"></a>      (hash-ref requests key &#39;()))</span>
<span id="cb173-110"><a href="#cb173-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-111"><a href="#cb173-111" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> recent-requests</span></span>
<span id="cb173-112"><a href="#cb173-112" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">filter</span> (λ (t) (<span class="op">&gt;</span> t window-start))</span>
<span id="cb173-113"><a href="#cb173-113" aria-hidden="true" tabindex="-1"></a>              key-requests))</span>
<span id="cb173-114"><a href="#cb173-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-115"><a href="#cb173-115" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Update and check</span></span>
<span id="cb173-116"><a href="#cb173-116" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb173-117"><a href="#cb173-117" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="op">&gt;=</span> (<span class="kw">length</span> recent-requests) max-requests)</span>
<span id="cb173-118"><a href="#cb173-118" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">values</span> <span class="dv">#f</span> (<span class="op">/</span> (<span class="op">-</span> (<span class="op">+</span> (first recent-requests) </span>
<span id="cb173-119"><a href="#cb173-119" aria-hidden="true" tabindex="-1"></a>                          (<span class="op">*</span> window-seconds <span class="dv">1000</span>)) </span>
<span id="cb173-120"><a href="#cb173-120" aria-hidden="true" tabindex="-1"></a>                       now) </span>
<span id="cb173-121"><a href="#cb173-121" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">1000</span>))<span class="op">]</span></span>
<span id="cb173-122"><a href="#cb173-122" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb173-123"><a href="#cb173-123" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb173-124"><a href="#cb173-124" aria-hidden="true" tabindex="-1"></a>       (hash-set! requests key </span>
<span id="cb173-125"><a href="#cb173-125" aria-hidden="true" tabindex="-1"></a>                 (<span class="kw">cons</span> now recent-requests))</span>
<span id="cb173-126"><a href="#cb173-126" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">values</span> <span class="dv">#t</span> <span class="dv">#f</span>)<span class="op">]</span>)))</span>
<span id="cb173-127"><a href="#cb173-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-128"><a href="#cb173-128" aria-hidden="true" tabindex="-1"></a><span class="co">;; IP-based rate limiting</span></span>
<span id="cb173-129"><a href="#cb173-129" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> ip-rate-limiter</span></span>
<span id="cb173-130"><a href="#cb173-130" aria-hidden="true" tabindex="-1"></a>  (make-rate-limiter <span class="dv">60</span> <span class="dv">100</span>))  <span class="co">; 100 requests per minute</span></span>
<span id="cb173-131"><a href="#cb173-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-132"><a href="#cb173-132" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(rate-limit-by-ip handler)</span>
<span id="cb173-133"><a href="#cb173-133" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb173-134"><a href="#cb173-134" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> client-ip </span>(request-client-ip req))</span>
<span id="cb173-135"><a href="#cb173-135" aria-hidden="true" tabindex="-1"></a>    (define-values (allowed? retry-after)</span>
<span id="cb173-136"><a href="#cb173-136" aria-hidden="true" tabindex="-1"></a>      (ip-rate-limiter client-ip))</span>
<span id="cb173-137"><a href="#cb173-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-138"><a href="#cb173-138" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> allowed?</span>
<span id="cb173-139"><a href="#cb173-139" aria-hidden="true" tabindex="-1"></a>        (handler req)</span>
<span id="cb173-140"><a href="#cb173-140" aria-hidden="true" tabindex="-1"></a>        (response/full</span>
<span id="cb173-141"><a href="#cb173-141" aria-hidden="true" tabindex="-1"></a>         <span class="dv">429</span> #<span class="st">&quot;Too Many Requests&quot;</span></span>
<span id="cb173-142"><a href="#cb173-142" aria-hidden="true" tabindex="-1"></a>         (current-seconds)</span>
<span id="cb173-143"><a href="#cb173-143" aria-hidden="true" tabindex="-1"></a>         TEXT/HTML-MIME-TYPE</span>
<span id="cb173-144"><a href="#cb173-144" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">if</span> retry-after</span>
<span id="cb173-145"><a href="#cb173-145" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">list</span> (make-header #<span class="st">&quot;Retry-After&quot;</span></span>
<span id="cb173-146"><a href="#cb173-146" aria-hidden="true" tabindex="-1"></a>                               (string-&gt;bytes/utf-8</span>
<span id="cb173-147"><a href="#cb173-147" aria-hidden="true" tabindex="-1"></a>                                (<span class="kw">number-&gt;string</span> </span>
<span id="cb173-148"><a href="#cb173-148" aria-hidden="true" tabindex="-1"></a>                                 (<span class="kw">ceiling</span> retry-after)))))</span>
<span id="cb173-149"><a href="#cb173-149" aria-hidden="true" tabindex="-1"></a>             &#39;())</span>
<span id="cb173-150"><a href="#cb173-150" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">list</span> #<span class="st">&quot;Rate limit exceeded&quot;</span>)))))</span>
<span id="cb173-151"><a href="#cb173-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-152"><a href="#cb173-152" aria-hidden="true" tabindex="-1"></a><span class="co">;; Content Security Policy builder</span></span>
<span id="cb173-153"><a href="#cb173-153" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-csp-header directives)</span>
<span id="cb173-154"><a href="#cb173-154" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> csp-string</span></span>
<span id="cb173-155"><a href="#cb173-155" aria-hidden="true" tabindex="-1"></a>    (string-join</span>
<span id="cb173-156"><a href="#cb173-156" aria-hidden="true" tabindex="-1"></a>     (for/list (<span class="op">[</span>(directive sources) (in-hash directives)<span class="op">]</span>)</span>
<span id="cb173-157"><a href="#cb173-157" aria-hidden="true" tabindex="-1"></a>       (format <span class="st">&quot;~a ~a&quot;</span> </span>
<span id="cb173-158"><a href="#cb173-158" aria-hidden="true" tabindex="-1"></a>               directive </span>
<span id="cb173-159"><a href="#cb173-159" aria-hidden="true" tabindex="-1"></a>               (string-join sources <span class="st">&quot; &quot;</span>)))</span>
<span id="cb173-160"><a href="#cb173-160" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;; &quot;</span>))</span>
<span id="cb173-161"><a href="#cb173-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-162"><a href="#cb173-162" aria-hidden="true" tabindex="-1"></a>  (make-header #<span class="st">&quot;Content-Security-Policy&quot;</span></span>
<span id="cb173-163"><a href="#cb173-163" aria-hidden="true" tabindex="-1"></a>               (string-&gt;bytes/utf-8 csp-string)))</span>
<span id="cb173-164"><a href="#cb173-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-165"><a href="#cb173-165" aria-hidden="true" tabindex="-1"></a><span class="co">;; Request sanitization</span></span>
<span id="cb173-166"><a href="#cb173-166" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(sanitize-request-middleware handler)</span>
<span id="cb173-167"><a href="#cb173-167" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb173-168"><a href="#cb173-168" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Sanitize path</span></span>
<span id="cb173-169"><a href="#cb173-169" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> clean-path </span>(sanitize-path (request-path req)))</span>
<span id="cb173-170"><a href="#cb173-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-171"><a href="#cb173-171" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Check for path traversal</span></span>
<span id="cb173-172"><a href="#cb173-172" aria-hidden="true" tabindex="-1"></a>    (when (contains-path-traversal? clean-path)</span>
<span id="cb173-173"><a href="#cb173-173" aria-hidden="true" tabindex="-1"></a>      (return (response/full</span>
<span id="cb173-174"><a href="#cb173-174" aria-hidden="true" tabindex="-1"></a>               <span class="dv">400</span> #<span class="st">&quot;Bad Request&quot;</span></span>
<span id="cb173-175"><a href="#cb173-175" aria-hidden="true" tabindex="-1"></a>               (current-seconds)</span>
<span id="cb173-176"><a href="#cb173-176" aria-hidden="true" tabindex="-1"></a>               TEXT/HTML-MIME-TYPE</span>
<span id="cb173-177"><a href="#cb173-177" aria-hidden="true" tabindex="-1"></a>               &#39;()</span>
<span id="cb173-178"><a href="#cb173-178" aria-hidden="true" tabindex="-1"></a>               (<span class="kw">list</span> #<span class="st">&quot;Invalid path&quot;</span>))))</span>
<span id="cb173-179"><a href="#cb173-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-180"><a href="#cb173-180" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Create sanitized request</span></span>
<span id="cb173-181"><a href="#cb173-181" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> clean-req</span></span>
<span id="cb173-182"><a href="#cb173-182" aria-hidden="true" tabindex="-1"></a>      (struct-copy request req</span>
<span id="cb173-183"><a href="#cb173-183" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>uri (struct-copy url (request-uri req)</span>
<span id="cb173-184"><a href="#cb173-184" aria-hidden="true" tabindex="-1"></a>               <span class="op">[</span>path clean-path<span class="op">]</span>)<span class="op">]</span>))</span>
<span id="cb173-185"><a href="#cb173-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-186"><a href="#cb173-186" aria-hidden="true" tabindex="-1"></a>    (handler clean-req)))</span>
<span id="cb173-187"><a href="#cb173-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-188"><a href="#cb173-188" aria-hidden="true" tabindex="-1"></a><span class="co">;; Path sanitization</span></span>
<span id="cb173-189"><a href="#cb173-189" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(sanitize-path path)</span>
<span id="cb173-190"><a href="#cb173-190" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> parts</span></span>
<span id="cb173-191"><a href="#cb173-191" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">filter</span> (λ (p) (<span class="kw">not</span> (<span class="kw">member</span> p &#39;(<span class="st">&quot;.&quot;</span> <span class="st">&quot;..&quot;</span>))))</span>
<span id="cb173-192"><a href="#cb173-192" aria-hidden="true" tabindex="-1"></a>            (string-split path <span class="st">&quot;/&quot;</span>)))</span>
<span id="cb173-193"><a href="#cb173-193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb173-194"><a href="#cb173-194" aria-hidden="true" tabindex="-1"></a>  (string-join parts <span class="st">&quot;/&quot;</span>))</span>
<span id="cb173-195"><a href="#cb173-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-196"><a href="#cb173-196" aria-hidden="true" tabindex="-1"></a><span class="co">;; Basic authentication middleware</span></span>
<span id="cb173-197"><a href="#cb173-197" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(basic-auth-middleware realm credentials handler)</span>
<span id="cb173-198"><a href="#cb173-198" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb173-199"><a href="#cb173-199" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> auth-header</span></span>
<span id="cb173-200"><a href="#cb173-200" aria-hidden="true" tabindex="-1"></a>      (headers-assq* #<span class="st">&quot;Authorization&quot;</span></span>
<span id="cb173-201"><a href="#cb173-201" aria-hidden="true" tabindex="-1"></a>                     (request-headers/raw req)))</span>
<span id="cb173-202"><a href="#cb173-202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-203"><a href="#cb173-203" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb173-204"><a href="#cb173-204" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="kw">and</span> auth-header</span>
<span id="cb173-205"><a href="#cb173-205" aria-hidden="true" tabindex="-1"></a>            (check-basic-auth auth-header credentials))</span>
<span id="cb173-206"><a href="#cb173-206" aria-hidden="true" tabindex="-1"></a>       (handler req)<span class="op">]</span></span>
<span id="cb173-207"><a href="#cb173-207" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb173-208"><a href="#cb173-208" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb173-209"><a href="#cb173-209" aria-hidden="true" tabindex="-1"></a>       (response/full</span>
<span id="cb173-210"><a href="#cb173-210" aria-hidden="true" tabindex="-1"></a>        <span class="dv">401</span> #<span class="st">&quot;Unauthorized&quot;</span></span>
<span id="cb173-211"><a href="#cb173-211" aria-hidden="true" tabindex="-1"></a>        (current-seconds)</span>
<span id="cb173-212"><a href="#cb173-212" aria-hidden="true" tabindex="-1"></a>        TEXT/HTML-MIME-TYPE</span>
<span id="cb173-213"><a href="#cb173-213" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">list</span> (make-header </span>
<span id="cb173-214"><a href="#cb173-214" aria-hidden="true" tabindex="-1"></a>               #<span class="st">&quot;WWW-Authenticate&quot;</span></span>
<span id="cb173-215"><a href="#cb173-215" aria-hidden="true" tabindex="-1"></a>               (string-&gt;bytes/utf-8 </span>
<span id="cb173-216"><a href="#cb173-216" aria-hidden="true" tabindex="-1"></a>                (format <span class="st">&quot;Basic realm=</span><span class="ch">\&quot;</span><span class="st">~a</span><span class="ch">\&quot;</span><span class="st">&quot;</span> realm))))</span>
<span id="cb173-217"><a href="#cb173-217" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">list</span> #<span class="st">&quot;Authentication required&quot;</span>))<span class="op">]</span>)))</span></code></pre></div>
<h2 id="development-tools-integration">Development Tools
Integration</h2>
<p>Enhanced development experience with browser integration:</p>
<div class="sourceCode" id="cb174"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; dev-tools.rkt</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>(provide development-middleware</span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>         error-page-middleware</span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>         request-logger</span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>         performance-monitor)</span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Development middleware stack</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(development-middleware handler)</span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>  (compose1</span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>   handler</span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>   request-logger</span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a>   error-page-middleware</span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a>   performance-monitor</span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a>   browser-sync-middleware))</span>
<span id="cb174-17"><a href="#cb174-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-18"><a href="#cb174-18" aria-hidden="true" tabindex="-1"></a><span class="co">;; Enhanced error pages</span></span>
<span id="cb174-19"><a href="#cb174-19" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(error-page-middleware handler)</span>
<span id="cb174-20"><a href="#cb174-20" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb174-21"><a href="#cb174-21" aria-hidden="true" tabindex="-1"></a>    (with-handlers (<span class="op">[</span>exn:fail?</span>
<span id="cb174-22"><a href="#cb174-22" aria-hidden="true" tabindex="-1"></a>                    (λ (e)</span>
<span id="cb174-23"><a href="#cb174-23" aria-hidden="true" tabindex="-1"></a>                      (render-error-page e req))<span class="op">]</span>)</span>
<span id="cb174-24"><a href="#cb174-24" aria-hidden="true" tabindex="-1"></a>      (handler req))))</span>
<span id="cb174-25"><a href="#cb174-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-26"><a href="#cb174-26" aria-hidden="true" tabindex="-1"></a><span class="co">;; Render detailed error page</span></span>
<span id="cb174-27"><a href="#cb174-27" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(render-error-page exn req)</span>
<span id="cb174-28"><a href="#cb174-28" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> stack-trace </span>(get-stack-trace exn))</span>
<span id="cb174-29"><a href="#cb174-29" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> context </span>(extract-error-context exn))</span>
<span id="cb174-30"><a href="#cb174-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-31"><a href="#cb174-31" aria-hidden="true" tabindex="-1"></a>  (response/xexpr</span>
<span id="cb174-32"><a href="#cb174-32" aria-hidden="true" tabindex="-1"></a>   #:code <span class="dv">500</span></span>
<span id="cb174-33"><a href="#cb174-33" aria-hidden="true" tabindex="-1"></a>   `(html</span>
<span id="cb174-34"><a href="#cb174-34" aria-hidden="true" tabindex="-1"></a>     (head</span>
<span id="cb174-35"><a href="#cb174-35" aria-hidden="true" tabindex="-1"></a>      (title <span class="st">&quot;Error - Shrdlu Development Server&quot;</span>)</span>
<span id="cb174-36"><a href="#cb174-36" aria-hidden="true" tabindex="-1"></a>      (style ,error-page-css))</span>
<span id="cb174-37"><a href="#cb174-37" aria-hidden="true" tabindex="-1"></a>     (body</span>
<span id="cb174-38"><a href="#cb174-38" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">div</span> ((class <span class="st">&quot;error-container&quot;</span>))</span>
<span id="cb174-39"><a href="#cb174-39" aria-hidden="true" tabindex="-1"></a>        (h1 ((class <span class="st">&quot;error-title&quot;</span>)) </span>
<span id="cb174-40"><a href="#cb174-40" aria-hidden="true" tabindex="-1"></a>            ,(exn-message exn))</span>
<span id="cb174-41"><a href="#cb174-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb174-42"><a href="#cb174-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Request details</span></span>
<span id="cb174-43"><a href="#cb174-43" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">div</span> ((class <span class="st">&quot;section&quot;</span>))</span>
<span id="cb174-44"><a href="#cb174-44" aria-hidden="true" tabindex="-1"></a>          (h2 <span class="st">&quot;Request Details&quot;</span>)</span>
<span id="cb174-45"><a href="#cb174-45" aria-hidden="true" tabindex="-1"></a>          (table</span>
<span id="cb174-46"><a href="#cb174-46" aria-hidden="true" tabindex="-1"></a>            (tr (td <span class="st">&quot;Method&quot;</span>) (td ,(request-method req)))</span>
<span id="cb174-47"><a href="#cb174-47" aria-hidden="true" tabindex="-1"></a>            (tr (td <span class="st">&quot;Path&quot;</span>) (td ,(request-path req)))</span>
<span id="cb174-48"><a href="#cb174-48" aria-hidden="true" tabindex="-1"></a>            (tr (td <span class="st">&quot;Time&quot;</span>) </span>
<span id="cb174-49"><a href="#cb174-49" aria-hidden="true" tabindex="-1"></a>                (td ,(format-timestamp (current-seconds))))))</span>
<span id="cb174-50"><a href="#cb174-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb174-51"><a href="#cb174-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Stack trace</span></span>
<span id="cb174-52"><a href="#cb174-52" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">div</span> ((class <span class="st">&quot;section&quot;</span>))</span>
<span id="cb174-53"><a href="#cb174-53" aria-hidden="true" tabindex="-1"></a>          (h2 <span class="st">&quot;Stack Trace&quot;</span>)</span>
<span id="cb174-54"><a href="#cb174-54" aria-hidden="true" tabindex="-1"></a>          (pre ((class <span class="st">&quot;stack-trace&quot;</span>))</span>
<span id="cb174-55"><a href="#cb174-55" aria-hidden="true" tabindex="-1"></a>               ,stack-trace))</span>
<span id="cb174-56"><a href="#cb174-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb174-57"><a href="#cb174-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Source context</span></span>
<span id="cb174-58"><a href="#cb174-58" aria-hidden="true" tabindex="-1"></a>        ,@(<span class="kw">if</span> context</span>
<span id="cb174-59"><a href="#cb174-59" aria-hidden="true" tabindex="-1"></a>              `((<span class="kw">div</span> ((class <span class="st">&quot;section&quot;</span>))</span>
<span id="cb174-60"><a href="#cb174-60" aria-hidden="true" tabindex="-1"></a>                  (h2 <span class="st">&quot;Source Context&quot;</span>)</span>
<span id="cb174-61"><a href="#cb174-61" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">div</span> ((class <span class="st">&quot;source-context&quot;</span>))</span>
<span id="cb174-62"><a href="#cb174-62" aria-hidden="true" tabindex="-1"></a>                    ,@(render-source-context context))))</span>
<span id="cb174-63"><a href="#cb174-63" aria-hidden="true" tabindex="-1"></a>              &#39;())</span>
<span id="cb174-64"><a href="#cb174-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb174-65"><a href="#cb174-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Environment</span></span>
<span id="cb174-66"><a href="#cb174-66" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">div</span> ((class <span class="st">&quot;section&quot;</span>))</span>
<span id="cb174-67"><a href="#cb174-67" aria-hidden="true" tabindex="-1"></a>          (h2 <span class="st">&quot;Environment&quot;</span>)</span>
<span id="cb174-68"><a href="#cb174-68" aria-hidden="true" tabindex="-1"></a>          (table</span>
<span id="cb174-69"><a href="#cb174-69" aria-hidden="true" tabindex="-1"></a>            ,@(for/list (<span class="op">[</span>binding (current-environment-variables)<span class="op">]</span>)</span>
<span id="cb174-70"><a href="#cb174-70" aria-hidden="true" tabindex="-1"></a>                `(tr (td ,(<span class="kw">car</span> binding))</span>
<span id="cb174-71"><a href="#cb174-71" aria-hidden="true" tabindex="-1"></a>                     (td ,(<span class="kw">cdr</span> binding)))))))))))</span>
<span id="cb174-72"><a href="#cb174-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-73"><a href="#cb174-73" aria-hidden="true" tabindex="-1"></a><span class="co">;; Request logging with colors</span></span>
<span id="cb174-74"><a href="#cb174-74" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(request-logger handler)</span>
<span id="cb174-75"><a href="#cb174-75" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb174-76"><a href="#cb174-76" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> start-time </span>(current-inexact-milliseconds))</span>
<span id="cb174-77"><a href="#cb174-77" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> method </span>(request-method req))</span>
<span id="cb174-78"><a href="#cb174-78" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> path </span>(request-path req))</span>
<span id="cb174-79"><a href="#cb174-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb174-80"><a href="#cb174-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Execute handler</span></span>
<span id="cb174-81"><a href="#cb174-81" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> resp </span>(handler req))</span>
<span id="cb174-82"><a href="#cb174-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb174-83"><a href="#cb174-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Calculate duration</span></span>
<span id="cb174-84"><a href="#cb174-84" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> duration </span></span>
<span id="cb174-85"><a href="#cb174-85" aria-hidden="true" tabindex="-1"></a>      (<span class="op">-</span> (current-inexact-milliseconds) start-time))</span>
<span id="cb174-86"><a href="#cb174-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb174-87"><a href="#cb174-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Log with colors</span></span>
<span id="cb174-88"><a href="#cb174-88" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> status </span>(response-code resp))</span>
<span id="cb174-89"><a href="#cb174-89" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> status-color</span></span>
<span id="cb174-90"><a href="#cb174-90" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">cond</span></span>
<span id="cb174-91"><a href="#cb174-91" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="op">&lt;=</span> <span class="dv">200</span> status <span class="dv">299</span>) &#39;green<span class="op">]</span></span>
<span id="cb174-92"><a href="#cb174-92" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="op">&lt;=</span> <span class="dv">300</span> status <span class="dv">399</span>) &#39;yellow<span class="op">]</span></span>
<span id="cb174-93"><a href="#cb174-93" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="op">&lt;=</span> <span class="dv">400</span> status <span class="dv">499</span>) &#39;red<span class="op">]</span></span>
<span id="cb174-94"><a href="#cb174-94" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span><span class="kw">else</span> &#39;bright-red<span class="op">]</span>))</span>
<span id="cb174-95"><a href="#cb174-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb174-96"><a href="#cb174-96" aria-hidden="true" tabindex="-1"></a>    (printf <span class="st">&quot;~a ~a ~a ~a ~ams~n&quot;</span></span>
<span id="cb174-97"><a href="#cb174-97" aria-hidden="true" tabindex="-1"></a>            (colorize method &#39;cyan)</span>
<span id="cb174-98"><a href="#cb174-98" aria-hidden="true" tabindex="-1"></a>            path</span>
<span id="cb174-99"><a href="#cb174-99" aria-hidden="true" tabindex="-1"></a>            (colorize (<span class="kw">number-&gt;string</span> status) status-color)</span>
<span id="cb174-100"><a href="#cb174-100" aria-hidden="true" tabindex="-1"></a>            (response-message resp)</span>
<span id="cb174-101"><a href="#cb174-101" aria-hidden="true" tabindex="-1"></a>            (~r duration #:precision <span class="dv">1</span>))</span>
<span id="cb174-102"><a href="#cb174-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb174-103"><a href="#cb174-103" aria-hidden="true" tabindex="-1"></a>    resp))</span>
<span id="cb174-104"><a href="#cb174-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-105"><a href="#cb174-105" aria-hidden="true" tabindex="-1"></a><span class="co">;; Browser auto-reload injection</span></span>
<span id="cb174-106"><a href="#cb174-106" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(browser-sync-middleware handler)</span>
<span id="cb174-107"><a href="#cb174-107" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb174-108"><a href="#cb174-108" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> resp </span>(handler req))</span>
<span id="cb174-109"><a href="#cb174-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb174-110"><a href="#cb174-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Only inject in HTML responses</span></span>
<span id="cb174-111"><a href="#cb174-111" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (html-response? resp)</span>
<span id="cb174-112"><a href="#cb174-112" aria-hidden="true" tabindex="-1"></a>        (inject-reload-script resp)</span>
<span id="cb174-113"><a href="#cb174-113" aria-hidden="true" tabindex="-1"></a>        resp)))</span>
<span id="cb174-114"><a href="#cb174-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-115"><a href="#cb174-115" aria-hidden="true" tabindex="-1"></a><span class="co">;; Inject live reload script</span></span>
<span id="cb174-116"><a href="#cb174-116" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(inject-reload-script resp)</span>
<span id="cb174-117"><a href="#cb174-117" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> body </span>(response-body resp))</span>
<span id="cb174-118"><a href="#cb174-118" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> modified-body</span></span>
<span id="cb174-119"><a href="#cb174-119" aria-hidden="true" tabindex="-1"></a>    (regexp-replace </span>
<span id="cb174-120"><a href="#cb174-120" aria-hidden="true" tabindex="-1"></a>     #rx<span class="st">&quot;&lt;/body&gt;&quot;</span></span>
<span id="cb174-121"><a href="#cb174-121" aria-hidden="true" tabindex="-1"></a>     body</span>
<span id="cb174-122"><a href="#cb174-122" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">string-append</span> reload-script-html <span class="st">&quot;&lt;/body&gt;&quot;</span>)))</span>
<span id="cb174-123"><a href="#cb174-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-124"><a href="#cb174-124" aria-hidden="true" tabindex="-1"></a>  (struct-copy response resp</span>
<span id="cb174-125"><a href="#cb174-125" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>body modified-body<span class="op">]</span>))</span>
<span id="cb174-126"><a href="#cb174-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-127"><a href="#cb174-127" aria-hidden="true" tabindex="-1"></a><span class="co">;; Performance monitoring</span></span>
<span id="cb174-128"><a href="#cb174-128" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> performance-monitor</span></span>
<span id="cb174-129"><a href="#cb174-129" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> (<span class="op">[</span>metrics (make-hash)<span class="op">]</span>)</span>
<span id="cb174-130"><a href="#cb174-130" aria-hidden="true" tabindex="-1"></a>    (λ (handler)</span>
<span id="cb174-131"><a href="#cb174-131" aria-hidden="true" tabindex="-1"></a>      (λ (req)</span>
<span id="cb174-132"><a href="#cb174-132" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> path </span>(request-path req))</span>
<span id="cb174-133"><a href="#cb174-133" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> start-time </span>(current-inexact-milliseconds))</span>
<span id="cb174-134"><a href="#cb174-134" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> start-memory </span>(current-memory-use))</span>
<span id="cb174-135"><a href="#cb174-135" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb174-136"><a href="#cb174-136" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Execute handler</span></span>
<span id="cb174-137"><a href="#cb174-137" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> resp </span>(handler req))</span>
<span id="cb174-138"><a href="#cb174-138" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb174-139"><a href="#cb174-139" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Collect metrics</span></span>
<span id="cb174-140"><a href="#cb174-140" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> duration </span></span>
<span id="cb174-141"><a href="#cb174-141" aria-hidden="true" tabindex="-1"></a>          (<span class="op">-</span> (current-inexact-milliseconds) start-time))</span>
<span id="cb174-142"><a href="#cb174-142" aria-hidden="true" tabindex="-1"></a>        (<span class="ex">define</span><span class="fu"> memory-delta</span></span>
<span id="cb174-143"><a href="#cb174-143" aria-hidden="true" tabindex="-1"></a>          (<span class="op">-</span> (current-memory-use) start-memory))</span>
<span id="cb174-144"><a href="#cb174-144" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb174-145"><a href="#cb174-145" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Update metrics</span></span>
<span id="cb174-146"><a href="#cb174-146" aria-hidden="true" tabindex="-1"></a>        (hash-update! metrics path</span>
<span id="cb174-147"><a href="#cb174-147" aria-hidden="true" tabindex="-1"></a>                     (λ (stats)</span>
<span id="cb174-148"><a href="#cb174-148" aria-hidden="true" tabindex="-1"></a>                       (struct-copy route-metrics stats</span>
<span id="cb174-149"><a href="#cb174-149" aria-hidden="true" tabindex="-1"></a>                         <span class="op">[</span>requests (<span class="op">+</span> (route-metrics-requests stats) <span class="dv">1</span>)<span class="op">]</span></span>
<span id="cb174-150"><a href="#cb174-150" aria-hidden="true" tabindex="-1"></a>                         <span class="op">[</span>total-time (<span class="op">+</span> (route-metrics-total-time stats)</span>
<span id="cb174-151"><a href="#cb174-151" aria-hidden="true" tabindex="-1"></a>                                       duration)<span class="op">]</span></span>
<span id="cb174-152"><a href="#cb174-152" aria-hidden="true" tabindex="-1"></a>                         <span class="op">[</span>max-time (<span class="kw">max</span> (route-metrics-max-time stats)</span>
<span id="cb174-153"><a href="#cb174-153" aria-hidden="true" tabindex="-1"></a>                                       duration)<span class="op">]</span>))</span>
<span id="cb174-154"><a href="#cb174-154" aria-hidden="true" tabindex="-1"></a>                     (λ () (route-metrics path <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span>)))</span>
<span id="cb174-155"><a href="#cb174-155" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb174-156"><a href="#cb174-156" aria-hidden="true" tabindex="-1"></a>        <span class="co">;; Add timing header</span></span>
<span id="cb174-157"><a href="#cb174-157" aria-hidden="true" tabindex="-1"></a>        (struct-copy response resp</span>
<span id="cb174-158"><a href="#cb174-158" aria-hidden="true" tabindex="-1"></a>          <span class="op">[</span>headers (<span class="kw">cons</span> (make-header </span>
<span id="cb174-159"><a href="#cb174-159" aria-hidden="true" tabindex="-1"></a>                          #<span class="st">&quot;Server-Timing&quot;</span></span>
<span id="cb174-160"><a href="#cb174-160" aria-hidden="true" tabindex="-1"></a>                          (string-&gt;bytes/utf-8</span>
<span id="cb174-161"><a href="#cb174-161" aria-hidden="true" tabindex="-1"></a>                           (format <span class="st">&quot;total;dur=~a&quot;</span> duration)))</span>
<span id="cb174-162"><a href="#cb174-162" aria-hidden="true" tabindex="-1"></a>                        (response-headers resp))<span class="op">]</span>)))))</span>
<span id="cb174-163"><a href="#cb174-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-164"><a href="#cb174-164" aria-hidden="true" tabindex="-1"></a><span class="co">;; Development dashboard</span></span>
<span id="cb174-165"><a href="#cb174-165" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(dev-dashboard-handler)</span>
<span id="cb174-166"><a href="#cb174-166" aria-hidden="true" tabindex="-1"></a>  (λ (req)</span>
<span id="cb174-167"><a href="#cb174-167" aria-hidden="true" tabindex="-1"></a>    (response/xexpr</span>
<span id="cb174-168"><a href="#cb174-168" aria-hidden="true" tabindex="-1"></a>     `(html</span>
<span id="cb174-169"><a href="#cb174-169" aria-hidden="true" tabindex="-1"></a>       (head</span>
<span id="cb174-170"><a href="#cb174-170" aria-hidden="true" tabindex="-1"></a>        (title <span class="st">&quot;Shrdlu Development Dashboard&quot;</span>)</span>
<span id="cb174-171"><a href="#cb174-171" aria-hidden="true" tabindex="-1"></a>        (style ,dashboard-css)</span>
<span id="cb174-172"><a href="#cb174-172" aria-hidden="true" tabindex="-1"></a>        (script ,dashboard-js))</span>
<span id="cb174-173"><a href="#cb174-173" aria-hidden="true" tabindex="-1"></a>       (body</span>
<span id="cb174-174"><a href="#cb174-174" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">div</span> ((class <span class="st">&quot;dashboard&quot;</span>))</span>
<span id="cb174-175"><a href="#cb174-175" aria-hidden="true" tabindex="-1"></a>         (h1 <span class="st">&quot;Shrdlu Development Dashboard&quot;</span>)</span>
<span id="cb174-176"><a href="#cb174-176" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb174-177"><a href="#cb174-177" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Server status</span></span>
<span id="cb174-178"><a href="#cb174-178" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">div</span> ((class <span class="st">&quot;widget&quot;</span>))</span>
<span id="cb174-179"><a href="#cb174-179" aria-hidden="true" tabindex="-1"></a>           (h2 <span class="st">&quot;Server Status&quot;</span>)</span>
<span id="cb174-180"><a href="#cb174-180" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">div</span> ((id <span class="st">&quot;server-status&quot;</span>))</span>
<span id="cb174-181"><a href="#cb174-181" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Loading...&quot;</span>))</span>
<span id="cb174-182"><a href="#cb174-182" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb174-183"><a href="#cb174-183" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Build status</span></span>
<span id="cb174-184"><a href="#cb174-184" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">div</span> ((class <span class="st">&quot;widget&quot;</span>))</span>
<span id="cb174-185"><a href="#cb174-185" aria-hidden="true" tabindex="-1"></a>           (h2 <span class="st">&quot;Build Status&quot;</span>)</span>
<span id="cb174-186"><a href="#cb174-186" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">div</span> ((id <span class="st">&quot;build-status&quot;</span>))</span>
<span id="cb174-187"><a href="#cb174-187" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Loading...&quot;</span>))</span>
<span id="cb174-188"><a href="#cb174-188" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb174-189"><a href="#cb174-189" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Performance metrics</span></span>
<span id="cb174-190"><a href="#cb174-190" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">div</span> ((class <span class="st">&quot;widget&quot;</span>))</span>
<span id="cb174-191"><a href="#cb174-191" aria-hidden="true" tabindex="-1"></a>           (h2 <span class="st">&quot;Performance Metrics&quot;</span>)</span>
<span id="cb174-192"><a href="#cb174-192" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">div</span> ((id <span class="st">&quot;performance-metrics&quot;</span>))</span>
<span id="cb174-193"><a href="#cb174-193" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Loading...&quot;</span>))</span>
<span id="cb174-194"><a href="#cb174-194" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb174-195"><a href="#cb174-195" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; WebSocket connections</span></span>
<span id="cb174-196"><a href="#cb174-196" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">div</span> ((class <span class="st">&quot;widget&quot;</span>))</span>
<span id="cb174-197"><a href="#cb174-197" aria-hidden="true" tabindex="-1"></a>           (h2 <span class="st">&quot;WebSocket Connections&quot;</span>)</span>
<span id="cb174-198"><a href="#cb174-198" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">div</span> ((id <span class="st">&quot;websocket-status&quot;</span>))</span>
<span id="cb174-199"><a href="#cb174-199" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Loading...&quot;</span>))</span>
<span id="cb174-200"><a href="#cb174-200" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb174-201"><a href="#cb174-201" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Recent errors</span></span>
<span id="cb174-202"><a href="#cb174-202" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">div</span> ((class <span class="st">&quot;widget&quot;</span>))</span>
<span id="cb174-203"><a href="#cb174-203" aria-hidden="true" tabindex="-1"></a>           (h2 <span class="st">&quot;Recent Errors&quot;</span>)</span>
<span id="cb174-204"><a href="#cb174-204" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">div</span> ((id <span class="st">&quot;recent-errors&quot;</span>))</span>
<span id="cb174-205"><a href="#cb174-205" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Loading...&quot;</span>)))))))))</span></code></pre></div>
<h2 id="testing-the-web-server">Testing the Web Server</h2>
<p>Comprehensive test suite for server functionality:</p>
<div class="sourceCode" id="cb175"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; web-server-tests.rkt</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>(require rackunit</span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>         net/url</span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;web-server.rkt&quot;</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;routing.rkt&quot;</span>)</span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Test server configuration</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> test-server-config</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>  (server-config</span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>   <span class="dv">8081</span>              <span class="co">; Different port for testing</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;127.0.0.1&quot;</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;test-output&quot;</span></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>   <span class="dv">#t</span> <span class="dv">#t</span> <span class="dv">#t</span> <span class="dv">#f</span> <span class="dv">#f</span> <span class="dv">#f</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a>   <span class="dv">10</span> <span class="dv">5</span> <span class="dv">#t</span> &#39;()))</span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Route matching&quot;</span></span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Exact match</span></span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a>  (check-equal? </span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a>   (match-route <span class="st">&quot;/blog&quot;</span> <span class="st">&quot;/blog&quot;</span>)</span>
<span id="cb175-22"><a href="#cb175-22" aria-hidden="true" tabindex="-1"></a>   &#39;())</span>
<span id="cb175-23"><a href="#cb175-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-24"><a href="#cb175-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Parameter extraction</span></span>
<span id="cb175-25"><a href="#cb175-25" aria-hidden="true" tabindex="-1"></a>  (check-equal?</span>
<span id="cb175-26"><a href="#cb175-26" aria-hidden="true" tabindex="-1"></a>   (match-route <span class="st">&quot;/blog/:year/:month/:slug&quot;</span> </span>
<span id="cb175-27"><a href="#cb175-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;/blog/2024/03/hello-world&quot;</span>)</span>
<span id="cb175-28"><a href="#cb175-28" aria-hidden="true" tabindex="-1"></a>   &#39;((year <span class="op">.</span> <span class="st">&quot;2024&quot;</span>) </span>
<span id="cb175-29"><a href="#cb175-29" aria-hidden="true" tabindex="-1"></a>     (month <span class="op">.</span> <span class="st">&quot;03&quot;</span>) </span>
<span id="cb175-30"><a href="#cb175-30" aria-hidden="true" tabindex="-1"></a>     (slug <span class="op">.</span> <span class="st">&quot;hello-world&quot;</span>)))</span>
<span id="cb175-31"><a href="#cb175-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-32"><a href="#cb175-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Wildcard matching</span></span>
<span id="cb175-33"><a href="#cb175-33" aria-hidden="true" tabindex="-1"></a>  (check-equal?</span>
<span id="cb175-34"><a href="#cb175-34" aria-hidden="true" tabindex="-1"></a>   (match-route <span class="st">&quot;/assets/*&quot;</span> <span class="st">&quot;/assets/css/style.css&quot;</span>)</span>
<span id="cb175-35"><a href="#cb175-35" aria-hidden="true" tabindex="-1"></a>   &#39;((splat <span class="op">.</span> <span class="st">&quot;css/style.css&quot;</span>)))</span>
<span id="cb175-36"><a href="#cb175-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-37"><a href="#cb175-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; No match</span></span>
<span id="cb175-38"><a href="#cb175-38" aria-hidden="true" tabindex="-1"></a>  (check-false</span>
<span id="cb175-39"><a href="#cb175-39" aria-hidden="true" tabindex="-1"></a>   (match-route <span class="st">&quot;/blog/:id&quot;</span> <span class="st">&quot;/about&quot;</span>)))</span>
<span id="cb175-40"><a href="#cb175-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-41"><a href="#cb175-41" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Static file serving&quot;</span></span>
<span id="cb175-42"><a href="#cb175-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create test files</span></span>
<span id="cb175-43"><a href="#cb175-43" aria-hidden="true" tabindex="-1"></a>  (make-directory* <span class="st">&quot;test-output&quot;</span>)</span>
<span id="cb175-44"><a href="#cb175-44" aria-hidden="true" tabindex="-1"></a>  (display-to-file <span class="st">&quot;&lt;h1&gt;Test&lt;/h1&gt;&quot;</span> <span class="st">&quot;test-output/test.html&quot;</span>)</span>
<span id="cb175-45"><a href="#cb175-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-46"><a href="#cb175-46" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> handler </span>(static-file-handler <span class="st">&quot;test-output&quot;</span>))</span>
<span id="cb175-47"><a href="#cb175-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-48"><a href="#cb175-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Test successful file serving</span></span>
<span id="cb175-49"><a href="#cb175-49" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> req </span>(make-test-request <span class="st">&quot;GET&quot;</span> <span class="st">&quot;/test.html&quot;</span>))</span>
<span id="cb175-50"><a href="#cb175-50" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> resp </span>(handler req))</span>
<span id="cb175-51"><a href="#cb175-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-52"><a href="#cb175-52" aria-hidden="true" tabindex="-1"></a>  (check-equal? (response-code resp) <span class="dv">200</span>)</span>
<span id="cb175-53"><a href="#cb175-53" aria-hidden="true" tabindex="-1"></a>  (check-equal? (response-mime resp) <span class="st">&quot;text/html; charset=utf-8&quot;</span>)</span>
<span id="cb175-54"><a href="#cb175-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-55"><a href="#cb175-55" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Test 404</span></span>
<span id="cb175-56"><a href="#cb175-56" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> req2 </span>(make-test-request <span class="st">&quot;GET&quot;</span> <span class="st">&quot;/missing.html&quot;</span>))</span>
<span id="cb175-57"><a href="#cb175-57" aria-hidden="true" tabindex="-1"></a>  (check-false (handler req2))</span>
<span id="cb175-58"><a href="#cb175-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-59"><a href="#cb175-59" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Cleanup</span></span>
<span id="cb175-60"><a href="#cb175-60" aria-hidden="true" tabindex="-1"></a>  (delete-directory/files <span class="st">&quot;test-output&quot;</span>))</span>
<span id="cb175-61"><a href="#cb175-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-62"><a href="#cb175-62" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;JSON API handling&quot;</span></span>
<span id="cb175-63"><a href="#cb175-63" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> data </span>(hash &#39;message <span class="st">&quot;Hello&quot;</span> &#39;count <span class="dv">42</span>))</span>
<span id="cb175-64"><a href="#cb175-64" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> resp </span>(json-response data))</span>
<span id="cb175-65"><a href="#cb175-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-66"><a href="#cb175-66" aria-hidden="true" tabindex="-1"></a>  (check-equal? (response-code resp) <span class="dv">200</span>)</span>
<span id="cb175-67"><a href="#cb175-67" aria-hidden="true" tabindex="-1"></a>  (check-equal? (response-mime resp) </span>
<span id="cb175-68"><a href="#cb175-68" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;application/json; charset=utf-8&quot;</span>)</span>
<span id="cb175-69"><a href="#cb175-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-70"><a href="#cb175-70" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> body </span>(response-body resp))</span>
<span id="cb175-71"><a href="#cb175-71" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> parsed </span>(bytes-&gt;jsexpr body))</span>
<span id="cb175-72"><a href="#cb175-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-73"><a href="#cb175-73" aria-hidden="true" tabindex="-1"></a>  (check-equal? (hash-ref parsed &#39;message) <span class="st">&quot;Hello&quot;</span>)</span>
<span id="cb175-74"><a href="#cb175-74" aria-hidden="true" tabindex="-1"></a>  (check-equal? (hash-ref parsed &#39;count) <span class="dv">42</span>))</span>
<span id="cb175-75"><a href="#cb175-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-76"><a href="#cb175-76" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;Rate limiting&quot;</span></span>
<span id="cb175-77"><a href="#cb175-77" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> limiter </span>(make-rate-limiter <span class="dv">1</span> <span class="dv">3</span>)) <span class="co">; 3 per second</span></span>
<span id="cb175-78"><a href="#cb175-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-79"><a href="#cb175-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Should allow first 3 requests</span></span>
<span id="cb175-80"><a href="#cb175-80" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[_</span> (in-range <span class="dv">3</span>)<span class="op">]</span>)</span>
<span id="cb175-81"><a href="#cb175-81" aria-hidden="true" tabindex="-1"></a>    (define-values (allowed? retry) (limiter <span class="st">&quot;test-key&quot;</span>))</span>
<span id="cb175-82"><a href="#cb175-82" aria-hidden="true" tabindex="-1"></a>    (check-true allowed?)</span>
<span id="cb175-83"><a href="#cb175-83" aria-hidden="true" tabindex="-1"></a>    (check-false retry))</span>
<span id="cb175-84"><a href="#cb175-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-85"><a href="#cb175-85" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; 4th request should be blocked</span></span>
<span id="cb175-86"><a href="#cb175-86" aria-hidden="true" tabindex="-1"></a>  (define-values (allowed? retry) (limiter <span class="st">&quot;test-key&quot;</span>))</span>
<span id="cb175-87"><a href="#cb175-87" aria-hidden="true" tabindex="-1"></a>  (check-false allowed?)</span>
<span id="cb175-88"><a href="#cb175-88" aria-hidden="true" tabindex="-1"></a>  (check-number? retry)</span>
<span id="cb175-89"><a href="#cb175-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-90"><a href="#cb175-90" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Different key should work</span></span>
<span id="cb175-91"><a href="#cb175-91" aria-hidden="true" tabindex="-1"></a>  (define-values (allowed2? retry2) (limiter <span class="st">&quot;other-key&quot;</span>))</span>
<span id="cb175-92"><a href="#cb175-92" aria-hidden="true" tabindex="-1"></a>  (check-true allowed2?))</span>
<span id="cb175-93"><a href="#cb175-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-94"><a href="#cb175-94" aria-hidden="true" tabindex="-1"></a>(test-case <span class="st">&quot;CSRF protection&quot;</span></span>
<span id="cb175-95"><a href="#cb175-95" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> token </span>(generate-csrf-token <span class="st">&quot;test-session&quot;</span>))</span>
<span id="cb175-96"><a href="#cb175-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-97"><a href="#cb175-97" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Valid token</span></span>
<span id="cb175-98"><a href="#cb175-98" aria-hidden="true" tabindex="-1"></a>  (check-true (valid-csrf-token? </span>
<span id="cb175-99"><a href="#cb175-99" aria-hidden="true" tabindex="-1"></a>               (make-test-request </span>
<span id="cb175-100"><a href="#cb175-100" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;POST&quot;</span> <span class="st">&quot;/&quot;</span></span>
<span id="cb175-101"><a href="#cb175-101" aria-hidden="true" tabindex="-1"></a>                #:headers `((#<span class="st">&quot;X-CSRF-Token&quot;</span> <span class="op">.</span> </span>
<span id="cb175-102"><a href="#cb175-102" aria-hidden="true" tabindex="-1"></a>                           ,(csrf-token-value token))))))</span>
<span id="cb175-103"><a href="#cb175-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-104"><a href="#cb175-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Missing token</span></span>
<span id="cb175-105"><a href="#cb175-105" aria-hidden="true" tabindex="-1"></a>  (check-false (valid-csrf-token?</span>
<span id="cb175-106"><a href="#cb175-106" aria-hidden="true" tabindex="-1"></a>                (make-test-request <span class="st">&quot;POST&quot;</span> <span class="st">&quot;/&quot;</span>)))</span>
<span id="cb175-107"><a href="#cb175-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-108"><a href="#cb175-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; GET requests don&#39;t need token</span></span>
<span id="cb175-109"><a href="#cb175-109" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> handler </span>(csrf-protection (λ (req) &#39;ok)))</span>
<span id="cb175-110"><a href="#cb175-110" aria-hidden="true" tabindex="-1"></a>  (check-eq? (handler (make-test-request <span class="st">&quot;GET&quot;</span> <span class="st">&quot;/&quot;</span>)) &#39;ok))</span>
<span id="cb175-111"><a href="#cb175-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-112"><a href="#cb175-112" aria-hidden="true" tabindex="-1"></a><span class="co">;; Helper to create test requests</span></span>
<span id="cb175-113"><a href="#cb175-113" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-test-request method path </span>
<span id="cb175-114"><a href="#cb175-114" aria-hidden="true" tabindex="-1"></a>                          #:headers <span class="op">[</span>headers &#39;()<span class="op">]</span></span>
<span id="cb175-115"><a href="#cb175-115" aria-hidden="true" tabindex="-1"></a>                          #:body <span class="op">[</span>body <span class="dv">#f</span><span class="op">]</span>)</span>
<span id="cb175-116"><a href="#cb175-116" aria-hidden="true" tabindex="-1"></a>  (request method</span>
<span id="cb175-117"><a href="#cb175-117" aria-hidden="true" tabindex="-1"></a>          (string-&gt;url (<span class="kw">string-append</span> <span class="st">&quot;http://localhost&quot;</span> path))</span>
<span id="cb175-118"><a href="#cb175-118" aria-hidden="true" tabindex="-1"></a>          headers</span>
<span id="cb175-119"><a href="#cb175-119" aria-hidden="true" tabindex="-1"></a>          (delay (<span class="kw">list</span> body))</span>
<span id="cb175-120"><a href="#cb175-120" aria-hidden="true" tabindex="-1"></a>          <span class="dv">#f</span></span>
<span id="cb175-121"><a href="#cb175-121" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;127.0.0.1&quot;</span></span>
<span id="cb175-122"><a href="#cb175-122" aria-hidden="true" tabindex="-1"></a>          <span class="dv">8080</span></span>
<span id="cb175-123"><a href="#cb175-123" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;127.0.0.1&quot;</span>))</span></code></pre></div>
<p>The web server transforms Shrdlu from a simple static generator into
a comprehensive development platform. With support for dynamic routing,
real-time updates, API endpoints, and robust security, developers can
build and preview their sites with instant feedback while maintaining
the simplicity and performance benefits of static generation.</p>
<h2 id="exercises-7">Exercises</h2>
<ol type="1">
<li><p><strong>Implement HTTP/2 support</strong>: Add HTTP/2
capabilities with server push for optimal performance.</p></li>
<li><p><strong>Create GraphQL endpoint</strong>: Design a GraphQL API
for querying site content and metadata.</p></li>
<li><p><strong>Add metrics collection</strong>: Build a comprehensive
metrics system with Prometheus-compatible endpoints.</p></li>
<li><p><strong>Implement OAuth integration</strong>: Add OAuth2 support
for protecting admin endpoints and preview functionality. # Chapter 13:
Advanced Language Features</p></li>
</ol>
<h2 id="pushing-the-boundaries-of-rackets-macro-system">Pushing the
Boundaries of Racket’s Macro System</h2>
<p>While we’ve explored basic macros and DSLs, Racket’s
language-oriented programming capabilities extend far beyond simple
syntax transformations. This chapter delves into advanced
metaprogramming techniques, syntax classes, phase separation, and
creating full-fledged languages that integrate seamlessly with Shrdlu’s
architecture.</p>
<h2 id="syntax-classes-and-robust-macros">Syntax Classes and Robust
Macros</h2>
<p>Syntax classes provide pattern matching with better error messages
and reusable abstractions:</p>
<div class="sourceCode" id="cb176"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; syntax-classes.rkt</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>(require syntax/parse</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>         syntax/parse/define</span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>         (for-syntax syntax/parse))</span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>(provide define-document-element</span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>         define-renderer</span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>         define-transformer)</span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Syntax class for document element specifications</span></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a>(begin-for-syntax</span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a>  (define-syntax-class element-spec</span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a>    #:description <span class="st">&quot;document element specification&quot;</span></span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a>    #:attributes (name args defaults constraints)</span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-18"><a href="#cb176-18" aria-hidden="true" tabindex="-1"></a>    (pattern (name:id arg:arg-spec <span class="op">...</span>)</span>
<span id="cb176-19"><a href="#cb176-19" aria-hidden="true" tabindex="-1"></a>             #:attr args #&#39;(arg.name <span class="op">...</span>)</span>
<span id="cb176-20"><a href="#cb176-20" aria-hidden="true" tabindex="-1"></a>             #:attr defaults #&#39;(arg.default <span class="op">...</span>)</span>
<span id="cb176-21"><a href="#cb176-21" aria-hidden="true" tabindex="-1"></a>             #:attr constraints #&#39;(arg.constraint <span class="op">...</span>)))</span>
<span id="cb176-22"><a href="#cb176-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb176-23"><a href="#cb176-23" aria-hidden="true" tabindex="-1"></a>  (define-syntax-class arg-spec</span>
<span id="cb176-24"><a href="#cb176-24" aria-hidden="true" tabindex="-1"></a>    #:description <span class="st">&quot;element argument specification&quot;</span></span>
<span id="cb176-25"><a href="#cb176-25" aria-hidden="true" tabindex="-1"></a>    #:attributes (name default constraint)</span>
<span id="cb176-26"><a href="#cb176-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-27"><a href="#cb176-27" aria-hidden="true" tabindex="-1"></a>    (pattern name:id</span>
<span id="cb176-28"><a href="#cb176-28" aria-hidden="true" tabindex="-1"></a>             #:attr default #&#39;<span class="dv">#f</span></span>
<span id="cb176-29"><a href="#cb176-29" aria-hidden="true" tabindex="-1"></a>             #:attr constraint #&#39;any/c)</span>
<span id="cb176-30"><a href="#cb176-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-31"><a href="#cb176-31" aria-hidden="true" tabindex="-1"></a>    (pattern <span class="op">[</span>name:id default-expr<span class="op">]</span></span>
<span id="cb176-32"><a href="#cb176-32" aria-hidden="true" tabindex="-1"></a>             #:attr default #&#39;default-expr</span>
<span id="cb176-33"><a href="#cb176-33" aria-hidden="true" tabindex="-1"></a>             #:attr constraint #&#39;any/c)</span>
<span id="cb176-34"><a href="#cb176-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-35"><a href="#cb176-35" aria-hidden="true" tabindex="-1"></a>    (pattern <span class="op">[</span>name:id default-expr #:contract contract-expr<span class="op">]</span></span>
<span id="cb176-36"><a href="#cb176-36" aria-hidden="true" tabindex="-1"></a>             #:attr default #&#39;default-expr</span>
<span id="cb176-37"><a href="#cb176-37" aria-hidden="true" tabindex="-1"></a>             #:attr constraint #&#39;contract-expr))</span>
<span id="cb176-38"><a href="#cb176-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb176-39"><a href="#cb176-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Enhanced identifier with naming conventions</span></span>
<span id="cb176-40"><a href="#cb176-40" aria-hidden="true" tabindex="-1"></a>  (define-syntax-class naming-convention</span>
<span id="cb176-41"><a href="#cb176-41" aria-hidden="true" tabindex="-1"></a>    #:description <span class="st">&quot;identifier following naming convention&quot;</span></span>
<span id="cb176-42"><a href="#cb176-42" aria-hidden="true" tabindex="-1"></a>    #:attributes (base suffix kind)</span>
<span id="cb176-43"><a href="#cb176-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-44"><a href="#cb176-44" aria-hidden="true" tabindex="-1"></a>    (pattern name:id</span>
<span id="cb176-45"><a href="#cb176-45" aria-hidden="true" tabindex="-1"></a>             #:do <span class="op">[</span>(<span class="ex">define</span><span class="fu"> str </span>(<span class="kw">symbol-&gt;string</span> (syntax-e #&#39;name)))<span class="op">]</span></span>
<span id="cb176-46"><a href="#cb176-46" aria-hidden="true" tabindex="-1"></a>             #:fail-unless (regexp-match? #rx<span class="st">&quot;-element$&quot;</span> str)</span>
<span id="cb176-47"><a href="#cb176-47" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;element names must end with &#39;-element&#39;&quot;</span></span>
<span id="cb176-48"><a href="#cb176-48" aria-hidden="true" tabindex="-1"></a>             #:attr base (<span class="kw">substring</span> str <span class="dv">0</span> (<span class="op">-</span> (<span class="kw">string-length</span> str) <span class="dv">8</span>))</span>
<span id="cb176-49"><a href="#cb176-49" aria-hidden="true" tabindex="-1"></a>             #:attr suffix <span class="st">&quot;element&quot;</span></span>
<span id="cb176-50"><a href="#cb176-50" aria-hidden="true" tabindex="-1"></a>             #:attr kind &#39;element)))</span>
<span id="cb176-51"><a href="#cb176-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-52"><a href="#cb176-52" aria-hidden="true" tabindex="-1"></a><span class="co">;; Macro with comprehensive error checking</span></span>
<span id="cb176-53"><a href="#cb176-53" aria-hidden="true" tabindex="-1"></a>(define-simple-macro </span>
<span id="cb176-54"><a href="#cb176-54" aria-hidden="true" tabindex="-1"></a>  (define-document-element spec:element-spec body <span class="op">...</span>)</span>
<span id="cb176-55"><a href="#cb176-55" aria-hidden="true" tabindex="-1"></a>  #:with name-str (<span class="kw">datum-&gt;syntax</span> #&#39;spec.name</span>
<span id="cb176-56"><a href="#cb176-56" aria-hidden="true" tabindex="-1"></a>                                 (<span class="kw">symbol-&gt;string</span> </span>
<span id="cb176-57"><a href="#cb176-57" aria-hidden="true" tabindex="-1"></a>                                  (syntax-e #&#39;spec.name)))</span>
<span id="cb176-58"><a href="#cb176-58" aria-hidden="true" tabindex="-1"></a>  #:with struct-name (format-id #&#39;spec.name <span class="st">&quot;~a-element&quot;</span> </span>
<span id="cb176-59"><a href="#cb176-59" aria-hidden="true" tabindex="-1"></a>                                #&#39;spec.name)</span>
<span id="cb176-60"><a href="#cb176-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb176-61"><a href="#cb176-61" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">begin</span></span>
<span id="cb176-62"><a href="#cb176-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Define the element structure</span></span>
<span id="cb176-63"><a href="#cb176-63" aria-hidden="true" tabindex="-1"></a>    (struct struct-name (spec.args <span class="op">...</span>)</span>
<span id="cb176-64"><a href="#cb176-64" aria-hidden="true" tabindex="-1"></a>      #:transparent</span>
<span id="cb176-65"><a href="#cb176-65" aria-hidden="true" tabindex="-1"></a>      #:guard (λ (spec.args <span class="op">...</span> name)</span>
<span id="cb176-66"><a href="#cb176-66" aria-hidden="true" tabindex="-1"></a>                (<span class="kw">values</span> (check-contract spec.constraints </span>
<span id="cb176-67"><a href="#cb176-67" aria-hidden="true" tabindex="-1"></a>                                       spec.args </span>
<span id="cb176-68"><a href="#cb176-68" aria-hidden="true" tabindex="-1"></a>                                       &#39;spec.args) <span class="op">...</span>)))</span>
<span id="cb176-69"><a href="#cb176-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-70"><a href="#cb176-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Define constructor with defaults</span></span>
<span id="cb176-71"><a href="#cb176-71" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> </span>(spec.name #:key <span class="op">[</span>spec.args spec.defaults<span class="op">]</span> <span class="op">...</span>)</span>
<span id="cb176-72"><a href="#cb176-72" aria-hidden="true" tabindex="-1"></a>      (struct-name spec.args <span class="op">...</span>))</span>
<span id="cb176-73"><a href="#cb176-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-74"><a href="#cb176-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Register in element table</span></span>
<span id="cb176-75"><a href="#cb176-75" aria-hidden="true" tabindex="-1"></a>    (register-element! &#39;spec.name struct-name)</span>
<span id="cb176-76"><a href="#cb176-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb176-77"><a href="#cb176-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Additional definitions</span></span>
<span id="cb176-78"><a href="#cb176-78" aria-hidden="true" tabindex="-1"></a>    body <span class="op">...</span>))</span>
<span id="cb176-79"><a href="#cb176-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-80"><a href="#cb176-80" aria-hidden="true" tabindex="-1"></a><span class="co">;; Syntax class for pattern matching with bindings</span></span>
<span id="cb176-81"><a href="#cb176-81" aria-hidden="true" tabindex="-1"></a>(define-syntax-class binding-pattern</span>
<span id="cb176-82"><a href="#cb176-82" aria-hidden="true" tabindex="-1"></a>  #:description <span class="st">&quot;pattern with variable bindings&quot;</span></span>
<span id="cb176-83"><a href="#cb176-83" aria-hidden="true" tabindex="-1"></a>  #:attributes ((var <span class="dv">1</span>) (expr <span class="dv">1</span>) arity)</span>
<span id="cb176-84"><a href="#cb176-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb176-85"><a href="#cb176-85" aria-hidden="true" tabindex="-1"></a>  (pattern (~and pat (var:id expr))</span>
<span id="cb176-86"><a href="#cb176-86" aria-hidden="true" tabindex="-1"></a>           #:attr (var <span class="dv">1</span>) (<span class="kw">list</span> #&#39;var)</span>
<span id="cb176-87"><a href="#cb176-87" aria-hidden="true" tabindex="-1"></a>           #:attr (expr <span class="dv">1</span>) (<span class="kw">list</span> #&#39;expr)</span>
<span id="cb176-88"><a href="#cb176-88" aria-hidden="true" tabindex="-1"></a>           #:attr arity <span class="dv">1</span>)</span>
<span id="cb176-89"><a href="#cb176-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb176-90"><a href="#cb176-90" aria-hidden="true" tabindex="-1"></a>  (pattern (~and pat ((~seq var:id expr) <span class="op">...</span>))</span>
<span id="cb176-91"><a href="#cb176-91" aria-hidden="true" tabindex="-1"></a>           #:attr (var <span class="dv">1</span>) (syntax-&gt;list #&#39;(var <span class="op">...</span>))</span>
<span id="cb176-92"><a href="#cb176-92" aria-hidden="true" tabindex="-1"></a>           #:attr (expr <span class="dv">1</span>) (syntax-&gt;list #&#39;(expr <span class="op">...</span>))</span>
<span id="cb176-93"><a href="#cb176-93" aria-hidden="true" tabindex="-1"></a>           #:attr arity (<span class="kw">length</span> (attribute var))))</span>
<span id="cb176-94"><a href="#cb176-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-95"><a href="#cb176-95" aria-hidden="true" tabindex="-1"></a><span class="co">;; Advanced pattern matching macro</span></span>
<span id="cb176-96"><a href="#cb176-96" aria-hidden="true" tabindex="-1"></a>(define-syntax-parse-rule</span>
<span id="cb176-97"><a href="#cb176-97" aria-hidden="true" tabindex="-1"></a>  (match-document form:expr</span>
<span id="cb176-98"><a href="#cb176-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(~literal type:id) pat:binding-pattern </span>
<span id="cb176-99"><a href="#cb176-99" aria-hidden="true" tabindex="-1"></a>     body:expr<span class="op">]</span> ...+)</span>
<span id="cb176-100"><a href="#cb176-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb176-101"><a href="#cb176-101" aria-hidden="true" tabindex="-1"></a>  (match form</span>
<span id="cb176-102"><a href="#cb176-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">list</span> &#39;type pat.expr <span class="op">...</span>)</span>
<span id="cb176-103"><a href="#cb176-103" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> (<span class="op">[</span>pat.var pat.expr<span class="op">]</span> <span class="op">...</span>)</span>
<span id="cb176-104"><a href="#cb176-104" aria-hidden="true" tabindex="-1"></a>       body)<span class="op">]</span></span>
<span id="cb176-105"><a href="#cb176-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb176-106"><a href="#cb176-106" aria-hidden="true" tabindex="-1"></a>    <span class="op">[_</span> (<span class="kw">error</span> <span class="st">&quot;No matching pattern for document:&quot;</span> form)<span class="op">]</span>))</span></code></pre></div>
<h2 id="phase-separation-and-compile-time-computation">Phase Separation
and Compile-Time Computation</h2>
<p>Managing computation across phases for optimal performance:</p>
<div class="sourceCode" id="cb177"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; phase-management.rkt</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>(require (for-syntax racket/syntax</span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>                     syntax/parse)</span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>         (for-meta <span class="dv">2</span> racket/base))</span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>(provide phase-persistent</span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>         compile-time-cache</span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>         define-for-phases)</span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Cross-phase persistent data</span></span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(phase-persistent stx)</span>
<span id="cb177-14"><a href="#cb177-14" aria-hidden="true" tabindex="-1"></a>  (syntax-parse stx</span>
<span id="cb177-15"><a href="#cb177-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> name:id value:expr)</span>
<span id="cb177-16"><a href="#cb177-16" aria-hidden="true" tabindex="-1"></a>     #&#39;(<span class="kw">begin</span></span>
<span id="cb177-17"><a href="#cb177-17" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Phase 0 (runtime)</span></span>
<span id="cb177-18"><a href="#cb177-18" aria-hidden="true" tabindex="-1"></a>         (<span class="ex">define</span><span class="fu"> name </span>value)</span>
<span id="cb177-19"><a href="#cb177-19" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb177-20"><a href="#cb177-20" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Phase 1 (compile-time)</span></span>
<span id="cb177-21"><a href="#cb177-21" aria-hidden="true" tabindex="-1"></a>         (begin-for-syntax</span>
<span id="cb177-22"><a href="#cb177-22" aria-hidden="true" tabindex="-1"></a>           (<span class="ex">define</span><span class="fu"> name </span>value))</span>
<span id="cb177-23"><a href="#cb177-23" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb177-24"><a href="#cb177-24" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Phase -1 (template)</span></span>
<span id="cb177-25"><a href="#cb177-25" aria-hidden="true" tabindex="-1"></a>         (begin-for-template</span>
<span id="cb177-26"><a href="#cb177-26" aria-hidden="true" tabindex="-1"></a>           (<span class="ex">define</span><span class="fu"> name </span>value)))<span class="op">]</span>))</span>
<span id="cb177-27"><a href="#cb177-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-28"><a href="#cb177-28" aria-hidden="true" tabindex="-1"></a><span class="co">;; Compile-time memoization</span></span>
<span id="cb177-29"><a href="#cb177-29" aria-hidden="true" tabindex="-1"></a>(begin-for-syntax</span>
<span id="cb177-30"><a href="#cb177-30" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> compile-cache </span>(make-hash))</span>
<span id="cb177-31"><a href="#cb177-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-32"><a href="#cb177-32" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(cached-compute key thunk)</span>
<span id="cb177-33"><a href="#cb177-33" aria-hidden="true" tabindex="-1"></a>    (hash-ref! compile-cache key thunk)))</span>
<span id="cb177-34"><a href="#cb177-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-35"><a href="#cb177-35" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(compile-time-cache stx)</span>
<span id="cb177-36"><a href="#cb177-36" aria-hidden="true" tabindex="-1"></a>  (syntax-parse stx</span>
<span id="cb177-37"><a href="#cb177-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> key:expr computation:expr)</span>
<span id="cb177-38"><a href="#cb177-38" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> result</span></span>
<span id="cb177-39"><a href="#cb177-39" aria-hidden="true" tabindex="-1"></a>       (cached-compute (<span class="kw">syntax-&gt;datum</span> #&#39;key)</span>
<span id="cb177-40"><a href="#cb177-40" aria-hidden="true" tabindex="-1"></a>                      (λ () (syntax-local-eval #&#39;computation))))</span>
<span id="cb177-41"><a href="#cb177-41" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">datum-&gt;syntax</span> stx result)<span class="op">]</span>))</span>
<span id="cb177-42"><a href="#cb177-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-43"><a href="#cb177-43" aria-hidden="true" tabindex="-1"></a><span class="co">;; Multi-phase definition</span></span>
<span id="cb177-44"><a href="#cb177-44" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(define-for-phases stx)</span>
<span id="cb177-45"><a href="#cb177-45" aria-hidden="true" tabindex="-1"></a>  (syntax-parse stx</span>
<span id="cb177-46"><a href="#cb177-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> (phase:number <span class="op">...</span>) name:id expr:expr)</span>
<span id="cb177-47"><a href="#cb177-47" aria-hidden="true" tabindex="-1"></a>     #:with (phase-def <span class="op">...</span>)</span>
<span id="cb177-48"><a href="#cb177-48" aria-hidden="true" tabindex="-1"></a>     (for/list (<span class="op">[</span>p (syntax-&gt;list #&#39;(phase <span class="op">...</span>))<span class="op">]</span>)</span>
<span id="cb177-49"><a href="#cb177-49" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">with-syntax</span> (<span class="op">[</span>phase p<span class="op">]</span>)</span>
<span id="cb177-50"><a href="#cb177-50" aria-hidden="true" tabindex="-1"></a>         #&#39;(begin-for-meta phase</span>
<span id="cb177-51"><a href="#cb177-51" aria-hidden="true" tabindex="-1"></a>             (<span class="ex">define</span><span class="fu"> name </span>expr))))</span>
<span id="cb177-52"><a href="#cb177-52" aria-hidden="true" tabindex="-1"></a>     #&#39;(<span class="kw">begin</span> phase-def <span class="op">...</span>)<span class="op">]</span>))</span>
<span id="cb177-53"><a href="#cb177-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-54"><a href="#cb177-54" aria-hidden="true" tabindex="-1"></a><span class="co">;; Phase-shifting utilities</span></span>
<span id="cb177-55"><a href="#cb177-55" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(shift-phase stx)</span>
<span id="cb177-56"><a href="#cb177-56" aria-hidden="true" tabindex="-1"></a>  (syntax-parse stx</span>
<span id="cb177-57"><a href="#cb177-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> n:integer body:expr <span class="op">...</span>)</span>
<span id="cb177-58"><a href="#cb177-58" aria-hidden="true" tabindex="-1"></a>     #&#39;(begin-for-meta n body <span class="op">...</span>)<span class="op">]</span>))</span>
<span id="cb177-59"><a href="#cb177-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-60"><a href="#cb177-60" aria-hidden="true" tabindex="-1"></a><span class="co">;; Compile-time code generation</span></span>
<span id="cb177-61"><a href="#cb177-61" aria-hidden="true" tabindex="-1"></a>(begin-for-syntax</span>
<span id="cb177-62"><a href="#cb177-62" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate optimized code based on static analysis</span></span>
<span id="cb177-63"><a href="#cb177-63" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(generate-optimized-renderer elements)</span>
<span id="cb177-64"><a href="#cb177-64" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> groups </span>(group-by-type elements))</span>
<span id="cb177-65"><a href="#cb177-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb177-66"><a href="#cb177-66" aria-hidden="true" tabindex="-1"></a>    #`(λ (doc)</span>
<span id="cb177-67"><a href="#cb177-67" aria-hidden="true" tabindex="-1"></a>        (match (document-type doc)</span>
<span id="cb177-68"><a href="#cb177-68" aria-hidden="true" tabindex="-1"></a>          #,@(for/list (<span class="op">[</span>(type elems) (in-hash groups)<span class="op">]</span>)</span>
<span id="cb177-69"><a href="#cb177-69" aria-hidden="true" tabindex="-1"></a>               #`<span class="op">[</span>#,type </span>
<span id="cb177-70"><a href="#cb177-70" aria-hidden="true" tabindex="-1"></a>                  (render-specialized #,type doc)<span class="op">]</span>)</span>
<span id="cb177-71"><a href="#cb177-71" aria-hidden="true" tabindex="-1"></a>          <span class="op">[_</span> (render-generic doc)<span class="op">]</span>)))</span>
<span id="cb177-72"><a href="#cb177-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-73"><a href="#cb177-73" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Static dependency analysis</span></span>
<span id="cb177-74"><a href="#cb177-74" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(analyze-dependencies syntax-tree)</span>
<span id="cb177-75"><a href="#cb177-75" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> deps </span>(mutable-set))</span>
<span id="cb177-76"><a href="#cb177-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb177-77"><a href="#cb177-77" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">let</span> loop (<span class="op">[</span>stx syntax-tree<span class="op">]</span>)</span>
<span id="cb177-78"><a href="#cb177-78" aria-hidden="true" tabindex="-1"></a>      (syntax-parse stx</span>
<span id="cb177-79"><a href="#cb177-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(require-element name:id)</span>
<span id="cb177-80"><a href="#cb177-80" aria-hidden="true" tabindex="-1"></a>         (set-add! deps (syntax-e #&#39;name))<span class="op">]</span></span>
<span id="cb177-81"><a href="#cb177-81" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(form <span class="op">...</span>)</span>
<span id="cb177-82"><a href="#cb177-82" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">for-each</span> loop (syntax-&gt;list #&#39;(form <span class="op">...</span>)))<span class="op">]</span></span>
<span id="cb177-83"><a href="#cb177-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">[_</span> (void)<span class="op">]</span>))</span>
<span id="cb177-84"><a href="#cb177-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb177-85"><a href="#cb177-85" aria-hidden="true" tabindex="-1"></a>    deps))</span>
<span id="cb177-86"><a href="#cb177-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-87"><a href="#cb177-87" aria-hidden="true" tabindex="-1"></a><span class="co">;; Macro with phase-separated compilation</span></span>
<span id="cb177-88"><a href="#cb177-88" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(optimizing-renderer stx)</span>
<span id="cb177-89"><a href="#cb177-89" aria-hidden="true" tabindex="-1"></a>  (syntax-parse stx</span>
<span id="cb177-90"><a href="#cb177-90" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> name:id </span>
<span id="cb177-91"><a href="#cb177-91" aria-hidden="true" tabindex="-1"></a>        #:elements <span class="op">[</span>elem-name:id elem-def:expr<span class="op">]</span> <span class="op">...</span></span>
<span id="cb177-92"><a href="#cb177-92" aria-hidden="true" tabindex="-1"></a>        body:expr <span class="op">...</span>)</span>
<span id="cb177-93"><a href="#cb177-93" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb177-94"><a href="#cb177-94" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Phase 1: Analyze at compile time</span></span>
<span id="cb177-95"><a href="#cb177-95" aria-hidden="true" tabindex="-1"></a>     #:do <span class="op">[</span>(<span class="ex">define</span><span class="fu"> analysis</span></span>
<span id="cb177-96"><a href="#cb177-96" aria-hidden="true" tabindex="-1"></a>             (analyze-dependencies #&#39;(body <span class="op">...</span>)))<span class="op">]</span></span>
<span id="cb177-97"><a href="#cb177-97" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb177-98"><a href="#cb177-98" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Phase 1: Generate optimized code</span></span>
<span id="cb177-99"><a href="#cb177-99" aria-hidden="true" tabindex="-1"></a>     #:with optimized-body</span>
<span id="cb177-100"><a href="#cb177-100" aria-hidden="true" tabindex="-1"></a>     (generate-optimized-renderer </span>
<span id="cb177-101"><a href="#cb177-101" aria-hidden="true" tabindex="-1"></a>      (syntax-&gt;list #&#39;(elem-name <span class="op">...</span>)))</span>
<span id="cb177-102"><a href="#cb177-102" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb177-103"><a href="#cb177-103" aria-hidden="true" tabindex="-1"></a>     #&#39;(<span class="kw">begin</span></span>
<span id="cb177-104"><a href="#cb177-104" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Phase 0: Runtime definitions</span></span>
<span id="cb177-105"><a href="#cb177-105" aria-hidden="true" tabindex="-1"></a>         (<span class="ex">define</span><span class="fu"> elem-name </span>elem-def) <span class="op">...</span></span>
<span id="cb177-106"><a href="#cb177-106" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb177-107"><a href="#cb177-107" aria-hidden="true" tabindex="-1"></a>         (<span class="ex">define</span><span class="fu"> name</span></span>
<span id="cb177-108"><a href="#cb177-108" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">let</span> (<span class="op">[</span>renderer optimized-body<span class="op">]</span>)</span>
<span id="cb177-109"><a href="#cb177-109" aria-hidden="true" tabindex="-1"></a>             (λ (doc)</span>
<span id="cb177-110"><a href="#cb177-110" aria-hidden="true" tabindex="-1"></a>               (parameterize (<span class="op">[</span>current-renderer renderer<span class="op">]</span>)</span>
<span id="cb177-111"><a href="#cb177-111" aria-hidden="true" tabindex="-1"></a>                 body <span class="op">...</span></span>
<span id="cb177-112"><a href="#cb177-112" aria-hidden="true" tabindex="-1"></a>                 (renderer doc))))))<span class="op">]</span>))</span></code></pre></div>
<h2 id="advanced-module-system-features">Advanced Module System
Features</h2>
<p>Sophisticated module management and language composition:</p>
<div class="sourceCode" id="cb178"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; module-system.rkt</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>(require racket/unit</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>         racket/contract</span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>         syntax/modread)</span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>(provide define-unit-language</span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>         language-compose</span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>         module-installer)</span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Unit-based language components</span></span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a>(define-signature parser^</span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>parse-document</span>
<span id="cb178-15"><a href="#cb178-15" aria-hidden="true" tabindex="-1"></a>   parse-fragment</span>
<span id="cb178-16"><a href="#cb178-16" aria-hidden="true" tabindex="-1"></a>   parse-inline<span class="op">]</span>)</span>
<span id="cb178-17"><a href="#cb178-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-18"><a href="#cb178-18" aria-hidden="true" tabindex="-1"></a>(define-signature renderer^</span>
<span id="cb178-19"><a href="#cb178-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>render-html</span>
<span id="cb178-20"><a href="#cb178-20" aria-hidden="true" tabindex="-1"></a>   render-latex</span>
<span id="cb178-21"><a href="#cb178-21" aria-hidden="true" tabindex="-1"></a>   render-markdown<span class="op">]</span>)</span>
<span id="cb178-22"><a href="#cb178-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-23"><a href="#cb178-23" aria-hidden="true" tabindex="-1"></a>(define-signature transformer^</span>
<span id="cb178-24"><a href="#cb178-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>transform-ast</span>
<span id="cb178-25"><a href="#cb178-25" aria-hidden="true" tabindex="-1"></a>   optimize-ast</span>
<span id="cb178-26"><a href="#cb178-26" aria-hidden="true" tabindex="-1"></a>   validate-ast<span class="op">]</span>)</span>
<span id="cb178-27"><a href="#cb178-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-28"><a href="#cb178-28" aria-hidden="true" tabindex="-1"></a><span class="co">;; Create composable language units</span></span>
<span id="cb178-29"><a href="#cb178-29" aria-hidden="true" tabindex="-1"></a>(define-syntax-rule </span>
<span id="cb178-30"><a href="#cb178-30" aria-hidden="true" tabindex="-1"></a>  (define-unit-language name </span>
<span id="cb178-31"><a href="#cb178-31" aria-hidden="true" tabindex="-1"></a>    #:parser parser-expr</span>
<span id="cb178-32"><a href="#cb178-32" aria-hidden="true" tabindex="-1"></a>    #:renderer renderer-expr</span>
<span id="cb178-33"><a href="#cb178-33" aria-hidden="true" tabindex="-1"></a>    #:transformer transformer-expr)</span>
<span id="cb178-34"><a href="#cb178-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-35"><a href="#cb178-35" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">begin</span></span>
<span id="cb178-36"><a href="#cb178-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Define unit</span></span>
<span id="cb178-37"><a href="#cb178-37" aria-hidden="true" tabindex="-1"></a>    (define-unit name@</span>
<span id="cb178-38"><a href="#cb178-38" aria-hidden="true" tabindex="-1"></a>      (import)</span>
<span id="cb178-39"><a href="#cb178-39" aria-hidden="true" tabindex="-1"></a>      (export parser^ renderer^ transformer^)</span>
<span id="cb178-40"><a href="#cb178-40" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb178-41"><a href="#cb178-41" aria-hidden="true" tabindex="-1"></a>      parser-expr</span>
<span id="cb178-42"><a href="#cb178-42" aria-hidden="true" tabindex="-1"></a>      renderer-expr  </span>
<span id="cb178-43"><a href="#cb178-43" aria-hidden="true" tabindex="-1"></a>      transformer-expr)</span>
<span id="cb178-44"><a href="#cb178-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb178-45"><a href="#cb178-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">;; Define instantiation</span></span>
<span id="cb178-46"><a href="#cb178-46" aria-hidden="true" tabindex="-1"></a>    (define-values/invoke-unit name@</span>
<span id="cb178-47"><a href="#cb178-47" aria-hidden="true" tabindex="-1"></a>      (export parser^ renderer^ transformer^))))</span>
<span id="cb178-48"><a href="#cb178-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-49"><a href="#cb178-49" aria-hidden="true" tabindex="-1"></a><span class="co">;; Language composition</span></span>
<span id="cb178-50"><a href="#cb178-50" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(language-compose stx)</span>
<span id="cb178-51"><a href="#cb178-51" aria-hidden="true" tabindex="-1"></a>  (syntax-parse stx</span>
<span id="cb178-52"><a href="#cb178-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> name:id</span>
<span id="cb178-53"><a href="#cb178-53" aria-hidden="true" tabindex="-1"></a>        #:base base-lang:id</span>
<span id="cb178-54"><a href="#cb178-54" aria-hidden="true" tabindex="-1"></a>        #:extend (<span class="op">[</span>signature:id unit:id<span class="op">]</span> <span class="op">...</span>)</span>
<span id="cb178-55"><a href="#cb178-55" aria-hidden="true" tabindex="-1"></a>        #:override (<span class="op">[</span>sig:id replacement:expr<span class="op">]</span> <span class="op">...</span>))</span>
<span id="cb178-56"><a href="#cb178-56" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb178-57"><a href="#cb178-57" aria-hidden="true" tabindex="-1"></a>     #&#39;(<span class="kw">begin</span></span>
<span id="cb178-58"><a href="#cb178-58" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Create compound unit</span></span>
<span id="cb178-59"><a href="#cb178-59" aria-hidden="true" tabindex="-1"></a>         (define-compound-unit name@</span>
<span id="cb178-60"><a href="#cb178-60" aria-hidden="true" tabindex="-1"></a>           (import)</span>
<span id="cb178-61"><a href="#cb178-61" aria-hidden="true" tabindex="-1"></a>           (export merged^)</span>
<span id="cb178-62"><a href="#cb178-62" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb178-63"><a href="#cb178-63" aria-hidden="true" tabindex="-1"></a>           (link <span class="op">[</span>base : base-signatures^ base-lang@<span class="op">]</span></span>
<span id="cb178-64"><a href="#cb178-64" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>ext : signature unit<span class="op">]</span> <span class="op">...</span></span>
<span id="cb178-65"><a href="#cb178-65" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>merged : merged^ </span>
<span id="cb178-66"><a href="#cb178-66" aria-hidden="true" tabindex="-1"></a>                  (merge-units@ base ext <span class="op">...</span>)<span class="op">]</span>))</span>
<span id="cb178-67"><a href="#cb178-67" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb178-68"><a href="#cb178-68" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Apply overrides</span></span>
<span id="cb178-69"><a href="#cb178-69" aria-hidden="true" tabindex="-1"></a>         (define-unit name-with-overrides@</span>
<span id="cb178-70"><a href="#cb178-70" aria-hidden="true" tabindex="-1"></a>           (import)</span>
<span id="cb178-71"><a href="#cb178-71" aria-hidden="true" tabindex="-1"></a>           (export final^)</span>
<span id="cb178-72"><a href="#cb178-72" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb178-73"><a href="#cb178-73" aria-hidden="true" tabindex="-1"></a>           (define-values/invoke-unit name@</span>
<span id="cb178-74"><a href="#cb178-74" aria-hidden="true" tabindex="-1"></a>             (export intermediate^))</span>
<span id="cb178-75"><a href="#cb178-75" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb178-76"><a href="#cb178-76" aria-hidden="true" tabindex="-1"></a>           (<span class="ex">define</span><span class="fu"> sig </span>replacement) <span class="op">...</span></span>
<span id="cb178-77"><a href="#cb178-77" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb178-78"><a href="#cb178-78" aria-hidden="true" tabindex="-1"></a>           (define-values (remaining <span class="op">...</span>)</span>
<span id="cb178-79"><a href="#cb178-79" aria-hidden="true" tabindex="-1"></a>             (filter-not overridden? </span>
<span id="cb178-80"><a href="#cb178-80" aria-hidden="true" tabindex="-1"></a>                        (intermediate-exports))))</span>
<span id="cb178-81"><a href="#cb178-81" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb178-82"><a href="#cb178-82" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Install as module language</span></span>
<span id="cb178-83"><a href="#cb178-83" aria-hidden="true" tabindex="-1"></a>         (install-language! &#39;name name-with-overrides@))<span class="op">]</span>))</span>
<span id="cb178-84"><a href="#cb178-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-85"><a href="#cb178-85" aria-hidden="true" tabindex="-1"></a><span class="co">;; Dynamic module loading</span></span>
<span id="cb178-86"><a href="#cb178-86" aria-hidden="true" tabindex="-1"></a>(struct module-loader</span>
<span id="cb178-87"><a href="#cb178-87" aria-hidden="true" tabindex="-1"></a>  (search-paths</span>
<span id="cb178-88"><a href="#cb178-88" aria-hidden="true" tabindex="-1"></a>   cache</span>
<span id="cb178-89"><a href="#cb178-89" aria-hidden="true" tabindex="-1"></a>   transformers)</span>
<span id="cb178-90"><a href="#cb178-90" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb178-91"><a href="#cb178-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-92"><a href="#cb178-92" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-module-loader)</span>
<span id="cb178-93"><a href="#cb178-93" aria-hidden="true" tabindex="-1"></a>  (module-loader</span>
<span id="cb178-94"><a href="#cb178-94" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span> (current-directory))</span>
<span id="cb178-95"><a href="#cb178-95" aria-hidden="true" tabindex="-1"></a>   (make-hash)</span>
<span id="cb178-96"><a href="#cb178-96" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span>)))</span>
<span id="cb178-97"><a href="#cb178-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-98"><a href="#cb178-98" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(load-language-module loader path)</span>
<span id="cb178-99"><a href="#cb178-99" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cache </span>(module-loader-cache loader))</span>
<span id="cb178-100"><a href="#cb178-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-101"><a href="#cb178-101" aria-hidden="true" tabindex="-1"></a>  (hash-ref! cache path</span>
<span id="cb178-102"><a href="#cb178-102" aria-hidden="true" tabindex="-1"></a>    (λ ()</span>
<span id="cb178-103"><a href="#cb178-103" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> module-path </span>(resolve-module-path path loader))</span>
<span id="cb178-104"><a href="#cb178-104" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb178-105"><a href="#cb178-105" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Load and instantiate</span></span>
<span id="cb178-106"><a href="#cb178-106" aria-hidden="true" tabindex="-1"></a>      (dynamic-require module-path <span class="dv">#f</span>)</span>
<span id="cb178-107"><a href="#cb178-107" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb178-108"><a href="#cb178-108" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Apply transformers</span></span>
<span id="cb178-109"><a href="#cb178-109" aria-hidden="true" tabindex="-1"></a>      (for/fold (<span class="op">[</span><span class="kw">mod</span> (dynamic-require module-path &#39;module-exports)<span class="op">]</span>)</span>
<span id="cb178-110"><a href="#cb178-110" aria-hidden="true" tabindex="-1"></a>                (<span class="op">[</span>transform (module-loader-transformers loader)<span class="op">]</span>)</span>
<span id="cb178-111"><a href="#cb178-111" aria-hidden="true" tabindex="-1"></a>        (transform <span class="kw">mod</span>))</span>
<span id="cb178-112"><a href="#cb178-112" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb178-113"><a href="#cb178-113" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Return processed module</span></span>
<span id="cb178-114"><a href="#cb178-114" aria-hidden="true" tabindex="-1"></a>      <span class="kw">mod</span>)))</span>
<span id="cb178-115"><a href="#cb178-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-116"><a href="#cb178-116" aria-hidden="true" tabindex="-1"></a><span class="co">;; Module installation and configuration</span></span>
<span id="cb178-117"><a href="#cb178-117" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> </span>(module-installer stx)</span>
<span id="cb178-118"><a href="#cb178-118" aria-hidden="true" tabindex="-1"></a>  (syntax-parse stx</span>
<span id="cb178-119"><a href="#cb178-119" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> config:expr)</span>
<span id="cb178-120"><a href="#cb178-120" aria-hidden="true" tabindex="-1"></a>     #:with config-datum (<span class="kw">syntax-&gt;datum</span> #&#39;config)</span>
<span id="cb178-121"><a href="#cb178-121" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb178-122"><a href="#cb178-122" aria-hidden="true" tabindex="-1"></a>     #&#39;(<span class="kw">begin</span></span>
<span id="cb178-123"><a href="#cb178-123" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Generate module reader</span></span>
<span id="cb178-124"><a href="#cb178-124" aria-hidden="true" tabindex="-1"></a>         (<span class="ex">define</span><span class="fu"> read-syntax</span></span>
<span id="cb178-125"><a href="#cb178-125" aria-hidden="true" tabindex="-1"></a>           (make-meta-reader</span>
<span id="cb178-126"><a href="#cb178-126" aria-hidden="true" tabindex="-1"></a>            &#39;shrdlu-language</span>
<span id="cb178-127"><a href="#cb178-127" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;language «shrdlu-language»&quot;</span></span>
<span id="cb178-128"><a href="#cb178-128" aria-hidden="true" tabindex="-1"></a>            (λ (in)</span>
<span id="cb178-129"><a href="#cb178-129" aria-hidden="true" tabindex="-1"></a>              (parameterize (<span class="op">[</span>current-readtable </span>
<span id="cb178-130"><a href="#cb178-130" aria-hidden="true" tabindex="-1"></a>                             (make-shrdlu-readtable)<span class="op">]</span>)</span>
<span id="cb178-131"><a href="#cb178-131" aria-hidden="true" tabindex="-1"></a>                (read-syntax/recursive in)))</span>
<span id="cb178-132"><a href="#cb178-132" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb178-133"><a href="#cb178-133" aria-hidden="true" tabindex="-1"></a>            <span class="co">;; Custom reader extensions</span></span>
<span id="cb178-134"><a href="#cb178-134" aria-hidden="true" tabindex="-1"></a>            (λ (proc)</span>
<span id="cb178-135"><a href="#cb178-135" aria-hidden="true" tabindex="-1"></a>              (λ (in src module-path)</span>
<span id="cb178-136"><a href="#cb178-136" aria-hidden="true" tabindex="-1"></a>                (<span class="ex">define</span><span class="fu"> config </span>config-datum)</span>
<span id="cb178-137"><a href="#cb178-137" aria-hidden="true" tabindex="-1"></a>                (parameterize (<span class="op">[</span>current-language-config config<span class="op">]</span>)</span>
<span id="cb178-138"><a href="#cb178-138" aria-hidden="true" tabindex="-1"></a>                  (proc in src module-path))))))</span>
<span id="cb178-139"><a href="#cb178-139" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb178-140"><a href="#cb178-140" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Provide module language</span></span>
<span id="cb178-141"><a href="#cb178-141" aria-hidden="true" tabindex="-1"></a>         (provide (except-out (all-from-out racket)</span>
<span id="cb178-142"><a href="#cb178-142" aria-hidden="true" tabindex="-1"></a>                             #%module-begin)</span>
<span id="cb178-143"><a href="#cb178-143" aria-hidden="true" tabindex="-1"></a>                  (rename-out <span class="op">[</span>module-begin #%module-begin<span class="op">]</span>))</span>
<span id="cb178-144"><a href="#cb178-144" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb178-145"><a href="#cb178-145" aria-hidden="true" tabindex="-1"></a>         <span class="co">;; Custom module begin</span></span>
<span id="cb178-146"><a href="#cb178-146" aria-hidden="true" tabindex="-1"></a>         (<span class="ex">define-syntax</span><span class="fu"> </span>(module-begin stx)</span>
<span id="cb178-147"><a href="#cb178-147" aria-hidden="true" tabindex="-1"></a>           (syntax-parse stx</span>
<span id="cb178-148"><a href="#cb178-148" aria-hidden="true" tabindex="-1"></a>             <span class="op">[</span>(<span class="op">_</span> body <span class="op">...</span>)</span>
<span id="cb178-149"><a href="#cb178-149" aria-hidden="true" tabindex="-1"></a>              #&#39;(#%plain-module-begin</span>
<span id="cb178-150"><a href="#cb178-150" aria-hidden="true" tabindex="-1"></a>                 <span class="co">;; Initialize language runtime</span></span>
<span id="cb178-151"><a href="#cb178-151" aria-hidden="true" tabindex="-1"></a>                 (initialize-shrdlu-language &#39;config-datum)</span>
<span id="cb178-152"><a href="#cb178-152" aria-hidden="true" tabindex="-1"></a>                 </span>
<span id="cb178-153"><a href="#cb178-153" aria-hidden="true" tabindex="-1"></a>                 <span class="co">;; Process module body</span></span>
<span id="cb178-154"><a href="#cb178-154" aria-hidden="true" tabindex="-1"></a>                 body <span class="op">...</span>)<span class="op">]</span>)))<span class="op">]</span>))</span></code></pre></div>
<h2 id="continuation-based-control-flow">Continuation-Based Control
Flow</h2>
<p>Advanced control structures using continuations and prompts:</p>
<div class="sourceCode" id="cb179"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; control-flow.rkt</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>(require racket/control)</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>(provide generator</span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>         async/await</span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>         coroutine</span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>         backtracking-search)</span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generator implementation</span></span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>(define-syntax-rule (generator body <span class="op">...</span>)</span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> (<span class="op">[</span>suspended <span class="dv">#f</span><span class="op">]</span></span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>done <span class="dv">#f</span><span class="op">]</span>)</span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> </span>(yield value)</span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>      (shift k</span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">set!</span> suspended k)</span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a>        value))</span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a>    (λ ()</span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">if</span> done</span>
<span id="cb179-22"><a href="#cb179-22" aria-hidden="true" tabindex="-1"></a>          eof</span>
<span id="cb179-23"><a href="#cb179-23" aria-hidden="true" tabindex="-1"></a>          (reset</span>
<span id="cb179-24"><a href="#cb179-24" aria-hidden="true" tabindex="-1"></a>           (when suspended</span>
<span id="cb179-25"><a href="#cb179-25" aria-hidden="true" tabindex="-1"></a>             (suspended &#39;resume))</span>
<span id="cb179-26"><a href="#cb179-26" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">let</span> (<span class="op">[</span>result (<span class="kw">begin</span> body <span class="op">...</span>)<span class="op">]</span>)</span>
<span id="cb179-27"><a href="#cb179-27" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">set!</span> done <span class="dv">#t</span>)</span>
<span id="cb179-28"><a href="#cb179-28" aria-hidden="true" tabindex="-1"></a>             result))))))</span>
<span id="cb179-29"><a href="#cb179-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-30"><a href="#cb179-30" aria-hidden="true" tabindex="-1"></a><span class="co">;; Async/await pattern</span></span>
<span id="cb179-31"><a href="#cb179-31" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> async</span></span>
<span id="cb179-32"><a href="#cb179-32" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-rules</span> ()</span>
<span id="cb179-33"><a href="#cb179-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> body <span class="op">...</span>)</span>
<span id="cb179-34"><a href="#cb179-34" aria-hidden="true" tabindex="-1"></a>     (thread (λ () body <span class="op">...</span>))<span class="op">]</span>))</span>
<span id="cb179-35"><a href="#cb179-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-36"><a href="#cb179-36" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> await</span></span>
<span id="cb179-37"><a href="#cb179-37" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-rules</span> ()</span>
<span id="cb179-38"><a href="#cb179-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> expr)</span>
<span id="cb179-39"><a href="#cb179-39" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> (<span class="op">[</span>result-channel (make-channel)<span class="op">]</span>)</span>
<span id="cb179-40"><a href="#cb179-40" aria-hidden="true" tabindex="-1"></a>       (thread (λ ()</span>
<span id="cb179-41"><a href="#cb179-41" aria-hidden="true" tabindex="-1"></a>                (channel-put result-channel expr)))</span>
<span id="cb179-42"><a href="#cb179-42" aria-hidden="true" tabindex="-1"></a>       (channel-get result-channel))<span class="op">]</span>))</span>
<span id="cb179-43"><a href="#cb179-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-44"><a href="#cb179-44" aria-hidden="true" tabindex="-1"></a><span class="co">;; Coroutine implementation</span></span>
<span id="cb179-45"><a href="#cb179-45" aria-hidden="true" tabindex="-1"></a>(struct coroutine</span>
<span id="cb179-46"><a href="#cb179-46" aria-hidden="true" tabindex="-1"></a>  (proc</span>
<span id="cb179-47"><a href="#cb179-47" aria-hidden="true" tabindex="-1"></a>   state</span>
<span id="cb179-48"><a href="#cb179-48" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>continuation #:mutable<span class="op">]</span>)</span>
<span id="cb179-49"><a href="#cb179-49" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb179-50"><a href="#cb179-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-51"><a href="#cb179-51" aria-hidden="true" tabindex="-1"></a>(define-syntax-rule (define-coroutine (name args <span class="op">...</span>)</span>
<span id="cb179-52"><a href="#cb179-52" aria-hidden="true" tabindex="-1"></a>                     body <span class="op">...</span>)</span>
<span id="cb179-53"><a href="#cb179-53" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(name args <span class="op">...</span>)</span>
<span id="cb179-54"><a href="#cb179-54" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> state </span>(make-hash))</span>
<span id="cb179-55"><a href="#cb179-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-56"><a href="#cb179-56" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> </span>(suspend <span class="op">[</span>value (void)<span class="op">]</span>)</span>
<span id="cb179-57"><a href="#cb179-57" aria-hidden="true" tabindex="-1"></a>      (shift k</span>
<span id="cb179-58"><a href="#cb179-58" aria-hidden="true" tabindex="-1"></a>        (set-coroutine-continuation! self k)</span>
<span id="cb179-59"><a href="#cb179-59" aria-hidden="true" tabindex="-1"></a>        value))</span>
<span id="cb179-60"><a href="#cb179-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-61"><a href="#cb179-61" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> </span>(resume <span class="op">[</span>value (void)<span class="op">]</span>)</span>
<span id="cb179-62"><a href="#cb179-62" aria-hidden="true" tabindex="-1"></a>      (<span class="ex">define</span><span class="fu"> k </span>(coroutine-continuation self))</span>
<span id="cb179-63"><a href="#cb179-63" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">if</span> k</span>
<span id="cb179-64"><a href="#cb179-64" aria-hidden="true" tabindex="-1"></a>          (reset (k value))</span>
<span id="cb179-65"><a href="#cb179-65" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">error</span> <span class="st">&quot;Coroutine not suspended&quot;</span>)))</span>
<span id="cb179-66"><a href="#cb179-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-67"><a href="#cb179-67" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> self</span></span>
<span id="cb179-68"><a href="#cb179-68" aria-hidden="true" tabindex="-1"></a>      (coroutine </span>
<span id="cb179-69"><a href="#cb179-69" aria-hidden="true" tabindex="-1"></a>       (λ () </span>
<span id="cb179-70"><a href="#cb179-70" aria-hidden="true" tabindex="-1"></a>         (reset body <span class="op">...</span>))</span>
<span id="cb179-71"><a href="#cb179-71" aria-hidden="true" tabindex="-1"></a>       state</span>
<span id="cb179-72"><a href="#cb179-72" aria-hidden="true" tabindex="-1"></a>       <span class="dv">#f</span>))</span>
<span id="cb179-73"><a href="#cb179-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-74"><a href="#cb179-74" aria-hidden="true" tabindex="-1"></a>    self))</span>
<span id="cb179-75"><a href="#cb179-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-76"><a href="#cb179-76" aria-hidden="true" tabindex="-1"></a><span class="co">;; Backtracking search with continuations</span></span>
<span id="cb179-77"><a href="#cb179-77" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(backtracking-search choices goal?)</span>
<span id="cb179-78"><a href="#cb179-78" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> solutions </span>&#39;())</span>
<span id="cb179-79"><a href="#cb179-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-80"><a href="#cb179-80" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(explore path remaining-choices)</span>
<span id="cb179-81"><a href="#cb179-81" aria-hidden="true" tabindex="-1"></a>    (shift k</span>
<span id="cb179-82"><a href="#cb179-82" aria-hidden="true" tabindex="-1"></a>      (for (<span class="op">[</span>choice remaining-choices<span class="op">]</span>)</span>
<span id="cb179-83"><a href="#cb179-83" aria-hidden="true" tabindex="-1"></a>        (reset </span>
<span id="cb179-84"><a href="#cb179-84" aria-hidden="true" tabindex="-1"></a>         (k (<span class="kw">cons</span> choice path) </span>
<span id="cb179-85"><a href="#cb179-85" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">remove</span> choice remaining-choices))))))</span>
<span id="cb179-86"><a href="#cb179-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-87"><a href="#cb179-87" aria-hidden="true" tabindex="-1"></a>  (reset</span>
<span id="cb179-88"><a href="#cb179-88" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">let</span> loop (<span class="op">[</span>path &#39;()<span class="op">]</span></span>
<span id="cb179-89"><a href="#cb179-89" aria-hidden="true" tabindex="-1"></a>              <span class="op">[</span>remaining choices<span class="op">]</span>)</span>
<span id="cb179-90"><a href="#cb179-90" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">cond</span></span>
<span id="cb179-91"><a href="#cb179-91" aria-hidden="true" tabindex="-1"></a>       <span class="op">[</span>(goal? path)</span>
<span id="cb179-92"><a href="#cb179-92" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">set!</span> solutions (<span class="kw">cons</span> (<span class="kw">reverse</span> path) solutions))<span class="op">]</span></span>
<span id="cb179-93"><a href="#cb179-93" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb179-94"><a href="#cb179-94" aria-hidden="true" tabindex="-1"></a>       <span class="op">[</span>(<span class="kw">not</span> (<span class="kw">null?</span> remaining))</span>
<span id="cb179-95"><a href="#cb179-95" aria-hidden="true" tabindex="-1"></a>        (explore path remaining)</span>
<span id="cb179-96"><a href="#cb179-96" aria-hidden="true" tabindex="-1"></a>        (loop path remaining)<span class="op">]</span>)))</span>
<span id="cb179-97"><a href="#cb179-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-98"><a href="#cb179-98" aria-hidden="true" tabindex="-1"></a>  solutions)</span>
<span id="cb179-99"><a href="#cb179-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-100"><a href="#cb179-100" aria-hidden="true" tabindex="-1"></a><span class="co">;; Delimited control for resource management</span></span>
<span id="cb179-101"><a href="#cb179-101" aria-hidden="true" tabindex="-1"></a>(define-syntax-rule (with-resource resource-expr</span>
<span id="cb179-102"><a href="#cb179-102" aria-hidden="true" tabindex="-1"></a>                                  cleanup-expr</span>
<span id="cb179-103"><a href="#cb179-103" aria-hidden="true" tabindex="-1"></a>                                  body <span class="op">...</span>)</span>
<span id="cb179-104"><a href="#cb179-104" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> (<span class="op">[</span>resource resource-expr<span class="op">]</span>)</span>
<span id="cb179-105"><a href="#cb179-105" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">dynamic-wind</span></span>
<span id="cb179-106"><a href="#cb179-106" aria-hidden="true" tabindex="-1"></a>      void</span>
<span id="cb179-107"><a href="#cb179-107" aria-hidden="true" tabindex="-1"></a>      (λ () body <span class="op">...</span>)</span>
<span id="cb179-108"><a href="#cb179-108" aria-hidden="true" tabindex="-1"></a>      (λ () cleanup-expr))))</span>
<span id="cb179-109"><a href="#cb179-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-110"><a href="#cb179-110" aria-hidden="true" tabindex="-1"></a><span class="co">;; Continuation-based exception handling</span></span>
<span id="cb179-111"><a href="#cb179-111" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define-syntax</span><span class="fu"> try</span></span>
<span id="cb179-112"><a href="#cb179-112" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-rules</span> (<span class="kw">catch</span> finally)</span>
<span id="cb179-113"><a href="#cb179-113" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> body <span class="op">...</span> </span>
<span id="cb179-114"><a href="#cb179-114" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">catch</span> (<span class="op">[</span>exception-type handler<span class="op">]</span> <span class="op">...</span>))</span>
<span id="cb179-115"><a href="#cb179-115" aria-hidden="true" tabindex="-1"></a>        (finally cleanup <span class="op">...</span>))</span>
<span id="cb179-116"><a href="#cb179-116" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-117"><a href="#cb179-117" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> (<span class="op">[</span>cleanup-thunk (λ () cleanup <span class="op">...</span>)<span class="op">]</span>)</span>
<span id="cb179-118"><a href="#cb179-118" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">dynamic-wind</span></span>
<span id="cb179-119"><a href="#cb179-119" aria-hidden="true" tabindex="-1"></a>         void</span>
<span id="cb179-120"><a href="#cb179-120" aria-hidden="true" tabindex="-1"></a>         (λ ()</span>
<span id="cb179-121"><a href="#cb179-121" aria-hidden="true" tabindex="-1"></a>           (</span>
<span id="cb179-122"><a href="#cb179-122" aria-hidden="true" tabindex="-1"></a># Chapter <span class="dv">14</span>: Deployment <span class="kw">and</span> Real-World Usage</span>
<span id="cb179-123"><a href="#cb179-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-124"><a href="#cb179-124" aria-hidden="true" tabindex="-1"></a>## From Development to Production</span>
<span id="cb179-125"><a href="#cb179-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-126"><a href="#cb179-126" aria-hidden="true" tabindex="-1"></a>Building Shrdlu is just the beginning. This chapter covers deployment strategies, performance optimization, real-world integration patterns, <span class="kw">and</span> maintaining a production static site generator. We&#39;ll explore deploying to various platforms with a focus on GitHub Pages, setting up custom domains, <span class="kw">and</span> ensuring your sites remain fast <span class="kw">and</span> reliable.</span>
<span id="cb179-127"><a href="#cb179-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-128"><a href="#cb179-128" aria-hidden="true" tabindex="-1"></a>## Building for Production</span>
<span id="cb179-129"><a href="#cb179-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-130"><a href="#cb179-130" aria-hidden="true" tabindex="-1"></a>Production builds require optimization, <span class="kw">error</span> handling, <span class="kw">and</span> proper configuration:</span>
<span id="cb179-131"><a href="#cb179-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-132"><a href="#cb179-132" aria-hidden="true" tabindex="-1"></a>```scheme</span>
<span id="cb179-133"><a href="#cb179-133" aria-hidden="true" tabindex="-1"></a><span class="co">;; production-build.rkt</span></span>
<span id="cb179-134"><a href="#cb179-134" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb179-135"><a href="#cb179-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-136"><a href="#cb179-136" aria-hidden="true" tabindex="-1"></a>(require <span class="st">&quot;core/builder.rkt&quot;</span></span>
<span id="cb179-137"><a href="#cb179-137" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;core/optimizer.rkt&quot;</span></span>
<span id="cb179-138"><a href="#cb179-138" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;core/config.rkt&quot;</span></span>
<span id="cb179-139"><a href="#cb179-139" aria-hidden="true" tabindex="-1"></a>         racket/cmdline</span>
<span id="cb179-140"><a href="#cb179-140" aria-hidden="true" tabindex="-1"></a>         racket/file</span>
<span id="cb179-141"><a href="#cb179-141" aria-hidden="true" tabindex="-1"></a>         racket/logging)</span>
<span id="cb179-142"><a href="#cb179-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-143"><a href="#cb179-143" aria-hidden="true" tabindex="-1"></a>(provide production-build</span>
<span id="cb179-144"><a href="#cb179-144" aria-hidden="true" tabindex="-1"></a>         build-configuration</span>
<span id="cb179-145"><a href="#cb179-145" aria-hidden="true" tabindex="-1"></a>         optimization-passes)</span>
<span id="cb179-146"><a href="#cb179-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-147"><a href="#cb179-147" aria-hidden="true" tabindex="-1"></a><span class="co">;; Build configuration structure</span></span>
<span id="cb179-148"><a href="#cb179-148" aria-hidden="true" tabindex="-1"></a>(struct build-config</span>
<span id="cb179-149"><a href="#cb179-149" aria-hidden="true" tabindex="-1"></a>  (source-dir</span>
<span id="cb179-150"><a href="#cb179-150" aria-hidden="true" tabindex="-1"></a>   output-dir</span>
<span id="cb179-151"><a href="#cb179-151" aria-hidden="true" tabindex="-1"></a>   base-url</span>
<span id="cb179-152"><a href="#cb179-152" aria-hidden="true" tabindex="-1"></a>   minify?</span>
<span id="cb179-153"><a href="#cb179-153" aria-hidden="true" tabindex="-1"></a>   generate-sitemap?</span>
<span id="cb179-154"><a href="#cb179-154" aria-hidden="true" tabindex="-1"></a>   cache-bust?</span>
<span id="cb179-155"><a href="#cb179-155" aria-hidden="true" tabindex="-1"></a>   compression-level</span>
<span id="cb179-156"><a href="#cb179-156" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>custom-domain #:mutable<span class="op">]</span>)</span>
<span id="cb179-157"><a href="#cb179-157" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb179-158"><a href="#cb179-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-159"><a href="#cb179-159" aria-hidden="true" tabindex="-1"></a><span class="co">;; Production build pipeline</span></span>
<span id="cb179-160"><a href="#cb179-160" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(production-build config)</span>
<span id="cb179-161"><a href="#cb179-161" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> logger </span>(make-logger &#39;shrdlu-build))</span>
<span id="cb179-162"><a href="#cb179-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-163"><a href="#cb179-163" aria-hidden="true" tabindex="-1"></a>  (with-logging-to-port</span>
<span id="cb179-164"><a href="#cb179-164" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">current-output-port</span>)</span>
<span id="cb179-165"><a href="#cb179-165" aria-hidden="true" tabindex="-1"></a>   (λ ()</span>
<span id="cb179-166"><a href="#cb179-166" aria-hidden="true" tabindex="-1"></a>     (log-message logger &#39;info <span class="st">&quot;Starting production build&quot;</span>)</span>
<span id="cb179-167"><a href="#cb179-167" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-168"><a href="#cb179-168" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Phase 1: Clean output directory</span></span>
<span id="cb179-169"><a href="#cb179-169" aria-hidden="true" tabindex="-1"></a>     (when (directory-exists? (build-config-output-dir config))</span>
<span id="cb179-170"><a href="#cb179-170" aria-hidden="true" tabindex="-1"></a>       (delete-directory/files (build-config-output-dir config)))</span>
<span id="cb179-171"><a href="#cb179-171" aria-hidden="true" tabindex="-1"></a>     (make-directory* (build-config-output-dir config))</span>
<span id="cb179-172"><a href="#cb179-172" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-173"><a href="#cb179-173" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Phase 2: Process all content</span></span>
<span id="cb179-174"><a href="#cb179-174" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> pages</span></span>
<span id="cb179-175"><a href="#cb179-175" aria-hidden="true" tabindex="-1"></a>       (parameterize (<span class="op">[</span>current-build-config config<span class="op">]</span></span>
<span id="cb179-176"><a href="#cb179-176" aria-hidden="true" tabindex="-1"></a>                      <span class="op">[</span>current-base-url (build-config-base-url config)<span class="op">]</span>)</span>
<span id="cb179-177"><a href="#cb179-177" aria-hidden="true" tabindex="-1"></a>         (process-all-pages (build-config-source-dir config))))</span>
<span id="cb179-178"><a href="#cb179-178" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-179"><a href="#cb179-179" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Phase 3: Optimization passes</span></span>
<span id="cb179-180"><a href="#cb179-180" aria-hidden="true" tabindex="-1"></a>     (<span class="ex">define</span><span class="fu"> optimized-pages</span></span>
<span id="cb179-181"><a href="#cb179-181" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">if</span> (build-config-minify? config)</span>
<span id="cb179-182"><a href="#cb179-182" aria-hidden="true" tabindex="-1"></a>           (run-optimization-passes pages config)</span>
<span id="cb179-183"><a href="#cb179-183" aria-hidden="true" tabindex="-1"></a>           pages))</span>
<span id="cb179-184"><a href="#cb179-184" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-185"><a href="#cb179-185" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Phase 4: Generate static files</span></span>
<span id="cb179-186"><a href="#cb179-186" aria-hidden="true" tabindex="-1"></a>     (for (<span class="op">[</span>page optimized-pages<span class="op">]</span>)</span>
<span id="cb179-187"><a href="#cb179-187" aria-hidden="true" tabindex="-1"></a>       (write-optimized-page page config))</span>
<span id="cb179-188"><a href="#cb179-188" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-189"><a href="#cb179-189" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Phase 5: Generate auxiliary files</span></span>
<span id="cb179-190"><a href="#cb179-190" aria-hidden="true" tabindex="-1"></a>     (when (build-config-generate-sitemap? config)</span>
<span id="cb179-191"><a href="#cb179-191" aria-hidden="true" tabindex="-1"></a>       (generate-sitemap optimized-pages config))</span>
<span id="cb179-192"><a href="#cb179-192" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-193"><a href="#cb179-193" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Phase 6: Copy static assets</span></span>
<span id="cb179-194"><a href="#cb179-194" aria-hidden="true" tabindex="-1"></a>     (copy-static-assets config)</span>
<span id="cb179-195"><a href="#cb179-195" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-196"><a href="#cb179-196" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Phase 7: Generate deployment files</span></span>
<span id="cb179-197"><a href="#cb179-197" aria-hidden="true" tabindex="-1"></a>     (generate-deployment-files config)</span>
<span id="cb179-198"><a href="#cb179-198" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-199"><a href="#cb179-199" aria-hidden="true" tabindex="-1"></a>     (log-message logger &#39;info </span>
<span id="cb179-200"><a href="#cb179-200" aria-hidden="true" tabindex="-1"></a>                  (format <span class="st">&quot;Build complete: ~a pages generated&quot;</span> </span>
<span id="cb179-201"><a href="#cb179-201" aria-hidden="true" tabindex="-1"></a>                          (<span class="kw">length</span> optimized-pages))))</span>
<span id="cb179-202"><a href="#cb179-202" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb179-203"><a href="#cb179-203" aria-hidden="true" tabindex="-1"></a>   &#39;info</span>
<span id="cb179-204"><a href="#cb179-204" aria-hidden="true" tabindex="-1"></a>   &#39;shrdlu-build))</span>
<span id="cb179-205"><a href="#cb179-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-206"><a href="#cb179-206" aria-hidden="true" tabindex="-1"></a><span class="co">;; Optimization pipeline</span></span>
<span id="cb179-207"><a href="#cb179-207" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(run-optimization-passes pages config)</span>
<span id="cb179-208"><a href="#cb179-208" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> passes</span></span>
<span id="cb179-209"><a href="#cb179-209" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">list</span></span>
<span id="cb179-210"><a href="#cb179-210" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; HTML minification</span></span>
<span id="cb179-211"><a href="#cb179-211" aria-hidden="true" tabindex="-1"></a>     (λ (page)</span>
<span id="cb179-212"><a href="#cb179-212" aria-hidden="true" tabindex="-1"></a>       (struct-copy page page</span>
<span id="cb179-213"><a href="#cb179-213" aria-hidden="true" tabindex="-1"></a>                    <span class="op">[</span>content (minify-html (page-content page))<span class="op">]</span>))</span>
<span id="cb179-214"><a href="#cb179-214" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-215"><a href="#cb179-215" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; CSS optimization</span></span>
<span id="cb179-216"><a href="#cb179-216" aria-hidden="true" tabindex="-1"></a>     (λ (page)</span>
<span id="cb179-217"><a href="#cb179-217" aria-hidden="true" tabindex="-1"></a>       (struct-copy page page</span>
<span id="cb179-218"><a href="#cb179-218" aria-hidden="true" tabindex="-1"></a>                    <span class="op">[</span>styles (optimize-css (page-styles page))<span class="op">]</span>))</span>
<span id="cb179-219"><a href="#cb179-219" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-220"><a href="#cb179-220" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; JavaScript minification</span></span>
<span id="cb179-221"><a href="#cb179-221" aria-hidden="true" tabindex="-1"></a>     (λ (page)</span>
<span id="cb179-222"><a href="#cb179-222" aria-hidden="true" tabindex="-1"></a>       (struct-copy page page</span>
<span id="cb179-223"><a href="#cb179-223" aria-hidden="true" tabindex="-1"></a>                    <span class="op">[</span>scripts (minify-js (page-scripts page))<span class="op">]</span>))</span>
<span id="cb179-224"><a href="#cb179-224" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-225"><a href="#cb179-225" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Image optimization</span></span>
<span id="cb179-226"><a href="#cb179-226" aria-hidden="true" tabindex="-1"></a>     (λ (page)</span>
<span id="cb179-227"><a href="#cb179-227" aria-hidden="true" tabindex="-1"></a>       (struct-copy page page</span>
<span id="cb179-228"><a href="#cb179-228" aria-hidden="true" tabindex="-1"></a>                    <span class="op">[</span>images (optimize-images (page-images page) config)<span class="op">]</span>))</span>
<span id="cb179-229"><a href="#cb179-229" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb179-230"><a href="#cb179-230" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Link validation</span></span>
<span id="cb179-231"><a href="#cb179-231" aria-hidden="true" tabindex="-1"></a>     (λ (page)</span>
<span id="cb179-232"><a href="#cb179-232" aria-hidden="true" tabindex="-1"></a>       (validate-links page pages)</span>
<span id="cb179-233"><a href="#cb179-233" aria-hidden="true" tabindex="-1"></a>       page)))</span>
<span id="cb179-234"><a href="#cb179-234" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb179-235"><a href="#cb179-235" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Apply all passes</span></span>
<span id="cb179-236"><a href="#cb179-236" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[</span>page pages<span class="op">]</span>)</span>
<span id="cb179-237"><a href="#cb179-237" aria-hidden="true" tabindex="-1"></a>    (for/fold (<span class="op">[</span>p page<span class="op">]</span>)</span>
<span id="cb179-238"><a href="#cb179-238" aria-hidden="true" tabindex="-1"></a>              (<span class="op">[</span>pass passes<span class="op">]</span>)</span>
<span id="cb179-239"><a href="#cb179-239" aria-hidden="true" tabindex="-1"></a>      (pass p))))</span>
<span id="cb179-240"><a href="#cb179-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-241"><a href="#cb179-241" aria-hidden="true" tabindex="-1"></a><span class="co">;; Asset optimization</span></span>
<span id="cb179-242"><a href="#cb179-242" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(optimize-images images config)</span>
<span id="cb179-243"><a href="#cb179-243" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[</span>img images<span class="op">]</span>)</span>
<span id="cb179-244"><a href="#cb179-244" aria-hidden="true" tabindex="-1"></a>    (match-define (image-asset path type dimensions) img)</span>
<span id="cb179-245"><a href="#cb179-245" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-246"><a href="#cb179-246" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> optimized-path</span></span>
<span id="cb179-247"><a href="#cb179-247" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">cond</span></span>
<span id="cb179-248"><a href="#cb179-248" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="kw">eq?</span> type &#39;jpeg) </span>
<span id="cb179-249"><a href="#cb179-249" aria-hidden="true" tabindex="-1"></a>         (optimize-jpeg path (build-config-compression-level config))<span class="op">]</span></span>
<span id="cb179-250"><a href="#cb179-250" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="kw">eq?</span> type &#39;png)</span>
<span id="cb179-251"><a href="#cb179-251" aria-hidden="true" tabindex="-1"></a>         (optimize-png path)<span class="op">]</span></span>
<span id="cb179-252"><a href="#cb179-252" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="kw">member</span> type &#39;(svg webp)) </span>
<span id="cb179-253"><a href="#cb179-253" aria-hidden="true" tabindex="-1"></a>         path<span class="op">]</span>  <span class="co">; Already optimized formats</span></span>
<span id="cb179-254"><a href="#cb179-254" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span><span class="kw">else</span> path<span class="op">]</span>))</span>
<span id="cb179-255"><a href="#cb179-255" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-256"><a href="#cb179-256" aria-hidden="true" tabindex="-1"></a>    (image-asset optimized-path type dimensions)))</span>
<span id="cb179-257"><a href="#cb179-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-258"><a href="#cb179-258" aria-hidden="true" tabindex="-1"></a><span class="co">;; Cache busting for static assets</span></span>
<span id="cb179-259"><a href="#cb179-259" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(add-cache-busting-hash file-path config)</span>
<span id="cb179-260"><a href="#cb179-260" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (build-config-cache-bust? config)</span>
<span id="cb179-261"><a href="#cb179-261" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">let*</span> (<span class="op">[</span>content (file-&gt;bytes file-path)<span class="op">]</span></span>
<span id="cb179-262"><a href="#cb179-262" aria-hidden="true" tabindex="-1"></a>             <span class="op">[</span>hash (<span class="kw">substring</span> (sha256 content) <span class="dv">0</span> <span class="dv">8</span>)<span class="op">]</span></span>
<span id="cb179-263"><a href="#cb179-263" aria-hidden="true" tabindex="-1"></a>             <span class="op">[</span>dir (path-only file-path)<span class="op">]</span></span>
<span id="cb179-264"><a href="#cb179-264" aria-hidden="true" tabindex="-1"></a>             <span class="op">[</span>base (path-replace-extension </span>
<span id="cb179-265"><a href="#cb179-265" aria-hidden="true" tabindex="-1"></a>                    (file-name-from-path file-path) </span>
<span id="cb179-266"><a href="#cb179-266" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;&quot;</span>)<span class="op">]</span></span>
<span id="cb179-267"><a href="#cb179-267" aria-hidden="true" tabindex="-1"></a>             <span class="op">[</span>ext (path-get-extension file-path)<span class="op">]</span>)</span>
<span id="cb179-268"><a href="#cb179-268" aria-hidden="true" tabindex="-1"></a>        (build-path dir (format <span class="st">&quot;~a.~a~a&quot;</span> base hash ext)))</span>
<span id="cb179-269"><a href="#cb179-269" aria-hidden="true" tabindex="-1"></a>      file-path))</span></code></pre></div>
<h2 id="github-pages-deployment">GitHub Pages Deployment</h2>
<p>Complete GitHub Pages integration with custom domains:</p>
<div class="sourceCode" id="cb180"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; github-pages-deploy.rkt</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>(require net/http-client</span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>         net/uri-codec</span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>         json</span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;production-build.rkt&quot;</span>)</span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>(provide deploy-to-github-pages</span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>         configure-custom-domain</span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>         github-pages-config)</span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a><span class="co">;; GitHub Pages configuration</span></span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>(struct gh-pages-config</span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a>  (repo-owner</span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a>   repo-name</span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a>   branch</span>
<span id="cb180-18"><a href="#cb180-18" aria-hidden="true" tabindex="-1"></a>   token</span>
<span id="cb180-19"><a href="#cb180-19" aria-hidden="true" tabindex="-1"></a>   custom-domain</span>
<span id="cb180-20"><a href="#cb180-20" aria-hidden="true" tabindex="-1"></a>   force-https?</span>
<span id="cb180-21"><a href="#cb180-21" aria-hidden="true" tabindex="-1"></a>   jekyll-bypass?)</span>
<span id="cb180-22"><a href="#cb180-22" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb180-23"><a href="#cb180-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-24"><a href="#cb180-24" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main deployment function</span></span>
<span id="cb180-25"><a href="#cb180-25" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(deploy-to-github-pages build-config gh-config)</span>
<span id="cb180-26"><a href="#cb180-26" aria-hidden="true" tabindex="-1"></a>  (log-info <span class="st">&quot;Deploying to GitHub Pages...&quot;</span>)</span>
<span id="cb180-27"><a href="#cb180-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-28"><a href="#cb180-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate CNAME file for custom domain</span></span>
<span id="cb180-29"><a href="#cb180-29" aria-hidden="true" tabindex="-1"></a>  (when (gh-pages-config-custom-domain gh-config)</span>
<span id="cb180-30"><a href="#cb180-30" aria-hidden="true" tabindex="-1"></a>    (generate-cname-file build-config gh-config))</span>
<span id="cb180-31"><a href="#cb180-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-32"><a href="#cb180-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add .nojekyll if needed</span></span>
<span id="cb180-33"><a href="#cb180-33" aria-hidden="true" tabindex="-1"></a>  (when (gh-pages-config-jekyll-bypass? gh-config)</span>
<span id="cb180-34"><a href="#cb180-34" aria-hidden="true" tabindex="-1"></a>    (generate-nojekyll-file build-config))</span>
<span id="cb180-35"><a href="#cb180-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-36"><a href="#cb180-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create deployment script</span></span>
<span id="cb180-37"><a href="#cb180-37" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> deploy-script</span></span>
<span id="cb180-38"><a href="#cb180-38" aria-hidden="true" tabindex="-1"></a>    (generate-deploy-script build-config gh-config))</span>
<span id="cb180-39"><a href="#cb180-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-40"><a href="#cb180-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Execute deployment</span></span>
<span id="cb180-41"><a href="#cb180-41" aria-hidden="true" tabindex="-1"></a>  (system* <span class="st">&quot;/bin/sh&quot;</span> <span class="st">&quot;-c&quot;</span> deploy-script)</span>
<span id="cb180-42"><a href="#cb180-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-43"><a href="#cb180-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Verify deployment</span></span>
<span id="cb180-44"><a href="#cb180-44" aria-hidden="true" tabindex="-1"></a>  (verify-deployment gh-config))</span>
<span id="cb180-45"><a href="#cb180-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-46"><a href="#cb180-46" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate CNAME file for custom domain</span></span>
<span id="cb180-47"><a href="#cb180-47" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-cname-file build-config gh-config)</span>
<span id="cb180-48"><a href="#cb180-48" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cname-path </span></span>
<span id="cb180-49"><a href="#cb180-49" aria-hidden="true" tabindex="-1"></a>    (build-path (build-config-output-dir build-config) <span class="st">&quot;CNAME&quot;</span>))</span>
<span id="cb180-50"><a href="#cb180-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-51"><a href="#cb180-51" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">with-output-to-file</span> cname-path</span>
<span id="cb180-52"><a href="#cb180-52" aria-hidden="true" tabindex="-1"></a>    (λ ()</span>
<span id="cb180-53"><a href="#cb180-53" aria-hidden="true" tabindex="-1"></a>      (displayln (gh-pages-config-custom-domain gh-config)))</span>
<span id="cb180-54"><a href="#cb180-54" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;replace)</span>
<span id="cb180-55"><a href="#cb180-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-56"><a href="#cb180-56" aria-hidden="true" tabindex="-1"></a>  (log-info (format <span class="st">&quot;Generated CNAME file for domain: ~a&quot;</span> </span>
<span id="cb180-57"><a href="#cb180-57" aria-hidden="true" tabindex="-1"></a>                    (gh-pages-config-custom-domain gh-config))))</span>
<span id="cb180-58"><a href="#cb180-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-59"><a href="#cb180-59" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate .nojekyll to bypass Jekyll processing</span></span>
<span id="cb180-60"><a href="#cb180-60" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-nojekyll-file build-config)</span>
<span id="cb180-61"><a href="#cb180-61" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> nojekyll-path</span></span>
<span id="cb180-62"><a href="#cb180-62" aria-hidden="true" tabindex="-1"></a>    (build-path (build-config-output-dir build-config) <span class="st">&quot;.nojekyll&quot;</span>))</span>
<span id="cb180-63"><a href="#cb180-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-64"><a href="#cb180-64" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">with-output-to-file</span> nojekyll-path</span>
<span id="cb180-65"><a href="#cb180-65" aria-hidden="true" tabindex="-1"></a>    (λ () (<span class="kw">display</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb180-66"><a href="#cb180-66" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;replace)</span>
<span id="cb180-67"><a href="#cb180-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-68"><a href="#cb180-68" aria-hidden="true" tabindex="-1"></a>  (log-info <span class="st">&quot;Generated .nojekyll file&quot;</span>))</span>
<span id="cb180-69"><a href="#cb180-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-70"><a href="#cb180-70" aria-hidden="true" tabindex="-1"></a><span class="co">;; Generate deployment script</span></span>
<span id="cb180-71"><a href="#cb180-71" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(generate-deploy-script build-config gh-config)</span>
<span id="cb180-72"><a href="#cb180-72" aria-hidden="true" tabindex="-1"></a>  (format <span class="st">#&lt;&lt;SCRIPT</span></span>
<span id="cb180-73"><a href="#cb180-73" aria-hidden="true" tabindex="-1"></a><span class="ot">#!/bin/bash</span></span>
<span id="cb180-74"><a href="#cb180-74" aria-hidden="true" tabindex="-1"></a><span class="ot">set -e</span></span>
<span id="cb180-75"><a href="#cb180-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-76"><a href="#cb180-76" aria-hidden="true" tabindex="-1"></a><span class="ot"># Configuration</span></span>
<span id="cb180-77"><a href="#cb180-77" aria-hidden="true" tabindex="-1"></a><span class="ot">OUTPUT_DIR=</span><span class="st">&quot;~a&quot;</span></span>
<span id="cb180-78"><a href="#cb180-78" aria-hidden="true" tabindex="-1"></a><span class="ot">REPO_URL=</span><span class="st">&quot;https://~a@github.com/~a/~a.git&quot;</span></span>
<span id="cb180-79"><a href="#cb180-79" aria-hidden="true" tabindex="-1"></a><span class="ot">BRANCH=</span><span class="st">&quot;~a&quot;</span></span>
<span id="cb180-80"><a href="#cb180-80" aria-hidden="true" tabindex="-1"></a><span class="ot">COMMIT_MESSAGE=</span><span class="st">&quot;Deploy to GitHub Pages: $(date)&quot;</span></span>
<span id="cb180-81"><a href="#cb180-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-82"><a href="#cb180-82" aria-hidden="true" tabindex="-1"></a><span class="ot"># Create temporary directory</span></span>
<span id="cb180-83"><a href="#cb180-83" aria-hidden="true" tabindex="-1"></a><span class="ot">TEMP_DIR=$(mktemp -d)</span></span>
<span id="cb180-84"><a href="#cb180-84" aria-hidden="true" tabindex="-1"></a><span class="ot">cd &quot;$TEMP_DIR&quot;</span></span>
<span id="cb180-85"><a href="#cb180-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-86"><a href="#cb180-86" aria-hidden="true" tabindex="-1"></a><span class="ot"># Clone the repository</span></span>
<span id="cb180-87"><a href="#cb180-87" aria-hidden="true" tabindex="-1"></a><span class="ot">git clone &quot;$REPO_URL&quot; .</span></span>
<span id="cb180-88"><a href="#cb180-88" aria-hidden="true" tabindex="-1"></a><span class="ot">git checkout &quot;$BRANCH&quot; || git checkout -b &quot;$BRANCH&quot;</span></span>
<span id="cb180-89"><a href="#cb180-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-90"><a href="#cb180-90" aria-hidden="true" tabindex="-1"></a><span class="ot"># Remove old files</span></span>
<span id="cb180-91"><a href="#cb180-91" aria-hidden="true" tabindex="-1"></a><span class="ot">git rm -rf . || true</span></span>
<span id="cb180-92"><a href="#cb180-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-93"><a href="#cb180-93" aria-hidden="true" tabindex="-1"></a><span class="ot"># Copy new files</span></span>
<span id="cb180-94"><a href="#cb180-94" aria-hidden="true" tabindex="-1"></a><span class="ot">cp -r &quot;$OUTPUT_DIR&quot;/* .</span></span>
<span id="cb180-95"><a href="#cb180-95" aria-hidden="true" tabindex="-1"></a><span class="ot">cp -r &quot;$OUTPUT_DIR&quot;/.[^.]* . 2</span><span class="st">&gt;/dev/null || true</span></span>
<span id="cb180-96"><a href="#cb180-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-97"><a href="#cb180-97" aria-hidden="true" tabindex="-1"></a><span class="st"># Commit and push</span></span>
<span id="cb180-98"><a href="#cb180-98" aria-hidden="true" tabindex="-1"></a><span class="st">git add -A</span></span>
<span id="cb180-99"><a href="#cb180-99" aria-hidden="true" tabindex="-1"></a><span class="st">git commit -m &quot;$COMMIT_MESSAGE&quot; || echo &quot;No changes to commit&quot;</span></span>
<span id="cb180-100"><a href="#cb180-100" aria-hidden="true" tabindex="-1"></a><span class="st">git push origin &quot;$BRANCH&quot;</span></span>
<span id="cb180-101"><a href="#cb180-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-102"><a href="#cb180-102" aria-hidden="true" tabindex="-1"></a><span class="st"># Cleanup</span></span>
<span id="cb180-103"><a href="#cb180-103" aria-hidden="true" tabindex="-1"></a><span class="st">cd ..</span></span>
<span id="cb180-104"><a href="#cb180-104" aria-hidden="true" tabindex="-1"></a><span class="st">rm -rf &quot;$TEMP_DIR&quot;</span></span>
<span id="cb180-105"><a href="#cb180-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-106"><a href="#cb180-106" aria-hidden="true" tabindex="-1"></a><span class="st">echo &quot;Deployment complete!&quot;</span></span>
<span id="cb180-107"><a href="#cb180-107" aria-hidden="true" tabindex="-1"></a><span class="st">SCRIPT</span></span>
<span id="cb180-108"><a href="#cb180-108" aria-hidden="true" tabindex="-1"></a><span class="st">          (build-config-output-dir build-config)</span></span>
<span id="cb180-109"><a href="#cb180-109" aria-hidden="true" tabindex="-1"></a><span class="st">          (gh-pages-config-token gh-config)</span></span>
<span id="cb180-110"><a href="#cb180-110" aria-hidden="true" tabindex="-1"></a><span class="st">          (gh-pages-config-repo-owner gh-config)</span></span>
<span id="cb180-111"><a href="#cb180-111" aria-hidden="true" tabindex="-1"></a><span class="st">          (gh-pages-config-repo-name gh-config)</span></span>
<span id="cb180-112"><a href="#cb180-112" aria-hidden="true" tabindex="-1"></a><span class="st">          (gh-pages-config-branch gh-config)))</span></span>
<span id="cb180-113"><a href="#cb180-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-114"><a href="#cb180-114" aria-hidden="true" tabindex="-1"></a><span class="st">;; Configure custom domain with DNS instructions</span></span>
<span id="cb180-115"><a href="#cb180-115" aria-hidden="true" tabindex="-1"></a><span class="st">(define (configure-custom-domain domain gh-config)</span></span>
<span id="cb180-116"><a href="#cb180-116" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;\n=== Custom Domain Configuration ===\n&quot;)</span></span>
<span id="cb180-117"><a href="#cb180-117" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb180-118"><a href="#cb180-118" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln (format &quot;To use ~a with GitHub Pages:\n&quot; domain))</span></span>
<span id="cb180-119"><a href="#cb180-119" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb180-120"><a href="#cb180-120" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;1. Add DNS records to your domain:&quot;)</span></span>
<span id="cb180-121"><a href="#cb180-121" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;   For apex domain (example.com):&quot;)</span></span>
<span id="cb180-122"><a href="#cb180-122" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;   - A record → 185.199.108.153&quot;)</span></span>
<span id="cb180-123"><a href="#cb180-123" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;   - A record → 185.199.109.153&quot;)</span></span>
<span id="cb180-124"><a href="#cb180-124" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;   - A record → 185.199.110.153&quot;)</span></span>
<span id="cb180-125"><a href="#cb180-125" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;   - A record → 185.199.111.153\n&quot;)</span></span>
<span id="cb180-126"><a href="#cb180-126" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb180-127"><a href="#cb180-127" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;   For subdomain (www.example.com):&quot;)</span></span>
<span id="cb180-128"><a href="#cb180-128" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln (format &quot;   - CNAME record → ~a.github.io\n&quot; </span></span>
<span id="cb180-129"><a href="#cb180-129" aria-hidden="true" tabindex="-1"></a><span class="st">                     (gh-pages-config-repo-owner gh-config)))</span></span>
<span id="cb180-130"><a href="#cb180-130" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb180-131"><a href="#cb180-131" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;2. In your GitHub repository settings:&quot;)</span></span>
<span id="cb180-132"><a href="#cb180-132" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;   - Go to Settings → Pages&quot;)</span></span>
<span id="cb180-133"><a href="#cb180-133" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln (format &quot;   - Set custom domain to: ~a&quot; domain))</span></span>
<span id="cb180-134"><a href="#cb180-134" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;   - Enable &#39;Enforce HTTPS&#39; (after DNS propagation)\n&quot;)</span></span>
<span id="cb180-135"><a href="#cb180-135" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb180-136"><a href="#cb180-136" aria-hidden="true" tabindex="-1"></a><span class="st">  (displayln &quot;3. Wait for DNS propagation (up to 48 hours)&quot;))</span></span>
<span id="cb180-137"><a href="#cb180-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-138"><a href="#cb180-138" aria-hidden="true" tabindex="-1"></a><span class="st">;; Deployment verification</span></span>
<span id="cb180-139"><a href="#cb180-139" aria-hidden="true" tabindex="-1"></a><span class="st">(define (verify-deployment gh-config)</span></span>
<span id="cb180-140"><a href="#cb180-140" aria-hidden="true" tabindex="-1"></a><span class="st">  (define base-url</span></span>
<span id="cb180-141"><a href="#cb180-141" aria-hidden="true" tabindex="-1"></a><span class="st">    (if (gh-pages-config-custom-domain gh-config)</span></span>
<span id="cb180-142"><a href="#cb180-142" aria-hidden="true" tabindex="-1"></a><span class="st">        (format &quot;https://~a&quot; (gh-pages-config-custom-domain gh-config))</span></span>
<span id="cb180-143"><a href="#cb180-143" aria-hidden="true" tabindex="-1"></a><span class="st">        (format &quot;https://~a.github.io/~a&quot; </span></span>
<span id="cb180-144"><a href="#cb180-144" aria-hidden="true" tabindex="-1"></a><span class="st">                (gh-pages-config-repo-owner gh-config)</span></span>
<span id="cb180-145"><a href="#cb180-145" aria-hidden="true" tabindex="-1"></a><span class="st">                (gh-pages-config-repo-name gh-config))))</span></span>
<span id="cb180-146"><a href="#cb180-146" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb180-147"><a href="#cb180-147" aria-hidden="true" tabindex="-1"></a><span class="st">  (log-info &quot;Waiting for deployment to complete...&quot;)</span></span>
<span id="cb180-148"><a href="#cb180-148" aria-hidden="true" tabindex="-1"></a><span class="st">  (sleep 10)</span></span>
<span id="cb180-149"><a href="#cb180-149" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb180-150"><a href="#cb180-150" aria-hidden="true" tabindex="-1"></a><span class="st">  (with-handlers ([exn:fail:network? </span></span>
<span id="cb180-151"><a href="#cb180-151" aria-hidden="true" tabindex="-1"></a><span class="st">                   (λ (e) </span></span>
<span id="cb180-152"><a href="#cb180-152" aria-hidden="true" tabindex="-1"></a><span class="st">                     (log-warning &quot;Could not verify deployment&quot;))])</span></span>
<span id="cb180-153"><a href="#cb180-153" aria-hidden="true" tabindex="-1"></a><span class="st">    (define-values (status headers in)</span></span>
<span id="cb180-154"><a href="#cb180-154" aria-hidden="true" tabindex="-1"></a><span class="st">      (http-sendrecv (string-&gt;url base-url) &quot;HEAD&quot;))</span></span>
<span id="cb180-155"><a href="#cb180-155" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb180-156"><a href="#cb180-156" aria-hidden="true" tabindex="-1"></a><span class="st">    (if (= status 200)</span></span>
<span id="cb180-157"><a href="#cb180-157" aria-hidden="true" tabindex="-1"></a><span class="st">        (log-info (format &quot;Site successfully deployed to: ~a&quot; base-url))</span></span>
<span id="cb180-158"><a href="#cb180-158" aria-hidden="true" tabindex="-1"></a><span class="st">        (log-warning (format &quot;Deployment may have failed. Status: ~a&quot; status)))))</span></span>
<span id="cb180-159"><a href="#cb180-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-160"><a href="#cb180-160" aria-hidden="true" tabindex="-1"></a><span class="st">;; GitHub Actions workflow generation</span></span>
<span id="cb180-161"><a href="#cb180-161" aria-hidden="true" tabindex="-1"></a><span class="st">(define (generate-github-actions-workflow config)</span></span>
<span id="cb180-162"><a href="#cb180-162" aria-hidden="true" tabindex="-1"></a><span class="st">  (define workflow-content</span></span>
<span id="cb180-163"><a href="#cb180-163" aria-hidden="true" tabindex="-1"></a><span class="st">    #&lt;&lt;YAML</span></span>
<span id="cb180-164"><a href="#cb180-164" aria-hidden="true" tabindex="-1"></a><span class="ot">name: Deploy to GitHub Pages</span></span>
<span id="cb180-165"><a href="#cb180-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-166"><a href="#cb180-166" aria-hidden="true" tabindex="-1"></a><span class="ot">on:</span></span>
<span id="cb180-167"><a href="#cb180-167" aria-hidden="true" tabindex="-1"></a><span class="ot">  push:</span></span>
<span id="cb180-168"><a href="#cb180-168" aria-hidden="true" tabindex="-1"></a><span class="ot">    branches: [ main ]</span></span>
<span id="cb180-169"><a href="#cb180-169" aria-hidden="true" tabindex="-1"></a><span class="ot">  workflow_dispatch:</span></span>
<span id="cb180-170"><a href="#cb180-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-171"><a href="#cb180-171" aria-hidden="true" tabindex="-1"></a><span class="ot">permissions:</span></span>
<span id="cb180-172"><a href="#cb180-172" aria-hidden="true" tabindex="-1"></a><span class="ot">  contents: read</span></span>
<span id="cb180-173"><a href="#cb180-173" aria-hidden="true" tabindex="-1"></a><span class="ot">  pages: write</span></span>
<span id="cb180-174"><a href="#cb180-174" aria-hidden="true" tabindex="-1"></a><span class="ot">  id-token: write</span></span>
<span id="cb180-175"><a href="#cb180-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-176"><a href="#cb180-176" aria-hidden="true" tabindex="-1"></a><span class="ot">concurrency:</span></span>
<span id="cb180-177"><a href="#cb180-177" aria-hidden="true" tabindex="-1"></a><span class="ot">  group: &quot;pages&quot;</span></span>
<span id="cb180-178"><a href="#cb180-178" aria-hidden="true" tabindex="-1"></a><span class="ot">  cancel-in-progress: false</span></span>
<span id="cb180-179"><a href="#cb180-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-180"><a href="#cb180-180" aria-hidden="true" tabindex="-1"></a><span class="ot">jobs:</span></span>
<span id="cb180-181"><a href="#cb180-181" aria-hidden="true" tabindex="-1"></a><span class="ot">  build:</span></span>
<span id="cb180-182"><a href="#cb180-182" aria-hidden="true" tabindex="-1"></a><span class="ot">    runs-on: ubuntu-latest</span></span>
<span id="cb180-183"><a href="#cb180-183" aria-hidden="true" tabindex="-1"></a><span class="ot">    steps:</span></span>
<span id="cb180-184"><a href="#cb180-184" aria-hidden="true" tabindex="-1"></a><span class="ot">      - name: Checkout</span></span>
<span id="cb180-185"><a href="#cb180-185" aria-hidden="true" tabindex="-1"></a><span class="ot">        uses: actions/checkout@v3</span></span>
<span id="cb180-186"><a href="#cb180-186" aria-hidden="true" tabindex="-1"></a><span class="ot">        </span></span>
<span id="cb180-187"><a href="#cb180-187" aria-hidden="true" tabindex="-1"></a><span class="ot">      - name: Setup Racket</span></span>
<span id="cb180-188"><a href="#cb180-188" aria-hidden="true" tabindex="-1"></a><span class="ot">        uses: Bogdanp/setup-racket@v1.9.1</span></span>
<span id="cb180-189"><a href="#cb180-189" aria-hidden="true" tabindex="-1"></a><span class="ot">        with:</span></span>
<span id="cb180-190"><a href="#cb180-190" aria-hidden="true" tabindex="-1"></a><span class="ot">          version: &#39;8.10&#39;</span></span>
<span id="cb180-191"><a href="#cb180-191" aria-hidden="true" tabindex="-1"></a><span class="ot">          </span></span>
<span id="cb180-192"><a href="#cb180-192" aria-hidden="true" tabindex="-1"></a><span class="ot">      - name: Install Shrdlu</span></span>
<span id="cb180-193"><a href="#cb180-193" aria-hidden="true" tabindex="-1"></a><span class="ot">        run: |</span></span>
<span id="cb180-194"><a href="#cb180-194" aria-hidden="true" tabindex="-1"></a><span class="ot">          raco pkg install --auto ./</span></span>
<span id="cb180-195"><a href="#cb180-195" aria-hidden="true" tabindex="-1"></a><span class="ot">          </span></span>
<span id="cb180-196"><a href="#cb180-196" aria-hidden="true" tabindex="-1"></a><span class="ot">      - name: Build site</span></span>
<span id="cb180-197"><a href="#cb180-197" aria-hidden="true" tabindex="-1"></a><span class="ot">        run: |</span></span>
<span id="cb180-198"><a href="#cb180-198" aria-hidden="true" tabindex="-1"></a><span class="ot">          shrdlu build --production --base-url &quot;https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}&quot;</span></span>
<span id="cb180-199"><a href="#cb180-199" aria-hidden="true" tabindex="-1"></a><span class="ot">          </span></span>
<span id="cb180-200"><a href="#cb180-200" aria-hidden="true" tabindex="-1"></a><span class="ot">      - name: Upload artifact</span></span>
<span id="cb180-201"><a href="#cb180-201" aria-hidden="true" tabindex="-1"></a><span class="ot">        uses: actions/upload-pages-artifact@v2</span></span>
<span id="cb180-202"><a href="#cb180-202" aria-hidden="true" tabindex="-1"></a><span class="ot">        with:</span></span>
<span id="cb180-203"><a href="#cb180-203" aria-hidden="true" tabindex="-1"></a><span class="ot">          path: &#39;_site&#39;</span></span>
<span id="cb180-204"><a href="#cb180-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-205"><a href="#cb180-205" aria-hidden="true" tabindex="-1"></a><span class="ot">  deploy:</span></span>
<span id="cb180-206"><a href="#cb180-206" aria-hidden="true" tabindex="-1"></a><span class="ot">    environment:</span></span>
<span id="cb180-207"><a href="#cb180-207" aria-hidden="true" tabindex="-1"></a><span class="ot">      name: github-pages</span></span>
<span id="cb180-208"><a href="#cb180-208" aria-hidden="true" tabindex="-1"></a><span class="ot">      url: ${{ steps.deployment.outputs.page_url }}</span></span>
<span id="cb180-209"><a href="#cb180-209" aria-hidden="true" tabindex="-1"></a><span class="ot">    runs-on: ubuntu-latest</span></span>
<span id="cb180-210"><a href="#cb180-210" aria-hidden="true" tabindex="-1"></a><span class="ot">    needs: build</span></span>
<span id="cb180-211"><a href="#cb180-211" aria-hidden="true" tabindex="-1"></a><span class="ot">    steps:</span></span>
<span id="cb180-212"><a href="#cb180-212" aria-hidden="true" tabindex="-1"></a><span class="ot">      - name: Deploy to GitHub Pages</span></span>
<span id="cb180-213"><a href="#cb180-213" aria-hidden="true" tabindex="-1"></a><span class="ot">        id: deployment</span></span>
<span id="cb180-214"><a href="#cb180-214" aria-hidden="true" tabindex="-1"></a><span class="ot">        uses: actions/deploy-pages@v2</span></span>
<span id="cb180-215"><a href="#cb180-215" aria-hidden="true" tabindex="-1"></a><span class="ot">YAML</span></span>
<span id="cb180-216"><a href="#cb180-216" aria-hidden="true" tabindex="-1"></a><span class="ot">    )</span></span>
<span id="cb180-217"><a href="#cb180-217" aria-hidden="true" tabindex="-1"></a><span class="ot">  </span></span>
<span id="cb180-218"><a href="#cb180-218" aria-hidden="true" tabindex="-1"></a><span class="ot">  (with-output-to-file &quot;.github/workflows/deploy.yml&quot;</span></span>
<span id="cb180-219"><a href="#cb180-219" aria-hidden="true" tabindex="-1"></a><span class="ot">    (λ () (display workflow-content))</span></span>
<span id="cb180-220"><a href="#cb180-220" aria-hidden="true" tabindex="-1"></a><span class="ot">    #:exists &#39;replace))</span></span></code></pre></div>
<h2 id="performance-optimization-1">Performance Optimization</h2>
<p>Advanced optimization techniques for production deployments:</p>
<div class="sourceCode" id="cb181"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; performance-optimization.rkt</span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>(require racket/async-channel</span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>         racket/place</span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>         ffi/unsafe</span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;core/cache.rkt&quot;</span>)</span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>(provide parallel-build</span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>         incremental-build</span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>         optimize-for-cdn)</span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parallel page processing</span></span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(parallel-build pages num-workers)</span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> work-queue </span>(make-async-channel))</span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> results </span>(make-async-channel))</span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Fill work queue</span></span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>page pages<span class="op">]</span>)</span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a>    (async-channel-put work-queue page))</span>
<span id="cb181-21"><a href="#cb181-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-22"><a href="#cb181-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Signal end of work</span></span>
<span id="cb181-23"><a href="#cb181-23" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[_</span> (in-range num-workers)<span class="op">]</span>)</span>
<span id="cb181-24"><a href="#cb181-24" aria-hidden="true" tabindex="-1"></a>    (async-channel-put work-queue &#39;done))</span>
<span id="cb181-25"><a href="#cb181-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-26"><a href="#cb181-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create worker places</span></span>
<span id="cb181-27"><a href="#cb181-27" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> workers</span></span>
<span id="cb181-28"><a href="#cb181-28" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>id (in-range num-workers)<span class="op">]</span>)</span>
<span id="cb181-29"><a href="#cb181-29" aria-hidden="true" tabindex="-1"></a>      (place ch</span>
<span id="cb181-30"><a href="#cb181-30" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">let</span> loop ()</span>
<span id="cb181-31"><a href="#cb181-31" aria-hidden="true" tabindex="-1"></a>          (match (place-channel-get ch)</span>
<span id="cb181-32"><a href="#cb181-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span>&#39;done (place-channel-put ch &#39;finished)<span class="op">]</span></span>
<span id="cb181-33"><a href="#cb181-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span>page</span>
<span id="cb181-34"><a href="#cb181-34" aria-hidden="true" tabindex="-1"></a>             (<span class="ex">define</span><span class="fu"> processed </span>(process-page-isolated page))</span>
<span id="cb181-35"><a href="#cb181-35" aria-hidden="true" tabindex="-1"></a>             (place-channel-put ch processed)</span>
<span id="cb181-36"><a href="#cb181-36" aria-hidden="true" tabindex="-1"></a>             (loop)<span class="op">]</span>)))))</span>
<span id="cb181-37"><a href="#cb181-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-38"><a href="#cb181-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Distribute work</span></span>
<span id="cb181-39"><a href="#cb181-39" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> </span>(worker-loop worker)</span>
<span id="cb181-40"><a href="#cb181-40" aria-hidden="true" tabindex="-1"></a>    (thread</span>
<span id="cb181-41"><a href="#cb181-41" aria-hidden="true" tabindex="-1"></a>     (λ ()</span>
<span id="cb181-42"><a href="#cb181-42" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">let</span> loop ()</span>
<span id="cb181-43"><a href="#cb181-43" aria-hidden="true" tabindex="-1"></a>         (<span class="ex">define</span><span class="fu"> work </span>(async-channel-get work-queue))</span>
<span id="cb181-44"><a href="#cb181-44" aria-hidden="true" tabindex="-1"></a>         (unless (<span class="kw">eq?</span> work &#39;done)</span>
<span id="cb181-45"><a href="#cb181-45" aria-hidden="true" tabindex="-1"></a>           (place-channel-put worker work)</span>
<span id="cb181-46"><a href="#cb181-46" aria-hidden="true" tabindex="-1"></a>           (<span class="ex">define</span><span class="fu"> result </span>(place-channel-get worker))</span>
<span id="cb181-47"><a href="#cb181-47" aria-hidden="true" tabindex="-1"></a>           (async-channel-put results result)</span>
<span id="cb181-48"><a href="#cb181-48" aria-hidden="true" tabindex="-1"></a>           (loop))</span>
<span id="cb181-49"><a href="#cb181-49" aria-hidden="true" tabindex="-1"></a>         (place-channel-put worker &#39;done)))))</span>
<span id="cb181-50"><a href="#cb181-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-51"><a href="#cb181-51" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Start workers</span></span>
<span id="cb181-52"><a href="#cb181-52" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> worker-threads</span></span>
<span id="cb181-53"><a href="#cb181-53" aria-hidden="true" tabindex="-1"></a>    (map worker-loop workers))</span>
<span id="cb181-54"><a href="#cb181-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-55"><a href="#cb181-55" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Collect results</span></span>
<span id="cb181-56"><a href="#cb181-56" aria-hidden="true" tabindex="-1"></a>  (for/list (<span class="op">[_</span> pages<span class="op">]</span>)</span>
<span id="cb181-57"><a href="#cb181-57" aria-hidden="true" tabindex="-1"></a>    (async-channel-get results)))</span>
<span id="cb181-58"><a href="#cb181-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-59"><a href="#cb181-59" aria-hidden="true" tabindex="-1"></a><span class="co">;; Incremental build system</span></span>
<span id="cb181-60"><a href="#cb181-60" aria-hidden="true" tabindex="-1"></a>(struct build-state</span>
<span id="cb181-61"><a href="#cb181-61" aria-hidden="true" tabindex="-1"></a>  (file-hashes</span>
<span id="cb181-62"><a href="#cb181-62" aria-hidden="true" tabindex="-1"></a>   dependency-graph</span>
<span id="cb181-63"><a href="#cb181-63" aria-hidden="true" tabindex="-1"></a>   output-cache)</span>
<span id="cb181-64"><a href="#cb181-64" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb181-65"><a href="#cb181-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-66"><a href="#cb181-66" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(incremental-build source-dir previous-state)</span>
<span id="cb181-67"><a href="#cb181-67" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> current-state</span></span>
<span id="cb181-68"><a href="#cb181-68" aria-hidden="true" tabindex="-1"></a>    (scan-source-directory source-dir))</span>
<span id="cb181-69"><a href="#cb181-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-70"><a href="#cb181-70" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> changed-files</span></span>
<span id="cb181-71"><a href="#cb181-71" aria-hidden="true" tabindex="-1"></a>    (find-changed-files previous-state current-state))</span>
<span id="cb181-72"><a href="#cb181-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-73"><a href="#cb181-73" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> affected-pages</span></span>
<span id="cb181-74"><a href="#cb181-74" aria-hidden="true" tabindex="-1"></a>    (compute-affected-pages changed-files </span>
<span id="cb181-75"><a href="#cb181-75" aria-hidden="true" tabindex="-1"></a>                           (build-state-dependency-graph current-state)))</span>
<span id="cb181-76"><a href="#cb181-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-77"><a href="#cb181-77" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Only rebuild affected pages</span></span>
<span id="cb181-78"><a href="#cb181-78" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> updated-pages</span></span>
<span id="cb181-79"><a href="#cb181-79" aria-hidden="true" tabindex="-1"></a>    (parallel-build affected-pages (processor-count)))</span>
<span id="cb181-80"><a href="#cb181-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-81"><a href="#cb181-81" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Merge with cached pages</span></span>
<span id="cb181-82"><a href="#cb181-82" aria-hidden="true" tabindex="-1"></a>  (merge-build-results </span>
<span id="cb181-83"><a href="#cb181-83" aria-hidden="true" tabindex="-1"></a>   updated-pages</span>
<span id="cb181-84"><a href="#cb181-84" aria-hidden="true" tabindex="-1"></a>   (build-state-output-cache previous-state)</span>
<span id="cb181-85"><a href="#cb181-85" aria-hidden="true" tabindex="-1"></a>   current-state))</span>
<span id="cb181-86"><a href="#cb181-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-87"><a href="#cb181-87" aria-hidden="true" tabindex="-1"></a><span class="co">;; CDN optimization</span></span>
<span id="cb181-88"><a href="#cb181-88" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(optimize-for-cdn build-config)</span>
<span id="cb181-89"><a href="#cb181-89" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cdn-config</span></span>
<span id="cb181-90"><a href="#cb181-90" aria-hidden="true" tabindex="-1"></a>    (hash &#39;cloudflare (hash &#39;cache-control <span class="st">&quot;public, max-age=31536000&quot;</span></span>
<span id="cb181-91"><a href="#cb181-91" aria-hidden="true" tabindex="-1"></a>                           &#39;compression &#39;brotli</span>
<span id="cb181-92"><a href="#cb181-92" aria-hidden="true" tabindex="-1"></a>                           &#39;minify <span class="dv">#t</span>)</span>
<span id="cb181-93"><a href="#cb181-93" aria-hidden="true" tabindex="-1"></a>          &#39;netlify (hash &#39;headers <span class="st">&quot;/*.js Cache-Control: max-age=31536000&quot;</span></span>
<span id="cb181-94"><a href="#cb181-94" aria-hidden="true" tabindex="-1"></a>                        &#39;redirects <span class="dv">#t</span></span>
<span id="cb181-95"><a href="#cb181-95" aria-hidden="true" tabindex="-1"></a>                        &#39;functions <span class="dv">#t</span>)</span>
<span id="cb181-96"><a href="#cb181-96" aria-hidden="true" tabindex="-1"></a>          &#39;vercel (hash &#39;regions &#39;(<span class="st">&quot;iad1&quot;</span> <span class="st">&quot;sfo1&quot;</span>)</span>
<span id="cb181-97"><a href="#cb181-97" aria-hidden="true" tabindex="-1"></a>                       &#39;functions-config <span class="st">&quot;vercel.json&quot;</span>)))</span>
<span id="cb181-98"><a href="#cb181-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-99"><a href="#cb181-99" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate CDN-specific configuration</span></span>
<span id="cb181-100"><a href="#cb181-100" aria-hidden="true" tabindex="-1"></a>  (match (build-config-cdn-provider build-config)</span>
<span id="cb181-101"><a href="#cb181-101" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;cloudflare</span>
<span id="cb181-102"><a href="#cb181-102" aria-hidden="true" tabindex="-1"></a>     (generate-cloudflare-config build-config)<span class="op">]</span></span>
<span id="cb181-103"><a href="#cb181-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;netlify</span>
<span id="cb181-104"><a href="#cb181-104" aria-hidden="true" tabindex="-1"></a>     (generate-netlify-toml build-config)<span class="op">]</span></span>
<span id="cb181-105"><a href="#cb181-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;vercel</span>
<span id="cb181-106"><a href="#cb181-106" aria-hidden="true" tabindex="-1"></a>     (generate-vercel-json build-config)<span class="op">]</span></span>
<span id="cb181-107"><a href="#cb181-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">[_</span> (void)<span class="op">]</span>))</span>
<span id="cb181-108"><a href="#cb181-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-109"><a href="#cb181-109" aria-hidden="true" tabindex="-1"></a><span class="co">;; Resource hints and preloading</span></span>
<span id="cb181-110"><a href="#cb181-110" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(add-resource-hints page critical-resources)</span>
<span id="cb181-111"><a href="#cb181-111" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> hints</span></span>
<span id="cb181-112"><a href="#cb181-112" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>resource critical-resources<span class="op">]</span>)</span>
<span id="cb181-113"><a href="#cb181-113" aria-hidden="true" tabindex="-1"></a>      (match resource</span>
<span id="cb181-114"><a href="#cb181-114" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="kw">list</span> &#39;font url)</span>
<span id="cb181-115"><a href="#cb181-115" aria-hidden="true" tabindex="-1"></a>         `(link (<span class="op">[</span>rel <span class="st">&quot;preload&quot;</span><span class="op">]</span></span>
<span id="cb181-116"><a href="#cb181-116" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>href ,url<span class="op">]</span></span>
<span id="cb181-117"><a href="#cb181-117" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>as <span class="st">&quot;font&quot;</span><span class="op">]</span></span>
<span id="cb181-118"><a href="#cb181-118" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>type <span class="st">&quot;font/woff2&quot;</span><span class="op">]</span></span>
<span id="cb181-119"><a href="#cb181-119" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>crossorigin <span class="st">&quot;&quot;</span><span class="op">]</span>))<span class="op">]</span></span>
<span id="cb181-120"><a href="#cb181-120" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="kw">list</span> &#39;style url)</span>
<span id="cb181-121"><a href="#cb181-121" aria-hidden="true" tabindex="-1"></a>         `(link (<span class="op">[</span>rel <span class="st">&quot;preload&quot;</span><span class="op">]</span></span>
<span id="cb181-122"><a href="#cb181-122" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>href ,url<span class="op">]</span></span>
<span id="cb181-123"><a href="#cb181-123" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>as <span class="st">&quot;style&quot;</span><span class="op">]</span>))<span class="op">]</span></span>
<span id="cb181-124"><a href="#cb181-124" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="kw">list</span> &#39;script url)</span>
<span id="cb181-125"><a href="#cb181-125" aria-hidden="true" tabindex="-1"></a>         `(link (<span class="op">[</span>rel <span class="st">&quot;preload&quot;</span><span class="op">]</span></span>
<span id="cb181-126"><a href="#cb181-126" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>href ,url<span class="op">]</span></span>
<span id="cb181-127"><a href="#cb181-127" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>as <span class="st">&quot;script&quot;</span><span class="op">]</span>))<span class="op">]</span></span>
<span id="cb181-128"><a href="#cb181-128" aria-hidden="true" tabindex="-1"></a>        <span class="op">[</span>(<span class="kw">list</span> &#39;image url)</span>
<span id="cb181-129"><a href="#cb181-129" aria-hidden="true" tabindex="-1"></a>         `(link (<span class="op">[</span>rel <span class="st">&quot;prefetch&quot;</span><span class="op">]</span></span>
<span id="cb181-130"><a href="#cb181-130" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>href ,url<span class="op">]</span></span>
<span id="cb181-131"><a href="#cb181-131" aria-hidden="true" tabindex="-1"></a>                 <span class="op">[</span>as <span class="st">&quot;image&quot;</span><span class="op">]</span>))<span class="op">]</span>)))</span>
<span id="cb181-132"><a href="#cb181-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb181-133"><a href="#cb181-133" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Inject hints into page head</span></span>
<span id="cb181-134"><a href="#cb181-134" aria-hidden="true" tabindex="-1"></a>  (update-page-head page hints))</span></code></pre></div>
<h2 id="monitoring-and-analytics">Monitoring and Analytics</h2>
<p>Production monitoring and analytics integration:</p>
<div class="sourceCode" id="cb182"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; monitoring.rkt</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>(require net/http-client</span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>         json)</span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a>(provide setup-monitoring</span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>         analytics-integration</span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a>         error-tracking)</span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Error tracking integration</span></span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(setup-error-tracking config)</span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tracking-script</span></span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a>    (match (hash-ref config &#39;error-tracking-provider <span class="dv">#f</span>)</span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>&#39;sentry</span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a>       (format <span class="st">#&lt;&lt;SCRIPT</span></span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;script</span></span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a><span class="ot">  src=</span><span class="st">&quot;https://browser.sentry-cdn.com/7.0.0/bundle.min.js&quot;</span></span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a><span class="ot">  integrity=</span><span class="st">&quot;sha384-...&quot;</span></span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a><span class="ot">  crossorigin=</span><span class="st">&quot;anonymous&quot;&gt;&lt;/script&gt;</span></span>
<span id="cb182-21"><a href="#cb182-21" aria-hidden="true" tabindex="-1"></a>&lt;script&gt;</span>
<span id="cb182-22"><a href="#cb182-22" aria-hidden="true" tabindex="-1"></a>  Sentry.init(<span class="op">{</span></span>
<span id="cb182-23"><a href="#cb182-23" aria-hidden="true" tabindex="-1"></a>    dsn: <span class="st">&quot;~a&quot;</span>,</span>
<span id="cb182-24"><a href="#cb182-24" aria-hidden="true" tabindex="-1"></a>    environment: <span class="st">&quot;~a&quot;</span>,</span>
<span id="cb182-25"><a href="#cb182-25" aria-hidden="true" tabindex="-1"></a>    integrations: <span class="op">[</span></span>
<span id="cb182-26"><a href="#cb182-26" aria-hidden="true" tabindex="-1"></a>      new Sentry.BrowserTracing(),</span>
<span id="cb182-27"><a href="#cb182-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">]</span>,</span>
<span id="cb182-28"><a href="#cb182-28" aria-hidden="true" tabindex="-1"></a>    tracesSampleRate: ~a,</span>
<span id="cb182-29"><a href="#cb182-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>)<span class="co">;</span></span>
<span id="cb182-30"><a href="#cb182-30" aria-hidden="true" tabindex="-1"></a>&lt;/script&gt;</span>
<span id="cb182-31"><a href="#cb182-31" aria-hidden="true" tabindex="-1"></a>SCRIPT</span>
<span id="cb182-32"><a href="#cb182-32" aria-hidden="true" tabindex="-1"></a>               (hash-ref config &#39;sentry-dsn)</span>
<span id="cb182-33"><a href="#cb182-33" aria-hidden="true" tabindex="-1"></a>               (hash-ref config &#39;environment <span class="st">&quot;production&quot;</span>)</span>
<span id="cb182-34"><a href="#cb182-34" aria-hidden="true" tabindex="-1"></a>               (hash-ref config &#39;traces-sample-rate <span class="fl">0.1</span>))<span class="op">]</span></span>
<span id="cb182-35"><a href="#cb182-35" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb182-36"><a href="#cb182-36" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>&#39;bugsnag</span>
<span id="cb182-37"><a href="#cb182-37" aria-hidden="true" tabindex="-1"></a>       (format <span class="st">#&lt;&lt;SCRIPT</span></span>
<span id="cb182-38"><a href="#cb182-38" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;script src=</span><span class="st">&quot;https://d2wy8f7a9ursnm.cloudfront.net/v7/bugsnag.min.js&quot;&gt;&lt;/script&gt;</span></span>
<span id="cb182-39"><a href="#cb182-39" aria-hidden="true" tabindex="-1"></a>&lt;script&gt;</span>
<span id="cb182-40"><a href="#cb182-40" aria-hidden="true" tabindex="-1"></a>  Bugsnag.start(<span class="op">{</span> </span>
<span id="cb182-41"><a href="#cb182-41" aria-hidden="true" tabindex="-1"></a>    apiKey: &#39;~a&#39;,</span>
<span id="cb182-42"><a href="#cb182-42" aria-hidden="true" tabindex="-1"></a>    releaseStage: &#39;~a&#39;</span>
<span id="cb182-43"><a href="#cb182-43" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>)<span class="co">;</span></span>
<span id="cb182-44"><a href="#cb182-44" aria-hidden="true" tabindex="-1"></a>&lt;/script&gt;</span>
<span id="cb182-45"><a href="#cb182-45" aria-hidden="true" tabindex="-1"></a>SCRIPT</span>
<span id="cb182-46"><a href="#cb182-46" aria-hidden="true" tabindex="-1"></a>               (hash-ref config &#39;bugsnag-api-key)</span>
<span id="cb182-47"><a href="#cb182-47" aria-hidden="true" tabindex="-1"></a>               (hash-ref config &#39;environment <span class="st">&quot;production&quot;</span>))<span class="op">]</span></span>
<span id="cb182-48"><a href="#cb182-48" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb182-49"><a href="#cb182-49" aria-hidden="true" tabindex="-1"></a>      <span class="op">[_</span> <span class="st">&quot;&quot;</span><span class="op">]</span>))</span>
<span id="cb182-50"><a href="#cb182-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb182-51"><a href="#cb182-51" aria-hidden="true" tabindex="-1"></a>  tracking-script)</span>
<span id="cb182-52"><a href="#cb182-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-53"><a href="#cb182-53" aria-hidden="true" tabindex="-1"></a><span class="co">;; Analytics setup</span></span>
<span id="cb182-54"><a href="#cb182-54" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(analytics-integration config)</span>
<span id="cb182-55"><a href="#cb182-55" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> analytics-scripts</span></span>
<span id="cb182-56"><a href="#cb182-56" aria-hidden="true" tabindex="-1"></a>    (filter-map</span>
<span id="cb182-57"><a href="#cb182-57" aria-hidden="true" tabindex="-1"></a>     (λ (provider)</span>
<span id="cb182-58"><a href="#cb182-58" aria-hidden="true" tabindex="-1"></a>       (match provider</span>
<span id="cb182-59"><a href="#cb182-59" aria-hidden="true" tabindex="-1"></a>         <span class="op">[</span>`(google-analytics ,id)</span>
<span id="cb182-60"><a href="#cb182-60" aria-hidden="true" tabindex="-1"></a>          (format <span class="st">#&lt;&lt;SCRIPT</span></span>
<span id="cb182-61"><a href="#cb182-61" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;!-- Google Analytics --</span><span class="st">&gt;</span></span>
<span id="cb182-62"><a href="#cb182-62" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;script</span><span class="ot"> async src=</span><span class="st">&quot;https://www.googletagmanager.com/gtag/js?id=~a&quot;&gt;&lt;/script&gt;</span></span>
<span id="cb182-63"><a href="#cb182-63" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;script&gt;</span></span>
<span id="cb182-64"><a href="#cb182-64" aria-hidden="true" tabindex="-1"></a><span class="st">  window.dataLayer = window.dataLayer || [];</span></span>
<span id="cb182-65"><a href="#cb182-65" aria-hidden="true" tabindex="-1"></a><span class="st">  function gtag(){dataLayer.push(arguments);}</span></span>
<span id="cb182-66"><a href="#cb182-66" aria-hidden="true" tabindex="-1"></a><span class="st">  gtag(&#39;js&#39;, new Date());</span></span>
<span id="cb182-67"><a href="#cb182-67" aria-hidden="true" tabindex="-1"></a><span class="st">  gtag(&#39;config&#39;, &#39;~a&#39;);</span></span>
<span id="cb182-68"><a href="#cb182-68" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/script&gt;</span></span>
<span id="cb182-69"><a href="#cb182-69" aria-hidden="true" tabindex="-1"></a><span class="st">SCRIPT</span></span>
<span id="cb182-70"><a href="#cb182-70" aria-hidden="true" tabindex="-1"></a><span class="st">                  id id)]</span></span>
<span id="cb182-71"><a href="#cb182-71" aria-hidden="true" tabindex="-1"></a><span class="st">         </span></span>
<span id="cb182-72"><a href="#cb182-72" aria-hidden="true" tabindex="-1"></a><span class="st">         [`(plausible ,domain)</span></span>
<span id="cb182-73"><a href="#cb182-73" aria-hidden="true" tabindex="-1"></a><span class="st">          (format #&lt;&lt;SCRIPT</span></span>
<span id="cb182-74"><a href="#cb182-74" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;!-- Plausible Analytics --</span><span class="st">&gt;</span></span>
<span id="cb182-75"><a href="#cb182-75" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;script</span><span class="ot"> defer data-domain=</span><span class="st">&quot;~a&quot;</span><span class="ot"> src=</span><span class="st">&quot;https://plausible.io/js/plausible.js&quot;&gt;&lt;/script&gt;</span></span>
<span id="cb182-76"><a href="#cb182-76" aria-hidden="true" tabindex="-1"></a><span class="st">SCRIPT</span></span>
<span id="cb182-77"><a href="#cb182-77" aria-hidden="true" tabindex="-1"></a><span class="st">                  domain)]</span></span>
<span id="cb182-78"><a href="#cb182-78" aria-hidden="true" tabindex="-1"></a><span class="st">         </span></span>
<span id="cb182-79"><a href="#cb182-79" aria-hidden="true" tabindex="-1"></a><span class="st">         [`(matomo ,url ,site-id)</span></span>
<span id="cb182-80"><a href="#cb182-80" aria-hidden="true" tabindex="-1"></a><span class="st">          (format #&lt;&lt;SCRIPT</span></span>
<span id="cb182-81"><a href="#cb182-81" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;!-- Matomo --</span><span class="st">&gt;</span></span>
<span id="cb182-82"><a href="#cb182-82" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;script&gt;</span></span>
<span id="cb182-83"><a href="#cb182-83" aria-hidden="true" tabindex="-1"></a><span class="st">  var _paq = window._paq = window._paq || [];</span></span>
<span id="cb182-84"><a href="#cb182-84" aria-hidden="true" tabindex="-1"></a><span class="st">  _paq.push([&#39;trackPageView&#39;]);</span></span>
<span id="cb182-85"><a href="#cb182-85" aria-hidden="true" tabindex="-1"></a><span class="st">  _paq.push([&#39;enableLinkTracking&#39;]);</span></span>
<span id="cb182-86"><a href="#cb182-86" aria-hidden="true" tabindex="-1"></a><span class="st">  (function() {</span></span>
<span id="cb182-87"><a href="#cb182-87" aria-hidden="true" tabindex="-1"></a><span class="st">    var u=&quot;~a/&quot;;</span></span>
<span id="cb182-88"><a href="#cb182-88" aria-hidden="true" tabindex="-1"></a><span class="st">    _paq.push([&#39;setTrackerUrl&#39;, u+&#39;matomo.php&#39;]);</span></span>
<span id="cb182-89"><a href="#cb182-89" aria-hidden="true" tabindex="-1"></a><span class="st">    _paq.push([&#39;setSiteId&#39;, &#39;~a&#39;]);</span></span>
<span id="cb182-90"><a href="#cb182-90" aria-hidden="true" tabindex="-1"></a><span class="st">    var d=document, g=d.createElement(&#39;script&#39;), s=d.getElementsByTagName(&#39;script&#39;)[0];</span></span>
<span id="cb182-91"><a href="#cb182-91" aria-hidden="true" tabindex="-1"></a><span class="st">    g.async=true; g.src=u+&#39;matomo.js&#39;; s.parentNode.insertBefore(g,s);</span></span>
<span id="cb182-92"><a href="#cb182-92" aria-hidden="true" tabindex="-1"></a><span class="st">  })();</span></span>
<span id="cb182-93"><a href="#cb182-93" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/script&gt;</span></span>
<span id="cb182-94"><a href="#cb182-94" aria-hidden="true" tabindex="-1"></a><span class="st">SCRIPT</span></span>
<span id="cb182-95"><a href="#cb182-95" aria-hidden="true" tabindex="-1"></a><span class="st">                  url site-id)]</span></span>
<span id="cb182-96"><a href="#cb182-96" aria-hidden="true" tabindex="-1"></a><span class="st">         </span></span>
<span id="cb182-97"><a href="#cb182-97" aria-hidden="true" tabindex="-1"></a><span class="st">         [_ #f]))</span></span>
<span id="cb182-98"><a href="#cb182-98" aria-hidden="true" tabindex="-1"></a><span class="st">     </span></span>
<span id="cb182-99"><a href="#cb182-99" aria-hidden="true" tabindex="-1"></a><span class="st">     (hash-ref config &#39;analytics-providers &#39;())))</span></span>
<span id="cb182-100"><a href="#cb182-100" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb182-101"><a href="#cb182-101" aria-hidden="true" tabindex="-1"></a><span class="st">  (string-join analytics-scripts &quot;\n&quot;))</span></span>
<span id="cb182-102"><a href="#cb182-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-103"><a href="#cb182-103" aria-hidden="true" tabindex="-1"></a><span class="st">;; Performance monitoring</span></span>
<span id="cb182-104"><a href="#cb182-104" aria-hidden="true" tabindex="-1"></a><span class="st">(define (add-performance-monitoring config)</span></span>
<span id="cb182-105"><a href="#cb182-105" aria-hidden="true" tabindex="-1"></a><span class="st">  #&lt;&lt;SCRIPT</span></span>
<span id="cb182-106"><a href="#cb182-106" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;script</span><span class="st">&gt;</span></span>
<span id="cb182-107"><a href="#cb182-107" aria-hidden="true" tabindex="-1"></a><span class="st">// Web Vitals monitoring</span></span>
<span id="cb182-108"><a href="#cb182-108" aria-hidden="true" tabindex="-1"></a><span class="st">function sendToAnalytics({name, value, rating, delta}) {</span></span>
<span id="cb182-109"><a href="#cb182-109" aria-hidden="true" tabindex="-1"></a><span class="st">  // Send to your analytics provider</span></span>
<span id="cb182-110"><a href="#cb182-110" aria-hidden="true" tabindex="-1"></a><span class="st">  if (window.gtag) {</span></span>
<span id="cb182-111"><a href="#cb182-111" aria-hidden="true" tabindex="-1"></a><span class="st">    gtag(&#39;event&#39;, name, {</span></span>
<span id="cb182-112"><a href="#cb182-112" aria-hidden="true" tabindex="-1"></a><span class="st">      value: Math.round(name === &#39;CLS&#39; ? delta * 1000 : delta),</span></span>
<span id="cb182-113"><a href="#cb182-113" aria-hidden="true" tabindex="-1"></a><span class="st">      event_category: &#39;Web Vitals&#39;,</span></span>
<span id="cb182-114"><a href="#cb182-114" aria-hidden="true" tabindex="-1"></a><span class="st">      event_label: rating,</span></span>
<span id="cb182-115"><a href="#cb182-115" aria-hidden="true" tabindex="-1"></a><span class="st">      non_interaction: true,</span></span>
<span id="cb182-116"><a href="#cb182-116" aria-hidden="true" tabindex="-1"></a><span class="st">    });</span></span>
<span id="cb182-117"><a href="#cb182-117" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb182-118"><a href="#cb182-118" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb182-119"><a href="#cb182-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-120"><a href="#cb182-120" aria-hidden="true" tabindex="-1"></a><span class="st">// Observe all Web Vitals</span></span>
<span id="cb182-121"><a href="#cb182-121" aria-hidden="true" tabindex="-1"></a><span class="st">if (&#39;PerformanceObserver&#39; in window) {</span></span>
<span id="cb182-122"><a href="#cb182-122" aria-hidden="true" tabindex="-1"></a><span class="st">  try {</span></span>
<span id="cb182-123"><a href="#cb182-123" aria-hidden="true" tabindex="-1"></a><span class="st">    const po = new PerformanceObserver((list) =&gt; {</span></span>
<span id="cb182-124"><a href="#cb182-124" aria-hidden="true" tabindex="-1"></a><span class="st">      for (const entry of list.getEntries()) {</span></span>
<span id="cb182-125"><a href="#cb182-125" aria-hidden="true" tabindex="-1"></a><span class="st">        sendToAnalytics(entry);</span></span>
<span id="cb182-126"><a href="#cb182-126" aria-hidden="true" tabindex="-1"></a><span class="st">      }</span></span>
<span id="cb182-127"><a href="#cb182-127" aria-hidden="true" tabindex="-1"></a><span class="st">    });</span></span>
<span id="cb182-128"><a href="#cb182-128" aria-hidden="true" tabindex="-1"></a><span class="st">    po.observe({entryTypes: [&#39;layout-shift&#39;, &#39;largest-contentful-paint&#39;, </span></span>
<span id="cb182-129"><a href="#cb182-129" aria-hidden="true" tabindex="-1"></a><span class="st">                            &#39;first-input&#39;, &#39;navigation&#39;]});</span></span>
<span id="cb182-130"><a href="#cb182-130" aria-hidden="true" tabindex="-1"></a><span class="st">  } catch (e) {</span></span>
<span id="cb182-131"><a href="#cb182-131" aria-hidden="true" tabindex="-1"></a><span class="st">    console.error(&#39;Performance monitoring error:&#39;, e);</span></span>
<span id="cb182-132"><a href="#cb182-132" aria-hidden="true" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb182-133"><a href="#cb182-133" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb182-134"><a href="#cb182-134" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/script&gt;</span></span>
<span id="cb182-135"><a href="#cb182-135" aria-hidden="true" tabindex="-1"></a><span class="st">SCRIPT</span></span>
<span id="cb182-136"><a href="#cb182-136" aria-hidden="true" tabindex="-1"></a><span class="st">  )</span></span>
<span id="cb182-137"><a href="#cb182-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-138"><a href="#cb182-138" aria-hidden="true" tabindex="-1"></a><span class="st">;; Health check endpoint generation</span></span>
<span id="cb182-139"><a href="#cb182-139" aria-hidden="true" tabindex="-1"></a><span class="st">(define (generate-health-check config)</span></span>
<span id="cb182-140"><a href="#cb182-140" aria-hidden="true" tabindex="-1"></a><span class="st">  (with-output-to-file </span></span>
<span id="cb182-141"><a href="#cb182-141" aria-hidden="true" tabindex="-1"></a><span class="st">    (build-path (hash-ref config &#39;output-dir) &quot;health.json&quot;)</span></span>
<span id="cb182-142"><a href="#cb182-142" aria-hidden="true" tabindex="-1"></a><span class="st">    (λ ()</span></span>
<span id="cb182-143"><a href="#cb182-143" aria-hidden="true" tabindex="-1"></a><span class="st">      (write-json</span></span>
<span id="cb182-144"><a href="#cb182-144" aria-hidden="true" tabindex="-1"></a><span class="st">       (hash &#39;status &quot;ok&quot;</span></span>
<span id="cb182-145"><a href="#cb182-145" aria-hidden="true" tabindex="-1"></a><span class="st">             &#39;timestamp (current-seconds)</span></span>
<span id="cb182-146"><a href="#cb182-146" aria-hidden="true" tabindex="-1"></a><span class="st">             &#39;version (hash-ref config &#39;version &quot;unknown&quot;)</span></span>
<span id="cb182-147"><a href="#cb182-147" aria-hidden="true" tabindex="-1"></a><span class="st">             &#39;build-time (hash-ref config &#39;build-timestamp)</span></span>
<span id="cb182-148"><a href="#cb182-148" aria-hidden="true" tabindex="-1"></a><span class="st">             &#39;git-commit (hash-ref config &#39;git-commit &quot;unknown&quot;))))</span></span>
<span id="cb182-149"><a href="#cb182-149" aria-hidden="true" tabindex="-1"></a><span class="st">    #:exists &#39;replace))</span></span></code></pre></div>
<h2 id="cli-and-automation">CLI and Automation</h2>
<p>Production-ready command-line interface:</p>
<div class="sourceCode" id="cb183"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; cli-production.rkt</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>(require racket/cmdline</span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;production-build.rkt&quot;</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;github-pages-deploy.rkt&quot;</span></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;monitoring.rkt&quot;</span>)</span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>(provide main)</span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(main)</span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> build-config </span>(make-parameter <span class="dv">#f</span>))</span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> deploy-target </span>(make-parameter <span class="dv">#f</span>))</span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> custom-domain </span>(make-parameter <span class="dv">#f</span>))</span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a>  (command-line</span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a>   #:program <span class="st">&quot;shrdlu&quot;</span></span>
<span id="cb183-18"><a href="#cb183-18" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-19"><a href="#cb183-19" aria-hidden="true" tabindex="-1"></a>   #:multi</span>
<span id="cb183-20"><a href="#cb183-20" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;-c&quot;</span> <span class="st">&quot;--config&quot;</span>) file</span>
<span id="cb183-21"><a href="#cb183-21" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;Configuration file&quot;</span></span>
<span id="cb183-22"><a href="#cb183-22" aria-hidden="true" tabindex="-1"></a>                      (build-config (load-config file))<span class="op">]</span></span>
<span id="cb183-23"><a href="#cb183-23" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-24"><a href="#cb183-24" aria-hidden="true" tabindex="-1"></a>   #:once-each</span>
<span id="cb183-25"><a href="#cb183-25" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;-o&quot;</span> <span class="st">&quot;--output&quot;</span>) dir</span>
<span id="cb183-26"><a href="#cb183-26" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot;Output directory&quot;</span></span>
<span id="cb183-27"><a href="#cb183-27" aria-hidden="true" tabindex="-1"></a>                      (update-config! &#39;output-dir dir)<span class="op">]</span></span>
<span id="cb183-28"><a href="#cb183-28" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-29"><a href="#cb183-29" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;--base-url&quot;</span>) url</span>
<span id="cb183-30"><a href="#cb183-30" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;Base URL for the site&quot;</span></span>
<span id="cb183-31"><a href="#cb183-31" aria-hidden="true" tabindex="-1"></a>                   (update-config! &#39;base-url url)<span class="op">]</span></span>
<span id="cb183-32"><a href="#cb183-32" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-33"><a href="#cb183-33" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;--custom-domain&quot;</span>) domain</span>
<span id="cb183-34"><a href="#cb183-34" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;Custom domain for GitHub Pages&quot;</span></span>
<span id="cb183-35"><a href="#cb183-35" aria-hidden="true" tabindex="-1"></a>                        (custom-domain domain)<span class="op">]</span></span>
<span id="cb183-36"><a href="#cb183-36" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-37"><a href="#cb183-37" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;-j&quot;</span> <span class="st">&quot;--jobs&quot;</span>) n</span>
<span id="cb183-38"><a href="#cb183-38" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;Number of parallel jobs&quot;</span></span>
<span id="cb183-39"><a href="#cb183-39" aria-hidden="true" tabindex="-1"></a>                    (update-config! &#39;num-workers (<span class="kw">string-&gt;number</span> n))<span class="op">]</span></span>
<span id="cb183-40"><a href="#cb183-40" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-41"><a href="#cb183-41" aria-hidden="true" tabindex="-1"></a>   #:once-any</span>
<span id="cb183-42"><a href="#cb183-42" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;--production&quot;</span>)</span>
<span id="cb183-43"><a href="#cb183-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Production build with all optimizations&quot;</span></span>
<span id="cb183-44"><a href="#cb183-44" aria-hidden="true" tabindex="-1"></a>    (set-production-mode!)<span class="op">]</span></span>
<span id="cb183-45"><a href="#cb183-45" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-46"><a href="#cb183-46" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;--development&quot;</span>)</span>
<span id="cb183-47"><a href="#cb183-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Development build (faster, no optimization)&quot;</span></span>
<span id="cb183-48"><a href="#cb183-48" aria-hidden="true" tabindex="-1"></a>    (set-development-mode!)<span class="op">]</span></span>
<span id="cb183-49"><a href="#cb183-49" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-50"><a href="#cb183-50" aria-hidden="true" tabindex="-1"></a>   #:multi</span>
<span id="cb183-51"><a href="#cb183-51" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;--deploy&quot;</span>) target</span>
<span id="cb183-52"><a href="#cb183-52" aria-hidden="true" tabindex="-1"></a>                 <span class="st">&quot;Deploy to target (github-pages, netlify, vercel)&quot;</span></span>
<span id="cb183-53"><a href="#cb183-53" aria-hidden="true" tabindex="-1"></a>                 (deploy-target target)<span class="op">]</span></span>
<span id="cb183-54"><a href="#cb183-54" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-55"><a href="#cb183-55" aria-hidden="true" tabindex="-1"></a>   <span class="op">[</span>(<span class="st">&quot;--analytics&quot;</span>) provider</span>
<span id="cb183-56"><a href="#cb183-56" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;Add analytics (google:ID, plausible:DOMAIN)&quot;</span></span>
<span id="cb183-57"><a href="#cb183-57" aria-hidden="true" tabindex="-1"></a>                    (add-analytics-provider! provider)<span class="op">]</span></span>
<span id="cb183-58"><a href="#cb183-58" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-59"><a href="#cb183-59" aria-hidden="true" tabindex="-1"></a>   #:args (command <span class="op">.</span> args)</span>
<span id="cb183-60"><a href="#cb183-60" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb183-61"><a href="#cb183-61" aria-hidden="true" tabindex="-1"></a>   (match command</span>
<span id="cb183-62"><a href="#cb183-62" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;build&quot;</span></span>
<span id="cb183-63"><a href="#cb183-63" aria-hidden="true" tabindex="-1"></a>      (run-build-command (build-config) args)<span class="op">]</span></span>
<span id="cb183-64"><a href="#cb183-64" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb183-65"><a href="#cb183-65" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;deploy&quot;</span></span>
<span id="cb183-66"><a href="#cb183-66" aria-hidden="true" tabindex="-1"></a>      (run-deploy-command (build-config) (deploy-target) (custom-domain))<span class="op">]</span></span>
<span id="cb183-67"><a href="#cb183-67" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb183-68"><a href="#cb183-68" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;serve&quot;</span></span>
<span id="cb183-69"><a href="#cb183-69" aria-hidden="true" tabindex="-1"></a>      (run-serve-command (build-config) args)<span class="op">]</span></span>
<span id="cb183-70"><a href="#cb183-70" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb183-71"><a href="#cb183-71" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;init&quot;</span></span>
<span id="cb183-72"><a href="#cb183-72" aria-hidden="true" tabindex="-1"></a>      (run-init-command args)<span class="op">]</span></span>
<span id="cb183-73"><a href="#cb183-73" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb183-74"><a href="#cb183-74" aria-hidden="true" tabindex="-1"></a>     <span class="op">[</span><span class="st">&quot;doctor&quot;</span></span>
<span id="cb183-75"><a href="#cb183-75" aria-hidden="true" tabindex="-1"></a>      (run-diagnostic-command)<span class="op">]</span></span>
<span id="cb183-76"><a href="#cb183-76" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb183-77"><a href="#cb183-77" aria-hidden="true" tabindex="-1"></a>     <span class="op">[_</span></span>
<span id="cb183-78"><a href="#cb183-78" aria-hidden="true" tabindex="-1"></a>      (displayln <span class="st">&quot;Unknown command. Use --help for usage.&quot;</span>)<span class="op">]</span>)))</span>
<span id="cb183-79"><a href="#cb183-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-80"><a href="#cb183-80" aria-hidden="true" tabindex="-1"></a><span class="co">;; Initialize new project</span></span>
<span id="cb183-81"><a href="#cb183-81" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(run-init-command args)</span>
<span id="cb183-82"><a href="#cb183-82" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> project-name </span>(<span class="kw">if</span> (<span class="kw">null?</span> args) <span class="st">&quot;my-site&quot;</span> (first args)))</span>
<span id="cb183-83"><a href="#cb183-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-84"><a href="#cb183-84" aria-hidden="true" tabindex="-1"></a>  (displayln (format <span class="st">&quot;Initializing new Shrdlu project: ~a&quot;</span> project-name))</span>
<span id="cb183-85"><a href="#cb183-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-86"><a href="#cb183-86" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create directory structure</span></span>
<span id="cb183-87"><a href="#cb183-87" aria-hidden="true" tabindex="-1"></a>  (make-directory* project-name)</span>
<span id="cb183-88"><a href="#cb183-88" aria-hidden="true" tabindex="-1"></a>  (make-directory* (build-path project-name <span class="st">&quot;content&quot;</span>))</span>
<span id="cb183-89"><a href="#cb183-89" aria-hidden="true" tabindex="-1"></a>  (make-directory* (build-path project-name <span class="st">&quot;templates&quot;</span>))</span>
<span id="cb183-90"><a href="#cb183-90" aria-hidden="true" tabindex="-1"></a>  (make-directory* (build-path project-name <span class="st">&quot;static&quot;</span>))</span>
<span id="cb183-91"><a href="#cb183-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-92"><a href="#cb183-92" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate default configuration</span></span>
<span id="cb183-93"><a href="#cb183-93" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">with-output-to-file</span> (build-path project-name <span class="st">&quot;shrdlu.config.rkt&quot;</span>)</span>
<span id="cb183-94"><a href="#cb183-94" aria-hidden="true" tabindex="-1"></a>    (λ ()</span>
<span id="cb183-95"><a href="#cb183-95" aria-hidden="true" tabindex="-1"></a>      (pretty-write</span>
<span id="cb183-96"><a href="#cb183-96" aria-hidden="true" tabindex="-1"></a>       &#39;(shrdlu-config</span>
<span id="cb183-97"><a href="#cb183-97" aria-hidden="true" tabindex="-1"></a>         #:title <span class="st">&quot;My Shrdlu Site&quot;</span></span>
<span id="cb183-98"><a href="#cb183-98" aria-hidden="true" tabindex="-1"></a>         #:author <span class="st">&quot;Your Name&quot;</span></span>
<span id="cb183-99"><a href="#cb183-99" aria-hidden="true" tabindex="-1"></a>         #:base-url <span class="st">&quot;https://example.com&quot;</span></span>
<span id="cb183-100"><a href="#cb183-100" aria-hidden="true" tabindex="-1"></a>         #:theme <span class="st">&quot;default&quot;</span></span>
<span id="cb183-101"><a href="#cb183-101" aria-hidden="true" tabindex="-1"></a>         #:plugins (syntax-highlighting</span>
<span id="cb183-102"><a href="#cb183-102" aria-hidden="true" tabindex="-1"></a>                   table-of-contents</span>
<span id="cb183-103"><a href="#cb183-103" aria-hidden="true" tabindex="-1"></a>                   search)</span>
<span id="cb183-104"><a href="#cb183-104" aria-hidden="true" tabindex="-1"></a>         #:build (output-dir <span class="st">&quot;_site&quot;</span></span>
<span id="cb183-105"><a href="#cb183-105" aria-hidden="true" tabindex="-1"></a>                 cache-dir <span class="st">&quot;.cache&quot;</span></span>
<span id="cb183-106"><a href="#cb183-106" aria-hidden="true" tabindex="-1"></a>                 minify? <span class="dv">#t</span>))))</span>
<span id="cb183-107"><a href="#cb183-107" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;error)</span>
<span id="cb183-108"><a href="#cb183-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-109"><a href="#cb183-109" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Create example content</span></span>
<span id="cb183-110"><a href="#cb183-110" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">with-output-to-file</span> (build-path project-name <span class="st">&quot;content/index.rkt&quot;</span>)</span>
<span id="cb183-111"><a href="#cb183-111" aria-hidden="true" tabindex="-1"></a>    (λ ()</span>
<span id="cb183-112"><a href="#cb183-112" aria-hidden="true" tabindex="-1"></a>      (displayln <span class="st">&quot;#lang shrdlu</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb183-113"><a href="#cb183-113" aria-hidden="true" tabindex="-1"></a>      (displayln <span class="st">&quot;#:title </span><span class="ch">\&quot;</span><span class="st">Welcome to Shrdlu</span><span class="ch">\&quot;</span><span class="st">&quot;</span>)</span>
<span id="cb183-114"><a href="#cb183-114" aria-hidden="true" tabindex="-1"></a>      (displayln <span class="st">&quot;#:date 2024-01-01</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb183-115"><a href="#cb183-115" aria-hidden="true" tabindex="-1"></a>      (displayln <span class="st">&quot;# Welcome to your new site!</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb183-116"><a href="#cb183-116" aria-hidden="true" tabindex="-1"></a>      (displayln <span class="st">&quot;This is an example page. Edit `content/index.rkt` to get started.&quot;</span>))</span>
<span id="cb183-117"><a href="#cb183-117" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;error)</span>
<span id="cb183-118"><a href="#cb183-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-119"><a href="#cb183-119" aria-hidden="true" tabindex="-1"></a>  (displayln <span class="st">&quot;</span><span class="ch">\n</span><span class="st">Project initialized successfully!&quot;</span>)</span>
<span id="cb183-120"><a href="#cb183-120" aria-hidden="true" tabindex="-1"></a>  (displayln <span class="st">&quot;Next steps:&quot;</span>)</span>
<span id="cb183-121"><a href="#cb183-121" aria-hidden="true" tabindex="-1"></a>  (displayln (format <span class="st">&quot;  cd ~a&quot;</span> project-name))</span>
<span id="cb183-122"><a href="#cb183-122" aria-hidden="true" tabindex="-1"></a>  (displayln <span class="st">&quot;  shrdlu build&quot;</span>)</span>
<span id="cb183-123"><a href="#cb183-123" aria-hidden="true" tabindex="-1"></a>  (displayln <span class="st">&quot;  shrdlu serve&quot;</span>))</span>
<span id="cb183-124"><a href="#cb183-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-125"><a href="#cb183-125" aria-hidden="true" tabindex="-1"></a><span class="co">;; Diagnostic command</span></span>
<span id="cb183-126"><a href="#cb183-126" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(run-diagnostic-command)</span>
<span id="cb183-127"><a href="#cb183-127" aria-hidden="true" tabindex="-1"></a>  (displayln <span class="st">&quot;Shrdlu Diagnostic Report&quot;</span>)</span>
<span id="cb183-128"><a href="#cb183-128" aria-hidden="true" tabindex="-1"></a>  (displayln <span class="st">&quot;========================</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb183-129"><a href="#cb183-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-130"><a href="#cb183-130" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check Racket version</span></span>
<span id="cb183-131"><a href="#cb183-131" aria-hidden="true" tabindex="-1"></a>  (displayln (format <span class="st">&quot;Racket version: ~a&quot;</span> (version)))</span>
<span id="cb183-132"><a href="#cb183-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-133"><a href="#cb183-133" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check required packages</span></span>
<span id="cb183-134"><a href="#cb183-134" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> required-packages</span></span>
<span id="cb183-135"><a href="#cb183-135" aria-hidden="true" tabindex="-1"></a>    &#39;(web-server scribble markdown pollen))</span>
<span id="cb183-136"><a href="#cb183-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-137"><a href="#cb183-137" aria-hidden="true" tabindex="-1"></a>  (displayln <span class="st">&quot;</span><span class="ch">\n</span><span class="st">Required packages:&quot;</span>)</span>
<span id="cb183-138"><a href="#cb183-138" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>pkg required-packages<span class="op">]</span>)</span>
<span id="cb183-139"><a href="#cb183-139" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> installed? </span>(package-installed? pkg))</span>
<span id="cb183-140"><a href="#cb183-140" aria-hidden="true" tabindex="-1"></a>    (displayln (format <span class="st">&quot;  ~a: ~a&quot;</span> </span>
<span id="cb183-141"><a href="#cb183-141" aria-hidden="true" tabindex="-1"></a>                      pkg </span>
<span id="cb183-142"><a href="#cb183-142" aria-hidden="true" tabindex="-1"></a>                      (<span class="kw">if</span> installed? <span class="st">&quot;✓ installed&quot;</span> <span class="st">&quot;✗ missing&quot;</span>))))</span>
<span id="cb183-143"><a href="#cb183-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-144"><a href="#cb183-144" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check system resources</span></span>
<span id="cb183-145"><a href="#cb183-145" aria-hidden="true" tabindex="-1"></a>  (displayln (format <span class="st">&quot;</span><span class="ch">\n</span><span class="st">System resources:&quot;</span>))</span>
<span id="cb183-146"><a href="#cb183-146" aria-hidden="true" tabindex="-1"></a>  (displayln (format <span class="st">&quot;  CPU cores: ~a&quot;</span> (processor-count)))</span>
<span id="cb183-147"><a href="#cb183-147" aria-hidden="true" tabindex="-1"></a>  (displayln (format <span class="st">&quot;  Memory: ~a MB&quot;</span> </span>
<span id="cb183-148"><a href="#cb183-148" aria-hidden="true" tabindex="-1"></a>                    (<span class="kw">quotient</span> (current-memory-use) <span class="dv">1048576</span>)))</span>
<span id="cb183-149"><a href="#cb183-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-150"><a href="#cb183-150" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Test build performance</span></span>
<span id="cb183-151"><a href="#cb183-151" aria-hidden="true" tabindex="-1"></a>  (displayln <span class="st">&quot;</span><span class="ch">\n</span><span class="st">Build performance test:&quot;</span>)</span>
<span id="cb183-152"><a href="#cb183-152" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> test-start </span>(current-inexact-milliseconds))</span>
<span id="cb183-153"><a href="#cb183-153" aria-hidden="true" tabindex="-1"></a>  (void (build-test-pages <span class="dv">10</span>))</span>
<span id="cb183-154"><a href="#cb183-154" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> test-time </span>(<span class="op">-</span> (current-inexact-milliseconds) test-start))</span>
<span id="cb183-155"><a href="#cb183-155" aria-hidden="true" tabindex="-1"></a>  (displayln (format <span class="st">&quot;  Built 10 test pages in ~a ms&quot;</span> test-time))</span>
<span id="cb183-156"><a href="#cb183-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-157"><a href="#cb183-157" aria-hidden="true" tabindex="-1"></a>  (displayln <span class="st">&quot;</span><span class="ch">\n</span><span class="st">Diagnostic complete.&quot;</span>))</span></code></pre></div>
<p>This chapter provides everything needed to deploy Shrdlu sites to
production, with special attention to GitHub Pages deployment including
custom domain configuration. The performance optimization section
ensures sites remain fast, while monitoring integration helps track
real-world usage. The CLI provides a professional interface for building
and deploying sites. # Chapter 15: Using LLM TTS to Narrate Posts</p>
<h2 id="overview">Overview</h2>
<p>This chapter explores adding text-to-speech (TTS) functionality to
your Shrdlu static site generator using free, open-source language
models. We’ll implement a system that generates audio narrations of
posts and serves them when users append <code>?fmt=tts</code> to the
URL.</p>
<h2 id="architecture">Architecture</h2>
<h3 id="core-components">Core Components</h3>
<div class="sourceCode" id="cb184"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; shrdlu/tts.rkt</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>(provide</span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a> tts-config</span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a> generate-narration</span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a> narration-exists?</span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a> get-narration-path</span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a> serve-narration)</span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>(struct tts-config</span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a>  (model-path</span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a>   voice-id</span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>   speed</span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a>   format</span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a>   cache-dir)</span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> default-tts-config</span></span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>  (tts-config</span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a>   #:model-path (find-system-path &#39;home-dir)</span>
<span id="cb184-22"><a href="#cb184-22" aria-hidden="true" tabindex="-1"></a>   #:voice-id <span class="st">&quot;default&quot;</span></span>
<span id="cb184-23"><a href="#cb184-23" aria-hidden="true" tabindex="-1"></a>   #:speed <span class="fl">1.0</span></span>
<span id="cb184-24"><a href="#cb184-24" aria-hidden="true" tabindex="-1"></a>   #:format &#39;mp3</span>
<span id="cb184-25"><a href="#cb184-25" aria-hidden="true" tabindex="-1"></a>   #:cache-dir <span class="st">&quot;_cache/tts&quot;</span>))</span></code></pre></div>
<h2 id="tts-model-integration">TTS Model Integration</h2>
<h3 id="using-coqui-tts">Using Coqui TTS</h3>
<p>We’ll use Coqui TTS, a free open-source TTS system that supports
multiple models:</p>
<div class="sourceCode" id="cb185"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; shrdlu/tts/coqui.rkt</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>(require net/http-client</span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>         json</span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>         file/sha1)</span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(setup-coqui-tts)</span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> models-dir </span>(build-path (find-system-path &#39;home-dir) </span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;.shrdlu&quot;</span> </span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;tts-models&quot;</span>))</span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>  (make-directory* models-dir)</span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Download VITS model if not present</span></span>
<span id="cb185-15"><a href="#cb185-15" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> model-path </span>(build-path models-dir <span class="st">&quot;tts_models--en--vits.tar.gz&quot;</span>))</span>
<span id="cb185-16"><a href="#cb185-16" aria-hidden="true" tabindex="-1"></a>  (unless (<span class="kw">file-exists?</span> model-path)</span>
<span id="cb185-17"><a href="#cb185-17" aria-hidden="true" tabindex="-1"></a>    (displayln <span class="st">&quot;Downloading Coqui TTS model...&quot;</span>)</span>
<span id="cb185-18"><a href="#cb185-18" aria-hidden="true" tabindex="-1"></a>    (download-model <span class="st">&quot;https://coqui.ai/models/tts_models--en--vits.tar.gz&quot;</span> </span>
<span id="cb185-19"><a href="#cb185-19" aria-hidden="true" tabindex="-1"></a>                    model-path))</span>
<span id="cb185-20"><a href="#cb185-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-21"><a href="#cb185-21" aria-hidden="true" tabindex="-1"></a>  model-path)</span>
<span id="cb185-22"><a href="#cb185-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-23"><a href="#cb185-23" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(text-to-speech-coqui text config)</span>
<span id="cb185-24"><a href="#cb185-24" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> temp-text </span>(make-temporary-file <span class="st">&quot;shrdlu-tts-~a.txt&quot;</span>))</span>
<span id="cb185-25"><a href="#cb185-25" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> output-path </span>(make-temporary-file <span class="st">&quot;shrdlu-tts-~a.wav&quot;</span>))</span>
<span id="cb185-26"><a href="#cb185-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-27"><a href="#cb185-27" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-with-output-file</span> temp-text</span>
<span id="cb185-28"><a href="#cb185-28" aria-hidden="true" tabindex="-1"></a>    (λ (out) (<span class="kw">display</span> text out))</span>
<span id="cb185-29"><a href="#cb185-29" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;replace)</span>
<span id="cb185-30"><a href="#cb185-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-31"><a href="#cb185-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Call Coqui TTS CLI</span></span>
<span id="cb185-32"><a href="#cb185-32" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> result</span></span>
<span id="cb185-33"><a href="#cb185-33" aria-hidden="true" tabindex="-1"></a>    (system* <span class="st">&quot;/usr/bin/env&quot;</span></span>
<span id="cb185-34"><a href="#cb185-34" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;tts&quot;</span></span>
<span id="cb185-35"><a href="#cb185-35" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;--text&quot;</span> text</span>
<span id="cb185-36"><a href="#cb185-36" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;--model_name&quot;</span> <span class="st">&quot;tts_models/en/vits&quot;</span></span>
<span id="cb185-37"><a href="#cb185-37" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;--out_path&quot;</span> (path-&gt;string output-path)))</span>
<span id="cb185-38"><a href="#cb185-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-39"><a href="#cb185-39" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">delete-file</span> temp-text)</span>
<span id="cb185-40"><a href="#cb185-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-41"><a href="#cb185-41" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> result</span>
<span id="cb185-42"><a href="#cb185-42" aria-hidden="true" tabindex="-1"></a>      output-path</span>
<span id="cb185-43"><a href="#cb185-43" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> &#39;text-to-speech-coqui <span class="st">&quot;TTS generation failed&quot;</span>)))</span></code></pre></div>
<h3 id="alternative-using-bark">Alternative: Using Bark</h3>
<p>For more expressive speech with emotion:</p>
<div class="sourceCode" id="cb186"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; shrdlu/tts/bark.rkt</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(setup-bark-model)</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Bark uses Hugging Face models</span></span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cache-dir </span>(build-path (find-system-path &#39;home-dir)</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;.cache&quot;</span></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;huggingface&quot;</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;bark&quot;</span>))</span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>  (make-directory* cache-dir)</span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; The model will auto-download on first use</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>  cache-dir)</span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(text-to-speech-bark text config)</span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Split text into chunks for Bark&#39;s token limit</span></span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> chunks </span>(split-text-for-bark text))</span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> audio-segments </span></span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a>    (for/list (<span class="op">[</span>chunk chunks<span class="op">]</span></span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a>               <span class="op">[</span>idx (in-naturals)<span class="op">]</span>)</span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a>      (generate-bark-segment chunk idx config)))</span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Concatenate audio segments</span></span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a>  (concatenate-audio-files audio-segments))</span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(split-text-for-bark text <span class="op">[</span>max-chars <span class="dv">400</span><span class="op">]</span>)</span>
<span id="cb186-27"><a href="#cb186-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Bark works best with shorter segments</span></span>
<span id="cb186-28"><a href="#cb186-28" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> sentences </span>(regexp-split #rx<span class="st">&quot;[.!?]+&quot;</span> text))</span>
<span id="cb186-29"><a href="#cb186-29" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> chunks </span>&#39;())</span>
<span id="cb186-30"><a href="#cb186-30" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> current-chunk </span><span class="st">&quot;&quot;</span>)</span>
<span id="cb186-31"><a href="#cb186-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb186-32"><a href="#cb186-32" aria-hidden="true" tabindex="-1"></a>  (for (<span class="op">[</span>sentence sentences<span class="op">]</span>)</span>
<span id="cb186-33"><a href="#cb186-33" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">cond</span></span>
<span id="cb186-34"><a href="#cb186-34" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="op">&gt;</span> (<span class="op">+</span> (<span class="kw">string-length</span> current-chunk) </span>
<span id="cb186-35"><a href="#cb186-35" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">string-length</span> sentence)) </span>
<span id="cb186-36"><a href="#cb186-36" aria-hidden="true" tabindex="-1"></a>          max-chars)</span>
<span id="cb186-37"><a href="#cb186-37" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> chunks (<span class="kw">cons</span> current-chunk chunks))</span>
<span id="cb186-38"><a href="#cb186-38" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> current-chunk sentence)<span class="op">]</span></span>
<span id="cb186-39"><a href="#cb186-39" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span><span class="kw">else</span></span>
<span id="cb186-40"><a href="#cb186-40" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">set!</span> current-chunk </span>
<span id="cb186-41"><a href="#cb186-41" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">string-append</span> current-chunk <span class="st">&quot; &quot;</span> sentence))<span class="op">]</span>))</span>
<span id="cb186-42"><a href="#cb186-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb186-43"><a href="#cb186-43" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">reverse</span> (<span class="kw">cons</span> current-chunk chunks)))</span></code></pre></div>
<h2 id="document-processing-pipeline">Document Processing Pipeline</h2>
<h3 id="text-extraction-and-preparation">Text Extraction and
Preparation</h3>
<div class="sourceCode" id="cb187"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; shrdlu/tts/processor.rkt</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>(provide</span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a> prepare-document-for-tts</span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a> extract-speakable-text</span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a> add-speech-marks)</span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(prepare-document-for-tts doc)</span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> content </span>(document-content doc))</span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> metadata </span>(document-metadata doc))</span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb187-13"><a href="#cb187-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Build narration script</span></span>
<span id="cb187-14"><a href="#cb187-14" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">string-append</span></span>
<span id="cb187-15"><a href="#cb187-15" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Introduction</span></span>
<span id="cb187-16"><a href="#cb187-16" aria-hidden="true" tabindex="-1"></a>   (format-introduction metadata)</span>
<span id="cb187-17"><a href="#cb187-17" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">&quot;</span></span>
<span id="cb187-18"><a href="#cb187-18" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Main content</span></span>
<span id="cb187-19"><a href="#cb187-19" aria-hidden="true" tabindex="-1"></a>   (extract-speakable-text content)</span>
<span id="cb187-20"><a href="#cb187-20" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">&quot;</span></span>
<span id="cb187-21"><a href="#cb187-21" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Conclusion</span></span>
<span id="cb187-22"><a href="#cb187-22" aria-hidden="true" tabindex="-1"></a>   (format-conclusion metadata)))</span>
<span id="cb187-23"><a href="#cb187-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-24"><a href="#cb187-24" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(extract-speakable-text node)</span>
<span id="cb187-25"><a href="#cb187-25" aria-hidden="true" tabindex="-1"></a>  (match (node-type node)</span>
<span id="cb187-26"><a href="#cb187-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;heading </span>
<span id="cb187-27"><a href="#cb187-27" aria-hidden="true" tabindex="-1"></a>     (format <span class="st">&quot;</span><span class="ch">\n</span><span class="st">~a.</span><span class="ch">\n</span><span class="st">&quot;</span> (node-&gt;plain-text node))<span class="op">]</span></span>
<span id="cb187-28"><a href="#cb187-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-29"><a href="#cb187-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;paragraph</span>
<span id="cb187-30"><a href="#cb187-30" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">string-append</span> (node-&gt;plain-text node) <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)<span class="op">]</span></span>
<span id="cb187-31"><a href="#cb187-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-32"><a href="#cb187-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;code-block</span>
<span id="cb187-33"><a href="#cb187-33" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Describe code blocks instead of reading them</span></span>
<span id="cb187-34"><a href="#cb187-34" aria-hidden="true" tabindex="-1"></a>     (format <span class="st">&quot;Code block in ~a.</span><span class="ch">\n</span><span class="st">&quot;</span> </span>
<span id="cb187-35"><a href="#cb187-35" aria-hidden="true" tabindex="-1"></a>             (node-get-attr node &#39;lang <span class="st">&quot;unknown language&quot;</span>))<span class="op">]</span></span>
<span id="cb187-36"><a href="#cb187-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-37"><a href="#cb187-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;math</span>
<span id="cb187-38"><a href="#cb187-38" aria-hidden="true" tabindex="-1"></a>     <span class="co">;; Describe math instead of reading LaTeX</span></span>
<span id="cb187-39"><a href="#cb187-39" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> (node-get-attr node &#39;display?)</span>
<span id="cb187-40"><a href="#cb187-40" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;Display equation.</span><span class="ch">\n</span><span class="st">&quot;</span></span>
<span id="cb187-41"><a href="#cb187-41" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;inline math expression&quot;</span>)<span class="op">]</span></span>
<span id="cb187-42"><a href="#cb187-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-43"><a href="#cb187-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;image</span>
<span id="cb187-44"><a href="#cb187-44" aria-hidden="true" tabindex="-1"></a>     (format <span class="st">&quot;Image: ~a.</span><span class="ch">\n</span><span class="st">&quot;</span> </span>
<span id="cb187-45"><a href="#cb187-45" aria-hidden="true" tabindex="-1"></a>             (node-get-attr node &#39;alt <span class="st">&quot;no description&quot;</span>))<span class="op">]</span></span>
<span id="cb187-46"><a href="#cb187-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-47"><a href="#cb187-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;list</span>
<span id="cb187-48"><a href="#cb187-48" aria-hidden="true" tabindex="-1"></a>     (format-list-for-speech node)<span class="op">]</span></span>
<span id="cb187-49"><a href="#cb187-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-50"><a href="#cb187-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>&#39;table</span>
<span id="cb187-51"><a href="#cb187-51" aria-hidden="true" tabindex="-1"></a>     (format-table-for-speech node)<span class="op">]</span></span>
<span id="cb187-52"><a href="#cb187-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-53"><a href="#cb187-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span></span>
<span id="cb187-54"><a href="#cb187-54" aria-hidden="true" tabindex="-1"></a>     (string-join</span>
<span id="cb187-55"><a href="#cb187-55" aria-hidden="true" tabindex="-1"></a>      (map extract-speakable-text (node-children node))</span>
<span id="cb187-56"><a href="#cb187-56" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot; &quot;</span>)<span class="op">]</span>))</span>
<span id="cb187-57"><a href="#cb187-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-58"><a href="#cb187-58" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(format-list-for-speech list-node)</span>
<span id="cb187-59"><a href="#cb187-59" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> items </span>(node-children list-node))</span>
<span id="cb187-60"><a href="#cb187-60" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> ordered? </span>(node-get-attr list-node &#39;ordered?))</span>
<span id="cb187-61"><a href="#cb187-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb187-62"><a href="#cb187-62" aria-hidden="true" tabindex="-1"></a>  (string-join</span>
<span id="cb187-63"><a href="#cb187-63" aria-hidden="true" tabindex="-1"></a>   (for/list (<span class="op">[</span>item items<span class="op">]</span></span>
<span id="cb187-64"><a href="#cb187-64" aria-hidden="true" tabindex="-1"></a>              <span class="op">[</span>idx (in-naturals <span class="dv">1</span>)<span class="op">]</span>)</span>
<span id="cb187-65"><a href="#cb187-65" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">if</span> ordered?</span>
<span id="cb187-66"><a href="#cb187-66" aria-hidden="true" tabindex="-1"></a>         (format <span class="st">&quot;~a. ~a&quot;</span> idx (node-&gt;plain-text item))</span>
<span id="cb187-67"><a href="#cb187-67" aria-hidden="true" tabindex="-1"></a>         (format <span class="st">&quot;• ~a&quot;</span> (node-&gt;plain-text item))))</span>
<span id="cb187-68"><a href="#cb187-68" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</span>
<span id="cb187-69"><a href="#cb187-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-70"><a href="#cb187-70" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(add-speech-marks text)</span>
<span id="cb187-71"><a href="#cb187-71" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add SSML-like markers for better pronunciation</span></span>
<span id="cb187-72"><a href="#cb187-72" aria-hidden="true" tabindex="-1"></a>  (regexp-replace* #rx<span class="st">&quot;</span><span class="ch">\\</span><span class="st">b([A-Z]{2,})</span><span class="ch">\\</span><span class="st">b&quot;</span></span>
<span id="cb187-73"><a href="#cb187-73" aria-hidden="true" tabindex="-1"></a>                   text</span>
<span id="cb187-74"><a href="#cb187-74" aria-hidden="true" tabindex="-1"></a>                   (λ (match acronym)</span>
<span id="cb187-75"><a href="#cb187-75" aria-hidden="true" tabindex="-1"></a>                     <span class="co">;; Spell out acronyms</span></span>
<span id="cb187-76"><a href="#cb187-76" aria-hidden="true" tabindex="-1"></a>                     (string-join </span>
<span id="cb187-77"><a href="#cb187-77" aria-hidden="true" tabindex="-1"></a>                      (map <span class="kw">string</span> (<span class="kw">string-&gt;list</span> acronym))</span>
<span id="cb187-78"><a href="#cb187-78" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&quot; &quot;</span>))))</span></code></pre></div>
<h3 id="caching-system">Caching System</h3>
<div class="sourceCode" id="cb188"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; shrdlu/tts/cache.rkt</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>(provide</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a> narration-cache</span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a> get-cached-narration</span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a> cache-narration!</span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a> invalidate-narration!)</span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>(struct narration-cache</span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>  (directory</span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>   manifest)</span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>  #:mutable)</span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(make-narration-cache dir)</span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>  (make-directory* dir)</span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> manifest-path </span>(build-path dir <span class="st">&quot;manifest.rktd&quot;</span>))</span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> manifest </span></span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (<span class="kw">file-exists?</span> manifest-path)</span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">call-with-input-file</span> manifest-path <span class="kw">read</span>)</span>
<span id="cb188-21"><a href="#cb188-21" aria-hidden="true" tabindex="-1"></a>        (hash)))</span>
<span id="cb188-22"><a href="#cb188-22" aria-hidden="true" tabindex="-1"></a>  (narration-cache dir manifest))</span>
<span id="cb188-23"><a href="#cb188-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-24"><a href="#cb188-24" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(get-cache-key doc config)</span>
<span id="cb188-25"><a href="#cb188-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate cache key based on content and config</span></span>
<span id="cb188-26"><a href="#cb188-26" aria-hidden="true" tabindex="-1"></a>  (sha256 (bytes-append</span>
<span id="cb188-27"><a href="#cb188-27" aria-hidden="true" tabindex="-1"></a>           (string-&gt;bytes/utf-8 (document-&gt;string doc))</span>
<span id="cb188-28"><a href="#cb188-28" aria-hidden="true" tabindex="-1"></a>           (string-&gt;bytes/utf-8 (format <span class="st">&quot;~s&quot;</span> config)))))</span>
<span id="cb188-29"><a href="#cb188-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-30"><a href="#cb188-30" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(get-cached-narration cache doc config)</span>
<span id="cb188-31"><a href="#cb188-31" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> key </span>(get-cache-key doc config))</span>
<span id="cb188-32"><a href="#cb188-32" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> entry </span>(hash-ref (narration-cache-manifest cache) key <span class="dv">#f</span>))</span>
<span id="cb188-33"><a href="#cb188-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-34"><a href="#cb188-34" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">and</span> entry</span>
<span id="cb188-35"><a href="#cb188-35" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">file-exists?</span> (build-path (narration-cache-directory cache)</span>
<span id="cb188-36"><a href="#cb188-36" aria-hidden="true" tabindex="-1"></a>                                 (hash-ref entry &#39;filename)))</span>
<span id="cb188-37"><a href="#cb188-37" aria-hidden="true" tabindex="-1"></a>       entry))</span>
<span id="cb188-38"><a href="#cb188-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-39"><a href="#cb188-39" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(cache-narration! cache doc config audio-path)</span>
<span id="cb188-40"><a href="#cb188-40" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> key </span>(get-cache-key doc config))</span>
<span id="cb188-41"><a href="#cb188-41" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> filename </span>(format <span class="st">&quot;~a.~a&quot;</span> </span>
<span id="cb188-42"><a href="#cb188-42" aria-hidden="true" tabindex="-1"></a>                          key </span>
<span id="cb188-43"><a href="#cb188-43" aria-hidden="true" tabindex="-1"></a>                          (tts-config-format config)))</span>
<span id="cb188-44"><a href="#cb188-44" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cached-path </span>(build-path (narration-cache-directory cache)</span>
<span id="cb188-45"><a href="#cb188-45" aria-hidden="true" tabindex="-1"></a>                                  filename))</span>
<span id="cb188-46"><a href="#cb188-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-47"><a href="#cb188-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Copy audio to cache</span></span>
<span id="cb188-48"><a href="#cb188-48" aria-hidden="true" tabindex="-1"></a>  (copy-file audio-path cached-path <span class="dv">#t</span>)</span>
<span id="cb188-49"><a href="#cb188-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-50"><a href="#cb188-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Update manifest</span></span>
<span id="cb188-51"><a href="#cb188-51" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> entry</span></span>
<span id="cb188-52"><a href="#cb188-52" aria-hidden="true" tabindex="-1"></a>    (hash &#39;filename filename</span>
<span id="cb188-53"><a href="#cb188-53" aria-hidden="true" tabindex="-1"></a>          &#39;created (current-seconds)</span>
<span id="cb188-54"><a href="#cb188-54" aria-hidden="true" tabindex="-1"></a>          &#39;size (file-size cached-path)</span>
<span id="cb188-55"><a href="#cb188-55" aria-hidden="true" tabindex="-1"></a>          &#39;duration (get-audio-duration cached-path)</span>
<span id="cb188-56"><a href="#cb188-56" aria-hidden="true" tabindex="-1"></a>          &#39;format (tts-config-format config)))</span>
<span id="cb188-57"><a href="#cb188-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-58"><a href="#cb188-58" aria-hidden="true" tabindex="-1"></a>  (hash-set! (narration-cache-manifest cache) key entry)</span>
<span id="cb188-59"><a href="#cb188-59" aria-hidden="true" tabindex="-1"></a>  (save-cache-manifest! cache)</span>
<span id="cb188-60"><a href="#cb188-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-61"><a href="#cb188-61" aria-hidden="true" tabindex="-1"></a>  cached-path)</span></code></pre></div>
<h2 id="audio-processing">Audio Processing</h2>
<h3 id="format-conversion-and-optimization">Format Conversion and
Optimization</h3>
<div class="sourceCode" id="cb189"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; shrdlu/tts/audio.rkt</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>(require file/convertible)</span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(convert-audio input-path output-format </span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>                      <span class="op">[</span>#:bitrate bitrate <span class="dv">128</span><span class="op">]</span></span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>                      <span class="op">[</span>#:sample-rate sample-rate <span class="dv">44100</span><span class="op">]</span>)</span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> output-path </span></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>    (path-replace-extension input-path </span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>                           (format <span class="st">&quot;.~a&quot;</span> output-format)))</span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case</span> output-format</span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(mp3)</span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>     (system* <span class="st">&quot;ffmpeg&quot;</span> <span class="st">&quot;-i&quot;</span> (path-&gt;string input-path)</span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;-acodec&quot;</span> <span class="st">&quot;libmp3lame&quot;</span></span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;-ab&quot;</span> (format <span class="st">&quot;~ak&quot;</span> bitrate)</span>
<span id="cb189-18"><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;-ar&quot;</span> (<span class="kw">number-&gt;string</span> sample-rate)</span>
<span id="cb189-19"><a href="#cb189-19" aria-hidden="true" tabindex="-1"></a>              (path-&gt;string output-path))<span class="op">]</span></span>
<span id="cb189-20"><a href="#cb189-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb189-21"><a href="#cb189-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(opus)</span>
<span id="cb189-22"><a href="#cb189-22" aria-hidden="true" tabindex="-1"></a>     (system* <span class="st">&quot;ffmpeg&quot;</span> <span class="st">&quot;-i&quot;</span> (path-&gt;string input-path)</span>
<span id="cb189-23"><a href="#cb189-23" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;-acodec&quot;</span> <span class="st">&quot;libopus&quot;</span></span>
<span id="cb189-24"><a href="#cb189-24" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;-ab&quot;</span> (format <span class="st">&quot;~ak&quot;</span> bitrate)</span>
<span id="cb189-25"><a href="#cb189-25" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;-ar&quot;</span> (<span class="kw">number-&gt;string</span> sample-rate)</span>
<span id="cb189-26"><a href="#cb189-26" aria-hidden="true" tabindex="-1"></a>              (path-&gt;string output-path))<span class="op">]</span></span>
<span id="cb189-27"><a href="#cb189-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb189-28"><a href="#cb189-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(m4a)</span>
<span id="cb189-29"><a href="#cb189-29" aria-hidden="true" tabindex="-1"></a>     (system* <span class="st">&quot;ffmpeg&quot;</span> <span class="st">&quot;-i&quot;</span> (path-&gt;string input-path)</span>
<span id="cb189-30"><a href="#cb189-30" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;-acodec&quot;</span> <span class="st">&quot;aac&quot;</span></span>
<span id="cb189-31"><a href="#cb189-31" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;-ab&quot;</span> (format <span class="st">&quot;~ak&quot;</span> bitrate)</span>
<span id="cb189-32"><a href="#cb189-32" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;-ar&quot;</span> (<span class="kw">number-&gt;string</span> sample-rate)</span>
<span id="cb189-33"><a href="#cb189-33" aria-hidden="true" tabindex="-1"></a>              (path-&gt;string output-path))<span class="op">]</span>)</span>
<span id="cb189-34"><a href="#cb189-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-35"><a href="#cb189-35" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> (<span class="kw">file-exists?</span> output-path)</span>
<span id="cb189-36"><a href="#cb189-36" aria-hidden="true" tabindex="-1"></a>      output-path</span>
<span id="cb189-37"><a href="#cb189-37" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">error</span> &#39;convert-audio <span class="st">&quot;Audio conversion failed&quot;</span>)))</span>
<span id="cb189-38"><a href="#cb189-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-39"><a href="#cb189-39" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(concatenate-audio-files files </span>
<span id="cb189-40"><a href="#cb189-40" aria-hidden="true" tabindex="-1"></a>                                <span class="op">[</span>#:output output <span class="st">&quot;combined.wav&quot;</span><span class="op">]</span>)</span>
<span id="cb189-41"><a href="#cb189-41" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> file-list </span>(make-temporary-file <span class="st">&quot;concat-~a.txt&quot;</span>))</span>
<span id="cb189-42"><a href="#cb189-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-43"><a href="#cb189-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Write file list for ffmpeg</span></span>
<span id="cb189-44"><a href="#cb189-44" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">call-with-output-file</span> file-list</span>
<span id="cb189-45"><a href="#cb189-45" aria-hidden="true" tabindex="-1"></a>    (λ (out)</span>
<span id="cb189-46"><a href="#cb189-46" aria-hidden="true" tabindex="-1"></a>      (for (<span class="op">[</span>file files<span class="op">]</span>)</span>
<span id="cb189-47"><a href="#cb189-47" aria-hidden="true" tabindex="-1"></a>        (fprintf out <span class="st">&quot;file &#39;~a&#39;</span><span class="ch">\n</span><span class="st">&quot;</span> (path-&gt;string file))))</span>
<span id="cb189-48"><a href="#cb189-48" aria-hidden="true" tabindex="-1"></a>    #:exists &#39;replace)</span>
<span id="cb189-49"><a href="#cb189-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-50"><a href="#cb189-50" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> result</span></span>
<span id="cb189-51"><a href="#cb189-51" aria-hidden="true" tabindex="-1"></a>    (system* <span class="st">&quot;ffmpeg&quot;</span> <span class="st">&quot;-f&quot;</span> <span class="st">&quot;concat&quot;</span></span>
<span id="cb189-52"><a href="#cb189-52" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;-safe&quot;</span> <span class="st">&quot;0&quot;</span></span>
<span id="cb189-53"><a href="#cb189-53" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;-i&quot;</span> (path-&gt;string file-list)</span>
<span id="cb189-54"><a href="#cb189-54" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;-c&quot;</span> <span class="st">&quot;copy&quot;</span></span>
<span id="cb189-55"><a href="#cb189-55" aria-hidden="true" tabindex="-1"></a>             output))</span>
<span id="cb189-56"><a href="#cb189-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-57"><a href="#cb189-57" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">delete-file</span> file-list)</span>
<span id="cb189-58"><a href="#cb189-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-59"><a href="#cb189-59" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">if</span> result output <span class="dv">#f</span>))</span>
<span id="cb189-60"><a href="#cb189-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-61"><a href="#cb189-61" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(get-audio-duration path)</span>
<span id="cb189-62"><a href="#cb189-62" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Use ffprobe to get duration</span></span>
<span id="cb189-63"><a href="#cb189-63" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> output </span>(open-output-string))</span>
<span id="cb189-64"><a href="#cb189-64" aria-hidden="true" tabindex="-1"></a>  (parameterize (<span class="op">[</span><span class="kw">current-output-port</span> output<span class="op">]</span>)</span>
<span id="cb189-65"><a href="#cb189-65" aria-hidden="true" tabindex="-1"></a>    (system* <span class="st">&quot;ffprobe&quot;</span> <span class="st">&quot;-v&quot;</span> <span class="st">&quot;error&quot;</span></span>
<span id="cb189-66"><a href="#cb189-66" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;-show_entries&quot;</span> <span class="st">&quot;format=duration&quot;</span></span>
<span id="cb189-67"><a href="#cb189-67" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;-of&quot;</span> <span class="st">&quot;default=noprint_wrappers=1:nokey=1&quot;</span></span>
<span id="cb189-68"><a href="#cb189-68" aria-hidden="true" tabindex="-1"></a>             (path-&gt;string path)))</span>
<span id="cb189-69"><a href="#cb189-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-70"><a href="#cb189-70" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">string-&gt;number</span> (string-trim (get-output-string output))))</span></code></pre></div>
<h2 id="web-integration">Web Integration</h2>
<h3 id="request-handler">Request Handler</h3>
<div class="sourceCode" id="cb190"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; shrdlu/web/tts-handler.rkt</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>(provide handle-tts-request)</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(handle-tts-request req doc)</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> params </span>(request-query req))</span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">cond</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">equal?</span> (dict-ref params &#39;fmt <span class="dv">#f</span>) <span class="st">&quot;tts&quot;</span>)</span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>     (serve-narration-response doc req)<span class="op">]</span></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="kw">equal?</span> (dict-ref params &#39;fmt <span class="dv">#f</span>) <span class="st">&quot;tts-player&quot;</span>)</span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>     (serve-tts-player-page doc req)<span class="op">]</span></span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="kw">else</span> <span class="dv">#f</span><span class="op">]</span>))</span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(serve-narration-response doc req)</span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> config </span>(current-tts-config))</span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cache </span>(current-narration-cache))</span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-22"><a href="#cb190-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Check cache first</span></span>
<span id="cb190-23"><a href="#cb190-23" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> cached </span>(get-cached-narration cache doc config))</span>
<span id="cb190-24"><a href="#cb190-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-25"><a href="#cb190-25" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> audio-path</span></span>
<span id="cb190-26"><a href="#cb190-26" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> cached</span>
<span id="cb190-27"><a href="#cb190-27" aria-hidden="true" tabindex="-1"></a>        (build-path (narration-cache-directory cache)</span>
<span id="cb190-28"><a href="#cb190-28" aria-hidden="true" tabindex="-1"></a>                    (hash-ref cached &#39;filename))</span>
<span id="cb190-29"><a href="#cb190-29" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">begin</span></span>
<span id="cb190-30"><a href="#cb190-30" aria-hidden="true" tabindex="-1"></a>          <span class="co">;; Generate new narration</span></span>
<span id="cb190-31"><a href="#cb190-31" aria-hidden="true" tabindex="-1"></a>          (<span class="ex">define</span><span class="fu"> narration </span>(generate-narration doc config))</span>
<span id="cb190-32"><a href="#cb190-32" aria-hidden="true" tabindex="-1"></a>          (cache-narration! cache doc config narration))))</span>
<span id="cb190-33"><a href="#cb190-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-34"><a href="#cb190-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Serve audio file</span></span>
<span id="cb190-35"><a href="#cb190-35" aria-hidden="true" tabindex="-1"></a>  (response/full</span>
<span id="cb190-36"><a href="#cb190-36" aria-hidden="true" tabindex="-1"></a>   <span class="dv">200</span> #<span class="st">&quot;OK&quot;</span></span>
<span id="cb190-37"><a href="#cb190-37" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span> (make-header #<span class="st">&quot;Content-Type&quot;</span> </span>
<span id="cb190-38"><a href="#cb190-38" aria-hidden="true" tabindex="-1"></a>                      (<span class="kw">case</span> (tts-config-format config)</span>
<span id="cb190-39"><a href="#cb190-39" aria-hidden="true" tabindex="-1"></a>                        <span class="op">[</span>(mp3) #<span class="st">&quot;audio/mpeg&quot;</span><span class="op">]</span></span>
<span id="cb190-40"><a href="#cb190-40" aria-hidden="true" tabindex="-1"></a>                        <span class="op">[</span>(opus) #<span class="st">&quot;audio/opus&quot;</span><span class="op">]</span></span>
<span id="cb190-41"><a href="#cb190-41" aria-hidden="true" tabindex="-1"></a>                        <span class="op">[</span>(m4a) #<span class="st">&quot;audio/mp4&quot;</span><span class="op">]</span>))</span>
<span id="cb190-42"><a href="#cb190-42" aria-hidden="true" tabindex="-1"></a>         (make-header #<span class="st">&quot;Content-Length&quot;</span></span>
<span id="cb190-43"><a href="#cb190-43" aria-hidden="true" tabindex="-1"></a>                      (string-&gt;bytes/utf-8 </span>
<span id="cb190-44"><a href="#cb190-44" aria-hidden="true" tabindex="-1"></a>                       (<span class="kw">number-&gt;string</span> (file-size audio-path))))</span>
<span id="cb190-45"><a href="#cb190-45" aria-hidden="true" tabindex="-1"></a>         (make-header #<span class="st">&quot;Accept-Ranges&quot;</span> #<span class="st">&quot;bytes&quot;</span>))</span>
<span id="cb190-46"><a href="#cb190-46" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">list</span> (file-&gt;bytes audio-path))))</span>
<span id="cb190-47"><a href="#cb190-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-48"><a href="#cb190-48" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(serve-tts-player-page doc req)</span>
<span id="cb190-49"><a href="#cb190-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Generate HTML5 audio player page</span></span>
<span id="cb190-50"><a href="#cb190-50" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> audio-url </span>(format <span class="st">&quot;~a?fmt=tts&quot;</span> (document-url doc)))</span>
<span id="cb190-51"><a href="#cb190-51" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> title </span>(document-title doc))</span>
<span id="cb190-52"><a href="#cb190-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-53"><a href="#cb190-53" aria-hidden="true" tabindex="-1"></a>  (response/xexpr</span>
<span id="cb190-54"><a href="#cb190-54" aria-hidden="true" tabindex="-1"></a>   `(html</span>
<span id="cb190-55"><a href="#cb190-55" aria-hidden="true" tabindex="-1"></a>     (head</span>
<span id="cb190-56"><a href="#cb190-56" aria-hidden="true" tabindex="-1"></a>      (title ,(format <span class="st">&quot;Audio: ~a&quot;</span> title))</span>
<span id="cb190-57"><a href="#cb190-57" aria-hidden="true" tabindex="-1"></a>      (meta ((charset <span class="st">&quot;utf-8&quot;</span>)))</span>
<span id="cb190-58"><a href="#cb190-58" aria-hidden="true" tabindex="-1"></a>      (meta ((name <span class="st">&quot;viewport&quot;</span>) </span>
<span id="cb190-59"><a href="#cb190-59" aria-hidden="true" tabindex="-1"></a>             (content <span class="st">&quot;width=device-width, initial-scale=1&quot;</span>)))</span>
<span id="cb190-60"><a href="#cb190-60" aria-hidden="true" tabindex="-1"></a>      (style</span>
<span id="cb190-61"><a href="#cb190-61" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;body { font-family: system-ui; max-width: 800px; margin: 0 auto; padding: 20px; }</span></span>
<span id="cb190-62"><a href="#cb190-62" aria-hidden="true" tabindex="-1"></a><span class="st">        .player { background: #f5f5f5; padding: 20px; border-radius: 8px; }</span></span>
<span id="cb190-63"><a href="#cb190-63" aria-hidden="true" tabindex="-1"></a><span class="st">        audio { width: 100%; margin: 20px 0; }</span></span>
<span id="cb190-64"><a href="#cb190-64" aria-hidden="true" tabindex="-1"></a><span class="st">        .controls { display: flex; gap: 10px; margin-top: 10px; }</span></span>
<span id="cb190-65"><a href="#cb190-65" aria-hidden="true" tabindex="-1"></a><span class="st">        button { padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; }</span></span>
<span id="cb190-66"><a href="#cb190-66" aria-hidden="true" tabindex="-1"></a><span class="st">        button:hover { background: #0056b3; }</span></span>
<span id="cb190-67"><a href="#cb190-67" aria-hidden="true" tabindex="-1"></a><span class="st">        .speed-control { display: flex; align-items: center; gap: 10px; }</span></span>
<span id="cb190-68"><a href="#cb190-68" aria-hidden="true" tabindex="-1"></a><span class="st">        .transcript { margin-top: 30px; padding: 20px; background: #fff; border: 1px solid #ddd; border-radius: 4px; white-space: pre-wrap; font-size: 16px; line-height: 1.6; }&quot;</span>))</span>
<span id="cb190-69"><a href="#cb190-69" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb190-70"><a href="#cb190-70" aria-hidden="true" tabindex="-1"></a>     (body</span>
<span id="cb190-71"><a href="#cb190-71" aria-hidden="true" tabindex="-1"></a>      (h1 ,title)</span>
<span id="cb190-72"><a href="#cb190-72" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb190-73"><a href="#cb190-73" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">div</span> ((class <span class="st">&quot;player&quot;</span>))</span>
<span id="cb190-74"><a href="#cb190-74" aria-hidden="true" tabindex="-1"></a>           (h2 <span class="st">&quot;Audio Narration&quot;</span>)</span>
<span id="cb190-75"><a href="#cb190-75" aria-hidden="true" tabindex="-1"></a>           (audio ((controls <span class="st">&quot;controls&quot;</span>)</span>
<span id="cb190-76"><a href="#cb190-76" aria-hidden="true" tabindex="-1"></a>                   (preload <span class="st">&quot;metadata&quot;</span>)</span>
<span id="cb190-77"><a href="#cb190-77" aria-hidden="true" tabindex="-1"></a>                   (id <span class="st">&quot;narration&quot;</span>))</span>
<span id="cb190-78"><a href="#cb190-78" aria-hidden="true" tabindex="-1"></a>                  (source ((src ,audio-url)</span>
<span id="cb190-79"><a href="#cb190-79" aria-hidden="true" tabindex="-1"></a>                           (type ,(audio-mime-type </span>
<span id="cb190-80"><a href="#cb190-80" aria-hidden="true" tabindex="-1"></a>                                   (tts-config-format </span>
<span id="cb190-81"><a href="#cb190-81" aria-hidden="true" tabindex="-1"></a>                                    (current-tts-config))))))</span>
<span id="cb190-82"><a href="#cb190-82" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;Your browser does not support audio playback.&quot;</span>)</span>
<span id="cb190-83"><a href="#cb190-83" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb190-84"><a href="#cb190-84" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">div</span> ((class <span class="st">&quot;controls&quot;</span>))</span>
<span id="cb190-85"><a href="#cb190-85" aria-hidden="true" tabindex="-1"></a>                (button ((onclick <span class="st">&quot;document.getElementById(&#39;narration&#39;).play()&quot;</span>))</span>
<span id="cb190-86"><a href="#cb190-86" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;Play&quot;</span>)</span>
<span id="cb190-87"><a href="#cb190-87" aria-hidden="true" tabindex="-1"></a>                (button ((onclick <span class="st">&quot;document.getElementById(&#39;narration&#39;).pause()&quot;</span>))</span>
<span id="cb190-88"><a href="#cb190-88" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;Pause&quot;</span>)</span>
<span id="cb190-89"><a href="#cb190-89" aria-hidden="true" tabindex="-1"></a>                (button ((onclick <span class="st">&quot;skipBack()&quot;</span>)) <span class="st">&quot;← 10s&quot;</span>)</span>
<span id="cb190-90"><a href="#cb190-90" aria-hidden="true" tabindex="-1"></a>                (button ((onclick <span class="st">&quot;skipForward()&quot;</span>)) <span class="st">&quot;10s →&quot;</span>))</span>
<span id="cb190-91"><a href="#cb190-91" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb190-92"><a href="#cb190-92" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">div</span> ((class <span class="st">&quot;speed-control&quot;</span>))</span>
<span id="cb190-93"><a href="#cb190-93" aria-hidden="true" tabindex="-1"></a>                (label <span class="st">&quot;Speed: &quot;</span>)</span>
<span id="cb190-94"><a href="#cb190-94" aria-hidden="true" tabindex="-1"></a>                (select ((id <span class="st">&quot;speed&quot;</span>)</span>
<span id="cb190-95"><a href="#cb190-95" aria-hidden="true" tabindex="-1"></a>                         (onchange <span class="st">&quot;changeSpeed()&quot;</span>))</span>
<span id="cb190-96"><a href="#cb190-96" aria-hidden="true" tabindex="-1"></a>                        (option ((value <span class="st">&quot;0.75&quot;</span>)) <span class="st">&quot;0.75x&quot;</span>)</span>
<span id="cb190-97"><a href="#cb190-97" aria-hidden="true" tabindex="-1"></a>                        (option ((value <span class="st">&quot;1&quot;</span>) (selected <span class="st">&quot;selected&quot;</span>)) <span class="st">&quot;1x&quot;</span>)</span>
<span id="cb190-98"><a href="#cb190-98" aria-hidden="true" tabindex="-1"></a>                        (option ((value <span class="st">&quot;1.25&quot;</span>)) <span class="st">&quot;1.25x&quot;</span>)</span>
<span id="cb190-99"><a href="#cb190-99" aria-hidden="true" tabindex="-1"></a>                        (option ((value <span class="st">&quot;1.5&quot;</span>)) <span class="st">&quot;1.5x&quot;</span>)</span>
<span id="cb190-100"><a href="#cb190-100" aria-hidden="true" tabindex="-1"></a>                        (option ((value <span class="st">&quot;2&quot;</span>)) <span class="st">&quot;2x&quot;</span>))))</span>
<span id="cb190-101"><a href="#cb190-101" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb190-102"><a href="#cb190-102" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">div</span> ((class <span class="st">&quot;transcript&quot;</span>))</span>
<span id="cb190-103"><a href="#cb190-103" aria-hidden="true" tabindex="-1"></a>           (h3 <span class="st">&quot;Transcript&quot;</span>)</span>
<span id="cb190-104"><a href="#cb190-104" aria-hidden="true" tabindex="-1"></a>           (pre ,(prepare-document-for-tts doc)))</span>
<span id="cb190-105"><a href="#cb190-105" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb190-106"><a href="#cb190-106" aria-hidden="true" tabindex="-1"></a>      (script</span>
<span id="cb190-107"><a href="#cb190-107" aria-hidden="true" tabindex="-1"></a>       <span class="st">&quot;function skipBack() { </span></span>
<span id="cb190-108"><a href="#cb190-108" aria-hidden="true" tabindex="-1"></a><span class="st">          var audio = document.getElementById(&#39;narration&#39;);</span></span>
<span id="cb190-109"><a href="#cb190-109" aria-hidden="true" tabindex="-1"></a><span class="st">          audio.currentTime -= 10;</span></span>
<span id="cb190-110"><a href="#cb190-110" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb190-111"><a href="#cb190-111" aria-hidden="true" tabindex="-1"></a><span class="st">        function skipForward() {</span></span>
<span id="cb190-112"><a href="#cb190-112" aria-hidden="true" tabindex="-1"></a><span class="st">          var audio = document.getElementById(&#39;narration&#39;);</span></span>
<span id="cb190-113"><a href="#cb190-113" aria-hidden="true" tabindex="-1"></a><span class="st">          audio.currentTime += 10;</span></span>
<span id="cb190-114"><a href="#cb190-114" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span></span>
<span id="cb190-115"><a href="#cb190-115" aria-hidden="true" tabindex="-1"></a><span class="st">        function changeSpeed() {</span></span>
<span id="cb190-116"><a href="#cb190-116" aria-hidden="true" tabindex="-1"></a><span class="st">          var audio = document.getElementById(&#39;narration&#39;);</span></span>
<span id="cb190-117"><a href="#cb190-117" aria-hidden="true" tabindex="-1"></a><span class="st">          var speed = document.getElementById(&#39;speed&#39;).value;</span></span>
<span id="cb190-118"><a href="#cb190-118" aria-hidden="true" tabindex="-1"></a><span class="st">          audio.playbackRate = parseFloat(speed);</span></span>
<span id="cb190-119"><a href="#cb190-119" aria-hidden="true" tabindex="-1"></a><span class="st">        }&quot;</span>)))))</span></code></pre></div>
<h2 id="configuration">Configuration</h2>
<h3 id="site-configuration-integration">Site Configuration
Integration</h3>
<div class="sourceCode" id="cb191"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; In shrdlu.config.rkt</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> site-config</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>  (shrdlu-configuration</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; ... other config ...</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>   #:features &#39;(markdown</span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>               syntax-highlighting</span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>               math</span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>               search</span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>               rss</span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>               sitemap</span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>               tts)  <span class="co">; Enable TTS feature</span></span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a>   #:tts-config</span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>   (tts-config</span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>    #:model &#39;coqui-vits  <span class="co">; or &#39;bark, &#39;silero</span></span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>    #:voice-id <span class="st">&quot;p225&quot;</span>    <span class="co">; Female voice</span></span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>    #:speed <span class="fl">1.0</span></span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a>    #:format &#39;mp3</span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a>    #:cache-dir <span class="st">&quot;_cache/tts&quot;</span></span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a>    #:max-cache-size (<span class="op">*</span> <span class="dv">100</span> <span class="dv">1024</span> <span class="dv">1024</span>))  <span class="co">; 100MB cache</span></span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a>   #:tts-options</span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a>   (hash &#39;enable-for-collections &#39;(blog articles)</span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a>         &#39;min-word-count <span class="dv">500</span>  <span class="co">; Only for longer posts</span></span>
<span id="cb191-26"><a href="#cb191-26" aria-hidden="true" tabindex="-1"></a>         &#39;include-player <span class="dv">#t</span></span>
<span id="cb191-27"><a href="#cb191-27" aria-hidden="true" tabindex="-1"></a>         &#39;pregenerate <span class="dv">#f</span>)))   <span class="co">; Generate on-demand</span></span></code></pre></div>
<h3 id="build-integration">Build Integration</h3>
<div class="sourceCode" id="cb192"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; shrdlu/build/tts.rkt</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(build-with-tts pages config)</span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>  (when (<span class="kw">member</span> &#39;tts (shrdlu-config-features config))</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> tts-config </span>(shrdlu-config-tts-config config))</span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>    (<span class="ex">define</span><span class="fu"> tts-options </span>(shrdlu-config-tts-options config))</span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>    (when (hash-ref tts-options &#39;pregenerate <span class="dv">#f</span>)</span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>      (displayln <span class="st">&quot;Pre-generating TTS narrations...&quot;</span>)</span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>      (for (<span class="op">[</span>page pages<span class="op">]</span>)</span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a>        (when (should-generate-tts? page tts-options)</span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a>          (displayln (format <span class="st">&quot;  Generating TTS for: ~a&quot;</span> </span>
<span id="cb192-15"><a href="#cb192-15" aria-hidden="true" tabindex="-1"></a>                            (document-title page)))</span>
<span id="cb192-16"><a href="#cb192-16" aria-hidden="true" tabindex="-1"></a>          (with-handlers (<span class="op">[</span>exn:fail? </span>
<span id="cb192-17"><a href="#cb192-17" aria-hidden="true" tabindex="-1"></a>                           (λ (e)</span>
<span id="cb192-18"><a href="#cb192-18" aria-hidden="true" tabindex="-1"></a>                             (displayln </span>
<span id="cb192-19"><a href="#cb192-19" aria-hidden="true" tabindex="-1"></a>                              (format <span class="st">&quot;  Warning: TTS failed for ~a: ~a&quot;</span></span>
<span id="cb192-20"><a href="#cb192-20" aria-hidden="true" tabindex="-1"></a>                                     (document-title page)</span>
<span id="cb192-21"><a href="#cb192-21" aria-hidden="true" tabindex="-1"></a>                                     (exn-message e))))<span class="op">]</span>)</span>
<span id="cb192-22"><a href="#cb192-22" aria-hidden="true" tabindex="-1"></a>            (generate-narration page tts-config)))))))</span>
<span id="cb192-23"><a href="#cb192-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-24"><a href="#cb192-24" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(should-generate-tts? page options)</span>
<span id="cb192-25"><a href="#cb192-25" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">and</span> (<span class="op">&gt;=</span> (document-word-count page)</span>
<span id="cb192-26"><a href="#cb192-26" aria-hidden="true" tabindex="-1"></a>           (hash-ref options &#39;min-word-count <span class="dv">0</span>))</span>
<span id="cb192-27"><a href="#cb192-27" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">member</span> (document-collection page)</span>
<span id="cb192-28"><a href="#cb192-28" aria-hidden="true" tabindex="-1"></a>               (hash-ref options &#39;enable-for-collections &#39;()))))</span>
<span id="cb192-29"><a href="#cb192-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-30"><a href="#cb192-30" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(add-tts-links doc)</span>
<span id="cb192-31"><a href="#cb192-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add TTS player link to document</span></span>
<span id="cb192-32"><a href="#cb192-32" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> tts-url </span>(format <span class="st">&quot;~a?fmt=tts-player&quot;</span> (document-url doc)))</span>
<span id="cb192-33"><a href="#cb192-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb192-34"><a href="#cb192-34" aria-hidden="true" tabindex="-1"></a>  (document-update-meta </span>
<span id="cb192-35"><a href="#cb192-35" aria-hidden="true" tabindex="-1"></a>   doc</span>
<span id="cb192-36"><a href="#cb192-36" aria-hidden="true" tabindex="-1"></a>   (hash-set (document-metadata doc)</span>
<span id="cb192-37"><a href="#cb192-37" aria-hidden="true" tabindex="-1"></a>             &#39;tts-url</span>
<span id="cb192-38"><a href="#cb192-38" aria-hidden="true" tabindex="-1"></a>             tts-url)))</span></code></pre></div>
<h2 id="frontend-integration">Frontend Integration</h2>
<h3 id="javascript-audio-player">JavaScript Audio Player</h3>
<div class="sourceCode" id="cb193"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co">// static/js/tts-player.js</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TTSPlayer {</span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">constructor</span>(element<span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">element</span> <span class="op">=</span> element<span class="op">;</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">audioUrl</span> <span class="op">=</span> options<span class="op">.</span><span class="at">audioUrl</span><span class="op">;</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">transcript</span> <span class="op">=</span> options<span class="op">.</span><span class="at">transcript</span> <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">audio</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">isPlaying</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">currentSpeed</span> <span class="op">=</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">init</span>()<span class="op">;</span></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">init</span>() {</span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">attachEventListeners</span>()<span class="op">;</span></span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">loadAudio</span>()<span class="op">;</span></span>
<span id="cb193-19"><a href="#cb193-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-20"><a href="#cb193-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-21"><a href="#cb193-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">render</span>() {</span>
<span id="cb193-22"><a href="#cb193-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb193-23"><a href="#cb193-23" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;tts-player&quot;&gt;</span></span>
<span id="cb193-24"><a href="#cb193-24" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;div class=&quot;tts-controls&quot;&gt;</span></span>
<span id="cb193-25"><a href="#cb193-25" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &lt;button class=&quot;play-pause&quot; aria-label=&quot;Play&quot;&gt;</span></span>
<span id="cb193-26"><a href="#cb193-26" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;svg class=&quot;play-icon&quot;&gt;&lt;!-- play icon --&gt;&lt;/svg&gt;</span></span>
<span id="cb193-27"><a href="#cb193-27" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;svg class=&quot;pause-icon&quot; style=&quot;display:none;&quot;&gt;&lt;!-- pause icon --&gt;&lt;/svg&gt;</span></span>
<span id="cb193-28"><a href="#cb193-28" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &lt;/button&gt;</span></span>
<span id="cb193-29"><a href="#cb193-29" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &lt;div class=&quot;progress-bar&quot;&gt;</span></span>
<span id="cb193-30"><a href="#cb193-30" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;div class=&quot;progress-fill&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb193-31"><a href="#cb193-31" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;div class=&quot;progress-handle&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb193-32"><a href="#cb193-32" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &lt;/div&gt;</span></span>
<span id="cb193-33"><a href="#cb193-33" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &lt;span class=&quot;time-display&quot;&gt;0:00 / 0:00&lt;/span&gt;</span></span>
<span id="cb193-34"><a href="#cb193-34" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &lt;select class=&quot;speed-control&quot;&gt;</span></span>
<span id="cb193-35"><a href="#cb193-35" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;option value=&quot;0.75&quot;&gt;0.75x&lt;/option&gt;</span></span>
<span id="cb193-36"><a href="#cb193-36" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;option value=&quot;1&quot; selected&gt;1x&lt;/option&gt;</span></span>
<span id="cb193-37"><a href="#cb193-37" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;option value=&quot;1.25&quot;&gt;1.25x&lt;/option&gt;</span></span>
<span id="cb193-38"><a href="#cb193-38" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;option value=&quot;1.5&quot;&gt;1.5x&lt;/option&gt;</span></span>
<span id="cb193-39"><a href="#cb193-39" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;option value=&quot;2&quot;&gt;2x&lt;/option&gt;</span></span>
<span id="cb193-40"><a href="#cb193-40" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &lt;/select&gt;</span></span>
<span id="cb193-41"><a href="#cb193-41" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;/div&gt;</span></span>
<span id="cb193-42"><a href="#cb193-42" aria-hidden="true" tabindex="-1"></a><span class="vs">                </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">transcript</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb193-43"><a href="#cb193-43" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &lt;details class=&quot;tts-transcript&quot;&gt;</span></span>
<span id="cb193-44"><a href="#cb193-44" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;summary&gt;Show Transcript&lt;/summary&gt;</span></span>
<span id="cb193-45"><a href="#cb193-45" aria-hidden="true" tabindex="-1"></a><span class="vs">                        &lt;div class=&quot;transcript-content&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">transcript</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb193-46"><a href="#cb193-46" aria-hidden="true" tabindex="-1"></a><span class="vs">                    &lt;/details&gt;</span></span>
<span id="cb193-47"><a href="#cb193-47" aria-hidden="true" tabindex="-1"></a><span class="vs">                `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb193-48"><a href="#cb193-48" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/div&gt;</span></span>
<span id="cb193-49"><a href="#cb193-49" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span><span class="op">;</span></span>
<span id="cb193-50"><a href="#cb193-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-51"><a href="#cb193-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-52"><a href="#cb193-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loadAudio</span>() {</span>
<span id="cb193-53"><a href="#cb193-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">audio</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Audio</span>(<span class="kw">this</span><span class="op">.</span><span class="at">audioUrl</span>)<span class="op">;</span></span>
<span id="cb193-54"><a href="#cb193-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;loadedmetadata&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb193-55"><a href="#cb193-55" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">updateTimeDisplay</span>()<span class="op">;</span></span>
<span id="cb193-56"><a href="#cb193-56" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb193-57"><a href="#cb193-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-58"><a href="#cb193-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;timeupdate&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb193-59"><a href="#cb193-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">updateProgress</span>()<span class="op">;</span></span>
<span id="cb193-60"><a href="#cb193-60" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">updateTimeDisplay</span>()<span class="op">;</span></span>
<span id="cb193-61"><a href="#cb193-61" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb193-62"><a href="#cb193-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-63"><a href="#cb193-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;ended&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb193-64"><a href="#cb193-64" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="at">isPlaying</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb193-65"><a href="#cb193-65" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">updatePlayButton</span>()<span class="op">;</span></span>
<span id="cb193-66"><a href="#cb193-66" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb193-67"><a href="#cb193-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-68"><a href="#cb193-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-69"><a href="#cb193-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">attachEventListeners</span>() {</span>
<span id="cb193-70"><a href="#cb193-70" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> playButton <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.play-pause&#39;</span>)<span class="op">;</span></span>
<span id="cb193-71"><a href="#cb193-71" aria-hidden="true" tabindex="-1"></a>        playButton<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">togglePlay</span>())<span class="op">;</span></span>
<span id="cb193-72"><a href="#cb193-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-73"><a href="#cb193-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> speedControl <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.speed-control&#39;</span>)<span class="op">;</span></span>
<span id="cb193-74"><a href="#cb193-74" aria-hidden="true" tabindex="-1"></a>        speedControl<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;change&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb193-75"><a href="#cb193-75" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="at">currentSpeed</span> <span class="op">=</span> <span class="pp">parseFloat</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb193-76"><a href="#cb193-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">audio</span>) {</span>
<span id="cb193-77"><a href="#cb193-77" aria-hidden="true" tabindex="-1"></a>                <span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="at">playbackRate</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentSpeed</span><span class="op">;</span></span>
<span id="cb193-78"><a href="#cb193-78" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb193-79"><a href="#cb193-79" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb193-80"><a href="#cb193-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-81"><a href="#cb193-81" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> progressBar <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.progress-bar&#39;</span>)<span class="op">;</span></span>
<span id="cb193-82"><a href="#cb193-82" aria-hidden="true" tabindex="-1"></a>        progressBar<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb193-83"><a href="#cb193-83" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> rect <span class="op">=</span> progressBar<span class="op">.</span><span class="fu">getBoundingClientRect</span>()<span class="op">;</span></span>
<span id="cb193-84"><a href="#cb193-84" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> percent <span class="op">=</span> (e<span class="op">.</span><span class="at">clientX</span> <span class="op">-</span> rect<span class="op">.</span><span class="at">left</span>) <span class="op">/</span> rect<span class="op">.</span><span class="at">width</span><span class="op">;</span></span>
<span id="cb193-85"><a href="#cb193-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">audio</span>) {</span>
<span id="cb193-86"><a href="#cb193-86" aria-hidden="true" tabindex="-1"></a>                <span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="at">currentTime</span> <span class="op">=</span> percent <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="at">duration</span><span class="op">;</span></span>
<span id="cb193-87"><a href="#cb193-87" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb193-88"><a href="#cb193-88" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb193-89"><a href="#cb193-89" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-90"><a href="#cb193-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-91"><a href="#cb193-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">togglePlay</span>() {</span>
<span id="cb193-92"><a href="#cb193-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">audio</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb193-93"><a href="#cb193-93" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-94"><a href="#cb193-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">isPlaying</span>) {</span>
<span id="cb193-95"><a href="#cb193-95" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="fu">pause</span>()<span class="op">;</span></span>
<span id="cb193-96"><a href="#cb193-96" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb193-97"><a href="#cb193-97" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="fu">play</span>()<span class="op">;</span></span>
<span id="cb193-98"><a href="#cb193-98" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb193-99"><a href="#cb193-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-100"><a href="#cb193-100" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">isPlaying</span> <span class="op">=</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">isPlaying</span><span class="op">;</span></span>
<span id="cb193-101"><a href="#cb193-101" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">updatePlayButton</span>()<span class="op">;</span></span>
<span id="cb193-102"><a href="#cb193-102" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-103"><a href="#cb193-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-104"><a href="#cb193-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updatePlayButton</span>() {</span>
<span id="cb193-105"><a href="#cb193-105" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> playIcon <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.play-icon&#39;</span>)<span class="op">;</span></span>
<span id="cb193-106"><a href="#cb193-106" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> pauseIcon <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.pause-icon&#39;</span>)<span class="op">;</span></span>
<span id="cb193-107"><a href="#cb193-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-108"><a href="#cb193-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">isPlaying</span>) {</span>
<span id="cb193-109"><a href="#cb193-109" aria-hidden="true" tabindex="-1"></a>            playIcon<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;none&#39;</span><span class="op">;</span></span>
<span id="cb193-110"><a href="#cb193-110" aria-hidden="true" tabindex="-1"></a>            pauseIcon<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;block&#39;</span><span class="op">;</span></span>
<span id="cb193-111"><a href="#cb193-111" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb193-112"><a href="#cb193-112" aria-hidden="true" tabindex="-1"></a>            playIcon<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;block&#39;</span><span class="op">;</span></span>
<span id="cb193-113"><a href="#cb193-113" aria-hidden="true" tabindex="-1"></a>            pauseIcon<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;none&#39;</span><span class="op">;</span></span>
<span id="cb193-114"><a href="#cb193-114" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb193-115"><a href="#cb193-115" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-116"><a href="#cb193-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-117"><a href="#cb193-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateProgress</span>() {</span>
<span id="cb193-118"><a href="#cb193-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">audio</span> <span class="op">||</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="at">duration</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb193-119"><a href="#cb193-119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-120"><a href="#cb193-120" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> percent <span class="op">=</span> (<span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="at">currentTime</span> <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="at">duration</span>) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb193-121"><a href="#cb193-121" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> progressFill <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.progress-fill&#39;</span>)<span class="op">;</span></span>
<span id="cb193-122"><a href="#cb193-122" aria-hidden="true" tabindex="-1"></a>        progressFill<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>percent<span class="sc">}</span><span class="vs">%`</span><span class="op">;</span></span>
<span id="cb193-123"><a href="#cb193-123" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-124"><a href="#cb193-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-125"><a href="#cb193-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateTimeDisplay</span>() {</span>
<span id="cb193-126"><a href="#cb193-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">audio</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb193-127"><a href="#cb193-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb193-128"><a href="#cb193-128" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> current <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">formatTime</span>(<span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="at">currentTime</span>)<span class="op">;</span></span>
<span id="cb193-129"><a href="#cb193-129" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> duration <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">formatTime</span>(<span class="kw">this</span><span class="op">.</span><span class="at">audio</span><span class="op">.</span><span class="at">duration</span> <span class="op">||</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb193-130"><a href="#cb193-130" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> display <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.time-display&#39;</span>)<span class="op">;</span></span>
<span id="cb193-131"><a href="#cb193-131" aria-hidden="true" tabindex="-1"></a>        display<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>current<span class="sc">}</span><span class="vs"> / </span><span class="sc">${</span>duration<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb193-132"><a href="#cb193-132" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-133"><a href="#cb193-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-134"><a href="#cb193-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">formatTime</span>(seconds) {</span>
<span id="cb193-135"><a href="#cb193-135" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> minutes <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(seconds <span class="op">/</span> <span class="dv">60</span>)<span class="op">;</span></span>
<span id="cb193-136"><a href="#cb193-136" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> secs <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(seconds <span class="op">%</span> <span class="dv">60</span>)<span class="op">;</span></span>
<span id="cb193-137"><a href="#cb193-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>minutes<span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>secs<span class="op">.</span><span class="fu">toString</span>()<span class="op">.</span><span class="fu">padStart</span>(<span class="dv">2</span><span class="op">,</span> <span class="st">&#39;0&#39;</span>)<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb193-138"><a href="#cb193-138" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb193-139"><a href="#cb193-139" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb193-140"><a href="#cb193-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-141"><a href="#cb193-141" aria-hidden="true" tabindex="-1"></a><span class="co">// Auto-initialize players</span></span>
<span id="cb193-142"><a href="#cb193-142" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;DOMContentLoaded&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb193-143"><a href="#cb193-143" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> players <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;[data-tts-player]&#39;</span>)<span class="op">;</span></span>
<span id="cb193-144"><a href="#cb193-144" aria-hidden="true" tabindex="-1"></a>    players<span class="op">.</span><span class="fu">forEach</span>(el <span class="kw">=&gt;</span> {</span>
<span id="cb193-145"><a href="#cb193-145" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> options <span class="op">=</span> {</span>
<span id="cb193-146"><a href="#cb193-146" aria-hidden="true" tabindex="-1"></a>            <span class="dt">audioUrl</span><span class="op">:</span> el<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">ttsUrl</span><span class="op">,</span></span>
<span id="cb193-147"><a href="#cb193-147" aria-hidden="true" tabindex="-1"></a>            <span class="dt">transcript</span><span class="op">:</span> el<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">ttsTranscript</span></span>
<span id="cb193-148"><a href="#cb193-148" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb193-149"><a href="#cb193-149" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="fu">TTSPlayer</span>(el<span class="op">,</span> options)<span class="op">;</span></span>
<span id="cb193-150"><a href="#cb193-150" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb193-151"><a href="#cb193-151" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 id="production-considerations">Production Considerations</h2>
<h3 id="performance-optimization-2">Performance Optimization</h3>
<div class="sourceCode" id="cb194"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; shrdlu/tts/optimizer.rkt</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(optimize-for-tts text)</span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Pre-process text for better TTS output</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>  (compose</span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>   normalize-whitespace</span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>   expand-abbreviations</span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a>   fix-pronunciations</span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>   add-pauses)</span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>  text)</span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(expand-abbreviations text)</span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> abbrevs</span></span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a>    &#39;((<span class="st">&quot;Dr.&quot;</span> <span class="op">.</span> <span class="st">&quot;Doctor&quot;</span>)</span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;Mr.&quot;</span> <span class="op">.</span> <span class="st">&quot;Mister&quot;</span>)</span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;Mrs.&quot;</span> <span class="op">.</span> <span class="st">&quot;Missus&quot;</span>)</span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;etc.&quot;</span> <span class="op">.</span> <span class="st">&quot;et cetera&quot;</span>)</span>
<span id="cb194-19"><a href="#cb194-19" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;vs.&quot;</span> <span class="op">.</span> <span class="st">&quot;versus&quot;</span>)</span>
<span id="cb194-20"><a href="#cb194-20" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;e.g.&quot;</span> <span class="op">.</span> <span class="st">&quot;for example&quot;</span>)</span>
<span id="cb194-21"><a href="#cb194-21" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;i.e.&quot;</span> <span class="op">.</span> <span class="st">&quot;that is&quot;</span>)))</span>
<span id="cb194-22"><a href="#cb194-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb194-23"><a href="#cb194-23" aria-hidden="true" tabindex="-1"></a>  (for/fold (<span class="op">[</span>result text<span class="op">]</span>)</span>
<span id="cb194-24"><a href="#cb194-24" aria-hidden="true" tabindex="-1"></a>            (<span class="op">[</span>pair abbrevs<span class="op">]</span>)</span>
<span id="cb194-25"><a href="#cb194-25" aria-hidden="true" tabindex="-1"></a>    (regexp-replace* (regexp-quote (<span class="kw">car</span> pair))</span>
<span id="cb194-26"><a href="#cb194-26" aria-hidden="true" tabindex="-1"></a>                     result</span>
<span id="cb194-27"><a href="#cb194-27" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">cdr</span> pair))))</span>
<span id="cb194-28"><a href="#cb194-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-29"><a href="#cb194-29" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(fix-pronunciations text)</span>
<span id="cb194-30"><a href="#cb194-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Fix common mispronunciations</span></span>
<span id="cb194-31"><a href="#cb194-31" aria-hidden="true" tabindex="-1"></a>  (<span class="ex">define</span><span class="fu"> fixes</span></span>
<span id="cb194-32"><a href="#cb194-32" aria-hidden="true" tabindex="-1"></a>    &#39;((<span class="st">&quot;SQL&quot;</span> <span class="op">.</span> <span class="st">&quot;sequel&quot;</span>)</span>
<span id="cb194-33"><a href="#cb194-33" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;PostgreSQL&quot;</span> <span class="op">.</span> <span class="st">&quot;postgres sequel&quot;</span>)</span>
<span id="cb194-34"><a href="#cb194-34" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;MySQL&quot;</span> <span class="op">.</span> <span class="st">&quot;my sequel&quot;</span>)</span>
<span id="cb194-35"><a href="#cb194-35" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;GUI&quot;</span> <span class="op">.</span> <span class="st">&quot;gooey&quot;</span>)</span>
<span id="cb194-36"><a href="#cb194-36" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;CLI&quot;</span> <span class="op">.</span> <span class="st">&quot;C L I&quot;</span>)))</span>
<span id="cb194-37"><a href="#cb194-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb194-38"><a href="#cb194-38" aria-hidden="true" tabindex="-1"></a>  (for/fold (<span class="op">[</span>result text<span class="op">]</span>)</span>
<span id="cb194-39"><a href="#cb194-39" aria-hidden="true" tabindex="-1"></a>            (<span class="op">[</span>pair fixes<span class="op">]</span>)</span>
<span id="cb194-40"><a href="#cb194-40" aria-hidden="true" tabindex="-1"></a>    (regexp-replace* (regexp (format <span class="st">&quot;</span><span class="ch">\\</span><span class="st">b~a</span><span class="ch">\\</span><span class="st">b&quot;</span> (<span class="kw">car</span> pair)))</span>
<span id="cb194-41"><a href="#cb194-41" aria-hidden="true" tabindex="-1"></a>                     result</span>
<span id="cb194-42"><a href="#cb194-42" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">cdr</span> pair))))</span>
<span id="cb194-43"><a href="#cb194-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-44"><a href="#cb194-44" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(add-pauses text)</span>
<span id="cb194-45"><a href="#cb194-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Add pauses after headings and between sections</span></span>
<span id="cb194-46"><a href="#cb194-46" aria-hidden="true" tabindex="-1"></a>  (regexp-replace* #rx<span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">+&quot;</span> </span>
<span id="cb194-47"><a href="#cb194-47" aria-hidden="true" tabindex="-1"></a>                   text</span>
<span id="cb194-48"><a href="#cb194-48" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">... </span><span class="ch">\n\n</span><span class="st">&quot;</span>))</span></code></pre></div>
<h3 id="error-handling">Error Handling</h3>
<div class="sourceCode" id="cb195"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(safe-generate-narration doc config)</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>  (with-handlers (<span class="op">[</span>exn:fail:filesystem?</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>                   (λ (e)</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>                     (log-error <span class="st">&quot;TTS filesystem error: ~a&quot;</span> </span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>                               (exn-message e))</span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>                     <span class="dv">#f</span>)<span class="op">]</span></span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>exn:fail:network?</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>                   (λ (e)</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>                     (log-error <span class="st">&quot;TTS network error: ~a&quot;</span></span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>                               (exn-message e))</span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>                     <span class="dv">#f</span>)<span class="op">]</span></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>                  <span class="op">[</span>exn:fail?</span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>                   (λ (e)</span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>                     (log-error <span class="st">&quot;TTS generation failed: ~a&quot;</span></span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>                               (exn-message e))</span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>                     <span class="dv">#f</span>)<span class="op">]</span>)</span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>    (generate-narration doc config)))</span></code></pre></div>
<h2 id="summary-5">Summary</h2>
<p>This chapter has shown how to integrate free, open-source LLM-based
TTS systems into your Shrdlu static site generator. The implementation
provides:</p>
<ol type="1">
<li><strong>Multiple TTS Engine Support</strong>: Integration with Coqui
TTS and Bark for different voice qualities</li>
<li><strong>Smart Caching</strong>: Efficient storage and retrieval of
generated audio</li>
<li><strong>Web Integration</strong>: Seamless serving of audio files
with proper HTTP headers</li>
<li><strong>Rich Player Interface</strong>: HTML5 audio player with
speed controls and transcript display</li>
<li><strong>Build System Integration</strong>: Options for on-demand or
pre-generated narrations</li>
<li><strong>Performance Optimization</strong>: Text preprocessing for
better speech synthesis</li>
</ol>
<p>The system gracefully handles errors and provides a professional
narration experience for your site visitors, making content more
accessible to users who prefer audio consumption. # Appendix A: Complete
Shrdlu Language Reference</p>
<h2 id="language-overview">Language Overview</h2>
<p>Shrdlu is a language-oriented static site generator built on Racket’s
macro system. This reference documents all language forms, reader
extensions, built-in functions, and configuration options available in
Shrdlu.</p>
<h2 id="core-language-forms">Core Language Forms</h2>
<h3 id="document-definition">Document Definition</h3>
<div class="sourceCode" id="cb196"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Basic document structure</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>#lang shrdlu</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>#:title <span class="st">&quot;Document Title&quot;</span></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>#:date <span class="dv">2025-01-15</span></span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>#:author <span class="st">&quot;Author Name&quot;</span></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>#:tags <span class="op">[</span><span class="st">&quot;tag1&quot;</span> <span class="st">&quot;tag2&quot;</span> <span class="st">&quot;tag3&quot;</span><span class="op">]</span></span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>#:draft <span class="dv">#f</span></span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>#:template <span class="st">&quot;custom-template&quot;</span></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>#:slug <span class="st">&quot;custom-url-slug&quot;</span></span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a>#:description <span class="st">&quot;Meta description for SEO&quot;</span></span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a>#:featured-image <span class="st">&quot;path/to/image.jpg&quot;</span></span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; Document content follows...</span></span></code></pre></div>
<h3 id="content-elements">Content Elements</h3>
<div class="sourceCode" id="cb197"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Headings (multiple syntaxes supported)</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>(heading <span class="dv">1</span> <span class="st">&quot;Main Title&quot;</span>)</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a># Main Title (markdown-style)</span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>@title<span class="op">{</span>Main Title<span class="op">}</span> (scribble-style)</span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Paragraphs</span></span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>(para <span class="st">&quot;Content&quot;</span> (bold <span class="st">&quot;emphasis&quot;</span>) <span class="st">&quot;more content&quot;</span>)</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>@para<span class="op">{</span>Content with @bold<span class="op">{</span>emphasis<span class="op">}</span> included<span class="op">}</span></span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a><span class="co">;; Lists</span></span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>(itemlist </span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>  (item <span class="st">&quot;First item&quot;</span>)</span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a>  (item <span class="st">&quot;Second item&quot;</span> </span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a>        (itemlist </span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a>          (item <span class="st">&quot;Nested item&quot;</span>))))</span>
<span id="cb197-16"><a href="#cb197-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-17"><a href="#cb197-17" aria-hidden="true" tabindex="-1"></a>(enumlist  <span class="co">; Numbered list</span></span>
<span id="cb197-18"><a href="#cb197-18" aria-hidden="true" tabindex="-1"></a>  (item <span class="st">&quot;First&quot;</span>)</span>
<span id="cb197-19"><a href="#cb197-19" aria-hidden="true" tabindex="-1"></a>  (item <span class="st">&quot;Second&quot;</span>))</span>
<span id="cb197-20"><a href="#cb197-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-21"><a href="#cb197-21" aria-hidden="true" tabindex="-1"></a><span class="co">;; Code blocks</span></span>
<span id="cb197-22"><a href="#cb197-22" aria-hidden="true" tabindex="-1"></a>(codeblock </span>
<span id="cb197-23"><a href="#cb197-23" aria-hidden="true" tabindex="-1"></a>  #:lang <span class="st">&quot;racket&quot;</span></span>
<span id="cb197-24"><a href="#cb197-24" aria-hidden="true" tabindex="-1"></a>  #:line-numbers <span class="dv">#t</span></span>
<span id="cb197-25"><a href="#cb197-25" aria-hidden="true" tabindex="-1"></a>  #:highlight &#39;(<span class="dv">3</span> <span class="dv">5-7</span>)</span>
<span id="cb197-26"><a href="#cb197-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;your code here&quot;</span>)</span>
<span id="cb197-27"><a href="#cb197-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-28"><a href="#cb197-28" aria-hidden="true" tabindex="-1"></a>@codeblock<span class="op">[</span>#:lang <span class="st">&quot;python&quot;</span><span class="op">]{</span></span>
<span id="cb197-29"><a href="#cb197-29" aria-hidden="true" tabindex="-1"></a>def hello():</span>
<span id="cb197-30"><a href="#cb197-30" aria-hidden="true" tabindex="-1"></a>    print(<span class="st">&quot;Hello, World!&quot;</span>)</span>
<span id="cb197-31"><a href="#cb197-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb197-32"><a href="#cb197-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-33"><a href="#cb197-33" aria-hidden="true" tabindex="-1"></a><span class="co">;; Links</span></span>
<span id="cb197-34"><a href="#cb197-34" aria-hidden="true" tabindex="-1"></a>(link <span class="st">&quot;https://example.com&quot;</span> <span class="st">&quot;Link text&quot;</span>)</span>
<span id="cb197-35"><a href="#cb197-35" aria-hidden="true" tabindex="-1"></a>(link #:internal <span class="st">&quot;about&quot;</span> <span class="st">&quot;About page&quot;</span>)</span>
<span id="cb197-36"><a href="#cb197-36" aria-hidden="true" tabindex="-1"></a>(link #:anchor <span class="st">&quot;section-id&quot;</span> <span class="st">&quot;Jump to section&quot;</span>)</span>
<span id="cb197-37"><a href="#cb197-37" aria-hidden="true" tabindex="-1"></a>@link<span class="op">[</span><span class="st">&quot;https://example.com&quot;</span><span class="op">]{</span>Link text<span class="op">}</span></span>
<span id="cb197-38"><a href="#cb197-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-39"><a href="#cb197-39" aria-hidden="true" tabindex="-1"></a><span class="co">;; Images</span></span>
<span id="cb197-40"><a href="#cb197-40" aria-hidden="true" tabindex="-1"></a>(image <span class="st">&quot;path/to/image.jpg&quot;</span> </span>
<span id="cb197-41"><a href="#cb197-41" aria-hidden="true" tabindex="-1"></a>       #:alt <span class="st">&quot;Description&quot;</span></span>
<span id="cb197-42"><a href="#cb197-42" aria-hidden="true" tabindex="-1"></a>       #:width <span class="dv">800</span></span>
<span id="cb197-43"><a href="#cb197-43" aria-hidden="true" tabindex="-1"></a>       #:height <span class="dv">600</span></span>
<span id="cb197-44"><a href="#cb197-44" aria-hidden="true" tabindex="-1"></a>       #:lazy <span class="dv">#t</span></span>
<span id="cb197-45"><a href="#cb197-45" aria-hidden="true" tabindex="-1"></a>       #:caption <span class="st">&quot;Image caption&quot;</span>)</span>
<span id="cb197-46"><a href="#cb197-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-47"><a href="#cb197-47" aria-hidden="true" tabindex="-1"></a><span class="co">;; Block quotes</span></span>
<span id="cb197-48"><a href="#cb197-48" aria-hidden="true" tabindex="-1"></a>(blockquote </span>
<span id="cb197-49"><a href="#cb197-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Quote content&quot;</span></span>
<span id="cb197-50"><a href="#cb197-50" aria-hidden="true" tabindex="-1"></a>  #:cite <span class="st">&quot;Author Name&quot;</span>)</span>
<span id="cb197-51"><a href="#cb197-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-52"><a href="#cb197-52" aria-hidden="true" tabindex="-1"></a>@blockquote<span class="op">{</span></span>
<span id="cb197-53"><a href="#cb197-53" aria-hidden="true" tabindex="-1"></a>  This is a longer <span class="kw">quote</span> that can span</span>
<span id="cb197-54"><a href="#cb197-54" aria-hidden="true" tabindex="-1"></a>  multiple lines.</span>
<span id="cb197-55"><a href="#cb197-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb197-56"><a href="#cb197-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-57"><a href="#cb197-57" aria-hidden="true" tabindex="-1"></a><span class="co">;; Tables</span></span>
<span id="cb197-58"><a href="#cb197-58" aria-hidden="true" tabindex="-1"></a>(table </span>
<span id="cb197-59"><a href="#cb197-59" aria-hidden="true" tabindex="-1"></a>  #:headers &#39;(<span class="st">&quot;Column 1&quot;</span> <span class="st">&quot;Column 2&quot;</span> <span class="st">&quot;Column 3&quot;</span>)</span>
<span id="cb197-60"><a href="#cb197-60" aria-hidden="true" tabindex="-1"></a>  #:align &#39;(left center right)</span>
<span id="cb197-61"><a href="#cb197-61" aria-hidden="true" tabindex="-1"></a>  (row <span class="st">&quot;A1&quot;</span> <span class="st">&quot;B1&quot;</span> <span class="st">&quot;C1&quot;</span>)</span>
<span id="cb197-62"><a href="#cb197-62" aria-hidden="true" tabindex="-1"></a>  (row <span class="st">&quot;A2&quot;</span> <span class="st">&quot;B2&quot;</span> <span class="st">&quot;C2&quot;</span>))</span>
<span id="cb197-63"><a href="#cb197-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-64"><a href="#cb197-64" aria-hidden="true" tabindex="-1"></a><span class="co">;; Mathematical expressions</span></span>
<span id="cb197-65"><a href="#cb197-65" aria-hidden="true" tabindex="-1"></a>(math <span class="st">&quot;</span><span class="ch">\\</span><span class="st">sum_{i=1}^{n} i = </span><span class="ch">\\</span><span class="st">frac{n(n+1)}{2}&quot;</span>)</span>
<span id="cb197-66"><a href="#cb197-66" aria-hidden="true" tabindex="-1"></a>(math #:display <span class="dv">#t</span> <span class="st">&quot;E = mc^2&quot;</span>)</span>
<span id="cb197-67"><a href="#cb197-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-68"><a href="#cb197-68" aria-hidden="true" tabindex="-1"></a><span class="co">;; Footnotes</span></span>
<span id="cb197-69"><a href="#cb197-69" aria-hidden="true" tabindex="-1"></a>(footnote <span class="st">&quot;ref-id&quot;</span> <span class="st">&quot;Footnote content&quot;</span>)</span>
<span id="cb197-70"><a href="#cb197-70" aria-hidden="true" tabindex="-1"></a>Some text(footnote-ref <span class="st">&quot;ref-id&quot;</span>) continues.</span>
<span id="cb197-71"><a href="#cb197-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-72"><a href="#cb197-72" aria-hidden="true" tabindex="-1"></a><span class="co">;; Custom HTML</span></span>
<span id="cb197-73"><a href="#cb197-73" aria-hidden="true" tabindex="-1"></a>(raw-html <span class="st">&quot;&lt;div class=&#39;custom&#39;&gt;Content&lt;/div&gt;&quot;</span>)</span>
<span id="cb197-74"><a href="#cb197-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-75"><a href="#cb197-75" aria-hidden="true" tabindex="-1"></a><span class="co">;; Includes</span></span>
<span id="cb197-76"><a href="#cb197-76" aria-hidden="true" tabindex="-1"></a>(include <span class="st">&quot;partials/header.rkt&quot;</span>)</span>
<span id="cb197-77"><a href="#cb197-77" aria-hidden="true" tabindex="-1"></a>(include-markdown <span class="st">&quot;content/section.md&quot;</span>)</span></code></pre></div>
<h2 id="reader-extensions">Reader Extensions</h2>
<h3 id="hash-lang-reader">Hash-lang Reader</h3>
<div class="sourceCode" id="cb198"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>#lang shrdlu</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; Reader literals</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>#px<span class="st">&quot;regex-pattern&quot;</span>        <span class="co">; Perl-compatible regex</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>#hash((key <span class="op">.</span> value))      <span class="co">; Hash table literal</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>#(<span class="kw">vector</span> elements)        <span class="co">; Vector literal</span></span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>#rx<span class="st">&quot;racket-regex&quot;</span>         <span class="co">; Racket regex</span></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Custom reader extensions</span></span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a>@<span class="op">{...}</span>                    <span class="co">; Scribble-style syntax</span></span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a><span class="op">${</span>variable<span class="op">}</span>               <span class="co">; Variable interpolation</span></span>
<span id="cb198-12"><a href="#cb198-12" aria-hidden="true" tabindex="-1"></a>%<span class="op">{</span>metadata<span class="op">}</span>               <span class="co">; Metadata reference</span></span>
<span id="cb198-13"><a href="#cb198-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-14"><a href="#cb198-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; At-expressions</span></span>
<span id="cb198-15"><a href="#cb198-15" aria-hidden="true" tabindex="-1"></a>@function<span class="op">[</span>args<span class="op">]{</span>body<span class="op">}</span></span>
<span id="cb198-16"><a href="#cb198-16" aria-hidden="true" tabindex="-1"></a>@function<span class="op">{</span>single-arg<span class="op">}</span></span>
<span id="cb198-17"><a href="#cb198-17" aria-hidden="true" tabindex="-1"></a>@(racket-expr)</span>
<span id="cb198-18"><a href="#cb198-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-19"><a href="#cb198-19" aria-hidden="true" tabindex="-1"></a><span class="co">;; Special literals</span></span>
<span id="cb198-20"><a href="#cb198-20" aria-hidden="true" tabindex="-1"></a>#:keyword value           <span class="co">; Keyword arguments</span></span>
<span id="cb198-21"><a href="#cb198-21" aria-hidden="true" tabindex="-1"></a>&#39;symbol                   <span class="co">; Quoted symbol</span></span>
<span id="cb198-22"><a href="#cb198-22" aria-hidden="true" tabindex="-1"></a>`(quasi ,unquote)        <span class="co">; Quasiquote</span></span></code></pre></div>
<h3 id="markdown-integration">Markdown Integration</h3>
<div class="sourceCode" id="cb199"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>#lang shrdlu/markdown</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a># Markdown Heading</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>Regular **markdown** <span class="kw">syntax</span> with *emphasis*.</span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>```scheme</span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Code blocks with syntax highlighting</span></span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(hello) <span class="st">&quot;world&quot;</span>)</span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> List item <span class="dv">1</span></span>
<span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> List item <span class="dv">2</span></span>
<span id="cb199-13"><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span> Nested item</span>
<span id="cb199-14"><a href="#cb199-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-15"><a href="#cb199-15" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>Link<span class="op">]</span>(url) <span class="kw">and</span> <span class="op">![</span>Image<span class="op">]</span>(path.jpg)</span>
<span id="cb199-16"><a href="#cb199-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-17"><a href="#cb199-17" aria-hidden="true" tabindex="-1"></a>&lt;!-- Shrdlu extensions in markdown --&gt;</span>
<span id="cb199-18"><a href="#cb199-18" aria-hidden="true" tabindex="-1"></a>@include<span class="op">{</span>header.rkt<span class="op">}</span></span>
<span id="cb199-19"><a href="#cb199-19" aria-hidden="true" tabindex="-1"></a>@macro<span class="op">{</span>custom-content<span class="op">}</span></span>
<span id="cb199-20"><a href="#cb199-20" aria-hidden="true" tabindex="-1"></a><span class="op">${</span>site.title<span class="op">}</span></span>
<span id="cb199-21"><a href="#cb199-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-22"><a href="#cb199-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-23"><a href="#cb199-23" aria-hidden="true" tabindex="-1"></a>## Built-in Functions <span class="kw">and</span> Macros</span>
<span id="cb199-24"><a href="#cb199-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-25"><a href="#cb199-25" aria-hidden="true" tabindex="-1"></a>### Document Manipulation</span>
<span id="cb199-26"><a href="#cb199-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-27"><a href="#cb199-27" aria-hidden="true" tabindex="-1"></a>```scheme</span>
<span id="cb199-28"><a href="#cb199-28" aria-hidden="true" tabindex="-1"></a><span class="co">;; Document creation</span></span>
<span id="cb199-29"><a href="#cb199-29" aria-hidden="true" tabindex="-1"></a>(document </span>
<span id="cb199-30"><a href="#cb199-30" aria-hidden="true" tabindex="-1"></a>  #:title <span class="kw">string?</span></span>
<span id="cb199-31"><a href="#cb199-31" aria-hidden="true" tabindex="-1"></a>  #:content content?</span>
<span id="cb199-32"><a href="#cb199-32" aria-hidden="true" tabindex="-1"></a>  #:metadata hash?)</span>
<span id="cb199-33"><a href="#cb199-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-34"><a href="#cb199-34" aria-hidden="true" tabindex="-1"></a><span class="co">;; Document queries</span></span>
<span id="cb199-35"><a href="#cb199-35" aria-hidden="true" tabindex="-1"></a>(current-document)                  <span class="co">; Get current document</span></span>
<span id="cb199-36"><a href="#cb199-36" aria-hidden="true" tabindex="-1"></a>(document-metadata doc <span class="op">[</span>key<span class="op">]</span>)       <span class="co">; Access metadata</span></span>
<span id="cb199-37"><a href="#cb199-37" aria-hidden="true" tabindex="-1"></a>(update-document doc key value)     <span class="co">; Update document</span></span>
<span id="cb199-38"><a href="#cb199-38" aria-hidden="true" tabindex="-1"></a>(document-&gt;html doc)                <span class="co">; Render to HTML</span></span>
<span id="cb199-39"><a href="#cb199-39" aria-hidden="true" tabindex="-1"></a>(document-&gt;sxml doc)                <span class="co">; Convert to SXML</span></span>
<span id="cb199-40"><a href="#cb199-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-41"><a href="#cb199-41" aria-hidden="true" tabindex="-1"></a><span class="co">;; Page management</span></span>
<span id="cb199-42"><a href="#cb199-42" aria-hidden="true" tabindex="-1"></a>(current-page)                      <span class="co">; Current page context</span></span>
<span id="cb199-43"><a href="#cb199-43" aria-hidden="true" tabindex="-1"></a>(page-url page)                    <span class="co">; Get page URL</span></span>
<span id="cb199-44"><a href="#cb199-44" aria-hidden="true" tabindex="-1"></a>(page-path page)                   <span class="co">; Get file path</span></span>
<span id="cb199-45"><a href="#cb199-45" aria-hidden="true" tabindex="-1"></a>(all-pages)                        <span class="co">; List all pages</span></span>
<span id="cb199-46"><a href="#cb199-46" aria-hidden="true" tabindex="-1"></a>(find-pages-by-tag tag)           <span class="co">; Find by tag</span></span>
<span id="cb199-47"><a href="#cb199-47" aria-hidden="true" tabindex="-1"></a>(find-pages-by-author author)     <span class="co">; Find by author</span></span>
<span id="cb199-48"><a href="#cb199-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-49"><a href="#cb199-49" aria-hidden="true" tabindex="-1"></a><span class="co">;; Collections</span></span>
<span id="cb199-50"><a href="#cb199-50" aria-hidden="true" tabindex="-1"></a>(define-collection name </span>
<span id="cb199-51"><a href="#cb199-51" aria-hidden="true" tabindex="-1"></a>  #:source pattern</span>
<span id="cb199-52"><a href="#cb199-52" aria-hidden="true" tabindex="-1"></a>  #:sort-by field</span>
<span id="cb199-53"><a href="#cb199-53" aria-hidden="true" tabindex="-1"></a>  #:filter predicate)</span>
<span id="cb199-54"><a href="#cb199-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-55"><a href="#cb199-55" aria-hidden="true" tabindex="-1"></a>(collection-pages collection-name)</span>
<span id="cb199-56"><a href="#cb199-56" aria-hidden="true" tabindex="-1"></a>(paginate collection #:per-page <span class="dv">10</span>)</span></code></pre></div>
<h3 id="template-system-1">Template System</h3>
<div class="sourceCode" id="cb200"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template definition</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>(define-template name (params <span class="op">...</span>)</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>  body <span class="op">...</span>)</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; Built-in template functions</span></span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>(render-template template-name args <span class="op">...</span>)</span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>(template-exists? name)</span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>(current-template)</span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>(inherit-template parent-name)</span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Layout functions</span></span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>(define-layout name (content)</span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span> content <span class="op">...</span>)</span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a>(wrap-layout layout-name content)</span>
<span id="cb200-16"><a href="#cb200-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-17"><a href="#cb200-17" aria-hidden="true" tabindex="-1"></a><span class="co">;; Partial rendering</span></span>
<span id="cb200-18"><a href="#cb200-18" aria-hidden="true" tabindex="-1"></a>(render-partial partial-name </span>
<span id="cb200-19"><a href="#cb200-19" aria-hidden="true" tabindex="-1"></a>                #:with &#39;((var <span class="op">.</span> value)))</span></code></pre></div>
<h3 id="content-processing">Content Processing</h3>
<div class="sourceCode" id="cb201"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Text processing</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>(markdown-&gt;html text)</span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>(sanitize-html html)</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>(strip-tags html)</span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>(truncate-words text n)</span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>(slugify text)</span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>(titlecase text)</span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a><span class="co">;; Syntax highlighting</span></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>(highlight-code code language)</span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>(detect-language code)</span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>(highlight-inline code)</span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; Table of contents</span></span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a>(extract-toc document </span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a>             #:max-depth <span class="dv">3</span></span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a>             #:id-prefix <span class="st">&quot;toc-&quot;</span>)</span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a>(generate-toc-html toc)</span>
<span id="cb201-20"><a href="#cb201-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-21"><a href="#cb201-21" aria-hidden="true" tabindex="-1"></a><span class="co">;; Search indexing</span></span>
<span id="cb201-22"><a href="#cb201-22" aria-hidden="true" tabindex="-1"></a>(index-document doc)</span>
<span id="cb201-23"><a href="#cb201-23" aria-hidden="true" tabindex="-1"></a>(build-search-index pages)</span>
<span id="cb201-24"><a href="#cb201-24" aria-hidden="true" tabindex="-1"></a>(search query index)</span></code></pre></div>
<h3 id="asset-management">Asset Management</h3>
<div class="sourceCode" id="cb202"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Asset handling</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>(asset-path path)</span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>(asset-url path)</span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>(fingerprint-asset path)</span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a>(inline-asset path)</span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Image processing</span></span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>(process-image path</span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a>               #:resize &#39;(<span class="dv">800</span> <span class="dv">600</span>)</span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a>               #:format &#39;webp</span>
<span id="cb202-11"><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a>               #:quality <span class="dv">85</span>)</span>
<span id="cb202-12"><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-13"><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a>(responsive-image path </span>
<span id="cb202-14"><a href="#cb202-14" aria-hidden="true" tabindex="-1"></a>                  #:sizes &#39;(<span class="dv">320</span> <span class="dv">640</span> <span class="dv">1024</span>)</span>
<span id="cb202-15"><a href="#cb202-15" aria-hidden="true" tabindex="-1"></a>                  #:formats &#39;(webp jpg))</span>
<span id="cb202-16"><a href="#cb202-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-17"><a href="#cb202-17" aria-hidden="true" tabindex="-1"></a><span class="co">;; CSS/JS processing</span></span>
<span id="cb202-18"><a href="#cb202-18" aria-hidden="true" tabindex="-1"></a>(compile-scss file)</span>
<span id="cb202-19"><a href="#cb202-19" aria-hidden="true" tabindex="-1"></a>(minify-css css)</span>
<span id="cb202-20"><a href="#cb202-20" aria-hidden="true" tabindex="-1"></a>(minify-js js)</span>
<span id="cb202-21"><a href="#cb202-21" aria-hidden="true" tabindex="-1"></a>(bundle-js files)</span></code></pre></div>
<h3 id="url-and-routing">URL and Routing</h3>
<div class="sourceCode" id="cb203"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; URL generation</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>(url-for page)</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>(absolute-url path)</span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>(relative-url from to)</span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>(permalink-for document)</span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Routing</span></span>
<span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a>(define-route pattern handler)</span>
<span id="cb203-9"><a href="#cb203-9" aria-hidden="true" tabindex="-1"></a>(match-route url)</span>
<span id="cb203-10"><a href="#cb203-10" aria-hidden="true" tabindex="-1"></a>(redirect-to url <span class="op">[</span>permanent?<span class="op">]</span>)</span>
<span id="cb203-11"><a href="#cb203-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-12"><a href="#cb203-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; Navigation</span></span>
<span id="cb203-13"><a href="#cb203-13" aria-hidden="true" tabindex="-1"></a>(nav-menu items </span>
<span id="cb203-14"><a href="#cb203-14" aria-hidden="true" tabindex="-1"></a>          #:current current-page</span>
<span id="cb203-15"><a href="#cb203-15" aria-hidden="true" tabindex="-1"></a>          #:depth <span class="dv">2</span>)</span>
<span id="cb203-16"><a href="#cb203-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-17"><a href="#cb203-17" aria-hidden="true" tabindex="-1"></a>(breadcrumbs page)</span>
<span id="cb203-18"><a href="#cb203-18" aria-hidden="true" tabindex="-1"></a>(sitemap pages)</span></code></pre></div>
<h2 id="configuration-reference">Configuration Reference</h2>
<h3 id="site-configuration">Site Configuration</h3>
<div class="sourceCode" id="cb204"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; shrdlu.config.rkt</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>(provide site-config)</span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> site-config</span></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a>  (shrdlu-configuration</span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Basic settings</span></span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a>   #:title <span class="st">&quot;Site Title&quot;</span></span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a>   #:author <span class="st">&quot;Default Author&quot;</span></span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a>   #:description <span class="st">&quot;Site description&quot;</span></span>
<span id="cb204-12"><a href="#cb204-12" aria-hidden="true" tabindex="-1"></a>   #:base-url <span class="st">&quot;https://example.com&quot;</span></span>
<span id="cb204-13"><a href="#cb204-13" aria-hidden="true" tabindex="-1"></a>   #:language <span class="st">&quot;en&quot;</span></span>
<span id="cb204-14"><a href="#cb204-14" aria-hidden="true" tabindex="-1"></a>   #:timezone <span class="st">&quot;America/New_York&quot;</span></span>
<span id="cb204-15"><a href="#cb204-15" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb204-16"><a href="#cb204-16" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Directories</span></span>
<span id="cb204-17"><a href="#cb204-17" aria-hidden="true" tabindex="-1"></a>   #:source-dir <span class="st">&quot;content&quot;</span></span>
<span id="cb204-18"><a href="#cb204-18" aria-hidden="true" tabindex="-1"></a>   #:output-dir <span class="st">&quot;_site&quot;</span></span>
<span id="cb204-19"><a href="#cb204-19" aria-hidden="true" tabindex="-1"></a>   #:template-dir <span class="st">&quot;templates&quot;</span></span>
<span id="cb204-20"><a href="#cb204-20" aria-hidden="true" tabindex="-1"></a>   #:static-dir <span class="st">&quot;static&quot;</span></span>
<span id="cb204-21"><a href="#cb204-21" aria-hidden="true" tabindex="-1"></a>   #:cache-dir <span class="st">&quot;.cache&quot;</span></span>
<span id="cb204-22"><a href="#cb204-22" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb204-23"><a href="#cb204-23" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Build options</span></span>
<span id="cb204-24"><a href="#cb204-24" aria-hidden="true" tabindex="-1"></a>   #:minify? <span class="dv">#t</span></span>
<span id="cb204-25"><a href="#cb204-25" aria-hidden="true" tabindex="-1"></a>   #:fingerprint? <span class="dv">#t</span></span>
<span id="cb204-26"><a href="#cb204-26" aria-hidden="true" tabindex="-1"></a>   #:sourcemaps? <span class="dv">#t</span></span>
<span id="cb204-27"><a href="#cb204-27" aria-hidden="true" tabindex="-1"></a>   #:drafts? <span class="dv">#f</span></span>
<span id="cb204-28"><a href="#cb204-28" aria-hidden="true" tabindex="-1"></a>   #:future? <span class="dv">#f</span></span>
<span id="cb204-29"><a href="#cb204-29" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb204-30"><a href="#cb204-30" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Features</span></span>
<span id="cb204-31"><a href="#cb204-31" aria-hidden="true" tabindex="-1"></a>   #:features &#39;(markdown</span>
<span id="cb204-32"><a href="#cb204-32" aria-hidden="true" tabindex="-1"></a>               syntax-highlighting</span>
<span id="cb204-33"><a href="#cb204-33" aria-hidden="true" tabindex="-1"></a>               math</span>
<span id="cb204-34"><a href="#cb204-34" aria-hidden="true" tabindex="-1"></a>               search</span>
<span id="cb204-35"><a href="#cb204-35" aria-hidden="true" tabindex="-1"></a>               rss</span>
<span id="cb204-36"><a href="#cb204-36" aria-hidden="true" tabindex="-1"></a>               sitemap)</span>
<span id="cb204-37"><a href="#cb204-37" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb204-38"><a href="#cb204-38" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Theme</span></span>
<span id="cb204-39"><a href="#cb204-39" aria-hidden="true" tabindex="-1"></a>   #:theme <span class="st">&quot;default&quot;</span></span>
<span id="cb204-40"><a href="#cb204-40" aria-hidden="true" tabindex="-1"></a>   #:custom-css <span class="st">&quot;styles/custom.css&quot;</span></span>
<span id="cb204-41"><a href="#cb204-41" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb204-42"><a href="#cb204-42" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Plugins</span></span>
<span id="cb204-43"><a href="#cb204-43" aria-hidden="true" tabindex="-1"></a>   #:plugins &#39;((analytics google <span class="st">&quot;GA-ID&quot;</span>)</span>
<span id="cb204-44"><a href="#cb204-44" aria-hidden="true" tabindex="-1"></a>              (comments disqus <span class="st">&quot;shortname&quot;</span>)</span>
<span id="cb204-45"><a href="#cb204-45" aria-hidden="true" tabindex="-1"></a>              (search algolia <span class="st">&quot;APP-ID&quot;</span>))</span>
<span id="cb204-46"><a href="#cb204-46" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb204-47"><a href="#cb204-47" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Collections</span></span>
<span id="cb204-48"><a href="#cb204-48" aria-hidden="true" tabindex="-1"></a>   #:collections </span>
<span id="cb204-49"><a href="#cb204-49" aria-hidden="true" tabindex="-1"></a>   &#39;((blog #:path <span class="st">&quot;blog/*.rkt&quot;</span></span>
<span id="cb204-50"><a href="#cb204-50" aria-hidden="true" tabindex="-1"></a>           #:sort date</span>
<span id="cb204-51"><a href="#cb204-51" aria-hidden="true" tabindex="-1"></a>           #:reverse <span class="dv">#t</span></span>
<span id="cb204-52"><a href="#cb204-52" aria-hidden="true" tabindex="-1"></a>           #:per-page <span class="dv">10</span>)</span>
<span id="cb204-53"><a href="#cb204-53" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb204-54"><a href="#cb204-54" aria-hidden="true" tabindex="-1"></a>     (projects #:path <span class="st">&quot;projects/*.rkt&quot;</span></span>
<span id="cb204-55"><a href="#cb204-55" aria-hidden="true" tabindex="-1"></a>               #:sort priority))</span>
<span id="cb204-56"><a href="#cb204-56" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb204-57"><a href="#cb204-57" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Permalinks</span></span>
<span id="cb204-58"><a href="#cb204-58" aria-hidden="true" tabindex="-1"></a>   #:permalink-style &#39;pretty  <span class="co">; or &#39;date, &#39;none</span></span>
<span id="cb204-59"><a href="#cb204-59" aria-hidden="true" tabindex="-1"></a>   #:permalink-format <span class="st">&quot;/{collection}/{slug}&quot;</span></span>
<span id="cb204-60"><a href="#cb204-60" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb204-61"><a href="#cb204-61" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Deployment</span></span>
<span id="cb204-62"><a href="#cb204-62" aria-hidden="true" tabindex="-1"></a>   #:deploy-method &#39;github-pages</span>
<span id="cb204-63"><a href="#cb204-63" aria-hidden="true" tabindex="-1"></a>   #:deploy-branch <span class="st">&quot;gh-pages&quot;</span></span>
<span id="cb204-64"><a href="#cb204-64" aria-hidden="true" tabindex="-1"></a>   #:cname <span class="st">&quot;custom-domain.com&quot;</span>))</span></code></pre></div>
<h3 id="environment-variables">Environment Variables</h3>
<div class="sourceCode" id="cb205"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Recognized environment variables</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>SHRDLU_ENV          <span class="co">; development, production, test</span></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>SHRDLU_BASE_URL     <span class="co">; Override base URL</span></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>SHRDLU_OUTPUT_DIR   <span class="co">; Override output directory</span></span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>SHRDLU_CACHE        <span class="co">; Enable/disable caching</span></span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>SHRDLU_VERBOSE      <span class="co">; Verbose logging</span></span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>SHRDLU_PARALLEL     <span class="co">; Number of parallel jobs</span></span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>SHRDLU_DRAFTS       <span class="co">; Include draft posts</span></span></code></pre></div>
<h2 id="plugin-system">Plugin System</h2>
<h3 id="plugin-structure">Plugin Structure</h3>
<div class="sourceCode" id="cb206"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; plugins/my-plugin/main.rkt</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>#lang racket</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>(provide plugin-info</span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>         initialize</span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>         process-document</span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>         extend-config)</span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> plugin-info</span></span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>  (shrdlu-plugin</span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>   #:name <span class="st">&quot;my-plugin&quot;</span></span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>   #:version <span class="st">&quot;1.0.0&quot;</span></span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a>   #:author <span class="st">&quot;Your Name&quot;</span></span>
<span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a>   #:description <span class="st">&quot;Plugin description&quot;</span></span>
<span id="cb206-15"><a href="#cb206-15" aria-hidden="true" tabindex="-1"></a>   #:requires &#39;(shrdlu-core)))</span>
<span id="cb206-16"><a href="#cb206-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-17"><a href="#cb206-17" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(initialize config)</span>
<span id="cb206-18"><a href="#cb206-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Setup code</span></span>
<span id="cb206-19"><a href="#cb206-19" aria-hidden="true" tabindex="-1"></a>  (void))</span>
<span id="cb206-20"><a href="#cb206-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-21"><a href="#cb206-21" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(process-document doc)</span>
<span id="cb206-22"><a href="#cb206-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Transform document</span></span>
<span id="cb206-23"><a href="#cb206-23" aria-hidden="true" tabindex="-1"></a>  doc)</span>
<span id="cb206-24"><a href="#cb206-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-25"><a href="#cb206-25" aria-hidden="true" tabindex="-1"></a>(<span class="ex">define</span><span class="fu"> </span>(extend-config config)</span>
<span id="cb206-26"><a href="#cb206-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; Modify configuration</span></span>
<span id="cb206-27"><a href="#cb206-27" aria-hidden="true" tabindex="-1"></a>  config)</span></code></pre></div>
<h3 id="plugin-hooks">Plugin Hooks</h3>
<div class="sourceCode" id="cb207"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Available hooks</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>&#39;before-build         <span class="co">; Before build starts</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>&#39;after-build         <span class="co">; After build completes</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>&#39;before-page         <span class="co">; Before processing page</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>&#39;after-page          <span class="co">; After processing page</span></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>&#39;before-render       <span class="co">; Before rendering</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>&#39;after-render        <span class="co">; After rendering</span></span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>&#39;on-asset           <span class="co">; Process asset</span></span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>&#39;on-error           <span class="co">; Handle errors</span></span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Hook registration</span></span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a>(register-hook &#39;before-build</span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a>  (λ (context)</span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a>    (log-info <span class="st">&quot;Build starting...&quot;</span>)))</span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a><span class="co">;; Hook execution</span></span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a>(run-hooks &#39;before-build context)</span></code></pre></div>
<h2 id="error-messages-and-diagnostics">Error Messages and
Diagnostics</h2>
<h3 id="common-error-patterns">Common Error Patterns</h3>
<div class="sourceCode" id="cb208"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template not found</span></span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>shrdlu: template <span class="kw">error</span></span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>  template &#39;custom-template&#39; <span class="kw">not</span> found</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>  in: templates/</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>  required by: content/page.rkt</span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Invalid front matter</span></span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>shrdlu: parse <span class="kw">error</span></span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>  invalid metadata field &#39;#:dated&#39; </span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a>  did you mean &#39;#:date&#39;?</span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>  at: content/post.rkt:3:0</span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a><span class="co">;; Missing required field</span></span>
<span id="cb208-14"><a href="#cb208-14" aria-hidden="true" tabindex="-1"></a>shrdlu: validation <span class="kw">error</span></span>
<span id="cb208-15"><a href="#cb208-15" aria-hidden="true" tabindex="-1"></a>  document missing required field: #:title</span>
<span id="cb208-16"><a href="#cb208-16" aria-hidden="true" tabindex="-1"></a>  in: content/page.rkt</span>
<span id="cb208-17"><a href="#cb208-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-18"><a href="#cb208-18" aria-hidden="true" tabindex="-1"></a><span class="co">;; Circular dependency</span></span>
<span id="cb208-19"><a href="#cb208-19" aria-hidden="true" tabindex="-1"></a>shrdlu: dependency cycle detected</span>
<span id="cb208-20"><a href="#cb208-20" aria-hidden="true" tabindex="-1"></a>  page1.rkt -&gt; partial.rkt -&gt; page1.rkt</span></code></pre></div>
<h3 id="debugging-functions">Debugging Functions</h3>
<div class="sourceCode" id="cb209"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Debug output</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>(debug-document doc)           <span class="co">; Print document structure</span></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>(trace-template name)          <span class="co">; Trace template rendering</span></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>(explain-error exn)           <span class="co">; Detailed error explanation</span></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>(validate-site)               <span class="co">; Check site integrity</span></span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; Profiling</span></span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>(time-build)                  <span class="co">; Profile build time</span></span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>(memory-usage)                <span class="co">; Check memory usage</span></span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a>(cache-stats)                 <span class="co">; Cache statistics</span></span></code></pre></div>
<h2 id="advanced-features">Advanced Features</h2>
<h3 id="macros-and-extensions">Macros and Extensions</h3>
<div class="sourceCode" id="cb210"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Define custom element</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>(define-shrdlu-element accordion</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>  #:attributes (title expanded?)</span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>  #:template <span class="st">&quot;accordion.html&quot;</span></span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>  (λ (title expanded? <span class="op">.</span> content)</span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>    `(<span class="kw">div</span> (<span class="op">[</span>class ,(<span class="kw">if</span> expanded? </span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;accordion expanded&quot;</span> </span>
<span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;accordion&quot;</span>)<span class="op">]</span>)</span>
<span id="cb210-9"><a href="#cb210-9" aria-hidden="true" tabindex="-1"></a>          (h3 ,title)</span>
<span id="cb210-10"><a href="#cb210-10" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">div</span> (<span class="op">[</span>class <span class="st">&quot;content&quot;</span><span class="op">]</span>) </span>
<span id="cb210-11"><a href="#cb210-11" aria-hidden="true" tabindex="-1"></a>               ,@content))))</span>
<span id="cb210-12"><a href="#cb210-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-13"><a href="#cb210-13" aria-hidden="true" tabindex="-1"></a><span class="co">;; Custom reader macro</span></span>
<span id="cb210-14"><a href="#cb210-14" aria-hidden="true" tabindex="-1"></a>(define-reader-syntax @custom</span>
<span id="cb210-15"><a href="#cb210-15" aria-hidden="true" tabindex="-1"></a>  (λ (stx)</span>
<span id="cb210-16"><a href="#cb210-16" aria-hidden="true" tabindex="-1"></a>    (syntax-parse stx</span>
<span id="cb210-17"><a href="#cb210-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">[</span>(<span class="op">_</span> arg <span class="op">...</span>)</span>
<span id="cb210-18"><a href="#cb210-18" aria-hidden="true" tabindex="-1"></a>       #&#39;(custom-function arg <span class="op">...</span>)<span class="op">]</span>)))</span>
<span id="cb210-19"><a href="#cb210-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-20"><a href="#cb210-20" aria-hidden="true" tabindex="-1"></a><span class="co">;; DSL extension</span></span>
<span id="cb210-21"><a href="#cb210-21" aria-hidden="true" tabindex="-1"></a>(define-dsl-syntax when-production</span>
<span id="cb210-22"><a href="#cb210-22" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">syntax-rules</span> ()</span>
<span id="cb210-23"><a href="#cb210-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>(<span class="op">_</span> body <span class="op">...</span>)</span>
<span id="cb210-24"><a href="#cb210-24" aria-hidden="true" tabindex="-1"></a>     (when (<span class="kw">eq?</span> (current-environment) &#39;production)</span>
<span id="cb210-25"><a href="#cb210-25" aria-hidden="true" tabindex="-1"></a>       body <span class="op">...</span>)<span class="op">]</span>))</span></code></pre></div>
<h3 id="performance-optimization-3">Performance Optimization</h3>
<div class="sourceCode" id="cb211"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Caching directives</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>(cache-for duration expr)</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>(invalidate-cache key)</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>(with-cache key thunk)</span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a><span class="co">;; Lazy evaluation</span></span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a>(lazy-asset path)</span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a>(defer-processing thunk)</span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a>(parallel-map proc lst)</span>
<span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Memory management</span></span>
<span id="cb211-12"><a href="#cb211-12" aria-hidden="true" tabindex="-1"></a>(limit-memory mb)</span>
<span id="cb211-13"><a href="#cb211-13" aria-hidden="true" tabindex="-1"></a>(gc-after-page)</span>
<span id="cb211-14"><a href="#cb211-14" aria-hidden="true" tabindex="-1"></a>(compact-cache)</span></code></pre></div>
<h2 id="migration-guide">Migration Guide</h2>
<h3 id="from-jekyll">From Jekyll</h3>
<div class="sourceCode" id="cb212"><pre
class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Jekyll front matter</span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="kw">---</span></span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a><span class="wa">layout: </span>post</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a><span class="wa">title: </span><span class="st">&quot;Title&quot;</span></span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a><span class="wa">date: </span><span class="dv">2024</span><span class="bn">-01-01</span></span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a><span class="kw">---</span></span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Becomes in Shrdlu:</span></span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a><span class="co">#lang shrdlu</span></span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a><span class="co">#:template &quot;post&quot;</span></span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a><span class="co">#:title &quot;Title&quot;</span></span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a><span class="co">#:date 2024-01-01</span></span></code></pre></div>
<h3 id="from-hugo">From Hugo</h3>
<div class="sourceCode" id="cb213"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Hugo front matter</span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a><span class="at">+++</span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a><span class="at">title = &quot;Title&quot;</span></span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a><span class="at">date = 2024-01-01T00:00:00Z</span></span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a><span class="at">draft = true</span></span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a><span class="at">+++</span></span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Becomes in Shrdlu:</span></span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a><span class="co">#lang shrdlu</span></span>
<span id="cb213-10"><a href="#cb213-10" aria-hidden="true" tabindex="-1"></a><span class="co">#:title &quot;Title&quot;</span></span>
<span id="cb213-11"><a href="#cb213-11" aria-hidden="true" tabindex="-1"></a><span class="co">#:date &quot;2024-01-01T00:00:00Z&quot;</span></span>
<span id="cb213-12"><a href="#cb213-12" aria-hidden="true" tabindex="-1"></a><span class="co">#:draft #t</span></span></code></pre></div>
<p>This reference provides a comprehensive guide to all Shrdlu language
features, from basic document creation to advanced plugin development.
Use it as a quick lookup while building your static sites with Shrdlu. #
Appendix B: API Documentation</p>
<h2 id="core-api">Core API</h2>
<h3 id="document-api">Document API</h3>
<h4 id="shrdludocument"><code>shrdlu/document</code></h4>
<div class="sourceCode" id="cb214"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Document structure</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>(struct document (metadata content)</span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>  #:transparent</span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>  #:methods gen:convertible</span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>(<span class="ex">define</span><span class="fu"> </span>(convert-proc doc target-type)</span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>     <span class="op">...</span>)<span class="op">]</span>)</span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; Constructor</span></span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a>(make-document </span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:title title<span class="op">]</span>           <span class="co">; string?</span></span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:author author<span class="op">]</span>         <span class="co">; string?</span></span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:date date<span class="op">]</span>            <span class="co">; date?</span></span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:tags tags<span class="op">]</span>            <span class="co">; (listof string?)</span></span>
<span id="cb214-14"><a href="#cb214-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:content content<span class="op">]</span>      <span class="co">; node?</span></span>
<span id="cb214-15"><a href="#cb214-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:metadata metadata<span class="op">]</span>)   <span class="co">; hash?</span></span>
<span id="cb214-16"><a href="#cb214-16" aria-hidden="true" tabindex="-1"></a>→ document?</span>
<span id="cb214-17"><a href="#cb214-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-18"><a href="#cb214-18" aria-hidden="true" tabindex="-1"></a><span class="co">;; Predicates</span></span>
<span id="cb214-19"><a href="#cb214-19" aria-hidden="true" tabindex="-1"></a>(document? v) → <span class="kw">boolean?</span></span>
<span id="cb214-20"><a href="#cb214-20" aria-hidden="true" tabindex="-1"></a>  v : any/c</span>
<span id="cb214-21"><a href="#cb214-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-22"><a href="#cb214-22" aria-hidden="true" tabindex="-1"></a><span class="co">;; Accessors</span></span>
<span id="cb214-23"><a href="#cb214-23" aria-hidden="true" tabindex="-1"></a>(document-title doc) → <span class="kw">string?</span></span>
<span id="cb214-24"><a href="#cb214-24" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb214-25"><a href="#cb214-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-26"><a href="#cb214-26" aria-hidden="true" tabindex="-1"></a>(document-author doc) → (or/c <span class="kw">string?</span> <span class="dv">#f</span>)</span>
<span id="cb214-27"><a href="#cb214-27" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb214-28"><a href="#cb214-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-29"><a href="#cb214-29" aria-hidden="true" tabindex="-1"></a>(document-date doc) → (or/c date? <span class="dv">#f</span>)</span>
<span id="cb214-30"><a href="#cb214-30" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb214-31"><a href="#cb214-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-32"><a href="#cb214-32" aria-hidden="true" tabindex="-1"></a>(document-tags doc) → (listof <span class="kw">string?</span>)</span>
<span id="cb214-33"><a href="#cb214-33" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb214-34"><a href="#cb214-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-35"><a href="#cb214-35" aria-hidden="true" tabindex="-1"></a>(document-get-meta doc key <span class="op">[</span>default<span class="op">]</span>) → any/c</span>
<span id="cb214-36"><a href="#cb214-36" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb214-37"><a href="#cb214-37" aria-hidden="true" tabindex="-1"></a>  key : <span class="kw">symbol?</span></span>
<span id="cb214-38"><a href="#cb214-38" aria-hidden="true" tabindex="-1"></a>  default : any/c <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb214-39"><a href="#cb214-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-40"><a href="#cb214-40" aria-hidden="true" tabindex="-1"></a><span class="co">;; Mutators</span></span>
<span id="cb214-41"><a href="#cb214-41" aria-hidden="true" tabindex="-1"></a>(document-set-meta doc key value) → document?</span>
<span id="cb214-42"><a href="#cb214-42" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb214-43"><a href="#cb214-43" aria-hidden="true" tabindex="-1"></a>  key : <span class="kw">symbol?</span></span>
<span id="cb214-44"><a href="#cb214-44" aria-hidden="true" tabindex="-1"></a>  value : any/c</span>
<span id="cb214-45"><a href="#cb214-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-46"><a href="#cb214-46" aria-hidden="true" tabindex="-1"></a>(document-update-meta doc updates) → document?</span>
<span id="cb214-47"><a href="#cb214-47" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb214-48"><a href="#cb214-48" aria-hidden="true" tabindex="-1"></a>  updates : hash?</span>
<span id="cb214-49"><a href="#cb214-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-50"><a href="#cb214-50" aria-hidden="true" tabindex="-1"></a><span class="co">;; Transformers</span></span>
<span id="cb214-51"><a href="#cb214-51" aria-hidden="true" tabindex="-1"></a>(document-map-content doc proc) → document?</span>
<span id="cb214-52"><a href="#cb214-52" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb214-53"><a href="#cb214-53" aria-hidden="true" tabindex="-1"></a>  proc : (-&gt; node? node?)</span>
<span id="cb214-54"><a href="#cb214-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-55"><a href="#cb214-55" aria-hidden="true" tabindex="-1"></a>(document-filter-content doc pred?) → document?</span>
<span id="cb214-56"><a href="#cb214-56" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb214-57"><a href="#cb214-57" aria-hidden="true" tabindex="-1"></a>  pred? : (-&gt; node? <span class="kw">boolean?</span>)</span></code></pre></div>
<h3 id="node-api">Node API</h3>
<h4 id="shrdluast"><code>shrdlu/ast</code></h4>
<div class="sourceCode" id="cb215"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Base node type</span></span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>(struct node (type attributes children)</span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>  #:transparent</span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a>  #:guard (λ (type attrs children name)</span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>           (unless (<span class="kw">symbol?</span> type)</span>
<span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a>             (raise-argument-error name <span class="st">&quot;symbol?&quot;</span> type))</span>
<span id="cb215-7"><a href="#cb215-7" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">values</span> type </span>
<span id="cb215-8"><a href="#cb215-8" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">or</span> attrs (hash))</span>
<span id="cb215-9"><a href="#cb215-9" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">or</span> children &#39;()))))</span>
<span id="cb215-10"><a href="#cb215-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-11"><a href="#cb215-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Node constructors</span></span>
<span id="cb215-12"><a href="#cb215-12" aria-hidden="true" tabindex="-1"></a>(heading level content <span class="op">[</span>#:id id<span class="op">]</span> <span class="op">[</span>#:class class<span class="op">]</span>) → node?</span>
<span id="cb215-13"><a href="#cb215-13" aria-hidden="true" tabindex="-1"></a>  level : (integer-in <span class="dv">1</span> <span class="dv">6</span>)</span>
<span id="cb215-14"><a href="#cb215-14" aria-hidden="true" tabindex="-1"></a>  content : (or/c <span class="kw">string?</span> node?)</span>
<span id="cb215-15"><a href="#cb215-15" aria-hidden="true" tabindex="-1"></a>  id : (or/c <span class="kw">string?</span> <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-16"><a href="#cb215-16" aria-hidden="true" tabindex="-1"></a>  class : (or/c <span class="kw">string?</span> <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-17"><a href="#cb215-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-18"><a href="#cb215-18" aria-hidden="true" tabindex="-1"></a>(paragraph <span class="op">.</span> contents) → node?</span>
<span id="cb215-19"><a href="#cb215-19" aria-hidden="true" tabindex="-1"></a>  contents : (listof (or/c <span class="kw">string?</span> node?))</span>
<span id="cb215-20"><a href="#cb215-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-21"><a href="#cb215-21" aria-hidden="true" tabindex="-1"></a>(emphasis content <span class="op">[</span>#:strong? strong?<span class="op">]</span>) → node?</span>
<span id="cb215-22"><a href="#cb215-22" aria-hidden="true" tabindex="-1"></a>  content : (or/c <span class="kw">string?</span> node?)</span>
<span id="cb215-23"><a href="#cb215-23" aria-hidden="true" tabindex="-1"></a>  strong? : <span class="kw">boolean?</span> <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-24"><a href="#cb215-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-25"><a href="#cb215-25" aria-hidden="true" tabindex="-1"></a>(code-block code </span>
<span id="cb215-26"><a href="#cb215-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span>#:lang lang<span class="op">]</span></span>
<span id="cb215-27"><a href="#cb215-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span>#:line-numbers? line-numbers?<span class="op">]</span></span>
<span id="cb215-28"><a href="#cb215-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">[</span>#:highlight highlights<span class="op">]</span>) → node?</span>
<span id="cb215-29"><a href="#cb215-29" aria-hidden="true" tabindex="-1"></a>  code : <span class="kw">string?</span></span>
<span id="cb215-30"><a href="#cb215-30" aria-hidden="true" tabindex="-1"></a>  lang : (or/c <span class="kw">string?</span> <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-31"><a href="#cb215-31" aria-hidden="true" tabindex="-1"></a>  line-numbers? : <span class="kw">boolean?</span> <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-32"><a href="#cb215-32" aria-hidden="true" tabindex="-1"></a>  highlights : (listof (or/c exact-integer? </span>
<span id="cb215-33"><a href="#cb215-33" aria-hidden="true" tabindex="-1"></a>                             (cons/c exact-integer? </span>
<span id="cb215-34"><a href="#cb215-34" aria-hidden="true" tabindex="-1"></a>                                    exact-integer?))) <span class="op">=</span> &#39;()</span>
<span id="cb215-35"><a href="#cb215-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-36"><a href="#cb215-36" aria-hidden="true" tabindex="-1"></a>(link url content <span class="op">[</span>#:title title<span class="op">]</span> <span class="op">[</span>#:target target<span class="op">]</span>) → node?</span>
<span id="cb215-37"><a href="#cb215-37" aria-hidden="true" tabindex="-1"></a>  url : <span class="kw">string?</span></span>
<span id="cb215-38"><a href="#cb215-38" aria-hidden="true" tabindex="-1"></a>  content : (or/c <span class="kw">string?</span> node?)</span>
<span id="cb215-39"><a href="#cb215-39" aria-hidden="true" tabindex="-1"></a>  title : (or/c <span class="kw">string?</span> <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-40"><a href="#cb215-40" aria-hidden="true" tabindex="-1"></a>  target : (or/c <span class="st">&quot;_blank&quot;</span> <span class="st">&quot;_self&quot;</span> <span class="st">&quot;_parent&quot;</span> <span class="st">&quot;_top&quot;</span> <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-41"><a href="#cb215-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-42"><a href="#cb215-42" aria-hidden="true" tabindex="-1"></a>(image src <span class="op">[</span>#:alt alt<span class="op">]</span> <span class="op">[</span>#:width width<span class="op">]</span> <span class="op">[</span>#:height height<span class="op">]</span>) → node?</span>
<span id="cb215-43"><a href="#cb215-43" aria-hidden="true" tabindex="-1"></a>  src : <span class="kw">string?</span></span>
<span id="cb215-44"><a href="#cb215-44" aria-hidden="true" tabindex="-1"></a>  alt : <span class="kw">string?</span> <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb215-45"><a href="#cb215-45" aria-hidden="true" tabindex="-1"></a>  width : (or/c exact-positive-integer? <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-46"><a href="#cb215-46" aria-hidden="true" tabindex="-1"></a>  height : (or/c exact-positive-integer? <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-47"><a href="#cb215-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-48"><a href="#cb215-48" aria-hidden="true" tabindex="-1"></a>(list-node items <span class="op">[</span>#:ordered? ordered?<span class="op">]</span> <span class="op">[</span>#:start start<span class="op">]</span>) → node?</span>
<span id="cb215-49"><a href="#cb215-49" aria-hidden="true" tabindex="-1"></a>  items : (listof node?)</span>
<span id="cb215-50"><a href="#cb215-50" aria-hidden="true" tabindex="-1"></a>  ordered? : <span class="kw">boolean?</span> <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-51"><a href="#cb215-51" aria-hidden="true" tabindex="-1"></a>  start : exact-positive-integer? <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb215-52"><a href="#cb215-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-53"><a href="#cb215-53" aria-hidden="true" tabindex="-1"></a>(table headers rows </span>
<span id="cb215-54"><a href="#cb215-54" aria-hidden="true" tabindex="-1"></a>       <span class="op">[</span>#:caption caption<span class="op">]</span></span>
<span id="cb215-55"><a href="#cb215-55" aria-hidden="true" tabindex="-1"></a>       <span class="op">[</span>#:align alignments<span class="op">]</span>) → node?</span>
<span id="cb215-56"><a href="#cb215-56" aria-hidden="true" tabindex="-1"></a>  headers : (listof <span class="kw">string?</span>)</span>
<span id="cb215-57"><a href="#cb215-57" aria-hidden="true" tabindex="-1"></a>  rows : (listof (listof (or/c <span class="kw">string?</span> node?)))</span>
<span id="cb215-58"><a href="#cb215-58" aria-hidden="true" tabindex="-1"></a>  caption : (or/c <span class="kw">string?</span> <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-59"><a href="#cb215-59" aria-hidden="true" tabindex="-1"></a>  alignments : (listof (or/c &#39;left &#39;center &#39;right)) <span class="op">=</span> &#39;()</span>
<span id="cb215-60"><a href="#cb215-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-61"><a href="#cb215-61" aria-hidden="true" tabindex="-1"></a>(math expr <span class="op">[</span>#:display? display?<span class="op">]</span> <span class="op">[</span>#:number number<span class="op">]</span>) → node?</span>
<span id="cb215-62"><a href="#cb215-62" aria-hidden="true" tabindex="-1"></a>  expr : <span class="kw">string?</span></span>
<span id="cb215-63"><a href="#cb215-63" aria-hidden="true" tabindex="-1"></a>  display? : <span class="kw">boolean?</span> <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-64"><a href="#cb215-64" aria-hidden="true" tabindex="-1"></a>  number : (or/c exact-positive-integer? <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb215-65"><a href="#cb215-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-66"><a href="#cb215-66" aria-hidden="true" tabindex="-1"></a><span class="co">;; Node predicates</span></span>
<span id="cb215-67"><a href="#cb215-67" aria-hidden="true" tabindex="-1"></a>(node? v) → <span class="kw">boolean?</span></span>
<span id="cb215-68"><a href="#cb215-68" aria-hidden="true" tabindex="-1"></a>(heading? v) → <span class="kw">boolean?</span></span>
<span id="cb215-69"><a href="#cb215-69" aria-hidden="true" tabindex="-1"></a>(paragraph? v) → <span class="kw">boolean?</span></span>
<span id="cb215-70"><a href="#cb215-70" aria-hidden="true" tabindex="-1"></a>(code-block? v) → <span class="kw">boolean?</span></span>
<span id="cb215-71"><a href="#cb215-71" aria-hidden="true" tabindex="-1"></a>(link? v) → <span class="kw">boolean?</span></span>
<span id="cb215-72"><a href="#cb215-72" aria-hidden="true" tabindex="-1"></a>(image? v) → <span class="kw">boolean?</span></span>
<span id="cb215-73"><a href="#cb215-73" aria-hidden="true" tabindex="-1"></a>(<span class="kw">list?</span> v) → <span class="kw">boolean?</span></span>
<span id="cb215-74"><a href="#cb215-74" aria-hidden="true" tabindex="-1"></a>(table? v) → <span class="kw">boolean?</span></span>
<span id="cb215-75"><a href="#cb215-75" aria-hidden="true" tabindex="-1"></a>(math? v) → <span class="kw">boolean?</span></span>
<span id="cb215-76"><a href="#cb215-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-77"><a href="#cb215-77" aria-hidden="true" tabindex="-1"></a><span class="co">;; Node operations</span></span>
<span id="cb215-78"><a href="#cb215-78" aria-hidden="true" tabindex="-1"></a>(node-type node) → <span class="kw">symbol?</span></span>
<span id="cb215-79"><a href="#cb215-79" aria-hidden="true" tabindex="-1"></a>(node-attributes node) → hash?</span>
<span id="cb215-80"><a href="#cb215-80" aria-hidden="true" tabindex="-1"></a>(node-children node) → <span class="kw">list?</span></span>
<span id="cb215-81"><a href="#cb215-81" aria-hidden="true" tabindex="-1"></a>(node-get-attr node key <span class="op">[</span>default<span class="op">]</span>) → any/c</span>
<span id="cb215-82"><a href="#cb215-82" aria-hidden="true" tabindex="-1"></a>(node-set-attr node key value) → node?</span>
<span id="cb215-83"><a href="#cb215-83" aria-hidden="true" tabindex="-1"></a>(node-add-child node child) → node?</span>
<span id="cb215-84"><a href="#cb215-84" aria-hidden="true" tabindex="-1"></a>(node-map-children node proc) → node?</span>
<span id="cb215-85"><a href="#cb215-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-86"><a href="#cb215-86" aria-hidden="true" tabindex="-1"></a><span class="co">;; Tree walking</span></span>
<span id="cb215-87"><a href="#cb215-87" aria-hidden="true" tabindex="-1"></a>(walk-nodes node visitor) → node?</span>
<span id="cb215-88"><a href="#cb215-88" aria-hidden="true" tabindex="-1"></a>  node : node?</span>
<span id="cb215-89"><a href="#cb215-89" aria-hidden="true" tabindex="-1"></a>  visitor : (-&gt; node? (or/c node? <span class="dv">#f</span>))</span>
<span id="cb215-90"><a href="#cb215-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-91"><a href="#cb215-91" aria-hidden="true" tabindex="-1"></a>(collect-nodes node pred?) → (listof node?)</span>
<span id="cb215-92"><a href="#cb215-92" aria-hidden="true" tabindex="-1"></a>  node : node?</span>
<span id="cb215-93"><a href="#cb215-93" aria-hidden="true" tabindex="-1"></a>  pred? : (-&gt; node? <span class="kw">boolean?</span>)</span>
<span id="cb215-94"><a href="#cb215-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-95"><a href="#cb215-95" aria-hidden="true" tabindex="-1"></a>(find-node node pred?) → (or/c node? <span class="dv">#f</span>)</span>
<span id="cb215-96"><a href="#cb215-96" aria-hidden="true" tabindex="-1"></a>  node : node?</span>
<span id="cb215-97"><a href="#cb215-97" aria-hidden="true" tabindex="-1"></a>  pred? : (-&gt; node? <span class="kw">boolean?</span>)</span>
<span id="cb215-98"><a href="#cb215-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-99"><a href="#cb215-99" aria-hidden="true" tabindex="-1"></a>(replace-nodes node pred? replacement) → node?</span>
<span id="cb215-100"><a href="#cb215-100" aria-hidden="true" tabindex="-1"></a>  node : node?</span>
<span id="cb215-101"><a href="#cb215-101" aria-hidden="true" tabindex="-1"></a>  pred? : (-&gt; node? <span class="kw">boolean?</span>)</span>
<span id="cb215-102"><a href="#cb215-102" aria-hidden="true" tabindex="-1"></a>  replacement : (-&gt; node? node?)</span></code></pre></div>
<h3 id="rendering-api">Rendering API</h3>
<h4 id="shrdlurender"><code>shrdlu/render</code></h4>
<div class="sourceCode" id="cb216"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Rendering context</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>(struct render-context </span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>  (options state output-port)</span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>  #:mutable)</span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>(make-render-context </span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:format format<span class="op">]</span></span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:theme theme<span class="op">]</span></span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:minify? minify?<span class="op">]</span></span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:math-renderer math-renderer<span class="op">]</span>) → render-context?</span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a>  format : (or/c &#39;html &#39;xml &#39;sxml) <span class="op">=</span> &#39;html</span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a>  theme : (or/c <span class="kw">string?</span> theme?) <span class="op">=</span> <span class="st">&quot;default&quot;</span></span>
<span id="cb216-13"><a href="#cb216-13" aria-hidden="true" tabindex="-1"></a>  minify? : <span class="kw">boolean?</span> <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb216-14"><a href="#cb216-14" aria-hidden="true" tabindex="-1"></a>  math-renderer : (or/c &#39;mathjax &#39;katex <span class="dv">#f</span>) <span class="op">=</span> &#39;katex</span>
<span id="cb216-15"><a href="#cb216-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-16"><a href="#cb216-16" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main rendering functions</span></span>
<span id="cb216-17"><a href="#cb216-17" aria-hidden="true" tabindex="-1"></a>(render doc <span class="op">[</span>#:format format<span class="op">]</span> <span class="op">[</span>#:context context<span class="op">]</span>) → <span class="kw">string?</span></span>
<span id="cb216-18"><a href="#cb216-18" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb216-19"><a href="#cb216-19" aria-hidden="true" tabindex="-1"></a>  format : (or/c &#39;html &#39;xml &#39;sxml) <span class="op">=</span> &#39;html</span>
<span id="cb216-20"><a href="#cb216-20" aria-hidden="true" tabindex="-1"></a>  context : (or/c render-context? <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb216-21"><a href="#cb216-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-22"><a href="#cb216-22" aria-hidden="true" tabindex="-1"></a>(render-to-file doc path <span class="op">[</span>#:format format<span class="op">]</span>) → void?</span>
<span id="cb216-23"><a href="#cb216-23" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb216-24"><a href="#cb216-24" aria-hidden="true" tabindex="-1"></a>  path : path-string?</span>
<span id="cb216-25"><a href="#cb216-25" aria-hidden="true" tabindex="-1"></a>  format : (or/c &#39;html &#39;xml &#39;sxml) <span class="op">=</span> &#39;html</span>
<span id="cb216-26"><a href="#cb216-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-27"><a href="#cb216-27" aria-hidden="true" tabindex="-1"></a>(render-to-port doc port <span class="op">[</span>#:format format<span class="op">]</span>) → void?</span>
<span id="cb216-28"><a href="#cb216-28" aria-hidden="true" tabindex="-1"></a>  doc : document?</span>
<span id="cb216-29"><a href="#cb216-29" aria-hidden="true" tabindex="-1"></a>  port : <span class="kw">output-port?</span></span>
<span id="cb216-30"><a href="#cb216-30" aria-hidden="true" tabindex="-1"></a>  format : (or/c &#39;html &#39;xml &#39;sxml) <span class="op">=</span> &#39;html</span>
<span id="cb216-31"><a href="#cb216-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-32"><a href="#cb216-32" aria-hidden="true" tabindex="-1"></a><span class="co">;; Specialized renderers</span></span>
<span id="cb216-33"><a href="#cb216-33" aria-hidden="true" tabindex="-1"></a>(render-html node context) → <span class="kw">string?</span></span>
<span id="cb216-34"><a href="#cb216-34" aria-hidden="true" tabindex="-1"></a>  node : node?</span>
<span id="cb216-35"><a href="#cb216-35" aria-hidden="true" tabindex="-1"></a>  context : render-context?</span>
<span id="cb216-36"><a href="#cb216-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-37"><a href="#cb216-37" aria-hidden="true" tabindex="-1"></a>(render-sxml node) → sxml?</span>
<span id="cb216-38"><a href="#cb216-38" aria-hidden="true" tabindex="-1"></a>  node : node?</span>
<span id="cb216-39"><a href="#cb216-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-40"><a href="#cb216-40" aria-hidden="true" tabindex="-1"></a>(render-markdown node) → <span class="kw">string?</span></span>
<span id="cb216-41"><a href="#cb216-41" aria-hidden="true" tabindex="-1"></a>  node : node?</span>
<span id="cb216-42"><a href="#cb216-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-43"><a href="#cb216-43" aria-hidden="true" tabindex="-1"></a>(render-latex node) → <span class="kw">string?</span></span>
<span id="cb216-44"><a href="#cb216-44" aria-hidden="true" tabindex="-1"></a>  node : node?</span>
<span id="cb216-45"><a href="#cb216-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-46"><a href="#cb216-46" aria-hidden="true" tabindex="-1"></a><span class="co">;; Component rendering</span></span>
<span id="cb216-47"><a href="#cb216-47" aria-hidden="true" tabindex="-1"></a>(render-template name data <span class="op">[</span>#:context context<span class="op">]</span>) → <span class="kw">string?</span></span>
<span id="cb216-48"><a href="#cb216-48" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">string?</span></span>
<span id="cb216-49"><a href="#cb216-49" aria-hidden="true" tabindex="-1"></a>  data : hash?</span>
<span id="cb216-50"><a href="#cb216-50" aria-hidden="true" tabindex="-1"></a>  context : (or/c render-context? <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb216-51"><a href="#cb216-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-52"><a href="#cb216-52" aria-hidden="true" tabindex="-1"></a>(render-partial name data) → <span class="kw">string?</span></span>
<span id="cb216-53"><a href="#cb216-53" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">string?</span></span>
<span id="cb216-54"><a href="#cb216-54" aria-hidden="true" tabindex="-1"></a>  data : any/c</span>
<span id="cb216-55"><a href="#cb216-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-56"><a href="#cb216-56" aria-hidden="true" tabindex="-1"></a>(render-layout layout content) → <span class="kw">string?</span></span>
<span id="cb216-57"><a href="#cb216-57" aria-hidden="true" tabindex="-1"></a>  layout : (or/c <span class="kw">string?</span> <span class="kw">procedure?</span>)</span>
<span id="cb216-58"><a href="#cb216-58" aria-hidden="true" tabindex="-1"></a>  content : <span class="kw">string?</span></span></code></pre></div>
<h3 id="parser-api">Parser API</h3>
<h4 id="shrdluparser"><code>shrdlu/parser</code></h4>
<div class="sourceCode" id="cb217"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Main parsing functions</span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>(parse-file path <span class="op">[</span>#:reader reader<span class="op">]</span>) → document?</span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>  path : path-string?</span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>  reader : (or/c &#39;shrdlu &#39;markdown &#39;auto) <span class="op">=</span> &#39;auto</span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>(parse-string str <span class="op">[</span>#:reader reader<span class="op">]</span>) → document?</span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>  str : <span class="kw">string?</span></span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a>  reader : (or/c &#39;shrdlu &#39;markdown) <span class="op">=</span> &#39;shrdlu</span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a>(parse-port port <span class="op">[</span>#:reader reader<span class="op">]</span> <span class="op">[</span>#:source source<span class="op">]</span>) → document?</span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a>  port : <span class="kw">input-port?</span></span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a>  reader : (or/c &#39;shrdlu &#39;markdown) <span class="op">=</span> &#39;shrdlu</span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a>  source : any/c <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb217-14"><a href="#cb217-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-15"><a href="#cb217-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; Markdown parsing</span></span>
<span id="cb217-16"><a href="#cb217-16" aria-hidden="true" tabindex="-1"></a>(markdown-&gt;nodes markdown) → (listof node?)</span>
<span id="cb217-17"><a href="#cb217-17" aria-hidden="true" tabindex="-1"></a>  markdown : <span class="kw">string?</span></span>
<span id="cb217-18"><a href="#cb217-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-19"><a href="#cb217-19" aria-hidden="true" tabindex="-1"></a>(markdown-&gt;document markdown <span class="op">[</span>#:metadata metadata<span class="op">]</span>) → document?</span>
<span id="cb217-20"><a href="#cb217-20" aria-hidden="true" tabindex="-1"></a>  markdown : <span class="kw">string?</span></span>
<span id="cb217-21"><a href="#cb217-21" aria-hidden="true" tabindex="-1"></a>  metadata : hash? <span class="op">=</span> (hash)</span>
<span id="cb217-22"><a href="#cb217-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-23"><a href="#cb217-23" aria-hidden="true" tabindex="-1"></a>(parse-markdown-file path) → document?</span>
<span id="cb217-24"><a href="#cb217-24" aria-hidden="true" tabindex="-1"></a>  path : path-string?</span>
<span id="cb217-25"><a href="#cb217-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-26"><a href="#cb217-26" aria-hidden="true" tabindex="-1"></a><span class="co">;; Front matter parsing</span></span>
<span id="cb217-27"><a href="#cb217-27" aria-hidden="true" tabindex="-1"></a>(parse-front-matter str) → (<span class="kw">values</span> hash? <span class="kw">string?</span>)</span>
<span id="cb217-28"><a href="#cb217-28" aria-hidden="true" tabindex="-1"></a>  str : <span class="kw">string?</span></span>
<span id="cb217-29"><a href="#cb217-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-30"><a href="#cb217-30" aria-hidden="true" tabindex="-1"></a>(extract-metadata port) → hash?</span>
<span id="cb217-31"><a href="#cb217-31" aria-hidden="true" tabindex="-1"></a>  port : <span class="kw">input-port?</span></span>
<span id="cb217-32"><a href="#cb217-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-33"><a href="#cb217-33" aria-hidden="true" tabindex="-1"></a><span class="co">;; Custom parsers</span></span>
<span id="cb217-34"><a href="#cb217-34" aria-hidden="true" tabindex="-1"></a>(define-parser name grammar)</span>
<span id="cb217-35"><a href="#cb217-35" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">symbol?</span></span>
<span id="cb217-36"><a href="#cb217-36" aria-hidden="true" tabindex="-1"></a>  grammar : parser-grammar?</span>
<span id="cb217-37"><a href="#cb217-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-38"><a href="#cb217-38" aria-hidden="true" tabindex="-1"></a>(make-parser-grammar </span>
<span id="cb217-39"><a href="#cb217-39" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:start start<span class="op">]</span></span>
<span id="cb217-40"><a href="#cb217-40" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:rules rules<span class="op">]</span></span>
<span id="cb217-41"><a href="#cb217-41" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:terminals terminals<span class="op">]</span>) → parser-grammar?</span>
<span id="cb217-42"><a href="#cb217-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-43"><a href="#cb217-43" aria-hidden="true" tabindex="-1"></a><span class="co">;; Parser combinators</span></span>
<span id="cb217-44"><a href="#cb217-44" aria-hidden="true" tabindex="-1"></a>(parse-sequence parsers) → parser?</span>
<span id="cb217-45"><a href="#cb217-45" aria-hidden="true" tabindex="-1"></a>(parse-choice parsers) → parser?</span>
<span id="cb217-46"><a href="#cb217-46" aria-hidden="true" tabindex="-1"></a>(parse-many parser <span class="op">[</span>#:min <span class="kw">min</span><span class="op">]</span> <span class="op">[</span>#:max <span class="kw">max</span><span class="op">]</span>) → parser?</span>
<span id="cb217-47"><a href="#cb217-47" aria-hidden="true" tabindex="-1"></a>(parse-optional parser <span class="op">[</span>#:default default<span class="op">]</span>) → parser?</span>
<span id="cb217-48"><a href="#cb217-48" aria-hidden="true" tabindex="-1"></a>(parse-between open close parser) → parser?</span></code></pre></div>
<h3 id="template-api">Template API</h3>
<h4 id="shrdlutemplate"><code>shrdlu/template</code></h4>
<div class="sourceCode" id="cb218"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template definition</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>(struct template (name params body environment)</span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>(define-template name (param <span class="op">...</span>) body <span class="op">...</span>)</span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">symbol?</span></span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>  param : <span class="kw">symbol?</span></span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>  body : any/c</span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>(make-template name params body) → template?</span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">symbol?</span></span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a>  params : (listof <span class="kw">symbol?</span>)</span>
<span id="cb218-13"><a href="#cb218-13" aria-hidden="true" tabindex="-1"></a>  body : any/c</span>
<span id="cb218-14"><a href="#cb218-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-15"><a href="#cb218-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template registry</span></span>
<span id="cb218-16"><a href="#cb218-16" aria-hidden="true" tabindex="-1"></a>(register-template! template) → void?</span>
<span id="cb218-17"><a href="#cb218-17" aria-hidden="true" tabindex="-1"></a>  template : template?</span>
<span id="cb218-18"><a href="#cb218-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-19"><a href="#cb218-19" aria-hidden="true" tabindex="-1"></a>(get-template name) → (or/c template? <span class="dv">#f</span>)</span>
<span id="cb218-20"><a href="#cb218-20" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">symbol?</span></span>
<span id="cb218-21"><a href="#cb218-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-22"><a href="#cb218-22" aria-hidden="true" tabindex="-1"></a>(template-exists? name) → <span class="kw">boolean?</span></span>
<span id="cb218-23"><a href="#cb218-23" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">symbol?</span></span>
<span id="cb218-24"><a href="#cb218-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-25"><a href="#cb218-25" aria-hidden="true" tabindex="-1"></a>(list-templates) → (listof <span class="kw">symbol?</span>)</span>
<span id="cb218-26"><a href="#cb218-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-27"><a href="#cb218-27" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template rendering</span></span>
<span id="cb218-28"><a href="#cb218-28" aria-hidden="true" tabindex="-1"></a>(render-with-template template data) → <span class="kw">string?</span></span>
<span id="cb218-29"><a href="#cb218-29" aria-hidden="true" tabindex="-1"></a>  template : (or/c template? <span class="kw">symbol?</span> <span class="kw">string?</span>)</span>
<span id="cb218-30"><a href="#cb218-30" aria-hidden="true" tabindex="-1"></a>  data : hash?</span>
<span id="cb218-31"><a href="#cb218-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-32"><a href="#cb218-32" aria-hidden="true" tabindex="-1"></a>(apply-template template <span class="op">.</span> args) → <span class="kw">string?</span></span>
<span id="cb218-33"><a href="#cb218-33" aria-hidden="true" tabindex="-1"></a>  template : (or/c template? <span class="kw">symbol?</span>)</span>
<span id="cb218-34"><a href="#cb218-34" aria-hidden="true" tabindex="-1"></a>  args : any/c</span>
<span id="cb218-35"><a href="#cb218-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-36"><a href="#cb218-36" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template inheritance</span></span>
<span id="cb218-37"><a href="#cb218-37" aria-hidden="true" tabindex="-1"></a>(extends parent-template)</span>
<span id="cb218-38"><a href="#cb218-38" aria-hidden="true" tabindex="-1"></a>  parent-template : <span class="kw">symbol?</span></span>
<span id="cb218-39"><a href="#cb218-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-40"><a href="#cb218-40" aria-hidden="true" tabindex="-1"></a>(block name content <span class="op">...</span>)</span>
<span id="cb218-41"><a href="#cb218-41" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">symbol?</span></span>
<span id="cb218-42"><a href="#cb218-42" aria-hidden="true" tabindex="-1"></a>  content : any/c</span>
<span id="cb218-43"><a href="#cb218-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-44"><a href="#cb218-44" aria-hidden="true" tabindex="-1"></a>(super)</span>
<span id="cb218-45"><a href="#cb218-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-46"><a href="#cb218-46" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template includes</span></span>
<span id="cb218-47"><a href="#cb218-47" aria-hidden="true" tabindex="-1"></a>(include-template name <span class="op">[</span>#:with data<span class="op">]</span>)</span>
<span id="cb218-48"><a href="#cb218-48" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">symbol?</span></span>
<span id="cb218-49"><a href="#cb218-49" aria-hidden="true" tabindex="-1"></a>  data : hash? <span class="op">=</span> (hash)</span>
<span id="cb218-50"><a href="#cb218-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-51"><a href="#cb218-51" aria-hidden="true" tabindex="-1"></a>(include-raw path)</span>
<span id="cb218-52"><a href="#cb218-52" aria-hidden="true" tabindex="-1"></a>  path : path-string?</span>
<span id="cb218-53"><a href="#cb218-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-54"><a href="#cb218-54" aria-hidden="true" tabindex="-1"></a><span class="co">;; Template filters</span></span>
<span id="cb218-55"><a href="#cb218-55" aria-hidden="true" tabindex="-1"></a>(define-filter name proc)</span>
<span id="cb218-56"><a href="#cb218-56" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">symbol?</span></span>
<span id="cb218-57"><a href="#cb218-57" aria-hidden="true" tabindex="-1"></a>  proc : <span class="kw">procedure?</span></span>
<span id="cb218-58"><a href="#cb218-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-59"><a href="#cb218-59" aria-hidden="true" tabindex="-1"></a>(apply-filter name value <span class="op">.</span> args) → any/c</span>
<span id="cb218-60"><a href="#cb218-60" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">symbol?</span></span>
<span id="cb218-61"><a href="#cb218-61" aria-hidden="true" tabindex="-1"></a>  value : any/c</span>
<span id="cb218-62"><a href="#cb218-62" aria-hidden="true" tabindex="-1"></a>  args : any/c</span>
<span id="cb218-63"><a href="#cb218-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-64"><a href="#cb218-64" aria-hidden="true" tabindex="-1"></a><span class="co">;; Built-in filters</span></span>
<span id="cb218-65"><a href="#cb218-65" aria-hidden="true" tabindex="-1"></a>(escape-html str) → <span class="kw">string?</span></span>
<span id="cb218-66"><a href="#cb218-66" aria-hidden="true" tabindex="-1"></a>(<span class="kw">truncate</span> str <span class="kw">length</span> <span class="op">[</span>#:suffix suffix<span class="op">]</span>) → <span class="kw">string?</span></span>
<span id="cb218-67"><a href="#cb218-67" aria-hidden="true" tabindex="-1"></a>(format-date date <span class="op">[</span>#:format format<span class="op">]</span>) → <span class="kw">string?</span></span>
<span id="cb218-68"><a href="#cb218-68" aria-hidden="true" tabindex="-1"></a>(slugify str) → <span class="kw">string?</span></span>
<span id="cb218-69"><a href="#cb218-69" aria-hidden="true" tabindex="-1"></a>(titlecase str) → <span class="kw">string?</span></span>
<span id="cb218-70"><a href="#cb218-70" aria-hidden="true" tabindex="-1"></a>(markdown str) → <span class="kw">string?</span></span>
<span id="cb218-71"><a href="#cb218-71" aria-hidden="true" tabindex="-1"></a>(highlight-code code <span class="op">[</span>#:lang lang<span class="op">]</span>) → <span class="kw">string?</span></span></code></pre></div>
<h3 id="collection-api">Collection API</h3>
<h4 id="shrdlucollection"><code>shrdlu/collection</code></h4>
<div class="sourceCode" id="cb219"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Collection structure</span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>(struct collection (name path items options)</span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>(define-collection name</span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:path path<span class="op">]</span></span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:filter <span class="kw">filter</span><span class="op">]</span></span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:sort-by sort-by<span class="op">]</span></span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:reverse? reverse?<span class="op">]</span></span>
<span id="cb219-10"><a href="#cb219-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>#:per-page per-page<span class="op">]</span>)</span>
<span id="cb219-11"><a href="#cb219-11" aria-hidden="true" tabindex="-1"></a>  name : <span class="kw">symbol?</span></span>
<span id="cb219-12"><a href="#cb219-12" aria-hidden="true" tabindex="-1"></a>  path : <span class="kw">string?</span></span>
<span id="cb219-13"><a href="#cb219-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">filter</span> : (or/c <span class="kw">procedure?</span> <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb219-14"><a href="#cb219-14" aria-hidden="true" tabindex="-1"></a>  sort-by : (or/c <span class="kw">symbol?</span> <span class="kw">procedure?</span> <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb219-15"><a href="#cb219-15" aria-hidden="true" tabindex="-1"></a>  reverse? : <span class="kw">boolean?</span> <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb219-16"><a href="#cb219-16" aria-hidden="true" tabindex="-1"></a>  per-page : (or/c exact-positive-integer? <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb219-17"><a href="#cb219-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-18"><a href="#cb219-18" aria-hidden="true" tabindex="-1"></a><span class="co">;; Collection operations</span></span>
<span id="cb219-19"><a href="#cb219-19" aria-hidden="true" tabindex="-1"></a>(collection-add! collection item) → void?</span>
<span id="cb219-20"><a href="#cb219-20" aria-hidden="true" tabindex="-1"></a>  collection : collection?</span>
<span id="cb219-21"><a href="#cb219-21" aria-hidden="true" tabindex="-1"></a>  item : any/c</span>
<span id="cb219-22"><a href="#cb219-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-23"><a href="#cb219-23" aria-hidden="true" tabindex="-1"></a>(collection-remove! collection item) → void?</span>
<span id="cb219-24"><a href="#cb219-24" aria-hidden="true" tabindex="-1"></a>  collection : collection?</span>
<span id="cb219-25"><a href="#cb219-25" aria-hidden="true" tabindex="-1"></a>  item : any/c</span>
<span id="cb219-26"><a href="#cb219-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-27"><a href="#cb219-27" aria-hidden="true" tabindex="-1"></a>(collection-filter collection pred?) → collection?</span>
<span id="cb219-28"><a href="#cb219-28" aria-hidden="true" tabindex="-1"></a>  collection : collection?</span>
<span id="cb219-29"><a href="#cb219-29" aria-hidden="true" tabindex="-1"></a>  pred? : <span class="kw">procedure?</span></span>
<span id="cb219-30"><a href="#cb219-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-31"><a href="#cb219-31" aria-hidden="true" tabindex="-1"></a>(collection-sort collection <span class="op">[</span>#:key key<span class="op">]</span> <span class="op">[</span>#:&lt; &lt;?<span class="op">]</span>) → collection?</span>
<span id="cb219-32"><a href="#cb219-32" aria-hidden="true" tabindex="-1"></a>  collection : collection?</span>
<span id="cb219-33"><a href="#cb219-33" aria-hidden="true" tabindex="-1"></a>  key : <span class="kw">procedure?</span> <span class="op">=</span> identity</span>
<span id="cb219-34"><a href="#cb219-34" aria-hidden="true" tabindex="-1"></a>  &lt;? : <span class="kw">procedure?</span> <span class="op">=</span> <span class="op">&lt;</span></span>
<span id="cb219-35"><a href="#cb219-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-36"><a href="#cb219-36" aria-hidden="true" tabindex="-1"></a>(collection-map collection proc) → <span class="kw">list?</span></span>
<span id="cb219-37"><a href="#cb219-37" aria-hidden="true" tabindex="-1"></a>  collection : collection?</span>
<span id="cb219-38"><a href="#cb219-38" aria-hidden="true" tabindex="-1"></a>  proc : <span class="kw">procedure?</span></span>
<span id="cb219-39"><a href="#cb219-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-40"><a href="#cb219-40" aria-hidden="true" tabindex="-1"></a>(collection-for-each collection proc) → void?</span>
<span id="cb219-41"><a href="#cb219-41" aria-hidden="true" tabindex="-1"></a>  collection : collection?</span>
<span id="cb219-42"><a href="#cb219-42" aria-hidden="true" tabindex="-1"></a>  proc : <span class="kw">procedure?</span></span>
<span id="cb219-43"><a href="#cb219-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-44"><a href="#cb219-44" aria-hidden="true" tabindex="-1"></a><span class="co">;; Pagination</span></span>
<span id="cb219-45"><a href="#cb219-45" aria-hidden="true" tabindex="-1"></a>(paginate collection <span class="op">[</span>#:per-page per-page<span class="op">]</span>) → paginated-collection?</span>
<span id="cb219-46"><a href="#cb219-46" aria-hidden="true" tabindex="-1"></a>  collection : collection?</span>
<span id="cb219-47"><a href="#cb219-47" aria-hidden="true" tabindex="-1"></a>  per-page : exact-positive-integer? <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb219-48"><a href="#cb219-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-49"><a href="#cb219-49" aria-hidden="true" tabindex="-1"></a>(struct paginated-collection (pages total-pages current-page)</span>
<span id="cb219-50"><a href="#cb219-50" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb219-51"><a href="#cb219-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-52"><a href="#cb219-52" aria-hidden="true" tabindex="-1"></a>(page-items page) → <span class="kw">list?</span></span>
<span id="cb219-53"><a href="#cb219-53" aria-hidden="true" tabindex="-1"></a>  page : page?</span>
<span id="cb219-54"><a href="#cb219-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-55"><a href="#cb219-55" aria-hidden="true" tabindex="-1"></a>(page-number page) → exact-positive-integer?</span>
<span id="cb219-56"><a href="#cb219-56" aria-hidden="true" tabindex="-1"></a>  page : page?</span>
<span id="cb219-57"><a href="#cb219-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-58"><a href="#cb219-58" aria-hidden="true" tabindex="-1"></a>(has-next-page? paginated page) → <span class="kw">boolean?</span></span>
<span id="cb219-59"><a href="#cb219-59" aria-hidden="true" tabindex="-1"></a>(has-prev-page? paginated page) → <span class="kw">boolean?</span></span>
<span id="cb219-60"><a href="#cb219-60" aria-hidden="true" tabindex="-1"></a>(next-page paginated page) → (or/c page? <span class="dv">#f</span>)</span>
<span id="cb219-61"><a href="#cb219-61" aria-hidden="true" tabindex="-1"></a>(prev-page paginated page) → (or/c page? <span class="dv">#f</span>)</span></code></pre></div>
<h3 id="asset-api">Asset API</h3>
<h4 id="shrdluasset"><code>shrdlu/asset</code></h4>
<div class="sourceCode" id="cb220"><pre
class="sourceCode scheme"><code class="sourceCode scheme"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Asset management</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>(struct asset (path type content metadata)</span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>  #:transparent)</span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>(register-asset! path <span class="op">[</span>#:type type<span class="op">]</span> <span class="op">[</span>#:metadata metadata<span class="op">]</span>) → asset?</span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>  path : path-string?</span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>  type : <span class="kw">symbol?</span> <span class="op">=</span> &#39;static</span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>  metadata : hash? <span class="op">=</span> (hash)</span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>(get-asset path) → (or/c asset? <span class="dv">#f</span>)</span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a>  path : path-string?</span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a>(asset-url asset <span class="op">[</span>#:absolute? absolute?<span class="op">]</span>) → <span class="kw">string?</span></span>
<span id="cb220-14"><a href="#cb220-14" aria-hidden="true" tabindex="-1"></a>  asset : (or/c asset? path-string?)</span>
<span id="cb220-15"><a href="#cb220-15" aria-hidden="true" tabindex="-1"></a>  absolute? : <span class="kw">boolean?</span> <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb220-16"><a href="#cb220-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-17"><a href="#cb220-17" aria-hidden="true" tabindex="-1"></a>(asset-path asset) → path-string?</span>
<span id="cb220-18"><a href="#cb220-18" aria-hidden="true" tabindex="-1"></a>  asset : (or/c asset? path-string?)</span>
<span id="cb220-19"><a href="#cb220-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-20"><a href="#cb220-20" aria-hidden="true" tabindex="-1"></a><span class="co">;; Asset processing</span></span>
<span id="cb220-21"><a href="#cb220-21" aria-hidden="true" tabindex="-1"></a>(process-asset asset processor) → asset?</span>
<span id="cb220-22"><a href="#cb220-22" aria-hidden="true" tabindex="-1"></a>  asset : asset?</span>
<span id="cb220-23"><a href="#cb220-23" aria-hidden="true" tabindex="-1"></a>  processor : <span class="kw">procedure?</span></span>
<span id="cb220-24"><a href="#cb220-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-25"><a href="#cb220-25" aria-hidden="true" tabindex="-1"></a>(optimize-image path <span class="op">[</span>#:format format<span class="op">]</span> </span>
<span id="cb220-26"><a href="#cb220-26" aria-hidden="true" tabindex="-1"></a>                     <span class="op">[</span>#:quality quality<span class="op">]</span></span>
<span id="cb220-27"><a href="#cb220-27" aria-hidden="true" tabindex="-1"></a>                     <span class="op">[</span>#:resize resize<span class="op">]</span>) → path-string?</span>
<span id="cb220-28"><a href="#cb220-28" aria-hidden="true" tabindex="-1"></a>  path : path-string?</span>
<span id="cb220-29"><a href="#cb220-29" aria-hidden="true" tabindex="-1"></a>  format : (or/c &#39;jpeg &#39;png &#39;webp) <span class="op">=</span> &#39;jpeg</span>
<span id="cb220-30"><a href="#cb220-30" aria-hidden="true" tabindex="-1"></a>  quality : (integer-in <span class="dv">1</span> <span class="dv">100</span>) <span class="op">=</span> <span class="dv">85</span></span>
<span id="cb220-31"><a href="#cb220-31" aria-hidden="true" tabindex="-1"></a>  resize : (or/c (list/c exact-integer? exact-integer?) <span class="dv">#f</span>) <span class="op">=</span> <span class="dv">#f</span></span>
<span id="cb220-32"><a href="#cb220-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-33"><a href="#cb220-33" aria-hidden="true" tabindex="-1"></a>(minify-css css) → <span class="kw">string?</span></span>
<span id="cb220-34"><a href="#cb220-34" aria-hidden="true" tabindex="-1"></a>  css : <span class="kw">string?</span></span>
<span id="cb220-35"><a href="#cb220-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-36"><a href="#cb220-36" aria-hidden="true" tabindex="-1"></a>(minify-js js) → <span class="kw">string?</span></span>
<span id="cb220-37"><a href="#cb220-37" aria-hidden="true" tabindex="-1"></a>  js : <span class="kw">string?</span></span>
<span id="cb220-38"><a href="#cb220-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-39"><a href="#cb220-39" aria-hidden="true" tabindex="-1"></a>(compile-sass sass <span class="op">[</span>#:style style<span class="op">]</span>) → <span class="kw">string?</span></span>
<span id="cb220-40"><a href="#cb220-40" aria-hidden="true" tabindex="-1"></a>  sass : <span class="kw">string?</span></span>
<span id="cb220-41"><a href="#cb220-41" aria-hidden="true" tabindex="-1"></a>  style : (or/c &#39;compressed &#39;expanded) <span class="op">=</span> &#39;compressed</span>
<span id="cb220-42"><a href="#cb220-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-43"><a href="#cb220-43" aria-hidden="true" tabindex="-1"></a><span class="co">;; Asset fingerprinting</span></span>
<span id="cb220-44"><a href="#cb220-44" aria-hidden="true" tabindex="-1"></a>(fingerprint path) → <span class="kw">string?</span></span>
<span id="cb220-45"><a href="#cb220-45" aria-hidden="true" tabindex="-1"></a>  path : path-string?</span>
<span id="cb220-46"><a href="#cb220-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-47"><a href="#cb220-47" aria-hidden="true" tabindex="-1"></a>(fingerprinted-url path) → <span class="kw">string?</span></span>
<span id="cb220-48"><a href="#cb220-48" aria-hidden="true" tabindex="-1"></a>  path : path-string?</span>
<span id="cb220-49"><a href="#cb220-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-50"><a href="#cb220-50" aria-hidden="true" tabindex="-1"></a>(resolve-fingerprint fingerprint) → (or/c path-string? <span class="dv">#f</span>)</span>
<span id="cb220-51"><a href="#cb220-51" aria-hidden="true" tabindex="-1"></a>  fingerprint : <span class="kw">string?</span></span>
<span id="cb220-52"><a href="#cb220-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-53"><a href="#cb220-53" aria-hidden="true" tabindex="-1"></a><span class="co">;; Asset bundling</span></span>
<span id="cb220-54"><a href="#cb220-54" aria-hidden="true" tabindex="-1"></a>(bundle-css paths <span class="op">[</span>#:output output<span class="op">]</span>) → path-string?</span>
<span id="cb220-55"><a href="#cb220-55" aria-hidden="true" tabindex="-1"></a>  paths : (listof path-string?)</span>
<span id="cb220-56"><a href="#cb220-56" aria-hidden="true" tabindex="-1"></a>  output : path-string? <span class="op">=</span> <span class="st">&quot;bundle.css&quot;</span></span>
<span id="cb220-57"><a href="#cb220-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-58"><a href="#cb220-58" aria-hidden="true" tabindex="-1"></a>(bundle-js paths <span class="op">[</span>#:output output<span class="op">]</span> <span class="op">[</span>#:minify? minify?<span class="op">]</span>) → path-string?</span>
<span id="cb220-59"><a href="#cb220-59" aria-hidden="true" tabindex="-1"></a>  paths : (listof path-string?)</span>
<span id="cb220-60"><a href="#cb220-60" aria-hidden="true" tabindex="-1"></a>  output : path-string? <span class="op">=</span> <span class="st">&quot;bundle.js&quot;</span></span>
<span id="cb220-61"><a href="#cb220-61" aria-hidden="true" tabindex="-1"></a>  minify? : <span class="kw">boolean?</span> <span class="op">=</span> <span class="dv">#t</span></span></code></pre></div>
<h3 id="build-api">Build API</h3>
<h4 id="shrdlubuild"><code>shrdlu/build</code></h4>
<p>```scheme ;; Build context (struct build-context (config</p>
</body>
</html>
